<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of checkTasks</title>
  <meta name="keywords" content="checkTasks">
  <meta name="description" content="checkTasks">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">core</a> &gt; checkTasks.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for core&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>checkTasks
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>checkTasks</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [taskReport essentialRxns taskStructure]=checkTasks(model,inputFile,printOutput,printOnlyFailed,getEssential,taskStructure) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> checkTasks
   Performs a set of simulations as defined in a task file.

   model           a model structure
   inputFile       a task list in Excel format. See the function
                   parseTaskList for details (opt if taskStructure is
                   supplied)
   printOutput     true if the results of the test should be displayed
                   (opt, default true)
   printOnlyFailed true if only tasks that failed should be displayed
                   (opt, default false)
   getEssential    true if the essential reactions should be calculated for
                   all the tasks. This option is used with runINIT (opt,
                   default false)
   taskStructure   structure with the tasks, as from parseTaskList. If
                   this is supplied then inputFile is ignored (opt)

   taskReport          structure with the results
       id              cell array with the id of the task
       description     cell array with the description of the task
       ok              boolean array with true if the task was successful
   essentialRxns       MxN matrix with the essential reactions (M) for each
                       task (N). An element is true if the corresponding
                       reaction is essential in the corresponding task.
                       Failed tasks and SHOULD FAIL tasks are ignored.
                       This is used by the INIT algorithm (if tasks
                       are supplied). If getEssential=false then
                       essentialRxns=false(nRxns,nTasks)
   taskStructure       structure with the tasks, as from parseTaskList

   This function is used for defining a set of tasks for a model to
   perform. The tasks are defined by defining constraints on the model,
   and if the problem is feasible, then the task is considered successful.
   In general, each row can contain one constraint on uptakes, one 
   constraint on outputs, one new equation, and one change of reaction
   bounds. If more bounds are needed to define the task, then several rows
   can be used for each task.

   Usage: [taskReport essentialReactions taskStructure]=checkTasks(model,inputFile,...
           printOutput,printOnlyFailed,getEssential,taskStructure)

   Rasmus Agren, 2013-11-17</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="addRxns.html" class="code" title="function newModel=addRxns(model,rxnsToAdd,eqnType,compartment,allowNewMets)">addRxns</a>	addRxns</li><li><a href="dispEM.html" class="code" title="function dispEM(string,throwErrors,toList,trimWarnings)">dispEM</a>	dispEM</li><li><a href="getEssentialRxns.html" class="code" title="function [essentialRxns, essentialRxnsIndexes]=getEssentialRxns(model,ignoreRxns)">getEssentialRxns</a>	getEssentialRxns</li><li><a href="parseTaskList.html" class="code" title="function taskStruct=parseTaskList(inputFile)">parseTaskList</a>	parseTaskList</li><li><a href="printFluxes.html" class="code" title="function printFluxes(model, fluxes, onlyExchange, cutOffFlux, outputFile,outputString,metaboliteList)">printFluxes</a>	printFluxes</li><li><a href="setParam.html" class="code" title="function model=setParam(model, paramType, rxnList, params)">setParam</a>	setParam</li><li><a href="../solver/solveLP.html" class="code" title="function [solution hsSolOut prob]=solveLP(model,minFlux,params,hsSol)">solveLP</a>	solveLP</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="../INIT/getINITModel.html" class="code" title="function [model metProduction essentialRxnsForTasks addedRxnsForTasks deletedDeadEndRxns deletedRxnsInINIT taskReport]=getINITModel(refModel, tissue, celltype, hpaData, arrayData, metabolomicsData, taskFile, useScoresForTasks, printReport, taskStructure, params, paramsFT)">getINITModel</a>	getINITModel</li><li><a href="../test/private/testTasks.html" class="code" title="function out=testTasks(param)">testTasks</a>	</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [taskReport essentialRxns taskStructure]=checkTasks(model,inputFile,printOutput,printOnlyFailed,getEssential,taskStructure)</a>
0002 <span class="comment">% checkTasks</span>
0003 <span class="comment">%   Performs a set of simulations as defined in a task file.</span>
0004 <span class="comment">%</span>
0005 <span class="comment">%   model           a model structure</span>
0006 <span class="comment">%   inputFile       a task list in Excel format. See the function</span>
0007 <span class="comment">%                   parseTaskList for details (opt if taskStructure is</span>
0008 <span class="comment">%                   supplied)</span>
0009 <span class="comment">%   printOutput     true if the results of the test should be displayed</span>
0010 <span class="comment">%                   (opt, default true)</span>
0011 <span class="comment">%   printOnlyFailed true if only tasks that failed should be displayed</span>
0012 <span class="comment">%                   (opt, default false)</span>
0013 <span class="comment">%   getEssential    true if the essential reactions should be calculated for</span>
0014 <span class="comment">%                   all the tasks. This option is used with runINIT (opt,</span>
0015 <span class="comment">%                   default false)</span>
0016 <span class="comment">%   taskStructure   structure with the tasks, as from parseTaskList. If</span>
0017 <span class="comment">%                   this is supplied then inputFile is ignored (opt)</span>
0018 <span class="comment">%</span>
0019 <span class="comment">%   taskReport          structure with the results</span>
0020 <span class="comment">%       id              cell array with the id of the task</span>
0021 <span class="comment">%       description     cell array with the description of the task</span>
0022 <span class="comment">%       ok              boolean array with true if the task was successful</span>
0023 <span class="comment">%   essentialRxns       MxN matrix with the essential reactions (M) for each</span>
0024 <span class="comment">%                       task (N). An element is true if the corresponding</span>
0025 <span class="comment">%                       reaction is essential in the corresponding task.</span>
0026 <span class="comment">%                       Failed tasks and SHOULD FAIL tasks are ignored.</span>
0027 <span class="comment">%                       This is used by the INIT algorithm (if tasks</span>
0028 <span class="comment">%                       are supplied). If getEssential=false then</span>
0029 <span class="comment">%                       essentialRxns=false(nRxns,nTasks)</span>
0030 <span class="comment">%   taskStructure       structure with the tasks, as from parseTaskList</span>
0031 <span class="comment">%</span>
0032 <span class="comment">%   This function is used for defining a set of tasks for a model to</span>
0033 <span class="comment">%   perform. The tasks are defined by defining constraints on the model,</span>
0034 <span class="comment">%   and if the problem is feasible, then the task is considered successful.</span>
0035 <span class="comment">%   In general, each row can contain one constraint on uptakes, one</span>
0036 <span class="comment">%   constraint on outputs, one new equation, and one change of reaction</span>
0037 <span class="comment">%   bounds. If more bounds are needed to define the task, then several rows</span>
0038 <span class="comment">%   can be used for each task.</span>
0039 <span class="comment">%</span>
0040 <span class="comment">%   Usage: [taskReport essentialReactions taskStructure]=checkTasks(model,inputFile,...</span>
0041 <span class="comment">%           printOutput,printOnlyFailed,getEssential,taskStructure)</span>
0042 <span class="comment">%</span>
0043 <span class="comment">%   Rasmus Agren, 2013-11-17</span>
0044 <span class="comment">%</span>
0045 
0046 <span class="keyword">if</span> nargin&lt;3
0047     printOutput=true;
0048 <span class="keyword">end</span>
0049 <span class="keyword">if</span> nargin&lt;4
0050     printOnlyFailed=false;
0051 <span class="keyword">end</span>
0052 <span class="keyword">if</span> nargin&lt;5
0053     getEssential=false;
0054 <span class="keyword">end</span>
0055 
0056 <span class="comment">%Prepare the input model a little</span>
0057 model.b=zeros(numel(model.mets),2);
0058 
0059 modelMets=upper(strcat(model.metNames,<span class="string">'['</span>,model.comps(model.metComps),<span class="string">']'</span>));
0060 <span class="keyword">if</span> ~isfield(model,<span class="string">'unconstrained'</span>)
0061     <a href="dispEM.html" class="code" title="function dispEM(string,throwErrors,toList,trimWarnings)">dispEM</a>(<span class="string">'Exchange metabolites should normally not be removed from the model when using checkTasks. Inputs and outputs are defined in the task file instead. Use importModel(file,false) to import a model with exchange metabolites remaining'</span>,false); 
0062 <span class="keyword">end</span>
0063 
0064 <span class="comment">%Parse the task file</span>
0065 <span class="keyword">if</span> nargin&lt;6
0066    taskStructure=<a href="parseTaskList.html" class="code" title="function taskStruct=parseTaskList(inputFile)">parseTaskList</a>(inputFile); 
0067 <span class="keyword">end</span>
0068 
0069 essentialRxns=false(numel(model.rxns),numel(taskStructure));
0070 
0071 tModel=model;
0072 taskReport=[];
0073 <span class="keyword">for</span> i=1:numel(taskStructure)
0074     taskReport.id{i,1}=taskStructure(i).id;
0075     taskReport.description{i,1}=taskStructure(i).description;
0076     <span class="comment">%Set the inputs</span>
0077     <span class="keyword">if</span> ~isempty(taskStructure(i).inputs)
0078         [I J]=ismember(upper(taskStructure(i).inputs),modelMets);
0079         J=J(I); <span class="comment">%Only keep the ones with matches</span>
0080         K=ismember(upper(taskStructure(i).inputs),<span class="string">'ALLMETS'</span>);
0081         L=~cellfun(<span class="string">'isempty'</span>,strfind(upper(taskStructure(i).inputs),<span class="string">'ALLMETSIN'</span>));
0082         <span class="comment">%Check that all metabolites are either real metabolites or</span>
0083         <span class="comment">%ALLMETS/ALLMETSIN</span>
0084         <span class="keyword">if</span> ~all(I|K|L)
0085             fprintf([<span class="string">'ERROR: Could not find all inputs in &quot;['</span> taskStructure(i).id <span class="string">'] '</span> taskStructure(i).description <span class="string">'&quot;\n'</span>]);
0086             taskReport.ok(i,1)=false;
0087             tModel=model;
0088             <span class="keyword">continue</span>;
0089         <span class="keyword">end</span>
0090         <span class="keyword">if</span> numel(J)~=numel(unique(J))
0091             <a href="dispEM.html" class="code" title="function dispEM(string,throwErrors,toList,trimWarnings)">dispEM</a>([<span class="string">'The constraints on some input(s) in &quot;['</span> taskStructure(i).id <span class="string">'] '</span> taskStructure(i).description <span class="string">'&quot; are defined more than one time'</span>]);  
0092         <span class="keyword">end</span>
0093         <span class="comment">%If all metabolites should be added</span>
0094         <span class="keyword">if</span> any(K)
0095             <span class="comment">%Check if ALLMETS is the first metabolite. Otherwise print a</span>
0096             <span class="comment">%warning since it will write over any other constraints that</span>
0097             <span class="comment">%are set</span>
0098             <span class="keyword">if</span> K(1)==0
0099                 <a href="dispEM.html" class="code" title="function dispEM(string,throwErrors,toList,trimWarnings)">dispEM</a>([<span class="string">'ALLMETS is used as an input in &quot;['</span> taskStructure(i).id <span class="string">'] '</span> taskStructure(i).description <span class="string">'&quot; but it it not the first metabolite in the list. Constraints defined for the metabolites before it will be over-written'</span>],false);
0100             <span class="keyword">end</span>
0101             <span class="comment">%Use the first match of ALLMETS. There should only be one, but</span>
0102             <span class="comment">%still..</span>
0103             tModel.b(:,1)=taskStructure(i).UBin(find(K,1))*-1;
0104         <span class="keyword">end</span>
0105         <span class="comment">%If metabolites in a specific compartment should be used</span>
0106         <span class="keyword">if</span> any(L)
0107             L=find(L);
0108             <span class="keyword">for</span> j=1:numel(L)
0109                 <span class="comment">%The compartment defined</span>
0110                 compartment=upper(taskStructure(i).inputs{L(j)}(11:end-1));
0111                 <span class="comment">%Check if it exists in the model</span>
0112                 C=find(ismember(upper(model.comps),compartment));
0113                 <span class="keyword">if</span> any(C)
0114                     <span class="comment">%Match to metabolites</span>
0115                     tModel.b(model.metComps==C,1)=taskStructure(i).UBin(L(j))*-1;
0116                 <span class="keyword">else</span>
0117                     <a href="dispEM.html" class="code" title="function dispEM(string,throwErrors,toList,trimWarnings)">dispEM</a>([<span class="string">'The compartment defined for ALLMETSIN in &quot;['</span> taskStructure(i).id <span class="string">'] '</span> taskStructure(i).description <span class="string">'&quot; does not exist'</span>]);  
0118                 <span class="keyword">end</span>
0119             <span class="keyword">end</span>
0120         <span class="keyword">end</span>
0121         <span class="comment">%Then add the normal constraints</span>
0122         <span class="keyword">if</span> any(J)
0123             tModel.b(J,1)=taskStructure(i).UBin(I)*-1;
0124             tModel.b(J,2)=taskStructure(i).LBin(I)*-1;
0125         <span class="keyword">end</span>
0126     <span class="keyword">end</span>
0127     <span class="comment">%Set the outputs</span>
0128     <span class="keyword">if</span> ~isempty(taskStructure(i).outputs)
0129         [I J]=ismember(upper(taskStructure(i).outputs),modelMets);
0130         J=J(I); <span class="comment">%Only keep the ones with matches</span>
0131         K=ismember(upper(taskStructure(i).outputs),<span class="string">'ALLMETS'</span>);
0132         L=~cellfun(<span class="string">'isempty'</span>,strfind(upper(taskStructure(i).outputs),<span class="string">'ALLMETSIN'</span>));
0133         <span class="comment">%Check that all metabolites are either real metabolites or</span>
0134         <span class="comment">%ALLMETS/ALLMETSIN</span>
0135         <span class="keyword">if</span> ~all(I|K|L)
0136             fprintf([<span class="string">'ERROR: Could not find all outputs in &quot;['</span> taskStructure(i).id <span class="string">'] '</span> taskStructure(i).description <span class="string">'&quot;\n'</span>]);
0137             taskReport.ok(i,1)=false;
0138             tModel=model;
0139             <span class="keyword">continue</span>;
0140         <span class="keyword">end</span>
0141         <span class="keyword">if</span> numel(J)~=numel(unique(J))
0142             <a href="dispEM.html" class="code" title="function dispEM(string,throwErrors,toList,trimWarnings)">dispEM</a>([<span class="string">'The constraints on some output(s) in &quot;['</span> taskStructure(i).id <span class="string">'] '</span> taskStructure(i).description <span class="string">'&quot; are defined more than one time'</span>]);  
0143         <span class="keyword">end</span>
0144         <span class="comment">%If all metabolites should be added</span>
0145         <span class="keyword">if</span> any(K)
0146             <span class="comment">%Check if ALLMETS is the first metabolite. Otherwise print a</span>
0147             <span class="comment">%warning since it will write over any other constraints that</span>
0148             <span class="comment">%are set</span>
0149             <span class="keyword">if</span> K(1)==0
0150                 <a href="dispEM.html" class="code" title="function dispEM(string,throwErrors,toList,trimWarnings)">dispEM</a>([<span class="string">'ALLMETS is used as an output in &quot;['</span> taskStructure(i).id <span class="string">'] '</span> taskStructure(i).description <span class="string">'&quot; but it it not the first metabolite in the list. Constraints defined for the metabolites before it will be over-written'</span>],false);
0151             <span class="keyword">end</span>
0152             <span class="comment">%Use the first match of ALLMETS. There should only be one, but</span>
0153             <span class="comment">%still..</span>
0154             tModel.b(:,2)=taskStructure(i).UBout(find(K,1));
0155         <span class="keyword">end</span>
0156         <span class="comment">%If metabolites in a specific compartment should be used</span>
0157         <span class="keyword">if</span> any(L)
0158             L=find(L);
0159             <span class="keyword">for</span> j=1:numel(L)
0160                 <span class="comment">%The compartment defined</span>
0161                 compartment=upper(taskStructure(i).outputs{L(j)}(11:end-1));
0162                 <span class="comment">%Check if it exists in the model</span>
0163                 C=find(ismember(upper(model.comps),compartment));
0164                 <span class="keyword">if</span> any(C)
0165                     <span class="comment">%Match to metabolites</span>
0166                     tModel.b(model.metComps==C,2)=taskStructure(i).UBout(L(j));
0167                 <span class="keyword">else</span>
0168                     <a href="dispEM.html" class="code" title="function dispEM(string,throwErrors,toList,trimWarnings)">dispEM</a>([<span class="string">'The compartment defined for ALLMETSIN in &quot;['</span> taskStructure(i).id <span class="string">'] '</span> taskStructure(i).description <span class="string">'&quot; does not exist'</span>]);  
0169                 <span class="keyword">end</span>
0170             <span class="keyword">end</span>
0171         <span class="keyword">end</span>
0172         <span class="comment">%Then add the normal constraints</span>
0173         <span class="keyword">if</span> any(J)
0174             tModel.b(J,1)=taskStructure(i).LBout(I);
0175             tModel.b(J,2)=taskStructure(i).UBout(I);
0176         <span class="keyword">end</span>
0177     <span class="keyword">end</span>
0178     <span class="comment">%Add new rxns</span>
0179     <span class="keyword">if</span> ~isempty(taskStructure(i).equations)
0180         rxn.equations=taskStructure(i).equations;
0181         rxn.lb=taskStructure(i).LBequ;
0182         rxn.ub=taskStructure(i).UBequ;
0183         rxn.rxns=strcat({<span class="string">'TEMPORARY_'</span>},num2str((1:numel(taskStructure(i).equations))'));
0184         <span class="comment">%Allow for new metabolites to be added. This is because it should</span>
0185         <span class="comment">%be possible to add, say, a whole new pathway</span>
0186         tModel=<a href="addRxns.html" class="code" title="function newModel=addRxns(model,rxnsToAdd,eqnType,compartment,allowNewMets)">addRxns</a>(tModel,rxn,3,[],true);
0187     <span class="keyword">end</span>
0188     <span class="comment">%Add changed bounds</span>
0189     <span class="keyword">if</span> ~isempty(taskStructure(i).changed)
0190        tModel=<a href="setParam.html" class="code" title="function model=setParam(model, paramType, rxnList, params)">setParam</a>(tModel,<span class="string">'lb'</span>,taskStructure(i).changed,taskStructure(i).LBrxn);
0191        tModel=<a href="setParam.html" class="code" title="function model=setParam(model, paramType, rxnList, params)">setParam</a>(tModel,<span class="string">'ub'</span>,taskStructure(i).changed,taskStructure(i).UBrxn);
0192     <span class="keyword">end</span>
0193     
0194     <span class="comment">%Solve and print</span>
0195     sol=<a href="../solver/solveLP.html" class="code" title="function [solution hsSolOut prob]=solveLP(model,minFlux,params,hsSol)">solveLP</a>(tModel);
0196     <span class="keyword">if</span> ~isempty(sol.x)
0197         <span class="keyword">if</span> ~taskStructure(i).shouldFail
0198             taskReport.ok(i,1)=true;
0199             <span class="keyword">if</span> printOnlyFailed==false &amp;&amp; printOutput==true
0200                 fprintf([<span class="string">'PASS: ['</span> taskStructure(i).id <span class="string">'] '</span> taskStructure(i).description <span class="string">'\n'</span>]);
0201             <span class="keyword">end</span>
0202             <span class="comment">%Calculate the essential reactions</span>
0203             <span class="keyword">if</span> getEssential==true
0204                 [crap taskEssential]=<a href="getEssentialRxns.html" class="code" title="function [essentialRxns, essentialRxnsIndexes]=getEssentialRxns(model,ignoreRxns)">getEssentialRxns</a>(tModel);
0205                 <span class="comment">%This is because there could be more reactions in tModel than</span>
0206                 <span class="comment">%in model</span>
0207                 essentialRxns(taskEssential(taskEssential&lt;=numel(model.rxns)),i)=true;
0208             <span class="keyword">end</span>
0209         <span class="keyword">else</span>
0210             taskReport.ok(i,1)=false;
0211             <span class="keyword">if</span> printOutput==true
0212                 fprintf([<span class="string">'PASS (should fail): ['</span> taskStructure(i).id <span class="string">'] '</span> taskStructure(i).description <span class="string">'\n'</span>]);
0213             <span class="keyword">end</span>
0214         <span class="keyword">end</span>
0215     <span class="keyword">else</span>
0216         <span class="keyword">if</span> ~taskStructure(i).shouldFail
0217             taskReport.ok(i,1)=false;
0218             <span class="keyword">if</span> printOutput==true
0219                 fprintf([<span class="string">'FAIL: ['</span> taskStructure(i).id <span class="string">'] '</span> taskStructure(i).description <span class="string">'\n'</span>]);
0220             <span class="keyword">end</span>
0221         <span class="keyword">else</span>
0222             taskReport.ok(i,1)=true;
0223             <span class="keyword">if</span> printOnlyFailed==false &amp;&amp; printOutput==true
0224                 fprintf([<span class="string">'FAIL (should fail): ['</span> taskStructure(i).id <span class="string">'] '</span> taskStructure(i).description <span class="string">'\n'</span>]);
0225             <span class="keyword">end</span>
0226         <span class="keyword">end</span>
0227     <span class="keyword">end</span>
0228     <span class="keyword">if</span> taskStructure(i).printFluxes &amp;&amp; ~isempty(sol.x)
0229         sol=<a href="../solver/solveLP.html" class="code" title="function [solution hsSolOut prob]=solveLP(model,minFlux,params,hsSol)">solveLP</a>(tModel,1);
0230         <span class="keyword">if</span> ~isempty(sol.x)
0231             <a href="printFluxes.html" class="code" title="function printFluxes(model, fluxes, onlyExchange, cutOffFlux, outputFile,outputString,metaboliteList)">printFluxes</a>(tModel,sol.x,false,10^-6,[],<span class="string">'%rxnID (%eqn):%flux\n'</span>);
0232             fprintf(<span class="string">'\n'</span>);
0233         <span class="keyword">end</span>
0234     <span class="keyword">end</span>
0235     tModel=model;
0236 <span class="keyword">end</span>
0237 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Fri 14-Oct-2016 12:02:10 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>