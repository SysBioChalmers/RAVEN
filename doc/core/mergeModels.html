<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of mergeModels</title>
  <meta name="keywords" content="mergeModels">
  <meta name="description" content="mergeModels">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">core</a> &gt; mergeModels.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for core&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>mergeModels
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>mergeModels</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function model=mergeModels(models,supressWarnings) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> mergeModels
   Merges models into one model structure.

   models          a cell array with model structures
   supressWarnings true if warnings should be supressed (opt, default
                   false)

   model     a model structure with the merged model. Follows the structure
             of normal models but also has 'rxnFrom/metFrom/geneFrom' fields 
             to indicate from which model each reaction/metabolite/gene was 
             taken

   Usage: model=mergeModels(models)

   Rasmus Agren, 2013-08-01</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="dispEM.html" class="code" title="function dispEM(string,throwErrors,toList,trimWarnings)">dispEM</a>	dispEM</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="../INIT/getINITModel.html" class="code" title="function [model metProduction essentialRxnsForTasks addedRxnsForTasks deletedDeadEndRxns deletedRxnsInINIT taskReport]=getINITModel(refModel, tissue, celltype, hpaData, arrayData, metabolomicsData, taskFile, useScoresForTasks, printReport, taskStructure, params, paramsFT)">getINITModel</a>	getINITModel</li><li><a href="copyToComps.html" class="code" title="function model=copyToComps(model,toComps,rxns,deleteOriginal,compNames,compOutside)">copyToComps</a>	copyToComps</li><li><a href="fillGaps.html" class="code" title="function [newConnected cannotConnect addedRxns newModel exitFlag]=fillGaps(model,models,allowNetProduction,useModelConstraints,supressWarnings,rxnScores,params)">fillGaps</a>	fillGaps</li><li><a href="fitTasks.html" class="code" title="function [outModel addedRxns]=fitTasks(model,refModel,inputFile,printOutput,rxnScores,taskStructure,params)">fitTasks</a>	fitTasks</li><li><a href="getModelFromHomology.html" class="code" title="function draftModel=getModelFromHomology(models,blastStructure,getModelFor,preferredOrder,strictness,onlyGenesInModels,maxE,minLen,minSim,mapNewGenesToOld)">getModelFromHomology</a>	getModelFromHomology</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function model=mergeModels(models,supressWarnings)</a>
0002 <span class="comment">% mergeModels</span>
0003 <span class="comment">%   Merges models into one model structure.</span>
0004 <span class="comment">%</span>
0005 <span class="comment">%   models          a cell array with model structures</span>
0006 <span class="comment">%   supressWarnings true if warnings should be supressed (opt, default</span>
0007 <span class="comment">%                   false)</span>
0008 <span class="comment">%</span>
0009 <span class="comment">%   model     a model structure with the merged model. Follows the structure</span>
0010 <span class="comment">%             of normal models but also has 'rxnFrom/metFrom/geneFrom' fields</span>
0011 <span class="comment">%             to indicate from which model each reaction/metabolite/gene was</span>
0012 <span class="comment">%             taken</span>
0013 <span class="comment">%</span>
0014 <span class="comment">%   Usage: model=mergeModels(models)</span>
0015 <span class="comment">%</span>
0016 <span class="comment">%   Rasmus Agren, 2013-08-01</span>
0017 <span class="comment">%</span>
0018 
0019 <span class="comment">%Just return the model</span>
0020 <span class="keyword">if</span> numel(models)&lt;=1
0021     model=models{1};
0022     <span class="keyword">return</span>;
0023 <span class="keyword">end</span>
0024 
0025 <span class="keyword">if</span> nargin&lt;2
0026     supressWarnings=false;
0027 <span class="keyword">end</span>
0028 
0029 <span class="comment">%Add new functionality in the order specified in models</span>
0030 model=models{1};
0031 model.id=<span class="string">'MERGED'</span>;
0032 model.description=<span class="string">''</span>;
0033 
0034 model.rxnFrom=cell(numel(models{1}.rxns),1);
0035 model.rxnFrom(:)={models{1}.id};
0036 model.metFrom=cell(numel(models{1}.mets),1);
0037 model.metFrom(:)={models{1}.id};
0038 <span class="keyword">if</span> isfield(models{1},<span class="string">'genes'</span>)
0039     model.geneFrom=cell(numel(models{1}.genes),1);
0040     model.geneFrom(:)={models{1}.id};
0041 <span class="keyword">end</span>
0042 
0043 <span class="keyword">if</span> isfield(model,<span class="string">'subSystems'</span>)
0044     hasDeletedSubSystem=false;
0045 <span class="keyword">else</span>
0046     <span class="keyword">if</span> supressWarnings==false
0047         <a href="dispEM.html" class="code" title="function dispEM(string,throwErrors,toList,trimWarnings)">dispEM</a>(<span class="string">'Cannot add subsystems since the existing model has no subsystems info. All reactions must have a subsystem for this to be included'</span>,false);  
0048     <span class="keyword">end</span>
0049     hasDeletedSubSystem=true;
0050 <span class="keyword">end</span>
0051 
0052 <span class="keyword">if</span> isfield(model,<span class="string">'equations'</span>)
0053     model=rmfield(model,<span class="string">'equations'</span>);
0054 <span class="keyword">end</span>
0055 
0056 <span class="keyword">for</span> i=2:numel(models)
0057     <span class="comment">%Add the model id to the rxn id id it already exists in the model (id</span>
0058     <span class="comment">%have to be unique)</span>
0059     <span class="comment">%This is because it makes a '[]' string if no new reactions</span>
0060     <span class="keyword">if</span> ~isempty(models{i}.rxns)
0061         I=ismember(models{i}.rxns,model.rxns);
0062         models{i}.rxns(I)=strcat(models{i}.rxns(I),[<span class="string">'_'</span> models{i}.id]);
0063     <span class="keyword">end</span> 
0064     
0065     <span class="comment">%Make sure that there are no conflicting reaction ids</span>
0066     [crap crap conflicting]=intersect(model.rxns,models{i}.rxns);
0067     
0068     <span class="keyword">if</span> ~isempty(conflicting)
0069        printString=cell(numel(conflicting),1);
0070        <span class="keyword">for</span> j=1:numel(conflicting)
0071            printString{j}=[<span class="string">'Old: '</span> models{i}.rxns{conflicting(j)} <span class="string">' New: '</span> models{i}.rxns{conflicting(j)} <span class="string">'_'</span> models{i}.id];
0072            models{i}.rxns{conflicting(j)}=[models{i}.rxns{conflicting(j)} <span class="string">'_'</span> models{i}.id];
0073        <span class="keyword">end</span>
0074        <span class="keyword">if</span> supressWarnings==false
0075             <a href="dispEM.html" class="code" title="function dispEM(string,throwErrors,toList,trimWarnings)">dispEM</a>([<span class="string">'The following reaction IDs in '</span> models{i}.id <span class="string">' are already present in the model and were renamed:'</span>],false,printString);
0076             fprintf(<span class="string">'\n'</span>);
0077        <span class="keyword">end</span>
0078     <span class="keyword">end</span>
0079     
0080     <span class="comment">%Add all static stuff</span>
0081     rxnFrom=cell(numel(models{i}.rxns),1);
0082     rxnFrom(:)={models{i}.id};
0083     model.rxnFrom=[model.rxnFrom;rxnFrom];
0084     model.rxns=[model.rxns;models{i}.rxns];
0085     model.rxnNames=[model.rxnNames;models{i}.rxnNames];
0086     model.lb=[model.lb;models{i}.lb];
0087     model.ub=[model.ub;models{i}.ub];
0088     model.c=[model.c;models{i}.c];
0089     model.rev=[model.rev;models{i}.rev];
0090     
0091     <span class="keyword">if</span> hasDeletedSubSystem==false
0092         <span class="keyword">if</span> isfield(models{i},<span class="string">'subSystems'</span>)
0093             model.subSystems=[model.subSystems;models{i}.subSystems];
0094         <span class="keyword">else</span>
0095            <span class="keyword">if</span> supressWarnings==false
0096                 <a href="dispEM.html" class="code" title="function dispEM(string,throwErrors,toList,trimWarnings)">dispEM</a>(<span class="string">'Cannot add subsystems since the existing model has no subsystems info. All reactions must have a subsystem for this to be included. Deleting subSystems field'</span>,false);  
0097            <span class="keyword">end</span>
0098            hasDeletedSubSystem=true;
0099            model=rmfield(model,<span class="string">'subSystems'</span>);
0100         <span class="keyword">end</span>
0101     <span class="keyword">end</span>
0102     
0103     <span class="keyword">if</span> isfield(models{i},<span class="string">'eccodes'</span>)
0104        <span class="keyword">if</span> isfield(model,<span class="string">'eccodes'</span>)
0105            model.eccodes=[model.eccodes;models{i}.eccodes];
0106        <span class="keyword">else</span>
0107            emptyEC=cell(numel(model.rxns)-numel(models{i}.rxns),1);
0108            emptyEC(:)={<span class="string">''</span>};
0109            model.eccodes=[emptyEC;models{i}.eccodes];
0110        <span class="keyword">end</span>
0111     <span class="keyword">else</span>
0112        <span class="keyword">if</span> isfield(model,<span class="string">'eccodes'</span>)
0113            emptyEC=cell(numel(models{i}.rxns),1);
0114            emptyEC(:)={<span class="string">''</span>};
0115            model.eccodes=[model.eccodes;emptyEC];
0116        <span class="keyword">end</span> 
0117     <span class="keyword">end</span>
0118     
0119     <span class="keyword">if</span> isfield(models{i},<span class="string">'rxnMiriams'</span>)
0120        <span class="keyword">if</span> isfield(model,<span class="string">'rxnMiriams'</span>)
0121            model.rxnMiriams=[model.rxnMiriams;models{i}.rxnMiriams];
0122        <span class="keyword">else</span>
0123            model.rxnMiriams=[cell(numel(model.rxns)-numel(models{i}.rxns),1);models{i}.rxnMiriams];
0124        <span class="keyword">end</span>
0125     <span class="keyword">else</span>
0126        <span class="keyword">if</span> isfield(model,<span class="string">'rxnMiriams'</span>)
0127            model.rxnMiriams=[model.rxnMiriams;cell(numel(models{i}.rxns),1)];
0128        <span class="keyword">end</span> 
0129     <span class="keyword">end</span>
0130     
0131     <span class="keyword">if</span> isfield(models{i},<span class="string">'rxnComps'</span>)
0132        <span class="keyword">if</span> isfield(model,<span class="string">'rxnComps'</span>)
0133            model.rxnComps=[model.rxnComps;models{i}.rxnComps];
0134        <span class="keyword">else</span>
0135            model.rxnComps=[ones(numel(model.rxns)-numel(models{i}.rxns),1);models{i}.rxnComps];
0136            fprintf(<span class="string">'NOTE: One of the models does not contain compartment information for its reactions. All reactions in that model has been assigned to the first compartment\n'</span>);
0137        <span class="keyword">end</span>
0138     <span class="keyword">else</span>
0139        <span class="keyword">if</span> isfield(model,<span class="string">'rxnComps'</span>)
0140            model.rxnComps=[model.rxnComps;ones(numel(models{i}.rxns),1)];
0141            fprintf(<span class="string">'NOTE: One of the models does not contain compartment information for its reactions. All reactions in that model has been assigned to the first compartment\n'</span>);
0142        <span class="keyword">end</span> 
0143     <span class="keyword">end</span>
0144     
0145     <span class="keyword">if</span> isfield(models{i},<span class="string">'rxnScores'</span>)
0146        <span class="keyword">if</span> isfield(model,<span class="string">'rxnScores'</span>)
0147            model.rxnScores=[model.rxnScores;models{i}.rxnScores];
0148        <span class="keyword">else</span>
0149            emptyRS=zeros(numel(model.rxns)-numel(models{i}.rxns),1);
0150            model.rxnScores=[emptyRS;models{i}.rxnScores];
0151        <span class="keyword">end</span>
0152     <span class="keyword">else</span>
0153        <span class="keyword">if</span> isfield(model,<span class="string">'rxnScores'</span>)
0154            emptyRS=zeros(numel(models{i}.rxns),1);
0155            model.rxnScores=[model.rxnScores;emptyRS];
0156        <span class="keyword">end</span> 
0157     <span class="keyword">end</span>
0158     
0159     <span class="comment">%Get the new metabolites from matching the models.</span>
0160     <span class="comment">%Metabolites are said to be the same if they share name and</span>
0161     <span class="comment">%compartment id. This means that metabolite IDs are not taken into</span>
0162     <span class="comment">%account.</span>
0163     oldMetComps=model.comps(model.metComps);
0164     oldMets=strcat(model.metNames,<span class="string">'['</span>,oldMetComps,<span class="string">']'</span>);
0165     <span class="comment">%This is because it makes a '[]' string if no new metabolites</span>
0166     <span class="keyword">if</span> ~isempty(models{i}.metNames)
0167         newMetComps=models{i}.comps(models{i}.metComps);
0168         newMets=strcat(models{i}.metNames,<span class="string">'['</span>,newMetComps,<span class="string">']'</span>);
0169     <span class="keyword">else</span>
0170         newMets={};
0171         newMetComps={};
0172     <span class="keyword">end</span>
0173     tf=ismember(newMets,oldMets);
0174     metsToAdd=find(~tf);
0175     
0176     <span class="comment">%First add the new metabolites</span>
0177     <span class="comment">%Make sure that there are no conflicting metabolite ids</span>
0178     [conflicting,crap]=ismember(models{i}.mets(metsToAdd),model.mets);
0179     
0180     conflicting=find(conflicting);
0181     
0182     <span class="keyword">if</span> ~isempty(conflicting)
0183        printString=cell(numel(conflicting),1);
0184        <span class="keyword">for</span> j=1:numel(conflicting)
0185            printString{j}=[<span class="string">'Old: '</span> models{i}.mets{metsToAdd(conflicting(j))} <span class="string">' New: '</span> models{i}.mets{metsToAdd(conflicting(j))} <span class="string">'_'</span> models{i}.id];
0186            models{i}.mets{metsToAdd(conflicting(j))}=[models{i}.mets{metsToAdd(conflicting(j))} <span class="string">'_'</span> models{i}.id];
0187        <span class="keyword">end</span>
0188        <span class="keyword">if</span> supressWarnings==false
0189            <a href="dispEM.html" class="code" title="function dispEM(string,throwErrors,toList,trimWarnings)">dispEM</a>([<span class="string">'The following metabolite IDs in '</span> models{i}.id <span class="string">' are already present in the model and were renamed:'</span>],false,printString);
0190        <span class="keyword">end</span>
0191     <span class="keyword">end</span>
0192     
0193     <span class="comment">%Add static info on the metabolites</span>
0194     metFrom=cell(numel(metsToAdd),1);
0195     metFrom(:)={models{i}.id};
0196     model.metFrom=[model.metFrom;metFrom];
0197     model.mets=[model.mets;models{i}.mets(metsToAdd)];
0198     model.metNames=[model.metNames;models{i}.metNames(metsToAdd)];
0199     model.b=[model.b;zeros(numel(metsToAdd),size(model.b,2))];
0200     
0201     <span class="keyword">if</span> isfield(model,<span class="string">'unconstrained'</span>)
0202        <span class="keyword">if</span> isfield(models{i},<span class="string">'unconstrained'</span>)
0203             model.unconstrained=[model.unconstrained;models{i}.unconstrained(metsToAdd)];
0204        <span class="keyword">else</span>
0205            model.unconstrained=[model.unconstrained;zeros(numel(metsToAdd),1)];
0206        <span class="keyword">end</span>
0207     <span class="keyword">else</span>
0208        <span class="keyword">if</span> isfield(models{i},<span class="string">'unconstrained'</span>)
0209           model.unconstrained=[zeros(numel(model.mets),1);models{i}.unconstrained(metsToAdd)];
0210        <span class="keyword">end</span>
0211     <span class="keyword">end</span>
0212     
0213     <span class="comment">%Only add extra info on new metabolites since it's a little tricky to</span>
0214     <span class="comment">%chose what to keep otherwise. Should change in the future</span>
0215     <span class="keyword">if</span> ~isempty(metsToAdd)
0216         <span class="keyword">if</span> isfield(models{i},<span class="string">'inchis'</span>)
0217            <span class="keyword">if</span> isfield(model,<span class="string">'inchis'</span>)
0218                model.inchis=[model.inchis;models{i}.inchis(metsToAdd)];
0219            <span class="keyword">else</span>
0220                emptyInchi=cell(numel(model.mets)-numel(metsToAdd),1);
0221                emptyInchi(:)={<span class="string">''</span>};
0222                model.inchis=[emptyInchi;models{i}.inchis(metsToAdd)];
0223            <span class="keyword">end</span>
0224         <span class="keyword">else</span>
0225            <span class="keyword">if</span> isfield(model,<span class="string">'inchis'</span>)
0226                emptyInchi=cell(numel(metsToAdd),1);
0227                emptyInchi(:)={<span class="string">''</span>};
0228                model.inchis=[model.inchis;emptyInchi];
0229            <span class="keyword">end</span> 
0230         <span class="keyword">end</span>
0231         
0232         <span class="keyword">if</span> isfield(models{i},<span class="string">'metFormulas'</span>)
0233            <span class="keyword">if</span> isfield(model,<span class="string">'metFormulas'</span>)
0234                model.metFormulas=[model.metFormulas;models{i}.metFormulas(metsToAdd)];
0235            <span class="keyword">else</span>
0236                emptyMetFormulas=cell(numel(model.mets)-numel(metsToAdd),1);
0237                emptyMetFormulas(:)={<span class="string">''</span>};
0238                model.metFormulas=[emptyMetFormulas;models{i}.metFormulas(metsToAdd)];
0239            <span class="keyword">end</span>
0240         <span class="keyword">else</span>
0241            <span class="keyword">if</span> isfield(model,<span class="string">'metFormulas'</span>)
0242                emptyMetFormulas=cell(numel(metsToAdd),1);
0243                emptyMetFormulas(:)={<span class="string">''</span>};
0244                model.metFormulas=[model.metFormulas;emptyMetFormulas];
0245            <span class="keyword">end</span> 
0246         <span class="keyword">end</span>
0247         
0248         <span class="keyword">if</span> isfield(models{i},<span class="string">'metMiriams'</span>)
0249            <span class="keyword">if</span> isfield(model,<span class="string">'metMiriams'</span>)
0250                model.metMiriams=[model.metMiriams;models{i}.metMiriams(metsToAdd)];
0251            <span class="keyword">else</span>
0252                emptyMetMiriam=cell(numel(model.mets)-numel(metsToAdd),1);
0253                model.metMiriams=[emptyMetMiriam;models{i}.metMiriams(metsToAdd)];
0254            <span class="keyword">end</span>
0255         <span class="keyword">else</span>
0256            <span class="keyword">if</span> isfield(model,<span class="string">'metMiriams'</span>)
0257                emptyMetMiriam=cell(numel(metsToAdd),1);
0258                model.metMiriams=[model.metMiriams;emptyMetMiriam];
0259            <span class="keyword">end</span> 
0260         <span class="keyword">end</span>
0261     <span class="keyword">end</span>
0262     
0263     <span class="comment">%Add if there are any new compartments and add those. This can change</span>
0264     <span class="comment">%the order of compartments and the corresponding indexes in</span>
0265     <span class="comment">%model.metComps.</span>
0266     
0267     <span class="comment">%Find overlapping and new compartments</span>
0268     [overlap oldIDs]=ismember(models{i}.comps,model.comps);
0269     overlap=find(overlap);
0270     
0271     <span class="comment">%Add the new compartments if any</span>
0272     <span class="keyword">if</span> numel(overlap)~=numel(models{i}.compNames)
0273         compIndexes=oldIDs==0;
0274         
0275         <span class="comment">%Make sure that there are no conflicting compartment ids</span>
0276         [crap, conflicting]=ismember(models{i}.compNames(compIndexes),model.compNames);
0277         <a href="dispEM.html" class="code" title="function dispEM(string,throwErrors,toList,trimWarnings)">dispEM</a>([<span class="string">'The following compartment IDs in '</span> models{i}.id <span class="string">' are already present in the model but with another name. They have to be renamed'</span>],true,model.comps(conflicting));
0278         
0279         <span class="comment">%It's ok to add duplicate name, but not duplicate IDs</span>
0280         model.compNames=[model.compNames; models{i}.compNames(compIndexes)];
0281         model.comps=[model.comps; models{i}.comps(compIndexes)];
0282         <span class="keyword">if</span> isfield(model,<span class="string">'compOutside'</span>)
0283             <span class="keyword">if</span> isfield(models{i},<span class="string">'compOutside'</span>)
0284                 model.compOutside=[model.compOutside; models{i}.compOutside(compIndexes)];
0285             <span class="keyword">else</span>
0286                 <span class="comment">%This is if not all models have the field</span>
0287                 padding=cell(sum(compIndexes),1);
0288                 padding(:)={<span class="string">''</span>};
0289                 model.compOutside=[model.compOutside;padding];
0290             <span class="keyword">end</span>
0291         <span class="keyword">end</span>
0292         <span class="keyword">if</span> isfield(model,<span class="string">'compMiriams'</span>)
0293             <span class="keyword">if</span> isfield(models{i},<span class="string">'compMiriams'</span>)
0294                 model.compMiriams=[model.compMiriams; models{i}.compMiriams(compIndexes)];
0295             <span class="keyword">else</span>
0296                 <span class="comment">%This is if not all models have the field</span>
0297                 model.compMiriams=[model.compMiriams;cell(sum(compIndexes),1)];
0298             <span class="keyword">end</span>
0299         <span class="keyword">end</span>
0300     <span class="keyword">end</span>
0301     
0302     <span class="comment">%Only add new comp info on the un-matched metabolites since the old ones will</span>
0303     <span class="comment">%be mapped to the existing list anyways</span>
0304     [I J]=ismember(newMetComps(metsToAdd),model.comps);
0305     <span class="comment">%Just a check</span>
0306     <span class="keyword">if</span> ~all(I)
0307         <a href="dispEM.html" class="code" title="function dispEM(string,throwErrors,toList,trimWarnings)">dispEM</a>(<span class="string">'There was an unexplained error in matching compartments'</span>);
0308     <span class="keyword">end</span>
0309     model.metComps=[model.metComps;J];
0310     
0311     <span class="comment">%Create the new stoichiometric matrix</span>
0312     model.S=[model.S;sparse(numel(metsToAdd),size(model.S,2))];
0313     
0314     <span class="comment">%Rematch metabolite names. Not the most clever way to do it maybe</span>
0315     allMets=strcat(model.metNames,<span class="string">'['</span>,model.comps(model.metComps),<span class="string">']'</span>);
0316     [crap J]=ismember(newMets,allMets);
0317     
0318     <span class="comment">%Update the stoichiometric matrix for the model to add</span>
0319     newS=sparse(numel(model.mets),numel(models{i}.rxns));
0320     newS(J,:)=models{i}.S;
0321     
0322     model.S=[model.S newS];
0323     
0324     <span class="comment">%Now add new genes</span>
0325     <span class="keyword">if</span> isfield(models{i},<span class="string">'genes'</span>)
0326         <span class="keyword">if</span> ~isfield(model,<span class="string">'genes'</span>)
0327             <span class="comment">%If there was no gene info before</span>
0328             model.genes=models{i}.genes;
0329             model.rxnGeneMat=[sparse(numel(model.rxns),numel(models{i}.genes));models{i}.rxnGeneMat];
0330             emptyGene=cell(numel(model.rxns),1);
0331             emptyGene(:)={<span class="string">''</span>};
0332             model.grRules=[emptyGene;models{i}.grRules];
0333             model.geneFrom=cell(numel(models{i}.genes),1);
0334             model.geneFrom(:)={models{i}.id};
0335             
0336             <span class="keyword">if</span> isfield(models{i},<span class="string">'geneShortNames'</span>)
0337                model.geneShortNames=models{i}.geneShortNames; 
0338             <span class="keyword">end</span>
0339             
0340             <span class="keyword">if</span> isfield(models{i},<span class="string">'geneMiriams'</span>)
0341                model.geneMiriams=models{i}.geneMiriams; 
0342             <span class="keyword">end</span>
0343             
0344             <span class="keyword">if</span> isfield(models{i},<span class="string">'geneComps'</span>)
0345                model.geneComps=models{i}.geneComps; 
0346             <span class="keyword">end</span>
0347         <span class="keyword">else</span>
0348             <span class="comment">%If gene info should be merged</span>
0349             [a crap]=ismember(models{i}.genes,model.genes);
0350             
0351             genesToAdd=find(~a);
0352             
0353             <span class="comment">%Only add extra gene info on new genes. This might not be</span>
0354             <span class="comment">%correct and should be changed later...</span>
0355             <span class="keyword">if</span> ~isempty(genesToAdd)
0356                 model.genes=[model.genes;models{i}.genes(genesToAdd)];
0357                 emptyGene=cell(numel(genesToAdd),1);
0358                 emptyGene(:)={models{i}.id};
0359                 model.geneFrom=[model.geneFrom;emptyGene];
0360                 model.rxnGeneMat=[model.rxnGeneMat sparse(size(model.rxnGeneMat,1),numel(genesToAdd))];
0361                 
0362                 <span class="keyword">if</span> isfield(models{i},<span class="string">'geneShortNames'</span>)
0363                     <span class="keyword">if</span> isfield(model,<span class="string">'geneShortNames'</span>)
0364                         model.geneShortNames=[model.geneShortNames;models{i}.geneShortNames(genesToAdd)];
0365                     <span class="keyword">else</span>
0366                         emptyGeneSN=cell(numel(model.genes)-numel(genesToAdd),1);
0367                         emptyGeneSN(:)={<span class="string">''</span>};
0368                         model.geneShortNames=[emptyGeneSN;models{i}.geneShortNames(genesToAdd)];
0369                     <span class="keyword">end</span>
0370                 <span class="keyword">else</span>
0371                     <span class="keyword">if</span> isfield(model,<span class="string">'geneShortNames'</span>)
0372                         emptyGeneSN=cell(numel(genesToAdd),1);
0373                         emptyGeneSN(:)={<span class="string">''</span>};
0374                         model.geneShortNames=[model.geneShortNames;emptyGeneSN];   
0375                     <span class="keyword">end</span>
0376                 <span class="keyword">end</span>
0377 
0378                 <span class="keyword">if</span> isfield(models{i},<span class="string">'geneMiriams'</span>)
0379                     <span class="keyword">if</span> isfield(model,<span class="string">'geneMiriams'</span>)
0380                         model.geneMiriams=[model.geneMiriams;models{i}.geneMiriams(genesToAdd)];
0381                     <span class="keyword">else</span>
0382                         emptyGeneMir=cell(numel(model.genes)-numel(genesToAdd),1);
0383                         model.geneMiriams=[emptyGeneMir;models{i}.geneMiriams(genesToAdd)];
0384                     <span class="keyword">end</span>
0385                 <span class="keyword">else</span>
0386                     <span class="keyword">if</span> isfield(model,<span class="string">'geneMiriams'</span>)
0387                         emptyGeneMir=cell(numel(genesToAdd),1);
0388                         model.geneMiriams=[model.geneMiriams;emptyGeneMir];   
0389                     <span class="keyword">end</span>
0390                 <span class="keyword">end</span>
0391                 
0392                 <span class="keyword">if</span> isfield(models{i},<span class="string">'geneComps'</span>)
0393                     <span class="keyword">if</span> isfield(model,<span class="string">'geneComps'</span>)
0394                         model.geneComps=[model.geneComps;models{i}.geneComps(genesToAdd)];
0395                     <span class="keyword">else</span>
0396                         emptyGeneMir=ones(numel(model.genes)-numel(genesToAdd),1);
0397                         model.geneComps=[emptyGeneMir;models{i}.geneComps(genesToAdd)];
0398                         <a href="dispEM.html" class="code" title="function dispEM(string,throwErrors,toList,trimWarnings)">dispEM</a>(<span class="string">'Adding genes with compartment information to a model without such information. All existing genes will be assigned to the first compartment'</span>,false);
0399                     <span class="keyword">end</span>
0400                 <span class="keyword">else</span>
0401                     <span class="keyword">if</span> isfield(model,<span class="string">'geneComps'</span>)
0402                         emptyGeneMir=ones(numel(genesToAdd),1);
0403                         model.geneComps=[model.geneComps;emptyGeneMir];
0404                         <a href="dispEM.html" class="code" title="function dispEM(string,throwErrors,toList,trimWarnings)">dispEM</a>(<span class="string">'Adding genes with compartment information to a model without such information. All existing genes will be assigned to the first compartment'</span>,false);
0405                     <span class="keyword">end</span>
0406                 <span class="keyword">end</span>
0407             <span class="keyword">end</span>
0408             
0409             <span class="comment">%Remap the genes from the new model. The same thing as with</span>
0410             <span class="comment">%mets; this is a wasteful way to do it but I don't care right</span>
0411             <span class="comment">%now</span>
0412             [a b]=ismember(models{i}.genes,model.genes);
0413             
0414             <span class="comment">%Just a check</span>
0415             <span class="keyword">if</span> ~all(a)
0416                 <a href="dispEM.html" class="code" title="function dispEM(string,throwErrors,toList,trimWarnings)">dispEM</a>(<span class="string">'There was an unexplained error in matching genes'</span>);
0417             <span class="keyword">end</span>
0418             
0419             <span class="comment">%Create the new rxnGene matrix</span>
0420             rxnGeneMat=sparse(numel(models{i}.rxns),numel(model.genes));
0421             rxnGeneMat(:,b)=models{i}.rxnGeneMat;
0422             model.rxnGeneMat=[model.rxnGeneMat; rxnGeneMat];
0423             model.grRules=[model.grRules;models{i}.grRules];
0424         <span class="keyword">end</span>
0425     <span class="keyword">else</span>
0426         <span class="comment">%Add empty gene associations</span>
0427         <span class="keyword">if</span> isfield(model,<span class="string">'genes'</span>)
0428             model.rxnGeneMat=[model.rxnGeneMat;sparse(numel(models{i}.rxns),numel(model.genes))];
0429             emptyGene=cell(numel(models{i}.rxns),1);
0430             emptyGene(:)={<span class="string">''</span>};
0431             model.grRules=[model.grRules;emptyGene];
0432         <span class="keyword">end</span>
0433     <span class="keyword">end</span>
0434 <span class="keyword">end</span>
0435 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Fri 14-Oct-2016 12:02:10 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>