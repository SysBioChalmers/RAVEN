<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of randomSampling</title>
  <meta name="keywords" content="randomSampling">
  <meta name="description" content="randomSampling">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">core</a> &gt; randomSampling.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for core&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>randomSampling
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>randomSampling</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [solutions, goodRxns]=randomSampling(model,nSamples,replaceBoundsWithInf,supressErrors,runParallel,goodRxns,minFlux) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> randomSampling
   Performs random sampling of the solution space, as described in Bordel
   et al. (2010) PLOS Compt Biol (doi:10.1371/journal.pcbi.1000859).

 Input:
   model                   a model structure
   nSamples                the number of solutions to return
                           (optional, default 1000)
   replaceBoundsWithInf    replace the largest upper bounds with Inf and
                           the smallest lower bounds with -Inf. This is
                           needed in order to get solutions without loops
                           if your model has for example 1000/-1000 as
                           arbitary large bounds. If your model only has
                           &quot;biologically relevant&quot; bounds, then set this
                           to false (optional, default true)
   supressErrors           the program will halt if it has problems
                           finding non-zero solutions which are not
                           involved in loops. This could be because the
                           constraints on the model are too relaxed (such
                           as unlimited glucose uptake) or too strict
                           (such as too many and too narrow constraints)
                           (optional, default false)
   runParallel             speed up calculations by parallel processing.
                           Requires MATLAB Parallel Computing Toolbox. If
                           this is not installed, the calculations will
                           not be parallelized, regardless what is
                           indicated as runParallel. (optional, default
                           true)
   goodRxns                double vector of indexes of those reactions
                           that are not involved in loops and can be used
                           as random objective functions, as generated by
                           a previous run of randomSampling on the same
                           model (optional, default empty)
   minFlux                 determines if a second optimization should be
                           performed for each random sample, to minimize
                           the number of fluxes and thereby preventing
                           loops. Typically, loops are averaged out when a
                           large number of samples are taken, but this is
                           not always the case (optional, default false)

 Output:
   solutions               matrix with the solutions
   goodRxns                double vector of indexes of those reactions
                           that are not involved in loops and can be used
                           as random objective functions

 The solutions are generated by maximizing (with random weights) for a
 random set of three reactions. For reversible reactions it randomly
 chooses between maximizing and minimizing.

 Usage: solutions = randomSampling(model, nSamples, replaceBoundsWithInf,...
                       supressErrors, runParallel, goodRxns, minFlux)</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="dispEM.html" class="code" title="function dispEM(string,throwErrors,toList,trimWarnings)">dispEM</a>	dispEM</li><li><a href="parallelPoolRAVEN.html" class="code" title="function [ps, oldPoolAutoCreate] = parallelPoolRAVEN(runParallel)">parallelPoolRAVEN</a>	handleParallelRAVEN</li><li><a href="setParam.html" class="code" title="function model=setParam(model, paramType, rxnList, params, var)">setParam</a>	setParam</li><li><a href="simplifyModel.html" class="code" title="function [reducedModel, deletedReactions, deletedMetabolites]=simplifyModel(model,deleteUnconstrained, deleteDuplicates, deleteZeroInterval, deleteInaccessible, deleteMinMax, groupLinear, constrainReversible, reservedRxns, suppressWarnings)">simplifyModel</a>	simplifyModel</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function I=randsample(n,k,replacement)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [solutions, goodRxns]=randomSampling(model,nSamples,replaceBoundsWithInf,supressErrors,runParallel,goodRxns,minFlux)</a>
0002 <span class="comment">% randomSampling</span>
0003 <span class="comment">%   Performs random sampling of the solution space, as described in Bordel</span>
0004 <span class="comment">%   et al. (2010) PLOS Compt Biol (doi:10.1371/journal.pcbi.1000859).</span>
0005 <span class="comment">%</span>
0006 <span class="comment">% Input:</span>
0007 <span class="comment">%   model                   a model structure</span>
0008 <span class="comment">%   nSamples                the number of solutions to return</span>
0009 <span class="comment">%                           (optional, default 1000)</span>
0010 <span class="comment">%   replaceBoundsWithInf    replace the largest upper bounds with Inf and</span>
0011 <span class="comment">%                           the smallest lower bounds with -Inf. This is</span>
0012 <span class="comment">%                           needed in order to get solutions without loops</span>
0013 <span class="comment">%                           if your model has for example 1000/-1000 as</span>
0014 <span class="comment">%                           arbitary large bounds. If your model only has</span>
0015 <span class="comment">%                           &quot;biologically relevant&quot; bounds, then set this</span>
0016 <span class="comment">%                           to false (optional, default true)</span>
0017 <span class="comment">%   supressErrors           the program will halt if it has problems</span>
0018 <span class="comment">%                           finding non-zero solutions which are not</span>
0019 <span class="comment">%                           involved in loops. This could be because the</span>
0020 <span class="comment">%                           constraints on the model are too relaxed (such</span>
0021 <span class="comment">%                           as unlimited glucose uptake) or too strict</span>
0022 <span class="comment">%                           (such as too many and too narrow constraints)</span>
0023 <span class="comment">%                           (optional, default false)</span>
0024 <span class="comment">%   runParallel             speed up calculations by parallel processing.</span>
0025 <span class="comment">%                           Requires MATLAB Parallel Computing Toolbox. If</span>
0026 <span class="comment">%                           this is not installed, the calculations will</span>
0027 <span class="comment">%                           not be parallelized, regardless what is</span>
0028 <span class="comment">%                           indicated as runParallel. (optional, default</span>
0029 <span class="comment">%                           true)</span>
0030 <span class="comment">%   goodRxns                double vector of indexes of those reactions</span>
0031 <span class="comment">%                           that are not involved in loops and can be used</span>
0032 <span class="comment">%                           as random objective functions, as generated by</span>
0033 <span class="comment">%                           a previous run of randomSampling on the same</span>
0034 <span class="comment">%                           model (optional, default empty)</span>
0035 <span class="comment">%   minFlux                 determines if a second optimization should be</span>
0036 <span class="comment">%                           performed for each random sample, to minimize</span>
0037 <span class="comment">%                           the number of fluxes and thereby preventing</span>
0038 <span class="comment">%                           loops. Typically, loops are averaged out when a</span>
0039 <span class="comment">%                           large number of samples are taken, but this is</span>
0040 <span class="comment">%                           not always the case (optional, default false)</span>
0041 <span class="comment">%</span>
0042 <span class="comment">% Output:</span>
0043 <span class="comment">%   solutions               matrix with the solutions</span>
0044 <span class="comment">%   goodRxns                double vector of indexes of those reactions</span>
0045 <span class="comment">%                           that are not involved in loops and can be used</span>
0046 <span class="comment">%                           as random objective functions</span>
0047 <span class="comment">%</span>
0048 <span class="comment">% The solutions are generated by maximizing (with random weights) for a</span>
0049 <span class="comment">% random set of three reactions. For reversible reactions it randomly</span>
0050 <span class="comment">% chooses between maximizing and minimizing.</span>
0051 <span class="comment">%</span>
0052 <span class="comment">% Usage: solutions = randomSampling(model, nSamples, replaceBoundsWithInf,...</span>
0053 <span class="comment">%                       supressErrors, runParallel, goodRxns, minFlux)</span>
0054 
0055 <span class="keyword">if</span> nargin&lt;2 | isempty(nSamples)
0056     nSamples=1000;
0057 <span class="keyword">end</span>
0058 <span class="keyword">if</span> nargin&lt;3 | isempty(replaceBoundsWithInf)
0059     replaceBoundsWithInf=true;
0060 <span class="keyword">end</span>
0061 <span class="keyword">if</span> nargin&lt;4 | isempty(supressErrors)
0062     supressErrors=false;
0063 <span class="keyword">end</span>
0064 <span class="keyword">if</span> nargin&lt;5 | isempty(runParallel)
0065     runParallel=true;
0066 <span class="keyword">end</span>
0067 <span class="keyword">if</span> nargin&lt;7 | isempty(minFlux)
0068     minFlux=false;
0069 <span class="keyword">end</span>
0070 
0071 [ps, oldPoolAutoCreateSetting] = <a href="parallelPoolRAVEN.html" class="code" title="function [ps, oldPoolAutoCreate] = parallelPoolRAVEN(runParallel)">parallelPoolRAVEN</a>(runParallel);
0072 
0073 nObjRxns=2; <span class="comment">%Number of reactions in the objective function in each iteration</span>
0074 
0075 <span class="comment">%Simplify the model to speed stuff up a little. Keep original mapping</span>
0076 originalRxns=model.rxns;
0077 model=<a href="simplifyModel.html" class="code" title="function [reducedModel, deletedReactions, deletedMetabolites]=simplifyModel(model,deleteUnconstrained, deleteDuplicates, deleteZeroInterval, deleteInaccessible, deleteMinMax, groupLinear, constrainReversible, reservedRxns, suppressWarnings)">simplifyModel</a>(model,false,false,true,true);
0078 
0079 <span class="comment">%Then change the bounds to +/- Inf. This is needed in order to not have</span>
0080 <span class="comment">%loops in the solutions</span>
0081 <span class="keyword">if</span> replaceBoundsWithInf==true
0082     model.ub(model.ub==max(model.ub))=Inf;
0083     <span class="keyword">if</span> min(model.lb)&lt;0 <span class="comment">% Only negative lower bounds should be set to -Inf</span>
0084         model.lb(model.lb==min(model.lb))=-Inf;
0085     <span class="keyword">end</span>
0086 <span class="keyword">end</span>
0087 
0088 <span class="comment">%Check that the model is feasible given the constraints</span>
0089 [sol,~]=solveLP(model);
0090 <span class="keyword">if</span> isempty(sol.x)
0091     EM=<span class="string">'The model has no feasible solution, likely due to incompatible constraints'</span>;
0092     <a href="dispEM.html" class="code" title="function dispEM(string,throwErrors,toList,trimWarnings)">dispEM</a>(EM);
0093 <span class="keyword">elseif</span> sol.f==0 &amp;&amp; showProgress
0094     warning(<span class="string">'The model objective function cannot reach a non-zero value. This might be intended, so randomSampling will continue, but this could indicate problems with your model'</span>)
0095 <span class="keyword">end</span>
0096 
0097 [~,hsSol]=solveLP(model);
0098 nRxns = numel(model.rxns);
0099 <span class="comment">%Reactions which can be involved in loops should not be optimized for.</span>
0100 <span class="comment">%Check which reactions reach an arbitary high upper bound</span>
0101 <span class="keyword">if</span> nargin&lt;6 || isempty(goodRxns)
0102     goodRxns = true(numel(model.rxns),numel(model.rxns));
0103     goodRxns = num2cell(goodRxns,1);
0104     PB = ProgressBar2(nRxns,<span class="string">'Prepare goodRxns not involved in loops'</span>,<span class="string">'cli'</span>);
0105     parfor (i=1:nRxns)
0106         testModel=<a href="setParam.html" class="code" title="function model=setParam(model, paramType, rxnList, params, var)">setParam</a>(model,<span class="string">'eq'</span>,model.rxns(i),1000);
0107         sol=solveLP(testModel,0,[],hsSol);
0108         <span class="keyword">if</span> ~isempty(sol.f)
0109             notGood = abs(sol.x)&gt;999;
0110             goodRxns{i}(notGood)=false;
0111         <span class="keyword">else</span>
0112             <span class="comment">%If the reaction is reversible, also check in that direction</span>
0113             <span class="keyword">if</span> model.rev(i)
0114                 testModel=<a href="setParam.html" class="code" title="function model=setParam(model, paramType, rxnList, params, var)">setParam</a>(model,<span class="string">'eq'</span>,model.rxns(i),-1000);
0115                 sol=solveLP(testModel,0,[],hsSol);
0116                 <span class="keyword">if</span> ~isempty(sol.f)
0117                     notGood = abs(sol.x)&gt;999;
0118                     goodRxns{i}(notGood)=false;
0119                 <span class="keyword">end</span>
0120             <span class="keyword">end</span>
0121         <span class="keyword">end</span>
0122         count(PB);
0123     <span class="keyword">end</span>
0124     goodRxns = cell2mat(goodRxns);
0125     goodRxns = find(prod(goodRxns,2));
0126 <span class="keyword">end</span>
0127 
0128 <span class="comment">%Reserve space for a solution matrix</span>
0129 sols = zeros(numel(model.rxns),nSamples);
0130 sols = num2cell(sols,1);
0131 
0132 <span class="comment">%Main loop</span>
0133 <span class="keyword">if</span> nSamples &gt; 0
0134 
0135     PB = ProgressBar2(nSamples,<span class="string">'Performing random sampling'</span>,<span class="string">'cli'</span>);
0136     parfor i=1:nSamples
0137         badSolutions = 1;
0138         tmpModel = model;
0139         <span class="keyword">while</span> lt(0,badSolutions)
0140             rxns = <a href="#_sub1" class="code" title="subfunction I=randsample(n,k,replacement)">randsample</a>(numel(goodRxns),nObjRxns);
0141             tmpModel.c = zeros(numel(tmpModel.rxns),1);
0142             multipliers = <a href="#_sub1" class="code" title="subfunction I=randsample(n,k,replacement)">randsample</a>([-1 1],nObjRxns,true);
0143             multipliers(tmpModel.rev(goodRxns(rxns))==0) = 1;
0144             tmpModel.c(goodRxns(rxns)) = rand(nObjRxns,1).*multipliers;
0145             <span class="keyword">if</span> true(minFlux)
0146                 sol=solveLP(tmpModel,1,[],hsSol);
0147             <span class="keyword">else</span>
0148                 sol=solveLP(tmpModel,0,[],hsSol);
0149             <span class="keyword">end</span>
0150             <span class="keyword">if</span> any(sol.x) &amp;&amp; abs(sol.f)&gt;10^-8
0151                 sols{i} = sol.x;
0152                 badSolutions = 0;
0153             <span class="keyword">else</span>
0154                 badSolutions = badSolutions+1;
0155                 <span class="comment">%If it only finds bad solutions then throw an error.</span>
0156                 <span class="keyword">if</span> badSolutions == 100 &amp;&amp; supressErrors==false
0157                     error(<span class="string">'The program is having problems finding non-zero solutions (ignoring reactions that might be involved in loops). Review the constraints on your model. Set supressErrors to true to ignore this error'</span>);
0158                 <span class="keyword">end</span>
0159             <span class="keyword">end</span>
0160         <span class="keyword">end</span>
0161         count(PB);
0162     <span class="keyword">end</span>
0163 
0164     <span class="comment">%Map to original model</span>
0165     sols = cell2mat(sols);
0166     [~, I]=ismember(model.rxns,originalRxns);
0167     solutions=zeros(numel(originalRxns),nSamples);
0168     solutions(I,:)=sols;
0169     solutions=sparse(solutions);
0170 <span class="keyword">else</span>
0171     solutions=[];
0172 <span class="keyword">end</span>
0173 <span class="comment">% Reset original Parallel setting</span>
0174 ps.Pool.AutoCreate = oldPoolAutoCreateSetting;
0175 <span class="keyword">end</span>
0176 
0177 <span class="comment">%To use instead of the normal Matlab randsample function. This is in order</span>
0178 <span class="comment">%to not depend on the Matlab statistical toolbox.</span>
0179 <a name="_sub1" href="#_subfunctions" class="code">function I=randsample(n,k,replacement)</a>
0180 <span class="keyword">if</span> nargin&lt;3
0181     replacement=false;
0182 <span class="keyword">end</span>
0183 <span class="comment">%n can be a integer, which leads to I being sampled from 1:n, or it can be</span>
0184 <span class="comment">%a population to sample from.</span>
0185 <span class="keyword">if</span> numel(n)==1 &amp;&amp; isnumeric(n)
0186     n=1:n;
0187 <span class="keyword">end</span>
0188 <span class="comment">%Loop and get random numbers until the list is unique. This is only a good</span>
0189 <span class="comment">%option is the number of samples is small compared to the population. There</span>
0190 <span class="comment">%are several checks that should be made here, for example regarding size</span>
0191 <span class="comment">%and that the number of samples is &lt;=population size if replacement==false.</span>
0192 <span class="comment">%This is not the case in randomSampling, so such checks are ignored</span>
0193 <span class="keyword">while</span> true
0194     J=randi(numel(n),[k,1]);
0195     <span class="keyword">if</span> replacement==true || numel(J)==numel(unique(J))
0196         I=n(J);
0197         <span class="keyword">break</span>;
0198     <span class="keyword">end</span>
0199 <span class="keyword">end</span>
0200 I=I(:);
0201 <span class="keyword">end</span></pre></div>
<hr><address>Generated by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>