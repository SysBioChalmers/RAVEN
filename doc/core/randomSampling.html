<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of randomSampling</title>
  <meta name="keywords" content="randomSampling">
  <meta name="description" content="randomSampling">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">core</a> &gt; randomSampling.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for core&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>randomSampling
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>randomSampling</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function solutions=randomSampling(model, nSamples, replaceBoundsWithInf,supressErrors) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> randomSampling
   Returns a number of random solutions

   model                   a model structure
   nSamples                the number of solutions to return
                           (opt, default 1000)
   replaceBoundsWithInf    replace the largest upper bounds with Inf and
                           the smallest lower bounds with -Inf. This is
                           needed in order to get solutions without loops
                           if your model has for example 1000/-1000 as 
                           arbitary large bounds. If your model only has
                           &quot;biologically relevant&quot; bounds, then set this
                           to false (opt, default true)
   supressErrors           the program will halt if it has problems
                           finding non-zero solutions which are not
                           involved in loops. This could be because the
                           constraints on the model are too relaxed (such
                           as unlimited glucose uptake) or too strict
                           (such as too many and too narrow constraints)
                           (opt, default false)

   solutions               matrix with the solutions

   The solutions are generated by maximizing (with random weights) for a
   random set of three reactions. For reversible reactions it randomly
   chooses between maximizing and minimizing.

   Usage: solutions=randomSampling(model, nSamples, replaceBoundsWithInf)

   Rasmus Agren, 2013-08-01</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="dispEM.html" class="code" title="function dispEM(string,throwErrors,toList,trimWarnings)">dispEM</a>	dispEM</li><li><a href="setParam.html" class="code" title="function model=setParam(model, paramType, rxnList, params)">setParam</a>	setParam</li><li><a href="simplifyModel.html" class="code" title="function [reducedModel, deletedReactions, deletedMetabolites]=simplifyModel(model,deleteUnconstrained, deleteDuplicates, deleteZeroInterval, deleteInaccessible, deleteMinMax, groupLinear, reservedRxns, suppressWarnings)">simplifyModel</a>	simplifyModel</li><li><a href="../solver/solveLP.html" class="code" title="function [solution hsSolOut prob]=solveLP(model,minFlux,params,hsSol)">solveLP</a>	solveLP</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function I=randsample(n,k,replacement)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function solutions=randomSampling(model, nSamples, replaceBoundsWithInf,supressErrors)</a>
0002 <span class="comment">% randomSampling</span>
0003 <span class="comment">%   Returns a number of random solutions</span>
0004 <span class="comment">%</span>
0005 <span class="comment">%   model                   a model structure</span>
0006 <span class="comment">%   nSamples                the number of solutions to return</span>
0007 <span class="comment">%                           (opt, default 1000)</span>
0008 <span class="comment">%   replaceBoundsWithInf    replace the largest upper bounds with Inf and</span>
0009 <span class="comment">%                           the smallest lower bounds with -Inf. This is</span>
0010 <span class="comment">%                           needed in order to get solutions without loops</span>
0011 <span class="comment">%                           if your model has for example 1000/-1000 as</span>
0012 <span class="comment">%                           arbitary large bounds. If your model only has</span>
0013 <span class="comment">%                           &quot;biologically relevant&quot; bounds, then set this</span>
0014 <span class="comment">%                           to false (opt, default true)</span>
0015 <span class="comment">%   supressErrors           the program will halt if it has problems</span>
0016 <span class="comment">%                           finding non-zero solutions which are not</span>
0017 <span class="comment">%                           involved in loops. This could be because the</span>
0018 <span class="comment">%                           constraints on the model are too relaxed (such</span>
0019 <span class="comment">%                           as unlimited glucose uptake) or too strict</span>
0020 <span class="comment">%                           (such as too many and too narrow constraints)</span>
0021 <span class="comment">%                           (opt, default false)</span>
0022 <span class="comment">%</span>
0023 <span class="comment">%   solutions               matrix with the solutions</span>
0024 <span class="comment">%</span>
0025 <span class="comment">%   The solutions are generated by maximizing (with random weights) for a</span>
0026 <span class="comment">%   random set of three reactions. For reversible reactions it randomly</span>
0027 <span class="comment">%   chooses between maximizing and minimizing.</span>
0028 <span class="comment">%</span>
0029 <span class="comment">%   Usage: solutions=randomSampling(model, nSamples, replaceBoundsWithInf)</span>
0030 <span class="comment">%</span>
0031 <span class="comment">%   Rasmus Agren, 2013-08-01</span>
0032 <span class="comment">%</span>
0033 
0034 <span class="keyword">if</span> nargin&lt;2
0035     nSamples=1000;
0036 <span class="keyword">end</span>
0037 <span class="keyword">if</span> nargin&lt;3
0038     replaceBoundsWithInf=true;
0039 <span class="keyword">end</span>
0040 <span class="keyword">if</span> nargin&lt;4
0041     supressErrors=false;
0042 <span class="keyword">end</span>
0043 
0044 nRxns=2; <span class="comment">%Number of reactions in the objective function in each iteration</span>
0045 
0046 <span class="comment">%First check that the model is feasible given the constraints</span>
0047 sol=<a href="../solver/solveLP.html" class="code" title="function [solution hsSolOut prob]=solveLP(model,minFlux,params,hsSol)">solveLP</a>(model);
0048 <span class="keyword">if</span> isempty(sol.x)
0049    <a href="dispEM.html" class="code" title="function dispEM(string,throwErrors,toList,trimWarnings)">dispEM</a>(<span class="string">'The model has no feasible solution'</span>); 
0050 <span class="keyword">end</span> 
0051 
0052 <span class="comment">%Simplify the model to speed stuff up a little. Keep original mapping</span>
0053 originalRxns=model.rxns;
0054 model=<a href="simplifyModel.html" class="code" title="function [reducedModel, deletedReactions, deletedMetabolites]=simplifyModel(model,deleteUnconstrained, deleteDuplicates, deleteZeroInterval, deleteInaccessible, deleteMinMax, groupLinear, reservedRxns, suppressWarnings)">simplifyModel</a>(model,false,false,true,true);
0055 <span class="comment">%Then change the bounds to +/- Inf. This is needed in order to not have</span>
0056 <span class="comment">%loops in the solutions</span>
0057 <span class="keyword">if</span> replaceBoundsWithInf==true
0058    model.ub(model.ub==max(model.ub))=Inf;
0059    model.lb(model.lb==min(model.lb))=-Inf;
0060 <span class="keyword">end</span>
0061 
0062 <span class="comment">%Reactions which can be involved in loops should not be optimized</span>
0063 <span class="comment">%for. Check which reactions reach an arbitary high upper bound</span>
0064 goodRxns=true(numel(model.rxns),1);
0065 <span class="keyword">for</span> i=1:numel(model.rxns)
0066     <span class="keyword">if</span> goodRxns(i)==true
0067         testModel=<a href="setParam.html" class="code" title="function model=setParam(model, paramType, rxnList, params)">setParam</a>(model,<span class="string">'eq'</span>,model.rxns(i),1000);
0068         sol=<a href="../solver/solveLP.html" class="code" title="function [solution hsSolOut prob]=solveLP(model,minFlux,params,hsSol)">solveLP</a>(testModel);
0069         <span class="keyword">if</span> ~isempty(sol.f)
0070             goodRxns(abs(sol.x)&gt;999)=false;
0071         <span class="keyword">else</span>
0072             <span class="comment">%If the reaction is reversible, also check in that direction</span>
0073             <span class="keyword">if</span> model.rev(i)
0074                 testModel=<a href="setParam.html" class="code" title="function model=setParam(model, paramType, rxnList, params)">setParam</a>(model,<span class="string">'eq'</span>,model.rxns(i),-1000);
0075                 sol=<a href="../solver/solveLP.html" class="code" title="function [solution hsSolOut prob]=solveLP(model,minFlux,params,hsSol)">solveLP</a>(testModel);
0076                 <span class="keyword">if</span> ~isempty(sol.f)
0077                     goodRxns(abs(sol.x)&gt;999)=false;
0078                 <span class="keyword">end</span>
0079             <span class="keyword">end</span>
0080         <span class="keyword">end</span>
0081     <span class="keyword">end</span>
0082 <span class="keyword">end</span>
0083 
0084 <span class="comment">%Reserve space for a solution matrix</span>
0085 sols=zeros(numel(model.rxns),nSamples);
0086 
0087 <span class="comment">%Main loop</span>
0088 counter=1;
0089 badSolutions=0;
0090 goodRxns=find(goodRxns);
0091 <span class="keyword">while</span> counter&lt;=nSamples
0092    rxns=<a href="#_sub1" class="code" title="subfunction I=randsample(n,k,replacement)">randsample</a>(numel(goodRxns),nRxns);
0093    model.c=zeros(numel(model.rxns),1);
0094    multipliers=<a href="#_sub1" class="code" title="subfunction I=randsample(n,k,replacement)">randsample</a>([-1 1],nRxns,true);
0095    multipliers(model.rev(goodRxns(rxns))==0)=1;
0096    model.c(goodRxns(rxns))=rand(nRxns,1).*multipliers;
0097    sol=<a href="../solver/solveLP.html" class="code" title="function [solution hsSolOut prob]=solveLP(model,minFlux,params,hsSol)">solveLP</a>(model);
0098    <span class="keyword">if</span> any(sol.x)
0099       <span class="comment">%disp('any')</span>
0100        <span class="keyword">if</span> abs(sol.f)&gt;10^-8
0101             sols(:,counter)=sol.x;
0102             counter=counter+1;
0103             badSolutions=0;
0104        <span class="keyword">else</span>
0105             badSolutions=badSolutions+1
0106             <span class="comment">%If it only finds bad solutions then throw an error.</span>
0107             <span class="keyword">if</span> badSolutions==50 &amp;&amp; supressErrors==false
0108                 <a href="dispEM.html" class="code" title="function dispEM(string,throwErrors,toList,trimWarnings)">dispEM</a>(<span class="string">'The program is having problems finding non-zero solutions that are not involved in loops. Review the constraints on your model. Set supressErrors to true to ignore this error'</span>); 
0109             <span class="keyword">end</span>
0110        <span class="keyword">end</span>
0111    <span class="keyword">end</span>
0112 <span class="keyword">end</span>
0113 
0114 <span class="comment">%Map to original model</span>
0115 [crap I]=ismember(model.rxns,originalRxns);
0116 solutions=zeros(numel(originalRxns),nSamples);
0117 solutions(I,:)=sols;
0118 solutions=sparse(solutions);
0119 <span class="keyword">end</span>
0120 
0121 <span class="comment">%To use instead of the normal Matlab randsample function. This is in order</span>
0122 <span class="comment">%to not depend on the Matlab statistical toolbox.</span>
0123 <a name="_sub1" href="#_subfunctions" class="code">function I=randsample(n,k,replacement)</a>
0124     <span class="keyword">if</span> nargin&lt;3
0125         replacement=false;
0126     <span class="keyword">end</span>
0127     <span class="comment">%n can be a integer, which leads to I being sampled from 1:n, or it can</span>
0128     <span class="comment">%be a population to sample from.</span>
0129     <span class="keyword">if</span> numel(n)==1 &amp;&amp; isnumeric(n)
0130        n=1:n;
0131     <span class="keyword">end</span>
0132     <span class="comment">%Loop and get random numbers until the list is unique. This is only a</span>
0133     <span class="comment">%good option is the number of samples is small compared to the</span>
0134     <span class="comment">%population. There are several checks that should be made here, for</span>
0135     <span class="comment">%example regarding size and that the number of samples is &lt;=population</span>
0136     <span class="comment">%size if replacement==false. This is not the case in randomSampling, so</span>
0137     <span class="comment">%such checks are ignored</span>
0138     <span class="keyword">while</span> true
0139         J=randi(numel(n),[k,1]);
0140         <span class="keyword">if</span> replacement==true || numel(J)==numel(unique(J))
0141             I=n(J);
0142             <span class="keyword">break</span>;
0143         <span class="keyword">end</span>
0144     <span class="keyword">end</span>
0145     I=I(:);
0146 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Fri 14-Oct-2016 12:02:10 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>