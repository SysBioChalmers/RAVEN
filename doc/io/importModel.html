<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of importModel</title>
  <meta name="keywords" content="importModel">
  <meta name="description" content="importModel">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">io</a> &gt; importModel.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for io&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>importModel
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>importModel</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function model=importModel(fileName,removeExcMets,isSBML2COBRA,supressWarnings) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> importModel
   Import a constraint-based model from a SBML file

   Input:
   fileName        a SBML file to import
   removeExcMets   true if exchange metabolites should be removed. This is
                   needed to be able to run simulations, but it could also
                   be done using simplifyModel at a later stage (opt,
                   default true)
   isSBML2COBRA    true if the SBML file is in the old COBRA Toolbox format
                   (SBML Level 2) (opt, default false)
   supressWarnings true if warnings regarding the model structure should
                   be supressed (opt, default false)

   Output:
   model
       id               model ID
       description      description of model contents
       annotation       additional information about model
       rxns             reaction ids
       mets             metabolite ids
       S                stoichiometric matrix
       lb               lower bounds
       ub               upper bounds
       rev              reversibility vector
       c                objective coefficients
       b                equality constraints for the metabolite equations
       comps            compartment ids
       compNames        compartment names
       compOutside      the id (as in comps) for the compartment
                        surrounding each of the compartments
       compMiriams      structure with MIRIAM information about the
                        compartments
       rxnNames         reaction description
       rxnComps         compartments for reactions
       grRules          reaction to gene rules in text form
       rxnGeneMat       reaction-to-gene mapping in sparse matrix form
       subSystems       subsystem name for each reaction
       eccodes          EC-codes for the reactions
       rxnMiriams       structure with MIRIAM information about the reactions
       rxnNotes         reaction notes
       rxnReferences    reaction references
       rxnConfidenceScores reaction confidence scores
       genes            list of all genes
       geneComps        compartments for genes
       geneMiriams      structure with MIRIAM information about the genes
       geneShortNames   gene alternative names (e.g. ERG10)
       metNames         metabolite description
       metComps         compartments for metabolites
       inchis           InChI-codes for metabolites
       metFormulas      metabolite chemical formula
       metMiriams       structure with MIRIAM information about the metabolites
       metCharges       metabolite charge
       unconstrained    true if the metabolite is an exchange metabolite

   Loads models in the COBRA Toolbox format and in the format used in
   the yeast consensus reconstruction. The resulting structure is compatible
   with COBRA Toolbox. A number of consistency checks are performed in order
   to ensure that the model is valid. Take these warnings seriously and modify the
   model structure to solve them. The RAVEN Toolbox is made to function
   only on consistent models, and the only checks performed are when the
   model is imported. You can use exportToExcelFormat, modify the model in
   Microsoft Excel and then reimport it using importExcelModel (or remake
   the SBML file using SBMLFromExcel)

   NOTE: This script requires that libSBML is installed.

   NOTE: All IDs are assumed to be named C_, M_, E_, R_ for compartments,
         metabolites, genes, and reactions. This is true for models
         generated by SBMLFromExcel and those that follow the yeast
         consensus network model formulation.

   Usage: model=importModel(fileName,removeExcMets,isSBML2COBRA,supressWarnings)</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function matchGenes=getGeneList(grRules)</a></li><li><a href="#_sub2" class="code">function fieldContent=parseNote(searchString,fieldName)</a></li><li><a href="#_sub3" class="code">function fieldContent=parseAnnotation(searchString,startString,midString,fieldName)</a></li><li><a href="#_sub4" class="code">function miriamStruct=parseMiriam(searchString)</a></li><li><a href="#_sub5" class="code">function miriam = addSBOtoMiriam(miriam,sboTerm)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function model=importModel(fileName,removeExcMets,isSBML2COBRA,supressWarnings)</a>
0002 <span class="comment">% importModel</span>
0003 <span class="comment">%   Import a constraint-based model from a SBML file</span>
0004 <span class="comment">%</span>
0005 <span class="comment">%   Input:</span>
0006 <span class="comment">%   fileName        a SBML file to import</span>
0007 <span class="comment">%   removeExcMets   true if exchange metabolites should be removed. This is</span>
0008 <span class="comment">%                   needed to be able to run simulations, but it could also</span>
0009 <span class="comment">%                   be done using simplifyModel at a later stage (opt,</span>
0010 <span class="comment">%                   default true)</span>
0011 <span class="comment">%   isSBML2COBRA    true if the SBML file is in the old COBRA Toolbox format</span>
0012 <span class="comment">%                   (SBML Level 2) (opt, default false)</span>
0013 <span class="comment">%   supressWarnings true if warnings regarding the model structure should</span>
0014 <span class="comment">%                   be supressed (opt, default false)</span>
0015 <span class="comment">%</span>
0016 <span class="comment">%   Output:</span>
0017 <span class="comment">%   model</span>
0018 <span class="comment">%       id               model ID</span>
0019 <span class="comment">%       description      description of model contents</span>
0020 <span class="comment">%       annotation       additional information about model</span>
0021 <span class="comment">%       rxns             reaction ids</span>
0022 <span class="comment">%       mets             metabolite ids</span>
0023 <span class="comment">%       S                stoichiometric matrix</span>
0024 <span class="comment">%       lb               lower bounds</span>
0025 <span class="comment">%       ub               upper bounds</span>
0026 <span class="comment">%       rev              reversibility vector</span>
0027 <span class="comment">%       c                objective coefficients</span>
0028 <span class="comment">%       b                equality constraints for the metabolite equations</span>
0029 <span class="comment">%       comps            compartment ids</span>
0030 <span class="comment">%       compNames        compartment names</span>
0031 <span class="comment">%       compOutside      the id (as in comps) for the compartment</span>
0032 <span class="comment">%                        surrounding each of the compartments</span>
0033 <span class="comment">%       compMiriams      structure with MIRIAM information about the</span>
0034 <span class="comment">%                        compartments</span>
0035 <span class="comment">%       rxnNames         reaction description</span>
0036 <span class="comment">%       rxnComps         compartments for reactions</span>
0037 <span class="comment">%       grRules          reaction to gene rules in text form</span>
0038 <span class="comment">%       rxnGeneMat       reaction-to-gene mapping in sparse matrix form</span>
0039 <span class="comment">%       subSystems       subsystem name for each reaction</span>
0040 <span class="comment">%       eccodes          EC-codes for the reactions</span>
0041 <span class="comment">%       rxnMiriams       structure with MIRIAM information about the reactions</span>
0042 <span class="comment">%       rxnNotes         reaction notes</span>
0043 <span class="comment">%       rxnReferences    reaction references</span>
0044 <span class="comment">%       rxnConfidenceScores reaction confidence scores</span>
0045 <span class="comment">%       genes            list of all genes</span>
0046 <span class="comment">%       geneComps        compartments for genes</span>
0047 <span class="comment">%       geneMiriams      structure with MIRIAM information about the genes</span>
0048 <span class="comment">%       geneShortNames   gene alternative names (e.g. ERG10)</span>
0049 <span class="comment">%       metNames         metabolite description</span>
0050 <span class="comment">%       metComps         compartments for metabolites</span>
0051 <span class="comment">%       inchis           InChI-codes for metabolites</span>
0052 <span class="comment">%       metFormulas      metabolite chemical formula</span>
0053 <span class="comment">%       metMiriams       structure with MIRIAM information about the metabolites</span>
0054 <span class="comment">%       metCharges       metabolite charge</span>
0055 <span class="comment">%       unconstrained    true if the metabolite is an exchange metabolite</span>
0056 <span class="comment">%</span>
0057 <span class="comment">%   Loads models in the COBRA Toolbox format and in the format used in</span>
0058 <span class="comment">%   the yeast consensus reconstruction. The resulting structure is compatible</span>
0059 <span class="comment">%   with COBRA Toolbox. A number of consistency checks are performed in order</span>
0060 <span class="comment">%   to ensure that the model is valid. Take these warnings seriously and modify the</span>
0061 <span class="comment">%   model structure to solve them. The RAVEN Toolbox is made to function</span>
0062 <span class="comment">%   only on consistent models, and the only checks performed are when the</span>
0063 <span class="comment">%   model is imported. You can use exportToExcelFormat, modify the model in</span>
0064 <span class="comment">%   Microsoft Excel and then reimport it using importExcelModel (or remake</span>
0065 <span class="comment">%   the SBML file using SBMLFromExcel)</span>
0066 <span class="comment">%</span>
0067 <span class="comment">%   NOTE: This script requires that libSBML is installed.</span>
0068 <span class="comment">%</span>
0069 <span class="comment">%   NOTE: All IDs are assumed to be named C_, M_, E_, R_ for compartments,</span>
0070 <span class="comment">%         metabolites, genes, and reactions. This is true for models</span>
0071 <span class="comment">%         generated by SBMLFromExcel and those that follow the yeast</span>
0072 <span class="comment">%         consensus network model formulation.</span>
0073 <span class="comment">%</span>
0074 <span class="comment">%   Usage: model=importModel(fileName,removeExcMets,isSBML2COBRA,supressWarnings)</span>
0075 
0076 <span class="keyword">if</span> nargin&lt;2
0077     removeExcMets=true;
0078 <span class="keyword">end</span>
0079 
0080 <span class="keyword">if</span> nargin&lt;3
0081     isSBML2COBRA=false;
0082 <span class="keyword">end</span>
0083 
0084 <span class="keyword">if</span> nargin&lt;4
0085     supressWarnings=false;
0086 <span class="keyword">end</span>
0087 
0088 <span class="keyword">if</span> ~(exist(fileName,<span class="string">'file'</span>)==2)
0089     error(<span class="string">'SBML file %s cannot be found'</span>,string(fileName));
0090 <span class="keyword">end</span>
0091 
0092 <span class="comment">%This is to match the order of the fields to those you get from importing</span>
0093 <span class="comment">%from Excel</span>
0094 model=[];
0095 model.id=[];
0096 model.description=[];
0097 model.annotation=[];
0098 model.rxns={};
0099 model.mets={};
0100 model.S=[];
0101 model.lb=[];
0102 model.ub=[];
0103 model.rev=[];
0104 model.c=[];
0105 model.b=[];
0106 model.comps={};
0107 model.compNames={};
0108 model.compOutside={};
0109 model.compMiriams={};
0110 model.rxnNames={};
0111 model.rxnComps=[];
0112 model.grRules={};
0113 model.rxnGeneMat=[];
0114 model.subSystems={};
0115 model.eccodes={};
0116 model.rxnMiriams={};
0117 model.rxnNotes={};
0118 model.rxnReferences={};
0119 model.rxnConfidenceScores=[];
0120 model.genes={};
0121 model.geneComps=[];
0122 model.geneMiriams={};
0123 model.geneShortNames={};
0124 model.metNames={};
0125 model.metComps=[];
0126 model.inchis={};
0127 model.metFormulas={};
0128 model.metMiriams={};
0129 model.metCharges=[];
0130 model.unconstrained=[];
0131 
0132 <span class="comment">%Load the model using libSBML</span>
0133 modelSBML = TranslateSBML(fileName,0,0,[1 1]);
0134 
0135 <span class="keyword">if</span> isempty(modelSBML)
0136     EM=<span class="string">'There is a problem with the SBML file. Try using the SBML Validator at http://sbml.org/Facilities/Validator'</span>;
0137     dispEM(EM);
0138 <span class="keyword">end</span>
0139 
0140 <span class="comment">%Remove the preceding strings for reactions, compartments and</span>
0141 <span class="comment">%reactants/products in 'reaction' field. The strings for metabolites, genes</span>
0142 <span class="comment">%and complexes are not removed, as we will need them later to identify them</span>
0143 <span class="comment">%from 'species' field</span>
0144 <span class="keyword">for</span> i=1:numel(modelSBML.reaction)
0145     modelSBML.reaction(i).name=regexprep(modelSBML.reaction(i).name,<span class="string">'^R_'</span>,<span class="string">''</span>);
0146     modelSBML.reaction(i).id=regexprep(modelSBML.reaction(i).id,<span class="string">'^R_'</span>,<span class="string">''</span>);
0147     <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'compartment'</span>)
0148         modelSBML.reaction(i).compartment=regexprep(modelSBML.reaction(i).compartment,<span class="string">'^C_'</span>,<span class="string">''</span>);
0149     <span class="keyword">end</span>
0150     <span class="keyword">for</span> j=1:numel(modelSBML.reaction(i).reactant)
0151         modelSBML.reaction(i).reactant(j).species=regexprep(modelSBML.reaction(i).reactant(j).species,<span class="string">'^M_'</span>,<span class="string">''</span>);
0152     <span class="keyword">end</span>
0153     <span class="keyword">for</span> j=1:numel(modelSBML.reaction(i).product)
0154         modelSBML.reaction(i).product(j).species=regexprep(modelSBML.reaction(i).product(j).species,<span class="string">'^M_'</span>,<span class="string">''</span>);
0155     <span class="keyword">end</span>
0156 <span class="keyword">end</span>
0157 
0158 <span class="comment">%Retrieve compartment names and IDs</span>
0159 compartmentNames=cell(numel(modelSBML.compartment),1);
0160 compartmentIDs=cell(numel(modelSBML.compartment),1);
0161 compartmentOutside=cell(numel(modelSBML.compartment),1);
0162 compartmentMiriams=cell(numel(modelSBML.compartment),1);
0163 
0164 <span class="keyword">if</span> isfield(modelSBML.compartment,<span class="string">'sboTerm'</span>) &amp;&amp; numel(unique([modelSBML.compartment.sboTerm])) == 1
0165     <span class="comment">%If all the SBO terms are identical, don't add them to compMiriams</span>
0166     modelSBML.compartment = rmfield(modelSBML.compartment,<span class="string">'sboTerm'</span>);
0167 <span class="keyword">end</span>
0168     
0169 <span class="keyword">for</span> i=1:numel(modelSBML.compartment)
0170     compartmentNames{i}=modelSBML.compartment(i).name;
0171     compartmentIDs{i}=regexprep(modelSBML.compartment(i).id,<span class="string">'^C_'</span>,<span class="string">''</span>);
0172     <span class="keyword">if</span> isfield(modelSBML.compartment(i),<span class="string">'outside'</span>)
0173         <span class="keyword">if</span> ~isempty(modelSBML.compartment(i).outside)
0174             compartmentOutside{i}=regexprep(modelSBML.compartment(i).outside,<span class="string">'^C_'</span>,<span class="string">''</span>);
0175         <span class="keyword">else</span>
0176             compartmentOutside{i}=<span class="string">''</span>;
0177         <span class="keyword">end</span>
0178     <span class="keyword">else</span>
0179         compartmentOutside{i}=[];
0180     <span class="keyword">end</span>
0181     
0182     <span class="keyword">if</span> isfield(modelSBML.compartment(i),<span class="string">'annotation'</span>)
0183         compartmentMiriams{i}=<a href="#_sub4" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.compartment(i).annotation);
0184     <span class="keyword">else</span>
0185         compartmentMiriams{i}=[];
0186     <span class="keyword">end</span>
0187     
0188     <span class="keyword">if</span> isfield(modelSBML.compartment(i),<span class="string">'sboTerm'</span>)
0189         compartmentMiriams{i} = <a href="#_sub5" class="code" title="subfunction miriam = addSBOtoMiriam(miriam,sboTerm)">addSBOtoMiriam</a>(compartmentMiriams{i},modelSBML.compartment(i).sboTerm);
0190     <span class="keyword">end</span>
0191 <span class="keyword">end</span>
0192 
0193 <span class="comment">%If there are no compartment names then use compartment id as name</span>
0194 <span class="keyword">if</span> all(cellfun(@isempty,compartmentNames))
0195     compartmentNames=compartmentIDs;
0196 <span class="keyword">end</span>
0197 
0198 <span class="comment">%Retrieve info on metabolites, genes, complexes</span>
0199 metaboliteNames={};
0200 metaboliteIDs={};
0201 metaboliteCompartments={};
0202 metaboliteUnconstrained=[];
0203 metaboliteFormula={};
0204 metaboliteInChI={};
0205 metaboliteMiriams={};
0206 metaboliteCharges=[];
0207 
0208 geneNames={};
0209 geneIDs={};
0210 geneMiriams={};
0211 geneShortNames={};
0212 geneCompartments={};
0213 complexIDs={};
0214 complexNames={};
0215 
0216 <span class="comment">%If the file is not a COBRA Toolbox model. According to the format</span>
0217 <span class="comment">%specified in the yeast consensus model both metabolites and genes are a</span>
0218 <span class="comment">%type of 'species'. The metabolites have names starting with 'M_' and genes</span>
0219 <span class="comment">%with 'E_'</span>
0220 geneSBOs = [];
0221 metSBOs = [];
0222 <span class="keyword">for</span> i=1:numel(modelSBML.species)
0223     <span class="keyword">if</span> ~isSBML2COBRA
0224         <span class="keyword">if</span> length(modelSBML.species(i).id)&gt;=2 &amp;&amp; strcmpi(modelSBML.species(i).id(1:2),<span class="string">'E_'</span>)
0225             geneNames{numel(geneNames)+1,1}=modelSBML.species(i).name;
0226             
0227             <span class="comment">%The &quot;E_&quot; is included in the ID. This is because it's only used</span>
0228             <span class="comment">%internally in this file and it makes the matching a little</span>
0229             <span class="comment">%smoother</span>
0230             geneIDs{numel(geneIDs)+1,1}=modelSBML.species(i).id;
0231             geneCompartments{numel(geneCompartments)+1,1}=regexprep(modelSBML.species(i).compartment,<span class="string">'^C_'</span>,<span class="string">''</span>);
0232             
0233             <span class="comment">%Get Miriam structure</span>
0234             <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'annotation'</span>)
0235                 <span class="comment">%Get Miriam info</span>
0236                 geneMiriam=<a href="#_sub4" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.species(i).annotation);
0237                 geneMiriams{numel(geneMiriams)+1,1}=geneMiriam;
0238             <span class="keyword">else</span>
0239                 geneMiriams{numel(geneMiriams)+1,1}=[];
0240             <span class="keyword">end</span>
0241             
0242             <span class="comment">%Protein short names (for example ERG10) are saved as SHORT</span>
0243             <span class="comment">%NAME: NAME in the notes-section of metabolites for SBML Level</span>
0244             <span class="comment">%2 and as PROTEIN_ASSOCIATION for each reaction in SBML Level 2</span>
0245             <span class="comment">%COBRA Toolbox format. For now only the SHORT NAME is loaded</span>
0246             <span class="comment">%and no mapping takes place</span>
0247             <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'notes'</span>)
0248                 geneShortNames{numel(geneShortNames)+1,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'SHORT NAME'</span>);
0249             <span class="keyword">else</span>
0250                 geneShortNames{numel(geneShortNames)+1,1}=<span class="string">''</span>;
0251             <span class="keyword">end</span>
0252             
0253             <span class="comment">%Get SBO term</span>
0254             <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'sboTerm'</span>)
0255                 geneSBOs(end+1,1) = modelSBML.species(i).sboTerm;
0256             <span class="keyword">end</span>
0257         <span class="keyword">elseif</span> length(modelSBML.species(i).id)&gt;=2 &amp;&amp; strcmpi(modelSBML.species(i).id(1:3),<span class="string">'Cx_'</span>)
0258             <span class="comment">%If it's a complex keep the ID and name</span>
0259             complexIDs=[complexIDs;modelSBML.species(i).id];
0260             complexNames=[complexNames;modelSBML.species(i).name];
0261         <span class="keyword">else</span>
0262             <span class="comment">%If it is not gene or complex, then it must be a metabolite</span>
0263             metaboliteNames{numel(metaboliteNames)+1,1}=modelSBML.species(i).name;
0264             metaboliteIDs{numel(metaboliteIDs)+1,1}=regexprep(modelSBML.species(i).id,<span class="string">'^M_'</span>,<span class="string">''</span>);
0265             metaboliteCompartments{numel(metaboliteCompartments)+1,1}=regexprep(modelSBML.species(i).compartment,<span class="string">'^C_'</span>,<span class="string">''</span>);
0266             metaboliteUnconstrained(numel(metaboliteUnconstrained)+1,1)=modelSBML.species(i).boundaryCondition;
0267             
0268             <span class="comment">%For each metabolite retrieve the formula and the InChI code if</span>
0269             <span class="comment">%available First add the InChI code and the formula from the</span>
0270             <span class="comment">%InChI. This allows for overwriting the formula by setting the</span>
0271             <span class="comment">%actual formula field</span>
0272             <span class="keyword">if</span> ~isempty(modelSBML.species(i).annotation)
0273                 <span class="comment">%Get the formula if available</span>
0274                 startString=<span class="string">'&gt;InChI='</span>;
0275                 endString=<span class="string">'&lt;/in:inchi&gt;'</span>;
0276                 formStart=strfind(modelSBML.species(i).annotation,startString);
0277                 <span class="keyword">if</span> isempty(formStart)
0278                     startString=<span class="string">'InChI='</span>;
0279                     endString=<span class="string">'&quot;/&gt;'</span>;
0280                 <span class="keyword">end</span>
0281                 formStart=strfind(modelSBML.species(i).annotation,startString);
0282                 <span class="keyword">if</span> ~isempty(formStart)
0283                     formEnd=strfind(modelSBML.species(i).annotation,endString);
0284                     formEndIndex=find(formEnd&gt;formStart, 1 );
0285                     formula=modelSBML.species(i).annotation(formStart+numel(startString):formEnd(formEndIndex)-1);
0286                     metaboliteInChI{numel(metaboliteInChI)+1,1}=formula;
0287                     
0288                     <span class="comment">%The composition is most often present between the</span>
0289                     <span class="comment">%first and second &quot;/&quot; in the model. In some simple</span>
0290                     <span class="comment">%molecules, such as salts, there is no second &quot;/&quot;. The</span>
0291                     <span class="comment">%formula is then assumed to be to the end of the string</span>
0292                     compositionIndexes=strfind(formula,<span class="string">'/'</span>);
0293                     <span class="keyword">if</span> numel(compositionIndexes)&gt;1
0294                         metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="keyword">...</span>
0295                             formula(compositionIndexes(1)+1:compositionIndexes(2)-1);
0296                     <span class="keyword">else</span>
0297                         <span class="keyword">if</span> numel(compositionIndexes)==1
0298                             <span class="comment">%Probably a simple molecule which can have only</span>
0299                             <span class="comment">%one conformation</span>
0300                             metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="keyword">...</span>
0301                                 formula(compositionIndexes(1)+1:numel(formula));
0302                         <span class="keyword">else</span>
0303                             metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0304                         <span class="keyword">end</span>
0305                     <span class="keyword">end</span>
0306                 <span class="keyword">elseif</span> isfield(modelSBML.species(i),<span class="string">'fbc_chemicalFormula'</span>)
0307                     metaboliteInChI{numel(metaboliteInChI)+1,1}=<span class="string">''</span>;
0308                     <span class="keyword">if</span> ~isempty(modelSBML.species(i).fbc_chemicalFormula)
0309                         <span class="comment">%Cannot extract InChi from formula, so remains</span>
0310                         <span class="comment">%empty</span>
0311                         metaboliteFormula{numel(metaboliteFormula)+1,1}=modelSBML.species(i).fbc_chemicalFormula;
0312                     <span class="keyword">else</span>
0313                         metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0314                     <span class="keyword">end</span>
0315                 <span class="keyword">else</span>
0316                     metaboliteInChI{numel(metaboliteInChI)+1,1}=<span class="string">''</span>;
0317                     metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0318                 <span class="keyword">end</span>
0319                 
0320                 <span class="comment">%Get Miriam info</span>
0321                 metMiriam=<a href="#_sub4" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.species(i).annotation);
0322                 metaboliteMiriams{numel(metaboliteMiriams)+1,1}=metMiriam;
0323             <span class="keyword">else</span>
0324                 metaboliteInChI{numel(metaboliteInChI)+1,1}=<span class="string">''</span>;
0325                 <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'notes'</span>)
0326                     metaboliteFormula{numel(metaboliteFormula)+1,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'FORMULA'</span>);
0327                 <span class="keyword">else</span>
0328                     metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0329                 <span class="keyword">end</span>
0330                 metaboliteMiriams{numel(metaboliteMiriams)+1,1}=[];
0331             <span class="keyword">end</span>
0332             <span class="keyword">if</span> ~isempty(modelSBML.species(i).notes)
0333                 <span class="keyword">if</span> ~isfield(modelSBML.species(i),<span class="string">'annotation'</span>)
0334                     metaboliteFormula{numel(metaboliteFormula)+1,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'FORMULA'</span>);
0335                 <span class="keyword">end</span>
0336             <span class="keyword">elseif</span> ~isfield(modelSBML.species(i),<span class="string">'annotation'</span>)
0337                 metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0338             <span class="keyword">end</span>
0339             <span class="comment">%Get SBO term</span>
0340             <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'sboTerm'</span>)
0341                 metSBOs(end+1,1) = modelSBML.species(i).sboTerm;
0342             <span class="keyword">end</span>
0343         <span class="keyword">end</span>
0344         
0345     <span class="keyword">elseif</span> isSBML2COBRA
0346         <span class="comment">%The metabolite names are assumed to be M_NAME_COMPOSITION or</span>
0347         <span class="comment">%_NAME_COMPOSITION or NAME_COMPOSITION or NAME. Regular expressions</span>
0348         <span class="comment">%are used that only NAME_COMPOSITION or NAME would be possible</span>
0349         
0350         modelSBML.species(i).name=regexprep(modelSBML.species(i).name,<span class="string">'^M_'</span>,<span class="string">''</span>);
0351         modelSBML.species(i).name=regexprep(modelSBML.species(i).name,<span class="string">'^_'</span>,<span class="string">''</span>);
0352         underscoreIndex=strfind(modelSBML.species(i).name,<span class="string">'_'</span>);
0353         
0354         metaboliteNames{numel(metaboliteNames)+1,1}=modelSBML.species(i).name;
0355         
0356         metaboliteIDs{numel(metaboliteIDs)+1,1}=regexprep(modelSBML.species(i).id,<span class="string">'^M_'</span>,<span class="string">''</span>);
0357         metaboliteCompartments{numel(metaboliteCompartments)+1,1}=regexprep(modelSBML.species(i).compartment,<span class="string">'^C_'</span>,<span class="string">''</span>);
0358         
0359         <span class="comment">%I think that COBRA doesn't set the boundary condition, but rather</span>
0360         <span class="comment">%uses name_b. Check for either</span>
0361         metaboliteUnconstrained(numel(metaboliteUnconstrained)+1,1)=modelSBML.species(i).boundaryCondition;
0362         <span class="keyword">if</span> strcmp(metaboliteIDs{end}(max(end-1,1):end),<span class="string">'_b'</span>)
0363             metaboliteUnconstrained(end)=1;
0364         <span class="keyword">end</span>
0365         
0366         <span class="comment">%Get the formula</span>
0367         <span class="keyword">if</span> max(underscoreIndex)&lt;length(modelSBML.species(i).name)
0368             metaboliteFormula{numel(metaboliteFormula)+1,1}=modelSBML.species(i).name(max(underscoreIndex)+1:length(modelSBML.species(i).name));
0369         <span class="keyword">else</span>
0370             metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0371         <span class="keyword">end</span>
0372         
0373         <span class="comment">%The old COBRA version sometimes has composition information in the</span>
0374         <span class="comment">%notes instead</span>
0375         <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'notes'</span>) &amp;&amp; ~isempty(<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'FORMULA'</span>))
0376             metaboliteFormula{numel(metaboliteFormula)+1,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'FORMULA'</span>);
0377         <span class="keyword">end</span>
0378         
0379         <span class="comment">%Get Miriam info</span>
0380         <span class="keyword">if</span> ~isempty(modelSBML.species(i).annotation)
0381             metMiriam=<a href="#_sub4" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.species(i).annotation);    
0382         <span class="keyword">else</span>
0383             metMiriam=[];
0384         <span class="keyword">end</span>
0385         metaboliteMiriams{numel(metaboliteMiriams)+1,1}=metMiriam;
0386         
0387         <span class="comment">%Get SBO term</span>
0388         <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'sboTerm'</span>)
0389             metSBOs(end+1,1) = modelSBML.species(i).sboTerm;
0390         <span class="keyword">end</span>
0391     <span class="keyword">end</span>
0392     <span class="comment">%The following lines are executed regardless isSBML2COBRA setting</span>
0393     <span class="keyword">if</span> isempty(modelSBML.species(i).id) || ~strcmpi(modelSBML.species(i).id(1:2),<span class="string">'E_'</span>)
0394         <span class="keyword">if</span> isempty(modelSBML.species(i).id) || ~strcmpi(modelSBML.species(i).id(1:3),<span class="string">'Cx_'</span>)
0395             <span class="comment">%Metabolite names could be of format NAME [compartment]. First</span>
0396             <span class="comment">%check whether metabolite name ends with square brackets, and</span>
0397             <span class="comment">%then check if the text within these brackets is a compartment</span>
0398             <span class="comment">%name. If so, then remove this section from the metabolite</span>
0399             <span class="comment">%name</span>
0400             comp.match=regexp(modelSBML.species(i).name,<span class="string">'.* \[(.*)\]$'</span>,<span class="string">'match'</span>);
0401             <span class="keyword">if</span> ~isempty(comp.match)
0402                 comp.split=strsplit(comp.match{1},{<span class="string">'['</span>,<span class="string">']'</span>});
0403                 comp.true=any(strcmpi({modelSBML.compartment.name},comp.split{2}));
0404                 <span class="keyword">if</span> comp.true==1
0405                     metaboliteNames{numel(metaboliteNames),1}=strtrim(comp.split{1});
0406                 <span class="keyword">else</span>
0407                     metaboliteNames{numel(metaboliteNames),1}=regexprep(modelSBML.species(i).name,<span class="string">'^M_'</span>,<span class="string">''</span>);
0408                 <span class="keyword">end</span>
0409             <span class="keyword">else</span>
0410                 <span class="comment">%Use the full name</span>
0411                 metaboliteNames{i,1}=modelSBML.species(i).name;
0412             <span class="keyword">end</span>
0413             <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'fbc_charge'</span>)
0414                 <span class="keyword">if</span> ~isempty(modelSBML.species(i).fbc_charge) &amp;&amp; modelSBML.species(i).isSetfbc_charge
0415                     metaboliteCharges(numel(metaboliteCharges)+1,1)=double(modelSBML.species(i).fbc_charge);
0416                 <span class="keyword">else</span>
0417                     <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'notes'</span>)
0418                         <span class="keyword">if</span> strfind(modelSBML.species(i).notes,<span class="string">'CHARGE'</span>)
0419                             metaboliteCharges(numel(metaboliteCharges)+1,1)=str2double(<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'CHARGE'</span>));
0420                         <span class="keyword">else</span>
0421                             metaboliteCharges(numel(metaboliteCharges)+1,1)=NaN;
0422                         <span class="keyword">end</span>
0423                     <span class="keyword">else</span>
0424                         metaboliteCharges(numel(metaboliteCharges)+1,1)=NaN;
0425                     <span class="keyword">end</span>
0426                 <span class="keyword">end</span>
0427             <span class="keyword">elseif</span> isfield(modelSBML.species(i),<span class="string">'notes'</span>)
0428                 <span class="keyword">if</span> strfind(modelSBML.species(i).notes,<span class="string">'CHARGE'</span>)
0429                     metaboliteCharges(numel(metaboliteCharges)+1,1)=str2double(<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'CHARGE'</span>));
0430                 <span class="keyword">else</span>
0431                     metaboliteCharges(numel(metaboliteCharges)+1,1)=NaN;
0432                 <span class="keyword">end</span>
0433             <span class="keyword">else</span>
0434                 metaboliteCharges(numel(metaboliteCharges)+1,1)=NaN;
0435             <span class="keyword">end</span>
0436             <span class="comment">%Additional information from FBC format Chemical formula</span>
0437             <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'fbc_chemicalFormula'</span>)
0438                 <span class="keyword">if</span> ~isempty(modelSBML.species(i).fbc_chemicalFormula)
0439                     metaboliteFormula{numel(metaboliteFormula),1}=modelSBML.species(i).fbc_chemicalFormula;
0440                 <span class="keyword">end</span>
0441             <span class="keyword">end</span>
0442         <span class="keyword">end</span>
0443     <span class="keyword">end</span>
0444 <span class="keyword">end</span>
0445 
0446 <span class="comment">%Add SBO terms to gene and metabolite miriam fields</span>
0447 <span class="keyword">if</span> numel(unique(geneSBOs)) &gt; 1  <span class="comment">% don't add if they're all identical</span>
0448     <span class="keyword">for</span> i = 1:numel(geneNames)
0449         geneMiriams{i} = <a href="#_sub5" class="code" title="subfunction miriam = addSBOtoMiriam(miriam,sboTerm)">addSBOtoMiriam</a>(geneMiriams{i},geneSBOs(i));
0450     <span class="keyword">end</span>
0451 <span class="keyword">end</span>
0452 <span class="keyword">if</span> numel(unique(metSBOs)) &gt; 1
0453     <span class="keyword">for</span> i = 1:numel(metaboliteNames)
0454         metaboliteMiriams{i} = <a href="#_sub5" class="code" title="subfunction miriam = addSBOtoMiriam(miriam,sboTerm)">addSBOtoMiriam</a>(metaboliteMiriams{i},metSBOs(i));
0455     <span class="keyword">end</span>
0456 <span class="keyword">end</span>
0457 
0458 <span class="comment">%Retrieve info on reactions</span>
0459 reactionNames=cell(numel(modelSBML.reaction),1);
0460 reactionIDs=cell(numel(modelSBML.reaction),1);
0461 subsystems=cell(numel(modelSBML.reaction),1);
0462 eccodes=cell(numel(modelSBML.reaction),1);
0463 eccodes(:,:)=cellstr(<span class="string">''</span>);
0464 rxnconfidencescores=NaN(numel(modelSBML.reaction),1);
0465 rxnreferences=cell(numel(modelSBML.reaction),1);
0466 rxnreferences(:,:)=cellstr(<span class="string">''</span>);
0467 rxnnotes=cell(numel(modelSBML.reaction),1);
0468 rxnnotes(:,:)=cellstr(<span class="string">''</span>);
0469 grRules=cell(numel(modelSBML.reaction),1);
0470 grRules(:,:)=cellstr(<span class="string">''</span>);
0471 grRulesFromModifier=grRules;
0472 rxnComps=zeros(numel(modelSBML.reaction),1);
0473 rxnMiriams=cell(numel(modelSBML.reaction),1);
0474 reactionReversibility=zeros(numel(modelSBML.reaction),1);
0475 reactionUB=zeros(numel(modelSBML.reaction),1);
0476 reactionLB=zeros(numel(modelSBML.reaction),1);
0477 reactionObjective=zeros(numel(modelSBML.reaction),1);
0478 
0479 <span class="comment">%Construct the stoichiometric matrix while the reaction info is read</span>
0480 S=zeros(numel(metaboliteIDs),numel(modelSBML.reaction));
0481 
0482 counter=0;
0483 <span class="comment">%If FBC, then bounds have parameter ids defined for the whole model</span>
0484 <span class="keyword">if</span> isfield(modelSBML,<span class="string">'parameter'</span>)
0485     parameter.name=cell(numel(modelSBML.parameter),1);
0486     parameter.name={modelSBML.parameter(:).id}';
0487     parameter.value={modelSBML.parameter(:).value}';
0488 <span class="keyword">end</span>
0489 
0490 <span class="keyword">if</span> isfield(modelSBML.reaction,<span class="string">'sboTerm'</span>) &amp;&amp; numel(unique([modelSBML.reaction.sboTerm])) == 1
0491     <span class="comment">%If all the SBO terms are identical, don't add them to rxnMiriams</span>
0492     modelSBML.reaction = rmfield(modelSBML.reaction,<span class="string">'sboTerm'</span>);
0493 <span class="keyword">end</span>
0494 
0495 <span class="keyword">for</span> i=1:numel(modelSBML.reaction)
0496     
0497     <span class="comment">%Check that the reaction doesn't produce a complex and nothing else. If</span>
0498     <span class="comment">%so, then jump to the next reaction. This is because I get the genes</span>
0499     <span class="comment">%for complexes from the names and not from the reactions that create</span>
0500     <span class="comment">%them. This only applies to the non-COBRA format</span>
0501     <span class="keyword">if</span> numel(modelSBML.reaction(i).product)==1
0502         <span class="keyword">if</span> length(modelSBML.reaction(i).product(1).species)&gt;=3
0503             <span class="keyword">if</span> strcmp(modelSBML.reaction(i).product(1).species(1:3),<span class="string">'Cx_'</span>)==true
0504                 <span class="keyword">continue</span>;
0505             <span class="keyword">end</span>
0506         <span class="keyword">end</span>
0507     <span class="keyword">end</span>
0508     
0509     <span class="comment">%It didn't look like a gene complex-forming reaction</span>
0510     counter=counter+1;
0511     
0512     reactionNames{counter}=modelSBML.reaction(i).name;
0513     
0514     reactionIDs{counter}=modelSBML.reaction(i).id;
0515     reactionReversibility(counter)=modelSBML.reaction(i).reversible;
0516     
0517     <span class="comment">%If model is FBC, first get parameter of bound and then replace it with</span>
0518     <span class="comment">%the correct value. Probably faster with replace(), but this was only</span>
0519     <span class="comment">%introduced in Matlab R2016b</span>
0520     <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'fbc_lowerFluxBound'</span>)
0521         lb=modelSBML.reaction(i).fbc_lowerFluxBound;
0522         ub=modelSBML.reaction(i).fbc_upperFluxBound;
0523         <span class="keyword">for</span> n=1:numel(parameter.value)
0524             lb=regexprep(lb,parameter.name(n),num2str(parameter.value{n}));
0525             ub=regexprep(ub,parameter.name(n),num2str(parameter.value{n}));
0526         <span class="keyword">end</span>
0527         reactionLB(counter)=str2num(lb);
0528         reactionUB(counter)=str2num(ub);
0529         <span class="comment">%The order of these parameters should not be hard coded</span>
0530     <span class="keyword">elseif</span> isfield(modelSBML.reaction(i).kineticLaw,<span class="string">'parameter'</span>)
0531         reactionLB(counter)=modelSBML.reaction(i).kineticLaw.parameter(1).value;
0532         reactionUB(counter)=modelSBML.reaction(i).kineticLaw.parameter(2).value;
0533         reactionObjective(counter)=modelSBML.reaction(i).kineticLaw.parameter(3).value;
0534     <span class="keyword">else</span>
0535         <span class="keyword">if</span> reactionReversibility(counter)==true
0536             reactionLB(counter)=-inf;
0537         <span class="keyword">else</span>
0538             reactionLB(counter)=0;
0539         <span class="keyword">end</span>
0540         reactionUB(counter)=inf;
0541         reactionObjective(counter)=0;
0542     <span class="keyword">end</span>
0543     
0544     <span class="comment">%Find the associated gene if available</span>
0545     <span class="comment">%If FBC, get gene association data from corresponding fields</span>
0546     <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'fbc_geneProductAssociation'</span>)
0547         <span class="keyword">if</span> ~isempty(modelSBML.reaction(i).fbc_geneProductAssociation) &amp;&amp; ~isempty(modelSBML.reaction(i).fbc_geneProductAssociation.fbc_association)
0548             grRules{counter}=modelSBML.reaction(i).fbc_geneProductAssociation.fbc_association.fbc_association;
0549         <span class="keyword">end</span>
0550     <span class="keyword">elseif</span> isfield(modelSBML.reaction(i),<span class="string">'notes'</span>)
0551         <span class="comment">%This section was previously executed only if isSBML2COBRA is true. Now</span>
0552         <span class="comment">%it will be executed, if 'GENE_ASSOCIATION' is found in</span>
0553         <span class="comment">%modelSBML.reaction(i).notes</span>
0554         <span class="keyword">if</span> strfind(modelSBML.reaction(i).notes,<span class="string">'GENE_ASSOCIATION'</span>)
0555             geneAssociation=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'GENE_ASSOCIATION'</span>);
0556         <span class="keyword">elseif</span> strfind(modelSBML.reaction(i).notes,<span class="string">'GENE ASSOCIATION'</span>)
0557             geneAssociation=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'GENE ASSOCIATION'</span>);
0558         <span class="keyword">else</span>
0559             geneAssociation=<span class="string">''</span>;
0560         <span class="keyword">end</span>
0561         <span class="keyword">if</span> ~isempty(geneAssociation)
0562             <span class="comment">%This adds the grRules. The gene list and rxnGeneMat are created</span>
0563             <span class="comment">%later</span>
0564             grRules{counter}=geneAssociation;
0565         <span class="keyword">end</span>
0566     <span class="keyword">end</span>
0567     <span class="keyword">if</span> isempty(grRules{counter}) &amp;&amp; ~isempty(modelSBML.reaction(i).modifier)
0568         rules=<span class="string">''</span>;
0569         <span class="keyword">for</span> j=1:numel(modelSBML.reaction(i).modifier)
0570             modifier=modelSBML.reaction(i).modifier(j).species;
0571             <span class="keyword">if</span> ~isempty(modifier)
0572                 <span class="keyword">if</span> strcmpi(modifier(1:2),<span class="string">'E_'</span>)
0573                     index=find(strcmp(modifier,geneIDs));
0574                     <span class="comment">%This should be unique and in the geneIDs list,</span>
0575                     <span class="comment">%otherwise something is wrong</span>
0576                     <span class="keyword">if</span> numel(index)~=1
0577                         EM=[<span class="string">'Could not get the gene association data from reaction '</span> reactionIDs{i}];
0578                         dispEM(EM);
0579                     <span class="keyword">end</span>
0580                     <span class="keyword">if</span> ~isempty(rules)
0581                         rules=[rules <span class="string">' or ('</span> geneNames{index} <span class="string">')'</span>];
0582                     <span class="keyword">else</span>
0583                         rules=[<span class="string">'('</span> geneNames{index} <span class="string">')'</span>];
0584                     <span class="keyword">end</span>
0585                 <span class="keyword">elseif</span> strcmp(modifier(1:2),<span class="string">'s_'</span>)
0586                     index=find(strcmp(modifier,metaboliteIDs));
0587                     <span class="comment">%This should be unique and in the geneIDs list,</span>
0588                     <span class="comment">%otherwise something is wrong</span>
0589                     <span class="keyword">if</span> numel(index)~=1
0590                         EM=[<span class="string">'Could not get the gene association data from reaction '</span> reactionIDs{i}];
0591                         dispEM(EM);
0592                     <span class="keyword">end</span>
0593                     <span class="keyword">if</span> ~isempty(rules)
0594                         rules=[rules <span class="string">' or ('</span> metaboliteIDs{index} <span class="string">')'</span>];
0595                     <span class="keyword">else</span>
0596                         rules=[<span class="string">'('</span> metaboliteIDs{index} <span class="string">')'</span>];
0597                     <span class="keyword">end</span>
0598                 <span class="keyword">else</span>
0599                     <span class="comment">%It seems to be a complex. Add the corresponding</span>
0600                     <span class="comment">%genes from the name of the complex (not the</span>
0601                     <span class="comment">%reaction that creates it)</span>
0602                     index=find(strcmp(modifier,complexIDs));
0603                     <span class="keyword">if</span> numel(index)==1
0604                         <span class="keyword">if</span> ~isempty(rules)
0605                             rules=[rules <span class="string">' or ('</span> strrep(complexNames{index},<span class="string">':'</span>,<span class="string">' and '</span>) <span class="string">')'</span>];
0606                         <span class="keyword">else</span>
0607                             rules=[<span class="string">'('</span> strrep(complexNames{index},<span class="string">':'</span>,<span class="string">' and '</span>) <span class="string">')'</span>];
0608                         <span class="keyword">end</span>
0609                     <span class="keyword">else</span>
0610                         <span class="comment">%Could not find a complex</span>
0611                         EM=[<span class="string">'Could not get the gene association data from reaction '</span> reactionIDs{i}];
0612                         dispEM(EM);
0613                     <span class="keyword">end</span>
0614                 <span class="keyword">end</span>
0615             <span class="keyword">end</span>
0616         <span class="keyword">end</span>
0617         grRules{counter}=rules;
0618         grRulesFromModifier{counter}=rules;<span class="comment">%Backup copy for grRules, useful to parse Yeast 7.6</span>
0619     <span class="keyword">end</span>
0620     
0621     <span class="comment">%Add reaction compartment</span>
0622     <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'compartment'</span>)
0623         <span class="keyword">if</span> ~isempty(modelSBML.reaction(i).compartment)
0624             rxnComp=modelSBML.reaction(i).compartment;
0625         <span class="keyword">else</span>
0626             rxnComp=<span class="string">''</span>;
0627         <span class="keyword">end</span>
0628     <span class="keyword">elseif</span> isfield(modelSBML.reaction(i),<span class="string">'notes'</span>)
0629         rxnComp=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'COMPARTMENT'</span>);
0630     <span class="keyword">end</span>
0631     <span class="keyword">if</span> ~isempty(rxnComp)
0632         <span class="comment">%Find it in the compartment list</span>
0633         [~, J]=ismember(rxnComp,compartmentIDs);
0634         rxnComps(counter)=J;
0635     <span class="keyword">end</span>
0636     
0637     <span class="comment">%Get other Miriam fields. This may include for example database indexes</span>
0638     <span class="comment">%to organism-specific databases. EC-codes are supported by the COBRA</span>
0639     <span class="comment">%Toolbox format and are therefore loaded separately</span>
0640     <span class="keyword">if</span> isSBML2COBRA==false
0641         miriamStruct=<a href="#_sub4" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.reaction(i).annotation);
0642         rxnMiriams{counter}=miriamStruct;
0643         <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'notes'</span>)
0644             subsystems{counter,1}=cellstr(<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'SUBSYSTEM'</span>));
0645             subsystems{counter,1}(cellfun(<span class="string">'isempty'</span>,subsystems{counter,1})) = [];
0646             <span class="keyword">if</span> strfind(modelSBML.reaction(i).notes,<span class="string">'Confidence Level'</span>)
0647                 rxnconfidencescores(counter)=str2num(<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'Confidence Level'</span>));
0648             <span class="keyword">end</span>
0649             rxnreferences{counter,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'AUTHORS'</span>);
0650             rxnnotes{counter,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'NOTES'</span>);
0651         <span class="keyword">end</span>
0652     <span class="keyword">end</span>
0653     
0654     <span class="comment">%Get SBO terms</span>
0655     <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'sboTerm'</span>)
0656         rxnMiriams{counter} = <a href="#_sub5" class="code" title="subfunction miriam = addSBOtoMiriam(miriam,sboTerm)">addSBOtoMiriam</a>(rxnMiriams{counter}, modelSBML.reaction(i).sboTerm);
0657     <span class="keyword">end</span>
0658     
0659     <span class="comment">%Get ec-codes</span>
0660     eccode=<span class="string">''</span>;
0661     <span class="keyword">if</span> ~isempty(modelSBML.reaction(i).annotation)
0662         <span class="keyword">if</span> strfind(modelSBML.reaction(i).annotation,<span class="string">'urn:miriam:ec-code'</span>)
0663             eccode=<a href="#_sub3" class="code" title="subfunction fieldContent=parseAnnotation(searchString,startString,midString,fieldName)">parseAnnotation</a>(modelSBML.reaction(i).annotation,<span class="string">'urn:miriam:'</span>,<span class="string">':'</span>,<span class="string">'ec-code'</span>);
0664         <span class="keyword">elseif</span> strfind(modelSBML.reaction(i).annotation,<span class="string">'http://identifiers.org/ec-code'</span>)
0665             eccode=<a href="#_sub3" class="code" title="subfunction fieldContent=parseAnnotation(searchString,startString,midString,fieldName)">parseAnnotation</a>(modelSBML.reaction(i).annotation,<span class="string">'http://identifiers.org/'</span>,<span class="string">'/'</span>,<span class="string">'ec-code'</span>);
0666         <span class="keyword">elseif</span> strfind(modelSBML.reaction(i).annotation,<span class="string">'https://identifiers.org/ec-code'</span>)
0667             eccode=<a href="#_sub3" class="code" title="subfunction fieldContent=parseAnnotation(searchString,startString,midString,fieldName)">parseAnnotation</a>(modelSBML.reaction(i).annotation,<span class="string">'https://identifiers.org/'</span>,<span class="string">'/'</span>,<span class="string">'ec-code'</span>);
0668         <span class="keyword">end</span>
0669     <span class="keyword">elseif</span> isfield(modelSBML.reaction(i),<span class="string">'notes'</span>)
0670         <span class="keyword">if</span> strfind(modelSBML.reaction(i).notes,<span class="string">'EC Number'</span>)
0671             eccode=[eccode <a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'EC Number'</span>)];
0672         <span class="keyword">elseif</span> strfind(modelSBML.reaction(i).notes,<span class="string">'PROTEIN_CLASS'</span>)
0673             eccode=[eccode <a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'PROTEIN_CLASS'</span>)];
0674         <span class="keyword">end</span>
0675     <span class="keyword">end</span>
0676     eccodes{counter}=eccode;
0677     
0678     <span class="comment">%Add all reactants</span>
0679     <span class="keyword">for</span> j=1:numel(modelSBML.reaction(i).reactant)
0680         <span class="comment">%Get the index of the metabolite in metaboliteIDs. External</span>
0681         <span class="comment">%metabolites will be removed at a later stage</span>
0682         metIndex=find(strcmp(modelSBML.reaction(i).reactant(j).species,metaboliteIDs),1);
0683         <span class="keyword">if</span> isempty(metIndex)
0684             EM=[<span class="string">'Could not find metabolite '</span> modelSBML.reaction(i).reactant(j).species <span class="string">' in reaction '</span> reactionIDs{counter}];
0685             dispEM(EM);
0686         <span class="keyword">end</span>
0687         S(metIndex,counter)=S(metIndex,counter)+modelSBML.reaction(i).reactant(j).stoichiometry*-1;
0688     <span class="keyword">end</span>
0689     
0690     <span class="comment">%Add all products</span>
0691     <span class="keyword">for</span> j=1:numel(modelSBML.reaction(i).product)
0692         <span class="comment">%Get the index of the metabolite in metaboliteIDs.</span>
0693         metIndex=find(strcmp(modelSBML.reaction(i).product(j).species,metaboliteIDs),1);
0694         <span class="keyword">if</span> isempty(metIndex)
0695             EM=[<span class="string">'Could not find metabolite '</span> modelSBML.reaction(i).reactant(j).species <span class="string">' in reaction '</span> reactionIDs{counter}];
0696             dispEM(EM);
0697         <span class="keyword">end</span>
0698         S(metIndex,counter)=S(metIndex,counter)+modelSBML.reaction(i).product(j).stoichiometry;
0699     <span class="keyword">end</span>
0700 <span class="keyword">end</span>
0701 
0702 <span class="comment">%if FBC, objective function is separately defined. Multiple objective</span>
0703 <span class="comment">%functions can be defined, one is set as active</span>
0704 <span class="keyword">if</span> isfield(modelSBML, <span class="string">'fbc_activeObjective'</span>)
0705     obj=modelSBML.fbc_activeObjective;
0706     <span class="keyword">for</span> i=1:numel(modelSBML.fbc_objective)
0707         <span class="keyword">if</span> strcmp(obj,modelSBML.fbc_objective(i).fbc_id)
0708             rxn=modelSBML.fbc_objective(i).fbc_fluxObjective.fbc_reaction;
0709             rxn=regexprep(rxn,<span class="string">'^R_'</span>,<span class="string">''</span>);
0710             idx=find(ismember(reactionIDs,rxn));
0711             reactionObjective(idx)=modelSBML.fbc_objective(i).fbc_fluxObjective.fbc_coefficient;
0712         <span class="keyword">end</span>
0713     <span class="keyword">end</span>
0714 <span class="keyword">end</span>
0715 
0716 <span class="comment">%subSystems can be stored as groups instead of in annotations</span>
0717 <span class="keyword">if</span> isfield(modelSBML,<span class="string">'groups_group'</span>)
0718     <span class="keyword">for</span> i=1:numel(modelSBML.groups_group)
0719         groupreactions={modelSBML.groups_group(i).groups_member(:).groups_idRef};
0720         groupreactions=regexprep(groupreactions,<span class="string">'^R_'</span>,<span class="string">''</span>);
0721         [~, idx] = ismember(groupreactions, reactionIDs);
0722         <span class="keyword">if</span> any(idx)
0723             <span class="keyword">for</span> j=1:numel(idx)
0724                 <span class="keyword">if</span> isempty(subsystems{idx(j)}) <span class="comment">% First subsystem</span>
0725                     subsystems{idx(j)} = {modelSBML.groups_group(i).groups_name};
0726                 <span class="keyword">else</span> <span class="comment">% Consecutive subsystems: concatenate</span>
0727                     subsystems{idx(j)} = horzcat(subsystems{idx(j)}, modelSBML.groups_group(i).groups_name);
0728                 <span class="keyword">end</span>
0729             <span class="keyword">end</span>
0730         <span class="keyword">end</span>
0731     <span class="keyword">end</span>
0732 <span class="keyword">end</span>
0733 
0734 <span class="comment">%Shrink the structures if complex-forming reactions had to be skipped</span>
0735 reactionNames=reactionNames(1:counter);
0736 reactionIDs=reactionIDs(1:counter);
0737 subsystems=subsystems(1:counter);
0738 eccodes=eccodes(1:counter);
0739 rxnconfidencescores=rxnconfidencescores(1:counter);
0740 rxnreferences=rxnreferences(1:counter);
0741 rxnnotes=rxnnotes(1:counter);
0742 grRules=grRules(1:counter);
0743 rxnMiriams=rxnMiriams(1:counter);
0744 reactionReversibility=reactionReversibility(1:counter);
0745 reactionUB=reactionUB(1:counter);
0746 reactionLB=reactionLB(1:counter);
0747 reactionObjective=reactionObjective(1:counter);
0748 S=S(:,1:counter);
0749 
0750 model.description=modelSBML.name;
0751 model.id=regexprep(modelSBML.id,<span class="string">'^M_'</span>,<span class="string">''</span>); <span class="comment">% COBRA adds M_ prefix</span>
0752 model.rxns=reactionIDs;
0753 model.mets=metaboliteIDs;
0754 model.S=sparse(S);
0755 model.lb=reactionLB;
0756 model.ub=reactionUB;
0757 model.rev=reactionReversibility;
0758 model.c=reactionObjective;
0759 model.b=zeros(numel(metaboliteIDs),1);
0760 model.comps=compartmentIDs;
0761 model.compNames=compartmentNames;
0762 model.rxnConfidenceScores=rxnconfidencescores;
0763 model.rxnReferences=rxnreferences;
0764 model.rxnNotes=rxnnotes;
0765 
0766 <span class="comment">%Load annotation if available. If there are several authors, only the first</span>
0767 <span class="comment">%author credentials are imported</span>
0768 <span class="keyword">if</span> isfield(modelSBML,<span class="string">'annotation'</span>)
0769     endString=<span class="string">'&lt;/'</span>;
0770     I=strfind(modelSBML.annotation,endString);
0771     J=strfind(modelSBML.annotation,<span class="string">'&lt;vCard:Family&gt;'</span>);
0772     <span class="keyword">if</span> any(J)
0773         model.annotation.familyName=modelSBML.annotation(J(1)+14:I(find(I&gt;J(1),1))-1);
0774     <span class="keyword">end</span>
0775     J=strfind(modelSBML.annotation,<span class="string">'&lt;vCard:Given&gt;'</span>);
0776     <span class="keyword">if</span> any(J)
0777         model.annotation.givenName=modelSBML.annotation(J(1)+13:I(find(I&gt;J(1),1))-1);
0778     <span class="keyword">end</span>
0779     J=strfind(modelSBML.annotation,<span class="string">'&lt;vCard:EMAIL&gt;'</span>);
0780     <span class="keyword">if</span> any(J)
0781         model.annotation.email=modelSBML.annotation(J(1)+13:I(find(I&gt;J(1),1))-1);
0782     <span class="keyword">end</span>
0783     J=strfind(modelSBML.annotation,<span class="string">'&lt;vCard:Orgname&gt;'</span>);
0784     <span class="keyword">if</span> any(J)
0785         model.annotation.organization=modelSBML.annotation(J(1)+15:I(find(I&gt;J(1),1))-1);
0786     <span class="keyword">end</span>
0787     endString=<span class="string">'&quot;/&gt;'</span>;
0788     I=strfind(modelSBML.annotation,endString);
0789     <span class="keyword">if</span> strfind(modelSBML.annotation,<span class="string">'&quot;urn:miriam:'</span>)
0790         J=strfind(modelSBML.annotation,<span class="string">'&quot;urn:miriam:'</span>);
0791         <span class="keyword">if</span> any(J)
0792             model.annotation.taxonomy=modelSBML.annotation(J+12:I(find(I&gt;J,1))-1);
0793         <span class="keyword">end</span>
0794     <span class="keyword">else</span>
0795         J=strfind(modelSBML.annotation,<span class="string">'&quot;http://identifiers.org/'</span>);
0796         <span class="keyword">if</span> any(J)
0797             model.annotation.taxonomy=modelSBML.annotation(J+24:I(find(I&gt;J,1))-1);
0798         <span class="keyword">else</span>
0799             J=strfind(modelSBML.annotation,<span class="string">'&quot;https://identifiers.org/'</span>);
0800             <span class="keyword">if</span> any(J)
0801                 model.annotation.taxonomy=modelSBML.annotation(J+24:I(find(I&gt;J,1))-1);
0802             <span class="keyword">end</span>
0803         <span class="keyword">end</span>
0804     <span class="keyword">end</span>
0805 <span class="keyword">end</span>
0806 <span class="keyword">if</span> isfield(modelSBML,<span class="string">'notes'</span>)
0807     startString=strfind(modelSBML.notes,<span class="string">'xhtml&quot;&gt;'</span>);
0808     endString=strfind(modelSBML.notes,<span class="string">'&lt;/body&gt;'</span>);
0809     <span class="keyword">if</span> any(startString) &amp;&amp; any(endString)
0810         model.annotation.note=modelSBML.notes(startString+7:endString-1);
0811         model.annotation.note=regexprep(model.annotation.note,<span class="string">'&lt;p&gt;|&lt;/p&gt;'</span>,<span class="string">''</span>);
0812         model.annotation.note=strtrim(model.annotation.note);
0813     <span class="keyword">end</span>
0814 <span class="keyword">end</span>
0815 
0816 <span class="keyword">if</span> any(~cellfun(@isempty,compartmentOutside))
0817     model.compOutside=compartmentOutside;
0818 <span class="keyword">end</span>
0819 
0820 model.rxnNames=reactionNames;
0821 model.metNames=metaboliteNames;
0822 
0823 <span class="comment">%Match the compartments for metabolites</span>
0824 [~, J]=ismember(metaboliteCompartments,model.comps);
0825 model.metComps=J;
0826 
0827 <span class="comment">%If any genes have been loaded (only for the new format)</span>
0828 <span class="keyword">if</span> ~isempty(geneNames)
0829     <span class="comment">%In some rare cases geneNames may not necessarily be used in grRules.</span>
0830     <span class="comment">%That is true for Yeast 7.6. It's therefore important to change gene</span>
0831     <span class="comment">%systematic names to geneIDs in sophisticated way. Gene systematic</span>
0832     <span class="comment">%names are not unique, since exactly the same name may be in different</span>
0833     <span class="comment">%compartments</span>
0834     <span class="keyword">if</span> all(cellfun(@isempty,strfind(grRules,geneNames{1})))
0835         geneShortNames=geneNames;
0836         <span class="comment">%geneShortNames contain compartments as well, so these are removed</span>
0837         geneShortNames=regexprep(geneShortNames,<span class="string">' \[.+$'</span>,<span class="string">''</span>);
0838         <span class="comment">%grRules obtained from modifier fields contain geneNames. These are</span>
0839         <span class="comment">%changed into geneIDs. grRulesFromModifier is a good way to have</span>
0840         <span class="comment">%geneIDs and rxns association when it's important to resolve</span>
0841         <span class="comment">%systematic name ambiguities</span>
0842         grRulesFromModifier=regexprep(regexprep(grRulesFromModifier,<span class="string">'\[|\]'</span>,<span class="string">'_'</span>),regexprep(geneNames,<span class="string">'\[|\]'</span>,<span class="string">'_'</span>),geneIDs);
0843         grRules=regexprep(regexprep(grRules,<span class="string">'\[|\]'</span>,<span class="string">'_'</span>),regexprep(geneNames,<span class="string">'\[|\]'</span>,<span class="string">'_'</span>),geneIDs);
0844         
0845         <span class="comment">%Yeast 7.6 contains several metabolites, which were used in gene</span>
0846         <span class="comment">%associations. For that reason, the list of species ID is created</span>
0847         <span class="comment">%and we then check whether any of them have kegg.genes annotation</span>
0848         <span class="comment">%thereby obtaining systematic gene names</span>
0849         geneShortNames=vertcat(geneShortNames,metaboliteNames);
0850         geneIDs=vertcat(geneIDs,metaboliteIDs);
0851         geneSystNames=extractMiriam(vertcat(geneMiriams,metaboliteMiriams),<span class="string">'kegg.genes'</span>);
0852         geneSystNames=regexprep(geneSystNames,<span class="string">'^.+:'</span>,<span class="string">''</span>);
0853         geneCompartments=vertcat(geneCompartments,metaboliteCompartments);
0854         geneMiriams=vertcat(geneMiriams,metaboliteMiriams);
0855         
0856         <span class="comment">%Now we retain information for only these entries, which have</span>
0857         <span class="comment">%kegg.genes annotation</span>
0858         geneShortNames=geneShortNames(~cellfun(<span class="string">'isempty'</span>,geneSystNames));
0859         geneIDs=geneIDs(~cellfun(<span class="string">'isempty'</span>,geneSystNames));
0860         geneSystNames=geneSystNames(~cellfun(<span class="string">'isempty'</span>,geneSystNames));
0861         geneCompartments=geneCompartments(~cellfun(<span class="string">'isempty'</span>,geneSystNames));
0862         geneMiriams=geneMiriams(~cellfun(<span class="string">'isempty'</span>,geneSystNames));
0863         <span class="comment">%Now we reorder geneIDs and geneSystNames by geneSystNames string</span>
0864         <span class="comment">%length</span>
0865         geneNames=geneIDs;<span class="comment">%Backuping geneIDs, since we need unsorted order for later</span>
0866         [~, Indx] = sort(cellfun(<span class="string">'size'</span>, geneSystNames, 2), <span class="string">'descend'</span>);
0867         geneIDs = geneIDs(Indx);
0868         geneSystNames = geneSystNames(Indx);
0869         <span class="keyword">for</span> i=1:numel(geneSystNames)
0870             <span class="keyword">for</span> j=1:numel(grRules)
0871                 <span class="keyword">if</span> strfind(grRules{j},geneSystNames{i})
0872                     <span class="keyword">if</span> ~isempty(grRules{j})
0873                         <span class="keyword">if</span> sum(ismember(geneSystNames,geneSystNames{i}))==1
0874                             grRules{j}=regexprep(grRules{j},geneSystNames{i},geneIDs{i});
0875                         <span class="keyword">elseif</span> sum(ismember(geneSystNames,geneSystNames{i}))&gt;1
0876                             counter=0;
0877                             ovrlpIDs=geneIDs(ismember(geneSystNames,geneSystNames{i}));
0878                             <span class="keyword">for</span> k=1:numel(ovrlpIDs)
0879                                 <span class="keyword">if</span> strfind(grRulesFromModifier{j},ovrlpIDs{k})
0880                                     counter=counter+1;
0881                                     grRules{j}=regexprep(grRules{j},geneSystNames{i},ovrlpIDs{k});
0882                                 <span class="keyword">end</span>
0883                                 <span class="keyword">if</span> counter&gt;1
0884                                     EM=[<span class="string">'Gene association is ambiguous for reaction '</span> modelSBML.reaction(j).id];
0885                                     dispEM(EM);
0886                                 <span class="keyword">end</span>
0887                             <span class="keyword">end</span>
0888                         <span class="keyword">end</span>
0889                     <span class="keyword">end</span>
0890                 <span class="keyword">end</span>
0891             <span class="keyword">end</span>
0892         <span class="keyword">end</span>
0893     <span class="keyword">end</span>
0894     model.genes=geneNames;
0895     model.grRules=grRules;
0896     [grRules,rxnGeneMat] = standardizeGrRules(model,true);
0897     model.grRules = grRules;
0898     model.rxnGeneMat = rxnGeneMat;
0899     
0900     <span class="comment">%Match the compartments for genes</span>
0901     [~, J]=ismember(geneCompartments,model.comps);
0902     model.geneComps=J;
0903 <span class="keyword">else</span>
0904     <span class="keyword">if</span> ~all(cellfun(@isempty,grRules))
0905         <span class="comment">%If fbc_geneProduct exists, follow the specified gene order, such</span>
0906         <span class="comment">%that matching geneShortNames in function below will work</span>
0907         <span class="keyword">if</span> isfield(modelSBML,<span class="string">'fbc_geneProduct'</span>)
0908             genes={modelSBML.fbc_geneProduct.fbc_id};
0909             
0910             <span class="comment">%Get gene Miriams if they were not retrieved above (this occurs</span>
0911             <span class="comment">%when genes are stored as fbc_geneProduct instead of species)</span>
0912             <span class="keyword">if</span> isempty(geneMiriams)
0913                 geneMiriams = cell(numel(genes),1);
0914                 <span class="keyword">if</span> isfield(modelSBML.fbc_geneProduct,<span class="string">'sboTerm'</span>) &amp;&amp; numel(unique([modelSBML.fbc_geneProduct.sboTerm])) == 1
0915                     <span class="comment">%If all the SBO terms are identical, don't add them to geneMiriams</span>
0916                     modelSBML.fbc_geneProduct = rmfield(modelSBML.fbc_geneProduct,<span class="string">'sboTerm'</span>);
0917                 <span class="keyword">end</span>
0918                 <span class="keyword">for</span> i = 1:numel(genes)
0919                     geneMiriams{i}=<a href="#_sub4" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.fbc_geneProduct(i).annotation);
0920                     <span class="keyword">if</span> isfield(modelSBML.fbc_geneProduct(i),<span class="string">'sboTerm'</span>)
0921                         geneMiriams{i} = <a href="#_sub5" class="code" title="subfunction miriam = addSBOtoMiriam(miriam,sboTerm)">addSBOtoMiriam</a>(geneMiriams{i},modelSBML.fbc_geneProduct(i).sboTerm);
0922                     <span class="keyword">end</span>
0923                 <span class="keyword">end</span>
0924             <span class="keyword">end</span>
0925         <span class="keyword">else</span>
0926             genes=<a href="#_sub1" class="code" title="subfunction matchGenes=getGeneList(grRules)">getGeneList</a>(grRules);
0927         <span class="keyword">end</span>
0928         <span class="keyword">if</span> strcmpi(genes{1}(1:2),<span class="string">'G_'</span>)
0929             genes=regexprep(genes,<span class="string">'^G_'</span>,<span class="string">''</span>);
0930             grRules=regexprep(grRules,<span class="string">'^G_'</span>,<span class="string">''</span>);
0931             grRules=regexprep(grRules,<span class="string">'\(G_'</span>,<span class="string">'('</span>);
0932             grRules=regexprep(grRules,<span class="string">' G_'</span>,<span class="string">' '</span>);
0933         <span class="keyword">end</span>
0934         model.genes=genes;
0935         model.grRules=grRules;
0936         [grRules,rxnGeneMat] = standardizeGrRules(model,true);
0937         model.grRules = grRules;
0938         model.rxnGeneMat = rxnGeneMat;
0939     <span class="keyword">end</span>
0940 <span class="keyword">end</span>
0941 
0942 <span class="keyword">if</span> all(cellfun(@isempty,geneShortNames))
0943     <span class="keyword">if</span> isfield(modelSBML,<span class="string">'fbc_geneProduct'</span>)
0944         <span class="keyword">for</span> i=1:numel(genes)
0945             <span class="keyword">if</span> ~isempty(modelSBML.fbc_geneProduct(i).fbc_label)
0946                 geneShortNames{i,1}=modelSBML.fbc_geneProduct(i).fbc_label;
0947             <span class="keyword">elseif</span> ~isempty(modelSBML.fbc_geneProduct(i).fbc_name)
0948                 geneShortNames{i,1}=modelSBML.fbc_geneProduct(i).fbc_name;
0949             <span class="keyword">else</span>
0950                 geneShortNames{i,1}=<span class="string">''</span>;
0951             <span class="keyword">end</span>
0952         <span class="keyword">end</span>
0953     <span class="keyword">end</span>
0954 <span class="keyword">end</span>
0955 
0956 <span class="comment">%If any InChIs have been loaded</span>
0957 <span class="keyword">if</span> any(~cellfun(@isempty,metaboliteInChI))
0958     model.inchis=metaboliteInChI;
0959 <span class="keyword">end</span>
0960 
0961 <span class="comment">%If any formulas have been loaded</span>
0962 <span class="keyword">if</span> any(~cellfun(@isempty,metaboliteFormula))
0963     model.metFormulas=metaboliteFormula;
0964 <span class="keyword">end</span>
0965 
0966 <span class="comment">%If any charges have been loaded</span>
0967 <span class="keyword">if</span> ~isempty(metaboliteCharges)
0968     model.metCharges=metaboliteCharges;
0969 <span class="keyword">end</span>
0970 
0971 <span class="comment">%If any gene short names have been loaded</span>
0972 <span class="keyword">if</span> any(~cellfun(@isempty,geneShortNames))
0973     model.geneShortNames=geneShortNames;
0974 <span class="keyword">end</span>
0975 
0976 <span class="comment">%If any Miriam strings for compartments have been loaded</span>
0977 <span class="keyword">if</span> any(~cellfun(@isempty,compartmentMiriams))
0978     model.compMiriams=compartmentMiriams;
0979 <span class="keyword">end</span>
0980 
0981 <span class="comment">%If any Miriam strings for metabolites have been loaded</span>
0982 <span class="keyword">if</span> any(~cellfun(@isempty,metaboliteMiriams))
0983     model.metMiriams=metaboliteMiriams;
0984 <span class="keyword">end</span>
0985 
0986 <span class="comment">%If any subsystems have been loaded</span>
0987 <span class="keyword">if</span> any(~cellfun(@isempty,subsystems))
0988     model.subSystems=subsystems;
0989 <span class="keyword">end</span>
0990 <span class="keyword">if</span> any(rxnComps)
0991     <span class="keyword">if</span> all(rxnComps)
0992         model.rxnComps=rxnComps;
0993     <span class="keyword">else</span>
0994         <span class="keyword">if</span> supressWarnings==false
0995             EM=<span class="string">'The compartments for the following reactions could not be matched. Ignoring reaction compartment information'</span>;
0996             dispEM(EM,false,model.rxns(rxnComps==0));
0997         <span class="keyword">end</span>
0998     <span class="keyword">end</span>
0999 <span class="keyword">end</span>
1000 
1001 <span class="comment">%If any ec-codes have been loaded</span>
1002 <span class="keyword">if</span> any(~cellfun(@isempty,eccodes))
1003     model.eccodes=eccodes;
1004 <span class="keyword">end</span>
1005 
1006 <span class="comment">%If any Miriam strings for reactions have been loaded</span>
1007 <span class="keyword">if</span> any(~cellfun(@isempty,rxnMiriams))
1008     model.rxnMiriams=rxnMiriams;
1009 <span class="keyword">end</span>
1010 
1011 <span class="comment">%If any Miriam strings for genes have been loaded</span>
1012 <span class="keyword">if</span> any(~cellfun(@isempty,geneMiriams))
1013     model.geneMiriams=geneMiriams;
1014 <span class="keyword">end</span>
1015 
1016 model.unconstrained=metaboliteUnconstrained;
1017 
1018 <span class="comment">%Convert SBML IDs back into their original strings. Here we are using part</span>
1019 <span class="comment">%from convertSBMLID, originating from the COBRA Toolbox</span>
1020 model.rxns=regexprep(model.rxns,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
1021 model.mets=regexprep(model.mets,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
1022 model.comps=regexprep(model.comps,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
1023 model.grRules=regexprep(model.grRules,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
1024 model.genes=regexprep(model.genes,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
1025 model.id=regexprep(model.id,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
1026 
1027 <span class="comment">%Remove unused fields</span>
1028 <span class="keyword">if</span> isempty(model.annotation)
1029     model=rmfield(model,<span class="string">'annotation'</span>);
1030 <span class="keyword">end</span>
1031 <span class="keyword">if</span> isempty(model.compOutside)
1032     model=rmfield(model,<span class="string">'compOutside'</span>);
1033 <span class="keyword">end</span>
1034 <span class="keyword">if</span> isempty(model.compMiriams)
1035     model=rmfield(model,<span class="string">'compMiriams'</span>);
1036 <span class="keyword">end</span>
1037 <span class="keyword">if</span> isempty(model.rxnComps)
1038     model=rmfield(model,<span class="string">'rxnComps'</span>);
1039 <span class="keyword">end</span>
1040 <span class="keyword">if</span> isempty(model.grRules)
1041     model=rmfield(model,<span class="string">'grRules'</span>);
1042 <span class="keyword">end</span>
1043 <span class="keyword">if</span> isempty(model.rxnGeneMat)
1044     model=rmfield(model,<span class="string">'rxnGeneMat'</span>);
1045 <span class="keyword">end</span>
1046 <span class="keyword">if</span> isempty(model.subSystems)
1047     model=rmfield(model,<span class="string">'subSystems'</span>);
1048 <span class="keyword">end</span>
1049 <span class="keyword">if</span> isempty(model.eccodes)
1050     model=rmfield(model,<span class="string">'eccodes'</span>);
1051 <span class="keyword">end</span>
1052 <span class="keyword">if</span> isempty(model.rxnMiriams)
1053     model=rmfield(model,<span class="string">'rxnMiriams'</span>);
1054 <span class="keyword">end</span>
1055 <span class="keyword">if</span> cellfun(@isempty,model.rxnNotes)
1056     model=rmfield(model,<span class="string">'rxnNotes'</span>);
1057 <span class="keyword">end</span>
1058 <span class="keyword">if</span> cellfun(@isempty,model.rxnReferences)
1059     model=rmfield(model,<span class="string">'rxnReferences'</span>);
1060 <span class="keyword">end</span>
1061 <span class="keyword">if</span> isempty(model.rxnConfidenceScores) || all(isnan(model.rxnConfidenceScores))
1062     model=rmfield(model,<span class="string">'rxnConfidenceScores'</span>);
1063 <span class="keyword">end</span>
1064 <span class="keyword">if</span> isempty(model.genes)
1065     model=rmfield(model,<span class="string">'genes'</span>);
1066 <span class="keyword">elseif</span> isrow(model.genes)
1067     model.genes=transpose(model.genes);
1068 <span class="keyword">end</span>
1069 <span class="keyword">if</span> isempty(model.geneComps)
1070     model=rmfield(model,<span class="string">'geneComps'</span>);
1071 <span class="keyword">end</span>
1072 <span class="keyword">if</span> isempty(model.geneMiriams)
1073     model=rmfield(model,<span class="string">'geneMiriams'</span>);
1074 <span class="keyword">end</span>
1075 <span class="keyword">if</span> isempty(model.geneShortNames)
1076     model=rmfield(model,<span class="string">'geneShortNames'</span>);
1077 <span class="keyword">end</span>
1078 <span class="keyword">if</span> isempty(model.inchis)
1079     model=rmfield(model,<span class="string">'inchis'</span>);
1080 <span class="keyword">end</span>
1081 <span class="keyword">if</span> isempty(model.metFormulas)
1082     model=rmfield(model,<span class="string">'metFormulas'</span>);
1083 <span class="keyword">end</span>
1084 <span class="keyword">if</span> isempty(model.metMiriams)
1085     model=rmfield(model,<span class="string">'metMiriams'</span>);
1086 <span class="keyword">end</span>
1087 <span class="keyword">if</span> ~any(model.metCharges)
1088     model=rmfield(model,<span class="string">'metCharges'</span>);
1089 <span class="keyword">end</span>
1090 
1091 <span class="comment">%This just removes the grRules if no genes have been loaded</span>
1092 <span class="keyword">if</span> ~isfield(model,<span class="string">'genes'</span>) &amp;&amp; isfield(model,<span class="string">'grRules'</span>)
1093     model=rmfield(model,<span class="string">'grRules'</span>);
1094 <span class="keyword">end</span>
1095 
1096 <span class="comment">%Print warnings about bad structure</span>
1097 <span class="keyword">if</span> supressWarnings==false
1098     checkModelStruct(model,false);
1099 <span class="keyword">end</span>
1100 
1101 <span class="keyword">if</span> removeExcMets==true
1102     model=simplifyModel(model);
1103 <span class="keyword">end</span>
1104 <span class="keyword">end</span>
1105 
1106 <a name="_sub1" href="#_subfunctions" class="code">function matchGenes=getGeneList(grRules)</a>
1107 <span class="comment">%Constructs the list of unique genes from grRules</span>
1108 
1109 <span class="comment">%Assumes that everything that isn't a paranthesis, &quot; AND &quot; or &quot; or &quot; is a</span>
1110 <span class="comment">%gene name</span>
1111 genes=strrep(grRules,<span class="string">'('</span>,<span class="string">''</span>);
1112 genes=strrep(genes,<span class="string">')'</span>,<span class="string">''</span>);
1113 genes=strrep(genes,<span class="string">' or '</span>,<span class="string">' '</span>);
1114 genes=strrep(genes,<span class="string">' and '</span>,<span class="string">' '</span>);
1115 genes=strrep(genes,<span class="string">' OR '</span>,<span class="string">' '</span>);
1116 genes=strrep(genes,<span class="string">' AND '</span>,<span class="string">' '</span>);
1117 genes=regexp(genes,<span class="string">' '</span>,<span class="string">'split'</span>);
1118 
1119 allNames={};
1120 <span class="keyword">for</span> i=1:numel(genes)
1121     allNames=[allNames genes{i}];
1122 <span class="keyword">end</span>
1123 matchGenes=unique(allNames)';
1124 
1125 <span class="comment">%Remove the empty element if present</span>
1126 <span class="keyword">if</span> isempty(matchGenes{1})
1127     matchGenes(1)=[];
1128 <span class="keyword">end</span>
1129 <span class="keyword">end</span>
1130 
1131 <a name="_sub2" href="#_subfunctions" class="code">function fieldContent=parseNote(searchString,fieldName)</a>
1132 <span class="comment">%The function obtains the particular information from 'notes' field, using</span>
1133 <span class="comment">%fieldName as the dummy string</span>
1134 
1135 fieldContent=<span class="string">''</span>;
1136 
1137 <span class="keyword">if</span> strfind(searchString,fieldName)
1138     [~,targetString] = regexp(searchString,[<span class="string">'&lt;p&gt;'</span> fieldName <span class="string">'.*?&lt;/p&gt;'</span>],<span class="string">'tokens'</span>,<span class="string">'match'</span>);
1139     targetString=regexprep(targetString,<span class="string">'&lt;p&gt;|&lt;/p&gt;'</span>,<span class="string">''</span>);
1140     targetString=regexprep(targetString,[fieldName, <span class="string">':'</span>],<span class="string">''</span>);
1141     <span class="keyword">for</span> i=1:numel(targetString)
1142         fieldContent=[fieldContent <span class="string">';'</span> strtrim(targetString{1,i})];
1143     <span class="keyword">end</span>
1144     fieldContent=regexprep(fieldContent,<span class="string">'^;|;$'</span>,<span class="string">''</span>);
1145 <span class="keyword">else</span>
1146     fieldContent=<span class="string">''</span>;
1147 <span class="keyword">end</span>
1148 <span class="keyword">end</span>
1149 
1150 <a name="_sub3" href="#_subfunctions" class="code">function fieldContent=parseAnnotation(searchString,startString,midString,fieldName)</a>
1151 
1152 fieldContent=<span class="string">''</span>;
1153 
1154 <span class="comment">%Removing whitespace characters from the ending strings, which may occur in</span>
1155 <span class="comment">%several cases</span>
1156 searchString=regexprep(searchString,<span class="string">'&quot; /&gt;'</span>,<span class="string">'&quot;/&gt;'</span>);
1157 [~,targetString] = regexp(searchString,[<span class="string">'&lt;rdf:li rdf:resource=&quot;'</span> startString fieldName midString <span class="string">'.*?&quot;/&gt;'</span>],<span class="string">'tokens'</span>,<span class="string">'match'</span>);
1158 targetString=regexprep(targetString,<span class="string">'&lt;rdf:li rdf:resource=&quot;|&quot;/&gt;'</span>,<span class="string">''</span>);
1159 targetString=regexprep(targetString,startString,<span class="string">''</span>);
1160 targetString=regexprep(targetString,[fieldName midString],<span class="string">''</span>);
1161 
1162 <span class="keyword">for</span> i=1:numel(targetString)
1163     fieldContent=[fieldContent <span class="string">';'</span> strtrim(targetString{1,i})];
1164 <span class="keyword">end</span>
1165 
1166 fieldContent=regexprep(fieldContent,<span class="string">'^;|;$'</span>,<span class="string">''</span>);
1167 <span class="keyword">end</span>
1168 
1169 <a name="_sub4" href="#_subfunctions" class="code">function miriamStruct=parseMiriam(searchString)</a>
1170 <span class="comment">%Generates miriam structure from annotation field</span>
1171 
1172 <span class="comment">%Finding whether miriams are written in the old or the new way</span>
1173 <span class="keyword">if</span> strfind(searchString,<span class="string">'urn:miriam:'</span>)
1174     startString=<span class="string">'urn:miriam:'</span>;
1175     midString=<span class="string">':'</span>;
1176 <span class="keyword">elseif</span> strfind(searchString,<span class="string">'http://identifiers.org/'</span>)
1177     startString=<span class="string">'http://identifiers.org/'</span>;
1178     midString=<span class="string">'/'</span>;
1179 <span class="keyword">elseif</span> strfind(searchString,<span class="string">'https://identifiers.org/'</span>)
1180     startString=<span class="string">'https://identifiers.org/'</span>;
1181     midString=<span class="string">'/'</span>;
1182 <span class="keyword">else</span>
1183     miriamStruct=[];
1184     <span class="keyword">return</span>;
1185 <span class="keyword">end</span>
1186 
1187 miriamStruct=[];
1188 
1189 searchString=regexprep(searchString,<span class="string">'&quot; /&gt;'</span>,<span class="string">'&quot;/&gt;'</span>);
1190 [~,targetString] = regexp(searchString,<span class="string">'&lt;rdf:li rdf:resource=&quot;.*?&quot;/&gt;'</span>,<span class="string">'tokens'</span>,<span class="string">'match'</span>);
1191 targetString=regexprep(targetString,<span class="string">'&lt;rdf:li rdf:resource=&quot;|&quot;/&gt;'</span>,<span class="string">''</span>);
1192 targetString=regexprep(targetString,startString,<span class="string">''</span>);
1193 targetString=regexprep(targetString,midString,<span class="string">'/'</span>,<span class="string">'once'</span>);
1194 
1195 counter=0;
1196 <span class="keyword">for</span> i=1:numel(targetString)
1197     <span class="keyword">if</span> isempty(regexp(targetString{1,i},<span class="string">'inchi|ec-code'</span>, <span class="string">'once'</span>))
1198         counter=counter+1;
1199         miriamStruct.name{counter,1} = regexprep(targetString{1,i},<span class="string">'/.+'</span>,<span class="string">''</span>,<span class="string">'once'</span>);
1200         miriamStruct.value{counter,1} = regexprep(targetString{1,i},[miriamStruct.name{counter,1} <span class="string">'/'</span>],<span class="string">''</span>,<span class="string">'once'</span>);
1201         miriamStruct.name{counter,1} = regexprep(miriamStruct.name{counter,1},<span class="string">'^obo\.'</span>,<span class="string">''</span>);
1202     <span class="keyword">end</span>
1203 <span class="keyword">end</span>
1204 <span class="keyword">end</span>
1205 
1206 <a name="_sub5" href="#_subfunctions" class="code">function miriam = addSBOtoMiriam(miriam,sboTerm)</a>
1207 <span class="comment">%Appends SBO term to miriam structure</span>
1208 
1209 sboTerm = {[<span class="string">'SBO:'</span> sprintf(<span class="string">'%07u'</span>,sboTerm)]};  <span class="comment">% convert to proper format</span>
1210 <span class="keyword">if</span> isempty(miriam)
1211     miriam.name = {<span class="string">'sbo'</span>};
1212     miriam.value = sboTerm;
1213 <span class="keyword">else</span>
1214     miriam.name(end+1) = {<span class="string">'sbo'</span>};
1215     miriam.value(end+1) = sboTerm;
1216 <span class="keyword">end</span>
1217 
1218 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Mon 08-Feb-2021 16:49:52 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>