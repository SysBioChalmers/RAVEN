<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of importModel</title>
  <meta name="keywords" content="importModel">
  <meta name="description" content="importModel">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">io</a> &gt; importModel.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for io&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>importModel
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>importModel</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function model=importModel(fileName,removeExcMets,COBRAstyle,supressWarnings) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> importModel
   Import a constraint-based model from a SBML file

 Input:
   fileName        a SBML file to import. A dialog window will open if
                   no file name is specified.
   removeExcMets   true if exchange metabolites should be removed. This is
                   needed to be able to run simulations, but it could also
                   be done using simplifyModel at a later stage (optional,
                   default true)
   COBRAstyle      true if the model uses COBRA style identifier prefixes
                   that should be removed when loading the model: G_ for
                   genes, R_ for reactions, M_ for metabolites, and C_ for
                   compartments. (optional, default false)
   supressWarnings true if warnings regarding the model structure should
                   be supressed (optional, default false)

 Output:
   model
       id               model ID
       name             name of model contents
       annotation       additional information about model
       rxns             reaction ids
       mets             metabolite ids
       S                stoichiometric matrix
       lb               lower bounds
       ub               upper bounds
       rev              reversibility vector
       c                objective coefficients
       b                equality constraints for the metabolite equations
       comps            compartment ids
       compNames        compartment names
       compOutside      the id (as in comps) for the compartment
                        surrounding each of the compartments
       compMiriams      structure with MIRIAM information about the
                        compartments
       rxnNames         reaction description
       rxnComps         compartments for reactions
       grRules          reaction to gene rules in text form
       rxnGeneMat       reaction-to-gene mapping in sparse matrix form
       subSystems       subsystem name for each reaction
       eccodes          EC-codes for the reactions
       rxnMiriams       structure with MIRIAM information about the reactions
       rxnNotes         reaction notes
       rxnReferences    reaction references
       rxnConfidenceScores reaction confidence scores
       genes            list of all genes
       geneComps        compartments for genes
       geneMiriams      structure with MIRIAM information about the genes
       geneShortNames   gene alternative names (e.g. ERG10)
       proteinNames     protein associated to each gene
       metNames         metabolite description
       metComps         compartments for metabolites
       inchis           InChI-codes for metabolites
       metFormulas      metabolite chemical formula
       metMiriams       structure with MIRIAM information about the metabolites
       metCharges       metabolite charge
       unconstrained    true if the metabolite is an exchange metabolite

 A number of consistency checks are performed in order to ensure that the
 model is valid. Take these warnings seriously and modify the model
 structure to solve them.

 Usage: model = importModel(fileName, removeExcMets, COBRAstyle, supressWarnings)</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="checkFileExistence.html" class="code" title="function files=checkFileExistence(files,fullOrTemp,allowSpace,checkExist)">checkFileExistence</a>	checkFileExistence</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function matchGenes=getGeneList(grRules)</a></li><li><a href="#_sub2" class="code">function fieldContent=parseNote(searchString,fieldName)</a></li><li><a href="#_sub3" class="code">function fieldContent=parseAnnotation(searchString,startString,midString,fieldName)</a></li><li><a href="#_sub4" class="code">function miriamStruct=parseMiriam(searchString)</a></li><li><a href="#_sub5" class="code">function miriam = addSBOtoMiriam(miriam,sboTerm)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function model=importModel(fileName,removeExcMets,COBRAstyle,supressWarnings)</a>
0002 <span class="comment">% importModel</span>
0003 <span class="comment">%   Import a constraint-based model from a SBML file</span>
0004 <span class="comment">%</span>
0005 <span class="comment">% Input:</span>
0006 <span class="comment">%   fileName        a SBML file to import. A dialog window will open if</span>
0007 <span class="comment">%                   no file name is specified.</span>
0008 <span class="comment">%   removeExcMets   true if exchange metabolites should be removed. This is</span>
0009 <span class="comment">%                   needed to be able to run simulations, but it could also</span>
0010 <span class="comment">%                   be done using simplifyModel at a later stage (optional,</span>
0011 <span class="comment">%                   default true)</span>
0012 <span class="comment">%   COBRAstyle      true if the model uses COBRA style identifier prefixes</span>
0013 <span class="comment">%                   that should be removed when loading the model: G_ for</span>
0014 <span class="comment">%                   genes, R_ for reactions, M_ for metabolites, and C_ for</span>
0015 <span class="comment">%                   compartments. (optional, default false)</span>
0016 <span class="comment">%   supressWarnings true if warnings regarding the model structure should</span>
0017 <span class="comment">%                   be supressed (optional, default false)</span>
0018 <span class="comment">%</span>
0019 <span class="comment">% Output:</span>
0020 <span class="comment">%   model</span>
0021 <span class="comment">%       id               model ID</span>
0022 <span class="comment">%       name             name of model contents</span>
0023 <span class="comment">%       annotation       additional information about model</span>
0024 <span class="comment">%       rxns             reaction ids</span>
0025 <span class="comment">%       mets             metabolite ids</span>
0026 <span class="comment">%       S                stoichiometric matrix</span>
0027 <span class="comment">%       lb               lower bounds</span>
0028 <span class="comment">%       ub               upper bounds</span>
0029 <span class="comment">%       rev              reversibility vector</span>
0030 <span class="comment">%       c                objective coefficients</span>
0031 <span class="comment">%       b                equality constraints for the metabolite equations</span>
0032 <span class="comment">%       comps            compartment ids</span>
0033 <span class="comment">%       compNames        compartment names</span>
0034 <span class="comment">%       compOutside      the id (as in comps) for the compartment</span>
0035 <span class="comment">%                        surrounding each of the compartments</span>
0036 <span class="comment">%       compMiriams      structure with MIRIAM information about the</span>
0037 <span class="comment">%                        compartments</span>
0038 <span class="comment">%       rxnNames         reaction description</span>
0039 <span class="comment">%       rxnComps         compartments for reactions</span>
0040 <span class="comment">%       grRules          reaction to gene rules in text form</span>
0041 <span class="comment">%       rxnGeneMat       reaction-to-gene mapping in sparse matrix form</span>
0042 <span class="comment">%       subSystems       subsystem name for each reaction</span>
0043 <span class="comment">%       eccodes          EC-codes for the reactions</span>
0044 <span class="comment">%       rxnMiriams       structure with MIRIAM information about the reactions</span>
0045 <span class="comment">%       rxnNotes         reaction notes</span>
0046 <span class="comment">%       rxnReferences    reaction references</span>
0047 <span class="comment">%       rxnConfidenceScores reaction confidence scores</span>
0048 <span class="comment">%       genes            list of all genes</span>
0049 <span class="comment">%       geneComps        compartments for genes</span>
0050 <span class="comment">%       geneMiriams      structure with MIRIAM information about the genes</span>
0051 <span class="comment">%       geneShortNames   gene alternative names (e.g. ERG10)</span>
0052 <span class="comment">%       proteinNames     protein associated to each gene</span>
0053 <span class="comment">%       metNames         metabolite description</span>
0054 <span class="comment">%       metComps         compartments for metabolites</span>
0055 <span class="comment">%       inchis           InChI-codes for metabolites</span>
0056 <span class="comment">%       metFormulas      metabolite chemical formula</span>
0057 <span class="comment">%       metMiriams       structure with MIRIAM information about the metabolites</span>
0058 <span class="comment">%       metCharges       metabolite charge</span>
0059 <span class="comment">%       unconstrained    true if the metabolite is an exchange metabolite</span>
0060 <span class="comment">%</span>
0061 <span class="comment">% A number of consistency checks are performed in order to ensure that the</span>
0062 <span class="comment">% model is valid. Take these warnings seriously and modify the model</span>
0063 <span class="comment">% structure to solve them.</span>
0064 <span class="comment">%</span>
0065 <span class="comment">% Usage: model = importModel(fileName, removeExcMets, COBRAstyle, supressWarnings)</span>
0066 
0067 <span class="keyword">if</span> nargin&lt;1 || isempty(fileName)
0068     [fileName, pathName] = uigetfile({<span class="string">'*.xml;*.sbml'</span>}, <span class="string">'Please select the model file'</span>);
0069     <span class="keyword">if</span> fileName == 0
0070         error(<span class="string">'You should select a model file'</span>)
0071     <span class="keyword">else</span>
0072         fileName = fullfile(pathName,fileName);
0073     <span class="keyword">end</span>
0074 <span class="keyword">end</span>
0075 fileName=char(fileName);
0076 <span class="keyword">if</span> nargin&lt;2 || isempty(removeExcMets)
0077     removeExcMets=true;
0078 <span class="keyword">end</span>
0079 
0080 <span class="keyword">if</span> nargin&lt;3 || isempty(COBRAstyle)
0081     COBRAstyle=false;
0082 <span class="keyword">end</span>
0083 
0084 <span class="keyword">if</span> nargin&lt;4
0085     supressWarnings=false;
0086 <span class="keyword">end</span>
0087 
0088 <span class="keyword">if</span> ~isfile(fileName)
0089     error(<span class="string">'SBML file %s cannot be found'</span>,string(fileName));
0090 <span class="keyword">end</span>
0091 
0092 <span class="comment">%This is to match the order of the fields to those you get from importing</span>
0093 <span class="comment">%from Excel</span>
0094 model=[];
0095 model.id=[];
0096 model.name=[];
0097 model.annotation=[];
0098 model.rxns={};
0099 model.mets={};
0100 model.S=[];
0101 model.lb=[];
0102 model.ub=[];
0103 model.rev=[];
0104 model.c=[];
0105 model.b=[];
0106 model.comps={};
0107 model.compNames={};
0108 model.compOutside={};
0109 model.compMiriams={};
0110 model.rxnNames={};
0111 model.rxnComps=[];
0112 model.grRules={};
0113 model.rxnGeneMat=[];
0114 model.subSystems={};
0115 model.eccodes={};
0116 model.rxnMiriams={};
0117 model.rxnNotes={};
0118 model.rxnReferences={};
0119 model.rxnConfidenceScores=[];
0120 model.genes={};
0121 model.geneComps=[];
0122 model.geneMiriams={};
0123 model.geneShortNames={};
0124 model.proteinNames={};
0125 model.metNames={};
0126 model.metComps=[];
0127 model.inchis={};
0128 model.metFormulas={};
0129 model.metMiriams={};
0130 model.metCharges=[];
0131 model.unconstrained=[];
0132 
0133 <span class="comment">%Load the model using libSBML</span>
0134 fileName=<a href="checkFileExistence.html" class="code" title="function files=checkFileExistence(files,fullOrTemp,allowSpace,checkExist)">checkFileExistence</a>(fileName,1);
0135 [modelSBML,errorMsg] = TranslateSBML_RAVEN(fileName,0,0,[1 1]);
0136 
0137 <span class="keyword">if</span> isempty(modelSBML)
0138     EM=[<span class="string">'There is a problem with the SBML file. Try using the SBML Validator at http://sbml.org/Facilities/Validator.\nlibSBML reports: '</span>, errorMsg.message];
0139     dispEM(EM);
0140 <span class="keyword">end</span>
0141 
0142 <span class="comment">%Retrieve compartment names and IDs</span>
0143 compartmentNames=cell(numel(modelSBML.compartment),1);
0144 compartmentIDs=cell(numel(modelSBML.compartment),1);
0145 compartmentOutside=cell(numel(modelSBML.compartment),1);
0146 compartmentMiriams=cell(numel(modelSBML.compartment),1);
0147 
0148 <span class="keyword">if</span> isfield(modelSBML.compartment,<span class="string">'sboTerm'</span>) &amp;&amp; numel(unique([modelSBML.compartment.sboTerm])) == 1
0149     <span class="comment">%If all the SBO terms are identical, don't add them to compMiriams</span>
0150     modelSBML.compartment = rmfield(modelSBML.compartment,<span class="string">'sboTerm'</span>);
0151 <span class="keyword">end</span>
0152 
0153 <span class="keyword">for</span> i=1:numel(modelSBML.compartment)
0154     compartmentNames{i}=modelSBML.compartment(i).name;
0155     compartmentIDs{i}=modelSBML.compartment(i).id;
0156     <span class="keyword">if</span> isfield(modelSBML.compartment(i),<span class="string">'outside'</span>)
0157         <span class="keyword">if</span> ~isempty(modelSBML.compartment(i).outside)
0158             compartmentOutside{i}=modelSBML.compartment(i).outside;
0159         <span class="keyword">else</span>
0160             compartmentOutside{i}=<span class="string">''</span>;
0161         <span class="keyword">end</span>
0162     <span class="keyword">else</span>
0163         compartmentOutside{i}=[];
0164     <span class="keyword">end</span>
0165 
0166     <span class="keyword">if</span> isfield(modelSBML.compartment(i),<span class="string">'annotation'</span>)
0167         compartmentMiriams{i}=<a href="#_sub4" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.compartment(i).annotation);
0168     <span class="keyword">else</span>
0169         compartmentMiriams{i}=[];
0170     <span class="keyword">end</span>
0171 
0172     <span class="keyword">if</span> isfield(modelSBML.compartment(i),<span class="string">'sboTerm'</span>) &amp;&amp; ~(modelSBML.compartment(i).sboTerm==-1)
0173         compartmentMiriams{i} = <a href="#_sub5" class="code" title="subfunction miriam = addSBOtoMiriam(miriam,sboTerm)">addSBOtoMiriam</a>(compartmentMiriams{i},modelSBML.compartment(i).sboTerm);
0174     <span class="keyword">end</span>
0175 <span class="keyword">end</span>
0176 
0177 <span class="comment">%If there are no compartment names then use compartment id as name</span>
0178 <span class="keyword">if</span> all(cellfun(@isempty,compartmentNames))
0179     compartmentNames=compartmentIDs;
0180 <span class="keyword">end</span>
0181 
0182 <span class="comment">%Retrieve info on metabolites, genes, complexes</span>
0183 metaboliteNames={};
0184 metaboliteIDs={};
0185 metaboliteCompartments={};
0186 metaboliteUnconstrained=[];
0187 metaboliteFormula={};
0188 metaboliteInChI={};
0189 metaboliteMiriams={};
0190 metaboliteCharges=[];
0191 
0192 geneNames={};
0193 geneIDs={};
0194 geneMiriams={};
0195 geneShortNames={};
0196 proteinNames={};
0197 geneCompartments={};
0198 complexIDs={};
0199 complexNames={};
0200 
0201 <span class="comment">%If the file is not a COBRA Toolbox model. According to the format</span>
0202 <span class="comment">%specified in the yeast consensus model both metabolites and genes are a</span>
0203 <span class="comment">%type of 'species'. The metabolites have names starting with 'M_' and genes</span>
0204 <span class="comment">%with 'E_'</span>
0205 geneSBOs = [];
0206 metSBOs = [];
0207 <span class="comment">%Regex of compartment names, later to be used to remove from metabolite</span>
0208 <span class="comment">%names if present as suffix.</span>
0209 regexCompNames = [<span class="string">'\s?\[(('</span> strjoin({modelSBML.compartment.name},<span class="string">')|('</span>) <span class="string">'))\]$'</span>];
0210 <span class="keyword">for</span> i=1:numel(modelSBML.species)
0211     <span class="keyword">if</span> length(modelSBML.species(i).id)&gt;=2 &amp;&amp; strcmpi(modelSBML.species(i).id(1:2),<span class="string">'E_'</span>)
0212         geneNames{numel(geneNames)+1,1}=modelSBML.species(i).name;
0213 
0214         <span class="comment">%The &quot;E_&quot; is included in the ID. This is because it's only used</span>
0215         <span class="comment">%internally in this file and it makes the matching a little</span>
0216         <span class="comment">%smoother</span>
0217         geneIDs{numel(geneIDs)+1,1}=modelSBML.species(i).id;
0218         geneCompartments{numel(geneCompartments)+1,1}=modelSBML.species(i).compartment;
0219 
0220         <span class="comment">%Get Miriam structure</span>
0221         <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'annotation'</span>)
0222             <span class="comment">%Get Miriam info</span>
0223             geneMiriam=<a href="#_sub4" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.species(i).annotation);
0224             geneMiriams{numel(geneMiriams)+1,1}=geneMiriam;
0225         <span class="keyword">else</span>
0226             geneMiriams{numel(geneMiriams)+1,1}=[];
0227         <span class="keyword">end</span>
0228 
0229         <span class="comment">%Protein short names (for example ERG10) are saved as SHORT</span>
0230         <span class="comment">%NAME: NAME in the notes-section of metabolites for SBML Level</span>
0231         <span class="comment">%2 and as PROTEIN_ASSOCIATION for each reaction in SBML Level 2</span>
0232         <span class="comment">%COBRA Toolbox format. For now only the SHORT NAME is loaded</span>
0233         <span class="comment">%and no mapping takes place</span>
0234         <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'notes'</span>)
0235             geneShortNames{numel(geneShortNames)+1,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'SHORT NAME'</span>);
0236         <span class="keyword">else</span>
0237             geneShortNames{numel(geneShortNames)+1,1}=<span class="string">''</span>;
0238         <span class="keyword">end</span>
0239 
0240         <span class="comment">%Get SBO term</span>
0241         <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'sboTerm'</span>) &amp;&amp; ~(modelSBML.species(i).sboTerm==-1)
0242             geneSBOs(end+1,1) = modelSBML.species(i).sboTerm;
0243         <span class="keyword">end</span>
0244     <span class="keyword">elseif</span> length(modelSBML.species(i).id)&gt;=2 &amp;&amp; strcmpi(modelSBML.species(i).id(1:3),<span class="string">'Cx_'</span>)
0245         <span class="comment">%If it's a complex keep the ID and name</span>
0246         complexIDs=[complexIDs;modelSBML.species(i).id];
0247         complexNames=[complexNames;modelSBML.species(i).name];
0248     <span class="keyword">else</span>
0249         <span class="comment">%If it is not gene or complex, then it must be a metabolite</span>
0250         metaboliteNames{numel(metaboliteNames)+1,1}=modelSBML.species(i).name;
0251         metaboliteIDs{numel(metaboliteIDs)+1,1}=modelSBML.species(i).id;
0252         metaboliteCompartments{numel(metaboliteCompartments)+1,1}=modelSBML.species(i).compartment;
0253         metaboliteUnconstrained(numel(metaboliteUnconstrained)+1,1)=modelSBML.species(i).boundaryCondition;
0254 
0255         <span class="comment">%For each metabolite retrieve the formula and the InChI code if</span>
0256         <span class="comment">%available First add the InChI code and the formula from the</span>
0257         <span class="comment">%InChI. This allows for overwriting the formula by setting the</span>
0258         <span class="comment">%actual formula field</span>
0259         <span class="keyword">if</span> ~isempty(modelSBML.species(i).annotation)
0260             <span class="comment">%Get the formula if available</span>
0261             startString=<span class="string">'&gt;InChI='</span>;
0262             endString=<span class="string">'&lt;/in:inchi&gt;'</span>;
0263             formStart=strfind(modelSBML.species(i).annotation,startString);
0264             <span class="keyword">if</span> isempty(formStart)
0265                 startString=<span class="string">'InChI='</span>;
0266                 endString=<span class="string">'&quot;/&gt;'</span>;
0267             <span class="keyword">end</span>
0268             formStart=strfind(modelSBML.species(i).annotation,startString);
0269             <span class="keyword">if</span> ~isempty(formStart)
0270                 formEnd=strfind(modelSBML.species(i).annotation,endString);
0271                 formEndIndex=find(formEnd&gt;formStart, 1 );
0272                 formula=modelSBML.species(i).annotation(formStart+numel(startString):formEnd(formEndIndex)-1);
0273                 metaboliteInChI{numel(metaboliteInChI)+1,1}=formula;
0274 
0275                 <span class="comment">%The composition is most often present between the</span>
0276                 <span class="comment">%first and second &quot;/&quot; in the model. In some simple</span>
0277                 <span class="comment">%molecules, such as salts, there is no second &quot;/&quot;. The</span>
0278                 <span class="comment">%formula is then assumed to be to the end of the string</span>
0279                 compositionIndexes=strfind(formula,<span class="string">'/'</span>);
0280                 <span class="keyword">if</span> numel(compositionIndexes)&gt;1
0281                     metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="keyword">...</span>
0282                         formula(compositionIndexes(1)+1:compositionIndexes(2)-1);
0283                 <span class="keyword">else</span>
0284                     <span class="keyword">if</span> numel(compositionIndexes)==1
0285                         <span class="comment">%Probably a simple molecule which can have only</span>
0286                         <span class="comment">%one conformation</span>
0287                         metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="keyword">...</span>
0288                             formula(compositionIndexes(1)+1:numel(formula));
0289                     <span class="keyword">else</span>
0290                         metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0291                     <span class="keyword">end</span>
0292                 <span class="keyword">end</span>
0293             <span class="keyword">elseif</span> isfield(modelSBML.species(i),<span class="string">'fbc_chemicalFormula'</span>)
0294                 metaboliteInChI{numel(metaboliteInChI)+1,1}=<span class="string">''</span>;
0295                 <span class="keyword">if</span> ~isempty(modelSBML.species(i).fbc_chemicalFormula)
0296                     <span class="comment">%Cannot extract InChi from formula, so remains</span>
0297                     <span class="comment">%empty</span>
0298                     metaboliteFormula{numel(metaboliteFormula)+1,1}=modelSBML.species(i).fbc_chemicalFormula;
0299                 <span class="keyword">else</span>
0300                     metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0301                 <span class="keyword">end</span>
0302             <span class="keyword">else</span>
0303                 metaboliteInChI{numel(metaboliteInChI)+1,1}=<span class="string">''</span>;
0304                 metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0305             <span class="keyword">end</span>
0306 
0307             <span class="comment">%Get Miriam info</span>
0308             metMiriam=<a href="#_sub4" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.species(i).annotation);
0309             metaboliteMiriams{numel(metaboliteMiriams)+1,1}=metMiriam;
0310         <span class="keyword">else</span>
0311             metaboliteInChI{numel(metaboliteInChI)+1,1}=<span class="string">''</span>;
0312             <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'notes'</span>)
0313                 metaboliteFormula{numel(metaboliteFormula)+1,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'FORMULA'</span>);
0314             <span class="keyword">else</span>
0315                 metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0316             <span class="keyword">end</span>
0317             metaboliteMiriams{numel(metaboliteMiriams)+1,1}=[];
0318         <span class="keyword">end</span>
0319         <span class="keyword">if</span> ~isempty(modelSBML.species(i).notes)
0320             <span class="keyword">if</span> ~isfield(modelSBML.species(i),<span class="string">'annotation'</span>)
0321                 metaboliteFormula{numel(metaboliteFormula)+1,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'FORMULA'</span>);
0322             <span class="keyword">end</span>
0323         <span class="keyword">elseif</span> ~isfield(modelSBML.species(i),<span class="string">'annotation'</span>)
0324             metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0325         <span class="keyword">end</span>
0326         <span class="comment">%Get SBO term</span>
0327         <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'sboTerm'</span>) &amp;&amp; ~(modelSBML.species(i).sboTerm==-1)
0328             metSBOs(end+1,1) = modelSBML.species(i).sboTerm;
0329         <span class="keyword">end</span>
0330     <span class="keyword">end</span>
0331 
0332     <span class="comment">%The following lines are executed regardless isSBML2COBRA setting</span>
0333     <span class="keyword">if</span> isempty(modelSBML.species(i).id) || ~strcmpi(modelSBML.species(i).id(1:2),<span class="string">'E_'</span>)
0334         <span class="keyword">if</span> isempty(modelSBML.species(i).id) || ~strcmpi(modelSBML.species(i).id(1:3),<span class="string">'Cx_'</span>)
0335             <span class="comment">%Remove trailing [compartment] from metabolite name if present</span>
0336             metaboliteNames{<span class="keyword">end</span>,1}=regexprep(metaboliteNames{<span class="keyword">end</span>,1},regexCompNames,<span class="string">''</span>);
0337             metaboliteNames{<span class="keyword">end</span>,1}=metaboliteNames{<span class="keyword">end</span>,1};
0338             <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'fbc_charge'</span>)
0339                 <span class="keyword">if</span> ~isempty(modelSBML.species(i).fbc_charge) &amp;&amp; modelSBML.species(i).isSetfbc_charge
0340                     metaboliteCharges(numel(metaboliteCharges)+1,1)=double(modelSBML.species(i).fbc_charge);
0341                 <span class="keyword">else</span>
0342                     <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'notes'</span>)
0343                         <span class="keyword">if</span> strfind(modelSBML.species(i).notes,<span class="string">'CHARGE'</span>)
0344                             metaboliteCharges(numel(metaboliteCharges)+1,1)=str2double(<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'CHARGE'</span>));
0345                         <span class="keyword">else</span>
0346                             metaboliteCharges(numel(metaboliteCharges)+1,1)=NaN;
0347                         <span class="keyword">end</span>
0348                     <span class="keyword">else</span>
0349                         metaboliteCharges(numel(metaboliteCharges)+1,1)=NaN;
0350                     <span class="keyword">end</span>
0351                 <span class="keyword">end</span>
0352             <span class="keyword">elseif</span> isfield(modelSBML.species(i),<span class="string">'notes'</span>)
0353                 <span class="keyword">if</span> strfind(modelSBML.species(i).notes,<span class="string">'CHARGE'</span>)
0354                     metaboliteCharges(numel(metaboliteCharges)+1,1)=str2double(<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'CHARGE'</span>));
0355                 <span class="keyword">else</span>
0356                     metaboliteCharges(numel(metaboliteCharges)+1,1)=NaN;
0357                 <span class="keyword">end</span>
0358             <span class="keyword">else</span>
0359                 metaboliteCharges(numel(metaboliteCharges)+1,1)=NaN;
0360             <span class="keyword">end</span>
0361             <span class="comment">%Additional information from FBC format Chemical formula</span>
0362             <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'fbc_chemicalFormula'</span>)
0363                 <span class="keyword">if</span> ~isempty(modelSBML.species(i).fbc_chemicalFormula)
0364                     metaboliteFormula{numel(metaboliteFormula),1}=modelSBML.species(i).fbc_chemicalFormula;
0365                 <span class="keyword">end</span>
0366             <span class="keyword">end</span>
0367         <span class="keyword">end</span>
0368     <span class="keyword">end</span>
0369 <span class="keyword">end</span>
0370 
0371 <span class="comment">%Add SBO terms to gene and metabolite miriam fields</span>
0372 <span class="keyword">if</span> numel(unique(geneSBOs)) &gt; 1  <span class="comment">% don't add if they're all identical</span>
0373     <span class="keyword">for</span> i = 1:numel(geneNames)
0374         geneMiriams{i} = <a href="#_sub5" class="code" title="subfunction miriam = addSBOtoMiriam(miriam,sboTerm)">addSBOtoMiriam</a>(geneMiriams{i},geneSBOs(i));
0375     <span class="keyword">end</span>
0376 <span class="keyword">end</span>
0377 <span class="keyword">if</span> numel(unique(metSBOs)) &gt; 1
0378     <span class="keyword">for</span> i = 1:numel(metaboliteNames)
0379         metaboliteMiriams{i} = <a href="#_sub5" class="code" title="subfunction miriam = addSBOtoMiriam(miriam,sboTerm)">addSBOtoMiriam</a>(metaboliteMiriams{i},metSBOs(i));
0380     <span class="keyword">end</span>
0381 <span class="keyword">end</span>
0382 
0383 <span class="comment">%Retrieve info on reactions</span>
0384 reactionNames=cell(numel(modelSBML.reaction),1);
0385 reactionIDs=cell(numel(modelSBML.reaction),1);
0386 subsystems=cell(numel(modelSBML.reaction),1);
0387 eccodes=cell(numel(modelSBML.reaction),1);
0388 eccodes(:,:)=cellstr(<span class="string">''</span>);
0389 rxnconfidencescores=NaN(numel(modelSBML.reaction),1);
0390 rxnreferences=cell(numel(modelSBML.reaction),1);
0391 rxnreferences(:,:)=cellstr(<span class="string">''</span>);
0392 rxnnotes=cell(numel(modelSBML.reaction),1);
0393 rxnnotes(:,:)=cellstr(<span class="string">''</span>);
0394 grRules=cell(numel(modelSBML.reaction),1);
0395 grRules(:,:)=cellstr(<span class="string">''</span>);
0396 grRulesFromModifier=grRules;
0397 rxnComps=zeros(numel(modelSBML.reaction),1);
0398 rxnMiriams=cell(numel(modelSBML.reaction),1);
0399 reactionReversibility=zeros(numel(modelSBML.reaction),1);
0400 reactionUB=zeros(numel(modelSBML.reaction),1);
0401 reactionLB=zeros(numel(modelSBML.reaction),1);
0402 reactionObjective=zeros(numel(modelSBML.reaction),1);
0403 
0404 <span class="comment">%Construct the stoichiometric matrix while the reaction info is read</span>
0405 S=zeros(numel(metaboliteIDs),numel(modelSBML.reaction));
0406 
0407 counter=0;
0408 <span class="comment">%If FBC, then bounds have parameter ids defined for the whole model</span>
0409 <span class="keyword">if</span> isfield(modelSBML,<span class="string">'parameter'</span>)
0410     parameter.name=cell(numel(modelSBML.parameter),1);
0411     parameter.name={modelSBML.parameter(:).id}';
0412     parameter.value={modelSBML.parameter(:).value}';
0413 <span class="keyword">end</span>
0414 
0415 <span class="keyword">if</span> isfield(modelSBML.reaction,<span class="string">'sboTerm'</span>) &amp;&amp; numel(unique([modelSBML.reaction.sboTerm])) == 1
0416     <span class="comment">%If all the SBO terms are identical, don't add them to rxnMiriams</span>
0417     modelSBML.reaction = rmfield(modelSBML.reaction,<span class="string">'sboTerm'</span>);
0418 <span class="keyword">end</span>
0419 
0420 <span class="keyword">for</span> i=1:numel(modelSBML.reaction)
0421 
0422     <span class="comment">%Check that the reaction doesn't produce a complex and nothing else. If</span>
0423     <span class="comment">%so, then jump to the next reaction. This is because I get the genes</span>
0424     <span class="comment">%for complexes from the names and not from the reactions that create</span>
0425     <span class="comment">%them. This only applies to the non-COBRA format</span>
0426     <span class="keyword">if</span> numel(modelSBML.reaction(i).product)==1
0427         <span class="keyword">if</span> length(modelSBML.reaction(i).product(1).species)&gt;=3
0428             <span class="keyword">if</span> strcmp(modelSBML.reaction(i).product(1).species(1:3),<span class="string">'Cx_'</span>)==true
0429                 <span class="keyword">continue</span>;
0430             <span class="keyword">end</span>
0431         <span class="keyword">end</span>
0432     <span class="keyword">end</span>
0433 
0434     <span class="comment">%It didn't look like a gene complex-forming reaction</span>
0435     counter=counter+1;
0436 
0437     reactionNames{counter}=modelSBML.reaction(i).name;
0438 
0439     reactionIDs{counter}=modelSBML.reaction(i).id;
0440     reactionReversibility(counter)=modelSBML.reaction(i).reversible;
0441 
0442     <span class="comment">%If model is FBC, first get parameter of bound and then replace it with</span>
0443     <span class="comment">%the correct value. Probably faster with replace(), but this was only</span>
0444     <span class="comment">%introduced in Matlab R2016b</span>
0445     <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'fbc_lowerFluxBound'</span>)
0446         lb=modelSBML.reaction(i).fbc_lowerFluxBound;
0447         ub=modelSBML.reaction(i).fbc_upperFluxBound;
0448         <span class="keyword">for</span> n=1:numel(parameter.value)
0449             lb=regexprep(lb,parameter.name(n),num2str(parameter.value{n}));
0450             ub=regexprep(ub,parameter.name(n),num2str(parameter.value{n}));
0451         <span class="keyword">end</span>
0452         <span class="keyword">if</span> isempty(lb)
0453             lb=<span class="string">'-Inf'</span>;
0454         <span class="keyword">end</span>
0455         <span class="keyword">if</span> isempty(ub)
0456             ub=<span class="string">'Inf'</span>;
0457         <span class="keyword">end</span>
0458         reactionLB(counter)=str2num(lb);
0459         reactionUB(counter)=str2num(ub);
0460         <span class="comment">%The order of these parameters should not be hard coded</span>
0461     <span class="keyword">elseif</span> isfield(modelSBML.reaction(i).kineticLaw,<span class="string">'parameter'</span>)
0462         reactionLB(counter)=modelSBML.reaction(i).kineticLaw.parameter(1).value;
0463         reactionUB(counter)=modelSBML.reaction(i).kineticLaw.parameter(2).value;
0464         reactionObjective(counter)=modelSBML.reaction(i).kineticLaw.parameter(3).value;
0465     <span class="keyword">else</span>
0466         <span class="keyword">if</span> reactionReversibility(counter)==true
0467             reactionLB(counter)=-inf;
0468         <span class="keyword">else</span>
0469             reactionLB(counter)=0;
0470         <span class="keyword">end</span>
0471         reactionUB(counter)=inf;
0472         reactionObjective(counter)=0;
0473     <span class="keyword">end</span>
0474 
0475     <span class="comment">%Find the associated gene if available</span>
0476     <span class="comment">%If FBC, get gene association data from corresponding fields</span>
0477     <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'fbc_geneProductAssociation'</span>)
0478         <span class="keyword">if</span> ~isempty(modelSBML.reaction(i).fbc_geneProductAssociation) &amp;&amp; ~isempty(modelSBML.reaction(i).fbc_geneProductAssociation.fbc_association)
0479             grRules{counter}=modelSBML.reaction(i).fbc_geneProductAssociation.fbc_association.fbc_association;
0480         <span class="keyword">end</span>
0481     <span class="keyword">elseif</span> isfield(modelSBML.reaction(i),<span class="string">'notes'</span>)
0482         <span class="comment">%This section was previously executed only if isSBML2COBRA is true. Now</span>
0483         <span class="comment">%it will be executed, if 'GENE_ASSOCIATION' is found in</span>
0484         <span class="comment">%modelSBML.reaction(i).notes</span>
0485         <span class="keyword">if</span> strfind(modelSBML.reaction(i).notes,<span class="string">'GENE_ASSOCIATION'</span>)
0486             geneAssociation=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'GENE_ASSOCIATION'</span>);
0487         <span class="keyword">elseif</span> strfind(modelSBML.reaction(i).notes,<span class="string">'GENE ASSOCIATION'</span>)
0488             geneAssociation=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'GENE ASSOCIATION'</span>);
0489         <span class="keyword">else</span>
0490             geneAssociation=<span class="string">''</span>;
0491         <span class="keyword">end</span>
0492         <span class="keyword">if</span> ~isempty(geneAssociation)
0493             <span class="comment">%This adds the grRules. The gene list and rxnGeneMat are created</span>
0494             <span class="comment">%later</span>
0495             grRules{counter}=geneAssociation;
0496         <span class="keyword">end</span>
0497     <span class="keyword">end</span>
0498     <span class="keyword">if</span> isempty(grRules{counter}) &amp;&amp; ~isempty(modelSBML.reaction(i).modifier)
0499         rules=<span class="string">''</span>;
0500         <span class="keyword">for</span> j=1:numel(modelSBML.reaction(i).modifier)
0501             modifier=modelSBML.reaction(i).modifier(j).species;
0502             <span class="keyword">if</span> ~isempty(modifier)
0503                 <span class="keyword">if</span> strcmpi(modifier(1:2),<span class="string">'E_'</span>)
0504                     index=find(strcmp(modifier,geneIDs));
0505                     <span class="comment">%This should be unique and in the geneIDs list,</span>
0506                     <span class="comment">%otherwise something is wrong</span>
0507                     <span class="keyword">if</span> numel(index)~=1
0508                         EM=[<span class="string">'Could not get the gene association data from reaction '</span> reactionIDs{i}];
0509                         dispEM(EM);
0510                     <span class="keyword">end</span>
0511                     <span class="keyword">if</span> ~isempty(rules)
0512                         rules=[rules <span class="string">' or ('</span> geneNames{index} <span class="string">')'</span>];
0513                     <span class="keyword">else</span>
0514                         rules=[<span class="string">'('</span> geneNames{index} <span class="string">')'</span>];
0515                     <span class="keyword">end</span>
0516                 <span class="keyword">elseif</span> strcmp(modifier(1:2),<span class="string">'s_'</span>)
0517                     index=find(strcmp(modifier,metaboliteIDs));
0518                     <span class="comment">%This should be unique and in the geneIDs list,</span>
0519                     <span class="comment">%otherwise something is wrong</span>
0520                     <span class="keyword">if</span> numel(index)~=1
0521                         EM=[<span class="string">'Could not get the gene association data from reaction '</span> reactionIDs{i}];
0522                         dispEM(EM);
0523                     <span class="keyword">end</span>
0524                     <span class="keyword">if</span> ~isempty(rules)
0525                         rules=[rules <span class="string">' or ('</span> metaboliteIDs{index} <span class="string">')'</span>];
0526                     <span class="keyword">else</span>
0527                         rules=[<span class="string">'('</span> metaboliteIDs{index} <span class="string">')'</span>];
0528                     <span class="keyword">end</span>
0529                 <span class="keyword">else</span>
0530                     <span class="comment">%It seems to be a complex. Add the corresponding</span>
0531                     <span class="comment">%genes from the name of the complex (not the</span>
0532                     <span class="comment">%reaction that creates it)</span>
0533                     index=find(strcmp(modifier,complexIDs));
0534                     <span class="keyword">if</span> numel(index)==1
0535                         <span class="keyword">if</span> ~isempty(rules)
0536                             rules=[rules <span class="string">' or ('</span> strrep(complexNames{index},<span class="string">':'</span>,<span class="string">' and '</span>) <span class="string">')'</span>];
0537                         <span class="keyword">else</span>
0538                             rules=[<span class="string">'('</span> strrep(complexNames{index},<span class="string">':'</span>,<span class="string">' and '</span>) <span class="string">')'</span>];
0539                         <span class="keyword">end</span>
0540                     <span class="keyword">else</span>
0541                         <span class="comment">%Could not find a complex</span>
0542                         EM=[<span class="string">'Could not get the gene association data from reaction '</span> reactionIDs{i}];
0543                         dispEM(EM);
0544                     <span class="keyword">end</span>
0545                 <span class="keyword">end</span>
0546             <span class="keyword">end</span>
0547         <span class="keyword">end</span>
0548         grRules{counter}=rules;
0549         grRulesFromModifier{counter}=rules;<span class="comment">%Backup copy for grRules, useful to parse Yeast 7.6</span>
0550     <span class="keyword">end</span>
0551 
0552     <span class="comment">%Add reaction compartment</span>
0553     <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'compartment'</span>)
0554         <span class="keyword">if</span> ~isempty(modelSBML.reaction(i).compartment)
0555             rxnComp=modelSBML.reaction(i).compartment;
0556         <span class="keyword">else</span>
0557             rxnComp=<span class="string">''</span>;
0558         <span class="keyword">end</span>
0559     <span class="keyword">elseif</span> isfield(modelSBML.reaction(i),<span class="string">'notes'</span>)
0560         rxnComp=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'COMPARTMENT'</span>);
0561     <span class="keyword">end</span>
0562     <span class="keyword">if</span> ~isempty(rxnComp)
0563         <span class="comment">%Find it in the compartment list</span>
0564         [~, J]=ismember(rxnComp,compartmentIDs);
0565         rxnComps(counter)=J;
0566     <span class="keyword">end</span>
0567 
0568 
0569     miriamStruct=<a href="#_sub4" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.reaction(i).annotation);
0570     rxnMiriams{counter}=miriamStruct;
0571     <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'notes'</span>)
0572         subsystems{counter,1}=cellstr(<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'SUBSYSTEM'</span>));
0573         subsystems{counter,1}(cellfun(<span class="string">'isempty'</span>,subsystems{counter,1})) = [];
0574         <span class="keyword">if</span> strfind(modelSBML.reaction(i).notes,<span class="string">'Confidence Level'</span>)
0575             confScore = <a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'Confidence Level'</span>);
0576             <span class="keyword">if</span> isempty(confScore)
0577                 confScore = 0;
0578             <span class="keyword">end</span>
0579             rxnconfidencescores(counter)=str2double(confScore);
0580         <span class="keyword">end</span>
0581         rxnreferences{counter,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'AUTHORS'</span>);
0582         rxnnotes{counter,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'NOTES'</span>);
0583     <span class="keyword">end</span>
0584 
0585     <span class="comment">%Get SBO terms</span>
0586     <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'sboTerm'</span>) &amp;&amp; ~(modelSBML.reaction(i).sboTerm==-1)
0587         rxnMiriams{counter} = <a href="#_sub5" class="code" title="subfunction miriam = addSBOtoMiriam(miriam,sboTerm)">addSBOtoMiriam</a>(rxnMiriams{counter}, modelSBML.reaction(i).sboTerm);
0588     <span class="keyword">end</span>
0589 
0590     <span class="comment">%Get ec-codes</span>
0591     eccode=<span class="string">''</span>;
0592     <span class="keyword">if</span> ~isempty(modelSBML.reaction(i).annotation)
0593         <span class="keyword">if</span> strfind(modelSBML.reaction(i).annotation,<span class="string">'urn:miriam:ec-code'</span>)
0594             eccode=<a href="#_sub3" class="code" title="subfunction fieldContent=parseAnnotation(searchString,startString,midString,fieldName)">parseAnnotation</a>(modelSBML.reaction(i).annotation,<span class="string">'urn:miriam:'</span>,<span class="string">':'</span>,<span class="string">'ec-code'</span>);
0595         <span class="keyword">elseif</span> strfind(modelSBML.reaction(i).annotation,<span class="string">'http://identifiers.org/ec-code'</span>)
0596             eccode=<a href="#_sub3" class="code" title="subfunction fieldContent=parseAnnotation(searchString,startString,midString,fieldName)">parseAnnotation</a>(modelSBML.reaction(i).annotation,<span class="string">'http://identifiers.org/'</span>,<span class="string">'/'</span>,<span class="string">'ec-code'</span>);
0597         <span class="keyword">elseif</span> strfind(modelSBML.reaction(i).annotation,<span class="string">'https://identifiers.org/ec-code'</span>)
0598             eccode=<a href="#_sub3" class="code" title="subfunction fieldContent=parseAnnotation(searchString,startString,midString,fieldName)">parseAnnotation</a>(modelSBML.reaction(i).annotation,<span class="string">'https://identifiers.org/'</span>,<span class="string">'/'</span>,<span class="string">'ec-code'</span>);
0599         <span class="keyword">end</span>
0600     <span class="keyword">elseif</span> isfield(modelSBML.reaction(i),<span class="string">'notes'</span>)
0601         <span class="keyword">if</span> strfind(modelSBML.reaction(i).notes,<span class="string">'EC Number'</span>)
0602             eccode=[eccode <a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'EC Number'</span>)];
0603         <span class="keyword">elseif</span> strfind(modelSBML.reaction(i).notes,<span class="string">'PROTEIN_CLASS'</span>)
0604             eccode=[eccode <a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'PROTEIN_CLASS'</span>)];
0605         <span class="keyword">end</span>
0606     <span class="keyword">end</span>
0607     eccodes{counter}=eccode;
0608 
0609     <span class="comment">%Add all reactants</span>
0610     <span class="keyword">for</span> j=1:numel(modelSBML.reaction(i).reactant)
0611         <span class="comment">%Get the index of the metabolite in metaboliteIDs. External</span>
0612         <span class="comment">%metabolites will be removed at a later stage</span>
0613         metIndex=find(strcmp(modelSBML.reaction(i).reactant(j).species,metaboliteIDs),1);
0614         <span class="keyword">if</span> isempty(metIndex)
0615             EM=[<span class="string">'Could not find metabolite '</span> modelSBML.reaction(i).reactant(j).species <span class="string">' in reaction '</span> reactionIDs{counter}];
0616             dispEM(EM);
0617         <span class="keyword">end</span>
0618         S(metIndex,counter)=S(metIndex,counter)+modelSBML.reaction(i).reactant(j).stoichiometry*-1;
0619     <span class="keyword">end</span>
0620 
0621     <span class="comment">%Add all products</span>
0622     <span class="keyword">for</span> j=1:numel(modelSBML.reaction(i).product)
0623         <span class="comment">%Get the index of the metabolite in metaboliteIDs.</span>
0624         metIndex=find(strcmp(modelSBML.reaction(i).product(j).species,metaboliteIDs),1);
0625         <span class="keyword">if</span> isempty(metIndex)
0626             EM=[<span class="string">'Could not find metabolite '</span> modelSBML.reaction(i).product(j).species <span class="string">' in reaction '</span> reactionIDs{counter}];
0627             dispEM(EM);
0628         <span class="keyword">end</span>
0629         S(metIndex,counter)=S(metIndex,counter)+modelSBML.reaction(i).product(j).stoichiometry;
0630     <span class="keyword">end</span>
0631 <span class="keyword">end</span>
0632 
0633 <span class="comment">%if FBC, objective function is separately defined. Multiple objective</span>
0634 <span class="comment">%functions can be defined, one is set as active</span>
0635 <span class="keyword">if</span> isfield(modelSBML, <span class="string">'fbc_activeObjective'</span>)
0636     obj=modelSBML.fbc_activeObjective;
0637     <span class="keyword">for</span> i=1:numel(modelSBML.fbc_objective)
0638         <span class="keyword">if</span> strcmp(obj,modelSBML.fbc_objective(i).fbc_id)
0639             <span class="keyword">if</span> ~isempty(modelSBML.fbc_objective(i).fbc_fluxObjective)
0640                 rxn=modelSBML.fbc_objective(i).fbc_fluxObjective.fbc_reaction;
0641                 idx=find(ismember(reactionIDs,rxn));
0642                 reactionObjective(idx)=modelSBML.fbc_objective(i).fbc_fluxObjective.fbc_coefficient;
0643             <span class="keyword">end</span>
0644         <span class="keyword">end</span>
0645     <span class="keyword">end</span>
0646 <span class="keyword">end</span>
0647 
0648 <span class="comment">%subSystems can be stored as groups instead of in annotations</span>
0649 <span class="keyword">if</span> isfield(modelSBML,<span class="string">'groups_group'</span>)
0650     <span class="keyword">for</span> i=1:numel(modelSBML.groups_group)
0651         groupreactions={modelSBML.groups_group(i).groups_member(:).groups_idRef};
0652         [~, idx] = ismember(groupreactions, reactionIDs);
0653         <span class="keyword">if</span> any(idx)
0654             <span class="keyword">for</span> j=1:numel(idx)
0655                 <span class="keyword">if</span> isempty(subsystems{idx(j)}) <span class="comment">% First subsystem</span>
0656                     subsystems{idx(j)} = {modelSBML.groups_group(i).groups_name};
0657                 <span class="keyword">else</span> <span class="comment">% Consecutive subsystems: concatenate</span>
0658                     subsystems{idx(j)} = horzcat(subsystems{idx(j)}, modelSBML.groups_group(i).groups_name);
0659                 <span class="keyword">end</span>
0660             <span class="keyword">end</span>
0661         <span class="keyword">end</span>
0662     <span class="keyword">end</span>
0663 <span class="keyword">end</span>
0664 
0665 <span class="comment">%Shrink the structures if complex-forming reactions had to be skipped</span>
0666 reactionNames=reactionNames(1:counter);
0667 reactionIDs=reactionIDs(1:counter);
0668 subsystems=subsystems(1:counter);
0669 eccodes=eccodes(1:counter);
0670 rxnconfidencescores=rxnconfidencescores(1:counter);
0671 rxnreferences=rxnreferences(1:counter);
0672 rxnnotes=rxnnotes(1:counter);
0673 grRules=grRules(1:counter);
0674 rxnMiriams=rxnMiriams(1:counter);
0675 reactionReversibility=reactionReversibility(1:counter);
0676 reactionUB=reactionUB(1:counter);
0677 reactionLB=reactionLB(1:counter);
0678 reactionObjective=reactionObjective(1:counter);
0679 S=S(:,1:counter);
0680 
0681 model.name=modelSBML.name;
0682 model.id=modelSBML.id;
0683 model.rxns=reactionIDs;
0684 model.mets=metaboliteIDs;
0685 model.S=sparse(S);
0686 model.lb=reactionLB;
0687 model.ub=reactionUB;
0688 model.rev=reactionReversibility;
0689 model.c=reactionObjective;
0690 model.b=zeros(numel(metaboliteIDs),1);
0691 model.comps=compartmentIDs;
0692 model.compNames=compartmentNames;
0693 model.rxnConfidenceScores=rxnconfidencescores;
0694 model.rxnReferences=rxnreferences;
0695 model.rxnNotes=rxnnotes;
0696 
0697 <span class="comment">%Load annotation if available. If there are several authors, only the first</span>
0698 <span class="comment">%author credentials are imported</span>
0699 <span class="keyword">if</span> isfield(modelSBML,<span class="string">'annotation'</span>)
0700     endString=<span class="string">'&lt;/'</span>;
0701     I=strfind(modelSBML.annotation,endString);
0702     J=strfind(modelSBML.annotation,<span class="string">'&lt;vCard:Family&gt;'</span>);
0703     <span class="keyword">if</span> any(J)
0704         model.annotation.familyName=modelSBML.annotation(J(1)+14:I(find(I&gt;J(1),1))-1);
0705     <span class="keyword">end</span>
0706     J=strfind(modelSBML.annotation,<span class="string">'&lt;vCard:Given&gt;'</span>);
0707     <span class="keyword">if</span> any(J)
0708         model.annotation.givenName=modelSBML.annotation(J(1)+13:I(find(I&gt;J(1),1))-1);
0709     <span class="keyword">end</span>
0710     J=strfind(modelSBML.annotation,<span class="string">'&lt;vCard:EMAIL&gt;'</span>);
0711     <span class="keyword">if</span> any(J)
0712         model.annotation.email=modelSBML.annotation(J(1)+13:I(find(I&gt;J(1),1))-1);
0713     <span class="keyword">end</span>
0714     J=strfind(modelSBML.annotation,<span class="string">'&lt;vCard:Orgname&gt;'</span>);
0715     <span class="keyword">if</span> any(J)
0716         model.annotation.organization=modelSBML.annotation(J(1)+15:I(find(I&gt;J(1),1))-1);
0717     <span class="keyword">end</span>
0718     endString=<span class="string">'&quot;/&gt;'</span>;
0719     I=strfind(modelSBML.annotation,endString);
0720     <span class="keyword">if</span> strfind(modelSBML.annotation,<span class="string">'&quot;urn:miriam:'</span>)
0721         J=strfind(modelSBML.annotation,<span class="string">'&quot;urn:miriam:'</span>);
0722         <span class="keyword">if</span> any(J)
0723             model.annotation.taxonomy=modelSBML.annotation(J+12:I(find(I&gt;J,1))-1);
0724         <span class="keyword">end</span>
0725     <span class="keyword">else</span>
0726         J=strfind(modelSBML.annotation,<span class="string">'&quot;http://identifiers.org/'</span>);
0727         <span class="keyword">if</span> any(J)
0728             model.annotation.taxonomy=modelSBML.annotation(J+24:I(find(I&gt;J,1))-1);
0729         <span class="keyword">else</span>
0730             J=strfind(modelSBML.annotation,<span class="string">'&quot;https://identifiers.org/'</span>);
0731             <span class="keyword">if</span> any(J)
0732                 model.annotation.taxonomy=modelSBML.annotation(J+25:I(find(I&gt;J,1))-1);
0733             <span class="keyword">end</span>
0734         <span class="keyword">end</span>
0735     <span class="keyword">end</span>
0736 <span class="keyword">end</span>
0737 <span class="keyword">if</span> isfield(modelSBML,<span class="string">'notes'</span>)
0738     startString=strfind(modelSBML.notes,<span class="string">'xhtml&quot;&gt;'</span>);
0739     endString=strfind(modelSBML.notes,<span class="string">'&lt;/body&gt;'</span>);
0740     <span class="keyword">if</span> any(startString) &amp;&amp; any(endString)
0741         model.annotation.note=modelSBML.notes(startString+7:endString-1);
0742         model.annotation.note=regexprep(model.annotation.note,<span class="string">'&lt;p&gt;|&lt;/p&gt;'</span>,<span class="string">''</span>);
0743         model.annotation.note=strtrim(model.annotation.note);
0744         <span class="keyword">if</span> regexp(model.annotation.note,<span class="string">'This file was generated using the exportModel function in RAVEN Toolbox \d\.\d and OutputSBML in libSBML'</span>)
0745             model.annotation=rmfield(model.annotation,<span class="string">'note'</span>); <span class="comment">% Default note added when running exportModel</span>
0746         <span class="keyword">end</span>
0747     <span class="keyword">end</span>
0748 <span class="keyword">end</span>
0749 
0750 <span class="keyword">if</span> any(~cellfun(@isempty,compartmentOutside))
0751     model.compOutside=compartmentOutside;
0752 <span class="keyword">end</span>
0753 
0754 model.rxnNames=reactionNames;
0755 model.metNames=metaboliteNames;
0756 
0757 <span class="comment">%Match the compartments for metabolites</span>
0758 [~, J]=ismember(metaboliteCompartments,model.comps);
0759 model.metComps=J;
0760 
0761 <span class="comment">%If any genes have been loaded (only for the new format)</span>
0762 <span class="keyword">if</span> ~isempty(geneNames)
0763     <span class="comment">%In some rare cases geneNames may not necessarily be used in grRules.</span>
0764     <span class="comment">%That is true for Yeast 7.6. It's therefore important to change gene</span>
0765     <span class="comment">%systematic names to geneIDs in sophisticated way. Gene systematic</span>
0766     <span class="comment">%names are not unique, since exactly the same name may be in different</span>
0767     <span class="comment">%compartments</span>
0768     <span class="keyword">if</span> all(cellfun(@isempty,strfind(grRules,geneNames{1})))
0769         geneShortNames=geneNames;
0770         <span class="comment">%geneShortNames contain compartments as well, so these are removed</span>
0771         geneShortNames=regexprep(geneShortNames,<span class="string">' \[.+$'</span>,<span class="string">''</span>);
0772         <span class="comment">%grRules obtained from modifier fields contain geneNames. These are</span>
0773         <span class="comment">%changed into geneIDs. grRulesFromModifier is a good way to have</span>
0774         <span class="comment">%geneIDs and rxns association when it's important to resolve</span>
0775         <span class="comment">%systematic name ambiguities</span>
0776         grRulesFromModifier=regexprep(regexprep(grRulesFromModifier,<span class="string">'\[|\]'</span>,<span class="string">'_'</span>),regexprep(geneNames,<span class="string">'\[|\]'</span>,<span class="string">'_'</span>),geneIDs);
0777         grRules=regexprep(regexprep(grRules,<span class="string">'\[|\]'</span>,<span class="string">'_'</span>),regexprep(geneNames,<span class="string">'\[|\]'</span>,<span class="string">'_'</span>),geneIDs);
0778 
0779         <span class="comment">%Yeast 7.6 contains several metabolites, which were used in gene</span>
0780         <span class="comment">%associations. For that reason, the list of species ID is created</span>
0781         <span class="comment">%and we then check whether any of them have kegg.genes annotation</span>
0782         <span class="comment">%thereby obtaining systematic gene names</span>
0783         geneShortNames=vertcat(geneShortNames,metaboliteNames);
0784         geneIDs=vertcat(geneIDs,metaboliteIDs);
0785         geneSystNames=extractMiriam(vertcat(geneMiriams,metaboliteMiriams),<span class="string">'kegg.genes'</span>);
0786         geneCompartments=vertcat(geneCompartments,metaboliteCompartments);
0787         geneMiriams=vertcat(geneMiriams,metaboliteMiriams);
0788 
0789         <span class="comment">%Now we retain information for only these entries, which have</span>
0790         <span class="comment">%kegg.genes annotation</span>
0791         geneShortNames=geneShortNames(~cellfun(<span class="string">'isempty'</span>,geneSystNames));
0792         geneIDs=geneIDs(~cellfun(<span class="string">'isempty'</span>,geneSystNames));
0793         geneSystNames=geneSystNames(~cellfun(<span class="string">'isempty'</span>,geneSystNames));
0794         geneCompartments=geneCompartments(~cellfun(<span class="string">'isempty'</span>,geneSystNames));
0795         geneMiriams=geneMiriams(~cellfun(<span class="string">'isempty'</span>,geneSystNames));
0796         <span class="comment">%Now we reorder geneIDs and geneSystNames by geneSystNames string</span>
0797         <span class="comment">%length</span>
0798         geneNames=geneIDs;<span class="comment">%Backuping geneIDs, since we need unsorted order for later</span>
0799         [~, Indx] = sort(cellfun(<span class="string">'size'</span>, geneSystNames, 2), <span class="string">'descend'</span>);
0800         geneIDs = geneIDs(Indx);
0801         geneSystNames = geneSystNames(Indx);
0802         <span class="keyword">for</span> i=1:numel(geneSystNames)
0803             <span class="keyword">for</span> j=1:numel(grRules)
0804                 <span class="keyword">if</span> strfind(grRules{j},geneSystNames{i})
0805                     <span class="keyword">if</span> ~isempty(grRules{j})
0806                         <span class="keyword">if</span> sum(ismember(geneSystNames,geneSystNames{i}))==1
0807                             grRules{j}=regexprep(grRules{j},geneSystNames{i},geneIDs{i});
0808                         <span class="keyword">elseif</span> sum(ismember(geneSystNames,geneSystNames{i}))&gt;1
0809                             counter=0;
0810                             ovrlpIDs=geneIDs(ismember(geneSystNames,geneSystNames{i}));
0811                             <span class="keyword">for</span> k=1:numel(ovrlpIDs)
0812                                 <span class="keyword">if</span> strfind(grRulesFromModifier{j},ovrlpIDs{k})
0813                                     counter=counter+1;
0814                                     grRules{j}=regexprep(grRules{j},geneSystNames{i},ovrlpIDs{k});
0815                                 <span class="keyword">end</span>
0816                                 <span class="keyword">if</span> counter&gt;1
0817                                     EM=[<span class="string">'Gene association is ambiguous for reaction '</span> modelSBML.reaction(j).id];
0818                                     dispEM(EM);
0819                                 <span class="keyword">end</span>
0820                             <span class="keyword">end</span>
0821                         <span class="keyword">end</span>
0822                     <span class="keyword">end</span>
0823                 <span class="keyword">end</span>
0824             <span class="keyword">end</span>
0825         <span class="keyword">end</span>
0826     <span class="keyword">end</span>
0827     model.genes=geneNames;
0828     model.grRules=grRules;
0829     [grRules,rxnGeneMat] = standardizeGrRules(model,true);
0830     model.grRules = grRules;
0831     model.rxnGeneMat = rxnGeneMat;
0832 
0833     <span class="comment">%Match the compartments for genes</span>
0834     [~, J]=ismember(geneCompartments,model.comps);
0835     model.geneComps=J;
0836 <span class="keyword">else</span>
0837     <span class="keyword">if</span> ~all(cellfun(@isempty,grRules))
0838         <span class="comment">%If fbc_geneProduct exists, follow the specified gene order, such</span>
0839         <span class="comment">%that matching geneShortNames in function below will work</span>
0840         <span class="keyword">if</span> isfield(modelSBML,<span class="string">'fbc_geneProduct'</span>)
0841             genes={modelSBML.fbc_geneProduct.fbc_id};
0842 
0843             <span class="comment">%Get gene Miriams if they were not retrieved above (this occurs</span>
0844             <span class="comment">%when genes are stored as fbc_geneProduct instead of species)</span>
0845             <span class="keyword">if</span> isempty(geneMiriams)
0846                 geneMiriams = cell(numel(genes),1);
0847                 <span class="keyword">if</span> isfield(modelSBML.fbc_geneProduct,<span class="string">'sboTerm'</span>) &amp;&amp; numel(unique([modelSBML.fbc_geneProduct.sboTerm])) == 1
0848                     <span class="comment">%If all the SBO terms are identical, don't add them to geneMiriams</span>
0849                     modelSBML.fbc_geneProduct = rmfield(modelSBML.fbc_geneProduct,<span class="string">'sboTerm'</span>);
0850                 <span class="keyword">end</span>
0851                 <span class="keyword">for</span> i = 1:numel(genes)
0852                     geneMiriams{i}=<a href="#_sub4" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.fbc_geneProduct(i).annotation);
0853                     <span class="keyword">if</span> isfield(modelSBML.fbc_geneProduct(i),<span class="string">'sboTerm'</span>) &amp;&amp; ~(modelSBML.fbc_geneProduct(i).sboTerm==-1)
0854                         geneMiriams{i} = <a href="#_sub5" class="code" title="subfunction miriam = addSBOtoMiriam(miriam,sboTerm)">addSBOtoMiriam</a>(geneMiriams{i},modelSBML.fbc_geneProduct(i).sboTerm);
0855                     <span class="keyword">end</span>
0856                 <span class="keyword">end</span>
0857             <span class="keyword">end</span>
0858             proteinNames={modelSBML.fbc_geneProduct.fbc_name};
0859         <span class="keyword">else</span>
0860             genes=<a href="#_sub1" class="code" title="subfunction matchGenes=getGeneList(grRules)">getGeneList</a>(grRules);
0861         <span class="keyword">end</span>
0862         model.genes=genes;
0863         model.grRules=grRules;
0864         [grRules,rxnGeneMat] = standardizeGrRules(model,true);
0865         model.grRules = grRules;
0866         model.rxnGeneMat = rxnGeneMat;
0867     <span class="keyword">end</span>
0868 <span class="keyword">end</span>
0869 
0870 <span class="keyword">if</span> all(cellfun(@isempty,geneShortNames))
0871     <span class="keyword">if</span> isfield(modelSBML,<span class="string">'fbc_geneProduct'</span>)
0872         <span class="keyword">for</span> i=1:numel(genes)
0873             <span class="keyword">if</span> ~isempty(modelSBML.fbc_geneProduct(i).fbc_label)
0874                 geneShortNames{i,1}=modelSBML.fbc_geneProduct(i).fbc_label;
0875             <span class="keyword">elseif</span> ~isempty(modelSBML.fbc_geneProduct(i).fbc_name)
0876                 geneShortNames{i,1}=modelSBML.fbc_geneProduct(i).fbc_name;
0877             <span class="keyword">else</span>
0878                 geneShortNames{i,1}=<span class="string">''</span>;
0879             <span class="keyword">end</span>
0880         <span class="keyword">end</span>
0881     <span class="keyword">end</span>
0882 <span class="keyword">end</span>
0883 
0884 <span class="comment">%If any InChIs have been loaded</span>
0885 <span class="keyword">if</span> any(~cellfun(@isempty,metaboliteInChI))
0886     model.inchis=metaboliteInChI;
0887 <span class="keyword">end</span>
0888 
0889 <span class="comment">%If any formulas have been loaded</span>
0890 <span class="keyword">if</span> any(~cellfun(@isempty,metaboliteFormula))
0891     model.metFormulas=metaboliteFormula;
0892 <span class="keyword">end</span>
0893 
0894 <span class="comment">%If any charges have been loaded</span>
0895 <span class="keyword">if</span> ~isempty(metaboliteCharges)
0896     model.metCharges=metaboliteCharges;
0897 <span class="keyword">end</span>
0898 
0899 <span class="comment">%If any gene short names have been loaded</span>
0900 <span class="keyword">if</span> any(~cellfun(@isempty,geneShortNames))
0901     model.geneShortNames=geneShortNames;
0902 <span class="keyword">end</span>
0903 
0904 <span class="comment">%If any Miriam strings for compartments have been loaded</span>
0905 <span class="keyword">if</span> any(~cellfun(@isempty,compartmentMiriams))
0906     model.compMiriams=compartmentMiriams;
0907 <span class="keyword">end</span>
0908 
0909 <span class="comment">%If any Miriam strings for metabolites have been loaded</span>
0910 <span class="keyword">if</span> any(~cellfun(@isempty,metaboliteMiriams))
0911     model.metMiriams=metaboliteMiriams;
0912 <span class="keyword">end</span>
0913 
0914 <span class="comment">%If any subsystems have been loaded</span>
0915 <span class="keyword">if</span> any(~cellfun(@isempty,subsystems))
0916     model.subSystems=subsystems;
0917 <span class="keyword">end</span>
0918 <span class="keyword">if</span> any(rxnComps)
0919     <span class="keyword">if</span> all(rxnComps)
0920         model.rxnComps=rxnComps;
0921     <span class="keyword">else</span>
0922         <span class="keyword">if</span> supressWarnings==false
0923             EM=<span class="string">'The compartments for the following reactions could not be matched. Ignoring reaction compartment information'</span>;
0924             dispEM(EM,false,model.rxns(rxnComps==0));
0925         <span class="keyword">end</span>
0926     <span class="keyword">end</span>
0927 <span class="keyword">end</span>
0928 
0929 <span class="comment">%If any ec-codes have been loaded</span>
0930 <span class="keyword">if</span> any(~cellfun(@isempty,eccodes))
0931     model.eccodes=eccodes;
0932 <span class="keyword">end</span>
0933 
0934 <span class="comment">%If any Miriam strings for reactions have been loaded</span>
0935 <span class="keyword">if</span> any(~cellfun(@isempty,rxnMiriams))
0936     model.rxnMiriams=rxnMiriams;
0937 <span class="keyword">end</span>
0938 
0939 <span class="comment">%If any Miriam strings for genes have been loaded</span>
0940 <span class="keyword">if</span> any(~cellfun(@isempty,geneMiriams))
0941     model.geneMiriams=geneMiriams;
0942 <span class="keyword">end</span>
0943 
0944 <span class="comment">%If any protein strings have been loaded</span>
0945 <span class="keyword">if</span> any(~cellfun(@isempty,proteinNames))
0946     model.proteinNames=proteinNames;
0947 <span class="keyword">end</span>
0948 
0949 model.unconstrained=metaboliteUnconstrained;
0950 
0951 <span class="comment">%Convert SBML IDs back into their original strings. Here we are using part</span>
0952 <span class="comment">%from convertSBMLID, originating from the COBRA Toolbox</span>
0953 model.rxns=regexprep(model.rxns,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
0954 model.mets=regexprep(model.mets,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
0955 model.comps=regexprep(model.comps,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
0956 model.grRules=regexprep(model.grRules,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
0957 model.genes=regexprep(model.genes,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
0958 model.id=regexprep(model.id,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
0959 
0960 
0961 hasCOBRAids(1) = all(startsWith(model.rxns,<span class="string">'R_'</span>));
0962 hasCOBRAids(2) = all(startsWith(model.mets,<span class="string">'M_'</span>));
0963 hasCOBRAids(3) = all(startsWith(model.comps,<span class="string">'C_'</span>));
0964 hasCOBRAids(4) = all(startsWith(model.genes,<span class="string">'G_'</span>));
0965 hasCOBRAids(5) = all(startsWith(model.metNames,<span class="string">'M_'</span>));
0966 hasCOBRAids(6) = all(startsWith(model.rxnNames,<span class="string">'R_'</span>));
0967 hasCOBRAids(7) = all(startsWith(model.id,<span class="string">'M_'</span>));
0968 
0969 <span class="keyword">if</span> COBRAstyle
0970     <span class="keyword">if</span> hasCOBRAids(1)
0971         model.rxns  = cellfun(@(x) x(3:end), model.rxns,<span class="string">'un'</span>,0);
0972     <span class="keyword">end</span>
0973     <span class="keyword">if</span> hasCOBRAids(2)
0974         model.mets  = cellfun(@(x) x(3:end), model.mets,<span class="string">'un'</span>,0);
0975     <span class="keyword">end</span>
0976     <span class="keyword">if</span> hasCOBRAids(3)
0977         model.comps = cellfun(@(x) x(3:end), model.comps,<span class="string">'un'</span>,0);
0978     <span class="keyword">end</span>
0979     <span class="keyword">if</span> hasCOBRAids(4)
0980         model.genes = cellfun(@(x) x(3:end), model.genes,<span class="string">'un'</span>,0);
0981         model.grRules=regexprep(model.grRules,<span class="string">'^G_'</span>,<span class="string">''</span>);
0982         model.grRules=regexprep(model.grRules,<span class="string">'\(G_'</span>,<span class="string">'('</span>);
0983         model.grRules=regexprep(model.grRules,<span class="string">' G_'</span>,<span class="string">' '</span>);
0984     <span class="keyword">end</span>
0985     <span class="comment">% Not strictly identifier, but also remove from metNames and rxnNames if present</span>
0986     <span class="keyword">if</span> hasCOBRAids(5)
0987         model.metNames  = cellfun(@(x) x(3:end), model.metNames,<span class="string">'un'</span>,0);
0988     <span class="keyword">end</span>
0989     <span class="keyword">if</span> hasCOBRAids(6)
0990         model.rxnNames  = cellfun(@(x) x(3:end), model.rxnNames,<span class="string">'un'</span>,0);
0991     <span class="keyword">end</span>
0992     <span class="keyword">if</span> hasCOBRAids(6)
0993         model.id        = model.id(3:end);
0994     <span class="keyword">end</span>
0995 <span class="keyword">elseif</span> any(hasCOBRAids)
0996     printOrange(<span class="string">'COBRA style identifier prefixes (like R_ for reactions) found in the model. To remove those, run importModel with COBRAstyle as true: importModel(''filename.xml'', [], true);\n'</span>);
0997 <span class="keyword">end</span>
0998 
0999 <span class="comment">%Remove unused fields</span>
1000 <span class="keyword">if</span> isempty(model.annotation)
1001     model=rmfield(model,<span class="string">'annotation'</span>);
1002 <span class="keyword">end</span>
1003 <span class="keyword">if</span> isempty(model.compOutside)
1004     model=rmfield(model,<span class="string">'compOutside'</span>);
1005 <span class="keyword">end</span>
1006 <span class="keyword">if</span> isempty(model.compMiriams)
1007     model=rmfield(model,<span class="string">'compMiriams'</span>);
1008 <span class="keyword">end</span>
1009 <span class="keyword">if</span> isempty(model.rxnComps)
1010     model=rmfield(model,<span class="string">'rxnComps'</span>);
1011 <span class="keyword">end</span>
1012 <span class="keyword">if</span> isempty(model.grRules)
1013     model=rmfield(model,<span class="string">'grRules'</span>);
1014 <span class="keyword">end</span>
1015 <span class="keyword">if</span> isempty(model.rxnGeneMat)
1016     model=rmfield(model,<span class="string">'rxnGeneMat'</span>);
1017 <span class="keyword">end</span>
1018 <span class="keyword">if</span> isempty(model.subSystems)
1019     model=rmfield(model,<span class="string">'subSystems'</span>);
1020 <span class="keyword">else</span>
1021     model.subSystems(cellfun(@isempty,subsystems))={{<span class="string">''</span>}};
1022 <span class="keyword">end</span>
1023 <span class="keyword">if</span> isempty(model.eccodes)
1024     model=rmfield(model,<span class="string">'eccodes'</span>);
1025 <span class="keyword">end</span>
1026 <span class="keyword">if</span> isempty(model.rxnMiriams)
1027     model=rmfield(model,<span class="string">'rxnMiriams'</span>);
1028 <span class="keyword">end</span>
1029 <span class="keyword">if</span> cellfun(@isempty,model.rxnNotes)
1030     model=rmfield(model,<span class="string">'rxnNotes'</span>);
1031 <span class="keyword">end</span>
1032 <span class="keyword">if</span> cellfun(@isempty,model.rxnReferences)
1033     model=rmfield(model,<span class="string">'rxnReferences'</span>);
1034 <span class="keyword">end</span>
1035 <span class="keyword">if</span> isempty(model.rxnConfidenceScores) || all(isnan(model.rxnConfidenceScores))
1036     model=rmfield(model,<span class="string">'rxnConfidenceScores'</span>);
1037 <span class="keyword">end</span>
1038 <span class="keyword">if</span> isempty(model.genes)
1039     model=rmfield(model,<span class="string">'genes'</span>);
1040 <span class="keyword">elseif</span> isrow(model.genes)
1041     model.genes=transpose(model.genes);
1042 <span class="keyword">end</span>
1043 <span class="keyword">if</span> isempty(model.geneComps)
1044     model=rmfield(model,<span class="string">'geneComps'</span>);
1045 <span class="keyword">end</span>
1046 <span class="keyword">if</span> isempty(model.geneMiriams)
1047     model=rmfield(model,<span class="string">'geneMiriams'</span>);
1048 <span class="keyword">end</span>
1049 <span class="keyword">if</span> isempty(model.geneShortNames)
1050     model=rmfield(model,<span class="string">'geneShortNames'</span>);
1051 <span class="keyword">end</span>
1052 <span class="keyword">if</span> isempty(model.proteinNames)
1053     model=rmfield(model,<span class="string">'proteinNames'</span>);
1054 <span class="keyword">end</span>
1055 <span class="keyword">if</span> isempty(model.inchis)
1056     model=rmfield(model,<span class="string">'inchis'</span>);
1057 <span class="keyword">end</span>
1058 <span class="keyword">if</span> isempty(model.metFormulas)
1059     model=rmfield(model,<span class="string">'metFormulas'</span>);
1060 <span class="keyword">end</span>
1061 <span class="keyword">if</span> isempty(model.metMiriams)
1062     model=rmfield(model,<span class="string">'metMiriams'</span>);
1063 <span class="keyword">end</span>
1064 <span class="keyword">if</span> ~any(model.metCharges)
1065     model=rmfield(model,<span class="string">'metCharges'</span>);
1066 <span class="keyword">end</span>
1067 
1068 <span class="comment">%This just removes the grRules if no genes have been loaded</span>
1069 <span class="keyword">if</span> ~isfield(model,<span class="string">'genes'</span>) &amp;&amp; isfield(model,<span class="string">'grRules'</span>)
1070     model=rmfield(model,<span class="string">'grRules'</span>);
1071 <span class="keyword">end</span>
1072 
1073 <span class="comment">%Print warnings about bad structure</span>
1074 <span class="keyword">if</span> supressWarnings==false
1075     checkModelStruct(model,false);
1076 <span class="keyword">end</span>
1077 
1078 <span class="keyword">if</span> removeExcMets==true
1079     model=simplifyModel(model);
1080 <span class="keyword">end</span>
1081 <span class="keyword">end</span>
1082 
1083 <a name="_sub1" href="#_subfunctions" class="code">function matchGenes=getGeneList(grRules)</a>
1084 <span class="comment">%Constructs the list of unique genes from grRules</span>
1085 
1086 <span class="comment">%Assumes that everything that isn't a paranthesis, &quot; AND &quot; or &quot; or &quot; is a</span>
1087 <span class="comment">%gene name</span>
1088 genes=strrep(grRules,<span class="string">'('</span>,<span class="string">''</span>);
1089 genes=strrep(genes,<span class="string">')'</span>,<span class="string">''</span>);
1090 genes=strrep(genes,<span class="string">' or '</span>,<span class="string">' '</span>);
1091 genes=strrep(genes,<span class="string">' and '</span>,<span class="string">' '</span>);
1092 genes=strrep(genes,<span class="string">' OR '</span>,<span class="string">' '</span>);
1093 genes=strrep(genes,<span class="string">' AND '</span>,<span class="string">' '</span>);
1094 genes=regexp(genes,<span class="string">' '</span>,<span class="string">'split'</span>);
1095 
1096 allNames={};
1097 <span class="keyword">for</span> i=1:numel(genes)
1098     allNames=[allNames genes{i}];
1099 <span class="keyword">end</span>
1100 matchGenes=unique(allNames)';
1101 
1102 <span class="comment">%Remove the empty element if present</span>
1103 <span class="keyword">if</span> isempty(matchGenes{1})
1104     matchGenes(1)=[];
1105 <span class="keyword">end</span>
1106 <span class="keyword">end</span>
1107 
1108 <a name="_sub2" href="#_subfunctions" class="code">function fieldContent=parseNote(searchString,fieldName)</a>
1109 <span class="comment">%The function obtains the particular information from 'notes' field, using</span>
1110 <span class="comment">%fieldName as the dummy string</span>
1111 
1112 fieldContent=<span class="string">''</span>;
1113 
1114 <span class="keyword">if</span> strfind(searchString,fieldName)
1115     [~,targetString] = regexp(searchString,[<span class="string">'&lt;p&gt;'</span> fieldName <span class="string">'.*?&lt;/p&gt;'</span>],<span class="string">'tokens'</span>,<span class="string">'match'</span>);
1116     targetString=regexprep(targetString,<span class="string">'&lt;p&gt;|&lt;/p&gt;'</span>,<span class="string">''</span>);
1117     targetString=regexprep(targetString,[fieldName, <span class="string">':'</span>],<span class="string">''</span>);
1118     <span class="keyword">for</span> i=1:numel(targetString)
1119         fieldContent=[fieldContent <span class="string">';'</span> strtrim(targetString{1,i})];
1120     <span class="keyword">end</span>
1121     fieldContent=regexprep(fieldContent,<span class="string">'^;|;$'</span>,<span class="string">''</span>);
1122 <span class="keyword">else</span>
1123     fieldContent=<span class="string">''</span>;
1124 <span class="keyword">end</span>
1125 <span class="keyword">end</span>
1126 
1127 <a name="_sub3" href="#_subfunctions" class="code">function fieldContent=parseAnnotation(searchString,startString,midString,fieldName)</a>
1128 
1129 fieldContent=<span class="string">''</span>;
1130 
1131 <span class="comment">%Removing whitespace characters from the ending strings, which may occur in</span>
1132 <span class="comment">%several cases</span>
1133 searchString=regexprep(searchString,<span class="string">'&quot; /&gt;'</span>,<span class="string">'&quot;/&gt;'</span>);
1134 [~,targetString] = regexp(searchString,[<span class="string">'&lt;rdf:li rdf:resource=&quot;'</span> startString fieldName midString <span class="string">'.*?&quot;/&gt;'</span>],<span class="string">'tokens'</span>,<span class="string">'match'</span>);
1135 targetString=regexprep(targetString,<span class="string">'&lt;rdf:li rdf:resource=&quot;|&quot;/&gt;'</span>,<span class="string">''</span>);
1136 targetString=regexprep(targetString,startString,<span class="string">''</span>);
1137 targetString=regexprep(targetString,[fieldName midString],<span class="string">''</span>);
1138 
1139 <span class="keyword">for</span> i=1:numel(targetString)
1140     fieldContent=[fieldContent <span class="string">';'</span> strtrim(targetString{1,i})];
1141 <span class="keyword">end</span>
1142 
1143 fieldContent=regexprep(fieldContent,<span class="string">'^;|;$'</span>,<span class="string">''</span>);
1144 <span class="keyword">end</span>
1145 
1146 <a name="_sub4" href="#_subfunctions" class="code">function miriamStruct=parseMiriam(searchString)</a>
1147 <span class="comment">%Generates miriam structure from annotation field</span>
1148 
1149 <span class="comment">%Finding whether miriams are written in the old or the new way</span>
1150 <span class="keyword">if</span> strfind(searchString,<span class="string">'urn:miriam:'</span>)
1151     startString=<span class="string">'urn:miriam:'</span>;
1152     midString=<span class="string">':'</span>;
1153 <span class="keyword">elseif</span> strfind(searchString,<span class="string">'http://identifiers.org/'</span>)
1154     startString=<span class="string">'http://identifiers.org/'</span>;
1155     midString=<span class="string">'/'</span>;
1156 <span class="keyword">elseif</span> strfind(searchString,<span class="string">'https://identifiers.org/'</span>)
1157     startString=<span class="string">'https://identifiers.org/'</span>;
1158     midString=<span class="string">'/'</span>;
1159 <span class="keyword">else</span>
1160     miriamStruct=[];
1161     <span class="keyword">return</span>;
1162 <span class="keyword">end</span>
1163 
1164 miriamStruct=[];
1165 
1166 searchString=regexprep(searchString,<span class="string">'&quot; /&gt;'</span>,<span class="string">'&quot;/&gt;'</span>);
1167 [~,targetString] = regexp(searchString,<span class="string">'&lt;rdf:li rdf:resource=&quot;.*?&quot;/&gt;'</span>,<span class="string">'tokens'</span>,<span class="string">'match'</span>);
1168 targetString=regexprep(targetString,<span class="string">'&lt;rdf:li rdf:resource=&quot;|&quot;/&gt;'</span>,<span class="string">''</span>);
1169 targetString=regexprep(targetString,startString,<span class="string">''</span>);
1170 targetString=regexprep(targetString,midString,<span class="string">'/'</span>,<span class="string">'once'</span>);
1171 
1172 counter=0;
1173 <span class="keyword">for</span> i=1:numel(targetString)
1174     <span class="keyword">if</span> isempty(regexp(targetString{1,i},<span class="string">'inchi|ec-code'</span>, <span class="string">'once'</span>))
1175         counter=counter+1;
1176         miriamStruct.name{counter,1} = regexprep(targetString{1,i},<span class="string">'/.+'</span>,<span class="string">''</span>,<span class="string">'once'</span>);
1177         miriamStruct.value{counter,1} = regexprep(targetString{1,i},[miriamStruct.name{counter,1} <span class="string">'/'</span>],<span class="string">''</span>,<span class="string">'once'</span>);
1178         miriamStruct.name{counter,1} = regexprep(miriamStruct.name{counter,1},<span class="string">'^obo\.'</span>,<span class="string">''</span>);
1179     <span class="keyword">end</span>
1180 <span class="keyword">end</span>
1181 <span class="keyword">end</span>
1182 
1183 <a name="_sub5" href="#_subfunctions" class="code">function miriam = addSBOtoMiriam(miriam,sboTerm)</a>
1184 <span class="comment">%Appends SBO term to miriam structure</span>
1185 
1186 sboTerm = {[<span class="string">'SBO:'</span> sprintf(<span class="string">'%07u'</span>,sboTerm)]};  <span class="comment">% convert to proper format</span>
1187 <span class="keyword">if</span> isempty(miriam)
1188     miriam.name = {<span class="string">'sbo'</span>};
1189     miriam.value = sboTerm;
1190 <span class="keyword">elseif</span> any(strcmp(<span class="string">'sbo'</span>,miriam.name))
1191     currSbo = strcmp(<span class="string">'sbo'</span>,miriam.name);
1192     miriam.value(currSbo) = sboTerm;
1193 <span class="keyword">else</span>
1194     miriam.name(end+1) = {<span class="string">'sbo'</span>};
1195     miriam.value(end+1) = sboTerm;
1196 <span class="keyword">end</span>
1197 <span class="keyword">end</span></pre></div>
<hr><address>Generated by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>