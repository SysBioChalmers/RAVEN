<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of importModel</title>
  <meta name="keywords" content="importModel">
  <meta name="description" content="importModel">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">io</a> &gt; importModel.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for io&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>importModel
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>importModel</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function model=importModel(fileName,removeExcMets,isSBML2COBRA,supressWarnings) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> importModel
   Import a constraint-based model from a SBML file

   Input:
   fileName        a SBML file to import. A dialog window will open if 
                   no file name is specified.
   removeExcMets   true if exchange metabolites should be removed. This is
                   needed to be able to run simulations, but it could also
                   be done using simplifyModel at a later stage (opt,
                   default true)
   isSBML2COBRA    true if the SBML file is in the old COBRA Toolbox format
                   (SBML Level 2) (opt, default false)
   supressWarnings true if warnings regarding the model structure should
                   be supressed (opt, default false)

   Output:
   model
       id               model ID
       name      name of model contents
       annotation       additional information about model
       rxns             reaction ids
       mets             metabolite ids
       S                stoichiometric matrix
       lb               lower bounds
       ub               upper bounds
       rev              reversibility vector
       c                objective coefficients
       b                equality constraints for the metabolite equations
       comps            compartment ids
       compNames        compartment names
       compOutside      the id (as in comps) for the compartment
                        surrounding each of the compartments
       compMiriams      structure with MIRIAM information about the
                        compartments
       rxnNames         reaction description
       rxnComps         compartments for reactions
       grRules          reaction to gene rules in text form
       rxnGeneMat       reaction-to-gene mapping in sparse matrix form
       subSystems       subsystem name for each reaction
       eccodes          EC-codes for the reactions
       rxnMiriams       structure with MIRIAM information about the reactions
       rxnNotes         reaction notes
       rxnReferences    reaction references
       rxnConfidenceScores reaction confidence scores
       genes            list of all genes
       geneComps        compartments for genes
       geneMiriams      structure with MIRIAM information about the genes
       geneShortNames   gene alternative names (e.g. ERG10)
       metNames         metabolite description
       metComps         compartments for metabolites
       inchis           InChI-codes for metabolites
       metFormulas      metabolite chemical formula
       metMiriams       structure with MIRIAM information about the metabolites
       metCharges       metabolite charge
       unconstrained    true if the metabolite is an exchange metabolite

   Loads models in the COBRA Toolbox format and in the format used in
   the yeast consensus reconstruction. The resulting structure is compatible
   with COBRA Toolbox. A number of consistency checks are performed in order
   to ensure that the model is valid. Take these warnings seriously and modify the
   model structure to solve them. The RAVEN Toolbox is made to function
   only on consistent models, and the only checks performed are when the
   model is imported. You can use exportToExcelFormat, modify the model in
   Microsoft Excel and then reimport it using importExcelModel (or remake
   the SBML file using SBMLFromExcel)

   NOTE: This script requires that libSBML is installed.

   NOTE: All IDs are assumed to be named C_, M_, E_, R_ for compartments,
         metabolites, genes, and reactions. This is true for models
         generated by SBMLFromExcel and those that follow the yeast
         consensus network model formulation.

   Usage: model=importModel(fileName,removeExcMets,isSBML2COBRA,supressWarnings)</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="checkFileExistence.html" class="code" title="function files=checkFileExistence(files,fullOrTemp,allowSpace,checkExist)">checkFileExistence</a>	checkFileExistence</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function matchGenes=getGeneList(grRules)</a></li><li><a href="#_sub2" class="code">function fieldContent=parseNote(searchString,fieldName)</a></li><li><a href="#_sub3" class="code">function fieldContent=parseAnnotation(searchString,startString,midString,fieldName)</a></li><li><a href="#_sub4" class="code">function miriamStruct=parseMiriam(searchString)</a></li><li><a href="#_sub5" class="code">function miriam = addSBOtoMiriam(miriam,sboTerm)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function model=importModel(fileName,removeExcMets,isSBML2COBRA,supressWarnings)</a>
0002 <span class="comment">% importModel</span>
0003 <span class="comment">%   Import a constraint-based model from a SBML file</span>
0004 <span class="comment">%</span>
0005 <span class="comment">%   Input:</span>
0006 <span class="comment">%   fileName        a SBML file to import. A dialog window will open if</span>
0007 <span class="comment">%                   no file name is specified.</span>
0008 <span class="comment">%   removeExcMets   true if exchange metabolites should be removed. This is</span>
0009 <span class="comment">%                   needed to be able to run simulations, but it could also</span>
0010 <span class="comment">%                   be done using simplifyModel at a later stage (opt,</span>
0011 <span class="comment">%                   default true)</span>
0012 <span class="comment">%   isSBML2COBRA    true if the SBML file is in the old COBRA Toolbox format</span>
0013 <span class="comment">%                   (SBML Level 2) (opt, default false)</span>
0014 <span class="comment">%   supressWarnings true if warnings regarding the model structure should</span>
0015 <span class="comment">%                   be supressed (opt, default false)</span>
0016 <span class="comment">%</span>
0017 <span class="comment">%   Output:</span>
0018 <span class="comment">%   model</span>
0019 <span class="comment">%       id               model ID</span>
0020 <span class="comment">%       name      name of model contents</span>
0021 <span class="comment">%       annotation       additional information about model</span>
0022 <span class="comment">%       rxns             reaction ids</span>
0023 <span class="comment">%       mets             metabolite ids</span>
0024 <span class="comment">%       S                stoichiometric matrix</span>
0025 <span class="comment">%       lb               lower bounds</span>
0026 <span class="comment">%       ub               upper bounds</span>
0027 <span class="comment">%       rev              reversibility vector</span>
0028 <span class="comment">%       c                objective coefficients</span>
0029 <span class="comment">%       b                equality constraints for the metabolite equations</span>
0030 <span class="comment">%       comps            compartment ids</span>
0031 <span class="comment">%       compNames        compartment names</span>
0032 <span class="comment">%       compOutside      the id (as in comps) for the compartment</span>
0033 <span class="comment">%                        surrounding each of the compartments</span>
0034 <span class="comment">%       compMiriams      structure with MIRIAM information about the</span>
0035 <span class="comment">%                        compartments</span>
0036 <span class="comment">%       rxnNames         reaction description</span>
0037 <span class="comment">%       rxnComps         compartments for reactions</span>
0038 <span class="comment">%       grRules          reaction to gene rules in text form</span>
0039 <span class="comment">%       rxnGeneMat       reaction-to-gene mapping in sparse matrix form</span>
0040 <span class="comment">%       subSystems       subsystem name for each reaction</span>
0041 <span class="comment">%       eccodes          EC-codes for the reactions</span>
0042 <span class="comment">%       rxnMiriams       structure with MIRIAM information about the reactions</span>
0043 <span class="comment">%       rxnNotes         reaction notes</span>
0044 <span class="comment">%       rxnReferences    reaction references</span>
0045 <span class="comment">%       rxnConfidenceScores reaction confidence scores</span>
0046 <span class="comment">%       genes            list of all genes</span>
0047 <span class="comment">%       geneComps        compartments for genes</span>
0048 <span class="comment">%       geneMiriams      structure with MIRIAM information about the genes</span>
0049 <span class="comment">%       geneShortNames   gene alternative names (e.g. ERG10)</span>
0050 <span class="comment">%       metNames         metabolite description</span>
0051 <span class="comment">%       metComps         compartments for metabolites</span>
0052 <span class="comment">%       inchis           InChI-codes for metabolites</span>
0053 <span class="comment">%       metFormulas      metabolite chemical formula</span>
0054 <span class="comment">%       metMiriams       structure with MIRIAM information about the metabolites</span>
0055 <span class="comment">%       metCharges       metabolite charge</span>
0056 <span class="comment">%       unconstrained    true if the metabolite is an exchange metabolite</span>
0057 <span class="comment">%</span>
0058 <span class="comment">%   Loads models in the COBRA Toolbox format and in the format used in</span>
0059 <span class="comment">%   the yeast consensus reconstruction. The resulting structure is compatible</span>
0060 <span class="comment">%   with COBRA Toolbox. A number of consistency checks are performed in order</span>
0061 <span class="comment">%   to ensure that the model is valid. Take these warnings seriously and modify the</span>
0062 <span class="comment">%   model structure to solve them. The RAVEN Toolbox is made to function</span>
0063 <span class="comment">%   only on consistent models, and the only checks performed are when the</span>
0064 <span class="comment">%   model is imported. You can use exportToExcelFormat, modify the model in</span>
0065 <span class="comment">%   Microsoft Excel and then reimport it using importExcelModel (or remake</span>
0066 <span class="comment">%   the SBML file using SBMLFromExcel)</span>
0067 <span class="comment">%</span>
0068 <span class="comment">%   NOTE: This script requires that libSBML is installed.</span>
0069 <span class="comment">%</span>
0070 <span class="comment">%   NOTE: All IDs are assumed to be named C_, M_, E_, R_ for compartments,</span>
0071 <span class="comment">%         metabolites, genes, and reactions. This is true for models</span>
0072 <span class="comment">%         generated by SBMLFromExcel and those that follow the yeast</span>
0073 <span class="comment">%         consensus network model formulation.</span>
0074 <span class="comment">%</span>
0075 <span class="comment">%   Usage: model=importModel(fileName,removeExcMets,isSBML2COBRA,supressWarnings)</span>
0076 <span class="keyword">if</span> nargin&lt;1 || isempty(fileName)
0077     [fileName, pathName] = uigetfile({<span class="string">'*.xml;*.sbml'</span>}, <span class="string">'Please select the model file'</span>);
0078     <span class="keyword">if</span> fileName == 0
0079         error(<span class="string">'You should select a model file'</span>)
0080     <span class="keyword">else</span>
0081         fileName = fullfile(pathName,fileName);
0082     <span class="keyword">end</span>
0083 <span class="keyword">end</span>
0084 fileName=char(fileName);
0085 <span class="keyword">if</span> nargin&lt;2
0086     removeExcMets=true;
0087 <span class="keyword">end</span>
0088 
0089 <span class="keyword">if</span> nargin&lt;3
0090     isSBML2COBRA=false;
0091 <span class="keyword">end</span>
0092 
0093 <span class="keyword">if</span> nargin&lt;4
0094     supressWarnings=false;
0095 <span class="keyword">end</span>
0096 
0097 <span class="keyword">if</span> ~isfile(fileName)
0098     error(<span class="string">'SBML file %s cannot be found'</span>,string(fileName));
0099 <span class="keyword">end</span>
0100 
0101 <span class="comment">%This is to match the order of the fields to those you get from importing</span>
0102 <span class="comment">%from Excel</span>
0103 model=[];
0104 model.id=[];
0105 model.name=[];
0106 model.annotation=[];
0107 model.rxns={};
0108 model.mets={};
0109 model.S=[];
0110 model.lb=[];
0111 model.ub=[];
0112 model.rev=[];
0113 model.c=[];
0114 model.b=[];
0115 model.comps={};
0116 model.compNames={};
0117 model.compOutside={};
0118 model.compMiriams={};
0119 model.rxnNames={};
0120 model.rxnComps=[];
0121 model.grRules={};
0122 model.rxnGeneMat=[];
0123 model.subSystems={};
0124 model.eccodes={};
0125 model.rxnMiriams={};
0126 model.rxnNotes={};
0127 model.rxnReferences={};
0128 model.rxnConfidenceScores=[];
0129 model.genes={};
0130 model.geneComps=[];
0131 model.geneMiriams={};
0132 model.geneShortNames={};
0133 model.metNames={};
0134 model.metComps=[];
0135 model.inchis={};
0136 model.metFormulas={};
0137 model.metMiriams={};
0138 model.metCharges=[];
0139 model.unconstrained=[];
0140 
0141 <span class="comment">%Load the model using libSBML</span>
0142 [ravenDir,prevDir]=findRAVENroot();
0143 fileName=<a href="checkFileExistence.html" class="code" title="function files=checkFileExistence(files,fullOrTemp,allowSpace,checkExist)">checkFileExistence</a>(fileName,1);
0144 cd(fullfile(ravenDir,<span class="string">'software'</span>,<span class="string">'libSBML'</span>));
0145 modelSBML = TranslateSBML(fileName,0,0,[1 1]);
0146 cd(prevDir);
0147 
0148 <span class="keyword">if</span> isempty(modelSBML)
0149     EM=<span class="string">'There is a problem with the SBML file. Try using the SBML Validator at http://sbml.org/Facilities/Validator'</span>;
0150     dispEM(EM);
0151 <span class="keyword">end</span>
0152 
0153 <span class="comment">%Remove the preceding strings for reactions, compartments and</span>
0154 <span class="comment">%reactants/products in 'reaction' field. The strings for metabolites, genes</span>
0155 <span class="comment">%and complexes are not removed, as we will need them later to identify them</span>
0156 <span class="comment">%from 'species' field</span>
0157 <span class="keyword">for</span> i=1:numel(modelSBML.reaction)
0158     modelSBML.reaction(i).name=regexprep(modelSBML.reaction(i).name,<span class="string">'^R_'</span>,<span class="string">''</span>);
0159     modelSBML.reaction(i).id=regexprep(modelSBML.reaction(i).id,<span class="string">'^R_'</span>,<span class="string">''</span>);
0160     <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'compartment'</span>)
0161         modelSBML.reaction(i).compartment=regexprep(modelSBML.reaction(i).compartment,<span class="string">'^C_'</span>,<span class="string">''</span>);
0162     <span class="keyword">end</span>
0163     <span class="keyword">for</span> j=1:numel(modelSBML.reaction(i).reactant)
0164         modelSBML.reaction(i).reactant(j).species=regexprep(modelSBML.reaction(i).reactant(j).species,<span class="string">'^M_'</span>,<span class="string">''</span>);
0165     <span class="keyword">end</span>
0166     <span class="keyword">for</span> j=1:numel(modelSBML.reaction(i).product)
0167         modelSBML.reaction(i).product(j).species=regexprep(modelSBML.reaction(i).product(j).species,<span class="string">'^M_'</span>,<span class="string">''</span>);
0168     <span class="keyword">end</span>
0169 <span class="keyword">end</span>
0170 
0171 <span class="comment">%Retrieve compartment names and IDs</span>
0172 compartmentNames=cell(numel(modelSBML.compartment),1);
0173 compartmentIDs=cell(numel(modelSBML.compartment),1);
0174 compartmentOutside=cell(numel(modelSBML.compartment),1);
0175 compartmentMiriams=cell(numel(modelSBML.compartment),1);
0176 
0177 <span class="keyword">if</span> isfield(modelSBML.compartment,<span class="string">'sboTerm'</span>) &amp;&amp; numel(unique([modelSBML.compartment.sboTerm])) == 1
0178     <span class="comment">%If all the SBO terms are identical, don't add them to compMiriams</span>
0179     modelSBML.compartment = rmfield(modelSBML.compartment,<span class="string">'sboTerm'</span>);
0180 <span class="keyword">end</span>
0181     
0182 <span class="keyword">for</span> i=1:numel(modelSBML.compartment)
0183     compartmentNames{i}=modelSBML.compartment(i).name;
0184     compartmentIDs{i}=regexprep(modelSBML.compartment(i).id,<span class="string">'^C_'</span>,<span class="string">''</span>);
0185     <span class="keyword">if</span> isfield(modelSBML.compartment(i),<span class="string">'outside'</span>)
0186         <span class="keyword">if</span> ~isempty(modelSBML.compartment(i).outside)
0187             compartmentOutside{i}=regexprep(modelSBML.compartment(i).outside,<span class="string">'^C_'</span>,<span class="string">''</span>);
0188         <span class="keyword">else</span>
0189             compartmentOutside{i}=<span class="string">''</span>;
0190         <span class="keyword">end</span>
0191     <span class="keyword">else</span>
0192         compartmentOutside{i}=[];
0193     <span class="keyword">end</span>
0194     
0195     <span class="keyword">if</span> isfield(modelSBML.compartment(i),<span class="string">'annotation'</span>)
0196         compartmentMiriams{i}=<a href="#_sub4" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.compartment(i).annotation);
0197     <span class="keyword">else</span>
0198         compartmentMiriams{i}=[];
0199     <span class="keyword">end</span>
0200     
0201     <span class="keyword">if</span> isfield(modelSBML.compartment(i),<span class="string">'sboTerm'</span>) &amp;&amp; ~(modelSBML.compartment(i).sboTerm==-1)
0202         compartmentMiriams{i} = <a href="#_sub5" class="code" title="subfunction miriam = addSBOtoMiriam(miriam,sboTerm)">addSBOtoMiriam</a>(compartmentMiriams{i},modelSBML.compartment(i).sboTerm);
0203     <span class="keyword">end</span>
0204 <span class="keyword">end</span>
0205 
0206 <span class="comment">%If there are no compartment names then use compartment id as name</span>
0207 <span class="keyword">if</span> all(cellfun(@isempty,compartmentNames))
0208     compartmentNames=compartmentIDs;
0209 <span class="keyword">end</span>
0210 
0211 <span class="comment">%Retrieve info on metabolites, genes, complexes</span>
0212 metaboliteNames={};
0213 metaboliteIDs={};
0214 metaboliteCompartments={};
0215 metaboliteUnconstrained=[];
0216 metaboliteFormula={};
0217 metaboliteInChI={};
0218 metaboliteMiriams={};
0219 metaboliteCharges=[];
0220 
0221 geneNames={};
0222 geneIDs={};
0223 geneMiriams={};
0224 geneShortNames={};
0225 geneCompartments={};
0226 complexIDs={};
0227 complexNames={};
0228 
0229 <span class="comment">%If the file is not a COBRA Toolbox model. According to the format</span>
0230 <span class="comment">%specified in the yeast consensus model both metabolites and genes are a</span>
0231 <span class="comment">%type of 'species'. The metabolites have names starting with 'M_' and genes</span>
0232 <span class="comment">%with 'E_'</span>
0233 geneSBOs = [];
0234 metSBOs = [];
0235 <span class="comment">%Regex of compartment names, later to be used to remove from metabolite</span>
0236 <span class="comment">%names if present as suffix.</span>
0237 regexCompNames = [<span class="string">'\s?\[(('</span> strjoin({modelSBML.compartment.name},<span class="string">')|('</span>) <span class="string">'))\]$'</span>];
0238 <span class="keyword">for</span> i=1:numel(modelSBML.species)
0239     <span class="keyword">if</span> ~isSBML2COBRA
0240         <span class="keyword">if</span> length(modelSBML.species(i).id)&gt;=2 &amp;&amp; strcmpi(modelSBML.species(i).id(1:2),<span class="string">'E_'</span>)
0241             geneNames{numel(geneNames)+1,1}=modelSBML.species(i).name;
0242             
0243             <span class="comment">%The &quot;E_&quot; is included in the ID. This is because it's only used</span>
0244             <span class="comment">%internally in this file and it makes the matching a little</span>
0245             <span class="comment">%smoother</span>
0246             geneIDs{numel(geneIDs)+1,1}=modelSBML.species(i).id;
0247             geneCompartments{numel(geneCompartments)+1,1}=regexprep(modelSBML.species(i).compartment,<span class="string">'^C_'</span>,<span class="string">''</span>);
0248             
0249             <span class="comment">%Get Miriam structure</span>
0250             <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'annotation'</span>)
0251                 <span class="comment">%Get Miriam info</span>
0252                 geneMiriam=<a href="#_sub4" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.species(i).annotation);
0253                 geneMiriams{numel(geneMiriams)+1,1}=geneMiriam;
0254             <span class="keyword">else</span>
0255                 geneMiriams{numel(geneMiriams)+1,1}=[];
0256             <span class="keyword">end</span>
0257             
0258             <span class="comment">%Protein short names (for example ERG10) are saved as SHORT</span>
0259             <span class="comment">%NAME: NAME in the notes-section of metabolites for SBML Level</span>
0260             <span class="comment">%2 and as PROTEIN_ASSOCIATION for each reaction in SBML Level 2</span>
0261             <span class="comment">%COBRA Toolbox format. For now only the SHORT NAME is loaded</span>
0262             <span class="comment">%and no mapping takes place</span>
0263             <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'notes'</span>)
0264                 geneShortNames{numel(geneShortNames)+1,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'SHORT NAME'</span>);
0265             <span class="keyword">else</span>
0266                 geneShortNames{numel(geneShortNames)+1,1}=<span class="string">''</span>;
0267             <span class="keyword">end</span>
0268             
0269             <span class="comment">%Get SBO term</span>
0270             <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'sboTerm'</span>) &amp;&amp; ~(modelSBML.species(i).sboTerm==-1)
0271                 geneSBOs(end+1,1) = modelSBML.species(i).sboTerm;
0272             <span class="keyword">end</span>
0273         <span class="keyword">elseif</span> length(modelSBML.species(i).id)&gt;=2 &amp;&amp; strcmpi(modelSBML.species(i).id(1:3),<span class="string">'Cx_'</span>)
0274             <span class="comment">%If it's a complex keep the ID and name</span>
0275             complexIDs=[complexIDs;modelSBML.species(i).id];
0276             complexNames=[complexNames;modelSBML.species(i).name];
0277         <span class="keyword">else</span>
0278             <span class="comment">%If it is not gene or complex, then it must be a metabolite</span>
0279             metaboliteNames{numel(metaboliteNames)+1,1}=modelSBML.species(i).name;
0280             metaboliteIDs{numel(metaboliteIDs)+1,1}=regexprep(modelSBML.species(i).id,<span class="string">'^M_'</span>,<span class="string">''</span>);
0281             metaboliteCompartments{numel(metaboliteCompartments)+1,1}=regexprep(modelSBML.species(i).compartment,<span class="string">'^C_'</span>,<span class="string">''</span>);
0282             metaboliteUnconstrained(numel(metaboliteUnconstrained)+1,1)=modelSBML.species(i).boundaryCondition;
0283             
0284             <span class="comment">%For each metabolite retrieve the formula and the InChI code if</span>
0285             <span class="comment">%available First add the InChI code and the formula from the</span>
0286             <span class="comment">%InChI. This allows for overwriting the formula by setting the</span>
0287             <span class="comment">%actual formula field</span>
0288             <span class="keyword">if</span> ~isempty(modelSBML.species(i).annotation)
0289                 <span class="comment">%Get the formula if available</span>
0290                 startString=<span class="string">'&gt;InChI='</span>;
0291                 endString=<span class="string">'&lt;/in:inchi&gt;'</span>;
0292                 formStart=strfind(modelSBML.species(i).annotation,startString);
0293                 <span class="keyword">if</span> isempty(formStart)
0294                     startString=<span class="string">'InChI='</span>;
0295                     endString=<span class="string">'&quot;/&gt;'</span>;
0296                 <span class="keyword">end</span>
0297                 formStart=strfind(modelSBML.species(i).annotation,startString);
0298                 <span class="keyword">if</span> ~isempty(formStart)
0299                     formEnd=strfind(modelSBML.species(i).annotation,endString);
0300                     formEndIndex=find(formEnd&gt;formStart, 1 );
0301                     formula=modelSBML.species(i).annotation(formStart+numel(startString):formEnd(formEndIndex)-1);
0302                     metaboliteInChI{numel(metaboliteInChI)+1,1}=formula;
0303                     
0304                     <span class="comment">%The composition is most often present between the</span>
0305                     <span class="comment">%first and second &quot;/&quot; in the model. In some simple</span>
0306                     <span class="comment">%molecules, such as salts, there is no second &quot;/&quot;. The</span>
0307                     <span class="comment">%formula is then assumed to be to the end of the string</span>
0308                     compositionIndexes=strfind(formula,<span class="string">'/'</span>);
0309                     <span class="keyword">if</span> numel(compositionIndexes)&gt;1
0310                         metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="keyword">...</span>
0311                             formula(compositionIndexes(1)+1:compositionIndexes(2)-1);
0312                     <span class="keyword">else</span>
0313                         <span class="keyword">if</span> numel(compositionIndexes)==1
0314                             <span class="comment">%Probably a simple molecule which can have only</span>
0315                             <span class="comment">%one conformation</span>
0316                             metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="keyword">...</span>
0317                                 formula(compositionIndexes(1)+1:numel(formula));
0318                         <span class="keyword">else</span>
0319                             metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0320                         <span class="keyword">end</span>
0321                     <span class="keyword">end</span>
0322                 <span class="keyword">elseif</span> isfield(modelSBML.species(i),<span class="string">'fbc_chemicalFormula'</span>)
0323                     metaboliteInChI{numel(metaboliteInChI)+1,1}=<span class="string">''</span>;
0324                     <span class="keyword">if</span> ~isempty(modelSBML.species(i).fbc_chemicalFormula)
0325                         <span class="comment">%Cannot extract InChi from formula, so remains</span>
0326                         <span class="comment">%empty</span>
0327                         metaboliteFormula{numel(metaboliteFormula)+1,1}=modelSBML.species(i).fbc_chemicalFormula;
0328                     <span class="keyword">else</span>
0329                         metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0330                     <span class="keyword">end</span>
0331                 <span class="keyword">else</span>
0332                     metaboliteInChI{numel(metaboliteInChI)+1,1}=<span class="string">''</span>;
0333                     metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0334                 <span class="keyword">end</span>
0335                 
0336                 <span class="comment">%Get Miriam info</span>
0337                 metMiriam=<a href="#_sub4" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.species(i).annotation);
0338                 metaboliteMiriams{numel(metaboliteMiriams)+1,1}=metMiriam;
0339             <span class="keyword">else</span>
0340                 metaboliteInChI{numel(metaboliteInChI)+1,1}=<span class="string">''</span>;
0341                 <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'notes'</span>)
0342                     metaboliteFormula{numel(metaboliteFormula)+1,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'FORMULA'</span>);
0343                 <span class="keyword">else</span>
0344                     metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0345                 <span class="keyword">end</span>
0346                 metaboliteMiriams{numel(metaboliteMiriams)+1,1}=[];
0347             <span class="keyword">end</span>
0348             <span class="keyword">if</span> ~isempty(modelSBML.species(i).notes)
0349                 <span class="keyword">if</span> ~isfield(modelSBML.species(i),<span class="string">'annotation'</span>)
0350                     metaboliteFormula{numel(metaboliteFormula)+1,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'FORMULA'</span>);
0351                 <span class="keyword">end</span>
0352             <span class="keyword">elseif</span> ~isfield(modelSBML.species(i),<span class="string">'annotation'</span>)
0353                 metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0354             <span class="keyword">end</span>
0355             <span class="comment">%Get SBO term</span>
0356             <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'sboTerm'</span>) &amp;&amp; ~(modelSBML.species(i).sboTerm==-1)
0357                 metSBOs(end+1,1) = modelSBML.species(i).sboTerm;
0358             <span class="keyword">end</span>
0359         <span class="keyword">end</span>
0360         
0361     <span class="keyword">elseif</span> isSBML2COBRA
0362         <span class="comment">%The metabolite names are assumed to be M_NAME_COMPOSITION or</span>
0363         <span class="comment">%_NAME_COMPOSITION or NAME_COMPOSITION or NAME. Regular expressions</span>
0364         <span class="comment">%are used that only NAME_COMPOSITION or NAME would be possible</span>
0365         
0366         modelSBML.species(i).name=regexprep(modelSBML.species(i).name,<span class="string">'^M_'</span>,<span class="string">''</span>);
0367         modelSBML.species(i).name=regexprep(modelSBML.species(i).name,<span class="string">'^_'</span>,<span class="string">''</span>);
0368         underscoreIndex=strfind(modelSBML.species(i).name,<span class="string">'_'</span>);
0369         
0370         metaboliteNames{numel(metaboliteNames)+1,1}=modelSBML.species(i).name;
0371         
0372         metaboliteIDs{numel(metaboliteIDs)+1,1}=regexprep(modelSBML.species(i).id,<span class="string">'^M_'</span>,<span class="string">''</span>);
0373         metaboliteCompartments{numel(metaboliteCompartments)+1,1}=regexprep(modelSBML.species(i).compartment,<span class="string">'^C_'</span>,<span class="string">''</span>);
0374         
0375         <span class="comment">%I think that COBRA doesn't set the boundary condition, but rather</span>
0376         <span class="comment">%uses name_b. Check for either</span>
0377         metaboliteUnconstrained(numel(metaboliteUnconstrained)+1,1)=modelSBML.species(i).boundaryCondition;
0378         <span class="keyword">if</span> strcmp(metaboliteIDs{end}(max(end-1,1):end),<span class="string">'_b'</span>)
0379             metaboliteUnconstrained(end)=1;
0380         <span class="keyword">end</span>
0381         
0382         <span class="comment">%Get the formula</span>
0383         <span class="keyword">if</span> max(underscoreIndex)&lt;length(modelSBML.species(i).name)
0384             metaboliteFormula{numel(metaboliteFormula)+1,1}=modelSBML.species(i).name(max(underscoreIndex)+1:length(modelSBML.species(i).name));
0385         <span class="keyword">else</span>
0386             metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0387         <span class="keyword">end</span>
0388         
0389         <span class="comment">%The old COBRA version sometimes has composition information in the</span>
0390         <span class="comment">%notes instead</span>
0391         <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'notes'</span>) &amp;&amp; ~isempty(<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'FORMULA'</span>))
0392             metaboliteFormula{numel(metaboliteFormula)+1,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'FORMULA'</span>);
0393         <span class="keyword">end</span>
0394         
0395         <span class="comment">%Get Miriam info</span>
0396         <span class="keyword">if</span> ~isempty(modelSBML.species(i).annotation)
0397             metMiriam=<a href="#_sub4" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.species(i).annotation);    
0398         <span class="keyword">else</span>
0399             metMiriam=[];
0400         <span class="keyword">end</span>
0401         metaboliteMiriams{numel(metaboliteMiriams)+1,1}=metMiriam;
0402         
0403         <span class="comment">%Get SBO term</span>
0404         <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'sboTerm'</span>) &amp;&amp; ~(modelSBML.species(i).sboTerm==-1)
0405             metSBOs(end+1,1) = modelSBML.species(i).sboTerm;
0406         <span class="keyword">end</span>
0407     <span class="keyword">end</span>
0408     <span class="comment">%The following lines are executed regardless isSBML2COBRA setting</span>
0409     <span class="keyword">if</span> isempty(modelSBML.species(i).id) || ~strcmpi(modelSBML.species(i).id(1:2),<span class="string">'E_'</span>)
0410         <span class="keyword">if</span> isempty(modelSBML.species(i).id) || ~strcmpi(modelSBML.species(i).id(1:3),<span class="string">'Cx_'</span>)
0411             <span class="comment">%Remove trailing [compartment] from metabolite name if present</span>
0412             metaboliteNames{<span class="keyword">end</span>,1}=regexprep(metaboliteNames{<span class="keyword">end</span>,1},regexCompNames,<span class="string">''</span>);
0413             metaboliteNames{<span class="keyword">end</span>,1}=regexprep(metaboliteNames{<span class="keyword">end</span>,1},<span class="string">'^M_'</span>,<span class="string">''</span>);
0414             <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'fbc_charge'</span>)
0415                 <span class="keyword">if</span> ~isempty(modelSBML.species(i).fbc_charge) &amp;&amp; modelSBML.species(i).isSetfbc_charge
0416                     metaboliteCharges(numel(metaboliteCharges)+1,1)=double(modelSBML.species(i).fbc_charge);
0417                 <span class="keyword">else</span>
0418                     <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'notes'</span>)
0419                         <span class="keyword">if</span> strfind(modelSBML.species(i).notes,<span class="string">'CHARGE'</span>)
0420                             metaboliteCharges(numel(metaboliteCharges)+1,1)=str2double(<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'CHARGE'</span>));
0421                         <span class="keyword">else</span>
0422                             metaboliteCharges(numel(metaboliteCharges)+1,1)=NaN;
0423                         <span class="keyword">end</span>
0424                     <span class="keyword">else</span>
0425                         metaboliteCharges(numel(metaboliteCharges)+1,1)=NaN;
0426                     <span class="keyword">end</span>
0427                 <span class="keyword">end</span>
0428             <span class="keyword">elseif</span> isfield(modelSBML.species(i),<span class="string">'notes'</span>)
0429                 <span class="keyword">if</span> strfind(modelSBML.species(i).notes,<span class="string">'CHARGE'</span>)
0430                     metaboliteCharges(numel(metaboliteCharges)+1,1)=str2double(<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'CHARGE'</span>));
0431                 <span class="keyword">else</span>
0432                     metaboliteCharges(numel(metaboliteCharges)+1,1)=NaN;
0433                 <span class="keyword">end</span>
0434             <span class="keyword">else</span>
0435                 metaboliteCharges(numel(metaboliteCharges)+1,1)=NaN;
0436             <span class="keyword">end</span>
0437             <span class="comment">%Additional information from FBC format Chemical formula</span>
0438             <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'fbc_chemicalFormula'</span>)
0439                 <span class="keyword">if</span> ~isempty(modelSBML.species(i).fbc_chemicalFormula)
0440                     metaboliteFormula{numel(metaboliteFormula),1}=modelSBML.species(i).fbc_chemicalFormula;
0441                 <span class="keyword">end</span>
0442             <span class="keyword">end</span>
0443         <span class="keyword">end</span>
0444     <span class="keyword">end</span>
0445 <span class="keyword">end</span>
0446 
0447 <span class="comment">%Add SBO terms to gene and metabolite miriam fields</span>
0448 <span class="keyword">if</span> numel(unique(geneSBOs)) &gt; 1  <span class="comment">% don't add if they're all identical</span>
0449     <span class="keyword">for</span> i = 1:numel(geneNames)
0450         geneMiriams{i} = <a href="#_sub5" class="code" title="subfunction miriam = addSBOtoMiriam(miriam,sboTerm)">addSBOtoMiriam</a>(geneMiriams{i},geneSBOs(i));
0451     <span class="keyword">end</span>
0452 <span class="keyword">end</span>
0453 <span class="keyword">if</span> numel(unique(metSBOs)) &gt; 1
0454     <span class="keyword">for</span> i = 1:numel(metaboliteNames)
0455         metaboliteMiriams{i} = <a href="#_sub5" class="code" title="subfunction miriam = addSBOtoMiriam(miriam,sboTerm)">addSBOtoMiriam</a>(metaboliteMiriams{i},metSBOs(i));
0456     <span class="keyword">end</span>
0457 <span class="keyword">end</span>
0458 
0459 <span class="comment">%Retrieve info on reactions</span>
0460 reactionNames=cell(numel(modelSBML.reaction),1);
0461 reactionIDs=cell(numel(modelSBML.reaction),1);
0462 subsystems=cell(numel(modelSBML.reaction),1);
0463 eccodes=cell(numel(modelSBML.reaction),1);
0464 eccodes(:,:)=cellstr(<span class="string">''</span>);
0465 rxnconfidencescores=NaN(numel(modelSBML.reaction),1);
0466 rxnreferences=cell(numel(modelSBML.reaction),1);
0467 rxnreferences(:,:)=cellstr(<span class="string">''</span>);
0468 rxnnotes=cell(numel(modelSBML.reaction),1);
0469 rxnnotes(:,:)=cellstr(<span class="string">''</span>);
0470 grRules=cell(numel(modelSBML.reaction),1);
0471 grRules(:,:)=cellstr(<span class="string">''</span>);
0472 grRulesFromModifier=grRules;
0473 rxnComps=zeros(numel(modelSBML.reaction),1);
0474 rxnMiriams=cell(numel(modelSBML.reaction),1);
0475 reactionReversibility=zeros(numel(modelSBML.reaction),1);
0476 reactionUB=zeros(numel(modelSBML.reaction),1);
0477 reactionLB=zeros(numel(modelSBML.reaction),1);
0478 reactionObjective=zeros(numel(modelSBML.reaction),1);
0479 
0480 <span class="comment">%Construct the stoichiometric matrix while the reaction info is read</span>
0481 S=zeros(numel(metaboliteIDs),numel(modelSBML.reaction));
0482 
0483 counter=0;
0484 <span class="comment">%If FBC, then bounds have parameter ids defined for the whole model</span>
0485 <span class="keyword">if</span> isfield(modelSBML,<span class="string">'parameter'</span>)
0486     parameter.name=cell(numel(modelSBML.parameter),1);
0487     parameter.name={modelSBML.parameter(:).id}';
0488     parameter.value={modelSBML.parameter(:).value}';
0489 <span class="keyword">end</span>
0490 
0491 <span class="keyword">if</span> isfield(modelSBML.reaction,<span class="string">'sboTerm'</span>) &amp;&amp; numel(unique([modelSBML.reaction.sboTerm])) == 1
0492     <span class="comment">%If all the SBO terms are identical, don't add them to rxnMiriams</span>
0493     modelSBML.reaction = rmfield(modelSBML.reaction,<span class="string">'sboTerm'</span>);
0494 <span class="keyword">end</span>
0495 
0496 <span class="keyword">for</span> i=1:numel(modelSBML.reaction)
0497     
0498     <span class="comment">%Check that the reaction doesn't produce a complex and nothing else. If</span>
0499     <span class="comment">%so, then jump to the next reaction. This is because I get the genes</span>
0500     <span class="comment">%for complexes from the names and not from the reactions that create</span>
0501     <span class="comment">%them. This only applies to the non-COBRA format</span>
0502     <span class="keyword">if</span> numel(modelSBML.reaction(i).product)==1
0503         <span class="keyword">if</span> length(modelSBML.reaction(i).product(1).species)&gt;=3
0504             <span class="keyword">if</span> strcmp(modelSBML.reaction(i).product(1).species(1:3),<span class="string">'Cx_'</span>)==true
0505                 <span class="keyword">continue</span>;
0506             <span class="keyword">end</span>
0507         <span class="keyword">end</span>
0508     <span class="keyword">end</span>
0509     
0510     <span class="comment">%It didn't look like a gene complex-forming reaction</span>
0511     counter=counter+1;
0512     
0513     reactionNames{counter}=modelSBML.reaction(i).name;
0514     
0515     reactionIDs{counter}=modelSBML.reaction(i).id;
0516     reactionReversibility(counter)=modelSBML.reaction(i).reversible;
0517     
0518     <span class="comment">%If model is FBC, first get parameter of bound and then replace it with</span>
0519     <span class="comment">%the correct value. Probably faster with replace(), but this was only</span>
0520     <span class="comment">%introduced in Matlab R2016b</span>
0521     <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'fbc_lowerFluxBound'</span>)
0522         lb=modelSBML.reaction(i).fbc_lowerFluxBound;
0523         ub=modelSBML.reaction(i).fbc_upperFluxBound;
0524         <span class="keyword">for</span> n=1:numel(parameter.value)
0525             lb=regexprep(lb,parameter.name(n),num2str(parameter.value{n}));
0526             ub=regexprep(ub,parameter.name(n),num2str(parameter.value{n}));
0527         <span class="keyword">end</span>
0528         <span class="keyword">if</span> isempty(lb)
0529             lb=<span class="string">'-Inf'</span>;
0530         <span class="keyword">end</span>
0531         <span class="keyword">if</span> isempty(ub)
0532             ub=<span class="string">'Inf'</span>;
0533         <span class="keyword">end</span>
0534         reactionLB(counter)=str2num(lb);
0535         reactionUB(counter)=str2num(ub);
0536         <span class="comment">%The order of these parameters should not be hard coded</span>
0537     <span class="keyword">elseif</span> isfield(modelSBML.reaction(i).kineticLaw,<span class="string">'parameter'</span>)
0538         reactionLB(counter)=modelSBML.reaction(i).kineticLaw.parameter(1).value;
0539         reactionUB(counter)=modelSBML.reaction(i).kineticLaw.parameter(2).value;
0540         reactionObjective(counter)=modelSBML.reaction(i).kineticLaw.parameter(3).value;
0541     <span class="keyword">else</span>
0542         <span class="keyword">if</span> reactionReversibility(counter)==true
0543             reactionLB(counter)=-inf;
0544         <span class="keyword">else</span>
0545             reactionLB(counter)=0;
0546         <span class="keyword">end</span>
0547         reactionUB(counter)=inf;
0548         reactionObjective(counter)=0;
0549     <span class="keyword">end</span>
0550     
0551     <span class="comment">%Find the associated gene if available</span>
0552     <span class="comment">%If FBC, get gene association data from corresponding fields</span>
0553     <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'fbc_geneProductAssociation'</span>)
0554         <span class="keyword">if</span> ~isempty(modelSBML.reaction(i).fbc_geneProductAssociation) &amp;&amp; ~isempty(modelSBML.reaction(i).fbc_geneProductAssociation.fbc_association)
0555             grRules{counter}=modelSBML.reaction(i).fbc_geneProductAssociation.fbc_association.fbc_association;
0556         <span class="keyword">end</span>
0557     <span class="keyword">elseif</span> isfield(modelSBML.reaction(i),<span class="string">'notes'</span>)
0558         <span class="comment">%This section was previously executed only if isSBML2COBRA is true. Now</span>
0559         <span class="comment">%it will be executed, if 'GENE_ASSOCIATION' is found in</span>
0560         <span class="comment">%modelSBML.reaction(i).notes</span>
0561         <span class="keyword">if</span> strfind(modelSBML.reaction(i).notes,<span class="string">'GENE_ASSOCIATION'</span>)
0562             geneAssociation=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'GENE_ASSOCIATION'</span>);
0563         <span class="keyword">elseif</span> strfind(modelSBML.reaction(i).notes,<span class="string">'GENE ASSOCIATION'</span>)
0564             geneAssociation=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'GENE ASSOCIATION'</span>);
0565         <span class="keyword">else</span>
0566             geneAssociation=<span class="string">''</span>;
0567         <span class="keyword">end</span>
0568         <span class="keyword">if</span> ~isempty(geneAssociation)
0569             <span class="comment">%This adds the grRules. The gene list and rxnGeneMat are created</span>
0570             <span class="comment">%later</span>
0571             grRules{counter}=geneAssociation;
0572         <span class="keyword">end</span>
0573     <span class="keyword">end</span>
0574     <span class="keyword">if</span> isempty(grRules{counter}) &amp;&amp; ~isempty(modelSBML.reaction(i).modifier)
0575         rules=<span class="string">''</span>;
0576         <span class="keyword">for</span> j=1:numel(modelSBML.reaction(i).modifier)
0577             modifier=modelSBML.reaction(i).modifier(j).species;
0578             <span class="keyword">if</span> ~isempty(modifier)
0579                 <span class="keyword">if</span> strcmpi(modifier(1:2),<span class="string">'E_'</span>)
0580                     index=find(strcmp(modifier,geneIDs));
0581                     <span class="comment">%This should be unique and in the geneIDs list,</span>
0582                     <span class="comment">%otherwise something is wrong</span>
0583                     <span class="keyword">if</span> numel(index)~=1
0584                         EM=[<span class="string">'Could not get the gene association data from reaction '</span> reactionIDs{i}];
0585                         dispEM(EM);
0586                     <span class="keyword">end</span>
0587                     <span class="keyword">if</span> ~isempty(rules)
0588                         rules=[rules <span class="string">' or ('</span> geneNames{index} <span class="string">')'</span>];
0589                     <span class="keyword">else</span>
0590                         rules=[<span class="string">'('</span> geneNames{index} <span class="string">')'</span>];
0591                     <span class="keyword">end</span>
0592                 <span class="keyword">elseif</span> strcmp(modifier(1:2),<span class="string">'s_'</span>)
0593                     index=find(strcmp(modifier,metaboliteIDs));
0594                     <span class="comment">%This should be unique and in the geneIDs list,</span>
0595                     <span class="comment">%otherwise something is wrong</span>
0596                     <span class="keyword">if</span> numel(index)~=1
0597                         EM=[<span class="string">'Could not get the gene association data from reaction '</span> reactionIDs{i}];
0598                         dispEM(EM);
0599                     <span class="keyword">end</span>
0600                     <span class="keyword">if</span> ~isempty(rules)
0601                         rules=[rules <span class="string">' or ('</span> metaboliteIDs{index} <span class="string">')'</span>];
0602                     <span class="keyword">else</span>
0603                         rules=[<span class="string">'('</span> metaboliteIDs{index} <span class="string">')'</span>];
0604                     <span class="keyword">end</span>
0605                 <span class="keyword">else</span>
0606                     <span class="comment">%It seems to be a complex. Add the corresponding</span>
0607                     <span class="comment">%genes from the name of the complex (not the</span>
0608                     <span class="comment">%reaction that creates it)</span>
0609                     index=find(strcmp(modifier,complexIDs));
0610                     <span class="keyword">if</span> numel(index)==1
0611                         <span class="keyword">if</span> ~isempty(rules)
0612                             rules=[rules <span class="string">' or ('</span> strrep(complexNames{index},<span class="string">':'</span>,<span class="string">' and '</span>) <span class="string">')'</span>];
0613                         <span class="keyword">else</span>
0614                             rules=[<span class="string">'('</span> strrep(complexNames{index},<span class="string">':'</span>,<span class="string">' and '</span>) <span class="string">')'</span>];
0615                         <span class="keyword">end</span>
0616                     <span class="keyword">else</span>
0617                         <span class="comment">%Could not find a complex</span>
0618                         EM=[<span class="string">'Could not get the gene association data from reaction '</span> reactionIDs{i}];
0619                         dispEM(EM);
0620                     <span class="keyword">end</span>
0621                 <span class="keyword">end</span>
0622             <span class="keyword">end</span>
0623         <span class="keyword">end</span>
0624         grRules{counter}=rules;
0625         grRulesFromModifier{counter}=rules;<span class="comment">%Backup copy for grRules, useful to parse Yeast 7.6</span>
0626     <span class="keyword">end</span>
0627     
0628     <span class="comment">%Add reaction compartment</span>
0629     <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'compartment'</span>)
0630         <span class="keyword">if</span> ~isempty(modelSBML.reaction(i).compartment)
0631             rxnComp=modelSBML.reaction(i).compartment;
0632         <span class="keyword">else</span>
0633             rxnComp=<span class="string">''</span>;
0634         <span class="keyword">end</span>
0635     <span class="keyword">elseif</span> isfield(modelSBML.reaction(i),<span class="string">'notes'</span>)
0636         rxnComp=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'COMPARTMENT'</span>);
0637     <span class="keyword">end</span>
0638     <span class="keyword">if</span> ~isempty(rxnComp)
0639         <span class="comment">%Find it in the compartment list</span>
0640         [~, J]=ismember(rxnComp,compartmentIDs);
0641         rxnComps(counter)=J;
0642     <span class="keyword">end</span>
0643     
0644     <span class="comment">%Get other Miriam fields. This may include for example database indexes</span>
0645     <span class="comment">%to organism-specific databases. EC-codes are supported by the COBRA</span>
0646     <span class="comment">%Toolbox format and are therefore loaded separately</span>
0647     <span class="keyword">if</span> isSBML2COBRA==false
0648         miriamStruct=<a href="#_sub4" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.reaction(i).annotation);
0649         rxnMiriams{counter}=miriamStruct;
0650         <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'notes'</span>)
0651             subsystems{counter,1}=cellstr(<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'SUBSYSTEM'</span>));
0652             subsystems{counter,1}(cellfun(<span class="string">'isempty'</span>,subsystems{counter,1})) = [];
0653             <span class="keyword">if</span> strfind(modelSBML.reaction(i).notes,<span class="string">'Confidence Level'</span>)
0654                 rxnconfidencescores(counter)=str2num(<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'Confidence Level'</span>));
0655             <span class="keyword">end</span>
0656             rxnreferences{counter,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'AUTHORS'</span>);
0657             rxnnotes{counter,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'NOTES'</span>);
0658         <span class="keyword">end</span>
0659     <span class="keyword">end</span>
0660     
0661     <span class="comment">%Get SBO terms</span>
0662     <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'sboTerm'</span>) &amp;&amp; ~(modelSBML.reaction(i).sboTerm==-1)
0663         rxnMiriams{counter} = <a href="#_sub5" class="code" title="subfunction miriam = addSBOtoMiriam(miriam,sboTerm)">addSBOtoMiriam</a>(rxnMiriams{counter}, modelSBML.reaction(i).sboTerm);
0664     <span class="keyword">end</span>
0665     
0666     <span class="comment">%Get ec-codes</span>
0667     eccode=<span class="string">''</span>;
0668     <span class="keyword">if</span> ~isempty(modelSBML.reaction(i).annotation)
0669         <span class="keyword">if</span> strfind(modelSBML.reaction(i).annotation,<span class="string">'urn:miriam:ec-code'</span>)
0670             eccode=<a href="#_sub3" class="code" title="subfunction fieldContent=parseAnnotation(searchString,startString,midString,fieldName)">parseAnnotation</a>(modelSBML.reaction(i).annotation,<span class="string">'urn:miriam:'</span>,<span class="string">':'</span>,<span class="string">'ec-code'</span>);
0671         <span class="keyword">elseif</span> strfind(modelSBML.reaction(i).annotation,<span class="string">'http://identifiers.org/ec-code'</span>)
0672             eccode=<a href="#_sub3" class="code" title="subfunction fieldContent=parseAnnotation(searchString,startString,midString,fieldName)">parseAnnotation</a>(modelSBML.reaction(i).annotation,<span class="string">'http://identifiers.org/'</span>,<span class="string">'/'</span>,<span class="string">'ec-code'</span>);
0673         <span class="keyword">elseif</span> strfind(modelSBML.reaction(i).annotation,<span class="string">'https://identifiers.org/ec-code'</span>)
0674             eccode=<a href="#_sub3" class="code" title="subfunction fieldContent=parseAnnotation(searchString,startString,midString,fieldName)">parseAnnotation</a>(modelSBML.reaction(i).annotation,<span class="string">'https://identifiers.org/'</span>,<span class="string">'/'</span>,<span class="string">'ec-code'</span>);
0675         <span class="keyword">end</span>
0676     <span class="keyword">elseif</span> isfield(modelSBML.reaction(i),<span class="string">'notes'</span>)
0677         <span class="keyword">if</span> strfind(modelSBML.reaction(i).notes,<span class="string">'EC Number'</span>)
0678             eccode=[eccode <a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'EC Number'</span>)];
0679         <span class="keyword">elseif</span> strfind(modelSBML.reaction(i).notes,<span class="string">'PROTEIN_CLASS'</span>)
0680             eccode=[eccode <a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'PROTEIN_CLASS'</span>)];
0681         <span class="keyword">end</span>
0682     <span class="keyword">end</span>
0683     eccodes{counter}=eccode;
0684     
0685     <span class="comment">%Add all reactants</span>
0686     <span class="keyword">for</span> j=1:numel(modelSBML.reaction(i).reactant)
0687         <span class="comment">%Get the index of the metabolite in metaboliteIDs. External</span>
0688         <span class="comment">%metabolites will be removed at a later stage</span>
0689         metIndex=find(strcmp(modelSBML.reaction(i).reactant(j).species,metaboliteIDs),1);
0690         <span class="keyword">if</span> isempty(metIndex)
0691             EM=[<span class="string">'Could not find metabolite '</span> modelSBML.reaction(i).reactant(j).species <span class="string">' in reaction '</span> reactionIDs{counter}];
0692             dispEM(EM);
0693         <span class="keyword">end</span>
0694         S(metIndex,counter)=S(metIndex,counter)+modelSBML.reaction(i).reactant(j).stoichiometry*-1;
0695     <span class="keyword">end</span>
0696     
0697     <span class="comment">%Add all products</span>
0698     <span class="keyword">for</span> j=1:numel(modelSBML.reaction(i).product)
0699         <span class="comment">%Get the index of the metabolite in metaboliteIDs.</span>
0700         metIndex=find(strcmp(modelSBML.reaction(i).product(j).species,metaboliteIDs),1);
0701         <span class="keyword">if</span> isempty(metIndex)
0702             EM=[<span class="string">'Could not find metabolite '</span> modelSBML.reaction(i).product(j).species <span class="string">' in reaction '</span> reactionIDs{counter}];
0703             dispEM(EM);
0704         <span class="keyword">end</span>
0705         S(metIndex,counter)=S(metIndex,counter)+modelSBML.reaction(i).product(j).stoichiometry;
0706     <span class="keyword">end</span>
0707 <span class="keyword">end</span>
0708 
0709 <span class="comment">%if FBC, objective function is separately defined. Multiple objective</span>
0710 <span class="comment">%functions can be defined, one is set as active</span>
0711 <span class="keyword">if</span> isfield(modelSBML, <span class="string">'fbc_activeObjective'</span>)
0712     obj=modelSBML.fbc_activeObjective;
0713     <span class="keyword">for</span> i=1:numel(modelSBML.fbc_objective)
0714         <span class="keyword">if</span> strcmp(obj,modelSBML.fbc_objective(i).fbc_id)
0715             <span class="keyword">if</span> ~isempty(modelSBML.fbc_objective(i).fbc_fluxObjective)
0716                 rxn=modelSBML.fbc_objective(i).fbc_fluxObjective.fbc_reaction;
0717                 rxn=regexprep(rxn,<span class="string">'^R_'</span>,<span class="string">''</span>);
0718                 idx=find(ismember(reactionIDs,rxn));
0719                 reactionObjective(idx)=modelSBML.fbc_objective(i).fbc_fluxObjective.fbc_coefficient;
0720             <span class="keyword">end</span>
0721         <span class="keyword">end</span>
0722     <span class="keyword">end</span>
0723 <span class="keyword">end</span>
0724 
0725 <span class="comment">%subSystems can be stored as groups instead of in annotations</span>
0726 <span class="keyword">if</span> isfield(modelSBML,<span class="string">'groups_group'</span>)
0727     <span class="keyword">for</span> i=1:numel(modelSBML.groups_group)
0728         groupreactions={modelSBML.groups_group(i).groups_member(:).groups_idRef};
0729         groupreactions=regexprep(groupreactions,<span class="string">'^R_'</span>,<span class="string">''</span>);
0730         [~, idx] = ismember(groupreactions, reactionIDs);
0731         <span class="keyword">if</span> any(idx)
0732             <span class="keyword">for</span> j=1:numel(idx)
0733                 <span class="keyword">if</span> isempty(subsystems{idx(j)}) <span class="comment">% First subsystem</span>
0734                     subsystems{idx(j)} = {modelSBML.groups_group(i).groups_name};
0735                 <span class="keyword">else</span> <span class="comment">% Consecutive subsystems: concatenate</span>
0736                     subsystems{idx(j)} = horzcat(subsystems{idx(j)}, modelSBML.groups_group(i).groups_name);
0737                 <span class="keyword">end</span>
0738             <span class="keyword">end</span>
0739         <span class="keyword">end</span>
0740     <span class="keyword">end</span>
0741 <span class="keyword">end</span>
0742 
0743 <span class="comment">%Shrink the structures if complex-forming reactions had to be skipped</span>
0744 reactionNames=reactionNames(1:counter);
0745 reactionIDs=reactionIDs(1:counter);
0746 subsystems=subsystems(1:counter);
0747 eccodes=eccodes(1:counter);
0748 rxnconfidencescores=rxnconfidencescores(1:counter);
0749 rxnreferences=rxnreferences(1:counter);
0750 rxnnotes=rxnnotes(1:counter);
0751 grRules=grRules(1:counter);
0752 rxnMiriams=rxnMiriams(1:counter);
0753 reactionReversibility=reactionReversibility(1:counter);
0754 reactionUB=reactionUB(1:counter);
0755 reactionLB=reactionLB(1:counter);
0756 reactionObjective=reactionObjective(1:counter);
0757 S=S(:,1:counter);
0758 
0759 model.name=modelSBML.name;
0760 model.id=regexprep(modelSBML.id,<span class="string">'^M_'</span>,<span class="string">''</span>); <span class="comment">% COBRA adds M_ prefix</span>
0761 model.rxns=reactionIDs;
0762 model.mets=metaboliteIDs;
0763 model.S=sparse(S);
0764 model.lb=reactionLB;
0765 model.ub=reactionUB;
0766 model.rev=reactionReversibility;
0767 model.c=reactionObjective;
0768 model.b=zeros(numel(metaboliteIDs),1);
0769 model.comps=compartmentIDs;
0770 model.compNames=compartmentNames;
0771 model.rxnConfidenceScores=rxnconfidencescores;
0772 model.rxnReferences=rxnreferences;
0773 model.rxnNotes=rxnnotes;
0774 
0775 <span class="comment">%Load annotation if available. If there are several authors, only the first</span>
0776 <span class="comment">%author credentials are imported</span>
0777 <span class="keyword">if</span> isfield(modelSBML,<span class="string">'annotation'</span>)
0778     endString=<span class="string">'&lt;/'</span>;
0779     I=strfind(modelSBML.annotation,endString);
0780     J=strfind(modelSBML.annotation,<span class="string">'&lt;vCard:Family&gt;'</span>);
0781     <span class="keyword">if</span> any(J)
0782         model.annotation.familyName=modelSBML.annotation(J(1)+14:I(find(I&gt;J(1),1))-1);
0783     <span class="keyword">end</span>
0784     J=strfind(modelSBML.annotation,<span class="string">'&lt;vCard:Given&gt;'</span>);
0785     <span class="keyword">if</span> any(J)
0786         model.annotation.givenName=modelSBML.annotation(J(1)+13:I(find(I&gt;J(1),1))-1);
0787     <span class="keyword">end</span>
0788     J=strfind(modelSBML.annotation,<span class="string">'&lt;vCard:EMAIL&gt;'</span>);
0789     <span class="keyword">if</span> any(J)
0790         model.annotation.email=modelSBML.annotation(J(1)+13:I(find(I&gt;J(1),1))-1);
0791     <span class="keyword">end</span>
0792     J=strfind(modelSBML.annotation,<span class="string">'&lt;vCard:Orgname&gt;'</span>);
0793     <span class="keyword">if</span> any(J)
0794         model.annotation.organization=modelSBML.annotation(J(1)+15:I(find(I&gt;J(1),1))-1);
0795     <span class="keyword">end</span>
0796     endString=<span class="string">'&quot;/&gt;'</span>;
0797     I=strfind(modelSBML.annotation,endString);
0798     <span class="keyword">if</span> strfind(modelSBML.annotation,<span class="string">'&quot;urn:miriam:'</span>)
0799         J=strfind(modelSBML.annotation,<span class="string">'&quot;urn:miriam:'</span>);
0800         <span class="keyword">if</span> any(J)
0801             model.annotation.taxonomy=modelSBML.annotation(J+12:I(find(I&gt;J,1))-1);
0802         <span class="keyword">end</span>
0803     <span class="keyword">else</span>
0804         J=strfind(modelSBML.annotation,<span class="string">'&quot;http://identifiers.org/'</span>);
0805         <span class="keyword">if</span> any(J)
0806             model.annotation.taxonomy=modelSBML.annotation(J+24:I(find(I&gt;J,1))-1);
0807         <span class="keyword">else</span>
0808             J=strfind(modelSBML.annotation,<span class="string">'&quot;https://identifiers.org/'</span>);
0809             <span class="keyword">if</span> any(J)
0810                 model.annotation.taxonomy=modelSBML.annotation(J+25:I(find(I&gt;J,1))-1);
0811             <span class="keyword">end</span>
0812         <span class="keyword">end</span>
0813     <span class="keyword">end</span>
0814 <span class="keyword">end</span>
0815 <span class="keyword">if</span> isfield(modelSBML,<span class="string">'notes'</span>)
0816     startString=strfind(modelSBML.notes,<span class="string">'xhtml&quot;&gt;'</span>);
0817     endString=strfind(modelSBML.notes,<span class="string">'&lt;/body&gt;'</span>);
0818     <span class="keyword">if</span> any(startString) &amp;&amp; any(endString)
0819         model.annotation.note=modelSBML.notes(startString+7:endString-1);
0820         model.annotation.note=regexprep(model.annotation.note,<span class="string">'&lt;p&gt;|&lt;/p&gt;'</span>,<span class="string">''</span>);
0821         model.annotation.note=strtrim(model.annotation.note);
0822     <span class="keyword">end</span>
0823 <span class="keyword">end</span>
0824 
0825 <span class="keyword">if</span> any(~cellfun(@isempty,compartmentOutside))
0826     model.compOutside=compartmentOutside;
0827 <span class="keyword">end</span>
0828 
0829 model.rxnNames=reactionNames;
0830 model.metNames=metaboliteNames;
0831 
0832 <span class="comment">%Match the compartments for metabolites</span>
0833 [~, J]=ismember(metaboliteCompartments,model.comps);
0834 model.metComps=J;
0835 
0836 <span class="comment">%If any genes have been loaded (only for the new format)</span>
0837 <span class="keyword">if</span> ~isempty(geneNames)
0838     <span class="comment">%In some rare cases geneNames may not necessarily be used in grRules.</span>
0839     <span class="comment">%That is true for Yeast 7.6. It's therefore important to change gene</span>
0840     <span class="comment">%systematic names to geneIDs in sophisticated way. Gene systematic</span>
0841     <span class="comment">%names are not unique, since exactly the same name may be in different</span>
0842     <span class="comment">%compartments</span>
0843     <span class="keyword">if</span> all(cellfun(@isempty,strfind(grRules,geneNames{1})))
0844         geneShortNames=geneNames;
0845         <span class="comment">%geneShortNames contain compartments as well, so these are removed</span>
0846         geneShortNames=regexprep(geneShortNames,<span class="string">' \[.+$'</span>,<span class="string">''</span>);
0847         <span class="comment">%grRules obtained from modifier fields contain geneNames. These are</span>
0848         <span class="comment">%changed into geneIDs. grRulesFromModifier is a good way to have</span>
0849         <span class="comment">%geneIDs and rxns association when it's important to resolve</span>
0850         <span class="comment">%systematic name ambiguities</span>
0851         grRulesFromModifier=regexprep(regexprep(grRulesFromModifier,<span class="string">'\[|\]'</span>,<span class="string">'_'</span>),regexprep(geneNames,<span class="string">'\[|\]'</span>,<span class="string">'_'</span>),geneIDs);
0852         grRules=regexprep(regexprep(grRules,<span class="string">'\[|\]'</span>,<span class="string">'_'</span>),regexprep(geneNames,<span class="string">'\[|\]'</span>,<span class="string">'_'</span>),geneIDs);
0853         
0854         <span class="comment">%Yeast 7.6 contains several metabolites, which were used in gene</span>
0855         <span class="comment">%associations. For that reason, the list of species ID is created</span>
0856         <span class="comment">%and we then check whether any of them have kegg.genes annotation</span>
0857         <span class="comment">%thereby obtaining systematic gene names</span>
0858         geneShortNames=vertcat(geneShortNames,metaboliteNames);
0859         geneIDs=vertcat(geneIDs,metaboliteIDs);
0860         geneSystNames=extractMiriam(vertcat(geneMiriams,metaboliteMiriams),<span class="string">'kegg.genes'</span>);
0861         geneCompartments=vertcat(geneCompartments,metaboliteCompartments);
0862         geneMiriams=vertcat(geneMiriams,metaboliteMiriams);
0863         
0864         <span class="comment">%Now we retain information for only these entries, which have</span>
0865         <span class="comment">%kegg.genes annotation</span>
0866         geneShortNames=geneShortNames(~cellfun(<span class="string">'isempty'</span>,geneSystNames));
0867         geneIDs=geneIDs(~cellfun(<span class="string">'isempty'</span>,geneSystNames));
0868         geneSystNames=geneSystNames(~cellfun(<span class="string">'isempty'</span>,geneSystNames));
0869         geneCompartments=geneCompartments(~cellfun(<span class="string">'isempty'</span>,geneSystNames));
0870         geneMiriams=geneMiriams(~cellfun(<span class="string">'isempty'</span>,geneSystNames));
0871         <span class="comment">%Now we reorder geneIDs and geneSystNames by geneSystNames string</span>
0872         <span class="comment">%length</span>
0873         geneNames=geneIDs;<span class="comment">%Backuping geneIDs, since we need unsorted order for later</span>
0874         [~, Indx] = sort(cellfun(<span class="string">'size'</span>, geneSystNames, 2), <span class="string">'descend'</span>);
0875         geneIDs = geneIDs(Indx);
0876         geneSystNames = geneSystNames(Indx);
0877         <span class="keyword">for</span> i=1:numel(geneSystNames)
0878             <span class="keyword">for</span> j=1:numel(grRules)
0879                 <span class="keyword">if</span> strfind(grRules{j},geneSystNames{i})
0880                     <span class="keyword">if</span> ~isempty(grRules{j})
0881                         <span class="keyword">if</span> sum(ismember(geneSystNames,geneSystNames{i}))==1
0882                             grRules{j}=regexprep(grRules{j},geneSystNames{i},geneIDs{i});
0883                         <span class="keyword">elseif</span> sum(ismember(geneSystNames,geneSystNames{i}))&gt;1
0884                             counter=0;
0885                             ovrlpIDs=geneIDs(ismember(geneSystNames,geneSystNames{i}));
0886                             <span class="keyword">for</span> k=1:numel(ovrlpIDs)
0887                                 <span class="keyword">if</span> strfind(grRulesFromModifier{j},ovrlpIDs{k})
0888                                     counter=counter+1;
0889                                     grRules{j}=regexprep(grRules{j},geneSystNames{i},ovrlpIDs{k});
0890                                 <span class="keyword">end</span>
0891                                 <span class="keyword">if</span> counter&gt;1
0892                                     EM=[<span class="string">'Gene association is ambiguous for reaction '</span> modelSBML.reaction(j).id];
0893                                     dispEM(EM);
0894                                 <span class="keyword">end</span>
0895                             <span class="keyword">end</span>
0896                         <span class="keyword">end</span>
0897                     <span class="keyword">end</span>
0898                 <span class="keyword">end</span>
0899             <span class="keyword">end</span>
0900         <span class="keyword">end</span>
0901     <span class="keyword">end</span>
0902     model.genes=geneNames;
0903     model.grRules=grRules;
0904     [grRules,rxnGeneMat] = standardizeGrRules(model,true);
0905     model.grRules = grRules;
0906     model.rxnGeneMat = rxnGeneMat;
0907     
0908     <span class="comment">%Match the compartments for genes</span>
0909     [~, J]=ismember(geneCompartments,model.comps);
0910     model.geneComps=J;
0911 <span class="keyword">else</span>
0912     <span class="keyword">if</span> ~all(cellfun(@isempty,grRules))
0913         <span class="comment">%If fbc_geneProduct exists, follow the specified gene order, such</span>
0914         <span class="comment">%that matching geneShortNames in function below will work</span>
0915         <span class="keyword">if</span> isfield(modelSBML,<span class="string">'fbc_geneProduct'</span>)
0916             genes={modelSBML.fbc_geneProduct.fbc_id};
0917             
0918             <span class="comment">%Get gene Miriams if they were not retrieved above (this occurs</span>
0919             <span class="comment">%when genes are stored as fbc_geneProduct instead of species)</span>
0920             <span class="keyword">if</span> isempty(geneMiriams)
0921                 geneMiriams = cell(numel(genes),1);
0922                 <span class="keyword">if</span> isfield(modelSBML.fbc_geneProduct,<span class="string">'sboTerm'</span>) &amp;&amp; numel(unique([modelSBML.fbc_geneProduct.sboTerm])) == 1
0923                     <span class="comment">%If all the SBO terms are identical, don't add them to geneMiriams</span>
0924                     modelSBML.fbc_geneProduct = rmfield(modelSBML.fbc_geneProduct,<span class="string">'sboTerm'</span>);
0925                 <span class="keyword">end</span>
0926                 <span class="keyword">for</span> i = 1:numel(genes)
0927                     geneMiriams{i}=<a href="#_sub4" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.fbc_geneProduct(i).annotation);
0928                     <span class="keyword">if</span> isfield(modelSBML.fbc_geneProduct(i),<span class="string">'sboTerm'</span>) &amp;&amp; ~(modelSBML.fbc_geneProduct(i).sboTerm==-1)
0929                         geneMiriams{i} = <a href="#_sub5" class="code" title="subfunction miriam = addSBOtoMiriam(miriam,sboTerm)">addSBOtoMiriam</a>(geneMiriams{i},modelSBML.fbc_geneProduct(i).sboTerm);
0930                     <span class="keyword">end</span>
0931                 <span class="keyword">end</span>
0932             <span class="keyword">end</span>
0933         <span class="keyword">else</span>
0934             genes=<a href="#_sub1" class="code" title="subfunction matchGenes=getGeneList(grRules)">getGeneList</a>(grRules);
0935         <span class="keyword">end</span>
0936         <span class="keyword">if</span> strcmpi(genes{1}(1:2),<span class="string">'G_'</span>)
0937             genes=regexprep(genes,<span class="string">'^G_'</span>,<span class="string">''</span>);
0938             grRules=regexprep(grRules,<span class="string">'^G_'</span>,<span class="string">''</span>);
0939             grRules=regexprep(grRules,<span class="string">'\(G_'</span>,<span class="string">'('</span>);
0940             grRules=regexprep(grRules,<span class="string">' G_'</span>,<span class="string">' '</span>);
0941         <span class="keyword">end</span>
0942         model.genes=genes;
0943         model.grRules=grRules;
0944         [grRules,rxnGeneMat] = standardizeGrRules(model,true);
0945         model.grRules = grRules;
0946         model.rxnGeneMat = rxnGeneMat;
0947     <span class="keyword">end</span>
0948 <span class="keyword">end</span>
0949 
0950 <span class="keyword">if</span> all(cellfun(@isempty,geneShortNames))
0951     <span class="keyword">if</span> isfield(modelSBML,<span class="string">'fbc_geneProduct'</span>)
0952         <span class="keyword">for</span> i=1:numel(genes)
0953             <span class="keyword">if</span> ~isempty(modelSBML.fbc_geneProduct(i).fbc_label)
0954                 geneShortNames{i,1}=modelSBML.fbc_geneProduct(i).fbc_label;
0955             <span class="keyword">elseif</span> ~isempty(modelSBML.fbc_geneProduct(i).fbc_name)
0956                 geneShortNames{i,1}=modelSBML.fbc_geneProduct(i).fbc_name;
0957             <span class="keyword">else</span>
0958                 geneShortNames{i,1}=<span class="string">''</span>;
0959             <span class="keyword">end</span>
0960         <span class="keyword">end</span>
0961     <span class="keyword">end</span>
0962 <span class="keyword">end</span>
0963 
0964 <span class="comment">%If any InChIs have been loaded</span>
0965 <span class="keyword">if</span> any(~cellfun(@isempty,metaboliteInChI))
0966     model.inchis=metaboliteInChI;
0967 <span class="keyword">end</span>
0968 
0969 <span class="comment">%If any formulas have been loaded</span>
0970 <span class="keyword">if</span> any(~cellfun(@isempty,metaboliteFormula))
0971     model.metFormulas=metaboliteFormula;
0972 <span class="keyword">end</span>
0973 
0974 <span class="comment">%If any charges have been loaded</span>
0975 <span class="keyword">if</span> ~isempty(metaboliteCharges)
0976     model.metCharges=metaboliteCharges;
0977 <span class="keyword">end</span>
0978 
0979 <span class="comment">%If any gene short names have been loaded</span>
0980 <span class="keyword">if</span> any(~cellfun(@isempty,geneShortNames))
0981     model.geneShortNames=geneShortNames;
0982 <span class="keyword">end</span>
0983 
0984 <span class="comment">%If any Miriam strings for compartments have been loaded</span>
0985 <span class="keyword">if</span> any(~cellfun(@isempty,compartmentMiriams))
0986     model.compMiriams=compartmentMiriams;
0987 <span class="keyword">end</span>
0988 
0989 <span class="comment">%If any Miriam strings for metabolites have been loaded</span>
0990 <span class="keyword">if</span> any(~cellfun(@isempty,metaboliteMiriams))
0991     model.metMiriams=metaboliteMiriams;
0992 <span class="keyword">end</span>
0993 
0994 <span class="comment">%If any subsystems have been loaded</span>
0995 <span class="keyword">if</span> any(~cellfun(@isempty,subsystems))
0996     model.subSystems=subsystems;
0997 <span class="keyword">end</span>
0998 <span class="keyword">if</span> any(rxnComps)
0999     <span class="keyword">if</span> all(rxnComps)
1000         model.rxnComps=rxnComps;
1001     <span class="keyword">else</span>
1002         <span class="keyword">if</span> supressWarnings==false
1003             EM=<span class="string">'The compartments for the following reactions could not be matched. Ignoring reaction compartment information'</span>;
1004             dispEM(EM,false,model.rxns(rxnComps==0));
1005         <span class="keyword">end</span>
1006     <span class="keyword">end</span>
1007 <span class="keyword">end</span>
1008 
1009 <span class="comment">%If any ec-codes have been loaded</span>
1010 <span class="keyword">if</span> any(~cellfun(@isempty,eccodes))
1011     model.eccodes=eccodes;
1012 <span class="keyword">end</span>
1013 
1014 <span class="comment">%If any Miriam strings for reactions have been loaded</span>
1015 <span class="keyword">if</span> any(~cellfun(@isempty,rxnMiriams))
1016     model.rxnMiriams=rxnMiriams;
1017 <span class="keyword">end</span>
1018 
1019 <span class="comment">%If any Miriam strings for genes have been loaded</span>
1020 <span class="keyword">if</span> any(~cellfun(@isempty,geneMiriams))
1021     model.geneMiriams=geneMiriams;
1022 <span class="keyword">end</span>
1023 
1024 model.unconstrained=metaboliteUnconstrained;
1025 
1026 <span class="comment">%Convert SBML IDs back into their original strings. Here we are using part</span>
1027 <span class="comment">%from convertSBMLID, originating from the COBRA Toolbox</span>
1028 model.rxns=regexprep(model.rxns,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
1029 model.mets=regexprep(model.mets,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
1030 model.comps=regexprep(model.comps,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
1031 model.grRules=regexprep(model.grRules,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
1032 model.genes=regexprep(model.genes,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
1033 model.id=regexprep(model.id,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
1034 
1035 <span class="comment">%Remove unused fields</span>
1036 <span class="keyword">if</span> isempty(model.annotation)
1037     model=rmfield(model,<span class="string">'annotation'</span>);
1038 <span class="keyword">end</span>
1039 <span class="keyword">if</span> isempty(model.compOutside)
1040     model=rmfield(model,<span class="string">'compOutside'</span>);
1041 <span class="keyword">end</span>
1042 <span class="keyword">if</span> isempty(model.compMiriams)
1043     model=rmfield(model,<span class="string">'compMiriams'</span>);
1044 <span class="keyword">end</span>
1045 <span class="keyword">if</span> isempty(model.rxnComps)
1046     model=rmfield(model,<span class="string">'rxnComps'</span>);
1047 <span class="keyword">end</span>
1048 <span class="keyword">if</span> isempty(model.grRules)
1049     model=rmfield(model,<span class="string">'grRules'</span>);
1050 <span class="keyword">end</span>
1051 <span class="keyword">if</span> isempty(model.rxnGeneMat)
1052     model=rmfield(model,<span class="string">'rxnGeneMat'</span>);
1053 <span class="keyword">end</span>
1054 <span class="keyword">if</span> isempty(model.subSystems)
1055     model=rmfield(model,<span class="string">'subSystems'</span>);
1056 <span class="keyword">else</span>
1057     model.subSystems(cellfun(@isempty,subsystems))={{<span class="string">''</span>}};
1058 <span class="keyword">end</span>
1059 <span class="keyword">if</span> isempty(model.eccodes)
1060     model=rmfield(model,<span class="string">'eccodes'</span>);
1061 <span class="keyword">end</span>
1062 <span class="keyword">if</span> isempty(model.rxnMiriams)
1063     model=rmfield(model,<span class="string">'rxnMiriams'</span>);
1064 <span class="keyword">end</span>
1065 <span class="keyword">if</span> cellfun(@isempty,model.rxnNotes)
1066     model=rmfield(model,<span class="string">'rxnNotes'</span>);
1067 <span class="keyword">end</span>
1068 <span class="keyword">if</span> cellfun(@isempty,model.rxnReferences)
1069     model=rmfield(model,<span class="string">'rxnReferences'</span>);
1070 <span class="keyword">end</span>
1071 <span class="keyword">if</span> isempty(model.rxnConfidenceScores) || all(isnan(model.rxnConfidenceScores))
1072     model=rmfield(model,<span class="string">'rxnConfidenceScores'</span>);
1073 <span class="keyword">end</span>
1074 <span class="keyword">if</span> isempty(model.genes)
1075     model=rmfield(model,<span class="string">'genes'</span>);
1076 <span class="keyword">elseif</span> isrow(model.genes)
1077     model.genes=transpose(model.genes);
1078 <span class="keyword">end</span>
1079 <span class="keyword">if</span> isempty(model.geneComps)
1080     model=rmfield(model,<span class="string">'geneComps'</span>);
1081 <span class="keyword">end</span>
1082 <span class="keyword">if</span> isempty(model.geneMiriams)
1083     model=rmfield(model,<span class="string">'geneMiriams'</span>);
1084 <span class="keyword">end</span>
1085 <span class="keyword">if</span> isempty(model.geneShortNames)
1086     model=rmfield(model,<span class="string">'geneShortNames'</span>);
1087 <span class="keyword">end</span>
1088 <span class="keyword">if</span> isempty(model.inchis)
1089     model=rmfield(model,<span class="string">'inchis'</span>);
1090 <span class="keyword">end</span>
1091 <span class="keyword">if</span> isempty(model.metFormulas)
1092     model=rmfield(model,<span class="string">'metFormulas'</span>);
1093 <span class="keyword">end</span>
1094 <span class="keyword">if</span> isempty(model.metMiriams)
1095     model=rmfield(model,<span class="string">'metMiriams'</span>);
1096 <span class="keyword">end</span>
1097 <span class="keyword">if</span> ~any(model.metCharges)
1098     model=rmfield(model,<span class="string">'metCharges'</span>);
1099 <span class="keyword">end</span>
1100 
1101 <span class="comment">%This just removes the grRules if no genes have been loaded</span>
1102 <span class="keyword">if</span> ~isfield(model,<span class="string">'genes'</span>) &amp;&amp; isfield(model,<span class="string">'grRules'</span>)
1103     model=rmfield(model,<span class="string">'grRules'</span>);
1104 <span class="keyword">end</span>
1105 
1106 <span class="comment">%Print warnings about bad structure</span>
1107 <span class="keyword">if</span> supressWarnings==false
1108     checkModelStruct(model,false);
1109 <span class="keyword">end</span>
1110 
1111 <span class="keyword">if</span> removeExcMets==true
1112     model=simplifyModel(model);
1113 <span class="keyword">end</span>
1114 <span class="keyword">end</span>
1115 
1116 <a name="_sub1" href="#_subfunctions" class="code">function matchGenes=getGeneList(grRules)</a>
1117 <span class="comment">%Constructs the list of unique genes from grRules</span>
1118 
1119 <span class="comment">%Assumes that everything that isn't a paranthesis, &quot; AND &quot; or &quot; or &quot; is a</span>
1120 <span class="comment">%gene name</span>
1121 genes=strrep(grRules,<span class="string">'('</span>,<span class="string">''</span>);
1122 genes=strrep(genes,<span class="string">')'</span>,<span class="string">''</span>);
1123 genes=strrep(genes,<span class="string">' or '</span>,<span class="string">' '</span>);
1124 genes=strrep(genes,<span class="string">' and '</span>,<span class="string">' '</span>);
1125 genes=strrep(genes,<span class="string">' OR '</span>,<span class="string">' '</span>);
1126 genes=strrep(genes,<span class="string">' AND '</span>,<span class="string">' '</span>);
1127 genes=regexp(genes,<span class="string">' '</span>,<span class="string">'split'</span>);
1128 
1129 allNames={};
1130 <span class="keyword">for</span> i=1:numel(genes)
1131     allNames=[allNames genes{i}];
1132 <span class="keyword">end</span>
1133 matchGenes=unique(allNames)';
1134 
1135 <span class="comment">%Remove the empty element if present</span>
1136 <span class="keyword">if</span> isempty(matchGenes{1})
1137     matchGenes(1)=[];
1138 <span class="keyword">end</span>
1139 <span class="keyword">end</span>
1140 
1141 <a name="_sub2" href="#_subfunctions" class="code">function fieldContent=parseNote(searchString,fieldName)</a>
1142 <span class="comment">%The function obtains the particular information from 'notes' field, using</span>
1143 <span class="comment">%fieldName as the dummy string</span>
1144 
1145 fieldContent=<span class="string">''</span>;
1146 
1147 <span class="keyword">if</span> strfind(searchString,fieldName)
1148     [~,targetString] = regexp(searchString,[<span class="string">'&lt;p&gt;'</span> fieldName <span class="string">'.*?&lt;/p&gt;'</span>],<span class="string">'tokens'</span>,<span class="string">'match'</span>);
1149     targetString=regexprep(targetString,<span class="string">'&lt;p&gt;|&lt;/p&gt;'</span>,<span class="string">''</span>);
1150     targetString=regexprep(targetString,[fieldName, <span class="string">':'</span>],<span class="string">''</span>);
1151     <span class="keyword">for</span> i=1:numel(targetString)
1152         fieldContent=[fieldContent <span class="string">';'</span> strtrim(targetString{1,i})];
1153     <span class="keyword">end</span>
1154     fieldContent=regexprep(fieldContent,<span class="string">'^;|;$'</span>,<span class="string">''</span>);
1155 <span class="keyword">else</span>
1156     fieldContent=<span class="string">''</span>;
1157 <span class="keyword">end</span>
1158 <span class="keyword">end</span>
1159 
1160 <a name="_sub3" href="#_subfunctions" class="code">function fieldContent=parseAnnotation(searchString,startString,midString,fieldName)</a>
1161 
1162 fieldContent=<span class="string">''</span>;
1163 
1164 <span class="comment">%Removing whitespace characters from the ending strings, which may occur in</span>
1165 <span class="comment">%several cases</span>
1166 searchString=regexprep(searchString,<span class="string">'&quot; /&gt;'</span>,<span class="string">'&quot;/&gt;'</span>);
1167 [~,targetString] = regexp(searchString,[<span class="string">'&lt;rdf:li rdf:resource=&quot;'</span> startString fieldName midString <span class="string">'.*?&quot;/&gt;'</span>],<span class="string">'tokens'</span>,<span class="string">'match'</span>);
1168 targetString=regexprep(targetString,<span class="string">'&lt;rdf:li rdf:resource=&quot;|&quot;/&gt;'</span>,<span class="string">''</span>);
1169 targetString=regexprep(targetString,startString,<span class="string">''</span>);
1170 targetString=regexprep(targetString,[fieldName midString],<span class="string">''</span>);
1171 
1172 <span class="keyword">for</span> i=1:numel(targetString)
1173     fieldContent=[fieldContent <span class="string">';'</span> strtrim(targetString{1,i})];
1174 <span class="keyword">end</span>
1175 
1176 fieldContent=regexprep(fieldContent,<span class="string">'^;|;$'</span>,<span class="string">''</span>);
1177 <span class="keyword">end</span>
1178 
1179 <a name="_sub4" href="#_subfunctions" class="code">function miriamStruct=parseMiriam(searchString)</a>
1180 <span class="comment">%Generates miriam structure from annotation field</span>
1181 
1182 <span class="comment">%Finding whether miriams are written in the old or the new way</span>
1183 <span class="keyword">if</span> strfind(searchString,<span class="string">'urn:miriam:'</span>)
1184     startString=<span class="string">'urn:miriam:'</span>;
1185     midString=<span class="string">':'</span>;
1186 <span class="keyword">elseif</span> strfind(searchString,<span class="string">'http://identifiers.org/'</span>)
1187     startString=<span class="string">'http://identifiers.org/'</span>;
1188     midString=<span class="string">'/'</span>;
1189 <span class="keyword">elseif</span> strfind(searchString,<span class="string">'https://identifiers.org/'</span>)
1190     startString=<span class="string">'https://identifiers.org/'</span>;
1191     midString=<span class="string">'/'</span>;
1192 <span class="keyword">else</span>
1193     miriamStruct=[];
1194     <span class="keyword">return</span>;
1195 <span class="keyword">end</span>
1196 
1197 miriamStruct=[];
1198 
1199 searchString=regexprep(searchString,<span class="string">'&quot; /&gt;'</span>,<span class="string">'&quot;/&gt;'</span>);
1200 [~,targetString] = regexp(searchString,<span class="string">'&lt;rdf:li rdf:resource=&quot;.*?&quot;/&gt;'</span>,<span class="string">'tokens'</span>,<span class="string">'match'</span>);
1201 targetString=regexprep(targetString,<span class="string">'&lt;rdf:li rdf:resource=&quot;|&quot;/&gt;'</span>,<span class="string">''</span>);
1202 targetString=regexprep(targetString,startString,<span class="string">''</span>);
1203 targetString=regexprep(targetString,midString,<span class="string">'/'</span>,<span class="string">'once'</span>);
1204 
1205 counter=0;
1206 <span class="keyword">for</span> i=1:numel(targetString)
1207     <span class="keyword">if</span> isempty(regexp(targetString{1,i},<span class="string">'inchi|ec-code'</span>, <span class="string">'once'</span>))
1208         counter=counter+1;
1209         miriamStruct.name{counter,1} = regexprep(targetString{1,i},<span class="string">'/.+'</span>,<span class="string">''</span>,<span class="string">'once'</span>);
1210         miriamStruct.value{counter,1} = regexprep(targetString{1,i},[miriamStruct.name{counter,1} <span class="string">'/'</span>],<span class="string">''</span>,<span class="string">'once'</span>);
1211         miriamStruct.name{counter,1} = regexprep(miriamStruct.name{counter,1},<span class="string">'^obo\.'</span>,<span class="string">''</span>);
1212     <span class="keyword">end</span>
1213 <span class="keyword">end</span>
1214 <span class="keyword">end</span>
1215 
1216 <a name="_sub5" href="#_subfunctions" class="code">function miriam = addSBOtoMiriam(miriam,sboTerm)</a>
1217 <span class="comment">%Appends SBO term to miriam structure</span>
1218 
1219 sboTerm = {[<span class="string">'SBO:'</span> sprintf(<span class="string">'%07u'</span>,sboTerm)]};  <span class="comment">% convert to proper format</span>
1220 <span class="keyword">if</span> isempty(miriam)
1221     miriam.name = {<span class="string">'sbo'</span>};
1222     miriam.value = sboTerm;
1223 <span class="keyword">elseif</span> any(strcmp(<span class="string">'sbo'</span>,miriam.name))
1224     currSbo = strcmp(<span class="string">'sbo'</span>,miriam.name);
1225     miriam.value(currSbo) = sboTerm;
1226 <span class="keyword">else</span>
1227     miriam.name(end+1) = {<span class="string">'sbo'</span>};
1228     miriam.value(end+1) = sboTerm;
1229 <span class="keyword">end</span>
1230 <span class="keyword">end</span></pre></div>
<hr><address>Generated by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>