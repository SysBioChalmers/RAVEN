<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of importModel</title>
  <meta name="keywords" content="importModel">
  <meta name="description" content="importModel">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">io</a> &gt; importModel.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for io&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>importModel
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>importModel</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function model=importModel(fileName,removeExcMets,COBRAstyle,supressWarnings) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> importModel
   Import a constraint-based model from a SBML file

 Input:
   fileName        a SBML file to import. A dialog window will open if
                   no file name is specified.
   removeExcMets   true if exchange metabolites should be removed. This is
                   needed to be able to run simulations, but it could also
                   be done using simplifyModel at a later stage (optional,
                   default true)
   COBRAstyle      true if the model uses COBRA style identifier prefixes
                   that should be removed when loading the model: G_ for
                   genes, R_ for reactions, M_ for metabolites, and C_ for
                   compartments. (optional, default false)
   supressWarnings true if warnings regarding the model structure should
                   be supressed (optional, default false)

 Output:
   model
       id               model ID
       name             name of model contents
       annotation       additional information about model
       rxns             reaction ids
       mets             metabolite ids
       S                stoichiometric matrix
       lb               lower bounds
       ub               upper bounds
       rev              reversibility vector
       c                objective coefficients
       b                equality constraints for the metabolite equations
       comps            compartment ids
       compNames        compartment names
       compOutside      the id (as in comps) for the compartment
                        surrounding each of the compartments
       compMiriams      structure with MIRIAM information about the
                        compartments
       rxnNames         reaction description
       rxnComps         compartments for reactions
       grRules          reaction to gene rules in text form
       rxnGeneMat       reaction-to-gene mapping in sparse matrix form
       subSystems       subsystem name for each reaction
       eccodes          EC-codes for the reactions
       rxnMiriams       structure with MIRIAM information about the reactions
       rxnNotes         reaction notes
       rxnReferences    reaction references
       rxnConfidenceScores reaction confidence scores
       genes            list of all genes
       geneComps        compartments for genes
       geneMiriams      structure with MIRIAM information about the genes
       geneShortNames   gene alternative names (e.g. ERG10)
       proteins     protein associated to each gene
       metNames         metabolite description
       metComps         compartments for metabolites
       inchis           InChI-codes for metabolites
       metFormulas      metabolite chemical formula
       metMiriams       structure with MIRIAM information about the metabolites
       metCharges       metabolite charge
       unconstrained    true if the metabolite is an exchange metabolite

 A number of consistency checks are performed in order to ensure that the
 model is valid. Take these warnings seriously and modify the model
 structure to solve them.

 Usage: model = importModel(fileName, removeExcMets, COBRAstyle, supressWarnings)</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="checkFileExistence.html" class="code" title="function files=checkFileExistence(files,fullOrTemp,allowSpace,checkExist)">checkFileExistence</a>	checkFileExistence</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function matchGenes=getGeneList(grRules)</a></li><li><a href="#_sub2" class="code">function fieldContent=parseNote(searchString,fieldName)</a></li><li><a href="#_sub3" class="code">function fieldContent=parseAnnotation(searchString,startString,midString,fieldName)</a></li><li><a href="#_sub4" class="code">function miriamStruct=parseMiriam(searchString)</a></li><li><a href="#_sub5" class="code">function miriam = addSBOtoMiriam(miriam,sboTerm)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function model=importModel(fileName,removeExcMets,COBRAstyle,supressWarnings)</a>
0002 <span class="comment">% importModel</span>
0003 <span class="comment">%   Import a constraint-based model from a SBML file</span>
0004 <span class="comment">%</span>
0005 <span class="comment">% Input:</span>
0006 <span class="comment">%   fileName        a SBML file to import. A dialog window will open if</span>
0007 <span class="comment">%                   no file name is specified.</span>
0008 <span class="comment">%   removeExcMets   true if exchange metabolites should be removed. This is</span>
0009 <span class="comment">%                   needed to be able to run simulations, but it could also</span>
0010 <span class="comment">%                   be done using simplifyModel at a later stage (optional,</span>
0011 <span class="comment">%                   default true)</span>
0012 <span class="comment">%   COBRAstyle      true if the model uses COBRA style identifier prefixes</span>
0013 <span class="comment">%                   that should be removed when loading the model: G_ for</span>
0014 <span class="comment">%                   genes, R_ for reactions, M_ for metabolites, and C_ for</span>
0015 <span class="comment">%                   compartments. (optional, default false)</span>
0016 <span class="comment">%   supressWarnings true if warnings regarding the model structure should</span>
0017 <span class="comment">%                   be supressed (optional, default false)</span>
0018 <span class="comment">%</span>
0019 <span class="comment">% Output:</span>
0020 <span class="comment">%   model</span>
0021 <span class="comment">%       id               model ID</span>
0022 <span class="comment">%       name             name of model contents</span>
0023 <span class="comment">%       annotation       additional information about model</span>
0024 <span class="comment">%       rxns             reaction ids</span>
0025 <span class="comment">%       mets             metabolite ids</span>
0026 <span class="comment">%       S                stoichiometric matrix</span>
0027 <span class="comment">%       lb               lower bounds</span>
0028 <span class="comment">%       ub               upper bounds</span>
0029 <span class="comment">%       rev              reversibility vector</span>
0030 <span class="comment">%       c                objective coefficients</span>
0031 <span class="comment">%       b                equality constraints for the metabolite equations</span>
0032 <span class="comment">%       comps            compartment ids</span>
0033 <span class="comment">%       compNames        compartment names</span>
0034 <span class="comment">%       compOutside      the id (as in comps) for the compartment</span>
0035 <span class="comment">%                        surrounding each of the compartments</span>
0036 <span class="comment">%       compMiriams      structure with MIRIAM information about the</span>
0037 <span class="comment">%                        compartments</span>
0038 <span class="comment">%       rxnNames         reaction description</span>
0039 <span class="comment">%       rxnComps         compartments for reactions</span>
0040 <span class="comment">%       grRules          reaction to gene rules in text form</span>
0041 <span class="comment">%       rxnGeneMat       reaction-to-gene mapping in sparse matrix form</span>
0042 <span class="comment">%       subSystems       subsystem name for each reaction</span>
0043 <span class="comment">%       eccodes          EC-codes for the reactions</span>
0044 <span class="comment">%       rxnMiriams       structure with MIRIAM information about the reactions</span>
0045 <span class="comment">%       rxnNotes         reaction notes</span>
0046 <span class="comment">%       rxnReferences    reaction references</span>
0047 <span class="comment">%       rxnConfidenceScores reaction confidence scores</span>
0048 <span class="comment">%       genes            list of all genes</span>
0049 <span class="comment">%       geneComps        compartments for genes</span>
0050 <span class="comment">%       geneMiriams      structure with MIRIAM information about the genes</span>
0051 <span class="comment">%       geneShortNames   gene alternative names (e.g. ERG10)</span>
0052 <span class="comment">%       proteins     protein associated to each gene</span>
0053 <span class="comment">%       metNames         metabolite description</span>
0054 <span class="comment">%       metComps         compartments for metabolites</span>
0055 <span class="comment">%       inchis           InChI-codes for metabolites</span>
0056 <span class="comment">%       metFormulas      metabolite chemical formula</span>
0057 <span class="comment">%       metMiriams       structure with MIRIAM information about the metabolites</span>
0058 <span class="comment">%       metCharges       metabolite charge</span>
0059 <span class="comment">%       unconstrained    true if the metabolite is an exchange metabolite</span>
0060 <span class="comment">%</span>
0061 <span class="comment">% A number of consistency checks are performed in order to ensure that the</span>
0062 <span class="comment">% model is valid. Take these warnings seriously and modify the model</span>
0063 <span class="comment">% structure to solve them.</span>
0064 <span class="comment">%</span>
0065 <span class="comment">% Usage: model = importModel(fileName, removeExcMets, COBRAstyle, supressWarnings)</span>
0066 
0067 <span class="keyword">if</span> nargin&lt;1 || isempty(fileName)
0068     [fileName, pathName] = uigetfile({<span class="string">'*.xml;*.sbml'</span>}, <span class="string">'Please select the model file'</span>);
0069     <span class="keyword">if</span> fileName == 0
0070         error(<span class="string">'You should select a model file'</span>)
0071     <span class="keyword">else</span>
0072         fileName = fullfile(pathName,fileName);
0073     <span class="keyword">end</span>
0074 <span class="keyword">end</span>
0075 fileName=char(fileName);
0076 <span class="keyword">if</span> nargin&lt;2 || isempty(removeExcMets)
0077     removeExcMets=true;
0078 <span class="keyword">end</span>
0079 
0080 <span class="keyword">if</span> nargin&lt;3 || isempty(COBRAstyle)
0081     COBRAstyle=false;
0082 <span class="keyword">end</span>
0083 
0084 <span class="keyword">if</span> nargin&lt;4
0085     supressWarnings=false;
0086 <span class="keyword">end</span>
0087 
0088 fileName=<a href="checkFileExistence.html" class="code" title="function files=checkFileExistence(files,fullOrTemp,allowSpace,checkExist)">checkFileExistence</a>(fileName,1);
0089 <span class="comment">% If path contains non-ASCII characters, copy file to tempdir first, as</span>
0090 <span class="comment">% libSBML is known to have problems with this on Windows:</span>
0091 <span class="comment">% https://sbml.org/software/libsbml/libsbml-docs/known-pitfalls/#matlab-on-windows-has-issues-with-unicode-filenames</span>
0092 <span class="keyword">if</span> ispc &amp;&amp; any(double(fileName)&gt;128)
0093     [~,originalFile,ext] = fileparts(fileName);
0094     tempFile = fullfile(tempdir,[originalFile ext]);
0095     copyfile(fileName,tempFile);
0096     fileName = tempFile;
0097 <span class="keyword">end</span>
0098 
0099 <span class="comment">%This is to match the order of the fields to those you get from importing</span>
0100 <span class="comment">%from Excel</span>
0101 model=[];
0102 model.id=[];
0103 model.name=[];
0104 model.annotation=[];
0105 model.rxns={};
0106 model.mets={};
0107 model.S=[];
0108 model.lb=[];
0109 model.ub=[];
0110 model.rev=[];
0111 model.c=[];
0112 model.b=[];
0113 model.comps={};
0114 model.compNames={};
0115 model.compOutside={};
0116 model.compMiriams={};
0117 model.rxnNames={};
0118 model.rxnComps=[];
0119 model.grRules={};
0120 model.rxnGeneMat=[];
0121 model.subSystems={};
0122 model.eccodes={};
0123 model.rxnMiriams={};
0124 model.rxnNotes={};
0125 model.rxnReferences={};
0126 model.rxnConfidenceScores=[];
0127 model.genes={};
0128 model.geneComps=[];
0129 model.geneMiriams={};
0130 model.geneShortNames={};
0131 model.proteins={};
0132 model.metNames={};
0133 model.metComps=[];
0134 model.inchis={};
0135 model.metFormulas={};
0136 model.metMiriams={};
0137 model.metCharges=[];
0138 model.unconstrained=[];
0139 
0140 <span class="comment">%Load the model using libSBML</span>
0141 [modelSBML,errorMsg] = TranslateSBML_RAVEN(fileName,0,0,[1 1]);
0142 <span class="keyword">if</span> exist(<span class="string">'tempFile'</span>,<span class="string">'var'</span>)
0143     delete(tempFile)
0144 <span class="keyword">end</span>
0145 
0146 <span class="keyword">if</span> isempty(modelSBML)
0147     EM=[<span class="string">'There is a problem with the SBML file. Try using the SBML Validator at http://sbml.org/Facilities/Validator.\nlibSBML reports: '</span>, errorMsg.message];
0148     dispEM(EM);
0149 <span class="keyword">end</span>
0150 
0151 <span class="comment">%Retrieve compartment names and IDs</span>
0152 compartmentNames=cell(numel(modelSBML.compartment),1);
0153 compartmentIDs=cell(numel(modelSBML.compartment),1);
0154 compartmentOutside=cell(numel(modelSBML.compartment),1);
0155 compartmentMiriams=cell(numel(modelSBML.compartment),1);
0156 
0157 <span class="keyword">if</span> isfield(modelSBML.compartment,<span class="string">'sboTerm'</span>) &amp;&amp; numel(unique([modelSBML.compartment.sboTerm])) == 1
0158     <span class="comment">%If all the SBO terms are identical, don't add them to compMiriams</span>
0159     modelSBML.compartment = rmfield(modelSBML.compartment,<span class="string">'sboTerm'</span>);
0160 <span class="keyword">end</span>
0161 
0162 <span class="keyword">for</span> i=1:numel(modelSBML.compartment)
0163     compartmentNames{i}=modelSBML.compartment(i).name;
0164     compartmentIDs{i}=modelSBML.compartment(i).id;
0165     <span class="keyword">if</span> isfield(modelSBML.compartment(i),<span class="string">'outside'</span>)
0166         <span class="keyword">if</span> ~isempty(modelSBML.compartment(i).outside)
0167             compartmentOutside{i}=modelSBML.compartment(i).outside;
0168         <span class="keyword">else</span>
0169             compartmentOutside{i}=<span class="string">''</span>;
0170         <span class="keyword">end</span>
0171     <span class="keyword">else</span>
0172         compartmentOutside{i}=[];
0173     <span class="keyword">end</span>
0174 
0175     <span class="keyword">if</span> isfield(modelSBML.compartment(i),<span class="string">'annotation'</span>)
0176         compartmentMiriams{i}=<a href="#_sub4" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.compartment(i).annotation);
0177     <span class="keyword">else</span>
0178         compartmentMiriams{i}=[];
0179     <span class="keyword">end</span>
0180 
0181     <span class="keyword">if</span> isfield(modelSBML.compartment(i),<span class="string">'sboTerm'</span>) &amp;&amp; ~(modelSBML.compartment(i).sboTerm==-1)
0182         compartmentMiriams{i} = <a href="#_sub5" class="code" title="subfunction miriam = addSBOtoMiriam(miriam,sboTerm)">addSBOtoMiriam</a>(compartmentMiriams{i},modelSBML.compartment(i).sboTerm);
0183     <span class="keyword">end</span>
0184 <span class="keyword">end</span>
0185 
0186 <span class="comment">%If there are no compartment names then use compartment id as name</span>
0187 <span class="keyword">if</span> all(cellfun(@isempty,compartmentNames))
0188     compartmentNames=compartmentIDs;
0189 <span class="keyword">end</span>
0190 
0191 <span class="comment">%Retrieve info on metabolites, genes, complexes</span>
0192 metaboliteNames={};
0193 metaboliteIDs={};
0194 metaboliteCompartments={};
0195 metaboliteUnconstrained=[];
0196 metaboliteFormula={};
0197 metaboliteInChI={};
0198 metaboliteMiriams={};
0199 metaboliteCharges=[];
0200 
0201 geneNames={};
0202 geneIDs={};
0203 geneMiriams={};
0204 geneShortNames={};
0205 proteins={};
0206 geneCompartments={};
0207 complexIDs={};
0208 complexNames={};
0209 
0210 <span class="comment">%If the file is not a COBRA Toolbox model. According to the format</span>
0211 <span class="comment">%specified in the yeast consensus model both metabolites and genes are a</span>
0212 <span class="comment">%type of 'species'. The metabolites have names starting with 'M_' and genes</span>
0213 <span class="comment">%with 'E_'</span>
0214 geneSBOs = [];
0215 metSBOs = [];
0216 <span class="comment">%Regex of compartment names, later to be used to remove from metabolite</span>
0217 <span class="comment">%names if present as suffix.</span>
0218 regexCompNames = [<span class="string">'\s?\[(('</span> strjoin({modelSBML.compartment.name},<span class="string">')|('</span>) <span class="string">'))\]$'</span>];
0219 <span class="keyword">for</span> i=1:numel(modelSBML.species)
0220     <span class="keyword">if</span> length(modelSBML.species(i).id)&gt;=2 &amp;&amp; strcmpi(modelSBML.species(i).id(1:2),<span class="string">'E_'</span>)
0221         geneNames{numel(geneNames)+1,1}=modelSBML.species(i).name;
0222 
0223         <span class="comment">%The &quot;E_&quot; is included in the ID. This is because it's only used</span>
0224         <span class="comment">%internally in this file and it makes the matching a little</span>
0225         <span class="comment">%smoother</span>
0226         geneIDs{numel(geneIDs)+1,1}=modelSBML.species(i).id;
0227         geneCompartments{numel(geneCompartments)+1,1}=modelSBML.species(i).compartment;
0228 
0229         <span class="comment">%Get Miriam structure</span>
0230         <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'annotation'</span>)
0231             <span class="comment">%Get Miriam info</span>
0232             geneMiriam=<a href="#_sub4" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.species(i).annotation);
0233             geneMiriams{numel(geneMiriams)+1,1}=geneMiriam;
0234         <span class="keyword">else</span>
0235             geneMiriams{numel(geneMiriams)+1,1}=[];
0236         <span class="keyword">end</span>
0237 
0238         <span class="comment">%Protein short names (for example ERG10) are saved as SHORT</span>
0239         <span class="comment">%NAME: NAME in the notes-section of metabolites for SBML Level</span>
0240         <span class="comment">%2 and as PROTEIN_ASSOCIATION for each reaction in SBML Level 2</span>
0241         <span class="comment">%COBRA Toolbox format. For now only the SHORT NAME is loaded</span>
0242         <span class="comment">%and no mapping takes place</span>
0243         <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'notes'</span>)
0244             geneShortNames{numel(geneShortNames)+1,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'SHORT NAME'</span>);
0245         <span class="keyword">else</span>
0246             geneShortNames{numel(geneShortNames)+1,1}=<span class="string">''</span>;
0247         <span class="keyword">end</span>
0248 
0249         <span class="comment">%Get SBO term</span>
0250         <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'sboTerm'</span>) &amp;&amp; ~(modelSBML.species(i).sboTerm==-1)
0251             geneSBOs(end+1,1) = modelSBML.species(i).sboTerm;
0252         <span class="keyword">end</span>
0253     <span class="keyword">elseif</span> length(modelSBML.species(i).id)&gt;=2 &amp;&amp; strcmpi(modelSBML.species(i).id(1:3),<span class="string">'Cx_'</span>)
0254         <span class="comment">%If it's a complex keep the ID and name</span>
0255         complexIDs=[complexIDs;modelSBML.species(i).id];
0256         complexNames=[complexNames;modelSBML.species(i).name];
0257     <span class="keyword">else</span>
0258         <span class="comment">%If it is not gene or complex, then it must be a metabolite</span>
0259         metaboliteNames{numel(metaboliteNames)+1,1}=modelSBML.species(i).name;
0260         metaboliteIDs{numel(metaboliteIDs)+1,1}=modelSBML.species(i).id;
0261         metaboliteCompartments{numel(metaboliteCompartments)+1,1}=modelSBML.species(i).compartment;
0262         metaboliteUnconstrained(numel(metaboliteUnconstrained)+1,1)=modelSBML.species(i).boundaryCondition;
0263 
0264         <span class="comment">%For each metabolite retrieve the formula and the InChI code if</span>
0265         <span class="comment">%available First add the InChI code and the formula from the</span>
0266         <span class="comment">%InChI. This allows for overwriting the formula by setting the</span>
0267         <span class="comment">%actual formula field</span>
0268         <span class="keyword">if</span> ~isempty(modelSBML.species(i).annotation)
0269             <span class="comment">%Get the formula if available</span>
0270             startString=<span class="string">'&gt;InChI='</span>;
0271             endString=<span class="string">'&lt;/in:inchi&gt;'</span>;
0272             formStart=strfind(modelSBML.species(i).annotation,startString);
0273             <span class="keyword">if</span> isempty(formStart)
0274                 startString=<span class="string">'InChI='</span>;
0275                 endString=<span class="string">'&quot;/&gt;'</span>;
0276             <span class="keyword">end</span>
0277             formStart=strfind(modelSBML.species(i).annotation,startString);
0278             <span class="keyword">if</span> ~isempty(formStart)
0279                 formEnd=strfind(modelSBML.species(i).annotation,endString);
0280                 formEndIndex=find(formEnd&gt;formStart, 1 );
0281                 formula=modelSBML.species(i).annotation(formStart+numel(startString):formEnd(formEndIndex)-1);
0282                 metaboliteInChI{numel(metaboliteInChI)+1,1}=formula;
0283 
0284                 <span class="comment">%The composition is most often present between the</span>
0285                 <span class="comment">%first and second &quot;/&quot; in the model. In some simple</span>
0286                 <span class="comment">%molecules, such as salts, there is no second &quot;/&quot;. The</span>
0287                 <span class="comment">%formula is then assumed to be to the end of the string</span>
0288                 compositionIndexes=strfind(formula,<span class="string">'/'</span>);
0289                 <span class="keyword">if</span> numel(compositionIndexes)&gt;1
0290                     metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="keyword">...</span>
0291                         formula(compositionIndexes(1)+1:compositionIndexes(2)-1);
0292                 <span class="keyword">else</span>
0293                     <span class="keyword">if</span> numel(compositionIndexes)==1
0294                         <span class="comment">%Probably a simple molecule which can have only</span>
0295                         <span class="comment">%one conformation</span>
0296                         metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="keyword">...</span>
0297                             formula(compositionIndexes(1)+1:numel(formula));
0298                     <span class="keyword">else</span>
0299                         metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0300                     <span class="keyword">end</span>
0301                 <span class="keyword">end</span>
0302             <span class="keyword">elseif</span> isfield(modelSBML.species(i),<span class="string">'fbc_chemicalFormula'</span>)
0303                 metaboliteInChI{numel(metaboliteInChI)+1,1}=<span class="string">''</span>;
0304                 <span class="keyword">if</span> ~isempty(modelSBML.species(i).fbc_chemicalFormula)
0305                     <span class="comment">%Cannot extract InChi from formula, so remains</span>
0306                     <span class="comment">%empty</span>
0307                     metaboliteFormula{numel(metaboliteFormula)+1,1}=modelSBML.species(i).fbc_chemicalFormula;
0308                 <span class="keyword">else</span>
0309                     metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0310                 <span class="keyword">end</span>
0311             <span class="keyword">else</span>
0312                 metaboliteInChI{numel(metaboliteInChI)+1,1}=<span class="string">''</span>;
0313                 metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0314             <span class="keyword">end</span>
0315 
0316             <span class="comment">%Get Miriam info</span>
0317             metMiriam=<a href="#_sub4" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.species(i).annotation);
0318             metaboliteMiriams{numel(metaboliteMiriams)+1,1}=metMiriam;
0319         <span class="keyword">else</span>
0320             metaboliteInChI{numel(metaboliteInChI)+1,1}=<span class="string">''</span>;
0321             <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'notes'</span>)
0322                 metaboliteFormula{numel(metaboliteFormula)+1,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'FORMULA'</span>);
0323             <span class="keyword">else</span>
0324                 metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0325             <span class="keyword">end</span>
0326             metaboliteMiriams{numel(metaboliteMiriams)+1,1}=[];
0327         <span class="keyword">end</span>
0328         <span class="keyword">if</span> ~isempty(modelSBML.species(i).notes)
0329             <span class="keyword">if</span> ~isfield(modelSBML.species(i),<span class="string">'annotation'</span>)
0330                 metaboliteFormula{numel(metaboliteFormula)+1,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'FORMULA'</span>);
0331             <span class="keyword">end</span>
0332         <span class="keyword">elseif</span> ~isfield(modelSBML.species(i),<span class="string">'annotation'</span>)
0333             metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0334         <span class="keyword">end</span>
0335         <span class="comment">%Get SBO term</span>
0336         <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'sboTerm'</span>) &amp;&amp; ~(modelSBML.species(i).sboTerm==-1)
0337             metSBOs(end+1,1) = modelSBML.species(i).sboTerm;
0338         <span class="keyword">end</span>
0339     <span class="keyword">end</span>
0340 
0341     <span class="comment">%The following lines are executed regardless isSBML2COBRA setting</span>
0342     <span class="keyword">if</span> isempty(modelSBML.species(i).id) || ~strcmpi(modelSBML.species(i).id(1:2),<span class="string">'E_'</span>)
0343         <span class="keyword">if</span> isempty(modelSBML.species(i).id) || ~strcmpi(modelSBML.species(i).id(1:3),<span class="string">'Cx_'</span>)
0344             <span class="comment">%Remove trailing [compartment] from metabolite name if present</span>
0345             metaboliteNames{<span class="keyword">end</span>,1}=regexprep(metaboliteNames{<span class="keyword">end</span>,1},regexCompNames,<span class="string">''</span>);
0346             metaboliteNames{<span class="keyword">end</span>,1}=metaboliteNames{<span class="keyword">end</span>,1};
0347             <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'fbc_charge'</span>)
0348                 <span class="keyword">if</span> ~isempty(modelSBML.species(i).fbc_charge) &amp;&amp; modelSBML.species(i).isSetfbc_charge
0349                     metaboliteCharges(numel(metaboliteCharges)+1,1)=double(modelSBML.species(i).fbc_charge);
0350                 <span class="keyword">else</span>
0351                     <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'notes'</span>)
0352                         <span class="keyword">if</span> strfind(modelSBML.species(i).notes,<span class="string">'CHARGE'</span>)
0353                             metaboliteCharges(numel(metaboliteCharges)+1,1)=str2double(<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'CHARGE'</span>));
0354                         <span class="keyword">else</span>
0355                             metaboliteCharges(numel(metaboliteCharges)+1,1)=NaN;
0356                         <span class="keyword">end</span>
0357                     <span class="keyword">else</span>
0358                         metaboliteCharges(numel(metaboliteCharges)+1,1)=NaN;
0359                     <span class="keyword">end</span>
0360                 <span class="keyword">end</span>
0361             <span class="keyword">elseif</span> isfield(modelSBML.species(i),<span class="string">'notes'</span>)
0362                 <span class="keyword">if</span> strfind(modelSBML.species(i).notes,<span class="string">'CHARGE'</span>)
0363                     metaboliteCharges(numel(metaboliteCharges)+1,1)=str2double(<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'CHARGE'</span>));
0364                 <span class="keyword">else</span>
0365                     metaboliteCharges(numel(metaboliteCharges)+1,1)=NaN;
0366                 <span class="keyword">end</span>
0367             <span class="keyword">else</span>
0368                 metaboliteCharges(numel(metaboliteCharges)+1,1)=NaN;
0369             <span class="keyword">end</span>
0370             <span class="comment">%Additional information from FBC format Chemical formula</span>
0371             <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'fbc_chemicalFormula'</span>)
0372                 <span class="keyword">if</span> ~isempty(modelSBML.species(i).fbc_chemicalFormula)
0373                     metaboliteFormula{numel(metaboliteFormula),1}=modelSBML.species(i).fbc_chemicalFormula;
0374                 <span class="keyword">end</span>
0375             <span class="keyword">end</span>
0376         <span class="keyword">end</span>
0377     <span class="keyword">end</span>
0378 <span class="keyword">end</span>
0379 
0380 <span class="comment">%Add SBO terms to gene and metabolite miriam fields</span>
0381 <span class="keyword">if</span> numel(unique(geneSBOs)) &gt; 1  <span class="comment">% don't add if they're all identical</span>
0382     <span class="keyword">for</span> i = 1:numel(geneNames)
0383         geneMiriams{i} = <a href="#_sub5" class="code" title="subfunction miriam = addSBOtoMiriam(miriam,sboTerm)">addSBOtoMiriam</a>(geneMiriams{i},geneSBOs(i));
0384     <span class="keyword">end</span>
0385 <span class="keyword">end</span>
0386 <span class="keyword">if</span> numel(unique(metSBOs)) &gt; 1
0387     <span class="keyword">for</span> i = 1:numel(metaboliteNames)
0388         metaboliteMiriams{i} = <a href="#_sub5" class="code" title="subfunction miriam = addSBOtoMiriam(miriam,sboTerm)">addSBOtoMiriam</a>(metaboliteMiriams{i},metSBOs(i));
0389     <span class="keyword">end</span>
0390 <span class="keyword">end</span>
0391 
0392 <span class="comment">%Retrieve info on reactions</span>
0393 reactionNames=cell(numel(modelSBML.reaction),1);
0394 reactionIDs=cell(numel(modelSBML.reaction),1);
0395 subsystems=cell(numel(modelSBML.reaction),1);
0396 eccodes=cell(numel(modelSBML.reaction),1);
0397 eccodes(:,:)=cellstr(<span class="string">''</span>);
0398 rxnconfidencescores=NaN(numel(modelSBML.reaction),1);
0399 rxnreferences=cell(numel(modelSBML.reaction),1);
0400 rxnreferences(:,:)=cellstr(<span class="string">''</span>);
0401 rxnnotes=cell(numel(modelSBML.reaction),1);
0402 rxnnotes(:,:)=cellstr(<span class="string">''</span>);
0403 grRules=cell(numel(modelSBML.reaction),1);
0404 grRules(:,:)=cellstr(<span class="string">''</span>);
0405 grRulesFromModifier=grRules;
0406 rxnComps=zeros(numel(modelSBML.reaction),1);
0407 rxnMiriams=cell(numel(modelSBML.reaction),1);
0408 reactionReversibility=zeros(numel(modelSBML.reaction),1);
0409 reactionUB=zeros(numel(modelSBML.reaction),1);
0410 reactionLB=zeros(numel(modelSBML.reaction),1);
0411 reactionObjective=zeros(numel(modelSBML.reaction),1);
0412 
0413 <span class="comment">%Construct the stoichiometric matrix while the reaction info is read</span>
0414 S=zeros(numel(metaboliteIDs),numel(modelSBML.reaction));
0415 
0416 counter=0;
0417 <span class="comment">%If FBC, then bounds have parameter ids defined for the whole model</span>
0418 <span class="keyword">if</span> isfield(modelSBML,<span class="string">'parameter'</span>)
0419     parameter.name=cell(numel(modelSBML.parameter),1);
0420     parameter.name={modelSBML.parameter(:).id}';
0421     parameter.value={modelSBML.parameter(:).value}';
0422 <span class="keyword">end</span>
0423 
0424 <span class="keyword">if</span> isfield(modelSBML.reaction,<span class="string">'sboTerm'</span>) &amp;&amp; numel(unique([modelSBML.reaction.sboTerm])) == 1
0425     <span class="comment">%If all the SBO terms are identical, don't add them to rxnMiriams</span>
0426     modelSBML.reaction = rmfield(modelSBML.reaction,<span class="string">'sboTerm'</span>);
0427 <span class="keyword">end</span>
0428 
0429 <span class="keyword">for</span> i=1:numel(modelSBML.reaction)
0430 
0431     <span class="comment">%Check that the reaction doesn't produce a complex and nothing else. If</span>
0432     <span class="comment">%so, then jump to the next reaction. This is because I get the genes</span>
0433     <span class="comment">%for complexes from the names and not from the reactions that create</span>
0434     <span class="comment">%them. This only applies to the non-COBRA format</span>
0435     <span class="keyword">if</span> numel(modelSBML.reaction(i).product)==1
0436         <span class="keyword">if</span> length(modelSBML.reaction(i).product(1).species)&gt;=3
0437             <span class="keyword">if</span> strcmp(modelSBML.reaction(i).product(1).species(1:3),<span class="string">'Cx_'</span>)==true
0438                 <span class="keyword">continue</span>;
0439             <span class="keyword">end</span>
0440         <span class="keyword">end</span>
0441     <span class="keyword">end</span>
0442 
0443     <span class="comment">%It didn't look like a gene complex-forming reaction</span>
0444     counter=counter+1;
0445 
0446     reactionNames{counter}=modelSBML.reaction(i).name;
0447 
0448     reactionIDs{counter}=modelSBML.reaction(i).id;
0449     reactionReversibility(counter)=modelSBML.reaction(i).reversible;
0450 
0451     <span class="comment">%If model is FBC, first get parameter of bound and then replace it with</span>
0452     <span class="comment">%the correct value. Probably faster with replace(), but this was only</span>
0453     <span class="comment">%introduced in Matlab R2016b</span>
0454     <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'fbc_lowerFluxBound'</span>)
0455         lb=modelSBML.reaction(i).fbc_lowerFluxBound;
0456         ub=modelSBML.reaction(i).fbc_upperFluxBound;
0457         <span class="keyword">for</span> n=1:numel(parameter.value)
0458             lb=regexprep(lb,parameter.name(n),num2str(parameter.value{n}));
0459             ub=regexprep(ub,parameter.name(n),num2str(parameter.value{n}));
0460         <span class="keyword">end</span>
0461         <span class="keyword">if</span> isempty(lb)
0462             lb=<span class="string">'-Inf'</span>;
0463         <span class="keyword">end</span>
0464         <span class="keyword">if</span> isempty(ub)
0465             ub=<span class="string">'Inf'</span>;
0466         <span class="keyword">end</span>
0467         reactionLB(counter)=str2num(lb);
0468         reactionUB(counter)=str2num(ub);
0469         <span class="comment">%The order of these parameters should not be hard coded</span>
0470     <span class="keyword">elseif</span> isfield(modelSBML.reaction(i).kineticLaw,<span class="string">'parameter'</span>)
0471         reactionLB(counter)=modelSBML.reaction(i).kineticLaw.parameter(1).value;
0472         reactionUB(counter)=modelSBML.reaction(i).kineticLaw.parameter(2).value;
0473         reactionObjective(counter)=modelSBML.reaction(i).kineticLaw.parameter(3).value;
0474     <span class="keyword">else</span>
0475         <span class="keyword">if</span> reactionReversibility(counter)==true
0476             reactionLB(counter)=-inf;
0477         <span class="keyword">else</span>
0478             reactionLB(counter)=0;
0479         <span class="keyword">end</span>
0480         reactionUB(counter)=inf;
0481         reactionObjective(counter)=0;
0482     <span class="keyword">end</span>
0483 
0484     <span class="comment">%Find the associated gene if available</span>
0485     <span class="comment">%If FBC, get gene association data from corresponding fields</span>
0486     <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'fbc_geneProductAssociation'</span>)
0487         <span class="keyword">if</span> ~isempty(modelSBML.reaction(i).fbc_geneProductAssociation) &amp;&amp; ~isempty(modelSBML.reaction(i).fbc_geneProductAssociation.fbc_association)
0488             grRules{counter}=modelSBML.reaction(i).fbc_geneProductAssociation.fbc_association.fbc_association;
0489         <span class="keyword">end</span>
0490     <span class="keyword">elseif</span> isfield(modelSBML.reaction(i),<span class="string">'notes'</span>)
0491         <span class="comment">%This section was previously executed only if isSBML2COBRA is true. Now</span>
0492         <span class="comment">%it will be executed, if 'GENE_ASSOCIATION' is found in</span>
0493         <span class="comment">%modelSBML.reaction(i).notes</span>
0494         <span class="keyword">if</span> strfind(modelSBML.reaction(i).notes,<span class="string">'GENE_ASSOCIATION'</span>)
0495             geneAssociation=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'GENE_ASSOCIATION'</span>);
0496         <span class="keyword">elseif</span> strfind(modelSBML.reaction(i).notes,<span class="string">'GENE ASSOCIATION'</span>)
0497             geneAssociation=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'GENE ASSOCIATION'</span>);
0498         <span class="keyword">else</span>
0499             geneAssociation=<span class="string">''</span>;
0500         <span class="keyword">end</span>
0501         <span class="keyword">if</span> ~isempty(geneAssociation)
0502             <span class="comment">%This adds the grRules. The gene list and rxnGeneMat are created</span>
0503             <span class="comment">%later</span>
0504             grRules{counter}=geneAssociation;
0505         <span class="keyword">end</span>
0506     <span class="keyword">end</span>
0507     <span class="keyword">if</span> isempty(grRules{counter}) &amp;&amp; ~isempty(modelSBML.reaction(i).modifier)
0508         rules=<span class="string">''</span>;
0509         <span class="keyword">for</span> j=1:numel(modelSBML.reaction(i).modifier)
0510             modifier=modelSBML.reaction(i).modifier(j).species;
0511             <span class="keyword">if</span> ~isempty(modifier)
0512                 <span class="keyword">if</span> strcmpi(modifier(1:2),<span class="string">'E_'</span>)
0513                     index=find(strcmp(modifier,geneIDs));
0514                     <span class="comment">%This should be unique and in the geneIDs list,</span>
0515                     <span class="comment">%otherwise something is wrong</span>
0516                     <span class="keyword">if</span> numel(index)~=1
0517                         EM=[<span class="string">'Could not get the gene association data from reaction '</span> reactionIDs{i}];
0518                         dispEM(EM);
0519                     <span class="keyword">end</span>
0520                     <span class="keyword">if</span> ~isempty(rules)
0521                         rules=[rules <span class="string">' or ('</span> geneNames{index} <span class="string">')'</span>];
0522                     <span class="keyword">else</span>
0523                         rules=[<span class="string">'('</span> geneNames{index} <span class="string">')'</span>];
0524                     <span class="keyword">end</span>
0525                 <span class="keyword">elseif</span> strcmp(modifier(1:2),<span class="string">'s_'</span>)
0526                     index=find(strcmp(modifier,metaboliteIDs));
0527                     <span class="comment">%This should be unique and in the geneIDs list,</span>
0528                     <span class="comment">%otherwise something is wrong</span>
0529                     <span class="keyword">if</span> numel(index)~=1
0530                         EM=[<span class="string">'Could not get the gene association data from reaction '</span> reactionIDs{i}];
0531                         dispEM(EM);
0532                     <span class="keyword">end</span>
0533                     <span class="keyword">if</span> ~isempty(rules)
0534                         rules=[rules <span class="string">' or ('</span> metaboliteIDs{index} <span class="string">')'</span>];
0535                     <span class="keyword">else</span>
0536                         rules=[<span class="string">'('</span> metaboliteIDs{index} <span class="string">')'</span>];
0537                     <span class="keyword">end</span>
0538                 <span class="keyword">else</span>
0539                     <span class="comment">%It seems to be a complex. Add the corresponding</span>
0540                     <span class="comment">%genes from the name of the complex (not the</span>
0541                     <span class="comment">%reaction that creates it)</span>
0542                     index=find(strcmp(modifier,complexIDs));
0543                     <span class="keyword">if</span> numel(index)==1
0544                         <span class="keyword">if</span> ~isempty(rules)
0545                             rules=[rules <span class="string">' or ('</span> strrep(complexNames{index},<span class="string">':'</span>,<span class="string">' and '</span>) <span class="string">')'</span>];
0546                         <span class="keyword">else</span>
0547                             rules=[<span class="string">'('</span> strrep(complexNames{index},<span class="string">':'</span>,<span class="string">' and '</span>) <span class="string">')'</span>];
0548                         <span class="keyword">end</span>
0549                     <span class="keyword">else</span>
0550                         <span class="comment">%Could not find a complex</span>
0551                         EM=[<span class="string">'Could not get the gene association data from reaction '</span> reactionIDs{i}];
0552                         dispEM(EM);
0553                     <span class="keyword">end</span>
0554                 <span class="keyword">end</span>
0555             <span class="keyword">end</span>
0556         <span class="keyword">end</span>
0557         grRules{counter}=rules;
0558         grRulesFromModifier{counter}=rules;<span class="comment">%Backup copy for grRules, useful to parse Yeast 7.6</span>
0559     <span class="keyword">end</span>
0560 
0561     <span class="comment">%Add reaction compartment</span>
0562     <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'compartment'</span>)
0563         <span class="keyword">if</span> ~isempty(modelSBML.reaction(i).compartment)
0564             rxnComp=modelSBML.reaction(i).compartment;
0565         <span class="keyword">else</span>
0566             rxnComp=<span class="string">''</span>;
0567         <span class="keyword">end</span>
0568     <span class="keyword">elseif</span> isfield(modelSBML.reaction(i),<span class="string">'notes'</span>)
0569         rxnComp=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'COMPARTMENT'</span>);
0570     <span class="keyword">end</span>
0571     <span class="keyword">if</span> ~isempty(rxnComp)
0572         <span class="comment">%Find it in the compartment list</span>
0573         [~, J]=ismember(rxnComp,compartmentIDs);
0574         rxnComps(counter)=J;
0575     <span class="keyword">end</span>
0576 
0577 
0578     miriamStruct=<a href="#_sub4" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.reaction(i).annotation);
0579     rxnMiriams{counter}=miriamStruct;
0580     <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'notes'</span>)
0581         subsystems{counter,1}=cellstr(<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'SUBSYSTEM'</span>));
0582         subsystems{counter,1}(cellfun(<span class="string">'isempty'</span>,subsystems{counter,1})) = [];
0583         <span class="keyword">if</span> strfind(modelSBML.reaction(i).notes,<span class="string">'Confidence Level'</span>)
0584             confScore = <a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'Confidence Level'</span>);
0585             <span class="keyword">if</span> isempty(confScore)
0586                 confScore = 0;
0587             <span class="keyword">end</span>
0588             rxnconfidencescores(counter)=str2double(confScore);
0589         <span class="keyword">end</span>
0590         rxnreferences{counter,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'AUTHORS'</span>);
0591         rxnnotes{counter,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'NOTES'</span>);
0592     <span class="keyword">end</span>
0593 
0594     <span class="comment">%Get SBO terms</span>
0595     <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'sboTerm'</span>) &amp;&amp; ~(modelSBML.reaction(i).sboTerm==-1)
0596         rxnMiriams{counter} = <a href="#_sub5" class="code" title="subfunction miriam = addSBOtoMiriam(miriam,sboTerm)">addSBOtoMiriam</a>(rxnMiriams{counter}, modelSBML.reaction(i).sboTerm);
0597     <span class="keyword">end</span>
0598 
0599     <span class="comment">%Get ec-codes</span>
0600     eccode=<span class="string">''</span>;
0601     <span class="keyword">if</span> ~isempty(modelSBML.reaction(i).annotation)
0602         <span class="keyword">if</span> strfind(modelSBML.reaction(i).annotation,<span class="string">'urn:miriam:ec-code'</span>)
0603             eccode=<a href="#_sub3" class="code" title="subfunction fieldContent=parseAnnotation(searchString,startString,midString,fieldName)">parseAnnotation</a>(modelSBML.reaction(i).annotation,<span class="string">'urn:miriam:'</span>,<span class="string">':'</span>,<span class="string">'ec-code'</span>);
0604         <span class="keyword">elseif</span> strfind(modelSBML.reaction(i).annotation,<span class="string">'http://identifiers.org/ec-code'</span>)
0605             eccode=<a href="#_sub3" class="code" title="subfunction fieldContent=parseAnnotation(searchString,startString,midString,fieldName)">parseAnnotation</a>(modelSBML.reaction(i).annotation,<span class="string">'http://identifiers.org/'</span>,<span class="string">'/'</span>,<span class="string">'ec-code'</span>);
0606         <span class="keyword">elseif</span> strfind(modelSBML.reaction(i).annotation,<span class="string">'https://identifiers.org/ec-code'</span>)
0607             eccode=<a href="#_sub3" class="code" title="subfunction fieldContent=parseAnnotation(searchString,startString,midString,fieldName)">parseAnnotation</a>(modelSBML.reaction(i).annotation,<span class="string">'https://identifiers.org/'</span>,<span class="string">'/'</span>,<span class="string">'ec-code'</span>);
0608         <span class="keyword">end</span>
0609     <span class="keyword">elseif</span> isfield(modelSBML.reaction(i),<span class="string">'notes'</span>)
0610         <span class="keyword">if</span> strfind(modelSBML.reaction(i).notes,<span class="string">'EC Number'</span>)
0611             eccode=[eccode <a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'EC Number'</span>)];
0612         <span class="keyword">elseif</span> strfind(modelSBML.reaction(i).notes,<span class="string">'PROTEIN_CLASS'</span>)
0613             eccode=[eccode <a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'PROTEIN_CLASS'</span>)];
0614         <span class="keyword">end</span>
0615     <span class="keyword">end</span>
0616     eccodes{counter}=eccode;
0617 
0618     <span class="comment">%Add all reactants</span>
0619     <span class="keyword">for</span> j=1:numel(modelSBML.reaction(i).reactant)
0620         <span class="comment">%Get the index of the metabolite in metaboliteIDs. External</span>
0621         <span class="comment">%metabolites will be removed at a later stage</span>
0622         metIndex=find(strcmp(modelSBML.reaction(i).reactant(j).species,metaboliteIDs),1);
0623         <span class="keyword">if</span> isempty(metIndex)
0624             EM=[<span class="string">'Could not find metabolite '</span> modelSBML.reaction(i).reactant(j).species <span class="string">' in reaction '</span> reactionIDs{counter}];
0625             dispEM(EM);
0626         <span class="keyword">end</span>
0627         S(metIndex,counter)=S(metIndex,counter)+modelSBML.reaction(i).reactant(j).stoichiometry*-1;
0628     <span class="keyword">end</span>
0629 
0630     <span class="comment">%Add all products</span>
0631     <span class="keyword">for</span> j=1:numel(modelSBML.reaction(i).product)
0632         <span class="comment">%Get the index of the metabolite in metaboliteIDs.</span>
0633         metIndex=find(strcmp(modelSBML.reaction(i).product(j).species,metaboliteIDs),1);
0634         <span class="keyword">if</span> isempty(metIndex)
0635             EM=[<span class="string">'Could not find metabolite '</span> modelSBML.reaction(i).product(j).species <span class="string">' in reaction '</span> reactionIDs{counter}];
0636             dispEM(EM);
0637         <span class="keyword">end</span>
0638         S(metIndex,counter)=S(metIndex,counter)+modelSBML.reaction(i).product(j).stoichiometry;
0639     <span class="keyword">end</span>
0640 <span class="keyword">end</span>
0641 
0642 <span class="comment">%if FBC, objective function is separately defined. Multiple objective</span>
0643 <span class="comment">%functions can be defined, one is set as active</span>
0644 <span class="keyword">if</span> isfield(modelSBML, <span class="string">'fbc_activeObjective'</span>)
0645     obj=modelSBML.fbc_activeObjective;
0646     <span class="keyword">for</span> i=1:numel(modelSBML.fbc_objective)
0647         <span class="keyword">if</span> strcmp(obj,modelSBML.fbc_objective(i).fbc_id)
0648             <span class="keyword">if</span> ~isempty(modelSBML.fbc_objective(i).fbc_fluxObjective)
0649                 rxn=modelSBML.fbc_objective(i).fbc_fluxObjective.fbc_reaction;
0650                 idx=find(ismember(reactionIDs,rxn));
0651                 reactionObjective(idx)=modelSBML.fbc_objective(i).fbc_fluxObjective.fbc_coefficient;
0652             <span class="keyword">end</span>
0653         <span class="keyword">end</span>
0654     <span class="keyword">end</span>
0655 <span class="keyword">end</span>
0656 
0657 <span class="comment">%subSystems can be stored as groups instead of in annotations</span>
0658 <span class="keyword">if</span> isfield(modelSBML,<span class="string">'groups_group'</span>)
0659     <span class="keyword">for</span> i=1:numel(modelSBML.groups_group)
0660         groupreactions={modelSBML.groups_group(i).groups_member(:).groups_idRef};
0661         [~, idx] = ismember(groupreactions, reactionIDs);
0662         <span class="keyword">if</span> any(idx)
0663             <span class="keyword">for</span> j=1:numel(idx)
0664                 <span class="keyword">if</span> isempty(subsystems{idx(j)}) <span class="comment">% First subsystem</span>
0665                     subsystems{idx(j)} = {modelSBML.groups_group(i).groups_name};
0666                 <span class="keyword">else</span> <span class="comment">% Consecutive subsystems: concatenate</span>
0667                     subsystems{idx(j)} = horzcat(subsystems{idx(j)}, modelSBML.groups_group(i).groups_name);
0668                 <span class="keyword">end</span>
0669             <span class="keyword">end</span>
0670         <span class="keyword">end</span>
0671     <span class="keyword">end</span>
0672 <span class="keyword">end</span>
0673 
0674 <span class="comment">%Shrink the structures if complex-forming reactions had to be skipped</span>
0675 reactionNames=reactionNames(1:counter);
0676 reactionIDs=reactionIDs(1:counter);
0677 subsystems=subsystems(1:counter);
0678 eccodes=eccodes(1:counter);
0679 rxnconfidencescores=rxnconfidencescores(1:counter);
0680 rxnreferences=rxnreferences(1:counter);
0681 rxnnotes=rxnnotes(1:counter);
0682 grRules=grRules(1:counter);
0683 rxnMiriams=rxnMiriams(1:counter);
0684 reactionReversibility=reactionReversibility(1:counter);
0685 reactionUB=reactionUB(1:counter);
0686 reactionLB=reactionLB(1:counter);
0687 reactionObjective=reactionObjective(1:counter);
0688 S=S(:,1:counter);
0689 
0690 model.name=modelSBML.name;
0691 model.id=modelSBML.id;
0692 model.rxns=reactionIDs;
0693 model.mets=metaboliteIDs;
0694 model.S=sparse(S);
0695 model.lb=reactionLB;
0696 model.ub=reactionUB;
0697 model.rev=reactionReversibility;
0698 model.c=reactionObjective;
0699 model.b=zeros(numel(metaboliteIDs),1);
0700 model.comps=compartmentIDs;
0701 model.compNames=compartmentNames;
0702 model.rxnConfidenceScores=rxnconfidencescores;
0703 model.rxnReferences=rxnreferences;
0704 model.rxnNotes=rxnnotes;
0705 
0706 <span class="comment">%Load annotation if available. If there are several authors, only the first</span>
0707 <span class="comment">%author credentials are imported</span>
0708 <span class="keyword">if</span> isfield(modelSBML,<span class="string">'annotation'</span>)
0709     endString=<span class="string">'&lt;/'</span>;
0710     I=strfind(modelSBML.annotation,endString);
0711     J=strfind(modelSBML.annotation,<span class="string">'&lt;vCard:Family&gt;'</span>);
0712     <span class="keyword">if</span> any(J)
0713         model.annotation.familyName=modelSBML.annotation(J(1)+14:I(find(I&gt;J(1),1))-1);
0714     <span class="keyword">end</span>
0715     J=strfind(modelSBML.annotation,<span class="string">'&lt;vCard:Given&gt;'</span>);
0716     <span class="keyword">if</span> any(J)
0717         model.annotation.givenName=modelSBML.annotation(J(1)+13:I(find(I&gt;J(1),1))-1);
0718     <span class="keyword">end</span>
0719     J=strfind(modelSBML.annotation,<span class="string">'&lt;vCard:EMAIL&gt;'</span>);
0720     <span class="keyword">if</span> any(J)
0721         model.annotation.email=modelSBML.annotation(J(1)+13:I(find(I&gt;J(1),1))-1);
0722     <span class="keyword">end</span>
0723     J=strfind(modelSBML.annotation,<span class="string">'&lt;vCard:Orgname&gt;'</span>);
0724     <span class="keyword">if</span> any(J)
0725         model.annotation.organization=modelSBML.annotation(J(1)+15:I(find(I&gt;J(1),1))-1);
0726     <span class="keyword">end</span>
0727     endString=<span class="string">'&quot;/&gt;'</span>;
0728     I=strfind(modelSBML.annotation,endString);
0729     <span class="keyword">if</span> strfind(modelSBML.annotation,<span class="string">'&quot;urn:miriam:'</span>)
0730         J=strfind(modelSBML.annotation,<span class="string">'&quot;urn:miriam:'</span>);
0731         <span class="keyword">if</span> any(J)
0732             model.annotation.taxonomy=modelSBML.annotation(J+12:I(find(I&gt;J,1))-1);
0733         <span class="keyword">end</span>
0734     <span class="keyword">else</span>
0735         J=strfind(modelSBML.annotation,<span class="string">'&quot;http://identifiers.org/'</span>);
0736         <span class="keyword">if</span> any(J)
0737             model.annotation.taxonomy=modelSBML.annotation(J+24:I(find(I&gt;J,1))-1);
0738         <span class="keyword">else</span>
0739             J=strfind(modelSBML.annotation,<span class="string">'&quot;https://identifiers.org/'</span>);
0740             <span class="keyword">if</span> any(J)
0741                 model.annotation.taxonomy=modelSBML.annotation(J+25:I(find(I&gt;J,1))-1);
0742             <span class="keyword">end</span>
0743         <span class="keyword">end</span>
0744     <span class="keyword">end</span>
0745 <span class="keyword">end</span>
0746 <span class="keyword">if</span> isfield(modelSBML,<span class="string">'notes'</span>)
0747     startString=strfind(modelSBML.notes,<span class="string">'xhtml&quot;&gt;'</span>);
0748     endString=strfind(modelSBML.notes,<span class="string">'&lt;/body&gt;'</span>);
0749     <span class="keyword">if</span> any(startString) &amp;&amp; any(endString)
0750         model.annotation.note=modelSBML.notes(startString+7:endString-1);
0751         model.annotation.note=regexprep(model.annotation.note,<span class="string">'&lt;p&gt;|&lt;/p&gt;'</span>,<span class="string">''</span>);
0752         model.annotation.note=strtrim(model.annotation.note);
0753         <span class="keyword">if</span> regexp(model.annotation.note,<span class="string">'This file was generated using the exportModel function in RAVEN Toolbox \d\.\d and OutputSBML in libSBML'</span>)
0754             model.annotation=rmfield(model.annotation,<span class="string">'note'</span>); <span class="comment">% Default note added when running exportModel</span>
0755         <span class="keyword">end</span>
0756     <span class="keyword">end</span>
0757 <span class="keyword">end</span>
0758 
0759 <span class="keyword">if</span> any(~cellfun(@isempty,compartmentOutside))
0760     model.compOutside=compartmentOutside;
0761 <span class="keyword">end</span>
0762 
0763 model.rxnNames=reactionNames;
0764 model.metNames=metaboliteNames;
0765 
0766 <span class="comment">%Match the compartments for metabolites</span>
0767 [~, J]=ismember(metaboliteCompartments,model.comps);
0768 model.metComps=J;
0769 
0770 <span class="comment">%If any genes have been loaded (only for the new format)</span>
0771 <span class="keyword">if</span> ~isempty(geneNames)
0772     <span class="comment">%In some rare cases geneNames may not necessarily be used in grRules.</span>
0773     <span class="comment">%That is true for Yeast 7.6. It's therefore important to change gene</span>
0774     <span class="comment">%systematic names to geneIDs in sophisticated way. Gene systematic</span>
0775     <span class="comment">%names are not unique, since exactly the same name may be in different</span>
0776     <span class="comment">%compartments</span>
0777     <span class="keyword">if</span> all(cellfun(@isempty,strfind(grRules,geneNames{1})))
0778         geneShortNames=geneNames;
0779         <span class="comment">%geneShortNames contain compartments as well, so these are removed</span>
0780         geneShortNames=regexprep(geneShortNames,<span class="string">' \[.+$'</span>,<span class="string">''</span>);
0781         <span class="comment">%grRules obtained from modifier fields contain geneNames. These are</span>
0782         <span class="comment">%changed into geneIDs. grRulesFromModifier is a good way to have</span>
0783         <span class="comment">%geneIDs and rxns association when it's important to resolve</span>
0784         <span class="comment">%systematic name ambiguities</span>
0785         grRulesFromModifier=regexprep(regexprep(grRulesFromModifier,<span class="string">'\[|\]'</span>,<span class="string">'_'</span>),regexprep(geneNames,<span class="string">'\[|\]'</span>,<span class="string">'_'</span>),geneIDs);
0786         grRules=regexprep(regexprep(grRules,<span class="string">'\[|\]'</span>,<span class="string">'_'</span>),regexprep(geneNames,<span class="string">'\[|\]'</span>,<span class="string">'_'</span>),geneIDs);
0787 
0788         <span class="comment">%Yeast 7.6 contains several metabolites, which were used in gene</span>
0789         <span class="comment">%associations. For that reason, the list of species ID is created</span>
0790         <span class="comment">%and we then check whether any of them have kegg.genes annotation</span>
0791         <span class="comment">%thereby obtaining systematic gene names</span>
0792         geneShortNames=vertcat(geneShortNames,metaboliteNames);
0793         geneIDs=vertcat(geneIDs,metaboliteIDs);
0794         geneSystNames=extractMiriam(vertcat(geneMiriams,metaboliteMiriams),<span class="string">'kegg.genes'</span>);
0795         geneCompartments=vertcat(geneCompartments,metaboliteCompartments);
0796         geneMiriams=vertcat(geneMiriams,metaboliteMiriams);
0797 
0798         <span class="comment">%Now we retain information for only these entries, which have</span>
0799         <span class="comment">%kegg.genes annotation</span>
0800         geneShortNames=geneShortNames(~cellfun(<span class="string">'isempty'</span>,geneSystNames));
0801         geneIDs=geneIDs(~cellfun(<span class="string">'isempty'</span>,geneSystNames));
0802         geneSystNames=geneSystNames(~cellfun(<span class="string">'isempty'</span>,geneSystNames));
0803         geneCompartments=geneCompartments(~cellfun(<span class="string">'isempty'</span>,geneSystNames));
0804         geneMiriams=geneMiriams(~cellfun(<span class="string">'isempty'</span>,geneSystNames));
0805         <span class="comment">%Now we reorder geneIDs and geneSystNames by geneSystNames string</span>
0806         <span class="comment">%length</span>
0807         geneNames=geneIDs;<span class="comment">%Backuping geneIDs, since we need unsorted order for later</span>
0808         [~, Indx] = sort(cellfun(<span class="string">'size'</span>, geneSystNames, 2), <span class="string">'descend'</span>);
0809         geneIDs = geneIDs(Indx);
0810         geneSystNames = geneSystNames(Indx);
0811         <span class="keyword">for</span> i=1:numel(geneSystNames)
0812             <span class="keyword">for</span> j=1:numel(grRules)
0813                 <span class="keyword">if</span> strfind(grRules{j},geneSystNames{i})
0814                     <span class="keyword">if</span> ~isempty(grRules{j})
0815                         <span class="keyword">if</span> sum(ismember(geneSystNames,geneSystNames{i}))==1
0816                             grRules{j}=regexprep(grRules{j},geneSystNames{i},geneIDs{i});
0817                         <span class="keyword">elseif</span> sum(ismember(geneSystNames,geneSystNames{i}))&gt;1
0818                             counter=0;
0819                             ovrlpIDs=geneIDs(ismember(geneSystNames,geneSystNames{i}));
0820                             <span class="keyword">for</span> k=1:numel(ovrlpIDs)
0821                                 <span class="keyword">if</span> strfind(grRulesFromModifier{j},ovrlpIDs{k})
0822                                     counter=counter+1;
0823                                     grRules{j}=regexprep(grRules{j},geneSystNames{i},ovrlpIDs{k});
0824                                 <span class="keyword">end</span>
0825                                 <span class="keyword">if</span> counter&gt;1
0826                                     EM=[<span class="string">'Gene association is ambiguous for reaction '</span> modelSBML.reaction(j).id];
0827                                     dispEM(EM);
0828                                 <span class="keyword">end</span>
0829                             <span class="keyword">end</span>
0830                         <span class="keyword">end</span>
0831                     <span class="keyword">end</span>
0832                 <span class="keyword">end</span>
0833             <span class="keyword">end</span>
0834         <span class="keyword">end</span>
0835     <span class="keyword">end</span>
0836     model.genes=geneNames;
0837     model.grRules=grRules;
0838     [grRules,rxnGeneMat] = standardizeGrRules(model,true);
0839     model.grRules = grRules;
0840     model.rxnGeneMat = rxnGeneMat;
0841 
0842     <span class="comment">%Match the compartments for genes</span>
0843     [~, J]=ismember(geneCompartments,model.comps);
0844     model.geneComps=J;
0845 <span class="keyword">else</span>
0846     <span class="keyword">if</span> ~all(cellfun(@isempty,grRules))
0847         <span class="comment">%If fbc_geneProduct exists, follow the specified gene order, such</span>
0848         <span class="comment">%that matching geneShortNames in function below will work</span>
0849         <span class="keyword">if</span> isfield(modelSBML,<span class="string">'fbc_geneProduct'</span>)
0850             genes={modelSBML.fbc_geneProduct.fbc_id};
0851 
0852             <span class="comment">%Get gene Miriams if they were not retrieved above (this occurs</span>
0853             <span class="comment">%when genes are stored as fbc_geneProduct instead of species)</span>
0854             <span class="keyword">if</span> isempty(geneMiriams)
0855                 geneMiriams = cell(numel(genes),1);
0856                 <span class="keyword">if</span> isfield(modelSBML.fbc_geneProduct,<span class="string">'sboTerm'</span>) &amp;&amp; numel(unique([modelSBML.fbc_geneProduct.sboTerm])) == 1
0857                     <span class="comment">%If all the SBO terms are identical, don't add them to geneMiriams</span>
0858                     modelSBML.fbc_geneProduct = rmfield(modelSBML.fbc_geneProduct,<span class="string">'sboTerm'</span>);
0859                 <span class="keyword">end</span>
0860                 <span class="keyword">for</span> i = 1:numel(genes)
0861                     geneMiriams{i}=<a href="#_sub4" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.fbc_geneProduct(i).annotation);
0862                     <span class="keyword">if</span> isfield(modelSBML.fbc_geneProduct(i),<span class="string">'sboTerm'</span>) &amp;&amp; ~(modelSBML.fbc_geneProduct(i).sboTerm==-1)
0863                         geneMiriams{i} = <a href="#_sub5" class="code" title="subfunction miriam = addSBOtoMiriam(miriam,sboTerm)">addSBOtoMiriam</a>(geneMiriams{i},modelSBML.fbc_geneProduct(i).sboTerm);
0864                     <span class="keyword">end</span>
0865                 <span class="keyword">end</span>
0866             <span class="keyword">end</span>
0867             proteins={modelSBML.fbc_geneProduct.fbc_name};
0868         <span class="keyword">else</span>
0869             genes=<a href="#_sub1" class="code" title="subfunction matchGenes=getGeneList(grRules)">getGeneList</a>(grRules);
0870         <span class="keyword">end</span>
0871         model.genes=genes;
0872         model.grRules=grRules;
0873         [grRules,rxnGeneMat] = standardizeGrRules(model,true);
0874         model.grRules = grRules;
0875         model.rxnGeneMat = rxnGeneMat;
0876     <span class="keyword">end</span>
0877 <span class="keyword">end</span>
0878 
0879 <span class="keyword">if</span> all(cellfun(@isempty,geneShortNames))
0880     <span class="keyword">if</span> isfield(modelSBML,<span class="string">'fbc_geneProduct'</span>)
0881         <span class="keyword">for</span> i=1:numel(genes)
0882             <span class="keyword">if</span> ~isempty(modelSBML.fbc_geneProduct(i).fbc_label)
0883                 geneShortNames{i,1}=modelSBML.fbc_geneProduct(i).fbc_label;
0884             <span class="keyword">elseif</span> ~isempty(modelSBML.fbc_geneProduct(i).fbc_name)
0885                 geneShortNames{i,1}=modelSBML.fbc_geneProduct(i).fbc_name;
0886             <span class="keyword">else</span>
0887                 geneShortNames{i,1}=<span class="string">''</span>;
0888             <span class="keyword">end</span>
0889         <span class="keyword">end</span>
0890     <span class="keyword">end</span>
0891 <span class="keyword">end</span>
0892 
0893 <span class="comment">%If any InChIs have been loaded</span>
0894 <span class="keyword">if</span> any(~cellfun(@isempty,metaboliteInChI))
0895     model.inchis=metaboliteInChI;
0896 <span class="keyword">end</span>
0897 
0898 <span class="comment">%If any formulas have been loaded</span>
0899 <span class="keyword">if</span> any(~cellfun(@isempty,metaboliteFormula))
0900     model.metFormulas=metaboliteFormula;
0901 <span class="keyword">end</span>
0902 
0903 <span class="comment">%If any charges have been loaded</span>
0904 <span class="keyword">if</span> ~isempty(metaboliteCharges)
0905     model.metCharges=metaboliteCharges;
0906 <span class="keyword">end</span>
0907 
0908 <span class="comment">%If any gene short names have been loaded</span>
0909 <span class="keyword">if</span> any(~cellfun(@isempty,geneShortNames))
0910     model.geneShortNames=geneShortNames;
0911 <span class="keyword">end</span>
0912 
0913 <span class="comment">%If any Miriam strings for compartments have been loaded</span>
0914 <span class="keyword">if</span> any(~cellfun(@isempty,compartmentMiriams))
0915     model.compMiriams=compartmentMiriams;
0916 <span class="keyword">end</span>
0917 
0918 <span class="comment">%If any Miriam strings for metabolites have been loaded</span>
0919 <span class="keyword">if</span> any(~cellfun(@isempty,metaboliteMiriams))
0920     model.metMiriams=metaboliteMiriams;
0921 <span class="keyword">end</span>
0922 
0923 <span class="comment">%If any subsystems have been loaded</span>
0924 <span class="keyword">if</span> any(~cellfun(@isempty,subsystems))
0925     model.subSystems=subsystems;
0926 <span class="keyword">end</span>
0927 <span class="keyword">if</span> any(rxnComps)
0928     <span class="keyword">if</span> all(rxnComps)
0929         model.rxnComps=rxnComps;
0930     <span class="keyword">else</span>
0931         <span class="keyword">if</span> supressWarnings==false
0932             EM=<span class="string">'The compartments for the following reactions could not be matched. Ignoring reaction compartment information'</span>;
0933             dispEM(EM,false,model.rxns(rxnComps==0));
0934         <span class="keyword">end</span>
0935     <span class="keyword">end</span>
0936 <span class="keyword">end</span>
0937 
0938 <span class="comment">%If any ec-codes have been loaded</span>
0939 <span class="keyword">if</span> any(~cellfun(@isempty,eccodes))
0940     model.eccodes=eccodes;
0941 <span class="keyword">end</span>
0942 
0943 <span class="comment">%If any Miriam strings for reactions have been loaded</span>
0944 <span class="keyword">if</span> any(~cellfun(@isempty,rxnMiriams))
0945     model.rxnMiriams=rxnMiriams;
0946 <span class="keyword">end</span>
0947 
0948 <span class="comment">%If any Miriam strings for genes have been loaded</span>
0949 <span class="keyword">if</span> any(~cellfun(@isempty,geneMiriams))
0950     model.geneMiriams=geneMiriams;
0951 <span class="keyword">end</span>
0952 
0953 <span class="comment">%If any protein strings have been loaded</span>
0954 <span class="keyword">if</span> any(~cellfun(@isempty,proteins))
0955     proteins = reshape(proteins,[],1);
0956     model.proteins=proteins;
0957 <span class="keyword">end</span>
0958 
0959 model.unconstrained=metaboliteUnconstrained;
0960 
0961 <span class="comment">%Convert SBML IDs back into their original strings. Here we are using part</span>
0962 <span class="comment">%from convertSBMLID, originating from the COBRA Toolbox</span>
0963 model.rxns=regexprep(model.rxns,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
0964 model.mets=regexprep(model.mets,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
0965 model.comps=regexprep(model.comps,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
0966 model.grRules=regexprep(model.grRules,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
0967 model.genes=regexprep(model.genes,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
0968 model.id=regexprep(model.id,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
0969 
0970 
0971 hasCOBRAids(1) = all(startsWith(model.rxns,<span class="string">'R_'</span>));
0972 hasCOBRAids(2) = all(startsWith(model.mets,<span class="string">'M_'</span>));
0973 hasCOBRAids(3) = all(startsWith(model.comps,<span class="string">'C_'</span>));
0974 hasCOBRAids(4) = all(startsWith(model.genes,<span class="string">'G_'</span>));
0975 hasCOBRAids(5) = all(startsWith(model.metNames,<span class="string">'M_'</span>));
0976 hasCOBRAids(6) = all(startsWith(model.rxnNames,<span class="string">'R_'</span>));
0977 hasCOBRAids(7) = all(startsWith(model.id,<span class="string">'M_'</span>));
0978 
0979 <span class="keyword">if</span> COBRAstyle
0980     <span class="keyword">if</span> hasCOBRAids(1)
0981         model.rxns  = cellfun(@(x) x(3:end), model.rxns,<span class="string">'un'</span>,0);
0982     <span class="keyword">end</span>
0983     <span class="keyword">if</span> hasCOBRAids(2)
0984         model.mets  = cellfun(@(x) x(3:end), model.mets,<span class="string">'un'</span>,0);
0985     <span class="keyword">end</span>
0986     <span class="keyword">if</span> hasCOBRAids(3)
0987         model.comps = cellfun(@(x) x(3:end), model.comps,<span class="string">'un'</span>,0);
0988     <span class="keyword">end</span>
0989     <span class="keyword">if</span> hasCOBRAids(4)
0990         model.genes = cellfun(@(x) x(3:end), model.genes,<span class="string">'un'</span>,0);
0991         model.grRules=regexprep(model.grRules,<span class="string">'^G_'</span>,<span class="string">''</span>);
0992         model.grRules=regexprep(model.grRules,<span class="string">'\(G_'</span>,<span class="string">'('</span>);
0993         model.grRules=regexprep(model.grRules,<span class="string">' G_'</span>,<span class="string">' '</span>);
0994     <span class="keyword">end</span>
0995     <span class="comment">% Not strictly identifier, but also remove from metNames and rxnNames if present</span>
0996     <span class="keyword">if</span> hasCOBRAids(5)
0997         model.metNames  = cellfun(@(x) x(3:end), model.metNames,<span class="string">'un'</span>,0);
0998     <span class="keyword">end</span>
0999     <span class="keyword">if</span> hasCOBRAids(6)
1000         model.rxnNames  = cellfun(@(x) x(3:end), model.rxnNames,<span class="string">'un'</span>,0);
1001     <span class="keyword">end</span>
1002     <span class="keyword">if</span> hasCOBRAids(6)
1003         model.id        = model.id(3:end);
1004     <span class="keyword">end</span>
1005 <span class="keyword">elseif</span> any(hasCOBRAids)
1006     hasCOBRAidsMsg = {<span class="string">'model.rxns (R_ prefix)'</span>,<span class="keyword">...</span>
1007                       <span class="string">'model.mets (M_ prefix)'</span>,<span class="keyword">...</span>
1008                       <span class="string">'model.comps (C_ prefix)'</span>,<span class="keyword">...</span>
1009                       <span class="string">'model.genes (G_ prefix)'</span>,<span class="keyword">...</span>
1010                       <span class="string">'model.metNames (M_ prefix)'</span>,<span class="keyword">...</span>
1011                       <span class="string">'model.rxnNames (R_ prefix)'</span>,<span class="keyword">...</span>
1012                       <span class="string">'model.id (M_ prefix)'</span>};
1013     hasCOBRAidsMsg(~hasCOBRAids) = [];
1014     printOrange([<span class="string">'COBRA style identifier prefixes are found in: &quot;'</span> <span class="keyword">...</span>
1015         strjoin(hasCOBRAidsMsg,<span class="string">'&quot;; &quot;'</span>) <span class="string">'&quot;. Since RAVEN 2.10.0, identifiers '</span> <span class="keyword">...</span>
1016         <span class="string">'are by default imported &quot;as-is&quot;. If you do prefer to remove these '</span> <span class="keyword">...</span>
1017         <span class="string">'identifier prefixes, run importModel with COBRAstyle as true. '</span> <span class="keyword">...</span>
1018         <span class="string">'Example:   importModel(''filename.xml'', [], true);\n'</span>]);
1019 <span class="keyword">end</span>
1020 
1021 <span class="comment">%Remove unused fields</span>
1022 <span class="keyword">if</span> isempty(model.annotation)
1023     model=rmfield(model,<span class="string">'annotation'</span>);
1024 <span class="keyword">end</span>
1025 <span class="keyword">if</span> isempty(model.compOutside)
1026     model=rmfield(model,<span class="string">'compOutside'</span>);
1027 <span class="keyword">end</span>
1028 <span class="keyword">if</span> isempty(model.compMiriams)
1029     model=rmfield(model,<span class="string">'compMiriams'</span>);
1030 <span class="keyword">end</span>
1031 <span class="keyword">if</span> isempty(model.rxnComps)
1032     model=rmfield(model,<span class="string">'rxnComps'</span>);
1033 <span class="keyword">end</span>
1034 <span class="keyword">if</span> isempty(model.grRules)
1035     model=rmfield(model,<span class="string">'grRules'</span>);
1036 <span class="keyword">end</span>
1037 <span class="keyword">if</span> isempty(model.rxnGeneMat)
1038     model=rmfield(model,<span class="string">'rxnGeneMat'</span>);
1039 <span class="keyword">end</span>
1040 <span class="keyword">if</span> isempty(model.subSystems)
1041     model=rmfield(model,<span class="string">'subSystems'</span>);
1042 <span class="keyword">else</span>
1043     model.subSystems(cellfun(@isempty,subsystems))={{<span class="string">''</span>}};
1044 <span class="keyword">end</span>
1045 <span class="keyword">if</span> isempty(model.eccodes)
1046     model=rmfield(model,<span class="string">'eccodes'</span>);
1047 <span class="keyword">end</span>
1048 <span class="keyword">if</span> isempty(model.rxnMiriams)
1049     model=rmfield(model,<span class="string">'rxnMiriams'</span>);
1050 <span class="keyword">end</span>
1051 <span class="keyword">if</span> cellfun(@isempty,model.rxnNotes)
1052     model=rmfield(model,<span class="string">'rxnNotes'</span>);
1053 <span class="keyword">end</span>
1054 <span class="keyword">if</span> cellfun(@isempty,model.rxnReferences)
1055     model=rmfield(model,<span class="string">'rxnReferences'</span>);
1056 <span class="keyword">end</span>
1057 <span class="keyword">if</span> isempty(model.rxnConfidenceScores) || all(isnan(model.rxnConfidenceScores))
1058     model=rmfield(model,<span class="string">'rxnConfidenceScores'</span>);
1059 <span class="keyword">end</span>
1060 <span class="keyword">if</span> isempty(model.genes)
1061     model=rmfield(model,<span class="string">'genes'</span>);
1062 <span class="keyword">elseif</span> isrow(model.genes)
1063     model.genes=transpose(model.genes);
1064 <span class="keyword">end</span>
1065 <span class="keyword">if</span> isempty(model.geneComps)
1066     model=rmfield(model,<span class="string">'geneComps'</span>);
1067 <span class="keyword">end</span>
1068 <span class="keyword">if</span> isempty(model.geneMiriams)
1069     model=rmfield(model,<span class="string">'geneMiriams'</span>);
1070 <span class="keyword">end</span>
1071 <span class="keyword">if</span> isempty(model.geneShortNames)
1072     model=rmfield(model,<span class="string">'geneShortNames'</span>);
1073 <span class="keyword">end</span>
1074 <span class="keyword">if</span> isempty(model.proteins)
1075     model=rmfield(model,<span class="string">'proteins'</span>);
1076 <span class="keyword">end</span>
1077 <span class="keyword">if</span> isempty(model.inchis)
1078     model=rmfield(model,<span class="string">'inchis'</span>);
1079 <span class="keyword">end</span>
1080 <span class="keyword">if</span> isempty(model.metFormulas)
1081     model=rmfield(model,<span class="string">'metFormulas'</span>);
1082 <span class="keyword">end</span>
1083 <span class="keyword">if</span> isempty(model.metMiriams)
1084     model=rmfield(model,<span class="string">'metMiriams'</span>);
1085 <span class="keyword">end</span>
1086 <span class="keyword">if</span> ~any(model.metCharges)
1087     model=rmfield(model,<span class="string">'metCharges'</span>);
1088 <span class="keyword">end</span>
1089 
1090 <span class="comment">%This just removes the grRules if no genes have been loaded</span>
1091 <span class="keyword">if</span> ~isfield(model,<span class="string">'genes'</span>) &amp;&amp; isfield(model,<span class="string">'grRules'</span>)
1092     model=rmfield(model,<span class="string">'grRules'</span>);
1093 <span class="keyword">end</span>
1094 
1095 <span class="comment">%Print warnings about bad structure</span>
1096 <span class="keyword">if</span> supressWarnings==false
1097     checkModelStruct(model,false);
1098 <span class="keyword">end</span>
1099 
1100 <span class="keyword">if</span> removeExcMets==true
1101     model=simplifyModel(model);
1102 <span class="keyword">end</span>
1103 <span class="keyword">end</span>
1104 
1105 <a name="_sub1" href="#_subfunctions" class="code">function matchGenes=getGeneList(grRules)</a>
1106 <span class="comment">%Constructs the list of unique genes from grRules</span>
1107 
1108 <span class="comment">%Assumes that everything that isn't a paranthesis, &quot; AND &quot; or &quot; or &quot; is a</span>
1109 <span class="comment">%gene name</span>
1110 genes=strrep(grRules,<span class="string">'('</span>,<span class="string">''</span>);
1111 genes=strrep(genes,<span class="string">')'</span>,<span class="string">''</span>);
1112 genes=strrep(genes,<span class="string">' or '</span>,<span class="string">' '</span>);
1113 genes=strrep(genes,<span class="string">' and '</span>,<span class="string">' '</span>);
1114 genes=strrep(genes,<span class="string">' OR '</span>,<span class="string">' '</span>);
1115 genes=strrep(genes,<span class="string">' AND '</span>,<span class="string">' '</span>);
1116 genes=regexp(genes,<span class="string">' '</span>,<span class="string">'split'</span>);
1117 
1118 allNames={};
1119 <span class="keyword">for</span> i=1:numel(genes)
1120     allNames=[allNames genes{i}];
1121 <span class="keyword">end</span>
1122 matchGenes=unique(allNames)';
1123 
1124 <span class="comment">%Remove the empty element if present</span>
1125 <span class="keyword">if</span> isempty(matchGenes{1})
1126     matchGenes(1)=[];
1127 <span class="keyword">end</span>
1128 <span class="keyword">end</span>
1129 
1130 <a name="_sub2" href="#_subfunctions" class="code">function fieldContent=parseNote(searchString,fieldName)</a>
1131 <span class="comment">%The function obtains the particular information from 'notes' field, using</span>
1132 <span class="comment">%fieldName as the dummy string</span>
1133 
1134 fieldContent=<span class="string">''</span>;
1135 
1136 <span class="keyword">if</span> strfind(searchString,fieldName)
1137     [~,targetString] = regexp(searchString,[<span class="string">'&lt;p&gt;'</span> fieldName <span class="string">'.*?&lt;/p&gt;'</span>],<span class="string">'tokens'</span>,<span class="string">'match'</span>);
1138     targetString=regexprep(targetString,<span class="string">'&lt;p&gt;|&lt;/p&gt;'</span>,<span class="string">''</span>);
1139     targetString=regexprep(targetString,[fieldName, <span class="string">':'</span>],<span class="string">''</span>);
1140     <span class="keyword">for</span> i=1:numel(targetString)
1141         fieldContent=[fieldContent <span class="string">';'</span> strtrim(targetString{1,i})];
1142     <span class="keyword">end</span>
1143     fieldContent=regexprep(fieldContent,<span class="string">'^;|;$'</span>,<span class="string">''</span>);
1144 <span class="keyword">else</span>
1145     fieldContent=<span class="string">''</span>;
1146 <span class="keyword">end</span>
1147 <span class="keyword">end</span>
1148 
1149 <a name="_sub3" href="#_subfunctions" class="code">function fieldContent=parseAnnotation(searchString,startString,midString,fieldName)</a>
1150 
1151 fieldContent=<span class="string">''</span>;
1152 
1153 <span class="comment">%Removing whitespace characters from the ending strings, which may occur in</span>
1154 <span class="comment">%several cases</span>
1155 searchString=regexprep(searchString,<span class="string">'&quot; /&gt;'</span>,<span class="string">'&quot;/&gt;'</span>);
1156 [~,targetString] = regexp(searchString,[<span class="string">'&lt;rdf:li rdf:resource=&quot;'</span> startString fieldName midString <span class="string">'.*?&quot;/&gt;'</span>],<span class="string">'tokens'</span>,<span class="string">'match'</span>);
1157 targetString=regexprep(targetString,<span class="string">'&lt;rdf:li rdf:resource=&quot;|&quot;/&gt;'</span>,<span class="string">''</span>);
1158 targetString=regexprep(targetString,startString,<span class="string">''</span>);
1159 targetString=regexprep(targetString,[fieldName midString],<span class="string">''</span>);
1160 
1161 <span class="keyword">for</span> i=1:numel(targetString)
1162     fieldContent=[fieldContent <span class="string">';'</span> strtrim(targetString{1,i})];
1163 <span class="keyword">end</span>
1164 
1165 fieldContent=regexprep(fieldContent,<span class="string">'^;|;$'</span>,<span class="string">''</span>);
1166 <span class="keyword">end</span>
1167 
1168 <a name="_sub4" href="#_subfunctions" class="code">function miriamStruct=parseMiriam(searchString)</a>
1169 <span class="comment">%Generates miriam structure from annotation field</span>
1170 
1171 <span class="comment">%Finding whether miriams are written in the old or the new way</span>
1172 <span class="keyword">if</span> strfind(searchString,<span class="string">'urn:miriam:'</span>)
1173     startString=<span class="string">'urn:miriam:'</span>;
1174     midString=<span class="string">':'</span>;
1175 <span class="keyword">elseif</span> strfind(searchString,<span class="string">'http://identifiers.org/'</span>)
1176     startString=<span class="string">'http://identifiers.org/'</span>;
1177     midString=<span class="string">'/'</span>;
1178 <span class="keyword">elseif</span> strfind(searchString,<span class="string">'https://identifiers.org/'</span>)
1179     startString=<span class="string">'https://identifiers.org/'</span>;
1180     midString=<span class="string">'/'</span>;
1181 <span class="keyword">else</span>
1182     miriamStruct=[];
1183     <span class="keyword">return</span>;
1184 <span class="keyword">end</span>
1185 
1186 miriamStruct=[];
1187 
1188 searchString=regexprep(searchString,<span class="string">'&quot; /&gt;'</span>,<span class="string">'&quot;/&gt;'</span>);
1189 [~,targetString] = regexp(searchString,<span class="string">'&lt;rdf:li rdf:resource=&quot;.*?&quot;/&gt;'</span>,<span class="string">'tokens'</span>,<span class="string">'match'</span>);
1190 targetString=regexprep(targetString,<span class="string">'&lt;rdf:li rdf:resource=&quot;|&quot;/&gt;'</span>,<span class="string">''</span>);
1191 targetString=regexprep(targetString,startString,<span class="string">''</span>);
1192 targetString=regexprep(targetString,midString,<span class="string">'/'</span>,<span class="string">'once'</span>);
1193 
1194 counter=0;
1195 <span class="keyword">for</span> i=1:numel(targetString)
1196     <span class="keyword">if</span> isempty(regexp(targetString{1,i},<span class="string">'inchi|ec-code'</span>, <span class="string">'once'</span>))
1197         counter=counter+1;
1198         miriamStruct.name{counter,1} = regexprep(targetString{1,i},<span class="string">'/.+'</span>,<span class="string">''</span>,<span class="string">'once'</span>);
1199         miriamStruct.value{counter,1} = regexprep(targetString{1,i},[miriamStruct.name{counter,1} <span class="string">'/'</span>],<span class="string">''</span>,<span class="string">'once'</span>);
1200         miriamStruct.name{counter,1} = regexprep(miriamStruct.name{counter,1},<span class="string">'^obo\.'</span>,<span class="string">''</span>);
1201     <span class="keyword">end</span>
1202 <span class="keyword">end</span>
1203 <span class="keyword">end</span>
1204 
1205 <a name="_sub5" href="#_subfunctions" class="code">function miriam = addSBOtoMiriam(miriam,sboTerm)</a>
1206 <span class="comment">%Appends SBO term to miriam structure</span>
1207 
1208 sboTerm = {[<span class="string">'SBO:'</span> sprintf(<span class="string">'%07u'</span>,sboTerm)]};  <span class="comment">% convert to proper format</span>
1209 <span class="keyword">if</span> isempty(miriam)
1210     miriam.name = {<span class="string">'sbo'</span>};
1211     miriam.value = sboTerm;
1212 <span class="keyword">elseif</span> any(strcmp(<span class="string">'sbo'</span>,miriam.name))
1213     currSbo = strcmp(<span class="string">'sbo'</span>,miriam.name);
1214     miriam.value(currSbo) = sboTerm;
1215 <span class="keyword">else</span>
1216     miriam.name(end+1) = {<span class="string">'sbo'</span>};
1217     miriam.value(end+1) = sboTerm;
1218 <span class="keyword">end</span>
1219 <span class="keyword">end</span></pre></div>
<hr><address>Generated by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>