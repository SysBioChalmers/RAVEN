<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of importModel</title>
  <meta name="keywords" content="importModel">
  <meta name="description" content="importModel">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">io</a> &gt; importModel.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for io&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>importModel
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>importModel</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function model=importModel(fileName,removeExcMets,isSBML2COBRA,supressWarnings) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> importModel
   Import a constraint-based model from a SBML file

   fileName        a SBML file to import
   removeExcMets   true if exchange metabolites should be removed. This is
                   needed to be able to run simulations, but it could also
                   be done using simplifyModel at a later stage (opt,
                   default true)
   isSBML2COBRA    true if the SBML file is in the old COBRA Toolbox format
                   (SBML Level 2) (opt, default false)
   supressWarnings true if warnings regarding the model structure should
                   be supressed (opt, default false)

   model
       id               model ID
       description      description of model contents
       annotation       additional information about model
       rxns             reaction ids
       mets             metabolite ids
       S                stoichiometric matrix
       lb               lower bounds
       ub               upper bounds
       rev              reversibility vector
       c                objective coefficients
       b                equality constraints for the metabolite equations
       comps            compartment ids
       compNames        compartment names
       compOutside      the id (as in comps) for the compartment
                        surrounding each of the compartments
       compMiriams      structure with MIRIAM information about the
                        compartments
       rxnNames         reaction description
       rxnComps         compartments for reactions
       grRules          reaction to gene rules in text form
       rxnGeneMat       reaction-to-gene mapping in sparse matrix form
       subSystems       subsystem name for each reaction
       eccodes          EC-codes for the reactions
       rxnMiriams       structure with MIRIAM information about the reactions
       rxnNotes         reaction notes
       rxnReferences     reaction references
       rxnConfidenceScores reaction confidence scores
       genes            list of all genes
       geneComps        compartments for genes
       geneMiriams      structure with MIRIAM information about the genes
       geneShortNames   gene alternative names (e.g. ERG10)
       metNames         metabolite description
       metComps         compartments for metabolites
       inchis           InChI-codes for metabolites
       metFormulas      metabolite chemical formula
       metMiriams       structure with MIRIAM information about the metabolites
       metCharges       metabolite charge
       unconstrained    true if the metabolite is an exchange metabolite

   Loads models in the COBRA Toolbox format and in the format used in
   the yeast consensus reconstruction. The resulting structure is compatible
   with COBRA Toolbox. A number of consistency checks are performed in order
   to ensure that the model is valid. Take these warnings seriously and modify the
   model structure to solve them. The RAVEN Toolbox is made to function
   only on consistent models, and the only checks performed are when the
   model is imported. You can use exportToExcelFormat, modify the model in
   Microsoft Excel and then reimport it using importExcelModel (or remake
   the SBML file using SBMLFromExcel)

   NOTE: This script requires that libSBML is installed.

   NOTE: All IDs are assumed to be named C_, M_, E_, R_ for compartments,
         metabolites, genes, and reactions. This is true for models
         generated by SBMLFromExcel and those that follow the yeast
         consensus network model formulation.

   Usage: model=importModel(fileName,removeExcMets,isSBML2COBRA,supressWarnings)

   Eduard Kerkhoven, 2018-03-14</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function [rxnGeneMat, matchGenes]=getGeneMat(grRules,matchGenes)</a></li><li><a href="#_sub2" class="code">function fieldContent=parseNote(searchString,fieldName)</a></li><li><a href="#_sub3" class="code">function fieldContent=parseAnnotation(searchString,startString,midString,fieldName)</a></li><li><a href="#_sub4" class="code">function miriamStruct=parseMiriam(searchString)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function model=importModel(fileName,removeExcMets,isSBML2COBRA,supressWarnings)</a>
0002 <span class="comment">% importModel</span>
0003 <span class="comment">%   Import a constraint-based model from a SBML file</span>
0004 <span class="comment">%</span>
0005 <span class="comment">%   fileName        a SBML file to import</span>
0006 <span class="comment">%   removeExcMets   true if exchange metabolites should be removed. This is</span>
0007 <span class="comment">%                   needed to be able to run simulations, but it could also</span>
0008 <span class="comment">%                   be done using simplifyModel at a later stage (opt,</span>
0009 <span class="comment">%                   default true)</span>
0010 <span class="comment">%   isSBML2COBRA    true if the SBML file is in the old COBRA Toolbox format</span>
0011 <span class="comment">%                   (SBML Level 2) (opt, default false)</span>
0012 <span class="comment">%   supressWarnings true if warnings regarding the model structure should</span>
0013 <span class="comment">%                   be supressed (opt, default false)</span>
0014 <span class="comment">%</span>
0015 <span class="comment">%   model</span>
0016 <span class="comment">%       id               model ID</span>
0017 <span class="comment">%       description      description of model contents</span>
0018 <span class="comment">%       annotation       additional information about model</span>
0019 <span class="comment">%       rxns             reaction ids</span>
0020 <span class="comment">%       mets             metabolite ids</span>
0021 <span class="comment">%       S                stoichiometric matrix</span>
0022 <span class="comment">%       lb               lower bounds</span>
0023 <span class="comment">%       ub               upper bounds</span>
0024 <span class="comment">%       rev              reversibility vector</span>
0025 <span class="comment">%       c                objective coefficients</span>
0026 <span class="comment">%       b                equality constraints for the metabolite equations</span>
0027 <span class="comment">%       comps            compartment ids</span>
0028 <span class="comment">%       compNames        compartment names</span>
0029 <span class="comment">%       compOutside      the id (as in comps) for the compartment</span>
0030 <span class="comment">%                        surrounding each of the compartments</span>
0031 <span class="comment">%       compMiriams      structure with MIRIAM information about the</span>
0032 <span class="comment">%                        compartments</span>
0033 <span class="comment">%       rxnNames         reaction description</span>
0034 <span class="comment">%       rxnComps         compartments for reactions</span>
0035 <span class="comment">%       grRules          reaction to gene rules in text form</span>
0036 <span class="comment">%       rxnGeneMat       reaction-to-gene mapping in sparse matrix form</span>
0037 <span class="comment">%       subSystems       subsystem name for each reaction</span>
0038 <span class="comment">%       eccodes          EC-codes for the reactions</span>
0039 <span class="comment">%       rxnMiriams       structure with MIRIAM information about the reactions</span>
0040 <span class="comment">%       rxnNotes         reaction notes</span>
0041 <span class="comment">%       rxnReferences     reaction references</span>
0042 <span class="comment">%       rxnConfidenceScores reaction confidence scores</span>
0043 <span class="comment">%       genes            list of all genes</span>
0044 <span class="comment">%       geneComps        compartments for genes</span>
0045 <span class="comment">%       geneMiriams      structure with MIRIAM information about the genes</span>
0046 <span class="comment">%       geneShortNames   gene alternative names (e.g. ERG10)</span>
0047 <span class="comment">%       metNames         metabolite description</span>
0048 <span class="comment">%       metComps         compartments for metabolites</span>
0049 <span class="comment">%       inchis           InChI-codes for metabolites</span>
0050 <span class="comment">%       metFormulas      metabolite chemical formula</span>
0051 <span class="comment">%       metMiriams       structure with MIRIAM information about the metabolites</span>
0052 <span class="comment">%       metCharges       metabolite charge</span>
0053 <span class="comment">%       unconstrained    true if the metabolite is an exchange metabolite</span>
0054 <span class="comment">%</span>
0055 <span class="comment">%   Loads models in the COBRA Toolbox format and in the format used in</span>
0056 <span class="comment">%   the yeast consensus reconstruction. The resulting structure is compatible</span>
0057 <span class="comment">%   with COBRA Toolbox. A number of consistency checks are performed in order</span>
0058 <span class="comment">%   to ensure that the model is valid. Take these warnings seriously and modify the</span>
0059 <span class="comment">%   model structure to solve them. The RAVEN Toolbox is made to function</span>
0060 <span class="comment">%   only on consistent models, and the only checks performed are when the</span>
0061 <span class="comment">%   model is imported. You can use exportToExcelFormat, modify the model in</span>
0062 <span class="comment">%   Microsoft Excel and then reimport it using importExcelModel (or remake</span>
0063 <span class="comment">%   the SBML file using SBMLFromExcel)</span>
0064 <span class="comment">%</span>
0065 <span class="comment">%   NOTE: This script requires that libSBML is installed.</span>
0066 <span class="comment">%</span>
0067 <span class="comment">%   NOTE: All IDs are assumed to be named C_, M_, E_, R_ for compartments,</span>
0068 <span class="comment">%         metabolites, genes, and reactions. This is true for models</span>
0069 <span class="comment">%         generated by SBMLFromExcel and those that follow the yeast</span>
0070 <span class="comment">%         consensus network model formulation.</span>
0071 <span class="comment">%</span>
0072 <span class="comment">%   Usage: model=importModel(fileName,removeExcMets,isSBML2COBRA,supressWarnings)</span>
0073 <span class="comment">%</span>
0074 <span class="comment">%   Eduard Kerkhoven, 2018-03-14</span>
0075 
0076 <span class="keyword">if</span> nargin&lt;2
0077     removeExcMets=true;
0078 <span class="keyword">end</span>
0079 
0080 <span class="keyword">if</span> nargin&lt;3
0081     isSBML2COBRA=false;
0082 <span class="keyword">end</span>
0083 
0084 <span class="keyword">if</span> nargin&lt;4
0085     supressWarnings=false;
0086 <span class="keyword">end</span>
0087 
0088 <span class="comment">%This is to match the order of the fields to those you get from importing</span>
0089 <span class="comment">%from Excel</span>
0090 model=[];
0091 model.id=[];
0092 model.description=[];
0093 model.annotation=[];
0094 model.rxns={};
0095 model.mets={};
0096 model.S=[];
0097 model.lb=[];
0098 model.ub=[];
0099 model.rev=[];
0100 model.c=[];
0101 model.b=[];
0102 model.comps={};
0103 model.compNames={};
0104 model.compOutside={};
0105 model.compMiriams={};
0106 model.rxnNames={};
0107 model.rxnComps=[];
0108 model.grRules={};
0109 model.rxnGeneMat=[];
0110 model.subSystems={};
0111 model.eccodes={};
0112 model.rxnMiriams={};
0113 model.rxnNotes={};
0114 model.rxnReferences={};
0115 model.rxnConfidenceScores={};
0116 model.genes={};
0117 model.geneComps=[];
0118 model.geneMiriams={};
0119 model.geneShortNames={};
0120 model.metNames={};
0121 model.metComps=[];
0122 model.inchis={};
0123 model.metFormulas={};
0124 model.metMiriams={};
0125 model.metCharges=[];
0126 model.unconstrained=[];
0127 
0128 <span class="comment">%Load the model using libSBML</span>
0129 modelSBML = TranslateSBML(fileName,0,0,[1 1]);
0130 
0131 <span class="keyword">if</span> isempty(modelSBML)
0132     EM=<span class="string">'There is a problem with the SBML file. Try using the SBML Validator at http://sbml.org/Facilities/Validator'</span>;
0133     dispEM(EM);
0134 <span class="keyword">end</span>
0135 
0136 <span class="comment">% Remove the preceding strings for reactions, compartments and</span>
0137 <span class="comment">% reactants/products in 'reaction' field. The strings for</span>
0138 <span class="comment">% metabolites, genes and complexes are not removed, as we will need them</span>
0139 <span class="comment">% later to identify them from 'species' field;</span>
0140 <span class="keyword">for</span> i=1:numel(modelSBML.reaction)
0141     modelSBML.reaction(i).name=regexprep(modelSBML.reaction(i).name,<span class="string">'^R_'</span>,<span class="string">''</span>);
0142     modelSBML.reaction(i).id=regexprep(modelSBML.reaction(i).id,<span class="string">'^R_'</span>,<span class="string">''</span>);
0143     <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'compartment'</span>)
0144         modelSBML.reaction(i).compartment=regexprep(modelSBML.reaction(i).compartment,<span class="string">'^C_'</span>,<span class="string">''</span>);
0145     <span class="keyword">end</span>;
0146     <span class="keyword">for</span> j=1:numel(modelSBML.reaction(i).reactant)
0147         modelSBML.reaction(i).reactant(j).species=regexprep(modelSBML.reaction(i).reactant(j).species,<span class="string">'^M_'</span>,<span class="string">''</span>);
0148     <span class="keyword">end</span>;
0149     <span class="keyword">for</span> j=1:numel(modelSBML.reaction(i).product)
0150         modelSBML.reaction(i).product(j).species=regexprep(modelSBML.reaction(i).product(j).species,<span class="string">'^M_'</span>,<span class="string">''</span>);
0151     <span class="keyword">end</span>;
0152 <span class="keyword">end</span>;
0153 
0154 <span class="comment">%Retrieve compartment names and IDs</span>
0155 compartmentNames=cell(numel(modelSBML.compartment),1);
0156 compartmentIDs=cell(numel(modelSBML.compartment),1);
0157 compartmentOutside=cell(numel(modelSBML.compartment),1);
0158 compartmentMiriams=cell(numel(modelSBML.compartment),1);
0159 
0160 <span class="keyword">for</span> i=1:numel(modelSBML.compartment)
0161     compartmentNames{i}=modelSBML.compartment(i).name;
0162     compartmentIDs{i}=regexprep(modelSBML.compartment(i).id,<span class="string">'^C_'</span>,<span class="string">''</span>);
0163     <span class="keyword">if</span> isfield(modelSBML.compartment(i),<span class="string">'outside'</span>)
0164         <span class="keyword">if</span> ~isempty(modelSBML.compartment(i).outside)
0165             compartmentOutside{i}=regexprep(modelSBML.compartment(i).outside,<span class="string">'^C_'</span>,<span class="string">''</span>);
0166         <span class="keyword">else</span>
0167             compartmentOutside{i}=<span class="string">''</span>;
0168         <span class="keyword">end</span>
0169     <span class="keyword">else</span>
0170         compartmentOutside{i}=[];
0171     <span class="keyword">end</span>
0172 
0173     <span class="keyword">if</span> isfield(modelSBML.compartment(i),<span class="string">'annotation'</span>)
0174         compartmentMiriams{i}=<a href="#_sub4" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.compartment(i).annotation);
0175     <span class="keyword">else</span>
0176         compartmentMiriams{i}=[];
0177     <span class="keyword">end</span>
0178 <span class="keyword">end</span>
0179 
0180 <span class="comment">%If there are no compartment names then use compartment id as name</span>
0181 <span class="keyword">if</span> all(cellfun(@isempty,compartmentNames))
0182     compartmentNames=compartmentIDs;
0183 <span class="keyword">end</span>
0184 
0185 <span class="comment">%Retrieve info on metabolites, genes, complexes</span>
0186 metaboliteNames={};
0187 metaboliteIDs={};
0188 metaboliteCompartments={};
0189 metaboliteUnconstrained=[];
0190 metaboliteFormula={};
0191 metaboliteInChI={};
0192 metaboliteMiriams={};
0193 metaboliteCharge=[];
0194 
0195 geneNames={};
0196 geneIDs={};
0197 geneMiriams={};
0198 geneShortNames={};
0199 geneCompartments={};
0200 complexIDs={};
0201 complexNames={};
0202 
0203 <span class="comment">%If the file is not a COBRA Toolbox model. According to the format</span>
0204 <span class="comment">%specified in the yeast consensus model both metabolites and genes are a</span>
0205 <span class="comment">%type of 'species'. The metabolites have names starting with 'M_' and genes</span>
0206 <span class="comment">%with 'E_'.</span>
0207 
0208 <span class="keyword">for</span> i=1:numel(modelSBML.species)
0209     <span class="keyword">if</span> ~isSBML2COBRA
0210         <span class="keyword">if</span> length(modelSBML.species(i).id)&gt;=2 &amp;&amp; strcmpi(modelSBML.species(i).id(1:2),<span class="string">'E_'</span>)
0211             geneNames{numel(geneNames)+1,1}=modelSBML.species(i).name;
0212 
0213             <span class="comment">%The &quot;E_&quot; is included in the ID. This is because it's only used</span>
0214             <span class="comment">%internally in this file and it makes the matching a little</span>
0215             <span class="comment">%smoother</span>
0216             geneIDs{numel(geneIDs)+1,1}=modelSBML.species(i).id;
0217             geneCompartments{numel(geneCompartments)+1,1}=regexprep(modelSBML.species(i).compartment,<span class="string">'^C_'</span>,<span class="string">''</span>);
0218             
0219             <span class="comment">%Get Miriam structure</span>
0220             <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'annotation'</span>)
0221                 <span class="comment">%Get Miriam info</span>
0222                 geneMiriam=<a href="#_sub4" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.species(i).annotation);
0223                 geneMiriams{numel(geneMiriams)+1,1}=geneMiriam;
0224             <span class="keyword">else</span>
0225                 geneMiriams{numel(geneMiriams)+1,1}=[];
0226             <span class="keyword">end</span>
0227 
0228             <span class="comment">%Protein short names (for example ERG10) are saved as SHORT</span>
0229             <span class="comment">%NAME: NAME in the notes-section of metabolites for SBML Level</span>
0230             <span class="comment">%2 and as PROTEIN_ASSOCIATION for each reaction in SBML Level 2</span>
0231             <span class="comment">% COBRA Toolbox format. For now only the SHORT NAME is loaded</span>
0232             <span class="comment">% and no mapping takes place</span>
0233             <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'notes'</span>)
0234                 geneShortNames{numel(geneShortNames)+1,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'SHORT NAME'</span>);
0235             <span class="keyword">else</span>
0236                 geneShortNames{numel(geneShortNames)+1,1}=<span class="string">''</span>;
0237             <span class="keyword">end</span>;
0238         <span class="comment">%If it's a complex keep the ID and name</span>
0239         <span class="keyword">elseif</span> length(modelSBML.species(i).id)&gt;=2 &amp;&amp; strcmpi(modelSBML.species(i).id(1:3),<span class="string">'Cx_'</span>)
0240             complexIDs=[complexIDs;modelSBML.species(i).id];
0241             complexNames=[complexNames;modelSBML.species(i).name];
0242         <span class="keyword">else</span>
0243             <span class="comment">% If it is not gene or complex, then it must be a metabolite;</span>
0244             metaboliteNames{numel(metaboliteNames)+1,1}=modelSBML.species(i).name;
0245             metaboliteIDs{numel(metaboliteIDs)+1,1}=regexprep(modelSBML.species(i).id,<span class="string">'^M_'</span>,<span class="string">''</span>);
0246             metaboliteCompartments{numel(metaboliteCompartments)+1,1}=regexprep(modelSBML.species(i).compartment,<span class="string">'^C_'</span>,<span class="string">''</span>);
0247             metaboliteUnconstrained(numel(metaboliteUnconstrained)+1,1)=modelSBML.species(i).boundaryCondition;
0248 
0249             <span class="comment">%For each metabolite retrieve the formula and the InChI code if</span>
0250             <span class="comment">%available</span>
0251             <span class="comment">%First add the InChI code and the formula from the InChI. This</span>
0252             <span class="comment">%allows for overwriting the formula by setting the actual formula</span>
0253             <span class="comment">%field</span>
0254             <span class="keyword">if</span> ~isempty(modelSBML.species(i).annotation)
0255                 <span class="comment">%Get the formula if available</span>
0256                 startString=<span class="string">'&gt;InChI='</span>;
0257                 endString=<span class="string">'&lt;/in:inchi&gt;'</span>;
0258                 formStart=strfind(modelSBML.species(i).annotation,startString);
0259                 <span class="keyword">if</span> isempty(formStart)
0260                     startString=<span class="string">'InChI='</span>;
0261                     endString=<span class="string">'&quot;/&gt;'</span>;
0262                 <span class="keyword">end</span>;
0263                 formStart=strfind(modelSBML.species(i).annotation,startString); 
0264                 <span class="keyword">if</span> ~isempty(formStart)
0265                     formEnd=strfind(modelSBML.species(i).annotation,endString);
0266                     formEndIndex=find(formEnd&gt;formStart, 1 );
0267                     formula=modelSBML.species(i).annotation(formStart+numel(startString):formEnd(formEndIndex)-1);
0268                     metaboliteInChI{numel(metaboliteInChI)+1,1}=formula;
0269 
0270                     <span class="comment">%The composition is most often present between the first</span>
0271                     <span class="comment">%and second &quot;/&quot; in the model. In some simple molecules,</span>
0272                     <span class="comment">%such as salts, there is no second &quot;/&quot;. The formula is then</span>
0273                     <span class="comment">%assumed to be to the end of the string</span>
0274                     compositionIndexes=strfind(formula,<span class="string">'/'</span>);
0275                     <span class="keyword">if</span> numel(compositionIndexes)&gt;1
0276                         metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="keyword">...</span>
0277                             formula(compositionIndexes(1)+1:compositionIndexes(2)-1);
0278                     <span class="keyword">else</span>
0279                         <span class="keyword">if</span> numel(compositionIndexes)==1
0280                             <span class="comment">%Probably a simple molecule which can have only one</span>
0281                             <span class="comment">%conformation</span>
0282                             metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="keyword">...</span>
0283                             formula(compositionIndexes(1)+1:numel(formula));
0284                         <span class="keyword">else</span>
0285                             metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0286                         <span class="keyword">end</span>
0287                     <span class="keyword">end</span>
0288                 <span class="keyword">elseif</span> isfield(modelSBML.species(i),<span class="string">'fbc_chemicalFormula'</span>)
0289                     metaboliteInChI{numel(metaboliteInChI)+1,1}=<span class="string">''</span>;
0290                     <span class="keyword">if</span> ~isempty(modelSBML.species(i).fbc_chemicalFormula)
0291                         <span class="comment">% Cannot extract InChi from formula, so remains empty.</span>
0292                         metaboliteFormula{numel(metaboliteFormula)+1,1}=modelSBML.species(i).fbc_chemicalFormula;
0293                     <span class="keyword">else</span>
0294                         metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0295                     <span class="keyword">end</span>;
0296                 <span class="keyword">else</span>
0297                     metaboliteInChI{numel(metaboliteInChI)+1,1}=<span class="string">''</span>;
0298                     metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0299                 <span class="keyword">end</span>
0300 
0301                 <span class="comment">%Get Miriam info</span>
0302                 metMiriam=<a href="#_sub4" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.species(i).annotation);
0303                 metaboliteMiriams{numel(metaboliteMiriams)+1,1}=metMiriam;
0304             <span class="keyword">else</span>
0305                 metaboliteInChI{numel(metaboliteInChI)+1,1}=<span class="string">''</span>;
0306                 <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'notes'</span>)
0307                     metaboliteFormula{numel(metaboliteFormula)+1,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'FORMULA'</span>);
0308                 <span class="keyword">else</span>
0309                     metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0310                 <span class="keyword">end</span>;
0311                 metaboliteMiriams{numel(metaboliteMiriams)+1,1}=[];
0312             <span class="keyword">end</span>
0313             <span class="keyword">if</span> ~isempty(modelSBML.species(i).notes)
0314                 <span class="keyword">if</span> ~isfield(modelSBML.species(i),<span class="string">'annotation'</span>)
0315                     metaboliteFormula{numel(metaboliteFormula)+1,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'FORMULA'</span>);
0316                 <span class="keyword">end</span>;
0317             <span class="keyword">elseif</span> ~isfield(modelSBML.species(i),<span class="string">'annotation'</span>)
0318                 metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0319             <span class="keyword">end</span>;
0320         <span class="keyword">end</span>
0321         
0322     <span class="keyword">elseif</span> isSBML2COBRA
0323         <span class="comment">%The metabolite names are assumed to be M_NAME_COMPOSITION or</span>
0324         <span class="comment">%_NAME_COMPOSITION or NAME_COMPOSITION or NAME. Regular expressions</span>
0325         <span class="comment">%are used that only NAME_COMPOSITION or NAME would be possible</span>
0326         
0327         modelSBML.species(i).name=regexprep(modelSBML.species(i).name,<span class="string">'^M_'</span>,<span class="string">''</span>);
0328         modelSBML.species(i).name=regexprep(modelSBML.species(i).name,<span class="string">'^_'</span>,<span class="string">''</span>);     
0329         underscoreIndex=strfind(modelSBML.species(i).name,<span class="string">'_'</span>);
0330 
0331         metaboliteNames{numel(metaboliteNames)+1,1}=modelSBML.species(i).name;
0332         
0333         metaboliteIDs{numel(metaboliteIDs)+1,1}=regexprep(modelSBML.species(i).id,<span class="string">'^M_'</span>,<span class="string">''</span>);
0334         metaboliteCompartments{numel(metaboliteCompartments)+1,1}=regexprep(modelSBML.species(i).compartment,<span class="string">'^C_'</span>,<span class="string">''</span>);
0335 
0336         <span class="comment">%I think that COBRA doesn't set the boundary condition, but rather</span>
0337         <span class="comment">%uses name_b. Check for either</span>
0338         metaboliteUnconstrained(numel(metaboliteUnconstrained)+1,1)=modelSBML.species(i).boundaryCondition;
0339         <span class="keyword">if</span> strcmp(metaboliteIDs{end}(max(end-1,1):end),<span class="string">'_b'</span>)
0340             metaboliteUnconstrained(end)=1;
0341         <span class="keyword">end</span>
0342         
0343         <span class="comment">%Get the formula</span>
0344         <span class="keyword">if</span> max(underscoreIndex)&lt;length(modelSBML.species(i).name)
0345             metaboliteFormula{numel(metaboliteFormula)+1,1}=modelSBML.species(i).name(max(underscoreIndex)+1:length(modelSBML.species(i).name));
0346         <span class="keyword">else</span>
0347             metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0348         <span class="keyword">end</span>
0349 
0350         <span class="comment">%The old COBRA version sometimes has composition information in</span>
0351         <span class="comment">%the notes instead</span>
0352         <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'notes'</span>)
0353             metaboliteFormula{numel(metaboliteFormula)+1,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'FORMULA'</span>);
0354         <span class="keyword">end</span>;
0355     <span class="keyword">end</span>
0356     <span class="comment">% The following lines are executed regardless isSBML2COBRA setting;</span>
0357     <span class="keyword">if</span> isempty(modelSBML.species(i).id) || ~strcmpi(modelSBML.species(i).id(1:2),<span class="string">'E_'</span>)
0358         <span class="keyword">if</span> isempty(modelSBML.species(i).id) || ~strcmpi(modelSBML.species(i).id(1:3),<span class="string">'Cx_'</span>)
0359             <span class="comment">% Metabolite names could be of format NAME [compartment]. First</span>
0360             <span class="comment">% check whether metabolite name ends with square brackets, and</span>
0361             <span class="comment">% then check if the text within these brackets is a compartment</span>
0362             <span class="comment">% name. If so, then remove this section from the metabolite</span>
0363             <span class="comment">% name.</span>
0364             comp.match=regexp(modelSBML.species(i).name,<span class="string">'.* \[(.*)\]$'</span>,<span class="string">'match'</span>);
0365             <span class="keyword">if</span> ~isempty(comp.match)
0366                 comp.split=strsplit(comp.match{1},{<span class="string">'['</span>,<span class="string">']'</span>});
0367                 comp.true=any(strcmpi({modelSBML.compartment.name},comp.split{2}));
0368                 <span class="keyword">if</span> comp.true==1
0369                     metaboliteNames{numel(metaboliteNames),1}=strtrim(comp.split{1});
0370                 <span class="keyword">else</span>
0371                     metaboliteNames{numel(metaboliteNames),1}=regexprep(modelSBML.species(i).name,<span class="string">'^M_'</span>,<span class="string">''</span>);
0372                 <span class="keyword">end</span>
0373             <span class="keyword">else</span>
0374                 <span class="comment">%Use the full name</span>
0375                 metaboliteNames{i,1}=modelSBML.species(i).name;
0376             <span class="keyword">end</span>
0377             <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'fbc_charge'</span>)
0378                 <span class="keyword">if</span> ~isempty(modelSBML.species(i).fbc_charge) &amp;&amp; modelSBML.species(i).isSetfbc_charge
0379                     metaboliteCharge(numel(metaboliteCharge)+1,1)=double(modelSBML.species(i).fbc_charge);
0380                 <span class="keyword">else</span>
0381                     <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'notes'</span>)
0382                         <span class="keyword">if</span> strfind(modelSBML.species(i).notes,<span class="string">'CHARGE'</span>)
0383                             metaboliteCharge(numel(metaboliteCharge)+1,1)=str2double(<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'CHARGE'</span>));
0384                         <span class="keyword">else</span>
0385                             metaboliteCharge(numel(metaboliteCharge)+1,1)=NaN;
0386                         <span class="keyword">end</span>;
0387                     <span class="keyword">else</span>
0388                         metaboliteCharge(numel(metaboliteCharge)+1,1)=NaN;
0389                     <span class="keyword">end</span>
0390                 <span class="keyword">end</span>
0391             <span class="keyword">elseif</span> isfield(modelSBML.species(i),<span class="string">'notes'</span>)
0392                 <span class="keyword">if</span> strfind(modelSBML.species(i).notes,<span class="string">'CHARGE'</span>)
0393                     metaboliteCharge(numel(metaboliteCharge)+1,1)=str2double(<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'CHARGE'</span>));
0394                 <span class="keyword">else</span>
0395                     metaboliteCharge(numel(metaboliteCharge)+1,1)=NaN;
0396                 <span class="keyword">end</span>;
0397             <span class="keyword">else</span>
0398                 metaboliteCharge(numel(metaboliteCharge)+1,1)=NaN;
0399             <span class="keyword">end</span>
0400             <span class="comment">%Additional information from FBC format</span>
0401             <span class="comment">%Chemical formula</span>
0402             <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'fbc_chemicalFormula'</span>)
0403                 <span class="keyword">if</span> ~isempty(modelSBML.species(i).fbc_chemicalFormula)
0404                     metaboliteFormula{numel(metaboliteFormula),1}=modelSBML.species(i).fbc_chemicalFormula;
0405                 <span class="keyword">end</span>
0406             <span class="keyword">end</span>
0407         <span class="keyword">end</span>
0408     <span class="keyword">end</span>
0409 <span class="keyword">end</span>
0410 
0411 <span class="comment">%Retrieve info on reactions</span>
0412 reactionNames=cell(numel(modelSBML.reaction),1);
0413 reactionIDs=cell(numel(modelSBML.reaction),1);
0414 subsystems=cell(numel(modelSBML.reaction),1);
0415 eccodes=cell(numel(modelSBML.reaction),1);
0416 eccodes(:,:)=cellstr(<span class="string">''</span>);
0417 confidencescores=cell(numel(modelSBML.reaction),1);
0418 confidencescores(:,:)=cellstr(<span class="string">''</span>);
0419 rxnreferences=cell(numel(modelSBML.reaction),1);
0420 rxnreferences(:,:)=cellstr(<span class="string">''</span>);
0421 rxnnotes=cell(numel(modelSBML.reaction),1);
0422 rxnnotes(:,:)=cellstr(<span class="string">''</span>);
0423 grRules=cell(numel(modelSBML.reaction),1);
0424 grRules(:,:)=cellstr(<span class="string">''</span>);
0425 grRulesFromModifier=grRules;
0426 rxnComps=zeros(numel(modelSBML.reaction),1);
0427 rxnMiriams=cell(numel(modelSBML.reaction),1);
0428 reactionReversibility=zeros(numel(modelSBML.reaction),1);
0429 reactionUB=zeros(numel(modelSBML.reaction),1);
0430 reactionLB=zeros(numel(modelSBML.reaction),1);
0431 reactionObjective=zeros(numel(modelSBML.reaction),1);
0432 
0433 <span class="comment">%Construct the stoichiometric matrix while the reaction info is read</span>
0434 S=zeros(numel(metaboliteIDs),numel(modelSBML.reaction));
0435 
0436 counter=0;
0437 <span class="comment">%If FBC, then bounds have parameter ids defined for the whole model</span>
0438 <span class="keyword">if</span> isfield(modelSBML,<span class="string">'parameter'</span>)
0439     parameter.name=cell(numel(modelSBML.parameter),1);
0440     parameter.name={modelSBML.parameter(:).id}';
0441     parameter.value={modelSBML.parameter(:).value}';
0442 <span class="keyword">end</span>
0443 
0444 <span class="keyword">for</span> i=1:numel(modelSBML.reaction)
0445 
0446     <span class="comment">%Check that the reaction doesn't produce a complex and nothing else.</span>
0447     <span class="comment">%If so, then jump to the next reaction. This is because I get the</span>
0448     <span class="comment">%genes for complexes from the names and not from the reactions that</span>
0449     <span class="comment">%create them. This only applies to the non-COBRA format.</span>
0450     <span class="keyword">if</span> numel(modelSBML.reaction(i).product)==1
0451         <span class="keyword">if</span> length(modelSBML.reaction(i).product(1).species)&gt;=3
0452             <span class="keyword">if</span> strcmp(modelSBML.reaction(i).product(1).species(1:3),<span class="string">'Cx_'</span>)==true
0453                 <span class="keyword">continue</span>;
0454             <span class="keyword">end</span>
0455         <span class="keyword">end</span>
0456     <span class="keyword">end</span>
0457 
0458     <span class="comment">%It didn't look like a gene complex-forming reaction</span>
0459     counter=counter+1;
0460 
0461     reactionNames{counter}=modelSBML.reaction(i).name;
0462 
0463     reactionIDs{counter}=modelSBML.reaction(i).id;
0464     reactionReversibility(counter)=modelSBML.reaction(i).reversible;
0465 
0466     <span class="comment">%If model is FBC, first get parameter of bound and then replace it</span>
0467     <span class="comment">%with the correct value. Probably faster with replace(), but this was</span>
0468     <span class="comment">%only introduced in Matlab R2016b</span>
0469     <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'fbc_lowerFluxBound'</span>)
0470         lb=modelSBML.reaction(i).fbc_lowerFluxBound;
0471         ub=modelSBML.reaction(i).fbc_upperFluxBound;
0472         <span class="keyword">for</span> n=1:numel(parameter.value)
0473             lb=regexprep(lb,parameter.name(n),num2str(parameter.value{n}));
0474             ub=regexprep(ub,parameter.name(n),num2str(parameter.value{n}));
0475         <span class="keyword">end</span>
0476         reactionLB(counter)=str2num(lb);
0477         reactionUB(counter)=str2num(ub);
0478     <span class="comment">%The order of these parameters should not be hard coded</span>
0479     <span class="keyword">elseif</span> isfield(modelSBML.reaction(i).kineticLaw,<span class="string">'parameter'</span>)
0480         reactionLB(counter)=modelSBML.reaction(i).kineticLaw.parameter(1).value;
0481         reactionUB(counter)=modelSBML.reaction(i).kineticLaw.parameter(2).value;
0482         reactionObjective(counter)=modelSBML.reaction(i).kineticLaw.parameter(3).value;
0483     <span class="keyword">else</span>
0484         <span class="keyword">if</span> reactionReversibility(counter)==true
0485             reactionLB(counter)=-inf;
0486         <span class="keyword">else</span>
0487             reactionLB(counter)=0;
0488         <span class="keyword">end</span>
0489         reactionUB(counter)=inf;
0490         reactionObjective(counter)=0;
0491     <span class="keyword">end</span>
0492 
0493     <span class="comment">%Find the associated gene if available</span>
0494     <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'modifier'</span>)
0495         <span class="keyword">if</span> ~isempty(modelSBML.reaction(i).modifier)
0496             rules=<span class="string">''</span>;
0497             <span class="keyword">for</span> j=1:numel(modelSBML.reaction(i).modifier)
0498                 modifier=modelSBML.reaction(i).modifier(j).species;
0499                 <span class="keyword">if</span> ~isempty(modifier)
0500                     <span class="keyword">if</span> strcmpi(modifier(1:2),<span class="string">'E_'</span>)
0501                         index=find(strcmp(modifier,geneIDs));
0502                         <span class="comment">%This should be unique and in the geneIDs list, otherwise</span>
0503                         <span class="comment">%something is wrong</span>
0504                         <span class="keyword">if</span> numel(index)~=1
0505                             EM=[<span class="string">'Could not get the gene association data from reaction '</span> reactionIDs{i}];
0506                             dispEM(EM);
0507                         <span class="keyword">end</span>
0508                         <span class="comment">%Add the association</span>
0509                         <span class="comment">%rxnGeneMat(i,index)=1;</span>
0510                         <span class="keyword">if</span> ~isempty(rules)
0511                             rules=[rules <span class="string">' or ('</span> geneNames{index} <span class="string">')'</span>];
0512                         <span class="keyword">else</span>
0513                             rules=[<span class="string">'('</span> geneNames{index} <span class="string">')'</span>];
0514                         <span class="keyword">end</span>
0515                     <span class="keyword">elseif</span> strcmp(modifier(1:2),<span class="string">'s_'</span>)
0516                         index=find(strcmp(modifier,metaboliteIDs));
0517                         <span class="comment">%This should be unique and in the geneIDs list, otherwise</span>
0518                         <span class="comment">%something is wrong</span>
0519                         <span class="keyword">if</span> numel(index)~=1
0520                             EM=[<span class="string">'Could not get the gene association data from reaction '</span> reactionIDs{i}];
0521                             dispEM(EM);
0522                         <span class="keyword">end</span>
0523                         <span class="comment">%Add the association</span>
0524                         <span class="comment">%rxnGeneMat(i,index)=1;</span>
0525                         <span class="keyword">if</span> ~isempty(rules)
0526                             rules=[rules <span class="string">' or ('</span> metaboliteIDs{index} <span class="string">')'</span>];
0527                         <span class="keyword">else</span>
0528                             rules=[<span class="string">'('</span> metaboliteIDs{index} <span class="string">')'</span>];
0529                         <span class="keyword">end</span>
0530                     <span class="keyword">else</span>
0531                        <span class="comment">%It seems to be a complex. Add the corresponding</span>
0532                        <span class="comment">%genes from the name of the complex (not the</span>
0533                        <span class="comment">%reaction that creates it)</span>
0534                        index=find(strcmp(modifier,complexIDs));
0535                        <span class="keyword">if</span> numel(index)==1
0536                            <span class="keyword">if</span> ~isempty(rules)
0537                                 rules=[rules <span class="string">' or ('</span> strrep(complexNames{index},<span class="string">':'</span>,<span class="string">' and '</span>) <span class="string">')'</span>];
0538                             <span class="keyword">else</span>
0539                                 rules=[<span class="string">'('</span> strrep(complexNames{index},<span class="string">':'</span>,<span class="string">' and '</span>) <span class="string">')'</span>];
0540                            <span class="keyword">end</span>
0541                        <span class="keyword">else</span>
0542                           <span class="comment">%Could not find a complex</span>
0543                           EM=[<span class="string">'Could not get the gene association data from reaction '</span> reactionIDs{i}];
0544                           dispEM(EM);
0545                        <span class="keyword">end</span>
0546                     <span class="keyword">end</span>
0547                 <span class="keyword">end</span>
0548             <span class="keyword">end</span>
0549             grRules{counter}=rules;
0550             grRulesFromModifier{counter}=rules;<span class="comment">%Backup copy for grRules, useful to parse Yeast 7.6</span>
0551         <span class="keyword">end</span>
0552     <span class="keyword">end</span>
0553     <span class="comment">% This section was previously executed only if isSBML2COBRA is true.</span>
0554     <span class="comment">% Now it will be executed, if 'GENE_ASSOCIATION' is found in</span>
0555     <span class="comment">% modelSBML.reaction(i).notes</span>
0556     <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'notes'</span>)
0557         <span class="keyword">if</span> strfind(modelSBML.reaction(i).notes,<span class="string">'GENE_ASSOCIATION'</span>)
0558             geneAssociation=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'GENE_ASSOCIATION'</span>);
0559         <span class="keyword">elseif</span> strfind(modelSBML.reaction(i).notes,<span class="string">'GENE ASSOCIATION'</span>)
0560             geneAssociation=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'GENE ASSOCIATION'</span>);
0561         <span class="keyword">else</span>
0562             geneAssociation=<span class="string">''</span>;
0563         <span class="keyword">end</span>;
0564     <span class="keyword">end</span>;
0565 
0566     <span class="keyword">if</span> ~isempty(geneAssociation)
0567         <span class="comment">%This adds the grRules. The gene list and rxnGeneMat</span>
0568         <span class="comment">%are created later</span>
0569         grRules{counter}=geneAssociation;
0570     <span class="keyword">end</span>;
0571     
0572     <span class="comment">% If FBC, get gene association data from corresponding fields;</span>
0573     <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'fbc_geneProductAssociation'</span>)
0574         <span class="keyword">if</span> ~isempty(modelSBML.reaction(i).fbc_geneProductAssociation) &amp;&amp; ~isempty(modelSBML.reaction(i).fbc_geneProductAssociation.fbc_association)
0575             grRules{counter}=modelSBML.reaction(i).fbc_geneProductAssociation.fbc_association.fbc_association;
0576         <span class="keyword">end</span>;
0577     <span class="keyword">end</span>;
0578 
0579     <span class="comment">%Add reaction compartment</span>
0580     <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'compartment'</span>)
0581         <span class="keyword">if</span> ~isempty(modelSBML.reaction(i).compartment)
0582             rxnComp=modelSBML.reaction(i).compartment;
0583         <span class="keyword">else</span>
0584             rxnComp=<span class="string">''</span>;
0585         <span class="keyword">end</span>;
0586     <span class="keyword">elseif</span> isfield(modelSBML.reaction(i),<span class="string">'notes'</span>)
0587         rxnComp=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'COMPARTMENT'</span>);
0588     <span class="keyword">end</span>;
0589     <span class="keyword">if</span> ~isempty(rxnComp)
0590         <span class="comment">%Find it in the compartment list</span>
0591         [~, J]=ismember(rxnComp,compartmentIDs);
0592         rxnComps(counter)=J;
0593     <span class="keyword">end</span>;
0594 
0595     <span class="comment">%Get other Miriam fields. This may include for example database indexes</span>
0596     <span class="comment">%to organism-specific databases. EC-codes are supported by the COBRA</span>
0597     <span class="comment">%Toolbox format and are therefore loaded separately</span>
0598     <span class="keyword">if</span> isSBML2COBRA==false
0599         miriamStruct=<a href="#_sub4" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.reaction(i).annotation);
0600         rxnMiriams{counter}=miriamStruct;
0601         <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'notes'</span>)
0602             subsystems{counter,1}=cellstr(<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'SUBSYSTEM'</span>));
0603             confidencescores{counter,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'Confidence Level'</span>);
0604             rxnreferences{counter,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'AUTHORS'</span>);
0605             rxnnotes{counter,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'NOTES'</span>);
0606         <span class="keyword">end</span>;
0607     <span class="keyword">end</span>
0608 
0609     <span class="comment">%Get ec-codes</span>
0610     eccode=<span class="string">''</span>;
0611     <span class="keyword">if</span> ~isempty(modelSBML.reaction(i).annotation)
0612         <span class="keyword">if</span> strfind(modelSBML.reaction(i).annotation,<span class="string">'urn:miriam:ec-code'</span>)
0613             eccode=<a href="#_sub3" class="code" title="subfunction fieldContent=parseAnnotation(searchString,startString,midString,fieldName)">parseAnnotation</a>(modelSBML.reaction(i).annotation,<span class="string">'urn:miriam:'</span>,<span class="string">':'</span>,<span class="string">'ec-code'</span>);
0614         <span class="keyword">elseif</span> strfind(modelSBML.reaction(i).annotation,<span class="string">'http://identifiers.org/ec-code'</span>)
0615             eccode=<a href="#_sub3" class="code" title="subfunction fieldContent=parseAnnotation(searchString,startString,midString,fieldName)">parseAnnotation</a>(modelSBML.reaction(i).annotation,<span class="string">'http://identifiers.org/'</span>,<span class="string">'/'</span>,<span class="string">'ec-code'</span>);
0616         <span class="keyword">end</span>;
0617     <span class="keyword">elseif</span> isfield(modelSBML.reaction(i),<span class="string">'notes'</span>)
0618         <span class="keyword">if</span> strfind(modelSBML.reaction(i).notes,<span class="string">'EC Number'</span>)
0619             eccode=[eccode <a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'EC Number'</span>)];
0620         <span class="keyword">elseif</span> strfind(modelSBML.reaction(i).notes,<span class="string">'PROTEIN_CLASS'</span>)
0621             eccode=[eccode <a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'PROTEIN_CLASS'</span>)];
0622         <span class="keyword">end</span>;  
0623     <span class="keyword">end</span>;
0624     eccodes{counter}=eccode;
0625     
0626     <span class="comment">%Add all reactants</span>
0627     <span class="keyword">for</span> j=1:numel(modelSBML.reaction(i).reactant)
0628        <span class="comment">%Get the index of the metabolite in metaboliteIDs. External</span>
0629        <span class="comment">%metabolites will be removed at a later stage</span>
0630        metIndex=find(strcmp(modelSBML.reaction(i).reactant(j).species,metaboliteIDs),1);
0631        <span class="keyword">if</span> isempty(metIndex)
0632            EM=[<span class="string">'Could not find metabolite '</span> modelSBML.reaction(i).reactant(j).species <span class="string">' in reaction '</span> reactionIDs{counter}];
0633            dispEM(EM);
0634        <span class="keyword">end</span>
0635        S(metIndex,counter)=S(metIndex,counter)+modelSBML.reaction(i).reactant(j).stoichiometry*-1;
0636     <span class="keyword">end</span>
0637 
0638     <span class="comment">%Add all products</span>
0639     <span class="keyword">for</span> j=1:numel(modelSBML.reaction(i).product)
0640        <span class="comment">%Get the index of the metabolite in metaboliteIDs.</span>
0641        metIndex=find(strcmp(modelSBML.reaction(i).product(j).species,metaboliteIDs),1);
0642        <span class="keyword">if</span> isempty(metIndex)
0643            EM=[<span class="string">'Could not find metabolite '</span> modelSBML.reaction(i).reactant(j).species <span class="string">' in reaction '</span> reactionIDs{counter}];
0644            dispEM(EM);
0645        <span class="keyword">end</span>
0646        S(metIndex,counter)=S(metIndex,counter)+modelSBML.reaction(i).product(j).stoichiometry;
0647     <span class="keyword">end</span>
0648 <span class="keyword">end</span>
0649 
0650 <span class="comment">%subSystems can be stored as groups instead of in annotations</span>
0651 <span class="keyword">if</span> isfield(modelSBML,<span class="string">'groups_group'</span>)
0652     <span class="keyword">for</span> i=1:numel(modelSBML.groups_group)
0653         groupreactions={modelSBML.groups_group(i).groups_member(:).groups_idRef};
0654         groupreactions=regexprep(groupreactions,<span class="string">'^R_'</span>,<span class="string">''</span>);
0655         [~, idx] = ismember(groupreactions, reactionIDs);
0656         <span class="keyword">for</span> j=1:numel(idx)
0657             <span class="keyword">if</span> isempty(subsystems{idx(j)}) <span class="comment">% First subsystem</span>
0658                 subsystems{idx(j)} = {modelSBML.groups_group(i).groups_name};
0659             <span class="keyword">else</span> <span class="comment">% Consecutive subsystems: concatenate</span>
0660                 subsystems{idx(j)} = horzcat(subsystems{idx(j)}, modelSBML.groups_group(i).groups_name);
0661             <span class="keyword">end</span>
0662         <span class="keyword">end</span>
0663     <span class="keyword">end</span>
0664 <span class="keyword">end</span>
0665 
0666 <span class="comment">%Shrink the structures if complex-forming reactions had to be skipped</span>
0667 reactionNames=reactionNames(1:counter);
0668 reactionIDs=reactionIDs(1:counter);
0669 subsystems=subsystems(1:counter);
0670 eccodes=eccodes(1:counter);
0671 confidencescores=confidencescores(1:counter);
0672 rxnreferences=rxnreferences(1:counter);
0673 rxnnotes=rxnnotes(1:counter);
0674 grRules=grRules(1:counter);
0675 rxnMiriams=rxnMiriams(1:counter);
0676 reactionReversibility=reactionReversibility(1:counter);
0677 reactionUB=reactionUB(1:counter);
0678 reactionLB=reactionLB(1:counter);
0679 reactionObjective=reactionObjective(1:counter);
0680 S=S(:,1:counter);
0681 
0682 model.description=modelSBML.name;
0683 model.id=modelSBML.id;
0684 model.rxns=reactionIDs;
0685 model.mets=metaboliteIDs;
0686 model.S=sparse(S);
0687 model.lb=reactionLB;
0688 model.ub=reactionUB;
0689 model.rev=reactionReversibility;
0690 model.c=reactionObjective;
0691 model.b=zeros(numel(metaboliteIDs),1);
0692 model.comps=compartmentIDs;
0693 model.compNames=compartmentNames;
0694 model.rxnConfidenceScores=confidencescores;
0695 model.rxnReferences=rxnreferences;
0696 model.rxnNotes=rxnnotes;
0697 
0698 <span class="comment">%Load annotation if available. If there are several authors, only the first</span>
0699 <span class="comment">%author credentials are imported</span>
0700 <span class="keyword">if</span> isfield(modelSBML,<span class="string">'annotation'</span>)
0701     endString=<span class="string">'&lt;/'</span>;
0702     I=strfind(modelSBML.annotation,endString);
0703     J=strfind(modelSBML.annotation,<span class="string">'&lt;vCard:Family&gt;'</span>);
0704     <span class="keyword">if</span> any(J)
0705        model.annotation.familyName=modelSBML.annotation(J(1)+14:I(find(I&gt;J(1),1))-1);
0706     <span class="keyword">end</span>
0707     J=strfind(modelSBML.annotation,<span class="string">'&lt;vCard:Given&gt;'</span>);
0708     <span class="keyword">if</span> any(J)
0709        model.annotation.givenName=modelSBML.annotation(J(1)+13:I(find(I&gt;J(1),1))-1);
0710     <span class="keyword">end</span>
0711     J=strfind(modelSBML.annotation,<span class="string">'&lt;vCard:EMAIL&gt;'</span>);
0712     <span class="keyword">if</span> any(J)
0713        model.annotation.email=modelSBML.annotation(J(1)+13:I(find(I&gt;J(1),1))-1);
0714     <span class="keyword">end</span>
0715     J=strfind(modelSBML.annotation,<span class="string">'&lt;vCard:Orgname&gt;'</span>);
0716     <span class="keyword">if</span> any(J)
0717        model.annotation.organization=modelSBML.annotation(J(1)+15:I(find(I&gt;J(1),1))-1);
0718     <span class="keyword">end</span>
0719     endString=<span class="string">'&quot;/&gt;'</span>;
0720     I=strfind(modelSBML.annotation,endString);
0721     <span class="keyword">if</span> strfind(modelSBML.annotation,<span class="string">'&quot;urn:miriam:'</span>)
0722         J=strfind(modelSBML.annotation,<span class="string">'&quot;urn:miriam:'</span>);
0723         <span class="keyword">if</span> any(J)
0724             model.annotation.taxonomy=modelSBML.annotation(J+12:I(find(I&gt;J,1))-1);
0725         <span class="keyword">end</span>;
0726     <span class="keyword">else</span>
0727         J=strfind(modelSBML.annotation,<span class="string">'&quot;http://identifiers.org/'</span>);
0728         <span class="keyword">if</span> any(J)
0729             model.annotation.taxonomy=modelSBML.annotation(J+24:I(find(I&gt;J,1))-1);
0730         <span class="keyword">end</span>
0731     <span class="keyword">end</span>
0732 <span class="keyword">end</span>
0733 <span class="keyword">if</span> isfield(modelSBML,<span class="string">'notes'</span>)
0734     startString=strfind(modelSBML.notes,<span class="string">'xhtml&quot;&gt;'</span>);
0735     endString=strfind(modelSBML.notes,<span class="string">'&lt;/body&gt;'</span>);
0736     <span class="keyword">if</span> any(startString) &amp;&amp; any(endString)
0737        model.annotation.note=modelSBML.notes(startString+7:endString-1);
0738        model.annotation.note=regexprep(model.annotation.note,<span class="string">'&lt;p&gt;|&lt;/p&gt;'</span>,<span class="string">''</span>);
0739        model.annotation.note=strtrim(model.annotation.note);
0740     <span class="keyword">end</span>
0741 <span class="keyword">end</span>
0742 
0743 <span class="keyword">if</span> any(~cellfun(@isempty,compartmentOutside))
0744     model.compOutside=compartmentOutside;
0745 <span class="keyword">end</span>
0746 
0747 model.rxnNames=reactionNames;
0748 model.metNames=metaboliteNames;
0749 
0750 <span class="comment">%Match the compartments for metabolites</span>
0751 [~, J]=ismember(metaboliteCompartments,model.comps);
0752 model.metComps=J;
0753 
0754 <span class="comment">%If any genes have been loaded (only for the new format)</span>
0755 <span class="keyword">if</span> ~isempty(geneNames)
0756     <span class="comment">%In some rare cases geneNames may not necessarily be used in grRules.</span>
0757     <span class="comment">%That is true for Yeast 7.6. It's therefore important to change gene</span>
0758     <span class="comment">%systematic names to geneIDs in sophisticated way. Gene systematic</span>
0759     <span class="comment">%names are not unique, since exactly the same name may be in different</span>
0760     <span class="comment">%compartments</span>
0761     <span class="keyword">if</span> all(cellfun(@isempty,strfind(grRules,geneNames{1})))
0762         geneShortNames=geneNames;
0763         <span class="comment">% geneShortNames contain compartments as well, so these are</span>
0764         <span class="comment">% removed;</span>
0765         geneShortNames=regexprep(geneShortNames,<span class="string">' \[.+$'</span>,<span class="string">''</span>);
0766         <span class="comment">% grRules obtained from modifier fields contain geneNames. These</span>
0767         <span class="comment">% are changed into geneIDs. grRulesFromModifier is a good way to</span>
0768         <span class="comment">% have geneIDs and rxns association when it's important to resolve</span>
0769         <span class="comment">% systematic name ambiguities;</span>
0770         grRulesFromModifier=regexprep(regexprep(grRulesFromModifier,<span class="string">'\[|\]'</span>,<span class="string">'_'</span>),regexprep(geneNames,<span class="string">'\[|\]'</span>,<span class="string">'_'</span>),geneIDs);
0771         grRules=regexprep(regexprep(grRules,<span class="string">'\[|\]'</span>,<span class="string">'_'</span>),regexprep(geneNames,<span class="string">'\[|\]'</span>,<span class="string">'_'</span>),geneIDs);
0772         
0773         <span class="comment">%Yeast 7.6 contains several metabolites, which were used in gene</span>
0774         <span class="comment">%associations. For that reason, the list of species ID is created</span>
0775         <span class="comment">%and we then check whether any of them have kegg.genes annotation</span>
0776         <span class="comment">%thereby obtaining systematic gene names;</span>
0777         geneShortNames=vertcat(geneShortNames,metaboliteNames);
0778         geneIDs=vertcat(geneIDs,metaboliteIDs);
0779         geneSystNames=extractMiriam(vertcat(geneMiriams,metaboliteMiriams),<span class="string">'kegg.genes'</span>);
0780         geneSystNames=regexprep(geneSystNames,<span class="string">'^.+:'</span>,<span class="string">''</span>);
0781         geneCompartments=vertcat(geneCompartments,metaboliteCompartments);
0782         geneMiriams=vertcat(geneMiriams,metaboliteMiriams);
0783         
0784         <span class="comment">%Now we retain information for only these entries, which have</span>
0785         <span class="comment">%kegg.genes annotation;</span>
0786         geneShortNames=geneShortNames(~cellfun(<span class="string">'isempty'</span>,geneSystNames));        
0787         geneIDs=geneIDs(~cellfun(<span class="string">'isempty'</span>,geneSystNames));
0788         geneSystNames=geneSystNames(~cellfun(<span class="string">'isempty'</span>,geneSystNames));
0789         geneCompartments=geneCompartments(~cellfun(<span class="string">'isempty'</span>,geneSystNames));
0790         geneMiriams=geneMiriams(~cellfun(<span class="string">'isempty'</span>,geneSystNames));
0791         <span class="comment">%Now we reorder geneIDs and geneSystNames by geneSystNames string</span>
0792         <span class="comment">%length;</span>
0793         geneNames=geneIDs;<span class="comment">%Backuping geneIDs, since we need unsorted order for later;</span>
0794         [~, Indx] = sort(cellfun(<span class="string">'size'</span>, geneSystNames, 2), <span class="string">'descend'</span>);
0795         geneIDs = geneIDs(Indx);
0796         geneSystNames = geneSystNames(Indx);
0797         <span class="keyword">for</span> i=1:numel(geneSystNames)
0798             <span class="keyword">for</span> j=1:numel(grRules)
0799                 <span class="keyword">if</span> strfind(grRules{j},geneSystNames{i})
0800                     <span class="keyword">if</span> ~isempty(grRules{j})
0801                         <span class="keyword">if</span> sum(ismember(geneSystNames,geneSystNames{i}))==1
0802                             grRules{j}=regexprep(grRules{j},geneSystNames{i},geneIDs{i});
0803                         <span class="keyword">elseif</span> sum(ismember(geneSystNames,geneSystNames{i}))&gt;1
0804                             counter=0;
0805                             ovrlpIDs=geneIDs(ismember(geneSystNames,geneSystNames{i}));
0806                             <span class="keyword">for</span> k=1:numel(ovrlpIDs)
0807                                 <span class="keyword">if</span> strfind(grRulesFromModifier{j},ovrlpIDs{k})
0808                                     counter=counter+1;
0809                                     grRules{j}=regexprep(grRules{j},geneSystNames{i},ovrlpIDs{k});
0810                                 <span class="keyword">end</span>;
0811                                 <span class="keyword">if</span> counter&gt;1
0812                                     EM=[<span class="string">'Gene association is ambiguous for reaction '</span> modelSBML.reaction(j).id];
0813                                     dispEM(EM);
0814                                 <span class="keyword">end</span>;
0815                             <span class="keyword">end</span>;
0816                         <span class="keyword">end</span>;
0817                     <span class="keyword">end</span>;
0818                 <span class="keyword">end</span>;
0819             <span class="keyword">end</span>;
0820         <span class="keyword">end</span>;
0821     <span class="keyword">end</span>;              
0822     model.genes=geneNames;
0823     model.rxnGeneMat=<a href="#_sub1" class="code" title="subfunction [rxnGeneMat, matchGenes]=getGeneMat(grRules,matchGenes)">getGeneMat</a>(grRules,geneNames);
0824     model.grRules=grRules;
0825     <span class="comment">%Match the compartments for genes</span>
0826     [~, J]=ismember(geneCompartments,model.comps);
0827     model.geneComps=J;
0828 <span class="keyword">else</span>
0829     <span class="keyword">if</span> ~isempty(grRules)
0830        <span class="comment">%In the non-COBRA version genes are surrounded by parenthesis even</span>
0831        <span class="comment">%if they are the only gene. Also, only single spaces are used</span>
0832        <span class="comment">%between genes. I'm pretty sure this is compatible with COBRA Toolbox so I</span>
0833        <span class="comment">%change it to be the same here.</span>
0834        grRules=strrep(grRules,<span class="string">'  '</span>,<span class="string">' '</span>);
0835        grRules=strrep(grRules,<span class="string">'( '</span>,<span class="string">'('</span>);
0836        grRules=strrep(grRules,<span class="string">' )'</span>,<span class="string">')'</span>);
0837        grRules=strrep(grRules,<span class="string">') or ('</span>,<span class="string">'*%%%%*'</span>);
0838        grRules=strrep(grRules,<span class="string">' or '</span>,<span class="string">') or ('</span>);
0839        grRules=strrep(grRules,<span class="string">'*%%%%*'</span>,<span class="string">') or ('</span>);
0840        grRules=regexprep(grRules,<span class="string">'\(\((.*)\)\)'</span>,<span class="string">'\($1\)'</span>); 
0841 
0842        <span class="comment">%Not very neat, but add parenthesis if missing</span>
0843        <span class="keyword">for</span> i=1:numel(grRules)
0844           <span class="keyword">if</span> any(grRules{i})
0845               <span class="keyword">if</span> ~strcmp(grRules{i}(1),<span class="string">'('</span>)
0846                   grRules{i}=[<span class="string">'('</span> grRules{i} <span class="string">')'</span>];
0847               <span class="keyword">end</span>
0848           <span class="keyword">end</span>
0849        <span class="keyword">end</span>
0850        <span class="comment">%If fbc_geneProduct exist, follow the specified gene order, such</span>
0851        <span class="comment">%that matching geneShortNames in function below will work.</span>
0852        <span class="keyword">if</span> isfield(modelSBML,<span class="string">'fbc_geneProduct'</span>)
0853            [rxnGeneMat, genes]=<a href="#_sub1" class="code" title="subfunction [rxnGeneMat, matchGenes]=getGeneMat(grRules,matchGenes)">getGeneMat</a>(grRules,{modelSBML.fbc_geneProduct.fbc_id});
0854        <span class="keyword">else</span>
0855            [rxnGeneMat, genes]=<a href="#_sub1" class="code" title="subfunction [rxnGeneMat, matchGenes]=getGeneMat(grRules,matchGenes)">getGeneMat</a>(grRules);
0856        <span class="keyword">end</span>
0857        model.rxnGeneMat=rxnGeneMat;
0858        <span class="keyword">if</span> strcmpi(genes{1}(1:2),<span class="string">'G_'</span>)
0859            genes=regexprep(genes,<span class="string">'^G_'</span>,<span class="string">''</span>);
0860            grRules=regexprep(grRules,<span class="string">'^G_'</span>,<span class="string">''</span>);
0861            grRules=regexprep(grRules,<span class="string">'\(G_'</span>,<span class="string">'('</span>);
0862            grRules=regexprep(grRules,<span class="string">' G_'</span>,<span class="string">' '</span>);
0863        <span class="keyword">end</span>
0864        model.genes=genes;
0865        model.grRules=grRules;
0866     <span class="keyword">end</span>
0867 <span class="keyword">end</span>
0868 
0869 <span class="comment">% Make sure that AND and OR string are in lowercase in grRules</span>
0870 model.grRules=strrep(model.grRules,<span class="string">' AND '</span>,<span class="string">' and '</span>);
0871 model.grRules=strrep(model.grRules,<span class="string">' OR '</span>,<span class="string">' or '</span>);
0872 
0873 <span class="keyword">if</span> all(cellfun(@isempty,geneShortNames))
0874     <span class="keyword">if</span> isfield(modelSBML,<span class="string">'fbc_geneProduct'</span>)
0875         <span class="keyword">for</span> i=1:numel(genes)
0876             <span class="keyword">if</span> ~isempty(modelSBML.fbc_geneProduct(i).fbc_label)
0877                 geneShortNames{i,1}=modelSBML.fbc_geneProduct(i).fbc_label;
0878             <span class="keyword">elseif</span> ~isempty(modelSBML.fbc_geneProduct(i).fbc_name)
0879                 geneShortNames{i,1}=modelSBML.fbc_geneProduct(i).fbc_name;
0880             <span class="keyword">else</span>
0881                 geneShortNames{i,1}=<span class="string">''</span>;
0882             <span class="keyword">end</span>;
0883         <span class="keyword">end</span>;
0884     <span class="keyword">end</span>;
0885 <span class="keyword">end</span>;
0886 
0887 <span class="comment">%If any InChIs have been loaded</span>
0888 <span class="keyword">if</span> any(~cellfun(@isempty,metaboliteInChI))
0889     model.inchis=metaboliteInChI;
0890 <span class="keyword">end</span>
0891 
0892 <span class="comment">%If any formulas have been loaded</span>
0893 <span class="keyword">if</span> any(~cellfun(@isempty,metaboliteFormula))
0894     model.metFormulas=metaboliteFormula;
0895 <span class="keyword">end</span>
0896 
0897 <span class="comment">%If any charges have been loaded</span>
0898 <span class="keyword">if</span> ~isempty(metaboliteCharge)
0899     model.metCharges=metaboliteCharge;
0900 <span class="keyword">end</span>
0901 
0902 <span class="comment">%If any gene short names have been loaded</span>
0903 <span class="keyword">if</span> any(~cellfun(@isempty,geneShortNames))
0904     model.geneShortNames=geneShortNames;
0905 <span class="keyword">end</span>
0906 
0907 <span class="comment">%If any Miriam strings for compartments have been loaded</span>
0908 <span class="keyword">if</span> any(~cellfun(@isempty,compartmentMiriams))
0909     model.compMiriams=compartmentMiriams;
0910 <span class="keyword">end</span>
0911 
0912 <span class="comment">%If any Miriam strings for metabolites have been loaded</span>
0913 <span class="keyword">if</span> any(~cellfun(@isempty,metaboliteMiriams))
0914     model.metMiriams=metaboliteMiriams;
0915 <span class="keyword">end</span>
0916 
0917 <span class="comment">%If any subsystems have been loaded</span>
0918 <span class="keyword">if</span> any(~cellfun(@isempty,subsystems))
0919     model.subSystems=subsystems;
0920 <span class="keyword">end</span>
0921 <span class="keyword">if</span> any(rxnComps)
0922    <span class="keyword">if</span> all(rxnComps)
0923        model.rxnComps=rxnComps;
0924    <span class="keyword">else</span>
0925        <span class="keyword">if</span> supressWarnings==false
0926            EM=<span class="string">'The compartments for the following reactions could not be matched. Ignoring reaction compartment information'</span>;
0927            dispEM(EM,false,model.rxns(rxnComps==0));
0928        <span class="keyword">end</span>
0929    <span class="keyword">end</span>
0930 <span class="keyword">end</span>
0931 
0932 <span class="comment">%If any ec-codes have been loaded</span>
0933 <span class="keyword">if</span> any(~cellfun(@isempty,eccodes))
0934     model.eccodes=eccodes;
0935 <span class="keyword">end</span>
0936 
0937 <span class="comment">%If any Miriam strings for reactions have been loaded</span>
0938 <span class="keyword">if</span> any(~cellfun(@isempty,rxnMiriams))
0939     model.rxnMiriams=rxnMiriams;
0940 <span class="keyword">end</span>
0941 
0942 <span class="comment">%If any Miriam strings for genes have been loaded</span>
0943 <span class="keyword">if</span> any(~cellfun(@isempty,geneMiriams))
0944     model.geneMiriams=geneMiriams;
0945 <span class="keyword">end</span>
0946 
0947 model.unconstrained=metaboliteUnconstrained;
0948 
0949 <span class="comment">% Convert SBML IDs back into their original strings. Here we are using part</span>
0950 <span class="comment">% from convertSBMLID, originating from the COBRA Toolbox</span>
0951 model.rxns=regexprep(model.rxns,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
0952 model.mets=regexprep(model.mets,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
0953 model.comps=regexprep(model.comps,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
0954 model.grRules=regexprep(model.grRules,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
0955 model.genes=regexprep(model.genes,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
0956 
0957 <span class="comment">%Remove unused fields</span>
0958 <span class="keyword">if</span> isempty(model.annotation)
0959     model=rmfield(model,<span class="string">'annotation'</span>);
0960 <span class="keyword">end</span>
0961 <span class="keyword">if</span> isempty(model.compOutside)
0962     model=rmfield(model,<span class="string">'compOutside'</span>);
0963 <span class="keyword">end</span>
0964 <span class="keyword">if</span> isempty(model.compMiriams)
0965     model=rmfield(model,<span class="string">'compMiriams'</span>);
0966 <span class="keyword">end</span>
0967 <span class="keyword">if</span> isempty(model.rxnComps)
0968     model=rmfield(model,<span class="string">'rxnComps'</span>);
0969 <span class="keyword">end</span>
0970 <span class="keyword">if</span> isempty(model.grRules)
0971     model=rmfield(model,<span class="string">'grRules'</span>);
0972 <span class="keyword">end</span>
0973 <span class="keyword">if</span> isempty(model.rxnGeneMat)
0974     model=rmfield(model,<span class="string">'rxnGeneMat'</span>);
0975 <span class="keyword">end</span>
0976 <span class="keyword">if</span> isempty(model.subSystems)
0977     model=rmfield(model,<span class="string">'subSystems'</span>);
0978 <span class="keyword">end</span>
0979 <span class="keyword">if</span> isempty(model.eccodes)
0980     model=rmfield(model,<span class="string">'eccodes'</span>);
0981 <span class="keyword">end</span>
0982 <span class="keyword">if</span> isempty(model.rxnMiriams)
0983     model=rmfield(model,<span class="string">'rxnMiriams'</span>);
0984 <span class="keyword">end</span>
0985 <span class="keyword">if</span> cellfun(@isempty,model.rxnNotes)
0986     model=rmfield(model,<span class="string">'rxnNotes'</span>);
0987 <span class="keyword">end</span>
0988 <span class="keyword">if</span> cellfun(@isempty,model.rxnReferences)
0989     model=rmfield(model,<span class="string">'rxnReferences'</span>);
0990 <span class="keyword">end</span>
0991 <span class="keyword">if</span> cellfun(@isempty,model.rxnConfidenceScores)
0992     model=rmfield(model,<span class="string">'rxnConfidenceScores'</span>);
0993 <span class="keyword">end</span>
0994 <span class="keyword">if</span> isempty(model.genes)
0995     model=rmfield(model,<span class="string">'genes'</span>);
0996 <span class="keyword">elseif</span> isrow(model.genes)
0997     model.genes=transpose(model.genes);
0998 <span class="keyword">end</span>
0999 <span class="keyword">if</span> isempty(model.geneComps)
1000     model=rmfield(model,<span class="string">'geneComps'</span>);
1001 <span class="keyword">end</span>
1002 <span class="keyword">if</span> isempty(model.geneMiriams)
1003     model=rmfield(model,<span class="string">'geneMiriams'</span>);
1004 <span class="keyword">end</span>
1005 <span class="keyword">if</span> isempty(model.geneShortNames)
1006     model=rmfield(model,<span class="string">'geneShortNames'</span>);
1007 <span class="keyword">end</span>
1008 <span class="keyword">if</span> isempty(model.inchis)
1009     model=rmfield(model,<span class="string">'inchis'</span>);
1010 <span class="keyword">end</span>
1011 <span class="keyword">if</span> isempty(model.metFormulas)
1012     model=rmfield(model,<span class="string">'metFormulas'</span>);
1013 <span class="keyword">end</span>
1014 <span class="keyword">if</span> isempty(model.metMiriams)
1015     model=rmfield(model,<span class="string">'metMiriams'</span>);
1016 <span class="keyword">end</span>
1017 <span class="keyword">if</span> ~any(model.metCharges)
1018     model=rmfield(model,<span class="string">'metCharges'</span>);
1019 <span class="keyword">end</span>
1020 
1021 <span class="comment">%This just removes the grRules if no genes have been loaded</span>
1022 <span class="keyword">if</span> ~isfield(model,<span class="string">'genes'</span>) &amp;&amp; isfield(model,<span class="string">'grRules'</span>)
1023    model=rmfield(model,<span class="string">'grRules'</span>);
1024 <span class="keyword">end</span>
1025 
1026 <span class="comment">%Print warnings about bad structure</span>
1027 <span class="keyword">if</span> supressWarnings==false
1028     checkModelStruct(model,false);
1029 <span class="keyword">end</span>
1030 
1031 <span class="keyword">if</span> removeExcMets==true
1032     model=simplifyModel(model);
1033 <span class="keyword">end</span>
1034 <span class="keyword">end</span>
1035 
1036 <a name="_sub1" href="#_subfunctions" class="code">function [rxnGeneMat, matchGenes]=getGeneMat(grRules,matchGenes)</a>
1037 <span class="comment">%Constructs the rxnGeneMat matrix and the cell array with gene names from</span>
1038 <span class="comment">%the grRules. Uses the genes in the order defined by matchGenes if supplied. No</span>
1039 <span class="comment">%checks are made here since that should have been made before.</span>
1040 
1041 <span class="keyword">if</span> nargin&lt;2
1042     matchGenes={};
1043 <span class="keyword">end</span>
1044 
1045 <span class="comment">%Assume that everything that isn't a paranthesis, &quot; AND &quot; or &quot; or &quot; is a</span>
1046 <span class="comment">%gene name</span>
1047 genes=strrep(grRules,<span class="string">'('</span>,<span class="string">''</span>);
1048 genes=strrep(genes,<span class="string">')'</span>,<span class="string">''</span>);
1049 genes=strrep(genes,<span class="string">' or '</span>,<span class="string">' '</span>);
1050 genes=strrep(genes,<span class="string">' and '</span>,<span class="string">' '</span>);
1051 genes=strrep(genes,<span class="string">' OR '</span>,<span class="string">' '</span>);
1052 genes=strrep(genes,<span class="string">' AND '</span>,<span class="string">' '</span>);
1053 genes=regexp(genes,<span class="string">' '</span>,<span class="string">'split'</span>);
1054 
1055 <span class="keyword">if</span> isempty(matchGenes)
1056     allNames={};
1057     <span class="keyword">for</span> i=1:numel(genes)
1058         allNames=[allNames genes{i}];
1059     <span class="keyword">end</span>
1060     matchGenes=unique(allNames)';
1061 
1062     <span class="comment">%Remove the empty element if present</span>
1063     <span class="keyword">if</span> isempty(matchGenes{1})
1064         matchGenes(1)=[];
1065     <span class="keyword">end</span>
1066 <span class="keyword">end</span>
1067 
1068 <span class="comment">%Create the matrix</span>
1069 rxnGeneMat=zeros(numel(genes),numel(matchGenes));
1070 
1071 <span class="keyword">for</span> i=1:numel(genes)
1072     <span class="keyword">if</span> ~isempty(genes{i})
1073         <span class="keyword">for</span> j=1:numel(genes{i})
1074             <span class="keyword">if</span> ~isempty(genes{i}{j})
1075                 index=find(strcmp(genes{i}{j},matchGenes));
1076                 <span class="keyword">if</span> numel(index)==1
1077                     rxnGeneMat(i,index)=1;
1078                 <span class="keyword">else</span>
1079                     EM=[<span class="string">'The gene '</span> genes{i}{j} <span class="string">' could not be matched to a gene in the gene list'</span>];
1080                     dispEM(EM);
1081                 <span class="keyword">end</span>
1082             <span class="keyword">end</span>
1083         <span class="keyword">end</span>
1084     <span class="keyword">end</span>
1085 <span class="keyword">end</span>
1086 rxnGeneMat=sparse(rxnGeneMat);
1087 <span class="keyword">end</span>
1088 
1089 <a name="_sub2" href="#_subfunctions" class="code">function fieldContent=parseNote(searchString,fieldName)</a>
1090 <span class="comment">% The function obtains the particular information from 'notes' field, using</span>
1091 <span class="comment">% fieldName as the dummy string</span>
1092     
1093 fieldContent=<span class="string">''</span>;
1094 
1095 <span class="keyword">if</span> strfind(searchString,fieldName)
1096     [~,targetString] = regexp(searchString,[<span class="string">'&lt;p&gt;'</span> fieldName <span class="string">'.*?&lt;/p&gt;'</span>],<span class="string">'tokens'</span>,<span class="string">'match'</span>);
1097     targetString=regexprep(targetString,<span class="string">'&lt;p&gt;|&lt;/p&gt;'</span>,<span class="string">''</span>);
1098     targetString=regexprep(targetString,[fieldName, <span class="string">':'</span>],<span class="string">''</span>);    
1099     <span class="keyword">for</span> i=1:numel(targetString)
1100         fieldContent=[fieldContent <span class="string">';'</span> strtrim(targetString{1,i})];
1101     <span class="keyword">end</span>;
1102     fieldContent=regexprep(fieldContent,<span class="string">'^;|;$'</span>,<span class="string">''</span>);
1103 <span class="keyword">else</span>
1104     fieldContent=<span class="string">''</span>;
1105 <span class="keyword">end</span>
1106 <span class="keyword">end</span>
1107 
1108 <a name="_sub3" href="#_subfunctions" class="code">function fieldContent=parseAnnotation(searchString,startString,midString,fieldName)</a>
1109 
1110 fieldContent=<span class="string">''</span>;
1111 
1112 <span class="comment">% Removing whitespace characters from the ending strings, which may occur</span>
1113 <span class="comment">% in several cases;</span>
1114 searchString=regexprep(searchString,<span class="string">'&quot; /&gt;'</span>,<span class="string">'&quot;/&gt;'</span>);
1115 [~,targetString] = regexp(searchString,[<span class="string">'&lt;rdf:li rdf:resource=&quot;'</span> startString fieldName midString <span class="string">'.*?&quot;/&gt;'</span>],<span class="string">'tokens'</span>,<span class="string">'match'</span>);
1116 targetString=regexprep(targetString,<span class="string">'&lt;rdf:li rdf:resource=&quot;|&quot;/&gt;'</span>,<span class="string">''</span>);
1117 targetString=regexprep(targetString,startString,<span class="string">''</span>);
1118 targetString=regexprep(targetString,[fieldName midString],<span class="string">''</span>);
1119 
1120 <span class="keyword">for</span> i=1:numel(targetString)
1121     fieldContent=[fieldContent <span class="string">';'</span> strtrim(targetString{1,i})];
1122 <span class="keyword">end</span>;
1123        
1124 fieldContent=regexprep(fieldContent,<span class="string">'^;|;$'</span>,<span class="string">''</span>);
1125 <span class="keyword">end</span>
1126 
1127 <a name="_sub4" href="#_subfunctions" class="code">function miriamStruct=parseMiriam(searchString)</a>
1128 <span class="comment">%Generates miriam structure from annotation field;</span>
1129 
1130 <span class="comment">%Finding whether miriams are written in the old or the new way;</span>
1131 <span class="keyword">if</span> strfind(searchString,<span class="string">'urn:miriam:'</span>)
1132     startString=<span class="string">'urn:miriam:'</span>;
1133     midString=<span class="string">':'</span>;
1134 <span class="keyword">elseif</span> strfind(searchString,<span class="string">'http://identifiers.org/'</span>)
1135     startString=<span class="string">'http://identifiers.org/'</span>;
1136     midString=<span class="string">'/'</span>;
1137 <span class="keyword">else</span>
1138     miriamStruct=[];
1139     <span class="keyword">return</span>;
1140 <span class="keyword">end</span>;
1141 
1142 miriamStruct=[];
1143 
1144 searchString=regexprep(searchString,<span class="string">'&quot; /&gt;'</span>,<span class="string">'&quot;/&gt;'</span>);
1145 [~,targetString] = regexp(searchString,<span class="string">'&lt;rdf:li rdf:resource=&quot;.*?&quot;/&gt;'</span>,<span class="string">'tokens'</span>,<span class="string">'match'</span>);
1146 targetString=regexprep(targetString,<span class="string">'&lt;rdf:li rdf:resource=&quot;|&quot;/&gt;'</span>,<span class="string">''</span>);
1147 targetString=regexprep(targetString,startString,<span class="string">''</span>);
1148 targetString=regexprep(targetString,midString,<span class="string">'/'</span>,<span class="string">'once'</span>);
1149 
1150 counter=0;
1151 <span class="keyword">for</span> i=1:numel(targetString)
1152     <span class="keyword">if</span> isempty(regexp(targetString{1,i},<span class="string">'inchi|ec-code'</span>))
1153         counter=counter+1;
1154         miriamStruct.name{counter,1} = regexprep(targetString{1,i},<span class="string">'/.+'</span>,<span class="string">''</span>,<span class="string">'once'</span>);
1155         miriamStruct.value{counter,1} = regexprep(targetString{1,i},[miriamStruct.name{counter,1} midString],<span class="string">''</span>,<span class="string">'once'</span>);
1156     <span class="keyword">end</span>;
1157 <span class="keyword">end</span>;
1158 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Wed 14-Mar-2018 21:08:28 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>