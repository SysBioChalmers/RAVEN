<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of importModel</title>
  <meta name="keywords" content="importModel">
  <meta name="description" content="importModel">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">io</a> &gt; importModel.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for io&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>importModel
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>importModel</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function model=importModel(fileName,removeExcMets,COBRAstyle,supressWarnings) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> importModel
   Import a constraint-based model from a SBML file

 Input:
   fileName        a SBML file to import. A dialog window will open if
                   no file name is specified.
   removeExcMets   true if exchange metabolites should be removed. This is
                   needed to be able to run simulations, but it could also
                   be done using simplifyModel at a later stage (optional,
                   default true)
   COBRAstyle      true if the model uses COBRA style identifier prefixes
                   that should be removed when loading the model: G_ for
                   genes, R_ for reactions, M_ for metabolites, and C_ for
                   compartments. (optional, default false)
   supressWarnings true if warnings regarding the model structure should
                   be supressed (optional, default false)

 Output:
   model
       id               model ID
       name             name of model contents
       annotation       additional information about model
       rxns             reaction ids
       mets             metabolite ids
       S                stoichiometric matrix
       lb               lower bounds
       ub               upper bounds
       rev              reversibility vector
       c                objective coefficients
       b                equality constraints for the metabolite equations
       comps            compartment ids
       compNames        compartment names
       compOutside      the id (as in comps) for the compartment
                        surrounding each of the compartments
       compMiriams      structure with MIRIAM information about the
                        compartments
       rxnNames         reaction description
       rxnComps         compartments for reactions
       grRules          reaction to gene rules in text form
       rxnGeneMat       reaction-to-gene mapping in sparse matrix form
       subSystems       subsystem name for each reaction
       eccodes          EC-codes for the reactions
       rxnMiriams       structure with MIRIAM information about the reactions
       rxnNotes         reaction notes
       rxnReferences    reaction references
       rxnConfidenceScores reaction confidence scores
       genes            list of all genes
       geneComps        compartments for genes
       geneMiriams      structure with MIRIAM information about the genes
       geneShortNames   gene alternative names (e.g. ERG10)
       metNames         metabolite description
       metComps         compartments for metabolites
       inchis           InChI-codes for metabolites
       metFormulas      metabolite chemical formula
       metMiriams       structure with MIRIAM information about the metabolites
       metCharges       metabolite charge
       unconstrained    true if the metabolite is an exchange metabolite

 A number of consistency checks are performed in order to ensure that the
 model is valid. Take these warnings seriously and modify the model
 structure to solve them.

 Usage: model = importModel(fileName, removeExcMets, COBRAstyle, supressWarnings)</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="checkFileExistence.html" class="code" title="function files=checkFileExistence(files,fullOrTemp,allowSpace,checkExist)">checkFileExistence</a>	checkFileExistence</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function matchGenes=getGeneList(grRules)</a></li><li><a href="#_sub2" class="code">function fieldContent=parseNote(searchString,fieldName)</a></li><li><a href="#_sub3" class="code">function fieldContent=parseAnnotation(searchString,startString,midString,fieldName)</a></li><li><a href="#_sub4" class="code">function miriamStruct=parseMiriam(searchString)</a></li><li><a href="#_sub5" class="code">function miriam = addSBOtoMiriam(miriam,sboTerm)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function model=importModel(fileName,removeExcMets,COBRAstyle,supressWarnings)</a>
0002 <span class="comment">% importModel</span>
0003 <span class="comment">%   Import a constraint-based model from a SBML file</span>
0004 <span class="comment">%</span>
0005 <span class="comment">% Input:</span>
0006 <span class="comment">%   fileName        a SBML file to import. A dialog window will open if</span>
0007 <span class="comment">%                   no file name is specified.</span>
0008 <span class="comment">%   removeExcMets   true if exchange metabolites should be removed. This is</span>
0009 <span class="comment">%                   needed to be able to run simulations, but it could also</span>
0010 <span class="comment">%                   be done using simplifyModel at a later stage (optional,</span>
0011 <span class="comment">%                   default true)</span>
0012 <span class="comment">%   COBRAstyle      true if the model uses COBRA style identifier prefixes</span>
0013 <span class="comment">%                   that should be removed when loading the model: G_ for</span>
0014 <span class="comment">%                   genes, R_ for reactions, M_ for metabolites, and C_ for</span>
0015 <span class="comment">%                   compartments. (optional, default false)</span>
0016 <span class="comment">%   supressWarnings true if warnings regarding the model structure should</span>
0017 <span class="comment">%                   be supressed (optional, default false)</span>
0018 <span class="comment">%</span>
0019 <span class="comment">% Output:</span>
0020 <span class="comment">%   model</span>
0021 <span class="comment">%       id               model ID</span>
0022 <span class="comment">%       name             name of model contents</span>
0023 <span class="comment">%       annotation       additional information about model</span>
0024 <span class="comment">%       rxns             reaction ids</span>
0025 <span class="comment">%       mets             metabolite ids</span>
0026 <span class="comment">%       S                stoichiometric matrix</span>
0027 <span class="comment">%       lb               lower bounds</span>
0028 <span class="comment">%       ub               upper bounds</span>
0029 <span class="comment">%       rev              reversibility vector</span>
0030 <span class="comment">%       c                objective coefficients</span>
0031 <span class="comment">%       b                equality constraints for the metabolite equations</span>
0032 <span class="comment">%       comps            compartment ids</span>
0033 <span class="comment">%       compNames        compartment names</span>
0034 <span class="comment">%       compOutside      the id (as in comps) for the compartment</span>
0035 <span class="comment">%                        surrounding each of the compartments</span>
0036 <span class="comment">%       compMiriams      structure with MIRIAM information about the</span>
0037 <span class="comment">%                        compartments</span>
0038 <span class="comment">%       rxnNames         reaction description</span>
0039 <span class="comment">%       rxnComps         compartments for reactions</span>
0040 <span class="comment">%       grRules          reaction to gene rules in text form</span>
0041 <span class="comment">%       rxnGeneMat       reaction-to-gene mapping in sparse matrix form</span>
0042 <span class="comment">%       subSystems       subsystem name for each reaction</span>
0043 <span class="comment">%       eccodes          EC-codes for the reactions</span>
0044 <span class="comment">%       rxnMiriams       structure with MIRIAM information about the reactions</span>
0045 <span class="comment">%       rxnNotes         reaction notes</span>
0046 <span class="comment">%       rxnReferences    reaction references</span>
0047 <span class="comment">%       rxnConfidenceScores reaction confidence scores</span>
0048 <span class="comment">%       genes            list of all genes</span>
0049 <span class="comment">%       geneComps        compartments for genes</span>
0050 <span class="comment">%       geneMiriams      structure with MIRIAM information about the genes</span>
0051 <span class="comment">%       geneShortNames   gene alternative names (e.g. ERG10)</span>
0052 <span class="comment">%       metNames         metabolite description</span>
0053 <span class="comment">%       metComps         compartments for metabolites</span>
0054 <span class="comment">%       inchis           InChI-codes for metabolites</span>
0055 <span class="comment">%       metFormulas      metabolite chemical formula</span>
0056 <span class="comment">%       metMiriams       structure with MIRIAM information about the metabolites</span>
0057 <span class="comment">%       metCharges       metabolite charge</span>
0058 <span class="comment">%       unconstrained    true if the metabolite is an exchange metabolite</span>
0059 <span class="comment">%</span>
0060 <span class="comment">% A number of consistency checks are performed in order to ensure that the</span>
0061 <span class="comment">% model is valid. Take these warnings seriously and modify the model</span>
0062 <span class="comment">% structure to solve them.</span>
0063 <span class="comment">%</span>
0064 <span class="comment">% Usage: model = importModel(fileName, removeExcMets, COBRAstyle, supressWarnings)</span>
0065 
0066 <span class="keyword">if</span> nargin&lt;1 || isempty(fileName)
0067     [fileName, pathName] = uigetfile({<span class="string">'*.xml;*.sbml'</span>}, <span class="string">'Please select the model file'</span>);
0068     <span class="keyword">if</span> fileName == 0
0069         error(<span class="string">'You should select a model file'</span>)
0070     <span class="keyword">else</span>
0071         fileName = fullfile(pathName,fileName);
0072     <span class="keyword">end</span>
0073 <span class="keyword">end</span>
0074 fileName=char(fileName);
0075 <span class="keyword">if</span> nargin&lt;2 || isempty(removeExcMets)
0076     removeExcMets=true;
0077 <span class="keyword">end</span>
0078 
0079 <span class="keyword">if</span> nargin&lt;3 || isempty(COBRAstyle)
0080     COBRAstyle=false;
0081 <span class="keyword">end</span>
0082 
0083 <span class="keyword">if</span> nargin&lt;4
0084     supressWarnings=false;
0085 <span class="keyword">end</span>
0086 
0087 <span class="keyword">if</span> ~isfile(fileName)
0088     error(<span class="string">'SBML file %s cannot be found'</span>,string(fileName));
0089 <span class="keyword">end</span>
0090 
0091 <span class="comment">%This is to match the order of the fields to those you get from importing</span>
0092 <span class="comment">%from Excel</span>
0093 model=[];
0094 model.id=[];
0095 model.name=[];
0096 model.annotation=[];
0097 model.rxns={};
0098 model.mets={};
0099 model.S=[];
0100 model.lb=[];
0101 model.ub=[];
0102 model.rev=[];
0103 model.c=[];
0104 model.b=[];
0105 model.comps={};
0106 model.compNames={};
0107 model.compOutside={};
0108 model.compMiriams={};
0109 model.rxnNames={};
0110 model.rxnComps=[];
0111 model.grRules={};
0112 model.rxnGeneMat=[];
0113 model.subSystems={};
0114 model.eccodes={};
0115 model.rxnMiriams={};
0116 model.rxnNotes={};
0117 model.rxnReferences={};
0118 model.rxnConfidenceScores=[];
0119 model.genes={};
0120 model.geneComps=[];
0121 model.geneMiriams={};
0122 model.geneShortNames={};
0123 model.metNames={};
0124 model.metComps=[];
0125 model.inchis={};
0126 model.metFormulas={};
0127 model.metMiriams={};
0128 model.metCharges=[];
0129 model.unconstrained=[];
0130 
0131 <span class="comment">%Load the model using libSBML</span>
0132 fileName=<a href="checkFileExistence.html" class="code" title="function files=checkFileExistence(files,fullOrTemp,allowSpace,checkExist)">checkFileExistence</a>(fileName,1);
0133 [modelSBML,errorMsg] = TranslateSBML_RAVEN(fileName,0,0,[1 1]);
0134 
0135 <span class="keyword">if</span> isempty(modelSBML)
0136     EM=[<span class="string">'There is a problem with the SBML file. Try using the SBML Validator at http://sbml.org/Facilities/Validator.\nlibSBML reports: '</span>, errorMsg.message];
0137     dispEM(EM);
0138 <span class="keyword">end</span>
0139 
0140 <span class="comment">%Retrieve compartment names and IDs</span>
0141 compartmentNames=cell(numel(modelSBML.compartment),1);
0142 compartmentIDs=cell(numel(modelSBML.compartment),1);
0143 compartmentOutside=cell(numel(modelSBML.compartment),1);
0144 compartmentMiriams=cell(numel(modelSBML.compartment),1);
0145 
0146 <span class="keyword">if</span> isfield(modelSBML.compartment,<span class="string">'sboTerm'</span>) &amp;&amp; numel(unique([modelSBML.compartment.sboTerm])) == 1
0147     <span class="comment">%If all the SBO terms are identical, don't add them to compMiriams</span>
0148     modelSBML.compartment = rmfield(modelSBML.compartment,<span class="string">'sboTerm'</span>);
0149 <span class="keyword">end</span>
0150 
0151 <span class="keyword">for</span> i=1:numel(modelSBML.compartment)
0152     compartmentNames{i}=modelSBML.compartment(i).name;
0153     compartmentIDs{i}=modelSBML.compartment(i).id;
0154     <span class="keyword">if</span> isfield(modelSBML.compartment(i),<span class="string">'outside'</span>)
0155         <span class="keyword">if</span> ~isempty(modelSBML.compartment(i).outside)
0156             compartmentOutside{i}=modelSBML.compartment(i).outside;
0157         <span class="keyword">else</span>
0158             compartmentOutside{i}=<span class="string">''</span>;
0159         <span class="keyword">end</span>
0160     <span class="keyword">else</span>
0161         compartmentOutside{i}=[];
0162     <span class="keyword">end</span>
0163 
0164     <span class="keyword">if</span> isfield(modelSBML.compartment(i),<span class="string">'annotation'</span>)
0165         compartmentMiriams{i}=<a href="#_sub4" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.compartment(i).annotation);
0166     <span class="keyword">else</span>
0167         compartmentMiriams{i}=[];
0168     <span class="keyword">end</span>
0169 
0170     <span class="keyword">if</span> isfield(modelSBML.compartment(i),<span class="string">'sboTerm'</span>) &amp;&amp; ~(modelSBML.compartment(i).sboTerm==-1)
0171         compartmentMiriams{i} = <a href="#_sub5" class="code" title="subfunction miriam = addSBOtoMiriam(miriam,sboTerm)">addSBOtoMiriam</a>(compartmentMiriams{i},modelSBML.compartment(i).sboTerm);
0172     <span class="keyword">end</span>
0173 <span class="keyword">end</span>
0174 
0175 <span class="comment">%If there are no compartment names then use compartment id as name</span>
0176 <span class="keyword">if</span> all(cellfun(@isempty,compartmentNames))
0177     compartmentNames=compartmentIDs;
0178 <span class="keyword">end</span>
0179 
0180 <span class="comment">%Retrieve info on metabolites, genes, complexes</span>
0181 metaboliteNames={};
0182 metaboliteIDs={};
0183 metaboliteCompartments={};
0184 metaboliteUnconstrained=[];
0185 metaboliteFormula={};
0186 metaboliteInChI={};
0187 metaboliteMiriams={};
0188 metaboliteCharges=[];
0189 
0190 geneNames={};
0191 geneIDs={};
0192 geneMiriams={};
0193 geneShortNames={};
0194 geneCompartments={};
0195 complexIDs={};
0196 complexNames={};
0197 
0198 <span class="comment">%If the file is not a COBRA Toolbox model. According to the format</span>
0199 <span class="comment">%specified in the yeast consensus model both metabolites and genes are a</span>
0200 <span class="comment">%type of 'species'. The metabolites have names starting with 'M_' and genes</span>
0201 <span class="comment">%with 'E_'</span>
0202 geneSBOs = [];
0203 metSBOs = [];
0204 <span class="comment">%Regex of compartment names, later to be used to remove from metabolite</span>
0205 <span class="comment">%names if present as suffix.</span>
0206 regexCompNames = [<span class="string">'\s?\[(('</span> strjoin({modelSBML.compartment.name},<span class="string">')|('</span>) <span class="string">'))\]$'</span>];
0207 <span class="keyword">for</span> i=1:numel(modelSBML.species)
0208     <span class="keyword">if</span> length(modelSBML.species(i).id)&gt;=2 &amp;&amp; strcmpi(modelSBML.species(i).id(1:2),<span class="string">'E_'</span>)
0209         geneNames{numel(geneNames)+1,1}=modelSBML.species(i).name;
0210 
0211         <span class="comment">%The &quot;E_&quot; is included in the ID. This is because it's only used</span>
0212         <span class="comment">%internally in this file and it makes the matching a little</span>
0213         <span class="comment">%smoother</span>
0214         geneIDs{numel(geneIDs)+1,1}=modelSBML.species(i).id;
0215         geneCompartments{numel(geneCompartments)+1,1}=modelSBML.species(i).compartment;
0216 
0217         <span class="comment">%Get Miriam structure</span>
0218         <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'annotation'</span>)
0219             <span class="comment">%Get Miriam info</span>
0220             geneMiriam=<a href="#_sub4" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.species(i).annotation);
0221             geneMiriams{numel(geneMiriams)+1,1}=geneMiriam;
0222         <span class="keyword">else</span>
0223             geneMiriams{numel(geneMiriams)+1,1}=[];
0224         <span class="keyword">end</span>
0225 
0226         <span class="comment">%Protein short names (for example ERG10) are saved as SHORT</span>
0227         <span class="comment">%NAME: NAME in the notes-section of metabolites for SBML Level</span>
0228         <span class="comment">%2 and as PROTEIN_ASSOCIATION for each reaction in SBML Level 2</span>
0229         <span class="comment">%COBRA Toolbox format. For now only the SHORT NAME is loaded</span>
0230         <span class="comment">%and no mapping takes place</span>
0231         <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'notes'</span>)
0232             geneShortNames{numel(geneShortNames)+1,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'SHORT NAME'</span>);
0233         <span class="keyword">else</span>
0234             geneShortNames{numel(geneShortNames)+1,1}=<span class="string">''</span>;
0235         <span class="keyword">end</span>
0236 
0237         <span class="comment">%Get SBO term</span>
0238         <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'sboTerm'</span>) &amp;&amp; ~(modelSBML.species(i).sboTerm==-1)
0239             geneSBOs(end+1,1) = modelSBML.species(i).sboTerm;
0240         <span class="keyword">end</span>
0241     <span class="keyword">elseif</span> length(modelSBML.species(i).id)&gt;=2 &amp;&amp; strcmpi(modelSBML.species(i).id(1:3),<span class="string">'Cx_'</span>)
0242         <span class="comment">%If it's a complex keep the ID and name</span>
0243         complexIDs=[complexIDs;modelSBML.species(i).id];
0244         complexNames=[complexNames;modelSBML.species(i).name];
0245     <span class="keyword">else</span>
0246         <span class="comment">%If it is not gene or complex, then it must be a metabolite</span>
0247         metaboliteNames{numel(metaboliteNames)+1,1}=modelSBML.species(i).name;
0248         metaboliteIDs{numel(metaboliteIDs)+1,1}=modelSBML.species(i).id;
0249         metaboliteCompartments{numel(metaboliteCompartments)+1,1}=modelSBML.species(i).compartment;
0250         metaboliteUnconstrained(numel(metaboliteUnconstrained)+1,1)=modelSBML.species(i).boundaryCondition;
0251 
0252         <span class="comment">%For each metabolite retrieve the formula and the InChI code if</span>
0253         <span class="comment">%available First add the InChI code and the formula from the</span>
0254         <span class="comment">%InChI. This allows for overwriting the formula by setting the</span>
0255         <span class="comment">%actual formula field</span>
0256         <span class="keyword">if</span> ~isempty(modelSBML.species(i).annotation)
0257             <span class="comment">%Get the formula if available</span>
0258             startString=<span class="string">'&gt;InChI='</span>;
0259             endString=<span class="string">'&lt;/in:inchi&gt;'</span>;
0260             formStart=strfind(modelSBML.species(i).annotation,startString);
0261             <span class="keyword">if</span> isempty(formStart)
0262                 startString=<span class="string">'InChI='</span>;
0263                 endString=<span class="string">'&quot;/&gt;'</span>;
0264             <span class="keyword">end</span>
0265             formStart=strfind(modelSBML.species(i).annotation,startString);
0266             <span class="keyword">if</span> ~isempty(formStart)
0267                 formEnd=strfind(modelSBML.species(i).annotation,endString);
0268                 formEndIndex=find(formEnd&gt;formStart, 1 );
0269                 formula=modelSBML.species(i).annotation(formStart+numel(startString):formEnd(formEndIndex)-1);
0270                 metaboliteInChI{numel(metaboliteInChI)+1,1}=formula;
0271 
0272                 <span class="comment">%The composition is most often present between the</span>
0273                 <span class="comment">%first and second &quot;/&quot; in the model. In some simple</span>
0274                 <span class="comment">%molecules, such as salts, there is no second &quot;/&quot;. The</span>
0275                 <span class="comment">%formula is then assumed to be to the end of the string</span>
0276                 compositionIndexes=strfind(formula,<span class="string">'/'</span>);
0277                 <span class="keyword">if</span> numel(compositionIndexes)&gt;1
0278                     metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="keyword">...</span>
0279                         formula(compositionIndexes(1)+1:compositionIndexes(2)-1);
0280                 <span class="keyword">else</span>
0281                     <span class="keyword">if</span> numel(compositionIndexes)==1
0282                         <span class="comment">%Probably a simple molecule which can have only</span>
0283                         <span class="comment">%one conformation</span>
0284                         metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="keyword">...</span>
0285                             formula(compositionIndexes(1)+1:numel(formula));
0286                     <span class="keyword">else</span>
0287                         metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0288                     <span class="keyword">end</span>
0289                 <span class="keyword">end</span>
0290             <span class="keyword">elseif</span> isfield(modelSBML.species(i),<span class="string">'fbc_chemicalFormula'</span>)
0291                 metaboliteInChI{numel(metaboliteInChI)+1,1}=<span class="string">''</span>;
0292                 <span class="keyword">if</span> ~isempty(modelSBML.species(i).fbc_chemicalFormula)
0293                     <span class="comment">%Cannot extract InChi from formula, so remains</span>
0294                     <span class="comment">%empty</span>
0295                     metaboliteFormula{numel(metaboliteFormula)+1,1}=modelSBML.species(i).fbc_chemicalFormula;
0296                 <span class="keyword">else</span>
0297                     metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0298                 <span class="keyword">end</span>
0299             <span class="keyword">else</span>
0300                 metaboliteInChI{numel(metaboliteInChI)+1,1}=<span class="string">''</span>;
0301                 metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0302             <span class="keyword">end</span>
0303 
0304             <span class="comment">%Get Miriam info</span>
0305             metMiriam=<a href="#_sub4" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.species(i).annotation);
0306             metaboliteMiriams{numel(metaboliteMiriams)+1,1}=metMiriam;
0307         <span class="keyword">else</span>
0308             metaboliteInChI{numel(metaboliteInChI)+1,1}=<span class="string">''</span>;
0309             <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'notes'</span>)
0310                 metaboliteFormula{numel(metaboliteFormula)+1,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'FORMULA'</span>);
0311             <span class="keyword">else</span>
0312                 metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0313             <span class="keyword">end</span>
0314             metaboliteMiriams{numel(metaboliteMiriams)+1,1}=[];
0315         <span class="keyword">end</span>
0316         <span class="keyword">if</span> ~isempty(modelSBML.species(i).notes)
0317             <span class="keyword">if</span> ~isfield(modelSBML.species(i),<span class="string">'annotation'</span>)
0318                 metaboliteFormula{numel(metaboliteFormula)+1,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'FORMULA'</span>);
0319             <span class="keyword">end</span>
0320         <span class="keyword">elseif</span> ~isfield(modelSBML.species(i),<span class="string">'annotation'</span>)
0321             metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0322         <span class="keyword">end</span>
0323         <span class="comment">%Get SBO term</span>
0324         <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'sboTerm'</span>) &amp;&amp; ~(modelSBML.species(i).sboTerm==-1)
0325             metSBOs(end+1,1) = modelSBML.species(i).sboTerm;
0326         <span class="keyword">end</span>
0327     <span class="keyword">end</span>
0328 
0329     <span class="comment">%The following lines are executed regardless isSBML2COBRA setting</span>
0330     <span class="keyword">if</span> isempty(modelSBML.species(i).id) || ~strcmpi(modelSBML.species(i).id(1:2),<span class="string">'E_'</span>)
0331         <span class="keyword">if</span> isempty(modelSBML.species(i).id) || ~strcmpi(modelSBML.species(i).id(1:3),<span class="string">'Cx_'</span>)
0332             <span class="comment">%Remove trailing [compartment] from metabolite name if present</span>
0333             metaboliteNames{<span class="keyword">end</span>,1}=regexprep(metaboliteNames{<span class="keyword">end</span>,1},regexCompNames,<span class="string">''</span>);
0334             metaboliteNames{<span class="keyword">end</span>,1}=metaboliteNames{<span class="keyword">end</span>,1};
0335             <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'fbc_charge'</span>)
0336                 <span class="keyword">if</span> ~isempty(modelSBML.species(i).fbc_charge) &amp;&amp; modelSBML.species(i).isSetfbc_charge
0337                     metaboliteCharges(numel(metaboliteCharges)+1,1)=double(modelSBML.species(i).fbc_charge);
0338                 <span class="keyword">else</span>
0339                     <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'notes'</span>)
0340                         <span class="keyword">if</span> strfind(modelSBML.species(i).notes,<span class="string">'CHARGE'</span>)
0341                             metaboliteCharges(numel(metaboliteCharges)+1,1)=str2double(<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'CHARGE'</span>));
0342                         <span class="keyword">else</span>
0343                             metaboliteCharges(numel(metaboliteCharges)+1,1)=NaN;
0344                         <span class="keyword">end</span>
0345                     <span class="keyword">else</span>
0346                         metaboliteCharges(numel(metaboliteCharges)+1,1)=NaN;
0347                     <span class="keyword">end</span>
0348                 <span class="keyword">end</span>
0349             <span class="keyword">elseif</span> isfield(modelSBML.species(i),<span class="string">'notes'</span>)
0350                 <span class="keyword">if</span> strfind(modelSBML.species(i).notes,<span class="string">'CHARGE'</span>)
0351                     metaboliteCharges(numel(metaboliteCharges)+1,1)=str2double(<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'CHARGE'</span>));
0352                 <span class="keyword">else</span>
0353                     metaboliteCharges(numel(metaboliteCharges)+1,1)=NaN;
0354                 <span class="keyword">end</span>
0355             <span class="keyword">else</span>
0356                 metaboliteCharges(numel(metaboliteCharges)+1,1)=NaN;
0357             <span class="keyword">end</span>
0358             <span class="comment">%Additional information from FBC format Chemical formula</span>
0359             <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'fbc_chemicalFormula'</span>)
0360                 <span class="keyword">if</span> ~isempty(modelSBML.species(i).fbc_chemicalFormula)
0361                     metaboliteFormula{numel(metaboliteFormula),1}=modelSBML.species(i).fbc_chemicalFormula;
0362                 <span class="keyword">end</span>
0363             <span class="keyword">end</span>
0364         <span class="keyword">end</span>
0365     <span class="keyword">end</span>
0366 <span class="keyword">end</span>
0367 
0368 <span class="comment">%Add SBO terms to gene and metabolite miriam fields</span>
0369 <span class="keyword">if</span> numel(unique(geneSBOs)) &gt; 1  <span class="comment">% don't add if they're all identical</span>
0370     <span class="keyword">for</span> i = 1:numel(geneNames)
0371         geneMiriams{i} = <a href="#_sub5" class="code" title="subfunction miriam = addSBOtoMiriam(miriam,sboTerm)">addSBOtoMiriam</a>(geneMiriams{i},geneSBOs(i));
0372     <span class="keyword">end</span>
0373 <span class="keyword">end</span>
0374 <span class="keyword">if</span> numel(unique(metSBOs)) &gt; 1
0375     <span class="keyword">for</span> i = 1:numel(metaboliteNames)
0376         metaboliteMiriams{i} = <a href="#_sub5" class="code" title="subfunction miriam = addSBOtoMiriam(miriam,sboTerm)">addSBOtoMiriam</a>(metaboliteMiriams{i},metSBOs(i));
0377     <span class="keyword">end</span>
0378 <span class="keyword">end</span>
0379 
0380 <span class="comment">%Retrieve info on reactions</span>
0381 reactionNames=cell(numel(modelSBML.reaction),1);
0382 reactionIDs=cell(numel(modelSBML.reaction),1);
0383 subsystems=cell(numel(modelSBML.reaction),1);
0384 eccodes=cell(numel(modelSBML.reaction),1);
0385 eccodes(:,:)=cellstr(<span class="string">''</span>);
0386 rxnconfidencescores=NaN(numel(modelSBML.reaction),1);
0387 rxnreferences=cell(numel(modelSBML.reaction),1);
0388 rxnreferences(:,:)=cellstr(<span class="string">''</span>);
0389 rxnnotes=cell(numel(modelSBML.reaction),1);
0390 rxnnotes(:,:)=cellstr(<span class="string">''</span>);
0391 grRules=cell(numel(modelSBML.reaction),1);
0392 grRules(:,:)=cellstr(<span class="string">''</span>);
0393 grRulesFromModifier=grRules;
0394 rxnComps=zeros(numel(modelSBML.reaction),1);
0395 rxnMiriams=cell(numel(modelSBML.reaction),1);
0396 reactionReversibility=zeros(numel(modelSBML.reaction),1);
0397 reactionUB=zeros(numel(modelSBML.reaction),1);
0398 reactionLB=zeros(numel(modelSBML.reaction),1);
0399 reactionObjective=zeros(numel(modelSBML.reaction),1);
0400 
0401 <span class="comment">%Construct the stoichiometric matrix while the reaction info is read</span>
0402 S=zeros(numel(metaboliteIDs),numel(modelSBML.reaction));
0403 
0404 counter=0;
0405 <span class="comment">%If FBC, then bounds have parameter ids defined for the whole model</span>
0406 <span class="keyword">if</span> isfield(modelSBML,<span class="string">'parameter'</span>)
0407     parameter.name=cell(numel(modelSBML.parameter),1);
0408     parameter.name={modelSBML.parameter(:).id}';
0409     parameter.value={modelSBML.parameter(:).value}';
0410 <span class="keyword">end</span>
0411 
0412 <span class="keyword">if</span> isfield(modelSBML.reaction,<span class="string">'sboTerm'</span>) &amp;&amp; numel(unique([modelSBML.reaction.sboTerm])) == 1
0413     <span class="comment">%If all the SBO terms are identical, don't add them to rxnMiriams</span>
0414     modelSBML.reaction = rmfield(modelSBML.reaction,<span class="string">'sboTerm'</span>);
0415 <span class="keyword">end</span>
0416 
0417 <span class="keyword">for</span> i=1:numel(modelSBML.reaction)
0418 
0419     <span class="comment">%Check that the reaction doesn't produce a complex and nothing else. If</span>
0420     <span class="comment">%so, then jump to the next reaction. This is because I get the genes</span>
0421     <span class="comment">%for complexes from the names and not from the reactions that create</span>
0422     <span class="comment">%them. This only applies to the non-COBRA format</span>
0423     <span class="keyword">if</span> numel(modelSBML.reaction(i).product)==1
0424         <span class="keyword">if</span> length(modelSBML.reaction(i).product(1).species)&gt;=3
0425             <span class="keyword">if</span> strcmp(modelSBML.reaction(i).product(1).species(1:3),<span class="string">'Cx_'</span>)==true
0426                 <span class="keyword">continue</span>;
0427             <span class="keyword">end</span>
0428         <span class="keyword">end</span>
0429     <span class="keyword">end</span>
0430 
0431     <span class="comment">%It didn't look like a gene complex-forming reaction</span>
0432     counter=counter+1;
0433 
0434     reactionNames{counter}=modelSBML.reaction(i).name;
0435 
0436     reactionIDs{counter}=modelSBML.reaction(i).id;
0437     reactionReversibility(counter)=modelSBML.reaction(i).reversible;
0438 
0439     <span class="comment">%If model is FBC, first get parameter of bound and then replace it with</span>
0440     <span class="comment">%the correct value. Probably faster with replace(), but this was only</span>
0441     <span class="comment">%introduced in Matlab R2016b</span>
0442     <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'fbc_lowerFluxBound'</span>)
0443         lb=modelSBML.reaction(i).fbc_lowerFluxBound;
0444         ub=modelSBML.reaction(i).fbc_upperFluxBound;
0445         <span class="keyword">for</span> n=1:numel(parameter.value)
0446             lb=regexprep(lb,parameter.name(n),num2str(parameter.value{n}));
0447             ub=regexprep(ub,parameter.name(n),num2str(parameter.value{n}));
0448         <span class="keyword">end</span>
0449         <span class="keyword">if</span> isempty(lb)
0450             lb=<span class="string">'-Inf'</span>;
0451         <span class="keyword">end</span>
0452         <span class="keyword">if</span> isempty(ub)
0453             ub=<span class="string">'Inf'</span>;
0454         <span class="keyword">end</span>
0455         reactionLB(counter)=str2num(lb);
0456         reactionUB(counter)=str2num(ub);
0457         <span class="comment">%The order of these parameters should not be hard coded</span>
0458     <span class="keyword">elseif</span> isfield(modelSBML.reaction(i).kineticLaw,<span class="string">'parameter'</span>)
0459         reactionLB(counter)=modelSBML.reaction(i).kineticLaw.parameter(1).value;
0460         reactionUB(counter)=modelSBML.reaction(i).kineticLaw.parameter(2).value;
0461         reactionObjective(counter)=modelSBML.reaction(i).kineticLaw.parameter(3).value;
0462     <span class="keyword">else</span>
0463         <span class="keyword">if</span> reactionReversibility(counter)==true
0464             reactionLB(counter)=-inf;
0465         <span class="keyword">else</span>
0466             reactionLB(counter)=0;
0467         <span class="keyword">end</span>
0468         reactionUB(counter)=inf;
0469         reactionObjective(counter)=0;
0470     <span class="keyword">end</span>
0471 
0472     <span class="comment">%Find the associated gene if available</span>
0473     <span class="comment">%If FBC, get gene association data from corresponding fields</span>
0474     <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'fbc_geneProductAssociation'</span>)
0475         <span class="keyword">if</span> ~isempty(modelSBML.reaction(i).fbc_geneProductAssociation) &amp;&amp; ~isempty(modelSBML.reaction(i).fbc_geneProductAssociation.fbc_association)
0476             grRules{counter}=modelSBML.reaction(i).fbc_geneProductAssociation.fbc_association.fbc_association;
0477         <span class="keyword">end</span>
0478     <span class="keyword">elseif</span> isfield(modelSBML.reaction(i),<span class="string">'notes'</span>)
0479         <span class="comment">%This section was previously executed only if isSBML2COBRA is true. Now</span>
0480         <span class="comment">%it will be executed, if 'GENE_ASSOCIATION' is found in</span>
0481         <span class="comment">%modelSBML.reaction(i).notes</span>
0482         <span class="keyword">if</span> strfind(modelSBML.reaction(i).notes,<span class="string">'GENE_ASSOCIATION'</span>)
0483             geneAssociation=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'GENE_ASSOCIATION'</span>);
0484         <span class="keyword">elseif</span> strfind(modelSBML.reaction(i).notes,<span class="string">'GENE ASSOCIATION'</span>)
0485             geneAssociation=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'GENE ASSOCIATION'</span>);
0486         <span class="keyword">else</span>
0487             geneAssociation=<span class="string">''</span>;
0488         <span class="keyword">end</span>
0489         <span class="keyword">if</span> ~isempty(geneAssociation)
0490             <span class="comment">%This adds the grRules. The gene list and rxnGeneMat are created</span>
0491             <span class="comment">%later</span>
0492             grRules{counter}=geneAssociation;
0493         <span class="keyword">end</span>
0494     <span class="keyword">end</span>
0495     <span class="keyword">if</span> isempty(grRules{counter}) &amp;&amp; ~isempty(modelSBML.reaction(i).modifier)
0496         rules=<span class="string">''</span>;
0497         <span class="keyword">for</span> j=1:numel(modelSBML.reaction(i).modifier)
0498             modifier=modelSBML.reaction(i).modifier(j).species;
0499             <span class="keyword">if</span> ~isempty(modifier)
0500                 <span class="keyword">if</span> strcmpi(modifier(1:2),<span class="string">'E_'</span>)
0501                     index=find(strcmp(modifier,geneIDs));
0502                     <span class="comment">%This should be unique and in the geneIDs list,</span>
0503                     <span class="comment">%otherwise something is wrong</span>
0504                     <span class="keyword">if</span> numel(index)~=1
0505                         EM=[<span class="string">'Could not get the gene association data from reaction '</span> reactionIDs{i}];
0506                         dispEM(EM);
0507                     <span class="keyword">end</span>
0508                     <span class="keyword">if</span> ~isempty(rules)
0509                         rules=[rules <span class="string">' or ('</span> geneNames{index} <span class="string">')'</span>];
0510                     <span class="keyword">else</span>
0511                         rules=[<span class="string">'('</span> geneNames{index} <span class="string">')'</span>];
0512                     <span class="keyword">end</span>
0513                 <span class="keyword">elseif</span> strcmp(modifier(1:2),<span class="string">'s_'</span>)
0514                     index=find(strcmp(modifier,metaboliteIDs));
0515                     <span class="comment">%This should be unique and in the geneIDs list,</span>
0516                     <span class="comment">%otherwise something is wrong</span>
0517                     <span class="keyword">if</span> numel(index)~=1
0518                         EM=[<span class="string">'Could not get the gene association data from reaction '</span> reactionIDs{i}];
0519                         dispEM(EM);
0520                     <span class="keyword">end</span>
0521                     <span class="keyword">if</span> ~isempty(rules)
0522                         rules=[rules <span class="string">' or ('</span> metaboliteIDs{index} <span class="string">')'</span>];
0523                     <span class="keyword">else</span>
0524                         rules=[<span class="string">'('</span> metaboliteIDs{index} <span class="string">')'</span>];
0525                     <span class="keyword">end</span>
0526                 <span class="keyword">else</span>
0527                     <span class="comment">%It seems to be a complex. Add the corresponding</span>
0528                     <span class="comment">%genes from the name of the complex (not the</span>
0529                     <span class="comment">%reaction that creates it)</span>
0530                     index=find(strcmp(modifier,complexIDs));
0531                     <span class="keyword">if</span> numel(index)==1
0532                         <span class="keyword">if</span> ~isempty(rules)
0533                             rules=[rules <span class="string">' or ('</span> strrep(complexNames{index},<span class="string">':'</span>,<span class="string">' and '</span>) <span class="string">')'</span>];
0534                         <span class="keyword">else</span>
0535                             rules=[<span class="string">'('</span> strrep(complexNames{index},<span class="string">':'</span>,<span class="string">' and '</span>) <span class="string">')'</span>];
0536                         <span class="keyword">end</span>
0537                     <span class="keyword">else</span>
0538                         <span class="comment">%Could not find a complex</span>
0539                         EM=[<span class="string">'Could not get the gene association data from reaction '</span> reactionIDs{i}];
0540                         dispEM(EM);
0541                     <span class="keyword">end</span>
0542                 <span class="keyword">end</span>
0543             <span class="keyword">end</span>
0544         <span class="keyword">end</span>
0545         grRules{counter}=rules;
0546         grRulesFromModifier{counter}=rules;<span class="comment">%Backup copy for grRules, useful to parse Yeast 7.6</span>
0547     <span class="keyword">end</span>
0548 
0549     <span class="comment">%Add reaction compartment</span>
0550     <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'compartment'</span>)
0551         <span class="keyword">if</span> ~isempty(modelSBML.reaction(i).compartment)
0552             rxnComp=modelSBML.reaction(i).compartment;
0553         <span class="keyword">else</span>
0554             rxnComp=<span class="string">''</span>;
0555         <span class="keyword">end</span>
0556     <span class="keyword">elseif</span> isfield(modelSBML.reaction(i),<span class="string">'notes'</span>)
0557         rxnComp=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'COMPARTMENT'</span>);
0558     <span class="keyword">end</span>
0559     <span class="keyword">if</span> ~isempty(rxnComp)
0560         <span class="comment">%Find it in the compartment list</span>
0561         [~, J]=ismember(rxnComp,compartmentIDs);
0562         rxnComps(counter)=J;
0563     <span class="keyword">end</span>
0564 
0565 
0566     miriamStruct=<a href="#_sub4" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.reaction(i).annotation);
0567     rxnMiriams{counter}=miriamStruct;
0568     <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'notes'</span>)
0569         subsystems{counter,1}=cellstr(<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'SUBSYSTEM'</span>));
0570         subsystems{counter,1}(cellfun(<span class="string">'isempty'</span>,subsystems{counter,1})) = [];
0571         <span class="keyword">if</span> strfind(modelSBML.reaction(i).notes,<span class="string">'Confidence Level'</span>)
0572             confScore = <a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'Confidence Level'</span>);
0573             <span class="keyword">if</span> isempty(confScore)
0574                 confScore = 0;
0575             <span class="keyword">end</span>
0576             rxnconfidencescores(counter)=str2double(confScore);
0577         <span class="keyword">end</span>
0578         rxnreferences{counter,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'AUTHORS'</span>);
0579         rxnnotes{counter,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'NOTES'</span>);
0580     <span class="keyword">end</span>
0581 
0582     <span class="comment">%Get SBO terms</span>
0583     <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'sboTerm'</span>) &amp;&amp; ~(modelSBML.reaction(i).sboTerm==-1)
0584         rxnMiriams{counter} = <a href="#_sub5" class="code" title="subfunction miriam = addSBOtoMiriam(miriam,sboTerm)">addSBOtoMiriam</a>(rxnMiriams{counter}, modelSBML.reaction(i).sboTerm);
0585     <span class="keyword">end</span>
0586 
0587     <span class="comment">%Get ec-codes</span>
0588     eccode=<span class="string">''</span>;
0589     <span class="keyword">if</span> ~isempty(modelSBML.reaction(i).annotation)
0590         <span class="keyword">if</span> strfind(modelSBML.reaction(i).annotation,<span class="string">'urn:miriam:ec-code'</span>)
0591             eccode=<a href="#_sub3" class="code" title="subfunction fieldContent=parseAnnotation(searchString,startString,midString,fieldName)">parseAnnotation</a>(modelSBML.reaction(i).annotation,<span class="string">'urn:miriam:'</span>,<span class="string">':'</span>,<span class="string">'ec-code'</span>);
0592         <span class="keyword">elseif</span> strfind(modelSBML.reaction(i).annotation,<span class="string">'http://identifiers.org/ec-code'</span>)
0593             eccode=<a href="#_sub3" class="code" title="subfunction fieldContent=parseAnnotation(searchString,startString,midString,fieldName)">parseAnnotation</a>(modelSBML.reaction(i).annotation,<span class="string">'http://identifiers.org/'</span>,<span class="string">'/'</span>,<span class="string">'ec-code'</span>);
0594         <span class="keyword">elseif</span> strfind(modelSBML.reaction(i).annotation,<span class="string">'https://identifiers.org/ec-code'</span>)
0595             eccode=<a href="#_sub3" class="code" title="subfunction fieldContent=parseAnnotation(searchString,startString,midString,fieldName)">parseAnnotation</a>(modelSBML.reaction(i).annotation,<span class="string">'https://identifiers.org/'</span>,<span class="string">'/'</span>,<span class="string">'ec-code'</span>);
0596         <span class="keyword">end</span>
0597     <span class="keyword">elseif</span> isfield(modelSBML.reaction(i),<span class="string">'notes'</span>)
0598         <span class="keyword">if</span> strfind(modelSBML.reaction(i).notes,<span class="string">'EC Number'</span>)
0599             eccode=[eccode <a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'EC Number'</span>)];
0600         <span class="keyword">elseif</span> strfind(modelSBML.reaction(i).notes,<span class="string">'PROTEIN_CLASS'</span>)
0601             eccode=[eccode <a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'PROTEIN_CLASS'</span>)];
0602         <span class="keyword">end</span>
0603     <span class="keyword">end</span>
0604     eccodes{counter}=eccode;
0605 
0606     <span class="comment">%Add all reactants</span>
0607     <span class="keyword">for</span> j=1:numel(modelSBML.reaction(i).reactant)
0608         <span class="comment">%Get the index of the metabolite in metaboliteIDs. External</span>
0609         <span class="comment">%metabolites will be removed at a later stage</span>
0610         metIndex=find(strcmp(modelSBML.reaction(i).reactant(j).species,metaboliteIDs),1);
0611         <span class="keyword">if</span> isempty(metIndex)
0612             EM=[<span class="string">'Could not find metabolite '</span> modelSBML.reaction(i).reactant(j).species <span class="string">' in reaction '</span> reactionIDs{counter}];
0613             dispEM(EM);
0614         <span class="keyword">end</span>
0615         S(metIndex,counter)=S(metIndex,counter)+modelSBML.reaction(i).reactant(j).stoichiometry*-1;
0616     <span class="keyword">end</span>
0617 
0618     <span class="comment">%Add all products</span>
0619     <span class="keyword">for</span> j=1:numel(modelSBML.reaction(i).product)
0620         <span class="comment">%Get the index of the metabolite in metaboliteIDs.</span>
0621         metIndex=find(strcmp(modelSBML.reaction(i).product(j).species,metaboliteIDs),1);
0622         <span class="keyword">if</span> isempty(metIndex)
0623             EM=[<span class="string">'Could not find metabolite '</span> modelSBML.reaction(i).product(j).species <span class="string">' in reaction '</span> reactionIDs{counter}];
0624             dispEM(EM);
0625         <span class="keyword">end</span>
0626         S(metIndex,counter)=S(metIndex,counter)+modelSBML.reaction(i).product(j).stoichiometry;
0627     <span class="keyword">end</span>
0628 <span class="keyword">end</span>
0629 
0630 <span class="comment">%if FBC, objective function is separately defined. Multiple objective</span>
0631 <span class="comment">%functions can be defined, one is set as active</span>
0632 <span class="keyword">if</span> isfield(modelSBML, <span class="string">'fbc_activeObjective'</span>)
0633     obj=modelSBML.fbc_activeObjective;
0634     <span class="keyword">for</span> i=1:numel(modelSBML.fbc_objective)
0635         <span class="keyword">if</span> strcmp(obj,modelSBML.fbc_objective(i).fbc_id)
0636             <span class="keyword">if</span> ~isempty(modelSBML.fbc_objective(i).fbc_fluxObjective)
0637                 rxn=modelSBML.fbc_objective(i).fbc_fluxObjective.fbc_reaction;
0638                 idx=find(ismember(reactionIDs,rxn));
0639                 reactionObjective(idx)=modelSBML.fbc_objective(i).fbc_fluxObjective.fbc_coefficient;
0640             <span class="keyword">end</span>
0641         <span class="keyword">end</span>
0642     <span class="keyword">end</span>
0643 <span class="keyword">end</span>
0644 
0645 <span class="comment">%subSystems can be stored as groups instead of in annotations</span>
0646 <span class="keyword">if</span> isfield(modelSBML,<span class="string">'groups_group'</span>)
0647     <span class="keyword">for</span> i=1:numel(modelSBML.groups_group)
0648         groupreactions={modelSBML.groups_group(i).groups_member(:).groups_idRef};
0649         [~, idx] = ismember(groupreactions, reactionIDs);
0650         <span class="keyword">if</span> any(idx)
0651             <span class="keyword">for</span> j=1:numel(idx)
0652                 <span class="keyword">if</span> isempty(subsystems{idx(j)}) <span class="comment">% First subsystem</span>
0653                     subsystems{idx(j)} = {modelSBML.groups_group(i).groups_name};
0654                 <span class="keyword">else</span> <span class="comment">% Consecutive subsystems: concatenate</span>
0655                     subsystems{idx(j)} = horzcat(subsystems{idx(j)}, modelSBML.groups_group(i).groups_name);
0656                 <span class="keyword">end</span>
0657             <span class="keyword">end</span>
0658         <span class="keyword">end</span>
0659     <span class="keyword">end</span>
0660 <span class="keyword">end</span>
0661 
0662 <span class="comment">%Shrink the structures if complex-forming reactions had to be skipped</span>
0663 reactionNames=reactionNames(1:counter);
0664 reactionIDs=reactionIDs(1:counter);
0665 subsystems=subsystems(1:counter);
0666 eccodes=eccodes(1:counter);
0667 rxnconfidencescores=rxnconfidencescores(1:counter);
0668 rxnreferences=rxnreferences(1:counter);
0669 rxnnotes=rxnnotes(1:counter);
0670 grRules=grRules(1:counter);
0671 rxnMiriams=rxnMiriams(1:counter);
0672 reactionReversibility=reactionReversibility(1:counter);
0673 reactionUB=reactionUB(1:counter);
0674 reactionLB=reactionLB(1:counter);
0675 reactionObjective=reactionObjective(1:counter);
0676 S=S(:,1:counter);
0677 
0678 model.name=modelSBML.name;
0679 model.id=modelSBML.id;
0680 model.rxns=reactionIDs;
0681 model.mets=metaboliteIDs;
0682 model.S=sparse(S);
0683 model.lb=reactionLB;
0684 model.ub=reactionUB;
0685 model.rev=reactionReversibility;
0686 model.c=reactionObjective;
0687 model.b=zeros(numel(metaboliteIDs),1);
0688 model.comps=compartmentIDs;
0689 model.compNames=compartmentNames;
0690 model.rxnConfidenceScores=rxnconfidencescores;
0691 model.rxnReferences=rxnreferences;
0692 model.rxnNotes=rxnnotes;
0693 
0694 <span class="comment">%Load annotation if available. If there are several authors, only the first</span>
0695 <span class="comment">%author credentials are imported</span>
0696 <span class="keyword">if</span> isfield(modelSBML,<span class="string">'annotation'</span>)
0697     endString=<span class="string">'&lt;/'</span>;
0698     I=strfind(modelSBML.annotation,endString);
0699     J=strfind(modelSBML.annotation,<span class="string">'&lt;vCard:Family&gt;'</span>);
0700     <span class="keyword">if</span> any(J)
0701         model.annotation.familyName=modelSBML.annotation(J(1)+14:I(find(I&gt;J(1),1))-1);
0702     <span class="keyword">end</span>
0703     J=strfind(modelSBML.annotation,<span class="string">'&lt;vCard:Given&gt;'</span>);
0704     <span class="keyword">if</span> any(J)
0705         model.annotation.givenName=modelSBML.annotation(J(1)+13:I(find(I&gt;J(1),1))-1);
0706     <span class="keyword">end</span>
0707     J=strfind(modelSBML.annotation,<span class="string">'&lt;vCard:EMAIL&gt;'</span>);
0708     <span class="keyword">if</span> any(J)
0709         model.annotation.email=modelSBML.annotation(J(1)+13:I(find(I&gt;J(1),1))-1);
0710     <span class="keyword">end</span>
0711     J=strfind(modelSBML.annotation,<span class="string">'&lt;vCard:Orgname&gt;'</span>);
0712     <span class="keyword">if</span> any(J)
0713         model.annotation.organization=modelSBML.annotation(J(1)+15:I(find(I&gt;J(1),1))-1);
0714     <span class="keyword">end</span>
0715     endString=<span class="string">'&quot;/&gt;'</span>;
0716     I=strfind(modelSBML.annotation,endString);
0717     <span class="keyword">if</span> strfind(modelSBML.annotation,<span class="string">'&quot;urn:miriam:'</span>)
0718         J=strfind(modelSBML.annotation,<span class="string">'&quot;urn:miriam:'</span>);
0719         <span class="keyword">if</span> any(J)
0720             model.annotation.taxonomy=modelSBML.annotation(J+12:I(find(I&gt;J,1))-1);
0721         <span class="keyword">end</span>
0722     <span class="keyword">else</span>
0723         J=strfind(modelSBML.annotation,<span class="string">'&quot;http://identifiers.org/'</span>);
0724         <span class="keyword">if</span> any(J)
0725             model.annotation.taxonomy=modelSBML.annotation(J+24:I(find(I&gt;J,1))-1);
0726         <span class="keyword">else</span>
0727             J=strfind(modelSBML.annotation,<span class="string">'&quot;https://identifiers.org/'</span>);
0728             <span class="keyword">if</span> any(J)
0729                 model.annotation.taxonomy=modelSBML.annotation(J+25:I(find(I&gt;J,1))-1);
0730             <span class="keyword">end</span>
0731         <span class="keyword">end</span>
0732     <span class="keyword">end</span>
0733 <span class="keyword">end</span>
0734 <span class="keyword">if</span> isfield(modelSBML,<span class="string">'notes'</span>)
0735     startString=strfind(modelSBML.notes,<span class="string">'xhtml&quot;&gt;'</span>);
0736     endString=strfind(modelSBML.notes,<span class="string">'&lt;/body&gt;'</span>);
0737     <span class="keyword">if</span> any(startString) &amp;&amp; any(endString)
0738         model.annotation.note=modelSBML.notes(startString+7:endString-1);
0739         model.annotation.note=regexprep(model.annotation.note,<span class="string">'&lt;p&gt;|&lt;/p&gt;'</span>,<span class="string">''</span>);
0740         model.annotation.note=strtrim(model.annotation.note);
0741         <span class="keyword">if</span> regexp(model.annotation.note,<span class="string">'This file was generated using the exportModel function in RAVEN Toolbox \d\.\d and OutputSBML in libSBML'</span>)
0742             model.annotation=rmfield(model.annotation,<span class="string">'note'</span>); <span class="comment">% Default note added when running exportModel</span>
0743         <span class="keyword">end</span>
0744     <span class="keyword">end</span>
0745 <span class="keyword">end</span>
0746 
0747 <span class="keyword">if</span> any(~cellfun(@isempty,compartmentOutside))
0748     model.compOutside=compartmentOutside;
0749 <span class="keyword">end</span>
0750 
0751 model.rxnNames=reactionNames;
0752 model.metNames=metaboliteNames;
0753 
0754 <span class="comment">%Match the compartments for metabolites</span>
0755 [~, J]=ismember(metaboliteCompartments,model.comps);
0756 model.metComps=J;
0757 
0758 <span class="comment">%If any genes have been loaded (only for the new format)</span>
0759 <span class="keyword">if</span> ~isempty(geneNames)
0760     <span class="comment">%In some rare cases geneNames may not necessarily be used in grRules.</span>
0761     <span class="comment">%That is true for Yeast 7.6. It's therefore important to change gene</span>
0762     <span class="comment">%systematic names to geneIDs in sophisticated way. Gene systematic</span>
0763     <span class="comment">%names are not unique, since exactly the same name may be in different</span>
0764     <span class="comment">%compartments</span>
0765     <span class="keyword">if</span> all(cellfun(@isempty,strfind(grRules,geneNames{1})))
0766         geneShortNames=geneNames;
0767         <span class="comment">%geneShortNames contain compartments as well, so these are removed</span>
0768         geneShortNames=regexprep(geneShortNames,<span class="string">' \[.+$'</span>,<span class="string">''</span>);
0769         <span class="comment">%grRules obtained from modifier fields contain geneNames. These are</span>
0770         <span class="comment">%changed into geneIDs. grRulesFromModifier is a good way to have</span>
0771         <span class="comment">%geneIDs and rxns association when it's important to resolve</span>
0772         <span class="comment">%systematic name ambiguities</span>
0773         grRulesFromModifier=regexprep(regexprep(grRulesFromModifier,<span class="string">'\[|\]'</span>,<span class="string">'_'</span>),regexprep(geneNames,<span class="string">'\[|\]'</span>,<span class="string">'_'</span>),geneIDs);
0774         grRules=regexprep(regexprep(grRules,<span class="string">'\[|\]'</span>,<span class="string">'_'</span>),regexprep(geneNames,<span class="string">'\[|\]'</span>,<span class="string">'_'</span>),geneIDs);
0775 
0776         <span class="comment">%Yeast 7.6 contains several metabolites, which were used in gene</span>
0777         <span class="comment">%associations. For that reason, the list of species ID is created</span>
0778         <span class="comment">%and we then check whether any of them have kegg.genes annotation</span>
0779         <span class="comment">%thereby obtaining systematic gene names</span>
0780         geneShortNames=vertcat(geneShortNames,metaboliteNames);
0781         geneIDs=vertcat(geneIDs,metaboliteIDs);
0782         geneSystNames=extractMiriam(vertcat(geneMiriams,metaboliteMiriams),<span class="string">'kegg.genes'</span>);
0783         geneCompartments=vertcat(geneCompartments,metaboliteCompartments);
0784         geneMiriams=vertcat(geneMiriams,metaboliteMiriams);
0785 
0786         <span class="comment">%Now we retain information for only these entries, which have</span>
0787         <span class="comment">%kegg.genes annotation</span>
0788         geneShortNames=geneShortNames(~cellfun(<span class="string">'isempty'</span>,geneSystNames));
0789         geneIDs=geneIDs(~cellfun(<span class="string">'isempty'</span>,geneSystNames));
0790         geneSystNames=geneSystNames(~cellfun(<span class="string">'isempty'</span>,geneSystNames));
0791         geneCompartments=geneCompartments(~cellfun(<span class="string">'isempty'</span>,geneSystNames));
0792         geneMiriams=geneMiriams(~cellfun(<span class="string">'isempty'</span>,geneSystNames));
0793         <span class="comment">%Now we reorder geneIDs and geneSystNames by geneSystNames string</span>
0794         <span class="comment">%length</span>
0795         geneNames=geneIDs;<span class="comment">%Backuping geneIDs, since we need unsorted order for later</span>
0796         [~, Indx] = sort(cellfun(<span class="string">'size'</span>, geneSystNames, 2), <span class="string">'descend'</span>);
0797         geneIDs = geneIDs(Indx);
0798         geneSystNames = geneSystNames(Indx);
0799         <span class="keyword">for</span> i=1:numel(geneSystNames)
0800             <span class="keyword">for</span> j=1:numel(grRules)
0801                 <span class="keyword">if</span> strfind(grRules{j},geneSystNames{i})
0802                     <span class="keyword">if</span> ~isempty(grRules{j})
0803                         <span class="keyword">if</span> sum(ismember(geneSystNames,geneSystNames{i}))==1
0804                             grRules{j}=regexprep(grRules{j},geneSystNames{i},geneIDs{i});
0805                         <span class="keyword">elseif</span> sum(ismember(geneSystNames,geneSystNames{i}))&gt;1
0806                             counter=0;
0807                             ovrlpIDs=geneIDs(ismember(geneSystNames,geneSystNames{i}));
0808                             <span class="keyword">for</span> k=1:numel(ovrlpIDs)
0809                                 <span class="keyword">if</span> strfind(grRulesFromModifier{j},ovrlpIDs{k})
0810                                     counter=counter+1;
0811                                     grRules{j}=regexprep(grRules{j},geneSystNames{i},ovrlpIDs{k});
0812                                 <span class="keyword">end</span>
0813                                 <span class="keyword">if</span> counter&gt;1
0814                                     EM=[<span class="string">'Gene association is ambiguous for reaction '</span> modelSBML.reaction(j).id];
0815                                     dispEM(EM);
0816                                 <span class="keyword">end</span>
0817                             <span class="keyword">end</span>
0818                         <span class="keyword">end</span>
0819                     <span class="keyword">end</span>
0820                 <span class="keyword">end</span>
0821             <span class="keyword">end</span>
0822         <span class="keyword">end</span>
0823     <span class="keyword">end</span>
0824     model.genes=geneNames;
0825     model.grRules=grRules;
0826     [grRules,rxnGeneMat] = standardizeGrRules(model,true);
0827     model.grRules = grRules;
0828     model.rxnGeneMat = rxnGeneMat;
0829 
0830     <span class="comment">%Match the compartments for genes</span>
0831     [~, J]=ismember(geneCompartments,model.comps);
0832     model.geneComps=J;
0833 <span class="keyword">else</span>
0834     <span class="keyword">if</span> ~all(cellfun(@isempty,grRules))
0835         <span class="comment">%If fbc_geneProduct exists, follow the specified gene order, such</span>
0836         <span class="comment">%that matching geneShortNames in function below will work</span>
0837         <span class="keyword">if</span> isfield(modelSBML,<span class="string">'fbc_geneProduct'</span>)
0838             genes={modelSBML.fbc_geneProduct.fbc_id};
0839 
0840             <span class="comment">%Get gene Miriams if they were not retrieved above (this occurs</span>
0841             <span class="comment">%when genes are stored as fbc_geneProduct instead of species)</span>
0842             <span class="keyword">if</span> isempty(geneMiriams)
0843                 geneMiriams = cell(numel(genes),1);
0844                 <span class="keyword">if</span> isfield(modelSBML.fbc_geneProduct,<span class="string">'sboTerm'</span>) &amp;&amp; numel(unique([modelSBML.fbc_geneProduct.sboTerm])) == 1
0845                     <span class="comment">%If all the SBO terms are identical, don't add them to geneMiriams</span>
0846                     modelSBML.fbc_geneProduct = rmfield(modelSBML.fbc_geneProduct,<span class="string">'sboTerm'</span>);
0847                 <span class="keyword">end</span>
0848                 <span class="keyword">for</span> i = 1:numel(genes)
0849                     geneMiriams{i}=<a href="#_sub4" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.fbc_geneProduct(i).annotation);
0850                     <span class="keyword">if</span> isfield(modelSBML.fbc_geneProduct(i),<span class="string">'sboTerm'</span>) &amp;&amp; ~(modelSBML.fbc_geneProduct(i).sboTerm==-1)
0851                         geneMiriams{i} = <a href="#_sub5" class="code" title="subfunction miriam = addSBOtoMiriam(miriam,sboTerm)">addSBOtoMiriam</a>(geneMiriams{i},modelSBML.fbc_geneProduct(i).sboTerm);
0852                     <span class="keyword">end</span>
0853                 <span class="keyword">end</span>
0854             <span class="keyword">end</span>
0855         <span class="keyword">else</span>
0856             genes=<a href="#_sub1" class="code" title="subfunction matchGenes=getGeneList(grRules)">getGeneList</a>(grRules);
0857         <span class="keyword">end</span>
0858         model.genes=genes;
0859         model.grRules=grRules;
0860         [grRules,rxnGeneMat] = standardizeGrRules(model,true);
0861         model.grRules = grRules;
0862         model.rxnGeneMat = rxnGeneMat;
0863     <span class="keyword">end</span>
0864 <span class="keyword">end</span>
0865 
0866 <span class="keyword">if</span> all(cellfun(@isempty,geneShortNames))
0867     <span class="keyword">if</span> isfield(modelSBML,<span class="string">'fbc_geneProduct'</span>)
0868         <span class="keyword">for</span> i=1:numel(genes)
0869             <span class="keyword">if</span> ~isempty(modelSBML.fbc_geneProduct(i).fbc_label)
0870                 geneShortNames{i,1}=modelSBML.fbc_geneProduct(i).fbc_label;
0871             <span class="keyword">elseif</span> ~isempty(modelSBML.fbc_geneProduct(i).fbc_name)
0872                 geneShortNames{i,1}=modelSBML.fbc_geneProduct(i).fbc_name;
0873             <span class="keyword">else</span>
0874                 geneShortNames{i,1}=<span class="string">''</span>;
0875             <span class="keyword">end</span>
0876         <span class="keyword">end</span>
0877     <span class="keyword">end</span>
0878 <span class="keyword">end</span>
0879 
0880 <span class="comment">%If any InChIs have been loaded</span>
0881 <span class="keyword">if</span> any(~cellfun(@isempty,metaboliteInChI))
0882     model.inchis=metaboliteInChI;
0883 <span class="keyword">end</span>
0884 
0885 <span class="comment">%If any formulas have been loaded</span>
0886 <span class="keyword">if</span> any(~cellfun(@isempty,metaboliteFormula))
0887     model.metFormulas=metaboliteFormula;
0888 <span class="keyword">end</span>
0889 
0890 <span class="comment">%If any charges have been loaded</span>
0891 <span class="keyword">if</span> ~isempty(metaboliteCharges)
0892     model.metCharges=metaboliteCharges;
0893 <span class="keyword">end</span>
0894 
0895 <span class="comment">%If any gene short names have been loaded</span>
0896 <span class="keyword">if</span> any(~cellfun(@isempty,geneShortNames))
0897     model.geneShortNames=geneShortNames;
0898 <span class="keyword">end</span>
0899 
0900 <span class="comment">%If any Miriam strings for compartments have been loaded</span>
0901 <span class="keyword">if</span> any(~cellfun(@isempty,compartmentMiriams))
0902     model.compMiriams=compartmentMiriams;
0903 <span class="keyword">end</span>
0904 
0905 <span class="comment">%If any Miriam strings for metabolites have been loaded</span>
0906 <span class="keyword">if</span> any(~cellfun(@isempty,metaboliteMiriams))
0907     model.metMiriams=metaboliteMiriams;
0908 <span class="keyword">end</span>
0909 
0910 <span class="comment">%If any subsystems have been loaded</span>
0911 <span class="keyword">if</span> any(~cellfun(@isempty,subsystems))
0912     model.subSystems=subsystems;
0913 <span class="keyword">end</span>
0914 <span class="keyword">if</span> any(rxnComps)
0915     <span class="keyword">if</span> all(rxnComps)
0916         model.rxnComps=rxnComps;
0917     <span class="keyword">else</span>
0918         <span class="keyword">if</span> supressWarnings==false
0919             EM=<span class="string">'The compartments for the following reactions could not be matched. Ignoring reaction compartment information'</span>;
0920             dispEM(EM,false,model.rxns(rxnComps==0));
0921         <span class="keyword">end</span>
0922     <span class="keyword">end</span>
0923 <span class="keyword">end</span>
0924 
0925 <span class="comment">%If any ec-codes have been loaded</span>
0926 <span class="keyword">if</span> any(~cellfun(@isempty,eccodes))
0927     model.eccodes=eccodes;
0928 <span class="keyword">end</span>
0929 
0930 <span class="comment">%If any Miriam strings for reactions have been loaded</span>
0931 <span class="keyword">if</span> any(~cellfun(@isempty,rxnMiriams))
0932     model.rxnMiriams=rxnMiriams;
0933 <span class="keyword">end</span>
0934 
0935 <span class="comment">%If any Miriam strings for genes have been loaded</span>
0936 <span class="keyword">if</span> any(~cellfun(@isempty,geneMiriams))
0937     model.geneMiriams=geneMiriams;
0938 <span class="keyword">end</span>
0939 
0940 model.unconstrained=metaboliteUnconstrained;
0941 
0942 <span class="comment">%Convert SBML IDs back into their original strings. Here we are using part</span>
0943 <span class="comment">%from convertSBMLID, originating from the COBRA Toolbox</span>
0944 model.rxns=regexprep(model.rxns,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
0945 model.mets=regexprep(model.mets,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
0946 model.comps=regexprep(model.comps,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
0947 model.grRules=regexprep(model.grRules,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
0948 model.genes=regexprep(model.genes,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
0949 model.id=regexprep(model.id,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
0950 
0951 
0952 hasCOBRAids(1) = all(startsWith(model.rxns,<span class="string">'R_'</span>));
0953 hasCOBRAids(2) = all(startsWith(model.mets,<span class="string">'M_'</span>));
0954 hasCOBRAids(3) = all(startsWith(model.comps,<span class="string">'C_'</span>));
0955 hasCOBRAids(4) = all(startsWith(model.genes,<span class="string">'G_'</span>));
0956 hasCOBRAids(5) = all(startsWith(model.metNames,<span class="string">'M_'</span>));
0957 hasCOBRAids(6) = all(startsWith(model.rxnNames,<span class="string">'R_'</span>));
0958 hasCOBRAids(7) = all(startsWith(model.id,<span class="string">'M_'</span>));
0959 
0960 <span class="keyword">if</span> COBRAstyle
0961     <span class="keyword">if</span> hasCOBRAids(1)
0962         model.rxns  = cellfun(@(x) x(3:end), model.rxns,<span class="string">'un'</span>,0);
0963     <span class="keyword">end</span>
0964     <span class="keyword">if</span> hasCOBRAids(2)
0965         model.mets  = cellfun(@(x) x(3:end), model.mets,<span class="string">'un'</span>,0);
0966     <span class="keyword">end</span>
0967     <span class="keyword">if</span> hasCOBRAids(3)
0968         model.comps = cellfun(@(x) x(3:end), model.comps,<span class="string">'un'</span>,0);
0969     <span class="keyword">end</span>
0970     <span class="keyword">if</span> hasCOBRAids(4)
0971         model.genes = cellfun(@(x) x(3:end), model.genes,<span class="string">'un'</span>,0);
0972         model.grRules=regexprep(model.grRules,<span class="string">'^G_'</span>,<span class="string">''</span>);
0973         model.grRules=regexprep(model.grRules,<span class="string">'\(G_'</span>,<span class="string">'('</span>);
0974         model.grRules=regexprep(model.grRules,<span class="string">' G_'</span>,<span class="string">' '</span>);
0975     <span class="keyword">end</span>
0976     <span class="comment">% Not strictly identifier, but also remove from metNames and rxnNames if present</span>
0977     <span class="keyword">if</span> hasCOBRAids(5)
0978         model.metNames  = cellfun(@(x) x(3:end), model.metNames,<span class="string">'un'</span>,0);
0979     <span class="keyword">end</span>
0980     <span class="keyword">if</span> hasCOBRAids(6)
0981         model.rxnNames  = cellfun(@(x) x(3:end), model.rxnNames,<span class="string">'un'</span>,0);
0982     <span class="keyword">end</span>
0983     <span class="keyword">if</span> hasCOBRAids(6)
0984         model.id        = model.id(3:end);
0985     <span class="keyword">end</span>
0986 <span class="keyword">elseif</span> any(hasCOBRAids)
0987     printOrange(<span class="string">'COBRA style identifier prefixes (like R_ for reactions) found in the model. To remove those, run importModel with COBRAstyle as true: importModel(''filename.xml'', [], true);\n'</span>);
0988 <span class="keyword">end</span>
0989 
0990 <span class="comment">%Remove unused fields</span>
0991 <span class="keyword">if</span> isempty(model.annotation)
0992     model=rmfield(model,<span class="string">'annotation'</span>);
0993 <span class="keyword">end</span>
0994 <span class="keyword">if</span> isempty(model.compOutside)
0995     model=rmfield(model,<span class="string">'compOutside'</span>);
0996 <span class="keyword">end</span>
0997 <span class="keyword">if</span> isempty(model.compMiriams)
0998     model=rmfield(model,<span class="string">'compMiriams'</span>);
0999 <span class="keyword">end</span>
1000 <span class="keyword">if</span> isempty(model.rxnComps)
1001     model=rmfield(model,<span class="string">'rxnComps'</span>);
1002 <span class="keyword">end</span>
1003 <span class="keyword">if</span> isempty(model.grRules)
1004     model=rmfield(model,<span class="string">'grRules'</span>);
1005 <span class="keyword">end</span>
1006 <span class="keyword">if</span> isempty(model.rxnGeneMat)
1007     model=rmfield(model,<span class="string">'rxnGeneMat'</span>);
1008 <span class="keyword">end</span>
1009 <span class="keyword">if</span> isempty(model.subSystems)
1010     model=rmfield(model,<span class="string">'subSystems'</span>);
1011 <span class="keyword">else</span>
1012     model.subSystems(cellfun(@isempty,subsystems))={{<span class="string">''</span>}};
1013 <span class="keyword">end</span>
1014 <span class="keyword">if</span> isempty(model.eccodes)
1015     model=rmfield(model,<span class="string">'eccodes'</span>);
1016 <span class="keyword">end</span>
1017 <span class="keyword">if</span> isempty(model.rxnMiriams)
1018     model=rmfield(model,<span class="string">'rxnMiriams'</span>);
1019 <span class="keyword">end</span>
1020 <span class="keyword">if</span> cellfun(@isempty,model.rxnNotes)
1021     model=rmfield(model,<span class="string">'rxnNotes'</span>);
1022 <span class="keyword">end</span>
1023 <span class="keyword">if</span> cellfun(@isempty,model.rxnReferences)
1024     model=rmfield(model,<span class="string">'rxnReferences'</span>);
1025 <span class="keyword">end</span>
1026 <span class="keyword">if</span> isempty(model.rxnConfidenceScores) || all(isnan(model.rxnConfidenceScores))
1027     model=rmfield(model,<span class="string">'rxnConfidenceScores'</span>);
1028 <span class="keyword">end</span>
1029 <span class="keyword">if</span> isempty(model.genes)
1030     model=rmfield(model,<span class="string">'genes'</span>);
1031 <span class="keyword">elseif</span> isrow(model.genes)
1032     model.genes=transpose(model.genes);
1033 <span class="keyword">end</span>
1034 <span class="keyword">if</span> isempty(model.geneComps)
1035     model=rmfield(model,<span class="string">'geneComps'</span>);
1036 <span class="keyword">end</span>
1037 <span class="keyword">if</span> isempty(model.geneMiriams)
1038     model=rmfield(model,<span class="string">'geneMiriams'</span>);
1039 <span class="keyword">end</span>
1040 <span class="keyword">if</span> isempty(model.geneShortNames)
1041     model=rmfield(model,<span class="string">'geneShortNames'</span>);
1042 <span class="keyword">end</span>
1043 <span class="keyword">if</span> isempty(model.inchis)
1044     model=rmfield(model,<span class="string">'inchis'</span>);
1045 <span class="keyword">end</span>
1046 <span class="keyword">if</span> isempty(model.metFormulas)
1047     model=rmfield(model,<span class="string">'metFormulas'</span>);
1048 <span class="keyword">end</span>
1049 <span class="keyword">if</span> isempty(model.metMiriams)
1050     model=rmfield(model,<span class="string">'metMiriams'</span>);
1051 <span class="keyword">end</span>
1052 <span class="keyword">if</span> ~any(model.metCharges)
1053     model=rmfield(model,<span class="string">'metCharges'</span>);
1054 <span class="keyword">end</span>
1055 
1056 <span class="comment">%This just removes the grRules if no genes have been loaded</span>
1057 <span class="keyword">if</span> ~isfield(model,<span class="string">'genes'</span>) &amp;&amp; isfield(model,<span class="string">'grRules'</span>)
1058     model=rmfield(model,<span class="string">'grRules'</span>);
1059 <span class="keyword">end</span>
1060 
1061 <span class="comment">%Print warnings about bad structure</span>
1062 <span class="keyword">if</span> supressWarnings==false
1063     checkModelStruct(model,false);
1064 <span class="keyword">end</span>
1065 
1066 <span class="keyword">if</span> removeExcMets==true
1067     model=simplifyModel(model);
1068 <span class="keyword">end</span>
1069 <span class="keyword">end</span>
1070 
1071 <a name="_sub1" href="#_subfunctions" class="code">function matchGenes=getGeneList(grRules)</a>
1072 <span class="comment">%Constructs the list of unique genes from grRules</span>
1073 
1074 <span class="comment">%Assumes that everything that isn't a paranthesis, &quot; AND &quot; or &quot; or &quot; is a</span>
1075 <span class="comment">%gene name</span>
1076 genes=strrep(grRules,<span class="string">'('</span>,<span class="string">''</span>);
1077 genes=strrep(genes,<span class="string">')'</span>,<span class="string">''</span>);
1078 genes=strrep(genes,<span class="string">' or '</span>,<span class="string">' '</span>);
1079 genes=strrep(genes,<span class="string">' and '</span>,<span class="string">' '</span>);
1080 genes=strrep(genes,<span class="string">' OR '</span>,<span class="string">' '</span>);
1081 genes=strrep(genes,<span class="string">' AND '</span>,<span class="string">' '</span>);
1082 genes=regexp(genes,<span class="string">' '</span>,<span class="string">'split'</span>);
1083 
1084 allNames={};
1085 <span class="keyword">for</span> i=1:numel(genes)
1086     allNames=[allNames genes{i}];
1087 <span class="keyword">end</span>
1088 matchGenes=unique(allNames)';
1089 
1090 <span class="comment">%Remove the empty element if present</span>
1091 <span class="keyword">if</span> isempty(matchGenes{1})
1092     matchGenes(1)=[];
1093 <span class="keyword">end</span>
1094 <span class="keyword">end</span>
1095 
1096 <a name="_sub2" href="#_subfunctions" class="code">function fieldContent=parseNote(searchString,fieldName)</a>
1097 <span class="comment">%The function obtains the particular information from 'notes' field, using</span>
1098 <span class="comment">%fieldName as the dummy string</span>
1099 
1100 fieldContent=<span class="string">''</span>;
1101 
1102 <span class="keyword">if</span> strfind(searchString,fieldName)
1103     [~,targetString] = regexp(searchString,[<span class="string">'&lt;p&gt;'</span> fieldName <span class="string">'.*?&lt;/p&gt;'</span>],<span class="string">'tokens'</span>,<span class="string">'match'</span>);
1104     targetString=regexprep(targetString,<span class="string">'&lt;p&gt;|&lt;/p&gt;'</span>,<span class="string">''</span>);
1105     targetString=regexprep(targetString,[fieldName, <span class="string">':'</span>],<span class="string">''</span>);
1106     <span class="keyword">for</span> i=1:numel(targetString)
1107         fieldContent=[fieldContent <span class="string">';'</span> strtrim(targetString{1,i})];
1108     <span class="keyword">end</span>
1109     fieldContent=regexprep(fieldContent,<span class="string">'^;|;$'</span>,<span class="string">''</span>);
1110 <span class="keyword">else</span>
1111     fieldContent=<span class="string">''</span>;
1112 <span class="keyword">end</span>
1113 <span class="keyword">end</span>
1114 
1115 <a name="_sub3" href="#_subfunctions" class="code">function fieldContent=parseAnnotation(searchString,startString,midString,fieldName)</a>
1116 
1117 fieldContent=<span class="string">''</span>;
1118 
1119 <span class="comment">%Removing whitespace characters from the ending strings, which may occur in</span>
1120 <span class="comment">%several cases</span>
1121 searchString=regexprep(searchString,<span class="string">'&quot; /&gt;'</span>,<span class="string">'&quot;/&gt;'</span>);
1122 [~,targetString] = regexp(searchString,[<span class="string">'&lt;rdf:li rdf:resource=&quot;'</span> startString fieldName midString <span class="string">'.*?&quot;/&gt;'</span>],<span class="string">'tokens'</span>,<span class="string">'match'</span>);
1123 targetString=regexprep(targetString,<span class="string">'&lt;rdf:li rdf:resource=&quot;|&quot;/&gt;'</span>,<span class="string">''</span>);
1124 targetString=regexprep(targetString,startString,<span class="string">''</span>);
1125 targetString=regexprep(targetString,[fieldName midString],<span class="string">''</span>);
1126 
1127 <span class="keyword">for</span> i=1:numel(targetString)
1128     fieldContent=[fieldContent <span class="string">';'</span> strtrim(targetString{1,i})];
1129 <span class="keyword">end</span>
1130 
1131 fieldContent=regexprep(fieldContent,<span class="string">'^;|;$'</span>,<span class="string">''</span>);
1132 <span class="keyword">end</span>
1133 
1134 <a name="_sub4" href="#_subfunctions" class="code">function miriamStruct=parseMiriam(searchString)</a>
1135 <span class="comment">%Generates miriam structure from annotation field</span>
1136 
1137 <span class="comment">%Finding whether miriams are written in the old or the new way</span>
1138 <span class="keyword">if</span> strfind(searchString,<span class="string">'urn:miriam:'</span>)
1139     startString=<span class="string">'urn:miriam:'</span>;
1140     midString=<span class="string">':'</span>;
1141 <span class="keyword">elseif</span> strfind(searchString,<span class="string">'http://identifiers.org/'</span>)
1142     startString=<span class="string">'http://identifiers.org/'</span>;
1143     midString=<span class="string">'/'</span>;
1144 <span class="keyword">elseif</span> strfind(searchString,<span class="string">'https://identifiers.org/'</span>)
1145     startString=<span class="string">'https://identifiers.org/'</span>;
1146     midString=<span class="string">'/'</span>;
1147 <span class="keyword">else</span>
1148     miriamStruct=[];
1149     <span class="keyword">return</span>;
1150 <span class="keyword">end</span>
1151 
1152 miriamStruct=[];
1153 
1154 searchString=regexprep(searchString,<span class="string">'&quot; /&gt;'</span>,<span class="string">'&quot;/&gt;'</span>);
1155 [~,targetString] = regexp(searchString,<span class="string">'&lt;rdf:li rdf:resource=&quot;.*?&quot;/&gt;'</span>,<span class="string">'tokens'</span>,<span class="string">'match'</span>);
1156 targetString=regexprep(targetString,<span class="string">'&lt;rdf:li rdf:resource=&quot;|&quot;/&gt;'</span>,<span class="string">''</span>);
1157 targetString=regexprep(targetString,startString,<span class="string">''</span>);
1158 targetString=regexprep(targetString,midString,<span class="string">'/'</span>,<span class="string">'once'</span>);
1159 
1160 counter=0;
1161 <span class="keyword">for</span> i=1:numel(targetString)
1162     <span class="keyword">if</span> isempty(regexp(targetString{1,i},<span class="string">'inchi|ec-code'</span>, <span class="string">'once'</span>))
1163         counter=counter+1;
1164         miriamStruct.name{counter,1} = regexprep(targetString{1,i},<span class="string">'/.+'</span>,<span class="string">''</span>,<span class="string">'once'</span>);
1165         miriamStruct.value{counter,1} = regexprep(targetString{1,i},[miriamStruct.name{counter,1} <span class="string">'/'</span>],<span class="string">''</span>,<span class="string">'once'</span>);
1166         miriamStruct.name{counter,1} = regexprep(miriamStruct.name{counter,1},<span class="string">'^obo\.'</span>,<span class="string">''</span>);
1167     <span class="keyword">end</span>
1168 <span class="keyword">end</span>
1169 <span class="keyword">end</span>
1170 
1171 <a name="_sub5" href="#_subfunctions" class="code">function miriam = addSBOtoMiriam(miriam,sboTerm)</a>
1172 <span class="comment">%Appends SBO term to miriam structure</span>
1173 
1174 sboTerm = {[<span class="string">'SBO:'</span> sprintf(<span class="string">'%07u'</span>,sboTerm)]};  <span class="comment">% convert to proper format</span>
1175 <span class="keyword">if</span> isempty(miriam)
1176     miriam.name = {<span class="string">'sbo'</span>};
1177     miriam.value = sboTerm;
1178 <span class="keyword">elseif</span> any(strcmp(<span class="string">'sbo'</span>,miriam.name))
1179     currSbo = strcmp(<span class="string">'sbo'</span>,miriam.name);
1180     miriam.value(currSbo) = sboTerm;
1181 <span class="keyword">else</span>
1182     miriam.name(end+1) = {<span class="string">'sbo'</span>};
1183     miriam.value(end+1) = sboTerm;
1184 <span class="keyword">end</span>
1185 <span class="keyword">end</span></pre></div>
<hr><address>Generated by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>