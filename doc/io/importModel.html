<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of importModel</title>
  <meta name="keywords" content="importModel">
  <meta name="description" content="importModel">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">io</a> &gt; importModel.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for io&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>importModel
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>importModel</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function model=importModel(fileName,removeExcMets,isSBML2COBRA,supressWarnings) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> importModel
   Import a constraint-based model from a SBML file

 Input:
   fileName        a SBML file to import. A dialog window will open if 
                   no file name is specified.
   removeExcMets   true if exchange metabolites should be removed. This is
                   needed to be able to run simulations, but it could also
                   be done using simplifyModel at a later stage (optional,
                   default true)
   isSBML2COBRA    true if the SBML file is in the old COBRA Toolbox
                   format (SBML Level 2) (optional, default false)
   supressWarnings true if warnings regarding the model structure should
                   be supressed (optional, default false)

 Output:
   model
       id               model ID
       name             name of model contents
       annotation       additional information about model
       rxns             reaction ids
       mets             metabolite ids
       S                stoichiometric matrix
       lb               lower bounds
       ub               upper bounds
       rev              reversibility vector
       c                objective coefficients
       b                equality constraints for the metabolite equations
       comps            compartment ids
       compNames        compartment names
       compOutside      the id (as in comps) for the compartment
                        surrounding each of the compartments
       compMiriams      structure with MIRIAM information about the
                        compartments
       rxnNames         reaction description
       rxnComps         compartments for reactions
       grRules          reaction to gene rules in text form
       rxnGeneMat       reaction-to-gene mapping in sparse matrix form
       subSystems       subsystem name for each reaction
       eccodes          EC-codes for the reactions
       rxnMiriams       structure with MIRIAM information about the reactions
       rxnNotes         reaction notes
       rxnReferences    reaction references
       rxnConfidenceScores reaction confidence scores
       genes            list of all genes
       geneComps        compartments for genes
       geneMiriams      structure with MIRIAM information about the genes
       geneShortNames   gene alternative names (e.g. ERG10)
       proteinNames     protein associated to each gene
       metNames         metabolite description
       metComps         compartments for metabolites
       inchis           InChI-codes for metabolites
       metFormulas      metabolite chemical formula
       metMiriams       structure with MIRIAM information about the metabolites
       metCharges       metabolite charge
       unconstrained    true if the metabolite is an exchange metabolite

 A number of consistency checks are performed in order to ensure that the
 model is valid. Take these warnings seriously and modify the model
 structure to solve them.

 Usage: model = importModel(fileName, removeExcMets, isSBML2COBRA, supressWarnings)</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="checkFileExistence.html" class="code" title="function files=checkFileExistence(files,fullOrTemp,allowSpace,checkExist)">checkFileExistence</a>	checkFileExistence</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function matchGenes=getGeneList(grRules)</a></li><li><a href="#_sub2" class="code">function fieldContent=parseNote(searchString,fieldName)</a></li><li><a href="#_sub3" class="code">function fieldContent=parseAnnotation(searchString,startString,midString,fieldName)</a></li><li><a href="#_sub4" class="code">function miriamStruct=parseMiriam(searchString)</a></li><li><a href="#_sub5" class="code">function miriam = addSBOtoMiriam(miriam,sboTerm)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function model=importModel(fileName,removeExcMets,isSBML2COBRA,supressWarnings)</a>
0002 <span class="comment">% importModel</span>
0003 <span class="comment">%   Import a constraint-based model from a SBML file</span>
0004 <span class="comment">%</span>
0005 <span class="comment">% Input:</span>
0006 <span class="comment">%   fileName        a SBML file to import. A dialog window will open if</span>
0007 <span class="comment">%                   no file name is specified.</span>
0008 <span class="comment">%   removeExcMets   true if exchange metabolites should be removed. This is</span>
0009 <span class="comment">%                   needed to be able to run simulations, but it could also</span>
0010 <span class="comment">%                   be done using simplifyModel at a later stage (optional,</span>
0011 <span class="comment">%                   default true)</span>
0012 <span class="comment">%   isSBML2COBRA    true if the SBML file is in the old COBRA Toolbox</span>
0013 <span class="comment">%                   format (SBML Level 2) (optional, default false)</span>
0014 <span class="comment">%   supressWarnings true if warnings regarding the model structure should</span>
0015 <span class="comment">%                   be supressed (optional, default false)</span>
0016 <span class="comment">%</span>
0017 <span class="comment">% Output:</span>
0018 <span class="comment">%   model</span>
0019 <span class="comment">%       id               model ID</span>
0020 <span class="comment">%       name             name of model contents</span>
0021 <span class="comment">%       annotation       additional information about model</span>
0022 <span class="comment">%       rxns             reaction ids</span>
0023 <span class="comment">%       mets             metabolite ids</span>
0024 <span class="comment">%       S                stoichiometric matrix</span>
0025 <span class="comment">%       lb               lower bounds</span>
0026 <span class="comment">%       ub               upper bounds</span>
0027 <span class="comment">%       rev              reversibility vector</span>
0028 <span class="comment">%       c                objective coefficients</span>
0029 <span class="comment">%       b                equality constraints for the metabolite equations</span>
0030 <span class="comment">%       comps            compartment ids</span>
0031 <span class="comment">%       compNames        compartment names</span>
0032 <span class="comment">%       compOutside      the id (as in comps) for the compartment</span>
0033 <span class="comment">%                        surrounding each of the compartments</span>
0034 <span class="comment">%       compMiriams      structure with MIRIAM information about the</span>
0035 <span class="comment">%                        compartments</span>
0036 <span class="comment">%       rxnNames         reaction description</span>
0037 <span class="comment">%       rxnComps         compartments for reactions</span>
0038 <span class="comment">%       grRules          reaction to gene rules in text form</span>
0039 <span class="comment">%       rxnGeneMat       reaction-to-gene mapping in sparse matrix form</span>
0040 <span class="comment">%       subSystems       subsystem name for each reaction</span>
0041 <span class="comment">%       eccodes          EC-codes for the reactions</span>
0042 <span class="comment">%       rxnMiriams       structure with MIRIAM information about the reactions</span>
0043 <span class="comment">%       rxnNotes         reaction notes</span>
0044 <span class="comment">%       rxnReferences    reaction references</span>
0045 <span class="comment">%       rxnConfidenceScores reaction confidence scores</span>
0046 <span class="comment">%       genes            list of all genes</span>
0047 <span class="comment">%       geneComps        compartments for genes</span>
0048 <span class="comment">%       geneMiriams      structure with MIRIAM information about the genes</span>
0049 <span class="comment">%       geneShortNames   gene alternative names (e.g. ERG10)</span>
0050 <span class="comment">%       proteinNames     protein associated to each gene</span>
0051 <span class="comment">%       metNames         metabolite description</span>
0052 <span class="comment">%       metComps         compartments for metabolites</span>
0053 <span class="comment">%       inchis           InChI-codes for metabolites</span>
0054 <span class="comment">%       metFormulas      metabolite chemical formula</span>
0055 <span class="comment">%       metMiriams       structure with MIRIAM information about the metabolites</span>
0056 <span class="comment">%       metCharges       metabolite charge</span>
0057 <span class="comment">%       unconstrained    true if the metabolite is an exchange metabolite</span>
0058 <span class="comment">%</span>
0059 <span class="comment">% A number of consistency checks are performed in order to ensure that the</span>
0060 <span class="comment">% model is valid. Take these warnings seriously and modify the model</span>
0061 <span class="comment">% structure to solve them.</span>
0062 <span class="comment">%</span>
0063 <span class="comment">% Usage: model = importModel(fileName, removeExcMets, isSBML2COBRA, supressWarnings)</span>
0064 
0065 <span class="keyword">if</span> nargin&lt;1 || isempty(fileName)
0066     [fileName, pathName] = uigetfile({<span class="string">'*.xml;*.sbml'</span>}, <span class="string">'Please select the model file'</span>);
0067     <span class="keyword">if</span> fileName == 0
0068         error(<span class="string">'You should select a model file'</span>)
0069     <span class="keyword">else</span>
0070         fileName = fullfile(pathName,fileName);
0071     <span class="keyword">end</span>
0072 <span class="keyword">end</span>
0073 fileName=char(fileName);
0074 <span class="keyword">if</span> nargin&lt;2 || isempty(removeExcMets)
0075     removeExcMets=true;
0076 <span class="keyword">end</span>
0077 
0078 <span class="keyword">if</span> nargin&lt;3 || isempty(isSBML2COBRA)
0079     isSBML2COBRA=false;
0080 <span class="keyword">end</span>
0081 
0082 <span class="keyword">if</span> nargin&lt;4
0083     supressWarnings=false;
0084 <span class="keyword">end</span>
0085 
0086 <span class="keyword">if</span> ~isfile(fileName)
0087     error(<span class="string">'SBML file %s cannot be found'</span>,string(fileName));
0088 <span class="keyword">end</span>
0089 
0090 <span class="comment">%This is to match the order of the fields to those you get from importing</span>
0091 <span class="comment">%from Excel</span>
0092 model=[];
0093 model.id=[];
0094 model.name=[];
0095 model.annotation=[];
0096 model.rxns={};
0097 model.mets={};
0098 model.S=[];
0099 model.lb=[];
0100 model.ub=[];
0101 model.rev=[];
0102 model.c=[];
0103 model.b=[];
0104 model.comps={};
0105 model.compNames={};
0106 model.compOutside={};
0107 model.compMiriams={};
0108 model.rxnNames={};
0109 model.rxnComps=[];
0110 model.grRules={};
0111 model.rxnGeneMat=[];
0112 model.subSystems={};
0113 model.eccodes={};
0114 model.rxnMiriams={};
0115 model.rxnNotes={};
0116 model.rxnReferences={};
0117 model.rxnConfidenceScores=[];
0118 model.genes={};
0119 model.geneComps=[];
0120 model.geneMiriams={};
0121 model.geneShortNames={};
0122 model.proteinNames={};
0123 model.metNames={};
0124 model.metComps=[];
0125 model.inchis={};
0126 model.metFormulas={};
0127 model.metMiriams={};
0128 model.metCharges=[];
0129 model.unconstrained=[];
0130 
0131 <span class="comment">%Load the model using libSBML</span>
0132 [ravenDir,prevDir]=findRAVENroot();
0133 fileName=<a href="checkFileExistence.html" class="code" title="function files=checkFileExistence(files,fullOrTemp,allowSpace,checkExist)">checkFileExistence</a>(fileName,1);
0134 modelSBML = TranslateSBML_RAVEN(fileName,0,0,[1 1]);
0135 
0136 <span class="keyword">if</span> isempty(modelSBML)
0137     EM=<span class="string">'There is a problem with the SBML file. Try using the SBML Validator at http://sbml.org/Facilities/Validator'</span>;
0138     dispEM(EM);
0139 <span class="keyword">end</span>
0140 
0141 <span class="comment">%Remove the preceding strings for reactions, compartments and</span>
0142 <span class="comment">%reactants/products in 'reaction' field. The strings for metabolites, genes</span>
0143 <span class="comment">%and complexes are not removed, as we will need them later to identify them</span>
0144 <span class="comment">%from 'species' field</span>
0145 <span class="keyword">for</span> i=1:numel(modelSBML.reaction)
0146     modelSBML.reaction(i).name=regexprep(modelSBML.reaction(i).name,<span class="string">'^R_'</span>,<span class="string">''</span>);
0147     modelSBML.reaction(i).id=regexprep(modelSBML.reaction(i).id,<span class="string">'^R_'</span>,<span class="string">''</span>);
0148     <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'compartment'</span>)
0149         modelSBML.reaction(i).compartment=regexprep(modelSBML.reaction(i).compartment,<span class="string">'^C_'</span>,<span class="string">''</span>);
0150     <span class="keyword">end</span>
0151     <span class="keyword">for</span> j=1:numel(modelSBML.reaction(i).reactant)
0152         modelSBML.reaction(i).reactant(j).species=regexprep(modelSBML.reaction(i).reactant(j).species,<span class="string">'^M_'</span>,<span class="string">''</span>);
0153     <span class="keyword">end</span>
0154     <span class="keyword">for</span> j=1:numel(modelSBML.reaction(i).product)
0155         modelSBML.reaction(i).product(j).species=regexprep(modelSBML.reaction(i).product(j).species,<span class="string">'^M_'</span>,<span class="string">''</span>);
0156     <span class="keyword">end</span>
0157 <span class="keyword">end</span>
0158 
0159 <span class="comment">%Retrieve compartment names and IDs</span>
0160 compartmentNames=cell(numel(modelSBML.compartment),1);
0161 compartmentIDs=cell(numel(modelSBML.compartment),1);
0162 compartmentOutside=cell(numel(modelSBML.compartment),1);
0163 compartmentMiriams=cell(numel(modelSBML.compartment),1);
0164 
0165 <span class="keyword">if</span> isfield(modelSBML.compartment,<span class="string">'sboTerm'</span>) &amp;&amp; numel(unique([modelSBML.compartment.sboTerm])) == 1
0166     <span class="comment">%If all the SBO terms are identical, don't add them to compMiriams</span>
0167     modelSBML.compartment = rmfield(modelSBML.compartment,<span class="string">'sboTerm'</span>);
0168 <span class="keyword">end</span>
0169     
0170 <span class="keyword">for</span> i=1:numel(modelSBML.compartment)
0171     compartmentNames{i}=modelSBML.compartment(i).name;
0172     compartmentIDs{i}=regexprep(modelSBML.compartment(i).id,<span class="string">'^C_'</span>,<span class="string">''</span>);
0173     <span class="keyword">if</span> isfield(modelSBML.compartment(i),<span class="string">'outside'</span>)
0174         <span class="keyword">if</span> ~isempty(modelSBML.compartment(i).outside)
0175             compartmentOutside{i}=regexprep(modelSBML.compartment(i).outside,<span class="string">'^C_'</span>,<span class="string">''</span>);
0176         <span class="keyword">else</span>
0177             compartmentOutside{i}=<span class="string">''</span>;
0178         <span class="keyword">end</span>
0179     <span class="keyword">else</span>
0180         compartmentOutside{i}=[];
0181     <span class="keyword">end</span>
0182     
0183     <span class="keyword">if</span> isfield(modelSBML.compartment(i),<span class="string">'annotation'</span>)
0184         compartmentMiriams{i}=<a href="#_sub4" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.compartment(i).annotation);
0185     <span class="keyword">else</span>
0186         compartmentMiriams{i}=[];
0187     <span class="keyword">end</span>
0188     
0189     <span class="keyword">if</span> isfield(modelSBML.compartment(i),<span class="string">'sboTerm'</span>) &amp;&amp; ~(modelSBML.compartment(i).sboTerm==-1)
0190         compartmentMiriams{i} = <a href="#_sub5" class="code" title="subfunction miriam = addSBOtoMiriam(miriam,sboTerm)">addSBOtoMiriam</a>(compartmentMiriams{i},modelSBML.compartment(i).sboTerm);
0191     <span class="keyword">end</span>
0192 <span class="keyword">end</span>
0193 
0194 <span class="comment">%If there are no compartment names then use compartment id as name</span>
0195 <span class="keyword">if</span> all(cellfun(@isempty,compartmentNames))
0196     compartmentNames=compartmentIDs;
0197 <span class="keyword">end</span>
0198 
0199 <span class="comment">%Retrieve info on metabolites, genes, complexes</span>
0200 metaboliteNames={};
0201 metaboliteIDs={};
0202 metaboliteCompartments={};
0203 metaboliteUnconstrained=[];
0204 metaboliteFormula={};
0205 metaboliteInChI={};
0206 metaboliteMiriams={};
0207 metaboliteCharges=[];
0208 
0209 geneNames={};
0210 geneIDs={};
0211 geneMiriams={};
0212 geneShortNames={};
0213 proteinNames={};
0214 geneCompartments={};
0215 complexIDs={};
0216 complexNames={};
0217 
0218 <span class="comment">%If the file is not a COBRA Toolbox model. According to the format</span>
0219 <span class="comment">%specified in the yeast consensus model both metabolites and genes are a</span>
0220 <span class="comment">%type of 'species'. The metabolites have names starting with 'M_' and genes</span>
0221 <span class="comment">%with 'E_'</span>
0222 geneSBOs = [];
0223 metSBOs = [];
0224 <span class="comment">%Regex of compartment names, later to be used to remove from metabolite</span>
0225 <span class="comment">%names if present as suffix.</span>
0226 regexCompNames = [<span class="string">'\s?\[(('</span> strjoin({modelSBML.compartment.name},<span class="string">')|('</span>) <span class="string">'))\]$'</span>];
0227 <span class="keyword">for</span> i=1:numel(modelSBML.species)
0228     <span class="keyword">if</span> ~isSBML2COBRA
0229         <span class="keyword">if</span> length(modelSBML.species(i).id)&gt;=2 &amp;&amp; strcmpi(modelSBML.species(i).id(1:2),<span class="string">'E_'</span>)
0230             geneNames{numel(geneNames)+1,1}=modelSBML.species(i).name;
0231             
0232             <span class="comment">%The &quot;E_&quot; is included in the ID. This is because it's only used</span>
0233             <span class="comment">%internally in this file and it makes the matching a little</span>
0234             <span class="comment">%smoother</span>
0235             geneIDs{numel(geneIDs)+1,1}=modelSBML.species(i).id;
0236             geneCompartments{numel(geneCompartments)+1,1}=regexprep(modelSBML.species(i).compartment,<span class="string">'^C_'</span>,<span class="string">''</span>);
0237             
0238             <span class="comment">%Get Miriam structure</span>
0239             <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'annotation'</span>)
0240                 <span class="comment">%Get Miriam info</span>
0241                 geneMiriam=<a href="#_sub4" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.species(i).annotation);
0242                 geneMiriams{numel(geneMiriams)+1,1}=geneMiriam;
0243             <span class="keyword">else</span>
0244                 geneMiriams{numel(geneMiriams)+1,1}=[];
0245             <span class="keyword">end</span>
0246             
0247             <span class="comment">%Protein short names (for example ERG10) are saved as SHORT</span>
0248             <span class="comment">%NAME: NAME in the notes-section of metabolites for SBML Level</span>
0249             <span class="comment">%2 and as PROTEIN_ASSOCIATION for each reaction in SBML Level 2</span>
0250             <span class="comment">%COBRA Toolbox format. For now only the SHORT NAME is loaded</span>
0251             <span class="comment">%and no mapping takes place</span>
0252             <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'notes'</span>)
0253                 geneShortNames{numel(geneShortNames)+1,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'SHORT NAME'</span>);
0254             <span class="keyword">else</span>
0255                 geneShortNames{numel(geneShortNames)+1,1}=<span class="string">''</span>;
0256             <span class="keyword">end</span>
0257             
0258             <span class="comment">%Get SBO term</span>
0259             <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'sboTerm'</span>) &amp;&amp; ~(modelSBML.species(i).sboTerm==-1)
0260                 geneSBOs(end+1,1) = modelSBML.species(i).sboTerm;
0261             <span class="keyword">end</span>
0262         <span class="keyword">elseif</span> length(modelSBML.species(i).id)&gt;=2 &amp;&amp; strcmpi(modelSBML.species(i).id(1:3),<span class="string">'Cx_'</span>)
0263             <span class="comment">%If it's a complex keep the ID and name</span>
0264             complexIDs=[complexIDs;modelSBML.species(i).id];
0265             complexNames=[complexNames;modelSBML.species(i).name];
0266         <span class="keyword">else</span>
0267             <span class="comment">%If it is not gene or complex, then it must be a metabolite</span>
0268             metaboliteNames{numel(metaboliteNames)+1,1}=modelSBML.species(i).name;
0269             metaboliteIDs{numel(metaboliteIDs)+1,1}=regexprep(modelSBML.species(i).id,<span class="string">'^M_'</span>,<span class="string">''</span>);
0270             metaboliteCompartments{numel(metaboliteCompartments)+1,1}=regexprep(modelSBML.species(i).compartment,<span class="string">'^C_'</span>,<span class="string">''</span>);
0271             metaboliteUnconstrained(numel(metaboliteUnconstrained)+1,1)=modelSBML.species(i).boundaryCondition;
0272             
0273             <span class="comment">%For each metabolite retrieve the formula and the InChI code if</span>
0274             <span class="comment">%available First add the InChI code and the formula from the</span>
0275             <span class="comment">%InChI. This allows for overwriting the formula by setting the</span>
0276             <span class="comment">%actual formula field</span>
0277             <span class="keyword">if</span> ~isempty(modelSBML.species(i).annotation)
0278                 <span class="comment">%Get the formula if available</span>
0279                 startString=<span class="string">'&gt;InChI='</span>;
0280                 endString=<span class="string">'&lt;/in:inchi&gt;'</span>;
0281                 formStart=strfind(modelSBML.species(i).annotation,startString);
0282                 <span class="keyword">if</span> isempty(formStart)
0283                     startString=<span class="string">'InChI='</span>;
0284                     endString=<span class="string">'&quot;/&gt;'</span>;
0285                 <span class="keyword">end</span>
0286                 formStart=strfind(modelSBML.species(i).annotation,startString);
0287                 <span class="keyword">if</span> ~isempty(formStart)
0288                     formEnd=strfind(modelSBML.species(i).annotation,endString);
0289                     formEndIndex=find(formEnd&gt;formStart, 1 );
0290                     formula=modelSBML.species(i).annotation(formStart+numel(startString):formEnd(formEndIndex)-1);
0291                     metaboliteInChI{numel(metaboliteInChI)+1,1}=formula;
0292                     
0293                     <span class="comment">%The composition is most often present between the</span>
0294                     <span class="comment">%first and second &quot;/&quot; in the model. In some simple</span>
0295                     <span class="comment">%molecules, such as salts, there is no second &quot;/&quot;. The</span>
0296                     <span class="comment">%formula is then assumed to be to the end of the string</span>
0297                     compositionIndexes=strfind(formula,<span class="string">'/'</span>);
0298                     <span class="keyword">if</span> numel(compositionIndexes)&gt;1
0299                         metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="keyword">...</span>
0300                             formula(compositionIndexes(1)+1:compositionIndexes(2)-1);
0301                     <span class="keyword">else</span>
0302                         <span class="keyword">if</span> numel(compositionIndexes)==1
0303                             <span class="comment">%Probably a simple molecule which can have only</span>
0304                             <span class="comment">%one conformation</span>
0305                             metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="keyword">...</span>
0306                                 formula(compositionIndexes(1)+1:numel(formula));
0307                         <span class="keyword">else</span>
0308                             metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0309                         <span class="keyword">end</span>
0310                     <span class="keyword">end</span>
0311                 <span class="keyword">elseif</span> isfield(modelSBML.species(i),<span class="string">'fbc_chemicalFormula'</span>)
0312                     metaboliteInChI{numel(metaboliteInChI)+1,1}=<span class="string">''</span>;
0313                     <span class="keyword">if</span> ~isempty(modelSBML.species(i).fbc_chemicalFormula)
0314                         <span class="comment">%Cannot extract InChi from formula, so remains</span>
0315                         <span class="comment">%empty</span>
0316                         metaboliteFormula{numel(metaboliteFormula)+1,1}=modelSBML.species(i).fbc_chemicalFormula;
0317                     <span class="keyword">else</span>
0318                         metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0319                     <span class="keyword">end</span>
0320                 <span class="keyword">else</span>
0321                     metaboliteInChI{numel(metaboliteInChI)+1,1}=<span class="string">''</span>;
0322                     metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0323                 <span class="keyword">end</span>
0324                 
0325                 <span class="comment">%Get Miriam info</span>
0326                 metMiriam=<a href="#_sub4" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.species(i).annotation);
0327                 metaboliteMiriams{numel(metaboliteMiriams)+1,1}=metMiriam;
0328             <span class="keyword">else</span>
0329                 metaboliteInChI{numel(metaboliteInChI)+1,1}=<span class="string">''</span>;
0330                 <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'notes'</span>)
0331                     metaboliteFormula{numel(metaboliteFormula)+1,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'FORMULA'</span>);
0332                 <span class="keyword">else</span>
0333                     metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0334                 <span class="keyword">end</span>
0335                 metaboliteMiriams{numel(metaboliteMiriams)+1,1}=[];
0336             <span class="keyword">end</span>
0337             <span class="keyword">if</span> ~isempty(modelSBML.species(i).notes)
0338                 <span class="keyword">if</span> ~isfield(modelSBML.species(i),<span class="string">'annotation'</span>)
0339                     metaboliteFormula{numel(metaboliteFormula)+1,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'FORMULA'</span>);
0340                 <span class="keyword">end</span>
0341             <span class="keyword">elseif</span> ~isfield(modelSBML.species(i),<span class="string">'annotation'</span>)
0342                 metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0343             <span class="keyword">end</span>
0344             <span class="comment">%Get SBO term</span>
0345             <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'sboTerm'</span>) &amp;&amp; ~(modelSBML.species(i).sboTerm==-1)
0346                 metSBOs(end+1,1) = modelSBML.species(i).sboTerm;
0347             <span class="keyword">end</span>
0348         <span class="keyword">end</span>
0349         
0350     <span class="keyword">elseif</span> isSBML2COBRA
0351         <span class="comment">%The metabolite names are assumed to be M_NAME_COMPOSITION or</span>
0352         <span class="comment">%_NAME_COMPOSITION or NAME_COMPOSITION or NAME. Regular expressions</span>
0353         <span class="comment">%are used that only NAME_COMPOSITION or NAME would be possible</span>
0354         
0355         modelSBML.species(i).name=regexprep(modelSBML.species(i).name,<span class="string">'^M_'</span>,<span class="string">''</span>);
0356         modelSBML.species(i).name=regexprep(modelSBML.species(i).name,<span class="string">'^_'</span>,<span class="string">''</span>);
0357         underscoreIndex=strfind(modelSBML.species(i).name,<span class="string">'_'</span>);
0358         
0359         metaboliteNames{numel(metaboliteNames)+1,1}=modelSBML.species(i).name;
0360         
0361         metaboliteIDs{numel(metaboliteIDs)+1,1}=regexprep(modelSBML.species(i).id,<span class="string">'^M_'</span>,<span class="string">''</span>);
0362         metaboliteCompartments{numel(metaboliteCompartments)+1,1}=regexprep(modelSBML.species(i).compartment,<span class="string">'^C_'</span>,<span class="string">''</span>);
0363         
0364         <span class="comment">%I think that COBRA doesn't set the boundary condition, but rather</span>
0365         <span class="comment">%uses name_b. Check for either</span>
0366         metaboliteUnconstrained(numel(metaboliteUnconstrained)+1,1)=modelSBML.species(i).boundaryCondition;
0367         <span class="keyword">if</span> strcmp(metaboliteIDs{end}(max(end-1,1):end),<span class="string">'_b'</span>)
0368             metaboliteUnconstrained(end)=1;
0369         <span class="keyword">end</span>
0370         
0371         <span class="comment">%Get the formula</span>
0372         <span class="keyword">if</span> max(underscoreIndex)&lt;length(modelSBML.species(i).name)
0373             metaboliteFormula{numel(metaboliteFormula)+1,1}=modelSBML.species(i).name(max(underscoreIndex)+1:length(modelSBML.species(i).name));
0374         <span class="keyword">else</span>
0375             metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0376         <span class="keyword">end</span>
0377         
0378         <span class="comment">%The old COBRA version sometimes has composition information in the</span>
0379         <span class="comment">%notes instead</span>
0380         <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'notes'</span>) &amp;&amp; ~isempty(<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'FORMULA'</span>))
0381             metaboliteFormula{numel(metaboliteFormula)+1,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'FORMULA'</span>);
0382         <span class="keyword">end</span>
0383         
0384         <span class="comment">%Get Miriam info</span>
0385         <span class="keyword">if</span> ~isempty(modelSBML.species(i).annotation)
0386             metMiriam=<a href="#_sub4" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.species(i).annotation);    
0387         <span class="keyword">else</span>
0388             metMiriam=[];
0389         <span class="keyword">end</span>
0390         metaboliteMiriams{numel(metaboliteMiriams)+1,1}=metMiriam;
0391         
0392         <span class="comment">%Get SBO term</span>
0393         <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'sboTerm'</span>) &amp;&amp; ~(modelSBML.species(i).sboTerm==-1)
0394             metSBOs(end+1,1) = modelSBML.species(i).sboTerm;
0395         <span class="keyword">end</span>
0396     <span class="keyword">end</span>
0397     <span class="comment">%The following lines are executed regardless isSBML2COBRA setting</span>
0398     <span class="keyword">if</span> isempty(modelSBML.species(i).id) || ~strcmpi(modelSBML.species(i).id(1:2),<span class="string">'E_'</span>)
0399         <span class="keyword">if</span> isempty(modelSBML.species(i).id) || ~strcmpi(modelSBML.species(i).id(1:3),<span class="string">'Cx_'</span>)
0400             <span class="comment">%Remove trailing [compartment] from metabolite name if present</span>
0401             metaboliteNames{<span class="keyword">end</span>,1}=regexprep(metaboliteNames{<span class="keyword">end</span>,1},regexCompNames,<span class="string">''</span>);
0402             metaboliteNames{<span class="keyword">end</span>,1}=regexprep(metaboliteNames{<span class="keyword">end</span>,1},<span class="string">'^M_'</span>,<span class="string">''</span>);
0403             <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'fbc_charge'</span>)
0404                 <span class="keyword">if</span> ~isempty(modelSBML.species(i).fbc_charge) &amp;&amp; modelSBML.species(i).isSetfbc_charge
0405                     metaboliteCharges(numel(metaboliteCharges)+1,1)=double(modelSBML.species(i).fbc_charge);
0406                 <span class="keyword">else</span>
0407                     <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'notes'</span>)
0408                         <span class="keyword">if</span> strfind(modelSBML.species(i).notes,<span class="string">'CHARGE'</span>)
0409                             metaboliteCharges(numel(metaboliteCharges)+1,1)=str2double(<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'CHARGE'</span>));
0410                         <span class="keyword">else</span>
0411                             metaboliteCharges(numel(metaboliteCharges)+1,1)=NaN;
0412                         <span class="keyword">end</span>
0413                     <span class="keyword">else</span>
0414                         metaboliteCharges(numel(metaboliteCharges)+1,1)=NaN;
0415                     <span class="keyword">end</span>
0416                 <span class="keyword">end</span>
0417             <span class="keyword">elseif</span> isfield(modelSBML.species(i),<span class="string">'notes'</span>)
0418                 <span class="keyword">if</span> strfind(modelSBML.species(i).notes,<span class="string">'CHARGE'</span>)
0419                     metaboliteCharges(numel(metaboliteCharges)+1,1)=str2double(<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.species(i).notes,<span class="string">'CHARGE'</span>));
0420                 <span class="keyword">else</span>
0421                     metaboliteCharges(numel(metaboliteCharges)+1,1)=NaN;
0422                 <span class="keyword">end</span>
0423             <span class="keyword">else</span>
0424                 metaboliteCharges(numel(metaboliteCharges)+1,1)=NaN;
0425             <span class="keyword">end</span>
0426             <span class="comment">%Additional information from FBC format Chemical formula</span>
0427             <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'fbc_chemicalFormula'</span>)
0428                 <span class="keyword">if</span> ~isempty(modelSBML.species(i).fbc_chemicalFormula)
0429                     metaboliteFormula{numel(metaboliteFormula),1}=modelSBML.species(i).fbc_chemicalFormula;
0430                 <span class="keyword">end</span>
0431             <span class="keyword">end</span>
0432         <span class="keyword">end</span>
0433     <span class="keyword">end</span>
0434 <span class="keyword">end</span>
0435 
0436 <span class="comment">%Add SBO terms to gene and metabolite miriam fields</span>
0437 <span class="keyword">if</span> numel(unique(geneSBOs)) &gt; 1  <span class="comment">% don't add if they're all identical</span>
0438     <span class="keyword">for</span> i = 1:numel(geneNames)
0439         geneMiriams{i} = <a href="#_sub5" class="code" title="subfunction miriam = addSBOtoMiriam(miriam,sboTerm)">addSBOtoMiriam</a>(geneMiriams{i},geneSBOs(i));
0440     <span class="keyword">end</span>
0441 <span class="keyword">end</span>
0442 <span class="keyword">if</span> numel(unique(metSBOs)) &gt; 1
0443     <span class="keyword">for</span> i = 1:numel(metaboliteNames)
0444         metaboliteMiriams{i} = <a href="#_sub5" class="code" title="subfunction miriam = addSBOtoMiriam(miriam,sboTerm)">addSBOtoMiriam</a>(metaboliteMiriams{i},metSBOs(i));
0445     <span class="keyword">end</span>
0446 <span class="keyword">end</span>
0447 
0448 <span class="comment">%Retrieve info on reactions</span>
0449 reactionNames=cell(numel(modelSBML.reaction),1);
0450 reactionIDs=cell(numel(modelSBML.reaction),1);
0451 subsystems=cell(numel(modelSBML.reaction),1);
0452 eccodes=cell(numel(modelSBML.reaction),1);
0453 eccodes(:,:)=cellstr(<span class="string">''</span>);
0454 rxnconfidencescores=NaN(numel(modelSBML.reaction),1);
0455 rxnreferences=cell(numel(modelSBML.reaction),1);
0456 rxnreferences(:,:)=cellstr(<span class="string">''</span>);
0457 rxnnotes=cell(numel(modelSBML.reaction),1);
0458 rxnnotes(:,:)=cellstr(<span class="string">''</span>);
0459 grRules=cell(numel(modelSBML.reaction),1);
0460 grRules(:,:)=cellstr(<span class="string">''</span>);
0461 grRulesFromModifier=grRules;
0462 rxnComps=zeros(numel(modelSBML.reaction),1);
0463 rxnMiriams=cell(numel(modelSBML.reaction),1);
0464 reactionReversibility=zeros(numel(modelSBML.reaction),1);
0465 reactionUB=zeros(numel(modelSBML.reaction),1);
0466 reactionLB=zeros(numel(modelSBML.reaction),1);
0467 reactionObjective=zeros(numel(modelSBML.reaction),1);
0468 
0469 <span class="comment">%Construct the stoichiometric matrix while the reaction info is read</span>
0470 S=zeros(numel(metaboliteIDs),numel(modelSBML.reaction));
0471 
0472 counter=0;
0473 <span class="comment">%If FBC, then bounds have parameter ids defined for the whole model</span>
0474 <span class="keyword">if</span> isfield(modelSBML,<span class="string">'parameter'</span>)
0475     parameter.name=cell(numel(modelSBML.parameter),1);
0476     parameter.name={modelSBML.parameter(:).id}';
0477     parameter.value={modelSBML.parameter(:).value}';
0478 <span class="keyword">end</span>
0479 
0480 <span class="keyword">if</span> isfield(modelSBML.reaction,<span class="string">'sboTerm'</span>) &amp;&amp; numel(unique([modelSBML.reaction.sboTerm])) == 1
0481     <span class="comment">%If all the SBO terms are identical, don't add them to rxnMiriams</span>
0482     modelSBML.reaction = rmfield(modelSBML.reaction,<span class="string">'sboTerm'</span>);
0483 <span class="keyword">end</span>
0484 
0485 <span class="keyword">for</span> i=1:numel(modelSBML.reaction)
0486     
0487     <span class="comment">%Check that the reaction doesn't produce a complex and nothing else. If</span>
0488     <span class="comment">%so, then jump to the next reaction. This is because I get the genes</span>
0489     <span class="comment">%for complexes from the names and not from the reactions that create</span>
0490     <span class="comment">%them. This only applies to the non-COBRA format</span>
0491     <span class="keyword">if</span> numel(modelSBML.reaction(i).product)==1
0492         <span class="keyword">if</span> length(modelSBML.reaction(i).product(1).species)&gt;=3
0493             <span class="keyword">if</span> strcmp(modelSBML.reaction(i).product(1).species(1:3),<span class="string">'Cx_'</span>)==true
0494                 <span class="keyword">continue</span>;
0495             <span class="keyword">end</span>
0496         <span class="keyword">end</span>
0497     <span class="keyword">end</span>
0498     
0499     <span class="comment">%It didn't look like a gene complex-forming reaction</span>
0500     counter=counter+1;
0501     
0502     reactionNames{counter}=modelSBML.reaction(i).name;
0503     
0504     reactionIDs{counter}=modelSBML.reaction(i).id;
0505     reactionReversibility(counter)=modelSBML.reaction(i).reversible;
0506     
0507     <span class="comment">%If model is FBC, first get parameter of bound and then replace it with</span>
0508     <span class="comment">%the correct value. Probably faster with replace(), but this was only</span>
0509     <span class="comment">%introduced in Matlab R2016b</span>
0510     <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'fbc_lowerFluxBound'</span>)
0511         lb=modelSBML.reaction(i).fbc_lowerFluxBound;
0512         ub=modelSBML.reaction(i).fbc_upperFluxBound;
0513         <span class="keyword">for</span> n=1:numel(parameter.value)
0514             lb=regexprep(lb,parameter.name(n),num2str(parameter.value{n}));
0515             ub=regexprep(ub,parameter.name(n),num2str(parameter.value{n}));
0516         <span class="keyword">end</span>
0517         <span class="keyword">if</span> isempty(lb)
0518             lb=<span class="string">'-Inf'</span>;
0519         <span class="keyword">end</span>
0520         <span class="keyword">if</span> isempty(ub)
0521             ub=<span class="string">'Inf'</span>;
0522         <span class="keyword">end</span>
0523         reactionLB(counter)=str2num(lb);
0524         reactionUB(counter)=str2num(ub);
0525         <span class="comment">%The order of these parameters should not be hard coded</span>
0526     <span class="keyword">elseif</span> isfield(modelSBML.reaction(i).kineticLaw,<span class="string">'parameter'</span>)
0527         reactionLB(counter)=modelSBML.reaction(i).kineticLaw.parameter(1).value;
0528         reactionUB(counter)=modelSBML.reaction(i).kineticLaw.parameter(2).value;
0529         reactionObjective(counter)=modelSBML.reaction(i).kineticLaw.parameter(3).value;
0530     <span class="keyword">else</span>
0531         <span class="keyword">if</span> reactionReversibility(counter)==true
0532             reactionLB(counter)=-inf;
0533         <span class="keyword">else</span>
0534             reactionLB(counter)=0;
0535         <span class="keyword">end</span>
0536         reactionUB(counter)=inf;
0537         reactionObjective(counter)=0;
0538     <span class="keyword">end</span>
0539     
0540     <span class="comment">%Find the associated gene if available</span>
0541     <span class="comment">%If FBC, get gene association data from corresponding fields</span>
0542     <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'fbc_geneProductAssociation'</span>)
0543         <span class="keyword">if</span> ~isempty(modelSBML.reaction(i).fbc_geneProductAssociation) &amp;&amp; ~isempty(modelSBML.reaction(i).fbc_geneProductAssociation.fbc_association)
0544             grRules{counter}=modelSBML.reaction(i).fbc_geneProductAssociation.fbc_association.fbc_association;
0545         <span class="keyword">end</span>
0546     <span class="keyword">elseif</span> isfield(modelSBML.reaction(i),<span class="string">'notes'</span>)
0547         <span class="comment">%This section was previously executed only if isSBML2COBRA is true. Now</span>
0548         <span class="comment">%it will be executed, if 'GENE_ASSOCIATION' is found in</span>
0549         <span class="comment">%modelSBML.reaction(i).notes</span>
0550         <span class="keyword">if</span> strfind(modelSBML.reaction(i).notes,<span class="string">'GENE_ASSOCIATION'</span>)
0551             geneAssociation=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'GENE_ASSOCIATION'</span>);
0552         <span class="keyword">elseif</span> strfind(modelSBML.reaction(i).notes,<span class="string">'GENE ASSOCIATION'</span>)
0553             geneAssociation=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'GENE ASSOCIATION'</span>);
0554         <span class="keyword">else</span>
0555             geneAssociation=<span class="string">''</span>;
0556         <span class="keyword">end</span>
0557         <span class="keyword">if</span> ~isempty(geneAssociation)
0558             <span class="comment">%This adds the grRules. The gene list and rxnGeneMat are created</span>
0559             <span class="comment">%later</span>
0560             grRules{counter}=geneAssociation;
0561         <span class="keyword">end</span>
0562     <span class="keyword">end</span>
0563     <span class="keyword">if</span> isempty(grRules{counter}) &amp;&amp; ~isempty(modelSBML.reaction(i).modifier)
0564         rules=<span class="string">''</span>;
0565         <span class="keyword">for</span> j=1:numel(modelSBML.reaction(i).modifier)
0566             modifier=modelSBML.reaction(i).modifier(j).species;
0567             <span class="keyword">if</span> ~isempty(modifier)
0568                 <span class="keyword">if</span> strcmpi(modifier(1:2),<span class="string">'E_'</span>)
0569                     index=find(strcmp(modifier,geneIDs));
0570                     <span class="comment">%This should be unique and in the geneIDs list,</span>
0571                     <span class="comment">%otherwise something is wrong</span>
0572                     <span class="keyword">if</span> numel(index)~=1
0573                         EM=[<span class="string">'Could not get the gene association data from reaction '</span> reactionIDs{i}];
0574                         dispEM(EM);
0575                     <span class="keyword">end</span>
0576                     <span class="keyword">if</span> ~isempty(rules)
0577                         rules=[rules <span class="string">' or ('</span> geneNames{index} <span class="string">')'</span>];
0578                     <span class="keyword">else</span>
0579                         rules=[<span class="string">'('</span> geneNames{index} <span class="string">')'</span>];
0580                     <span class="keyword">end</span>
0581                 <span class="keyword">elseif</span> strcmp(modifier(1:2),<span class="string">'s_'</span>)
0582                     index=find(strcmp(modifier,metaboliteIDs));
0583                     <span class="comment">%This should be unique and in the geneIDs list,</span>
0584                     <span class="comment">%otherwise something is wrong</span>
0585                     <span class="keyword">if</span> numel(index)~=1
0586                         EM=[<span class="string">'Could not get the gene association data from reaction '</span> reactionIDs{i}];
0587                         dispEM(EM);
0588                     <span class="keyword">end</span>
0589                     <span class="keyword">if</span> ~isempty(rules)
0590                         rules=[rules <span class="string">' or ('</span> metaboliteIDs{index} <span class="string">')'</span>];
0591                     <span class="keyword">else</span>
0592                         rules=[<span class="string">'('</span> metaboliteIDs{index} <span class="string">')'</span>];
0593                     <span class="keyword">end</span>
0594                 <span class="keyword">else</span>
0595                     <span class="comment">%It seems to be a complex. Add the corresponding</span>
0596                     <span class="comment">%genes from the name of the complex (not the</span>
0597                     <span class="comment">%reaction that creates it)</span>
0598                     index=find(strcmp(modifier,complexIDs));
0599                     <span class="keyword">if</span> numel(index)==1
0600                         <span class="keyword">if</span> ~isempty(rules)
0601                             rules=[rules <span class="string">' or ('</span> strrep(complexNames{index},<span class="string">':'</span>,<span class="string">' and '</span>) <span class="string">')'</span>];
0602                         <span class="keyword">else</span>
0603                             rules=[<span class="string">'('</span> strrep(complexNames{index},<span class="string">':'</span>,<span class="string">' and '</span>) <span class="string">')'</span>];
0604                         <span class="keyword">end</span>
0605                     <span class="keyword">else</span>
0606                         <span class="comment">%Could not find a complex</span>
0607                         EM=[<span class="string">'Could not get the gene association data from reaction '</span> reactionIDs{i}];
0608                         dispEM(EM);
0609                     <span class="keyword">end</span>
0610                 <span class="keyword">end</span>
0611             <span class="keyword">end</span>
0612         <span class="keyword">end</span>
0613         grRules{counter}=rules;
0614         grRulesFromModifier{counter}=rules;<span class="comment">%Backup copy for grRules, useful to parse Yeast 7.6</span>
0615     <span class="keyword">end</span>
0616     
0617     <span class="comment">%Add reaction compartment</span>
0618     <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'compartment'</span>)
0619         <span class="keyword">if</span> ~isempty(modelSBML.reaction(i).compartment)
0620             rxnComp=modelSBML.reaction(i).compartment;
0621         <span class="keyword">else</span>
0622             rxnComp=<span class="string">''</span>;
0623         <span class="keyword">end</span>
0624     <span class="keyword">elseif</span> isfield(modelSBML.reaction(i),<span class="string">'notes'</span>)
0625         rxnComp=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'COMPARTMENT'</span>);
0626     <span class="keyword">end</span>
0627     <span class="keyword">if</span> ~isempty(rxnComp)
0628         <span class="comment">%Find it in the compartment list</span>
0629         [~, J]=ismember(rxnComp,compartmentIDs);
0630         rxnComps(counter)=J;
0631     <span class="keyword">end</span>
0632     
0633     <span class="comment">%Get other Miriam fields. This may include for example database indexes</span>
0634     <span class="comment">%to organism-specific databases. EC-codes are supported by the COBRA</span>
0635     <span class="comment">%Toolbox format and are therefore loaded separately</span>
0636     <span class="keyword">if</span> isSBML2COBRA==false
0637         miriamStruct=<a href="#_sub4" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.reaction(i).annotation);
0638         rxnMiriams{counter}=miriamStruct;
0639         <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'notes'</span>)
0640             subsystems{counter,1}=cellstr(<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'SUBSYSTEM'</span>));
0641             subsystems{counter,1}(cellfun(<span class="string">'isempty'</span>,subsystems{counter,1})) = [];
0642             <span class="keyword">if</span> strfind(modelSBML.reaction(i).notes,<span class="string">'Confidence Level'</span>)
0643                 confScore = <a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'Confidence Level'</span>);
0644                 <span class="keyword">if</span> isempty(confScore)
0645                     confScore = 0;
0646                 <span class="keyword">end</span>
0647                 rxnconfidencescores(counter)=str2double(confScore);
0648             <span class="keyword">end</span>
0649             rxnreferences{counter,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'AUTHORS'</span>);
0650             rxnnotes{counter,1}=<a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'NOTES'</span>);
0651         <span class="keyword">end</span>
0652     <span class="keyword">end</span>
0653     
0654     <span class="comment">%Get SBO terms</span>
0655     <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'sboTerm'</span>) &amp;&amp; ~(modelSBML.reaction(i).sboTerm==-1)
0656         rxnMiriams{counter} = <a href="#_sub5" class="code" title="subfunction miriam = addSBOtoMiriam(miriam,sboTerm)">addSBOtoMiriam</a>(rxnMiriams{counter}, modelSBML.reaction(i).sboTerm);
0657     <span class="keyword">end</span>
0658     
0659     <span class="comment">%Get ec-codes</span>
0660     eccode=<span class="string">''</span>;
0661     <span class="keyword">if</span> ~isempty(modelSBML.reaction(i).annotation)
0662         <span class="keyword">if</span> strfind(modelSBML.reaction(i).annotation,<span class="string">'urn:miriam:ec-code'</span>)
0663             eccode=<a href="#_sub3" class="code" title="subfunction fieldContent=parseAnnotation(searchString,startString,midString,fieldName)">parseAnnotation</a>(modelSBML.reaction(i).annotation,<span class="string">'urn:miriam:'</span>,<span class="string">':'</span>,<span class="string">'ec-code'</span>);
0664         <span class="keyword">elseif</span> strfind(modelSBML.reaction(i).annotation,<span class="string">'http://identifiers.org/ec-code'</span>)
0665             eccode=<a href="#_sub3" class="code" title="subfunction fieldContent=parseAnnotation(searchString,startString,midString,fieldName)">parseAnnotation</a>(modelSBML.reaction(i).annotation,<span class="string">'http://identifiers.org/'</span>,<span class="string">'/'</span>,<span class="string">'ec-code'</span>);
0666         <span class="keyword">elseif</span> strfind(modelSBML.reaction(i).annotation,<span class="string">'https://identifiers.org/ec-code'</span>)
0667             eccode=<a href="#_sub3" class="code" title="subfunction fieldContent=parseAnnotation(searchString,startString,midString,fieldName)">parseAnnotation</a>(modelSBML.reaction(i).annotation,<span class="string">'https://identifiers.org/'</span>,<span class="string">'/'</span>,<span class="string">'ec-code'</span>);
0668         <span class="keyword">end</span>
0669     <span class="keyword">elseif</span> isfield(modelSBML.reaction(i),<span class="string">'notes'</span>)
0670         <span class="keyword">if</span> strfind(modelSBML.reaction(i).notes,<span class="string">'EC Number'</span>)
0671             eccode=[eccode <a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'EC Number'</span>)];
0672         <span class="keyword">elseif</span> strfind(modelSBML.reaction(i).notes,<span class="string">'PROTEIN_CLASS'</span>)
0673             eccode=[eccode <a href="#_sub2" class="code" title="subfunction fieldContent=parseNote(searchString,fieldName)">parseNote</a>(modelSBML.reaction(i).notes,<span class="string">'PROTEIN_CLASS'</span>)];
0674         <span class="keyword">end</span>
0675     <span class="keyword">end</span>
0676     eccodes{counter}=eccode;
0677     
0678     <span class="comment">%Add all reactants</span>
0679     <span class="keyword">for</span> j=1:numel(modelSBML.reaction(i).reactant)
0680         <span class="comment">%Get the index of the metabolite in metaboliteIDs. External</span>
0681         <span class="comment">%metabolites will be removed at a later stage</span>
0682         metIndex=find(strcmp(modelSBML.reaction(i).reactant(j).species,metaboliteIDs),1);
0683         <span class="keyword">if</span> isempty(metIndex)
0684             EM=[<span class="string">'Could not find metabolite '</span> modelSBML.reaction(i).reactant(j).species <span class="string">' in reaction '</span> reactionIDs{counter}];
0685             dispEM(EM);
0686         <span class="keyword">end</span>
0687         S(metIndex,counter)=S(metIndex,counter)+modelSBML.reaction(i).reactant(j).stoichiometry*-1;
0688     <span class="keyword">end</span>
0689     
0690     <span class="comment">%Add all products</span>
0691     <span class="keyword">for</span> j=1:numel(modelSBML.reaction(i).product)
0692         <span class="comment">%Get the index of the metabolite in metaboliteIDs.</span>
0693         metIndex=find(strcmp(modelSBML.reaction(i).product(j).species,metaboliteIDs),1);
0694         <span class="keyword">if</span> isempty(metIndex)
0695             EM=[<span class="string">'Could not find metabolite '</span> modelSBML.reaction(i).product(j).species <span class="string">' in reaction '</span> reactionIDs{counter}];
0696             dispEM(EM);
0697         <span class="keyword">end</span>
0698         S(metIndex,counter)=S(metIndex,counter)+modelSBML.reaction(i).product(j).stoichiometry;
0699     <span class="keyword">end</span>
0700 <span class="keyword">end</span>
0701 
0702 <span class="comment">%if FBC, objective function is separately defined. Multiple objective</span>
0703 <span class="comment">%functions can be defined, one is set as active</span>
0704 <span class="keyword">if</span> isfield(modelSBML, <span class="string">'fbc_activeObjective'</span>)
0705     obj=modelSBML.fbc_activeObjective;
0706     <span class="keyword">for</span> i=1:numel(modelSBML.fbc_objective)
0707         <span class="keyword">if</span> strcmp(obj,modelSBML.fbc_objective(i).fbc_id)
0708             <span class="keyword">if</span> ~isempty(modelSBML.fbc_objective(i).fbc_fluxObjective)
0709                 rxn=modelSBML.fbc_objective(i).fbc_fluxObjective.fbc_reaction;
0710                 rxn=regexprep(rxn,<span class="string">'^R_'</span>,<span class="string">''</span>);
0711                 idx=find(ismember(reactionIDs,rxn));
0712                 reactionObjective(idx)=modelSBML.fbc_objective(i).fbc_fluxObjective.fbc_coefficient;
0713             <span class="keyword">end</span>
0714         <span class="keyword">end</span>
0715     <span class="keyword">end</span>
0716 <span class="keyword">end</span>
0717 
0718 <span class="comment">%subSystems can be stored as groups instead of in annotations</span>
0719 <span class="keyword">if</span> isfield(modelSBML,<span class="string">'groups_group'</span>)
0720     <span class="keyword">for</span> i=1:numel(modelSBML.groups_group)
0721         groupreactions={modelSBML.groups_group(i).groups_member(:).groups_idRef};
0722         groupreactions=regexprep(groupreactions,<span class="string">'^R_'</span>,<span class="string">''</span>);
0723         [~, idx] = ismember(groupreactions, reactionIDs);
0724         <span class="keyword">if</span> any(idx)
0725             <span class="keyword">for</span> j=1:numel(idx)
0726                 <span class="keyword">if</span> isempty(subsystems{idx(j)}) <span class="comment">% First subsystem</span>
0727                     subsystems{idx(j)} = {modelSBML.groups_group(i).groups_name};
0728                 <span class="keyword">else</span> <span class="comment">% Consecutive subsystems: concatenate</span>
0729                     subsystems{idx(j)} = horzcat(subsystems{idx(j)}, modelSBML.groups_group(i).groups_name);
0730                 <span class="keyword">end</span>
0731             <span class="keyword">end</span>
0732         <span class="keyword">end</span>
0733     <span class="keyword">end</span>
0734 <span class="keyword">end</span>
0735 
0736 <span class="comment">%Shrink the structures if complex-forming reactions had to be skipped</span>
0737 reactionNames=reactionNames(1:counter);
0738 reactionIDs=reactionIDs(1:counter);
0739 subsystems=subsystems(1:counter);
0740 eccodes=eccodes(1:counter);
0741 rxnconfidencescores=rxnconfidencescores(1:counter);
0742 rxnreferences=rxnreferences(1:counter);
0743 rxnnotes=rxnnotes(1:counter);
0744 grRules=grRules(1:counter);
0745 rxnMiriams=rxnMiriams(1:counter);
0746 reactionReversibility=reactionReversibility(1:counter);
0747 reactionUB=reactionUB(1:counter);
0748 reactionLB=reactionLB(1:counter);
0749 reactionObjective=reactionObjective(1:counter);
0750 S=S(:,1:counter);
0751 
0752 model.name=modelSBML.name;
0753 model.id=regexprep(modelSBML.id,<span class="string">'^M_'</span>,<span class="string">''</span>); <span class="comment">% COBRA adds M_ prefix</span>
0754 model.rxns=reactionIDs;
0755 model.mets=metaboliteIDs;
0756 model.S=sparse(S);
0757 model.lb=reactionLB;
0758 model.ub=reactionUB;
0759 model.rev=reactionReversibility;
0760 model.c=reactionObjective;
0761 model.b=zeros(numel(metaboliteIDs),1);
0762 model.comps=compartmentIDs;
0763 model.compNames=compartmentNames;
0764 model.rxnConfidenceScores=rxnconfidencescores;
0765 model.rxnReferences=rxnreferences;
0766 model.rxnNotes=rxnnotes;
0767 
0768 <span class="comment">%Load annotation if available. If there are several authors, only the first</span>
0769 <span class="comment">%author credentials are imported</span>
0770 <span class="keyword">if</span> isfield(modelSBML,<span class="string">'annotation'</span>)
0771     endString=<span class="string">'&lt;/'</span>;
0772     I=strfind(modelSBML.annotation,endString);
0773     J=strfind(modelSBML.annotation,<span class="string">'&lt;vCard:Family&gt;'</span>);
0774     <span class="keyword">if</span> any(J)
0775         model.annotation.familyName=modelSBML.annotation(J(1)+14:I(find(I&gt;J(1),1))-1);
0776     <span class="keyword">end</span>
0777     J=strfind(modelSBML.annotation,<span class="string">'&lt;vCard:Given&gt;'</span>);
0778     <span class="keyword">if</span> any(J)
0779         model.annotation.givenName=modelSBML.annotation(J(1)+13:I(find(I&gt;J(1),1))-1);
0780     <span class="keyword">end</span>
0781     J=strfind(modelSBML.annotation,<span class="string">'&lt;vCard:EMAIL&gt;'</span>);
0782     <span class="keyword">if</span> any(J)
0783         model.annotation.email=modelSBML.annotation(J(1)+13:I(find(I&gt;J(1),1))-1);
0784     <span class="keyword">end</span>
0785     J=strfind(modelSBML.annotation,<span class="string">'&lt;vCard:Orgname&gt;'</span>);
0786     <span class="keyword">if</span> any(J)
0787         model.annotation.organization=modelSBML.annotation(J(1)+15:I(find(I&gt;J(1),1))-1);
0788     <span class="keyword">end</span>
0789     endString=<span class="string">'&quot;/&gt;'</span>;
0790     I=strfind(modelSBML.annotation,endString);
0791     <span class="keyword">if</span> strfind(modelSBML.annotation,<span class="string">'&quot;urn:miriam:'</span>)
0792         J=strfind(modelSBML.annotation,<span class="string">'&quot;urn:miriam:'</span>);
0793         <span class="keyword">if</span> any(J)
0794             model.annotation.taxonomy=modelSBML.annotation(J+12:I(find(I&gt;J,1))-1);
0795         <span class="keyword">end</span>
0796     <span class="keyword">else</span>
0797         J=strfind(modelSBML.annotation,<span class="string">'&quot;http://identifiers.org/'</span>);
0798         <span class="keyword">if</span> any(J)
0799             model.annotation.taxonomy=modelSBML.annotation(J+24:I(find(I&gt;J,1))-1);
0800         <span class="keyword">else</span>
0801             J=strfind(modelSBML.annotation,<span class="string">'&quot;https://identifiers.org/'</span>);
0802             <span class="keyword">if</span> any(J)
0803                 model.annotation.taxonomy=modelSBML.annotation(J+25:I(find(I&gt;J,1))-1);
0804             <span class="keyword">end</span>
0805         <span class="keyword">end</span>
0806     <span class="keyword">end</span>
0807 <span class="keyword">end</span>
0808 <span class="keyword">if</span> isfield(modelSBML,<span class="string">'notes'</span>)
0809     startString=strfind(modelSBML.notes,<span class="string">'xhtml&quot;&gt;'</span>);
0810     endString=strfind(modelSBML.notes,<span class="string">'&lt;/body&gt;'</span>);
0811     <span class="keyword">if</span> any(startString) &amp;&amp; any(endString)
0812         model.annotation.note=modelSBML.notes(startString+7:endString-1);
0813         model.annotation.note=regexprep(model.annotation.note,<span class="string">'&lt;p&gt;|&lt;/p&gt;'</span>,<span class="string">''</span>);
0814         model.annotation.note=strtrim(model.annotation.note);
0815         <span class="keyword">if</span> regexp(model.annotation.note,<span class="string">'This file was generated using the exportModel function in RAVEN Toolbox \d\.\d and OutputSBML in libSBML'</span>)
0816             model.annotation=rmfield(model.annotation,<span class="string">'note'</span>); <span class="comment">% Default note added when running exportModel</span>
0817         <span class="keyword">end</span>
0818     <span class="keyword">end</span>
0819 <span class="keyword">end</span>
0820 
0821 <span class="keyword">if</span> any(~cellfun(@isempty,compartmentOutside))
0822     model.compOutside=compartmentOutside;
0823 <span class="keyword">end</span>
0824 
0825 model.rxnNames=reactionNames;
0826 model.metNames=metaboliteNames;
0827 
0828 <span class="comment">%Match the compartments for metabolites</span>
0829 [~, J]=ismember(metaboliteCompartments,model.comps);
0830 model.metComps=J;
0831 
0832 <span class="comment">%If any genes have been loaded (only for the new format)</span>
0833 <span class="keyword">if</span> ~isempty(geneNames)
0834     <span class="comment">%In some rare cases geneNames may not necessarily be used in grRules.</span>
0835     <span class="comment">%That is true for Yeast 7.6. It's therefore important to change gene</span>
0836     <span class="comment">%systematic names to geneIDs in sophisticated way. Gene systematic</span>
0837     <span class="comment">%names are not unique, since exactly the same name may be in different</span>
0838     <span class="comment">%compartments</span>
0839     <span class="keyword">if</span> all(cellfun(@isempty,strfind(grRules,geneNames{1})))
0840         geneShortNames=geneNames;
0841         <span class="comment">%geneShortNames contain compartments as well, so these are removed</span>
0842         geneShortNames=regexprep(geneShortNames,<span class="string">' \[.+$'</span>,<span class="string">''</span>);
0843         <span class="comment">%grRules obtained from modifier fields contain geneNames. These are</span>
0844         <span class="comment">%changed into geneIDs. grRulesFromModifier is a good way to have</span>
0845         <span class="comment">%geneIDs and rxns association when it's important to resolve</span>
0846         <span class="comment">%systematic name ambiguities</span>
0847         grRulesFromModifier=regexprep(regexprep(grRulesFromModifier,<span class="string">'\[|\]'</span>,<span class="string">'_'</span>),regexprep(geneNames,<span class="string">'\[|\]'</span>,<span class="string">'_'</span>),geneIDs);
0848         grRules=regexprep(regexprep(grRules,<span class="string">'\[|\]'</span>,<span class="string">'_'</span>),regexprep(geneNames,<span class="string">'\[|\]'</span>,<span class="string">'_'</span>),geneIDs);
0849         
0850         <span class="comment">%Yeast 7.6 contains several metabolites, which were used in gene</span>
0851         <span class="comment">%associations. For that reason, the list of species ID is created</span>
0852         <span class="comment">%and we then check whether any of them have kegg.genes annotation</span>
0853         <span class="comment">%thereby obtaining systematic gene names</span>
0854         geneShortNames=vertcat(geneShortNames,metaboliteNames);
0855         geneIDs=vertcat(geneIDs,metaboliteIDs);
0856         geneSystNames=extractMiriam(vertcat(geneMiriams,metaboliteMiriams),<span class="string">'kegg.genes'</span>);
0857         geneCompartments=vertcat(geneCompartments,metaboliteCompartments);
0858         geneMiriams=vertcat(geneMiriams,metaboliteMiriams);
0859         
0860         <span class="comment">%Now we retain information for only these entries, which have</span>
0861         <span class="comment">%kegg.genes annotation</span>
0862         geneShortNames=geneShortNames(~cellfun(<span class="string">'isempty'</span>,geneSystNames));
0863         geneIDs=geneIDs(~cellfun(<span class="string">'isempty'</span>,geneSystNames));
0864         geneSystNames=geneSystNames(~cellfun(<span class="string">'isempty'</span>,geneSystNames));
0865         geneCompartments=geneCompartments(~cellfun(<span class="string">'isempty'</span>,geneSystNames));
0866         geneMiriams=geneMiriams(~cellfun(<span class="string">'isempty'</span>,geneSystNames));
0867         <span class="comment">%Now we reorder geneIDs and geneSystNames by geneSystNames string</span>
0868         <span class="comment">%length</span>
0869         geneNames=geneIDs;<span class="comment">%Backuping geneIDs, since we need unsorted order for later</span>
0870         [~, Indx] = sort(cellfun(<span class="string">'size'</span>, geneSystNames, 2), <span class="string">'descend'</span>);
0871         geneIDs = geneIDs(Indx);
0872         geneSystNames = geneSystNames(Indx);
0873         <span class="keyword">for</span> i=1:numel(geneSystNames)
0874             <span class="keyword">for</span> j=1:numel(grRules)
0875                 <span class="keyword">if</span> strfind(grRules{j},geneSystNames{i})
0876                     <span class="keyword">if</span> ~isempty(grRules{j})
0877                         <span class="keyword">if</span> sum(ismember(geneSystNames,geneSystNames{i}))==1
0878                             grRules{j}=regexprep(grRules{j},geneSystNames{i},geneIDs{i});
0879                         <span class="keyword">elseif</span> sum(ismember(geneSystNames,geneSystNames{i}))&gt;1
0880                             counter=0;
0881                             ovrlpIDs=geneIDs(ismember(geneSystNames,geneSystNames{i}));
0882                             <span class="keyword">for</span> k=1:numel(ovrlpIDs)
0883                                 <span class="keyword">if</span> strfind(grRulesFromModifier{j},ovrlpIDs{k})
0884                                     counter=counter+1;
0885                                     grRules{j}=regexprep(grRules{j},geneSystNames{i},ovrlpIDs{k});
0886                                 <span class="keyword">end</span>
0887                                 <span class="keyword">if</span> counter&gt;1
0888                                     EM=[<span class="string">'Gene association is ambiguous for reaction '</span> modelSBML.reaction(j).id];
0889                                     dispEM(EM);
0890                                 <span class="keyword">end</span>
0891                             <span class="keyword">end</span>
0892                         <span class="keyword">end</span>
0893                     <span class="keyword">end</span>
0894                 <span class="keyword">end</span>
0895             <span class="keyword">end</span>
0896         <span class="keyword">end</span>
0897     <span class="keyword">end</span>
0898     model.genes=geneNames;
0899     model.grRules=grRules;
0900     [grRules,rxnGeneMat] = standardizeGrRules(model,true);
0901     model.grRules = grRules;
0902     model.rxnGeneMat = rxnGeneMat;
0903     
0904     <span class="comment">%Match the compartments for genes</span>
0905     [~, J]=ismember(geneCompartments,model.comps);
0906     model.geneComps=J;
0907 <span class="keyword">else</span>
0908     <span class="keyword">if</span> ~all(cellfun(@isempty,grRules))
0909         <span class="comment">%If fbc_geneProduct exists, follow the specified gene order, such</span>
0910         <span class="comment">%that matching geneShortNames in function below will work</span>
0911         <span class="keyword">if</span> isfield(modelSBML,<span class="string">'fbc_geneProduct'</span>)
0912             genes={modelSBML.fbc_geneProduct.fbc_id};
0913             
0914             <span class="comment">%Get gene Miriams if they were not retrieved above (this occurs</span>
0915             <span class="comment">%when genes are stored as fbc_geneProduct instead of species)</span>
0916             <span class="keyword">if</span> isempty(geneMiriams)
0917                 geneMiriams = cell(numel(genes),1);
0918                 <span class="keyword">if</span> isfield(modelSBML.fbc_geneProduct,<span class="string">'sboTerm'</span>) &amp;&amp; numel(unique([modelSBML.fbc_geneProduct.sboTerm])) == 1
0919                     <span class="comment">%If all the SBO terms are identical, don't add them to geneMiriams</span>
0920                     modelSBML.fbc_geneProduct = rmfield(modelSBML.fbc_geneProduct,<span class="string">'sboTerm'</span>);
0921                 <span class="keyword">end</span>
0922                 <span class="keyword">for</span> i = 1:numel(genes)
0923                     geneMiriams{i}=<a href="#_sub4" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.fbc_geneProduct(i).annotation);
0924                     <span class="keyword">if</span> isfield(modelSBML.fbc_geneProduct(i),<span class="string">'sboTerm'</span>) &amp;&amp; ~(modelSBML.fbc_geneProduct(i).sboTerm==-1)
0925                         geneMiriams{i} = <a href="#_sub5" class="code" title="subfunction miriam = addSBOtoMiriam(miriam,sboTerm)">addSBOtoMiriam</a>(geneMiriams{i},modelSBML.fbc_geneProduct(i).sboTerm);
0926                     <span class="keyword">end</span>
0927                 <span class="keyword">end</span>
0928             <span class="keyword">end</span>
0929             proteinNames={modelSBML.fbc_geneProduct.fbc_name};
0930         <span class="keyword">else</span>
0931             genes=<a href="#_sub1" class="code" title="subfunction matchGenes=getGeneList(grRules)">getGeneList</a>(grRules);
0932         <span class="keyword">end</span>
0933         <span class="keyword">if</span> strcmpi(genes{1}(1:2),<span class="string">'G_'</span>)
0934             genes=regexprep(genes,<span class="string">'^G_'</span>,<span class="string">''</span>);
0935             grRules=regexprep(grRules,<span class="string">'^G_'</span>,<span class="string">''</span>);
0936             grRules=regexprep(grRules,<span class="string">'\(G_'</span>,<span class="string">'('</span>);
0937             grRules=regexprep(grRules,<span class="string">' G_'</span>,<span class="string">' '</span>);
0938         <span class="keyword">end</span>
0939         model.genes=genes;
0940         model.grRules=grRules;
0941         [grRules,rxnGeneMat] = standardizeGrRules(model,true);
0942         model.grRules = grRules;
0943         model.rxnGeneMat = rxnGeneMat;
0944     <span class="keyword">end</span>
0945 <span class="keyword">end</span>
0946 
0947 <span class="keyword">if</span> all(cellfun(@isempty,geneShortNames))
0948     <span class="keyword">if</span> isfield(modelSBML,<span class="string">'fbc_geneProduct'</span>)
0949         <span class="keyword">for</span> i=1:numel(genes)
0950             <span class="keyword">if</span> ~isempty(modelSBML.fbc_geneProduct(i).fbc_label)
0951                 geneShortNames{i,1}=modelSBML.fbc_geneProduct(i).fbc_label;
0952             <span class="keyword">elseif</span> ~isempty(modelSBML.fbc_geneProduct(i).fbc_name)
0953                 geneShortNames{i,1}=modelSBML.fbc_geneProduct(i).fbc_name;
0954             <span class="keyword">else</span>
0955                 geneShortNames{i,1}=<span class="string">''</span>;
0956             <span class="keyword">end</span>
0957         <span class="keyword">end</span>
0958     <span class="keyword">end</span>
0959 <span class="keyword">end</span>
0960 
0961 <span class="comment">%If any InChIs have been loaded</span>
0962 <span class="keyword">if</span> any(~cellfun(@isempty,metaboliteInChI))
0963     model.inchis=metaboliteInChI;
0964 <span class="keyword">end</span>
0965 
0966 <span class="comment">%If any formulas have been loaded</span>
0967 <span class="keyword">if</span> any(~cellfun(@isempty,metaboliteFormula))
0968     model.metFormulas=metaboliteFormula;
0969 <span class="keyword">end</span>
0970 
0971 <span class="comment">%If any charges have been loaded</span>
0972 <span class="keyword">if</span> ~isempty(metaboliteCharges)
0973     model.metCharges=metaboliteCharges;
0974 <span class="keyword">end</span>
0975 
0976 <span class="comment">%If any gene short names have been loaded</span>
0977 <span class="keyword">if</span> any(~cellfun(@isempty,geneShortNames))
0978     model.geneShortNames=geneShortNames;
0979 <span class="keyword">end</span>
0980 
0981 <span class="comment">%If any Miriam strings for compartments have been loaded</span>
0982 <span class="keyword">if</span> any(~cellfun(@isempty,compartmentMiriams))
0983     model.compMiriams=compartmentMiriams;
0984 <span class="keyword">end</span>
0985 
0986 <span class="comment">%If any Miriam strings for metabolites have been loaded</span>
0987 <span class="keyword">if</span> any(~cellfun(@isempty,metaboliteMiriams))
0988     model.metMiriams=metaboliteMiriams;
0989 <span class="keyword">end</span>
0990 
0991 <span class="comment">%If any subsystems have been loaded</span>
0992 <span class="keyword">if</span> any(~cellfun(@isempty,subsystems))
0993     model.subSystems=subsystems;
0994 <span class="keyword">end</span>
0995 <span class="keyword">if</span> any(rxnComps)
0996     <span class="keyword">if</span> all(rxnComps)
0997         model.rxnComps=rxnComps;
0998     <span class="keyword">else</span>
0999         <span class="keyword">if</span> supressWarnings==false
1000             EM=<span class="string">'The compartments for the following reactions could not be matched. Ignoring reaction compartment information'</span>;
1001             dispEM(EM,false,model.rxns(rxnComps==0));
1002         <span class="keyword">end</span>
1003     <span class="keyword">end</span>
1004 <span class="keyword">end</span>
1005 
1006 <span class="comment">%If any ec-codes have been loaded</span>
1007 <span class="keyword">if</span> any(~cellfun(@isempty,eccodes))
1008     model.eccodes=eccodes;
1009 <span class="keyword">end</span>
1010 
1011 <span class="comment">%If any Miriam strings for reactions have been loaded</span>
1012 <span class="keyword">if</span> any(~cellfun(@isempty,rxnMiriams))
1013     model.rxnMiriams=rxnMiriams;
1014 <span class="keyword">end</span>
1015 
1016 <span class="comment">%If any Miriam strings for genes have been loaded</span>
1017 <span class="keyword">if</span> any(~cellfun(@isempty,geneMiriams))
1018     model.geneMiriams=geneMiriams;
1019 <span class="keyword">end</span>
1020 
1021 <span class="comment">%If any protein strings have been loaded</span>
1022 <span class="keyword">if</span> any(~cellfun(@isempty,proteinNames))
1023     model.proteinNames=proteinNames;
1024 <span class="keyword">end</span>
1025 
1026 model.unconstrained=metaboliteUnconstrained;
1027 
1028 <span class="comment">%Convert SBML IDs back into their original strings. Here we are using part</span>
1029 <span class="comment">%from convertSBMLID, originating from the COBRA Toolbox</span>
1030 model.rxns=regexprep(model.rxns,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
1031 model.mets=regexprep(model.mets,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
1032 model.comps=regexprep(model.comps,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
1033 model.grRules=regexprep(model.grRules,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
1034 model.genes=regexprep(model.genes,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
1035 model.id=regexprep(model.id,<span class="string">'__([0-9]+)__'</span>,<span class="string">'${char(str2num($1))}'</span>);
1036 
1037 <span class="comment">%Remove unused fields</span>
1038 <span class="keyword">if</span> isempty(model.annotation)
1039     model=rmfield(model,<span class="string">'annotation'</span>);
1040 <span class="keyword">end</span>
1041 <span class="keyword">if</span> isempty(model.compOutside)
1042     model=rmfield(model,<span class="string">'compOutside'</span>);
1043 <span class="keyword">end</span>
1044 <span class="keyword">if</span> isempty(model.compMiriams)
1045     model=rmfield(model,<span class="string">'compMiriams'</span>);
1046 <span class="keyword">end</span>
1047 <span class="keyword">if</span> isempty(model.rxnComps)
1048     model=rmfield(model,<span class="string">'rxnComps'</span>);
1049 <span class="keyword">end</span>
1050 <span class="keyword">if</span> isempty(model.grRules)
1051     model=rmfield(model,<span class="string">'grRules'</span>);
1052 <span class="keyword">end</span>
1053 <span class="keyword">if</span> isempty(model.rxnGeneMat)
1054     model=rmfield(model,<span class="string">'rxnGeneMat'</span>);
1055 <span class="keyword">end</span>
1056 <span class="keyword">if</span> isempty(model.subSystems)
1057     model=rmfield(model,<span class="string">'subSystems'</span>);
1058 <span class="keyword">else</span>
1059     model.subSystems(cellfun(@isempty,subsystems))={{<span class="string">''</span>}};
1060 <span class="keyword">end</span>
1061 <span class="keyword">if</span> isempty(model.eccodes)
1062     model=rmfield(model,<span class="string">'eccodes'</span>);
1063 <span class="keyword">end</span>
1064 <span class="keyword">if</span> isempty(model.rxnMiriams)
1065     model=rmfield(model,<span class="string">'rxnMiriams'</span>);
1066 <span class="keyword">end</span>
1067 <span class="keyword">if</span> cellfun(@isempty,model.rxnNotes)
1068     model=rmfield(model,<span class="string">'rxnNotes'</span>);
1069 <span class="keyword">end</span>
1070 <span class="keyword">if</span> cellfun(@isempty,model.rxnReferences)
1071     model=rmfield(model,<span class="string">'rxnReferences'</span>);
1072 <span class="keyword">end</span>
1073 <span class="keyword">if</span> isempty(model.rxnConfidenceScores) || all(isnan(model.rxnConfidenceScores))
1074     model=rmfield(model,<span class="string">'rxnConfidenceScores'</span>);
1075 <span class="keyword">end</span>
1076 <span class="keyword">if</span> isempty(model.genes)
1077     model=rmfield(model,<span class="string">'genes'</span>);
1078 <span class="keyword">elseif</span> isrow(model.genes)
1079     model.genes=transpose(model.genes);
1080 <span class="keyword">end</span>
1081 <span class="keyword">if</span> isempty(model.geneComps)
1082     model=rmfield(model,<span class="string">'geneComps'</span>);
1083 <span class="keyword">end</span>
1084 <span class="keyword">if</span> isempty(model.geneMiriams)
1085     model=rmfield(model,<span class="string">'geneMiriams'</span>);
1086 <span class="keyword">end</span>
1087 <span class="keyword">if</span> isempty(model.geneShortNames)
1088     model=rmfield(model,<span class="string">'geneShortNames'</span>);
1089 <span class="keyword">end</span>
1090 <span class="keyword">if</span> isempty(model.inchis)
1091     model=rmfield(model,<span class="string">'inchis'</span>);
1092 <span class="keyword">end</span>
1093 <span class="keyword">if</span> isempty(model.metFormulas)
1094     model=rmfield(model,<span class="string">'metFormulas'</span>);
1095 <span class="keyword">end</span>
1096 <span class="keyword">if</span> isempty(model.metMiriams)
1097     model=rmfield(model,<span class="string">'metMiriams'</span>);
1098 <span class="keyword">end</span>
1099 <span class="keyword">if</span> ~any(model.metCharges)
1100     model=rmfield(model,<span class="string">'metCharges'</span>);
1101 <span class="keyword">end</span>
1102 
1103 <span class="comment">%This just removes the grRules if no genes have been loaded</span>
1104 <span class="keyword">if</span> ~isfield(model,<span class="string">'genes'</span>) &amp;&amp; isfield(model,<span class="string">'grRules'</span>)
1105     model=rmfield(model,<span class="string">'grRules'</span>);
1106 <span class="keyword">end</span>
1107 
1108 <span class="comment">%Print warnings about bad structure</span>
1109 <span class="keyword">if</span> supressWarnings==false
1110     checkModelStruct(model,false);
1111 <span class="keyword">end</span>
1112 
1113 <span class="keyword">if</span> removeExcMets==true
1114     model=simplifyModel(model);
1115 <span class="keyword">end</span>
1116 <span class="keyword">end</span>
1117 
1118 <a name="_sub1" href="#_subfunctions" class="code">function matchGenes=getGeneList(grRules)</a>
1119 <span class="comment">%Constructs the list of unique genes from grRules</span>
1120 
1121 <span class="comment">%Assumes that everything that isn't a paranthesis, &quot; AND &quot; or &quot; or &quot; is a</span>
1122 <span class="comment">%gene name</span>
1123 genes=strrep(grRules,<span class="string">'('</span>,<span class="string">''</span>);
1124 genes=strrep(genes,<span class="string">')'</span>,<span class="string">''</span>);
1125 genes=strrep(genes,<span class="string">' or '</span>,<span class="string">' '</span>);
1126 genes=strrep(genes,<span class="string">' and '</span>,<span class="string">' '</span>);
1127 genes=strrep(genes,<span class="string">' OR '</span>,<span class="string">' '</span>);
1128 genes=strrep(genes,<span class="string">' AND '</span>,<span class="string">' '</span>);
1129 genes=regexp(genes,<span class="string">' '</span>,<span class="string">'split'</span>);
1130 
1131 allNames={};
1132 <span class="keyword">for</span> i=1:numel(genes)
1133     allNames=[allNames genes{i}];
1134 <span class="keyword">end</span>
1135 matchGenes=unique(allNames)';
1136 
1137 <span class="comment">%Remove the empty element if present</span>
1138 <span class="keyword">if</span> isempty(matchGenes{1})
1139     matchGenes(1)=[];
1140 <span class="keyword">end</span>
1141 <span class="keyword">end</span>
1142 
1143 <a name="_sub2" href="#_subfunctions" class="code">function fieldContent=parseNote(searchString,fieldName)</a>
1144 <span class="comment">%The function obtains the particular information from 'notes' field, using</span>
1145 <span class="comment">%fieldName as the dummy string</span>
1146 
1147 fieldContent=<span class="string">''</span>;
1148 
1149 <span class="keyword">if</span> strfind(searchString,fieldName)
1150     [~,targetString] = regexp(searchString,[<span class="string">'&lt;p&gt;'</span> fieldName <span class="string">'.*?&lt;/p&gt;'</span>],<span class="string">'tokens'</span>,<span class="string">'match'</span>);
1151     targetString=regexprep(targetString,<span class="string">'&lt;p&gt;|&lt;/p&gt;'</span>,<span class="string">''</span>);
1152     targetString=regexprep(targetString,[fieldName, <span class="string">':'</span>],<span class="string">''</span>);
1153     <span class="keyword">for</span> i=1:numel(targetString)
1154         fieldContent=[fieldContent <span class="string">';'</span> strtrim(targetString{1,i})];
1155     <span class="keyword">end</span>
1156     fieldContent=regexprep(fieldContent,<span class="string">'^;|;$'</span>,<span class="string">''</span>);
1157 <span class="keyword">else</span>
1158     fieldContent=<span class="string">''</span>;
1159 <span class="keyword">end</span>
1160 <span class="keyword">end</span>
1161 
1162 <a name="_sub3" href="#_subfunctions" class="code">function fieldContent=parseAnnotation(searchString,startString,midString,fieldName)</a>
1163 
1164 fieldContent=<span class="string">''</span>;
1165 
1166 <span class="comment">%Removing whitespace characters from the ending strings, which may occur in</span>
1167 <span class="comment">%several cases</span>
1168 searchString=regexprep(searchString,<span class="string">'&quot; /&gt;'</span>,<span class="string">'&quot;/&gt;'</span>);
1169 [~,targetString] = regexp(searchString,[<span class="string">'&lt;rdf:li rdf:resource=&quot;'</span> startString fieldName midString <span class="string">'.*?&quot;/&gt;'</span>],<span class="string">'tokens'</span>,<span class="string">'match'</span>);
1170 targetString=regexprep(targetString,<span class="string">'&lt;rdf:li rdf:resource=&quot;|&quot;/&gt;'</span>,<span class="string">''</span>);
1171 targetString=regexprep(targetString,startString,<span class="string">''</span>);
1172 targetString=regexprep(targetString,[fieldName midString],<span class="string">''</span>);
1173 
1174 <span class="keyword">for</span> i=1:numel(targetString)
1175     fieldContent=[fieldContent <span class="string">';'</span> strtrim(targetString{1,i})];
1176 <span class="keyword">end</span>
1177 
1178 fieldContent=regexprep(fieldContent,<span class="string">'^;|;$'</span>,<span class="string">''</span>);
1179 <span class="keyword">end</span>
1180 
1181 <a name="_sub4" href="#_subfunctions" class="code">function miriamStruct=parseMiriam(searchString)</a>
1182 <span class="comment">%Generates miriam structure from annotation field</span>
1183 
1184 <span class="comment">%Finding whether miriams are written in the old or the new way</span>
1185 <span class="keyword">if</span> strfind(searchString,<span class="string">'urn:miriam:'</span>)
1186     startString=<span class="string">'urn:miriam:'</span>;
1187     midString=<span class="string">':'</span>;
1188 <span class="keyword">elseif</span> strfind(searchString,<span class="string">'http://identifiers.org/'</span>)
1189     startString=<span class="string">'http://identifiers.org/'</span>;
1190     midString=<span class="string">'/'</span>;
1191 <span class="keyword">elseif</span> strfind(searchString,<span class="string">'https://identifiers.org/'</span>)
1192     startString=<span class="string">'https://identifiers.org/'</span>;
1193     midString=<span class="string">'/'</span>;
1194 <span class="keyword">else</span>
1195     miriamStruct=[];
1196     <span class="keyword">return</span>;
1197 <span class="keyword">end</span>
1198 
1199 miriamStruct=[];
1200 
1201 searchString=regexprep(searchString,<span class="string">'&quot; /&gt;'</span>,<span class="string">'&quot;/&gt;'</span>);
1202 [~,targetString] = regexp(searchString,<span class="string">'&lt;rdf:li rdf:resource=&quot;.*?&quot;/&gt;'</span>,<span class="string">'tokens'</span>,<span class="string">'match'</span>);
1203 targetString=regexprep(targetString,<span class="string">'&lt;rdf:li rdf:resource=&quot;|&quot;/&gt;'</span>,<span class="string">''</span>);
1204 targetString=regexprep(targetString,startString,<span class="string">''</span>);
1205 targetString=regexprep(targetString,midString,<span class="string">'/'</span>,<span class="string">'once'</span>);
1206 
1207 counter=0;
1208 <span class="keyword">for</span> i=1:numel(targetString)
1209     <span class="keyword">if</span> isempty(regexp(targetString{1,i},<span class="string">'inchi|ec-code'</span>, <span class="string">'once'</span>))
1210         counter=counter+1;
1211         miriamStruct.name{counter,1} = regexprep(targetString{1,i},<span class="string">'/.+'</span>,<span class="string">''</span>,<span class="string">'once'</span>);
1212         miriamStruct.value{counter,1} = regexprep(targetString{1,i},[miriamStruct.name{counter,1} <span class="string">'/'</span>],<span class="string">''</span>,<span class="string">'once'</span>);
1213         miriamStruct.name{counter,1} = regexprep(miriamStruct.name{counter,1},<span class="string">'^obo\.'</span>,<span class="string">''</span>);
1214     <span class="keyword">end</span>
1215 <span class="keyword">end</span>
1216 <span class="keyword">end</span>
1217 
1218 <a name="_sub5" href="#_subfunctions" class="code">function miriam = addSBOtoMiriam(miriam,sboTerm)</a>
1219 <span class="comment">%Appends SBO term to miriam structure</span>
1220 
1221 sboTerm = {[<span class="string">'SBO:'</span> sprintf(<span class="string">'%07u'</span>,sboTerm)]};  <span class="comment">% convert to proper format</span>
1222 <span class="keyword">if</span> isempty(miriam)
1223     miriam.name = {<span class="string">'sbo'</span>};
1224     miriam.value = sboTerm;
1225 <span class="keyword">elseif</span> any(strcmp(<span class="string">'sbo'</span>,miriam.name))
1226     currSbo = strcmp(<span class="string">'sbo'</span>,miriam.name);
1227     miriam.value(currSbo) = sboTerm;
1228 <span class="keyword">else</span>
1229     miriam.name(end+1) = {<span class="string">'sbo'</span>};
1230     miriam.value(end+1) = sboTerm;
1231 <span class="keyword">end</span>
1232 <span class="keyword">end</span></pre></div>
<hr><address>Generated by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>