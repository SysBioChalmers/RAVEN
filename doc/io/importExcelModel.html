<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of importExcelModel</title>
  <meta name="keywords" content="importExcelModel">
  <meta name="description" content="importExcelModel">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">io</a> &gt; importExcelModel.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for io&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>importExcelModel
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>importExcelModel</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function model=importExcelModel(fileName,removeExcMets,printWarnings,ignoreErrors) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> importExcelModel
   Imports a constraint-based model from a Excel file

   fileName      a Microsoft Excel file to import
   removeExcMets true if exchange metabolites should be removed. This is
                 needed to be able to run simulations, but it could also
                 be done using simplifyModel at a later stage (opt,
                 default true)
   printWarnings true if warnings should be printed (opt, default true)
   ignoreErrors  true if errors should be ignored. See below for details
                 (opt, default false)

   model
       description      description of model contents
       id               model ID
       rxns             reaction ids
       mets             metabolite ids
       S                stoichiometric matrix
       lb               lower bounds
       ub               upper bounds
       rev              reversibility vector
       c                objective coefficients
       b                equality constraints for the metabolite equations
       comps            compartment ids
       compNames        compartment names
       compOutside      the id (as in comps) for the compartment
                        surrounding each of the compartments
       compMiriams      structure with MIRIAM information about the
                        compartments
       rxnNames         reaction description
       rxnComps         compartments for reactions
       grRules          reaction to gene rules in text form
       rxnGeneMat       reaction-to-gene mapping in sparse matrix form
       subSystems       subsystem name for each reaction
       eccodes          EC-codes for the reactions
       rxnMiriams       structure with MIRIAM information about the reactions
       rxnNotes         reaction notes
       rxnReferences    reaction references
       rxnConfidenceScores reaction confidence scores
       genes            list of all genes
       geneComps        compartments for genes
       geneMiriams      structure with MIRIAM information about the genes
       geneShortNames   gene alternative names (e.g. ERG10)
       metNames         metabolite description
       metComps         compartments for metabolites
       inchis           InChI-codes for metabolites
       metFormulas      metabolite chemical formula
       metMiriams       structure with MIRIAM information about the metabolites
       metCharges        metabolite charge
       unconstrained    true if the metabolite is an exchange metabolite

   Loads models in the RAVEN Toolbox Excel format. A number of consistency
   checks are performed in order to ensure that the model is valid. These
   can be ignored by putting ignoreErrors to true. However, this is highly
   advised against, as it can result in errors in simulations or other
   functionalities. The RAVEN Toolbox is made to function only on consistent
   models, and the only checks performed are when the model is imported.

   NOTE: Most errors are checked for by checkModelStruct, but some
   are checked for in this function as well. Those are ones which relate
   to missing model elements and so on, and which would make it impossible
   to construct the model structure. Those errors cannot be ignored by
   setting ignoreErrors to true.

   Usage: model=importExcelModel(fileName,removeExcMets,printWarnings,ignoreErrors)

   Simonas Marcisauskas, 2017-11-17</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="cleanSheet.html" class="code" title="function [raw,keptRows,keptCols]=cleanSheet(raw,removeComments,removeOnlyCap,removeNoCap,removeEmptyRows)">cleanSheet</a>	cleanSheet</li><li><a href="loadSheet.html" class="code" title="function [raw, flag]=loadSheet(workbook, sheet)">loadSheet</a>	loadSheet</li><li><a href="loadWorkbook.html" class="code" title="function workbook=loadWorkbook(fileName,createEmpty)">loadWorkbook</a>	loadWorkbook</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="SBMLFromExcel.html" class="code" title="function SBMLFromExcel(fileName, outputFileName,toCOBRA,printWarnings)">SBMLFromExcel</a>	SBMLFromExcel</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function miriamStruct=parseMiriam(strings,miriamStruct)</a></li><li><a href="#_sub2" class="code">function y=toStr(x)</a></li><li><a href="#_sub3" class="code">function y=toDouble(x,default)</a></li><li><a href="#_sub4" class="code">function y=boolToDouble(x)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function model=importExcelModel(fileName,removeExcMets,printWarnings,ignoreErrors)</a>
0002 <span class="comment">% importExcelModel</span>
0003 <span class="comment">%   Imports a constraint-based model from a Excel file</span>
0004 <span class="comment">%</span>
0005 <span class="comment">%   fileName      a Microsoft Excel file to import</span>
0006 <span class="comment">%   removeExcMets true if exchange metabolites should be removed. This is</span>
0007 <span class="comment">%                 needed to be able to run simulations, but it could also</span>
0008 <span class="comment">%                 be done using simplifyModel at a later stage (opt,</span>
0009 <span class="comment">%                 default true)</span>
0010 <span class="comment">%   printWarnings true if warnings should be printed (opt, default true)</span>
0011 <span class="comment">%   ignoreErrors  true if errors should be ignored. See below for details</span>
0012 <span class="comment">%                 (opt, default false)</span>
0013 <span class="comment">%</span>
0014 <span class="comment">%   model</span>
0015 <span class="comment">%       description      description of model contents</span>
0016 <span class="comment">%       id               model ID</span>
0017 <span class="comment">%       rxns             reaction ids</span>
0018 <span class="comment">%       mets             metabolite ids</span>
0019 <span class="comment">%       S                stoichiometric matrix</span>
0020 <span class="comment">%       lb               lower bounds</span>
0021 <span class="comment">%       ub               upper bounds</span>
0022 <span class="comment">%       rev              reversibility vector</span>
0023 <span class="comment">%       c                objective coefficients</span>
0024 <span class="comment">%       b                equality constraints for the metabolite equations</span>
0025 <span class="comment">%       comps            compartment ids</span>
0026 <span class="comment">%       compNames        compartment names</span>
0027 <span class="comment">%       compOutside      the id (as in comps) for the compartment</span>
0028 <span class="comment">%                        surrounding each of the compartments</span>
0029 <span class="comment">%       compMiriams      structure with MIRIAM information about the</span>
0030 <span class="comment">%                        compartments</span>
0031 <span class="comment">%       rxnNames         reaction description</span>
0032 <span class="comment">%       rxnComps         compartments for reactions</span>
0033 <span class="comment">%       grRules          reaction to gene rules in text form</span>
0034 <span class="comment">%       rxnGeneMat       reaction-to-gene mapping in sparse matrix form</span>
0035 <span class="comment">%       subSystems       subsystem name for each reaction</span>
0036 <span class="comment">%       eccodes          EC-codes for the reactions</span>
0037 <span class="comment">%       rxnMiriams       structure with MIRIAM information about the reactions</span>
0038 <span class="comment">%       rxnNotes         reaction notes</span>
0039 <span class="comment">%       rxnReferences    reaction references</span>
0040 <span class="comment">%       rxnConfidenceScores reaction confidence scores</span>
0041 <span class="comment">%       genes            list of all genes</span>
0042 <span class="comment">%       geneComps        compartments for genes</span>
0043 <span class="comment">%       geneMiriams      structure with MIRIAM information about the genes</span>
0044 <span class="comment">%       geneShortNames   gene alternative names (e.g. ERG10)</span>
0045 <span class="comment">%       metNames         metabolite description</span>
0046 <span class="comment">%       metComps         compartments for metabolites</span>
0047 <span class="comment">%       inchis           InChI-codes for metabolites</span>
0048 <span class="comment">%       metFormulas      metabolite chemical formula</span>
0049 <span class="comment">%       metMiriams       structure with MIRIAM information about the metabolites</span>
0050 <span class="comment">%       metCharges        metabolite charge</span>
0051 <span class="comment">%       unconstrained    true if the metabolite is an exchange metabolite</span>
0052 <span class="comment">%</span>
0053 <span class="comment">%   Loads models in the RAVEN Toolbox Excel format. A number of consistency</span>
0054 <span class="comment">%   checks are performed in order to ensure that the model is valid. These</span>
0055 <span class="comment">%   can be ignored by putting ignoreErrors to true. However, this is highly</span>
0056 <span class="comment">%   advised against, as it can result in errors in simulations or other</span>
0057 <span class="comment">%   functionalities. The RAVEN Toolbox is made to function only on consistent</span>
0058 <span class="comment">%   models, and the only checks performed are when the model is imported.</span>
0059 <span class="comment">%</span>
0060 <span class="comment">%   NOTE: Most errors are checked for by checkModelStruct, but some</span>
0061 <span class="comment">%   are checked for in this function as well. Those are ones which relate</span>
0062 <span class="comment">%   to missing model elements and so on, and which would make it impossible</span>
0063 <span class="comment">%   to construct the model structure. Those errors cannot be ignored by</span>
0064 <span class="comment">%   setting ignoreErrors to true.</span>
0065 <span class="comment">%</span>
0066 <span class="comment">%   Usage: model=importExcelModel(fileName,removeExcMets,printWarnings,ignoreErrors)</span>
0067 <span class="comment">%</span>
0068 <span class="comment">%   Simonas Marcisauskas, 2017-11-17</span>
0069 <span class="comment">%</span>
0070 
0071 <span class="keyword">if</span> nargin&lt;2
0072     removeExcMets=true;
0073 <span class="keyword">end</span>
0074 <span class="keyword">if</span> nargin&lt;3
0075     printWarnings=true;
0076 <span class="keyword">end</span>
0077 <span class="keyword">if</span> nargin&lt;4
0078     ignoreErrors=false;
0079 <span class="keyword">end</span>
0080 
0081 <span class="comment">%This is to match the order of the fields to those you get from importing</span>
0082 <span class="comment">%from SBML</span>
0083 model=[];
0084 model.id=[];
0085 model.description=[];
0086 model.annotation=[];
0087 <span class="comment">%Default bounds if not defined</span>
0088 model.annotation.defaultLB=-1000;
0089 model.annotation.defaultUB=1000;
0090 model.rxns={};
0091 model.mets={};
0092 model.S=[];
0093 model.lb=[];
0094 model.ub=[];
0095 model.rev=[];
0096 model.c=[];
0097 model.b=[];
0098 model.comps={};
0099 model.compNames={};
0100 model.compOutside={};
0101 model.compMiriams={};
0102 model.rxnNames={};
0103 model.rxnComps={}; <span class="comment">%Will be double later</span>
0104 model.grRules={};
0105 model.rxnGeneMat=[];
0106 model.subSystems={};
0107 model.eccodes={};
0108 model.rxnMiriams={};
0109 model.rxnNotes={};
0110 model.rxnReferences={};
0111 model.rxnConfidenceScores={};
0112 model.genes={};
0113 model.geneComps={}; <span class="comment">%Will be double later</span>
0114 model.geneMiriams={};
0115 model.geneShortNames={};
0116 model.metNames={};
0117 model.metComps=[];
0118 model.inchis={};
0119 model.metFormulas={};
0120 model.metMiriams={};
0121 model.metCharges={}; <span class="comment">%Will be double later</span>
0122 model.unconstrained=[];
0123 
0124 workbook=<a href="loadWorkbook.html" class="code" title="function workbook=loadWorkbook(fileName,createEmpty)">loadWorkbook</a>(fileName);
0125 
0126 [raw, flag]=<a href="loadSheet.html" class="code" title="function [raw, flag]=loadSheet(workbook, sheet)">loadSheet</a>(workbook,<span class="string">'MODEL'</span>);
0127 
0128 <span class="keyword">if</span> flag&lt;0
0129     <span class="keyword">if</span> printWarnings==true
0130         EM=<span class="string">'Could not load the MODEL sheet'</span>;
0131         dispEM(EM,false);
0132     <span class="keyword">end</span>
0133     model.id=<span class="string">'UNKNOWN'</span>;
0134     model.description=<span class="string">'No model details available'</span>;
0135 <span class="keyword">else</span>
0136     raw=<a href="cleanSheet.html" class="code" title="function [raw,keptRows,keptCols]=cleanSheet(raw,removeComments,removeOnlyCap,removeNoCap,removeEmptyRows)">cleanSheet</a>(raw);
0137 
0138     <span class="comment">%It is assumed that the first line is labels and that the second one is</span>
0139     <span class="comment">%info</span>
0140     allLabels={<span class="string">'ID'</span>;<span class="string">'DESCRIPTION'</span>;<span class="string">'DEFAULT LOWER'</span>;<span class="string">'DEFAULT UPPER'</span>;<span class="string">'CONTACT GIVEN NAME'</span>;<span class="string">'CONTACT FAMILY NAME'</span>;<span class="string">'CONTACT EMAIL'</span>;<span class="string">'ORGANIZATION'</span>;<span class="string">'TAXONOMY'</span>;<span class="string">'NOTES'</span>};
0141 
0142     <span class="comment">%Map to new captions</span>
0143     raw(1,:)=upper(raw(1,:));
0144     raw(1,:)=strrep(raw(1,:),<span class="string">'MODELID'</span>,<span class="string">'ID'</span>);
0145     raw(1,:)=strrep(raw(1,:),<span class="string">'MODELNAME'</span>,<span class="string">'DESCRIPTION'</span>);
0146 
0147     <span class="comment">%Loop through the labels</span>
0148     [I, J]=ismember(raw(1,:),allLabels);
0149     I=find(I);
0150     <span class="keyword">for</span> i=1:numel(I)
0151         <span class="keyword">switch</span> J(I(i))
0152             <span class="keyword">case</span> 1
0153                 <span class="keyword">if</span> any(raw{I(i),2})
0154                     model.id=<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>(raw{2,I(i)}); <span class="comment">%Should be string already</span>
0155                 <span class="keyword">else</span>
0156                     EM=<span class="string">'No model ID supplied'</span>;
0157                     dispEM(EM);
0158                 <span class="keyword">end</span>
0159             <span class="keyword">case</span> 2
0160                 <span class="keyword">if</span> any(raw{2,I(i)})
0161                     model.description=<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>(raw{2,I(i)}); <span class="comment">%Should be string already</span>
0162                 <span class="keyword">else</span>
0163                     EM=<span class="string">'No model name supplied'</span>;
0164                     dispEM(EM);
0165                 <span class="keyword">end</span>
0166             <span class="keyword">case</span> 3
0167                 <span class="keyword">if</span> ~isempty(raw{2,I(i)})
0168                     <span class="keyword">try</span>
0169                         model.annotation.defaultLB=<a href="#_sub3" class="code" title="subfunction y=toDouble(x,default)">toDouble</a>(raw{2,I(i)},NaN);
0170                     <span class="keyword">catch</span>
0171                         EM=<span class="string">'DEFAULT LOWER must be numeric'</span>;
0172                         dispEM(EM);
0173                     <span class="keyword">end</span>
0174                 <span class="keyword">else</span>
0175                     <span class="keyword">if</span> printWarnings==true
0176                         fprintf(<span class="string">'NOTE: DEFAULT LOWER not supplied. Uses -1000\n'</span>);
0177                     <span class="keyword">end</span>
0178                     model.annotation.defaultLB=-1000;
0179                 <span class="keyword">end</span>
0180             <span class="keyword">case</span> 4
0181                 <span class="keyword">if</span> ~isempty(raw{2,I(i)})
0182                     <span class="keyword">try</span>
0183                         model.annotation.defaultUB=<a href="#_sub3" class="code" title="subfunction y=toDouble(x,default)">toDouble</a>(raw{2,I(i)},NaN);
0184                     <span class="keyword">catch</span>
0185                         EM=<span class="string">'DEFAULT UPPER must be numeric'</span>;
0186                         dispEM(EM);
0187                     <span class="keyword">end</span>
0188                 <span class="keyword">else</span>
0189                     <span class="keyword">if</span> printWarnings==true
0190                         fprintf(<span class="string">'NOTE: DEFAULT UPPER not supplied. Uses 1000\n'</span>);
0191                     <span class="keyword">end</span>
0192                     model.annotation.defaultUB=1000;
0193                 <span class="keyword">end</span>
0194             <span class="keyword">case</span> 5
0195                 <span class="keyword">if</span> any(raw{2,I(i)})
0196                     model.annotation.givenName=<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>(raw{2,I(i)}); <span class="comment">%Should be string already</span>
0197                 <span class="keyword">end</span>
0198             <span class="keyword">case</span> 6
0199                 <span class="keyword">if</span> any(raw{2,I(i)})
0200                     model.annotation.familyName=<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>(raw{2,I(i)}); <span class="comment">%Should be string already</span>
0201                 <span class="keyword">end</span>
0202             <span class="keyword">case</span> 7
0203                 <span class="keyword">if</span> any(raw{2,I(i)})
0204                     model.annotation.email=<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>(raw{2,I(i)}); <span class="comment">%Should be string already</span>
0205                 <span class="keyword">end</span>
0206             <span class="keyword">case</span> 8
0207                 <span class="keyword">if</span> any(raw{2,I(i)})
0208                     model.annotation.organization=<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>(raw{2,I(i)}); <span class="comment">%Should be string already</span>
0209                 <span class="keyword">end</span>
0210             <span class="keyword">case</span> 9
0211                 <span class="keyword">if</span> any(raw{2,I(i)})
0212                     model.annotation.taxonomy=<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>(raw{2,I(i)}); <span class="comment">%Should be string already</span>
0213                 <span class="keyword">end</span>
0214             <span class="keyword">case</span> 10
0215                 <span class="keyword">if</span> any(raw{2,I(i)})
0216                     model.annotation.note=<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>(raw{2,I(i)}); <span class="comment">%Should be string already</span>
0217                 <span class="keyword">end</span>
0218         <span class="keyword">end</span>
0219     <span class="keyword">end</span>
0220 <span class="keyword">end</span>
0221 
0222 <span class="comment">%Get compartment information</span>
0223 [raw, flag]=<a href="loadSheet.html" class="code" title="function [raw, flag]=loadSheet(workbook, sheet)">loadSheet</a>(workbook,<span class="string">'COMPS'</span>);
0224 
0225 <span class="keyword">if</span> flag&lt;0
0226     <span class="keyword">if</span> printWarnings==true
0227         EM=<span class="string">'Could not load the COMPS sheet. All elements will be assigned to a compartment &quot;s&quot; for &quot;System&quot;'</span>;
0228         dispEM(EM,false);
0229     <span class="keyword">end</span>
0230     model.comps={<span class="string">'s'</span>};
0231     model.compNames={<span class="string">'System'</span>};
0232 <span class="keyword">else</span>
0233     raw=<a href="cleanSheet.html" class="code" title="function [raw,keptRows,keptCols]=cleanSheet(raw,removeComments,removeOnlyCap,removeNoCap,removeEmptyRows)">cleanSheet</a>(raw);
0234 
0235     <span class="comment">%Map to new captions</span>
0236     raw(1,:)=upper(raw(1,:));
0237     raw(1,:)=strrep(raw(1,:),<span class="string">'COMPABBREV'</span>,<span class="string">'ABBREVIATION'</span>);
0238     raw(1,:)=strrep(raw(1,:),<span class="string">'COMPNAME'</span>,<span class="string">'NAME'</span>);
0239 
0240     allLabels={<span class="string">'ABBREVIATION'</span>;<span class="string">'NAME'</span>;<span class="string">'INSIDE'</span>;<span class="string">'MIRIAM'</span>};
0241 
0242     <span class="comment">%Loop through the labels</span>
0243     [I, J]=ismember(raw(1,:),allLabels);
0244     I=find(I);
0245     <span class="keyword">for</span> i=1:numel(I)
0246         <span class="keyword">switch</span> J(I(i))
0247             <span class="keyword">case</span> 1
0248                 model.comps=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0249             <span class="keyword">case</span> 2
0250                 model.compNames=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0251             <span class="keyword">case</span> 3
0252                 model.compOutside=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0253             <span class="keyword">case</span> 4
0254                 model.compMiriams=raw(2:<span class="keyword">end</span>,I(i));
0255         <span class="keyword">end</span>
0256     <span class="keyword">end</span>
0257 
0258     <span class="comment">%Check that necessary fields are loaded</span>
0259     <span class="keyword">if</span> isempty(model.comps)
0260         EM=<span class="string">'There must be a column named ABBREVIATION in the COMPS sheet'</span>;
0261         dispEM(EM);
0262     <span class="keyword">end</span>
0263     <span class="keyword">if</span> isempty(model.compNames)
0264         model.compNames=model.comps;
0265         <span class="keyword">if</span> printWarnings==true
0266             EM=<span class="string">'There is no column named NAME in the COMPS sheet. ABBREVIATION will be used as name'</span>;
0267             dispEM(EM,false);
0268         <span class="keyword">end</span>
0269     <span class="keyword">end</span>
0270 
0271     model.compMiriams=<a href="#_sub1" class="code" title="subfunction miriamStruct=parseMiriam(strings,miriamStruct)">parseMiriam</a>(model.compMiriams);
0272 <span class="keyword">end</span>
0273 
0274 <span class="comment">%Get all the genes and info about them</span>
0275 [raw, flag]=<a href="loadSheet.html" class="code" title="function [raw, flag]=loadSheet(workbook, sheet)">loadSheet</a>(workbook,<span class="string">'GENES'</span>);
0276 
0277 <span class="keyword">if</span> flag&lt;0
0278     <span class="keyword">if</span> printWarnings==true
0279         EM=<span class="string">'There is no spreadsheet named GENES'</span>;
0280         dispEM(EM,false)
0281     <span class="keyword">end</span>
0282 <span class="keyword">else</span>
0283     raw=<a href="cleanSheet.html" class="code" title="function [raw,keptRows,keptCols]=cleanSheet(raw,removeComments,removeOnlyCap,removeNoCap,removeEmptyRows)">cleanSheet</a>(raw);
0284 
0285     <span class="comment">%Map to new captions</span>
0286     raw(1,:)=upper(raw(1,:));
0287     raw(1,:)=strrep(raw(1,:),<span class="string">'GENE NAME'</span>,<span class="string">'NAME'</span>);
0288 
0289     allLabels={<span class="string">'NAME'</span>;<span class="string">'MIRIAM'</span>;<span class="string">'SHORT NAME'</span>;<span class="string">'COMPARTMENT'</span>};
0290 
0291     <span class="comment">%Loop through the labels</span>
0292     [I, J]=ismember(upper(raw(1,:)),allLabels);
0293     I=find(I);
0294     foundGenes=false;
0295     <span class="keyword">for</span> i=1:numel(I)
0296         <span class="keyword">switch</span> J(I(i))
0297             <span class="keyword">case</span> 1
0298                 model.genes=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0299                 foundGenes=true;
0300             <span class="keyword">case</span> 2
0301                 model.geneMiriams=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0302             <span class="keyword">case</span> 3
0303                 model.geneShortNames=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);    
0304             <span class="keyword">case</span> 4
0305                 model.geneComps=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0306         <span class="keyword">end</span>
0307     <span class="keyword">end</span>
0308 
0309     <span class="keyword">if</span> foundGenes==false
0310         EM=<span class="string">'There must be a column named NAME in the GENES sheet'</span>;
0311         dispEM(EM);
0312     <span class="keyword">end</span>
0313 
0314     <span class="comment">%Its ok if all of them are empty</span>
0315     <span class="keyword">if</span> all(cellfun(@isempty,model.geneComps))
0316         model.geneComps=[];
0317     <span class="keyword">end</span>
0318 
0319     <span class="comment">%Check that geneName contain only strings and no empty strings</span>
0320     <span class="keyword">if</span> ~iscellstr(model.genes)
0321         EM=<span class="string">'All gene names have to be strings'</span>;
0322         dispEM(EM);
0323     <span class="keyword">else</span>
0324         <span class="keyword">if</span> any(strcmp(<span class="string">''</span>,model.genes))
0325             EM=<span class="string">'There can be no empty strings in gene names'</span>;
0326             dispEM(EM);
0327         <span class="keyword">end</span>
0328     <span class="keyword">end</span>
0329 
0330     <span class="comment">%Check that geneComp contains only strings and no empty string</span>
0331     <span class="keyword">if</span> ~isempty(model.geneComps)
0332         <span class="keyword">if</span> ~iscellstr(model.geneComps)
0333             EM=<span class="string">'All gene compartments have to be strings'</span>;
0334             dispEM(EM);
0335         <span class="keyword">else</span>
0336             <span class="keyword">if</span> any(strcmp(<span class="string">''</span>,model.geneComps))
0337                 EM=<span class="string">'There can be no empty strings in gene compartments'</span>;
0338                 dispEM(EM);
0339             <span class="keyword">end</span>
0340         <span class="keyword">end</span>
0341         [I, model.geneComps]=ismember(model.geneComps,model.comps);
0342         EM=<span class="string">'The following genes have compartment abbreviations which could not be found:'</span>;
0343         dispEM(EM,true,model.genes(~I));
0344     <span class="keyword">end</span>
0345 <span class="keyword">end</span>
0346 
0347 model.geneMiriams=<a href="#_sub1" class="code" title="subfunction miriamStruct=parseMiriam(strings,miriamStruct)">parseMiriam</a>(model.geneMiriams);
0348 
0349 <span class="comment">%Loads the reaction data</span>
0350 [raw, flag]=<a href="loadSheet.html" class="code" title="function [raw, flag]=loadSheet(workbook, sheet)">loadSheet</a>(workbook,<span class="string">'RXNS'</span>);
0351 
0352 <span class="keyword">if</span> flag&lt;0
0353     EM=<span class="string">'Could not load the RXNS sheet'</span>;
0354     dispEM(EM);
0355 <span class="keyword">end</span>
0356 
0357 raw=<a href="cleanSheet.html" class="code" title="function [raw,keptRows,keptCols]=cleanSheet(raw,removeComments,removeOnlyCap,removeNoCap,removeEmptyRows)">cleanSheet</a>(raw);
0358 
0359 <span class="comment">%Map to new captions</span>
0360 raw(1,:)=upper(raw(1,:));
0361 raw(1,:)=strrep(raw(1,:),<span class="string">'RXNID'</span>,<span class="string">'ID'</span>);
0362 
0363 allLabels={<span class="string">'ID'</span>;<span class="string">'NAME'</span>;<span class="string">'EQUATION'</span>;<span class="string">'EC-NUMBER'</span>;<span class="string">'GENE ASSOCIATION'</span>;<span class="string">'LOWER BOUND'</span>;<span class="string">'UPPER BOUND'</span>;<span class="string">'OBJECTIVE'</span>;<span class="string">'COMPARTMENT'</span>;<span class="string">'SUBSYSTEM'</span>;<span class="string">'REPLACEMENT ID'</span>;<span class="string">'MIRIAM'</span>;<span class="string">'NOTE'</span>;<span class="string">'REFERENCE'</span>;<span class="string">'CONFIDENCE SCORE'</span>};
0364 equations={};
0365 reactionReplacement={};
0366 
0367 <span class="comment">%Loop through the labels</span>
0368 [I, J]=ismember(raw(1,:),allLabels);
0369 I=find(I);
0370 <span class="keyword">for</span> i=1:numel(I)
0371     <span class="keyword">switch</span> J(I(i))
0372         <span class="keyword">case</span> 1
0373            model.rxns=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0374         <span class="keyword">case</span> 2
0375            model.rxnNames=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0376         <span class="keyword">case</span> 3
0377            equations=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0378         <span class="keyword">case</span> 4
0379            model.eccodes=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0380         <span class="keyword">case</span> 5
0381            model.grRules=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0382         <span class="keyword">case</span> 6
0383            <span class="keyword">try</span>
0384                model.lb=cellfun(@(x) <a href="#_sub3" class="code" title="subfunction y=toDouble(x,default)">toDouble</a>(x,NaN),raw(2:<span class="keyword">end</span>,I(i)));
0385            <span class="keyword">catch</span>
0386                EM=<span class="string">'The lower bounds must be numerical values'</span>;
0387                dispEM(EM);
0388            <span class="keyword">end</span>
0389         <span class="keyword">case</span> 7
0390            <span class="keyword">try</span>
0391                model.ub=cellfun(@(x) <a href="#_sub3" class="code" title="subfunction y=toDouble(x,default)">toDouble</a>(x,NaN),raw(2:<span class="keyword">end</span>,I(i)));
0392            <span class="keyword">catch</span>
0393                EM=<span class="string">'The upper bounds must be numerical values'</span>;
0394                dispEM(EM);
0395            <span class="keyword">end</span>
0396         <span class="keyword">case</span> 8
0397            <span class="keyword">try</span>
0398                model.c=cellfun(@(x) <a href="#_sub3" class="code" title="subfunction y=toDouble(x,default)">toDouble</a>(x,0),raw(2:<span class="keyword">end</span>,I(i)));
0399            <span class="keyword">catch</span>
0400                EM=<span class="string">'The objective coefficients must be numerical values'</span>;
0401                dispEM(EM);
0402            <span class="keyword">end</span>
0403         <span class="keyword">case</span> 9
0404             model.rxnComps=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0405         <span class="keyword">case</span> 10
0406             model.subSystems=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0407         <span class="keyword">case</span> 11
0408             reactionReplacement=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0409         <span class="keyword">case</span> 12
0410             model.rxnMiriams=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0411         <span class="keyword">case</span> 13
0412             model.rxnNotes=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0413         <span class="keyword">case</span> 14
0414             model.rxnReferences=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0415         <span class="keyword">case</span> 15
0416             model.rxnConfidenceScores=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0417     <span class="keyword">end</span>
0418 <span class="keyword">end</span>
0419 
0420 <span class="comment">%Check that all necessary reaction info has been loaded</span>
0421 <span class="keyword">if</span> isempty(equations)
0422     EM=<span class="string">'There must be a column named EQUATION in the RXNS sheet'</span>;
0423     dispEM(EM);
0424 <span class="keyword">end</span>
0425 <span class="keyword">if</span> isempty(model.rxns)
0426      <span class="keyword">if</span> printWarnings==true
0427          EM=<span class="string">'There is no column named ID in the RXNS sheet. The reactions will be named as &quot;r1&quot;, &quot;r2&quot;...'</span>;
0428          dispEM(EM,false);
0429      <span class="keyword">end</span>
0430      I=num2cell((1:numel(equations))');
0431      model.rxns=strcat(<span class="string">'r'</span>,cellfun(@num2str,I,<span class="string">'UniformOutput'</span>,false));
0432 <span class="keyword">end</span>
0433 
0434 <span class="comment">%Check if some other stuff is loaded and populate with default values</span>
0435 <span class="comment">%otherwise</span>
0436 <span class="keyword">if</span> isempty(model.rxnNames)
0437    model.rxnNames=cell(numel(model.rxns),1);
0438    model.rxnNames(:)={<span class="string">''</span>};
0439    <span class="keyword">if</span> printWarnings==true
0440        EM=<span class="string">'There is no column named NAME in the RXNS sheet. Empty strings will be used as reaction names'</span>;
0441        dispEM(EM,false);
0442    <span class="keyword">end</span>
0443 <span class="keyword">end</span>
0444 <span class="keyword">if</span> isempty(model.lb)
0445    <span class="comment">%This is not set here since the reversibility isn't known yet</span>
0446    model.lb=nan(numel(model.rxns),1);
0447    <span class="keyword">if</span> printWarnings==true
0448        EM=<span class="string">'There is no column named LOWER BOUND in the RXNS sheet. Default bounds will be used'</span>;
0449        dispEM(EM,false);
0450    <span class="keyword">end</span>
0451 <span class="keyword">end</span>
0452 <span class="keyword">if</span> isempty(model.ub)
0453    model.ub=nan(numel(model.rxns),1);
0454    <span class="keyword">if</span> printWarnings==true
0455        EM=<span class="string">'There is no column named UPPER BOUND in the RXNS sheet. Default bounds will be used'</span>;
0456        dispEM(EM,false);
0457    <span class="keyword">end</span>
0458 <span class="keyword">end</span>
0459 <span class="keyword">if</span> isempty(model.c)
0460    model.c=zeros(numel(model.rxns),1);
0461    <span class="keyword">if</span> printWarnings==true
0462        EM=<span class="string">'There is no column named OBJECTIVE in the RXNS sheet'</span>;
0463        dispEM(EM,false);
0464    <span class="keyword">end</span>
0465 <span class="keyword">end</span>
0466 
0467 <span class="comment">%Either all reactions must have a compartment string or none of them.</span>
0468 <span class="comment">%Check if it's only empty and if so return it to []</span>
0469 <span class="keyword">if</span> ~isempty(model.rxnComps)
0470     <span class="keyword">if</span> all(cellfun(@isempty,model.rxnComps))
0471         model.rxnComps=[];
0472     <span class="keyword">end</span>
0473 <span class="keyword">end</span>
0474 
0475 <span class="comment">%Construct the rxnMiriams structure</span>
0476 model.rxnMiriams=<a href="#_sub1" class="code" title="subfunction miriamStruct=parseMiriam(strings,miriamStruct)">parseMiriam</a>(model.rxnMiriams);
0477 
0478 <span class="comment">%Replace the reaction IDs for those IDs that have a corresponding</span>
0479 <span class="comment">%replacement name.</span>
0480 I=cellfun(@any,reactionReplacement);
0481 model.rxns(I)=reactionReplacement(I);
0482 
0483 <span class="comment">%Check that there are no empty strings in reactionIDs or equations</span>
0484 <span class="keyword">if</span> any(strcmp(<span class="string">''</span>,model.rxns))
0485     EM=<span class="string">'There are empty reaction IDs'</span>;
0486     dispEM(EM);
0487 <span class="keyword">end</span>
0488 
0489 <span class="keyword">if</span> any(strcmp(<span class="string">''</span>,equations))
0490     EM=<span class="string">'There are empty equations'</span>;
0491     dispEM(EM);
0492 <span class="keyword">end</span>
0493 
0494 <span class="keyword">if</span> ~isempty(model.rxnComps)
0495     <span class="keyword">if</span> any(strcmp(<span class="string">''</span>,model.rxnComps))
0496         EM=<span class="string">'Either all reactions must have an associated compartment string or none of them'</span>;
0497         dispEM(EM);
0498     <span class="keyword">end</span>
0499 <span class="keyword">end</span>
0500 
0501 <span class="comment">%Check gene association for each reaction and populate rxnGeneMat</span>
0502 <span class="keyword">if</span> ~isempty(model.genes)
0503     model.rxnGeneMat=zeros(numel(model.rxns),numel(model.genes));
0504 <span class="keyword">end</span>
0505 <span class="keyword">if</span> ~isempty(model.grRules)
0506     tempRules=model.grRules;
0507     <span class="keyword">for</span> i=1:length(model.rxns)
0508        <span class="comment">%Check that all gene associations have a match in the gene list</span>
0509        <span class="keyword">if</span> ~isempty(model.grRules{i})          
0510            tempRules{i}=regexprep(tempRules{i},<span class="string">' and | or '</span>,<span class="string">'&gt;'</span>); <span class="comment">%New format: Genes are separated 'and' and 'or' strings with parentheses</span>
0511            tempRules{i}=regexprep(tempRules{i},<span class="string">'('</span>,<span class="string">''</span>); <span class="comment">%New format: Genes are separated 'and' and 'or' strings with parentheses</span>
0512            tempRules{i}=regexprep(tempRules{i},<span class="string">')'</span>,<span class="string">''</span>); <span class="comment">%New format: Genes are separated 'and' and 'or' strings with parentheses</span>
0513            indexesNew=strfind(tempRules{i},<span class="string">'&gt;'</span>); <span class="comment">%Old format: Genes are separated by &quot;:&quot; for AND and &quot;;&quot; for OR</span>
0514            indexes=strfind(tempRules{i},<span class="string">':'</span>); <span class="comment">%Old format: Genes are separated by &quot;:&quot; for AND and &quot;;&quot; for OR</span>
0515            indexes=unique([indexesNew indexes strfind(tempRules{i},<span class="string">';'</span>)]);
0516            <span class="keyword">if</span> isempty(indexes)
0517                <span class="comment">%See if you have a match</span>
0518                I=find(strcmp(tempRules{i},model.genes));
0519                <span class="keyword">if</span> isempty(I)
0520                    EM=[<span class="string">'The gene association in reaction '</span> model.rxns{i} <span class="string">' ('</span> tempRules{i} <span class="string">') is not present in the gene list'</span>];
0521                    dispEM(EM);
0522                <span class="keyword">end</span>
0523                model.rxnGeneMat(i,I)=1;
0524            <span class="keyword">else</span>
0525                temp=[0 indexes numel(tempRules{i})+1];
0526                <span class="keyword">for</span> j=1:numel(indexes)+1
0527                    <span class="comment">%The reaction has several associated genes</span>
0528                    geneName=tempRules{i}(temp(j)+1:temp(j+1)-1);
0529                    I=find(strcmp(geneName,model.genes));
0530                    <span class="keyword">if</span> isempty(I)
0531                        EM=[<span class="string">'The gene association in reaction '</span> model.rxns{i} <span class="string">' ('</span> geneName <span class="string">') is not present in the gene list'</span>];
0532                        dispEM(EM);
0533                    <span class="keyword">end</span>
0534                    model.rxnGeneMat(i,I)=1;
0535                <span class="keyword">end</span>
0536            <span class="keyword">end</span>
0537             <span class="comment">%In order to adhere to the COBRA standards it should be like</span>
0538             <span class="comment">%this:</span>
0539             <span class="comment">%-If only one gene then no parentheses</span>
0540             <span class="comment">%-If only &quot;and&quot; or only &quot;or&quot; there should only be one set of</span>
0541             <span class="comment">%parentheses</span>
0542             <span class="comment">%-If both &quot;and&quot; and &quot;or&quot;, then split on &quot;or&quot;. This is not</span>
0543             <span class="comment">%complete, but it's the type of relationship supported by the</span>
0544             <span class="comment">%Excel formulation</span>
0545             aSign=strfind(model.grRules{i},<span class="string">':'</span>);
0546             oSign=strfind(model.grRules{i},<span class="string">';'</span>);
0547             <span class="keyword">if</span> isempty(aSign) &amp;&amp; isempty(oSign)
0548                 model.grRules{i}=model.grRules{i};
0549             <span class="keyword">else</span>
0550                 <span class="keyword">if</span> isempty(aSign)
0551                     model.grRules{i}=[<span class="string">'('</span> strrep(model.grRules{i},<span class="string">';'</span>,<span class="string">' or '</span>) <span class="string">')'</span>];
0552                 <span class="keyword">else</span>
0553                     <span class="keyword">if</span> isempty(oSign)
0554                         model.grRules{i}=[<span class="string">'('</span> strrep(model.grRules{i},<span class="string">':'</span>,<span class="string">' and '</span>) <span class="string">')'</span>];
0555                     <span class="keyword">else</span>
0556                         model.grRules{i}=[<span class="string">'(('</span> strrep(model.grRules{i},<span class="string">';'</span>,<span class="string">') or ('</span>) <span class="string">'))'</span>];
0557                         model.grRules{i}=strrep(model.grRules{i},<span class="string">':'</span>,<span class="string">' and '</span>);
0558                     <span class="keyword">end</span>
0559                 <span class="keyword">end</span>
0560             <span class="keyword">end</span>
0561        <span class="keyword">end</span>
0562     <span class="keyword">end</span>
0563 <span class="keyword">end</span>
0564 model.rxnGeneMat=sparse(model.rxnGeneMat);
0565 
0566 <span class="comment">%Check that the compartment for each reaction can be found</span>
0567 <span class="keyword">if</span> ~isempty(model.rxnComps)
0568     [I, model.rxnComps]=ismember(model.rxnComps,model.comps);
0569     EM=<span class="string">'The following reactions have compartment abbreviations which could not be found:'</span>;
0570     dispEM(EM,true,model.rxns(~I));
0571 <span class="keyword">end</span>
0572 
0573 <span class="comment">%Get all the metabolites and info about them</span>
0574 [raw, flag]=<a href="loadSheet.html" class="code" title="function [raw, flag]=loadSheet(workbook, sheet)">loadSheet</a>(workbook,<span class="string">'METS'</span>);
0575 
0576 <span class="keyword">if</span> flag&lt;0
0577     <span class="keyword">if</span> printWarnings==true
0578         EM=<span class="string">'There is no spreadsheet named METS. The metabolites will be named &quot;m1&quot;, &quot;m2&quot;... and assigned to the first compartment'</span>;
0579         dispEM(EM,false);
0580     <span class="keyword">end</span>
0581     <span class="comment">%Parse the equations to find out how many metabolites there are</span>
0582     metsForParsing=parseRxnEqu(equations);
0583     I=num2cell((1:numel(metsForParsing))');
0584     model.mets=strcat(<span class="string">'m'</span>,cellfun(@num2str,I,<span class="string">'UniformOutput'</span>,false));
0585     model.metComps=ones(numel(model.mets),1);
0586     model.unconstrained=zeros(numel(model.mets),1);
0587     model.metNames=metsForParsing;
0588 <span class="keyword">else</span>
0589     raw=<a href="cleanSheet.html" class="code" title="function [raw,keptRows,keptCols]=cleanSheet(raw,removeComments,removeOnlyCap,removeNoCap,removeEmptyRows)">cleanSheet</a>(raw);
0590 
0591     <span class="comment">%Map to new captions</span>
0592     raw(1,:)=upper(raw(1,:));
0593     raw(1,:)=strrep(raw(1,:),<span class="string">'METID'</span>,<span class="string">'ID'</span>);
0594     raw(1,:)=strrep(raw(1,:),<span class="string">'METNAME'</span>,<span class="string">'NAME'</span>);
0595 
0596     allLabels={<span class="string">'ID'</span>;<span class="string">'NAME'</span>;<span class="string">'UNCONSTRAINED'</span>;<span class="string">'MIRIAM'</span>;<span class="string">'COMPOSITION'</span>;<span class="string">'INCHI'</span>;<span class="string">'COMPARTMENT'</span>;<span class="string">'REPLACEMENT ID'</span>;<span class="string">'CHARGE'</span>};
0597 
0598     <span class="comment">%Load the metabolite information</span>
0599     metReplacement={};
0600 
0601     <span class="comment">%Loop through the labels</span>
0602     [I, J]=ismember(raw(1,:),allLabels);
0603     I=find(I);
0604     <span class="keyword">for</span> i=1:numel(I)
0605         <span class="keyword">switch</span> J(I(i))
0606             <span class="keyword">case</span> 1
0607                model.mets=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0608             <span class="keyword">case</span> 2
0609                model.metNames=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0610             <span class="keyword">case</span> 3
0611                model.unconstrained=cellfun(@<a href="#_sub4" class="code" title="subfunction y=boolToDouble(x)">boolToDouble</a>,raw(2:<span class="keyword">end</span>,I(i)));
0612 
0613                <span class="comment">%NaN is returned if the values couldn't be parsed</span>
0614                EM=<span class="string">'The UNCONSTRAINED property for the following metabolites must be &quot;true&quot;/&quot;false&quot;, 1/0, TRUE/FALSE or not set:'</span>;
0615                dispEM(EM,true,model.mets(isnan(model.unconstrained)));
0616             <span class="keyword">case</span> 4
0617                model.metMiriams=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0618             <span class="keyword">case</span> 5
0619                model.metFormulas=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0620             <span class="keyword">case</span> 6
0621                model.inchis=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0622             <span class="keyword">case</span> 7
0623                 model.metComps=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0624 
0625                 <span class="comment">%Check that all metabolites have compartments defined</span>
0626                 <span class="keyword">if</span> any(strcmp(<span class="string">''</span>,model.metComps))
0627                     EM=<span class="string">'All metabolites must have an associated compartment string'</span>;
0628                     dispEM(EM);
0629                 <span class="keyword">end</span>
0630             <span class="keyword">case</span> 8
0631                metReplacement=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0632             <span class="keyword">case</span> 9
0633                model.metCharges=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0634         <span class="keyword">end</span>
0635     <span class="keyword">end</span>
0636 
0637     <span class="comment">%Check that necessary fields are loaded (METID)</span>
0638     <span class="keyword">if</span> isempty(model.mets)
0639         EM=<span class="string">'There must be a column named ID in the METS sheet'</span>;
0640         dispEM(EM);
0641     <span class="keyword">end</span>
0642 
0643     <span class="comment">%Check that some other stuff is loaded and use default values otherwise</span>
0644     <span class="keyword">if</span> isempty(model.metNames)
0645        model.metNames=cell(numel(model.mets),1);
0646        <span class="keyword">if</span> printWarnings==true
0647            EM=<span class="string">'There is no column named NAME in the METS sheet. ID will be used as name'</span>;
0648            dispEM(EM,false);
0649        <span class="keyword">end</span>
0650     <span class="keyword">end</span>
0651     <span class="keyword">if</span> isempty(model.unconstrained)
0652        model.unconstrained=zeros(numel(model.mets),1);
0653        <span class="keyword">if</span> printWarnings==true
0654            EM=<span class="string">'There is no column named UNCONSTRAINED in the METS sheet. All metabolites will be constrained'</span>;
0655            dispEM(EM,false);
0656        <span class="keyword">end</span>
0657     <span class="keyword">end</span>
0658 
0659     <span class="keyword">if</span> isempty(model.metComps)
0660        model.metComps=cell(numel(model.mets),1);
0661        model.metComps(:)=model.comps(1);
0662        <span class="keyword">if</span> printWarnings==true
0663            EM=<span class="string">'There is no column named COMPARTMENT in the METS sheet. All metabolites will be assigned to the first compartment in COMPS. Note that RAVEN makes extensive use of metabolite names and compartments. Some features will therefore not function correctly if metabolite compartments are not correctly assigned'</span>;
0664            dispEM(EM,false);
0665        <span class="keyword">end</span>
0666     <span class="keyword">end</span>
0667 
0668     <span class="comment">%The composition should be loaded from InChIs when available</span>
0669     I=find(~cellfun(@isempty,model.inchis));
0670     <span class="keyword">for</span> i=1:numel(I)
0671         S=regexp(model.inchis(I(i)),<span class="string">'/'</span>,<span class="string">'split'</span>);
0672         S=S{1};
0673         <span class="keyword">if</span> numel(S)&gt;=2
0674             <span class="comment">%Don't copy if it doesn't look good</span>
0675             model.metFormulas(I(i))=S(2);
0676         <span class="keyword">end</span>
0677     <span class="keyword">end</span>
0678 
0679     <span class="comment">%Check that the compartment for each metabolite can be found. Also convert</span>
0680     <span class="comment">%from id to index</span>
0681     [I, model.metComps]=ismember(model.metComps,model.comps);
0682     EM=<span class="string">'The following metabolites have compartment abbreviations which could not be found:'</span>;
0683     dispEM(EM,true,model.mets(~I));
0684 
0685     <span class="comment">%Check that the model.mets vector is unique. The problem is that</span>
0686     <span class="comment">%the checkModelStruct cannot check for that since only the metReplacements</span>
0687     <span class="comment">%(if used) end up in the model structure</span>
0688     I=false(numel(model.mets),1);
0689     [J, K]=unique(model.mets);
0690     <span class="keyword">if</span> numel(J)~=numel(model.mets)
0691         L=1:numel(model.mets);
0692         L(K)=[];
0693         I(L)=true;
0694     <span class="keyword">end</span>
0695     EM=<span class="string">'The following metabolites are duplicates:'</span>;
0696     dispEM(EM,~ignoreErrors,model.mets(I));
0697 
0698     <span class="comment">%Check that there are no metabolite IDs which are numbers. This would</span>
0699     <span class="comment">%give errors when parsing the equations</span>
0700     I=cellfun(@str2double,model.mets);
0701     EM=<span class="string">'The following metabolites have names which cannot be distinguished from numbers:'</span>;
0702     dispEM(EM,~ignoreErrors,model.mets(~isnan(I)));
0703     I=cellfun(@str2double,metReplacement);
0704     EM=<span class="string">'The following metabolites have names which cannot be distinguished from numbers:'</span>;
0705     dispEM(EM,~ignoreErrors,metReplacement(~isnan(I)));
0706 
0707     <span class="comment">%Replace the metabolite IDs for those IDs that have a corresponding</span>
0708     <span class="comment">%replacement metabolite. This is not used for matching, but will be checked</span>
0709     <span class="comment">%for consistency with SBML naming conventions</span>
0710     metsForParsing=model.mets; <span class="comment">%This is because the equations are written with this</span>
0711     I=cellfun(@any,metReplacement);
0712     model.mets(I)=metReplacement(I);
0713 
0714     <span class="comment">%If the metabolite name isn't set, replace it with the metabolite id</span>
0715     I=~cellfun(@any,model.metNames);
0716     model.metNames(I)=model.mets(I);
0717 
0718     <span class="comment">%Construct the metMiriams structure</span>
0719     model.metMiriams=<a href="#_sub1" class="code" title="subfunction miriamStruct=parseMiriam(strings,miriamStruct)">parseMiriam</a>(model.metMiriams);
0720 
0721     <span class="comment">%Either all metabolites have charge or none of them.</span>
0722     <span class="comment">%Check if it's only empty and if so return it to []</span>
0723     <span class="keyword">if</span> ~isempty(model.metCharges)
0724         <span class="keyword">if</span> all(cellfun(@isempty,model.metCharges))
0725             model.metCharges=[];
0726         <span class="keyword">end</span>
0727     <span class="keyword">end</span>
0728     <span class="keyword">if</span> ~isempty(model.metCharges)
0729         model.metCharges=str2double(model.metCharges);
0730     <span class="keyword">end</span>
0731 <span class="keyword">end</span>
0732 
0733 <span class="comment">%Everything seems fine with the metabolite IDs, compartments, genes, and</span>
0734 <span class="comment">%reactions</span>
0735 
0736 <span class="comment">%Parse the equations</span>
0737 [model.S, mets, badRxns, model.rev]=constructS(equations,metsForParsing,model.rxns);
0738 model.rev=model.rev*1; <span class="comment">%Typecast to double</span>
0739 
0740 <span class="comment">%Add default constraints</span>
0741 model.lb(isnan(model.lb))=model.annotation.defaultLB.*model.rev(isnan(model.lb));
0742 model.ub(isnan(model.ub))=model.annotation.defaultUB;
0743 
0744 <span class="comment">%Reorder the S matrix so that it fits with the metabolite list in the</span>
0745 <span class="comment">%structure</span>
0746 [~, I]=ismember(mets,metsForParsing);
0747 model.S=model.S(I,:);
0748 
0749 <span class="comment">%Print warnings about the reactions which contain the same metabolite as</span>
0750 <span class="comment">%both reactants and products</span>
0751 EM=<span class="string">'The following reactions have metabolites which are present more than once. Only the net reactions will be exported:'</span>;
0752 dispEM(EM,false,model.rxns(badRxns));
0753 
0754 model.b=zeros(numel(model.mets),1);
0755 
0756 <span class="comment">%Remove unused fields</span>
0757 <span class="keyword">if</span> all(cellfun(@isempty,model.compOutside))
0758     model=rmfield(model,<span class="string">'compOutside'</span>);
0759 <span class="keyword">end</span>
0760 <span class="keyword">if</span> all(cellfun(@isempty,model.compMiriams))
0761     model=rmfield(model,<span class="string">'compMiriams'</span>);
0762 <span class="keyword">end</span>
0763 <span class="keyword">if</span> all(cellfun(@isempty,model.rxnNames))
0764     model=rmfield(model,<span class="string">'rxnNames'</span>);
0765 <span class="keyword">end</span>
0766 <span class="keyword">if</span> isempty(model.rxnComps)
0767     model=rmfield(model,<span class="string">'rxnComps'</span>);
0768 <span class="keyword">end</span>
0769 <span class="keyword">if</span> all(cellfun(@isempty,model.grRules))
0770     model=rmfield(model,<span class="string">'grRules'</span>);
0771 <span class="keyword">end</span>
0772 <span class="keyword">if</span> isfield(model,<span class="string">'rxnGeneMat'</span>) &amp;&amp; isempty(model.rxnGeneMat)
0773     model=rmfield(model,<span class="string">'rxnGeneMat'</span>);
0774 <span class="keyword">end</span>
0775 <span class="keyword">if</span> all(cellfun(@isempty,model.subSystems))
0776     model=rmfield(model,<span class="string">'subSystems'</span>);
0777 <span class="keyword">end</span>
0778 <span class="keyword">if</span> all(cellfun(@isempty,model.eccodes))
0779     model=rmfield(model,<span class="string">'eccodes'</span>);
0780 <span class="keyword">end</span>
0781 <span class="keyword">if</span> all(cellfun(@isempty,model.rxnMiriams))
0782     model=rmfield(model,<span class="string">'rxnMiriams'</span>);
0783 <span class="keyword">end</span>
0784 <span class="keyword">if</span> all(cellfun(@isempty,model.rxnNotes))
0785     model=rmfield(model,<span class="string">'rxnNotes'</span>);
0786 <span class="keyword">end</span>
0787 <span class="keyword">if</span> all(cellfun(@isempty,model.rxnReferences))
0788     model=rmfield(model,<span class="string">'rxnReferences'</span>);
0789 <span class="keyword">end</span>
0790 <span class="keyword">if</span> all(cellfun(@isempty,model.rxnConfidenceScores))
0791     model=rmfield(model,<span class="string">'rxnConfidenceScores'</span>);
0792 <span class="keyword">end</span>
0793 <span class="keyword">if</span> isempty(model.genes)
0794     model=rmfield(model,<span class="string">'genes'</span>);
0795 <span class="keyword">end</span>
0796 <span class="keyword">if</span> isempty(model.geneComps)
0797     model=rmfield(model,<span class="string">'geneComps'</span>);
0798 <span class="keyword">end</span>
0799 <span class="keyword">if</span> isempty(model.geneMiriams)
0800     model=rmfield(model,<span class="string">'geneMiriams'</span>);
0801 <span class="keyword">end</span>
0802 <span class="keyword">if</span> all(cellfun(@isempty,model.geneShortNames))
0803     model=rmfield(model,<span class="string">'geneShortNames'</span>);
0804 <span class="keyword">end</span>
0805 <span class="keyword">if</span> all(cellfun(@isempty,model.inchis))
0806     model=rmfield(model,<span class="string">'inchis'</span>);
0807 <span class="keyword">end</span>
0808 <span class="keyword">if</span> all(cellfun(@isempty,model.metFormulas))
0809     model=rmfield(model,<span class="string">'metFormulas'</span>);
0810 <span class="keyword">end</span>
0811 <span class="keyword">if</span> all(cellfun(@isempty,model.metMiriams))
0812     model=rmfield(model,<span class="string">'metMiriams'</span>);
0813 <span class="keyword">end</span>
0814 <span class="keyword">if</span> isempty(model.metCharges)
0815     model=rmfield(model,<span class="string">'metCharges'</span>);
0816 <span class="keyword">end</span>
0817 
0818 <span class="comment">%The model structure has now been reconstructed but it can still contain</span>
0819 <span class="comment">%many types of errors. The checkModelConsistency function is used to make</span>
0820 <span class="comment">%sure that naming and mapping of stuff looks good</span>
0821 checkModelStruct(model,~ignoreErrors);
0822 
0823 <span class="keyword">if</span> removeExcMets==true
0824     model=simplifyModel(model);
0825 <span class="keyword">end</span>
0826 <span class="keyword">end</span>
0827 
0828 <a name="_sub1" href="#_subfunctions" class="code">function miriamStruct=parseMiriam(strings,miriamStruct)</a>
0829 <span class="comment">%Gets the names and values of Miriam-string. Nothing fancy at all, just to</span>
0830 <span class="comment">%prevent using the same code for metabolites, genes, and reactions. The</span>
0831 <span class="comment">%function also allows for supplying a miriamStruct and the info will then</span>
0832 <span class="comment">%be added</span>
0833 
0834 <span class="keyword">if</span> nargin&lt;2
0835     miriamStruct=cell(numel(strings),1);
0836 <span class="keyword">end</span>
0837 <span class="keyword">for</span> i=1:numel(strings)
0838     <span class="keyword">if</span> any(strings{i})
0839         <span class="comment">%A Miriam string can be several ids separated by &quot;;&quot;. Each id is</span>
0840         <span class="comment">%&quot;name(..:..)/value&quot;; an old format when value is separated by</span>
0841         <span class="comment">%colon is also supported</span>
0842         I=regexp(strings{i},<span class="string">';'</span>,<span class="string">'split'</span>);
0843         <span class="keyword">if</span> isfield(miriamStruct{i},<span class="string">'name'</span>)
0844             startIndex=numel(miriamStruct{i}.name);
0845             miriamStruct{i}.name=[miriamStruct{i}.name;cell(numel(I),1)];
0846             miriamStruct{i}.value=[miriamStruct{i}.value;cell(numel(I),1)];
0847         <span class="keyword">else</span>
0848             startIndex=0;
0849             miriamStruct{i}.name=cell(numel(I),1);
0850             miriamStruct{i}.value=cell(numel(I),1);
0851         <span class="keyword">end</span>
0852 
0853         <span class="keyword">for</span> j=1:numel(I)  
0854             <span class="keyword">if</span> any(strfind(I{j},<span class="string">'/'</span>))
0855                 index=max(strfind(I{j},<span class="string">'/'</span>));
0856             <span class="keyword">elseif</span> any(strfind(I{j},<span class="string">':'</span>))            
0857                 index=max(strfind(I{j},<span class="string">':'</span>));
0858             <span class="keyword">end</span>
0859             <span class="keyword">if</span> any(index)
0860                 miriamStruct{i}.name{startIndex+j}=I{j}(1:index-1);               
0861                 miriamStruct{i}.value{startIndex+j}=I{j}(index+1:end);
0862             <span class="keyword">else</span>
0863                 EM=[<span class="string">'&quot;'</span> I{j} <span class="string">'&quot; is not a valid MIRIAM string. The format must be &quot;identifier/value&quot; or identifier:value'</span>];
0864                 dispEM(EM);
0865             <span class="keyword">end</span>
0866         <span class="keyword">end</span>
0867     <span class="keyword">end</span>
0868 <span class="keyword">end</span>
0869 <span class="keyword">end</span>
0870 
0871 <span class="comment">%For converting a value to string. This is used instead of num2str because</span>
0872 <span class="comment">%I want to convert empty cells to {''}.</span>
0873 <a name="_sub2" href="#_subfunctions" class="code">function y=toStr(x)</a>
0874     <span class="comment">%x can be empty, numerical, string or boolean. It cannot be NaN.</span>
0875     <span class="comment">%Boolean values will be converted to '1'/'0'</span>
0876     <span class="keyword">if</span> isempty(x)
0877         y=<span class="string">''</span>;
0878     <span class="keyword">else</span>
0879         y=num2str(x);
0880     <span class="keyword">end</span>
0881 <span class="keyword">end</span>
0882 
0883 <span class="comment">%For converting to numeric. This is used instead of str2num because I want</span>
0884 <span class="comment">%to be able to choose what empty values should be mapped to.</span>
0885 <span class="comment">%</span>
0886 <span class="comment">% default the value to use for empty input</span>
0887 <a name="_sub3" href="#_subfunctions" class="code">function y=toDouble(x,default)</a>
0888     <span class="keyword">if</span> isempty(x) <span class="comment">%Note that this catches '' as well</span>
0889         y=default;
0890     <span class="keyword">else</span>
0891         <span class="keyword">if</span> isnumeric(x)
0892             y=x;
0893         <span class="keyword">else</span>
0894             y=str2double(x);
0895 
0896             <span class="comment">%This happens if the input couldn't be converted.</span>
0897             <span class="comment">%Note that the input itself cannot be NaN since it was fixed in</span>
0898             <span class="comment">%clean imported</span>
0899             <span class="keyword">if</span> isnan(y)
0900                 EM=[<span class="string">'Cannot convert the string &quot;'</span> x <span class="string">'&quot; to double'</span>];
0901                 dispEM(EM);
0902             <span class="keyword">end</span>
0903         <span class="keyword">end</span>
0904     <span class="keyword">end</span>
0905 <span class="keyword">end</span>
0906 
0907 <span class="comment">%For converting boolean (the UNCONSTRAINED field) to double (the</span>
0908 <span class="comment">%model.unconstrained field)</span>
0909 <a name="_sub4" href="#_subfunctions" class="code">function y=boolToDouble(x)</a>
0910     <span class="keyword">if</span> isempty(x)
0911         y=0;
0912         <span class="keyword">return</span>;
0913     <span class="keyword">end</span>
0914     <span class="keyword">if</span> islogical(x)
0915         y=x*1; <span class="comment">%Typecast to double</span>
0916         <span class="keyword">return</span>;
0917     <span class="keyword">end</span>
0918     <span class="keyword">if</span> isnumeric(x)
0919        <span class="keyword">if</span> x~=0
0920            y=1;
0921            <span class="keyword">return</span>;
0922        <span class="keyword">else</span>
0923            y=0;
0924            <span class="keyword">return</span>;
0925        <span class="keyword">end</span>
0926     <span class="keyword">end</span>
0927     <span class="keyword">if</span> ischar(x)
0928        <span class="keyword">if</span> strcmpi(x,<span class="string">'TRUE'</span>)
0929            y=1;
0930            <span class="keyword">return</span>;
0931        <span class="keyword">end</span>
0932        <span class="keyword">if</span> strcmpi(x,<span class="string">'FALSE'</span>)
0933            y=0;
0934            <span class="keyword">return</span>;
0935        <span class="keyword">end</span>
0936     <span class="keyword">end</span>
0937     y=NaN; <span class="comment">%This means that the input couldn't be parsed</span>
0938 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Thu 28-Dec-2017 10:46:27 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>