<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of importExcelModel</title>
  <meta name="keywords" content="importExcelModel">
  <meta name="description" content="importExcelModel">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">io</a> &gt; importExcelModel.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for io&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>importExcelModel
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>importExcelModel</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function model=importExcelModel(fileName,removeExcMets,printWarnings,ignoreErrors) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> importExcelModel
   Imports a constraint-based model from a Excel file

   fileName      a Microsoft Excel file to import
   removeExcMets true if exchange metabolites should be removed. This is
                 needed to be able to run simulations, but it could also
                 be done using simplifyModel at a later stage (opt,
                 default true)
   printWarnings true if warnings should be printed (opt, default true)
   ignoreErrors  true if errors should be ignored. See below for details
                 (opt, default false)

   model
       annotation       
           taxonomy     String with the NCBI Taxonomy ID, as valid
                        identifiers.org annotation
           defaultLB     Double    with the default lower bound values for reactions
           defaultUB     Double    with the default upper bound values for reactions
           givenName     String    with the name of the main model author
           familyName     String    with the surname of the main model author
           email        String    with the e-mail address of the main model author
           organization String    with the organization of the main model author
           note         String    with additional comments about the model
       description      description of model contents
       id               model ID
       rxns             reaction ids
       mets             metabolite ids
       S                stoichiometric matrix
       lb               lower bounds
       ub               upper bounds
       rev              reversibility vector
       c                objective coefficients
       b                equality constraints for the metabolite equations
       comps            compartment ids
       compNames        compartment names
       compOutside      the id (as in comps) for the compartment
                        surrounding each of the compartments
       compMiriams      structure with MIRIAM information about the
                        compartments
       rxnNames         reaction description
       rxnComps         compartments for reactions
       grRules          reaction to gene rules in text form
       rxnGeneMat       reaction-to-gene mapping in sparse matrix form
       subSystems       subsystem name for each reaction
       eccodes          EC-codes for the reactions
       rxnMiriams       structure with MIRIAM information about the reactions
       rxnNotes         reaction notes
       rxnReferences    reaction references
       rxnConfidenceScores reaction confidence scores
       genes            list of all genes
       geneComps        compartments for genes
       geneMiriams      structure with MIRIAM information about the genes
       geneShortNames   gene alternative names (e.g. ERG10)
       metNames         metabolite description
       metComps         compartments for metabolites
       inchis           InChI-codes for metabolites
       metFormulas      metabolite chemical formula
       metMiriams       structure with MIRIAM information about the metabolites
       metCharges       metabolite charge
       unconstrained    true if the metabolite is an exchange metabolite

   Loads models in the RAVEN Toolbox Excel format. A number of consistency
   checks are performed in order to ensure that the model is valid. These
   can be ignored by putting ignoreErrors to true. However, this is highly
   advised against, as it can result in errors in simulations or other
   functionalities. The RAVEN Toolbox is made to function only on consistent
   models, and the only checks performed are when the model is imported.

   NOTE: Most errors are checked for by checkModelStruct, but some
   are checked for in this function as well. Those are ones which relate
   to missing model elements and so on, and which would make it impossible
   to construct the model structure. Those errors cannot be ignored by
   setting ignoreErrors to true.

   Usage: model=importExcelModel(fileName,removeExcMets,printWarnings,ignoreErrors)

   Eduard Kerkhoven        2018-05-18
   Benjamin J. Sanchez     2018-09-24</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="cleanSheet.html" class="code" title="function [raw,keptRows,keptCols]=cleanSheet(raw,removeComments,removeOnlyCap,removeNoCap,removeEmptyRows)">cleanSheet</a>	cleanSheet</li><li><a href="loadSheet.html" class="code" title="function [raw, flag]=loadSheet(workbook, sheet)">loadSheet</a>	loadSheet</li><li><a href="loadWorkbook.html" class="code" title="function workbook=loadWorkbook(fileName,createEmpty)">loadWorkbook</a>	loadWorkbook</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="SBMLFromExcel.html" class="code" title="function SBMLFromExcel(fileName, outputFileName,toCOBRA,printWarnings)">SBMLFromExcel</a>	SBMLFromExcel</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function miriamStruct=parseMiriam(strings,miriamStruct)</a></li><li><a href="#_sub2" class="code">function y=toStr(x)</a></li><li><a href="#_sub3" class="code">function y=toDouble(x,default)</a></li><li><a href="#_sub4" class="code">function y=boolToDouble(x)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function model=importExcelModel(fileName,removeExcMets,printWarnings,ignoreErrors)</a>
0002 <span class="comment">% importExcelModel</span>
0003 <span class="comment">%   Imports a constraint-based model from a Excel file</span>
0004 <span class="comment">%</span>
0005 <span class="comment">%   fileName      a Microsoft Excel file to import</span>
0006 <span class="comment">%   removeExcMets true if exchange metabolites should be removed. This is</span>
0007 <span class="comment">%                 needed to be able to run simulations, but it could also</span>
0008 <span class="comment">%                 be done using simplifyModel at a later stage (opt,</span>
0009 <span class="comment">%                 default true)</span>
0010 <span class="comment">%   printWarnings true if warnings should be printed (opt, default true)</span>
0011 <span class="comment">%   ignoreErrors  true if errors should be ignored. See below for details</span>
0012 <span class="comment">%                 (opt, default false)</span>
0013 <span class="comment">%</span>
0014 <span class="comment">%   model</span>
0015 <span class="comment">%       annotation</span>
0016 <span class="comment">%           taxonomy     String with the NCBI Taxonomy ID, as valid</span>
0017 <span class="comment">%                        identifiers.org annotation</span>
0018 <span class="comment">%           defaultLB     Double    with the default lower bound values for reactions</span>
0019 <span class="comment">%           defaultUB     Double    with the default upper bound values for reactions</span>
0020 <span class="comment">%           givenName     String    with the name of the main model author</span>
0021 <span class="comment">%           familyName     String    with the surname of the main model author</span>
0022 <span class="comment">%           email        String    with the e-mail address of the main model author</span>
0023 <span class="comment">%           organization String    with the organization of the main model author</span>
0024 <span class="comment">%           note         String    with additional comments about the model</span>
0025 <span class="comment">%       description      description of model contents</span>
0026 <span class="comment">%       id               model ID</span>
0027 <span class="comment">%       rxns             reaction ids</span>
0028 <span class="comment">%       mets             metabolite ids</span>
0029 <span class="comment">%       S                stoichiometric matrix</span>
0030 <span class="comment">%       lb               lower bounds</span>
0031 <span class="comment">%       ub               upper bounds</span>
0032 <span class="comment">%       rev              reversibility vector</span>
0033 <span class="comment">%       c                objective coefficients</span>
0034 <span class="comment">%       b                equality constraints for the metabolite equations</span>
0035 <span class="comment">%       comps            compartment ids</span>
0036 <span class="comment">%       compNames        compartment names</span>
0037 <span class="comment">%       compOutside      the id (as in comps) for the compartment</span>
0038 <span class="comment">%                        surrounding each of the compartments</span>
0039 <span class="comment">%       compMiriams      structure with MIRIAM information about the</span>
0040 <span class="comment">%                        compartments</span>
0041 <span class="comment">%       rxnNames         reaction description</span>
0042 <span class="comment">%       rxnComps         compartments for reactions</span>
0043 <span class="comment">%       grRules          reaction to gene rules in text form</span>
0044 <span class="comment">%       rxnGeneMat       reaction-to-gene mapping in sparse matrix form</span>
0045 <span class="comment">%       subSystems       subsystem name for each reaction</span>
0046 <span class="comment">%       eccodes          EC-codes for the reactions</span>
0047 <span class="comment">%       rxnMiriams       structure with MIRIAM information about the reactions</span>
0048 <span class="comment">%       rxnNotes         reaction notes</span>
0049 <span class="comment">%       rxnReferences    reaction references</span>
0050 <span class="comment">%       rxnConfidenceScores reaction confidence scores</span>
0051 <span class="comment">%       genes            list of all genes</span>
0052 <span class="comment">%       geneComps        compartments for genes</span>
0053 <span class="comment">%       geneMiriams      structure with MIRIAM information about the genes</span>
0054 <span class="comment">%       geneShortNames   gene alternative names (e.g. ERG10)</span>
0055 <span class="comment">%       metNames         metabolite description</span>
0056 <span class="comment">%       metComps         compartments for metabolites</span>
0057 <span class="comment">%       inchis           InChI-codes for metabolites</span>
0058 <span class="comment">%       metFormulas      metabolite chemical formula</span>
0059 <span class="comment">%       metMiriams       structure with MIRIAM information about the metabolites</span>
0060 <span class="comment">%       metCharges       metabolite charge</span>
0061 <span class="comment">%       unconstrained    true if the metabolite is an exchange metabolite</span>
0062 <span class="comment">%</span>
0063 <span class="comment">%   Loads models in the RAVEN Toolbox Excel format. A number of consistency</span>
0064 <span class="comment">%   checks are performed in order to ensure that the model is valid. These</span>
0065 <span class="comment">%   can be ignored by putting ignoreErrors to true. However, this is highly</span>
0066 <span class="comment">%   advised against, as it can result in errors in simulations or other</span>
0067 <span class="comment">%   functionalities. The RAVEN Toolbox is made to function only on consistent</span>
0068 <span class="comment">%   models, and the only checks performed are when the model is imported.</span>
0069 <span class="comment">%</span>
0070 <span class="comment">%   NOTE: Most errors are checked for by checkModelStruct, but some</span>
0071 <span class="comment">%   are checked for in this function as well. Those are ones which relate</span>
0072 <span class="comment">%   to missing model elements and so on, and which would make it impossible</span>
0073 <span class="comment">%   to construct the model structure. Those errors cannot be ignored by</span>
0074 <span class="comment">%   setting ignoreErrors to true.</span>
0075 <span class="comment">%</span>
0076 <span class="comment">%   Usage: model=importExcelModel(fileName,removeExcMets,printWarnings,ignoreErrors)</span>
0077 <span class="comment">%</span>
0078 <span class="comment">%   Eduard Kerkhoven        2018-05-18</span>
0079 <span class="comment">%   Benjamin J. Sanchez     2018-09-24</span>
0080 <span class="comment">%</span>
0081 
0082 <span class="keyword">if</span> nargin&lt;2
0083     removeExcMets=true;
0084 <span class="keyword">end</span>
0085 <span class="keyword">if</span> nargin&lt;3
0086     printWarnings=true;
0087 <span class="keyword">end</span>
0088 <span class="keyword">if</span> nargin&lt;4
0089     ignoreErrors=false;
0090 <span class="keyword">end</span>
0091 
0092 <span class="keyword">if</span> ~(exist(fileName,<span class="string">'file'</span>)==2)
0093     error(<span class="string">'Excel file %s cannot be found'</span>,string(fileName));
0094 <span class="keyword">end</span>
0095 
0096 <span class="comment">%This is to match the order of the fields to those you get from importing</span>
0097 <span class="comment">%from SBML</span>
0098 model=[];
0099 model.id=[];
0100 model.description=[];
0101 model.annotation=[];
0102 <span class="comment">%Default bounds if not defined</span>
0103 model.annotation.defaultLB=-1000;
0104 model.annotation.defaultUB=1000;
0105 model.rxns={};
0106 model.mets={};
0107 model.S=[];
0108 model.lb=[];
0109 model.ub=[];
0110 model.rev=[];
0111 model.c=[];
0112 model.b=[];
0113 model.comps={};
0114 model.compNames={};
0115 model.compOutside={};
0116 model.compMiriams={};
0117 model.rxnNames={};
0118 model.rxnComps={}; <span class="comment">%Will be double later</span>
0119 model.grRules={};
0120 model.rxnGeneMat=[];
0121 model.subSystems={};
0122 model.eccodes={};
0123 model.rxnMiriams={};
0124 model.rxnNotes={};
0125 model.rxnReferences={};
0126 model.rxnConfidenceScores={}; <span class="comment">%Will be double later</span>
0127 model.genes={};
0128 model.geneComps={}; <span class="comment">%Will be double later</span>
0129 model.geneMiriams={};
0130 model.geneShortNames={};
0131 model.metNames={};
0132 model.metComps=[];
0133 model.inchis={};
0134 model.metFormulas={};
0135 model.metMiriams={};
0136 model.metCharges={}; <span class="comment">%Will be double later</span>
0137 model.unconstrained=[];
0138 
0139 workbook=<a href="loadWorkbook.html" class="code" title="function workbook=loadWorkbook(fileName,createEmpty)">loadWorkbook</a>(fileName);
0140 
0141 [raw, flag]=<a href="loadSheet.html" class="code" title="function [raw, flag]=loadSheet(workbook, sheet)">loadSheet</a>(workbook,<span class="string">'MODEL'</span>);
0142 
0143 <span class="keyword">if</span> flag&lt;0
0144     <span class="keyword">if</span> printWarnings==true
0145         EM=<span class="string">'Could not load the MODEL sheet'</span>;
0146         dispEM(EM,false);
0147     <span class="keyword">end</span>
0148     model.id=<span class="string">'UNKNOWN'</span>;
0149     model.description=<span class="string">'No model details available'</span>;
0150 <span class="keyword">else</span>
0151     raw=<a href="cleanSheet.html" class="code" title="function [raw,keptRows,keptCols]=cleanSheet(raw,removeComments,removeOnlyCap,removeNoCap,removeEmptyRows)">cleanSheet</a>(raw);
0152     
0153     <span class="comment">%It is assumed that the first line is labels and that the second one is</span>
0154     <span class="comment">%info</span>
0155     raw(1,:)=upper(raw(1,:));
0156     raw(1,:)=strrep(raw(1,:),<span class="string">'MODELID'</span>,<span class="string">'ID'</span>);
0157     raw(1,:)=strrep(raw(1,:),<span class="string">'MODELNAME'</span>,<span class="string">'DESCRIPTION'</span>);
0158     
0159     <span class="comment">%Loop through the labels</span>
0160     <span class="keyword">for</span> i=1:numel(raw(1,:))
0161         <span class="keyword">switch</span> raw{1,i}
0162             <span class="keyword">case</span> <span class="string">'ID'</span>
0163                 <span class="keyword">if</span> any(raw{2,i})
0164                     model.id=<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>(raw{2,i}); <span class="comment">%Should be string already</span>
0165                 <span class="keyword">else</span>
0166                     EM=<span class="string">'No model ID supplied'</span>;
0167                     dispEM(EM);
0168                 <span class="keyword">end</span>
0169             <span class="keyword">case</span> <span class="string">'DESCRIPTION'</span>
0170                 <span class="keyword">if</span> any(raw{2,i})
0171                     model.description=<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>(raw{2,i}); <span class="comment">%Should be string already</span>
0172                 <span class="keyword">else</span>
0173                     EM=<span class="string">'No model name supplied'</span>;
0174                     dispEM(EM);
0175                 <span class="keyword">end</span>
0176             <span class="keyword">case</span> <span class="string">'DEFAULT LOWER'</span>
0177                 <span class="keyword">if</span> ~isempty(raw{2,i})
0178                     <span class="keyword">try</span>
0179                         model.annotation.defaultLB=<a href="#_sub3" class="code" title="subfunction y=toDouble(x,default)">toDouble</a>(raw{2,i},NaN);
0180                     <span class="keyword">catch</span>
0181                         EM=<span class="string">'DEFAULT LOWER must be numeric'</span>;
0182                         dispEM(EM);
0183                     <span class="keyword">end</span>
0184                 <span class="keyword">else</span>
0185                     <span class="keyword">if</span> printWarnings==true
0186                         fprintf(<span class="string">'NOTE: DEFAULT LOWER not supplied. Uses -1000\n'</span>);
0187                     <span class="keyword">end</span>
0188                     model.annotation.defaultLB=-1000;
0189                 <span class="keyword">end</span>
0190             <span class="keyword">case</span> <span class="string">'DEFAULT UPPER'</span>
0191                 <span class="keyword">if</span> ~isempty(raw{2,i})
0192                     <span class="keyword">try</span>
0193                         model.annotation.defaultUB=<a href="#_sub3" class="code" title="subfunction y=toDouble(x,default)">toDouble</a>(raw{2,i},NaN);
0194                     <span class="keyword">catch</span>
0195                         EM=<span class="string">'DEFAULT UPPER must be numeric'</span>;
0196                         dispEM(EM);
0197                     <span class="keyword">end</span>
0198                 <span class="keyword">else</span>
0199                     <span class="keyword">if</span> printWarnings==true
0200                         fprintf(<span class="string">'NOTE: DEFAULT UPPER not supplied. Uses 1000\n'</span>);
0201                     <span class="keyword">end</span>
0202                     model.annotation.defaultUB=1000;
0203                 <span class="keyword">end</span>
0204             <span class="keyword">case</span> <span class="string">'TAXONOMY'</span>
0205                 <span class="keyword">if</span> any(raw{2,i})
0206                     model.annotation.taxonomy=<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>(raw{2,i}); <span class="comment">%Should be string already</span>
0207                 <span class="keyword">end</span>
0208             <span class="keyword">case</span> <span class="string">'CONTACT GIVEN NAME'</span>
0209                 <span class="keyword">if</span> any(raw{2,i})
0210                     model.annotation.givenName=<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>(raw{2,i}); <span class="comment">%Should be string already</span>
0211                 <span class="keyword">end</span>
0212             <span class="keyword">case</span> <span class="string">'CONTACT FAMILY NAME'</span>
0213                 <span class="keyword">if</span> any(raw{2,i})
0214                     model.annotation.familyName=<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>(raw{2,i}); <span class="comment">%Should be string already</span>
0215                 <span class="keyword">end</span>
0216             <span class="keyword">case</span> <span class="string">'CONTACT EMAIL'</span>
0217                 <span class="keyword">if</span> any(raw{2,i})
0218                     model.annotation.email=<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>(raw{2,i}); <span class="comment">%Should be string already</span>
0219                 <span class="keyword">end</span>
0220             <span class="keyword">case</span> <span class="string">'ORGANIZATION'</span>
0221                 <span class="keyword">if</span> any(raw{2,i})
0222                     model.annotation.organization=<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>(raw{2,i}); <span class="comment">%Should be string already</span>
0223                 <span class="keyword">end</span>
0224             <span class="keyword">case</span> <span class="string">'NOTES'</span>
0225                 <span class="keyword">if</span> any(raw{2,i})
0226                     model.annotation.note=<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>(raw{2,i}); <span class="comment">%Should be string already</span>
0227                 <span class="keyword">end</span>
0228         <span class="keyword">end</span>
0229     <span class="keyword">end</span>
0230 <span class="keyword">end</span>
0231 
0232 <span class="comment">%Get compartment information</span>
0233 [raw, flag]=<a href="loadSheet.html" class="code" title="function [raw, flag]=loadSheet(workbook, sheet)">loadSheet</a>(workbook,<span class="string">'COMPS'</span>);
0234 
0235 <span class="keyword">if</span> flag&lt;0
0236     <span class="keyword">if</span> printWarnings==true
0237         EM=<span class="string">'Could not load the COMPS sheet. All elements will be assigned to a compartment &quot;s&quot; for &quot;System&quot;'</span>;
0238         dispEM(EM,false);
0239     <span class="keyword">end</span>
0240     model.comps={<span class="string">'s'</span>};
0241     model.compNames={<span class="string">'System'</span>};
0242 <span class="keyword">else</span>
0243     raw=<a href="cleanSheet.html" class="code" title="function [raw,keptRows,keptCols]=cleanSheet(raw,removeComments,removeOnlyCap,removeNoCap,removeEmptyRows)">cleanSheet</a>(raw);
0244     
0245     <span class="comment">%Map to new captions</span>
0246     raw(1,:)=upper(raw(1,:));
0247     raw(1,:)=strrep(raw(1,:),<span class="string">'COMPABBREV'</span>,<span class="string">'ABBREVIATION'</span>);
0248     raw(1,:)=strrep(raw(1,:),<span class="string">'COMPNAME'</span>,<span class="string">'NAME'</span>);
0249         
0250     <span class="comment">%Loop through the labels</span>
0251     <span class="keyword">for</span> i=1:numel(raw(1,:))
0252         <span class="keyword">switch</span> raw{1,i}
0253             <span class="keyword">case</span> <span class="string">'ABBREVIATION'</span>
0254                 model.comps=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,i),<span class="string">'UniformOutput'</span>,false);
0255             <span class="keyword">case</span> <span class="string">'NAME'</span>
0256                 model.compNames=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,i),<span class="string">'UniformOutput'</span>,false);
0257             <span class="keyword">case</span> <span class="string">'INSIDE'</span>
0258                 model.compOutside=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,i),<span class="string">'UniformOutput'</span>,false);
0259             <span class="keyword">case</span> <span class="string">'MIRIAM'</span>
0260                 model.compMiriams=raw(2:<span class="keyword">end</span>,i);
0261         <span class="keyword">end</span>
0262     <span class="keyword">end</span>
0263     
0264     <span class="comment">%Check that necessary fields are loaded</span>
0265     <span class="keyword">if</span> isempty(model.comps)
0266         EM=<span class="string">'There must be a column named ABBREVIATION in the COMPS sheet'</span>;
0267         dispEM(EM);
0268     <span class="keyword">end</span>
0269     <span class="keyword">if</span> isempty(model.compNames)
0270         model.compNames=model.comps;
0271         <span class="keyword">if</span> printWarnings==true
0272             EM=<span class="string">'There is no column named NAME in the COMPS sheet. ABBREVIATION will be used as name'</span>;
0273             dispEM(EM,false);
0274         <span class="keyword">end</span>
0275     <span class="keyword">end</span>
0276     model.compMiriams=<a href="#_sub1" class="code" title="subfunction miriamStruct=parseMiriam(strings,miriamStruct)">parseMiriam</a>(model.compMiriams);
0277 <span class="keyword">end</span>
0278 
0279 <span class="comment">%Get all the genes and info about them</span>
0280 [raw, flag]=<a href="loadSheet.html" class="code" title="function [raw, flag]=loadSheet(workbook, sheet)">loadSheet</a>(workbook,<span class="string">'GENES'</span>);
0281 
0282 <span class="keyword">if</span> flag&lt;0
0283     <span class="keyword">if</span> printWarnings==true
0284         EM=<span class="string">'There is no spreadsheet named GENES'</span>;
0285         dispEM(EM,false)
0286     <span class="keyword">end</span>
0287 <span class="keyword">else</span>
0288     raw=<a href="cleanSheet.html" class="code" title="function [raw,keptRows,keptCols]=cleanSheet(raw,removeComments,removeOnlyCap,removeNoCap,removeEmptyRows)">cleanSheet</a>(raw);
0289     
0290     <span class="comment">%Map to new captions</span>
0291     raw(1,:)=upper(raw(1,:));
0292     raw(1,:)=strrep(raw(1,:),<span class="string">'GENE NAME'</span>,<span class="string">'NAME'</span>);
0293         
0294     <span class="comment">%Loop through the labels</span>
0295     foundGenes=false;
0296     <span class="keyword">for</span> i=1:numel(raw(1,:))
0297         <span class="keyword">switch</span> raw{1,i}
0298             <span class="keyword">case</span> <span class="string">'NAME'</span>
0299                 model.genes=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,i),<span class="string">'UniformOutput'</span>,false);
0300                 foundGenes=true;
0301             <span class="keyword">case</span> <span class="string">'MIRIAM'</span>
0302                 model.geneMiriams=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,i),<span class="string">'UniformOutput'</span>,false);
0303             <span class="keyword">case</span> <span class="string">'SHORT NAME'</span>
0304                 model.geneShortNames=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,i),<span class="string">'UniformOutput'</span>,false);
0305             <span class="keyword">case</span> <span class="string">'COMPARTMENT'</span>
0306                 model.geneComps=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,i),<span class="string">'UniformOutput'</span>,false);
0307         <span class="keyword">end</span>
0308     <span class="keyword">end</span>
0309     
0310     <span class="keyword">if</span> foundGenes==false
0311         EM=<span class="string">'There must be a column named NAME in the GENES sheet'</span>;
0312         dispEM(EM);
0313     <span class="keyword">end</span>
0314     
0315     <span class="comment">%Its ok if all of them are empty</span>
0316     <span class="keyword">if</span> all(cellfun(@isempty,model.geneComps))
0317         model.geneComps=[];
0318     <span class="keyword">end</span>
0319     
0320     <span class="comment">%Check that geneName contain only strings and no empty strings</span>
0321     <span class="keyword">if</span> ~iscellstr(model.genes)
0322         EM=<span class="string">'All gene names have to be strings'</span>;
0323         dispEM(EM);
0324     <span class="keyword">else</span>
0325         <span class="keyword">if</span> any(strcmp(<span class="string">''</span>,model.genes))
0326             EM=<span class="string">'There can be no empty strings in gene names'</span>;
0327             dispEM(EM);
0328         <span class="keyword">end</span>
0329     <span class="keyword">end</span>
0330     
0331     <span class="comment">%Check that geneComp contains only strings and no empty string</span>
0332     <span class="keyword">if</span> ~isempty(model.geneComps)
0333         <span class="keyword">if</span> ~iscellstr(model.geneComps)
0334             EM=<span class="string">'All gene compartments have to be strings'</span>;
0335             dispEM(EM);
0336         <span class="keyword">else</span>
0337             <span class="keyword">if</span> any(strcmp(<span class="string">''</span>,model.geneComps))
0338                 EM=<span class="string">'There can be no empty strings in gene compartments'</span>;
0339                 dispEM(EM);
0340             <span class="keyword">end</span>
0341         <span class="keyword">end</span>
0342         [I, model.geneComps]=ismember(model.geneComps,model.comps);
0343         EM=<span class="string">'The following genes have compartment abbreviations which could not be found:'</span>;
0344         dispEM(EM,true,model.genes(~I));
0345     <span class="keyword">end</span>
0346 <span class="keyword">end</span>
0347 
0348 model.geneMiriams=<a href="#_sub1" class="code" title="subfunction miriamStruct=parseMiriam(strings,miriamStruct)">parseMiriam</a>(model.geneMiriams);
0349 
0350 <span class="comment">%Loads the reaction data</span>
0351 [raw, flag]=<a href="loadSheet.html" class="code" title="function [raw, flag]=loadSheet(workbook, sheet)">loadSheet</a>(workbook,<span class="string">'RXNS'</span>);
0352 
0353 <span class="keyword">if</span> flag&lt;0
0354     EM=<span class="string">'Could not load the RXNS sheet'</span>;
0355     dispEM(EM);
0356 <span class="keyword">end</span>
0357 
0358 raw=<a href="cleanSheet.html" class="code" title="function [raw,keptRows,keptCols]=cleanSheet(raw,removeComments,removeOnlyCap,removeNoCap,removeEmptyRows)">cleanSheet</a>(raw);
0359 
0360 <span class="comment">%Map to new captions</span>
0361 raw(1,:)=upper(raw(1,:));
0362 raw(1,:)=strrep(raw(1,:),<span class="string">'RXNID'</span>,<span class="string">'ID'</span>);
0363 
0364 <span class="comment">%Loop through the labels</span>
0365 equations={};
0366 reactionReplacement={};
0367 <span class="keyword">for</span> i=1:numel(raw(1,:))
0368     <span class="keyword">switch</span> raw{1,i}
0369         <span class="keyword">case</span> <span class="string">'ID'</span>
0370             model.rxns=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,i),<span class="string">'UniformOutput'</span>,false);
0371         <span class="keyword">case</span> <span class="string">'NAME'</span>
0372             model.rxnNames=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,i),<span class="string">'UniformOutput'</span>,false);
0373         <span class="keyword">case</span> <span class="string">'EQUATION'</span>
0374             equations=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,i),<span class="string">'UniformOutput'</span>,false);
0375         <span class="keyword">case</span> <span class="string">'EC-NUMBER'</span>
0376             model.eccodes=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,i),<span class="string">'UniformOutput'</span>,false);
0377         <span class="keyword">case</span> <span class="string">'GENE ASSOCIATION'</span>
0378             model.grRules=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,i),<span class="string">'UniformOutput'</span>,false);
0379         <span class="keyword">case</span> <span class="string">'LOWER BOUND'</span>
0380             <span class="keyword">try</span>
0381                 model.lb=cellfun(@(x) <a href="#_sub3" class="code" title="subfunction y=toDouble(x,default)">toDouble</a>(x,NaN),raw(2:<span class="keyword">end</span>,i));
0382             <span class="keyword">catch</span>
0383                 EM=<span class="string">'The lower bounds must be numerical values'</span>;
0384                 dispEM(EM);
0385             <span class="keyword">end</span>
0386         <span class="keyword">case</span> <span class="string">'UPPER BOUND'</span>
0387             <span class="keyword">try</span>
0388                 model.ub=cellfun(@(x) <a href="#_sub3" class="code" title="subfunction y=toDouble(x,default)">toDouble</a>(x,NaN),raw(2:<span class="keyword">end</span>,i));
0389             <span class="keyword">catch</span>
0390                 EM=<span class="string">'The upper bounds must be numerical values'</span>;
0391                 dispEM(EM);
0392             <span class="keyword">end</span>
0393         <span class="keyword">case</span> <span class="string">'OBJECTIVE'</span>
0394             <span class="keyword">try</span>
0395                 model.c=cellfun(@(x) <a href="#_sub3" class="code" title="subfunction y=toDouble(x,default)">toDouble</a>(x,0),raw(2:<span class="keyword">end</span>,i));
0396             <span class="keyword">catch</span>
0397                 EM=<span class="string">'The objective coefficients must be numerical values'</span>;
0398                 dispEM(EM);
0399             <span class="keyword">end</span>
0400         <span class="keyword">case</span> <span class="string">'COMPARTMENT'</span>
0401             model.rxnComps=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,i),<span class="string">'UniformOutput'</span>,false);
0402         <span class="keyword">case</span> <span class="string">'SUBSYSTEM'</span>
0403             subsystems=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,i),<span class="string">'UniformOutput'</span>,false);
0404         <span class="keyword">case</span> <span class="string">'REPLACEMENT ID'</span>
0405             reactionReplacement=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,i),<span class="string">'UniformOutput'</span>,false);
0406         <span class="keyword">case</span> <span class="string">'MIRIAM'</span>
0407             model.rxnMiriams=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,i),<span class="string">'UniformOutput'</span>,false);
0408         <span class="keyword">case</span> <span class="string">'NOTE'</span>
0409             model.rxnNotes=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,i),<span class="string">'UniformOutput'</span>,false);
0410         <span class="keyword">case</span> <span class="string">'REFERENCE'</span>
0411             model.rxnReferences=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,i),<span class="string">'UniformOutput'</span>,false);
0412         <span class="keyword">case</span> <span class="string">'CONFIDENCE SCORE'</span>
0413             model.rxnConfidenceScores=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,i),<span class="string">'UniformOutput'</span>,false);
0414     <span class="keyword">end</span>
0415 <span class="keyword">end</span>
0416 
0417 <span class="keyword">if</span> ~isempty(model.rxnConfidenceScores)
0418     model.rxnConfidenceScores=str2double(model.rxnConfidenceScores);
0419 <span class="keyword">end</span>
0420 <span class="keyword">for</span> i=1:numel(subsystems)
0421     model.subSystems{i,1}=cellstr(strsplit(subsystems{i,1},<span class="string">';'</span>));
0422 <span class="keyword">end</span>
0423 
0424 <span class="comment">%Check that all necessary reaction info has been loaded</span>
0425 <span class="keyword">if</span> isempty(equations)
0426     EM=<span class="string">'There must be a column named EQUATION in the RXNS sheet'</span>;
0427     dispEM(EM);
0428 <span class="keyword">end</span>
0429 <span class="keyword">if</span> isempty(model.rxns)
0430     <span class="keyword">if</span> printWarnings==true
0431         EM=<span class="string">'There is no column named ID in the RXNS sheet. The reactions will be named as &quot;r1&quot;, &quot;r2&quot;...'</span>;
0432         dispEM(EM,false);
0433     <span class="keyword">end</span>
0434     I=num2cell((1:numel(equations))');
0435     model.rxns=strcat(<span class="string">'r'</span>,cellfun(@num2str,I,<span class="string">'UniformOutput'</span>,false));
0436 <span class="keyword">end</span>
0437 
0438 <span class="comment">%Check if some other stuff is loaded and populate with default values</span>
0439 <span class="comment">%otherwise</span>
0440 <span class="keyword">if</span> isempty(model.rxnNames)
0441     model.rxnNames=cell(numel(model.rxns),1);
0442     model.rxnNames(:)={<span class="string">''</span>};
0443     <span class="keyword">if</span> printWarnings==true
0444         EM=<span class="string">'There is no column named NAME in the RXNS sheet. Empty strings will be used as reaction names'</span>;
0445         dispEM(EM,false);
0446     <span class="keyword">end</span>
0447 <span class="keyword">end</span>
0448 <span class="keyword">if</span> isempty(model.lb)
0449     <span class="comment">%This is not set here since the reversibility isn't known yet</span>
0450     model.lb=nan(numel(model.rxns),1);
0451     <span class="keyword">if</span> printWarnings==true
0452         EM=<span class="string">'There is no column named LOWER BOUND in the RXNS sheet. Default bounds will be used'</span>;
0453         dispEM(EM,false);
0454     <span class="keyword">end</span>
0455 <span class="keyword">end</span>
0456 <span class="keyword">if</span> isempty(model.ub)
0457     model.ub=nan(numel(model.rxns),1);
0458     <span class="keyword">if</span> printWarnings==true
0459         EM=<span class="string">'There is no column named UPPER BOUND in the RXNS sheet. Default bounds will be used'</span>;
0460         dispEM(EM,false);
0461     <span class="keyword">end</span>
0462 <span class="keyword">end</span>
0463 <span class="keyword">if</span> isempty(model.c)
0464     model.c=zeros(numel(model.rxns),1);
0465     <span class="keyword">if</span> printWarnings==true
0466         EM=<span class="string">'There is no column named OBJECTIVE in the RXNS sheet'</span>;
0467         dispEM(EM,false);
0468     <span class="keyword">end</span>
0469 <span class="keyword">end</span>
0470 
0471 <span class="comment">%Either all reactions must have a compartment string or none of them. Check</span>
0472 <span class="comment">%if it's only empty and if so return it to []</span>
0473 <span class="keyword">if</span> ~isempty(model.rxnComps)
0474     <span class="keyword">if</span> all(cellfun(@isempty,model.rxnComps))
0475         model.rxnComps=[];
0476     <span class="keyword">end</span>
0477 <span class="keyword">end</span>
0478 
0479 <span class="comment">%Construct the rxnMiriams structure</span>
0480 model.rxnMiriams=<a href="#_sub1" class="code" title="subfunction miriamStruct=parseMiriam(strings,miriamStruct)">parseMiriam</a>(model.rxnMiriams);
0481 
0482 <span class="comment">%Replace the reaction IDs for those IDs that have a corresponding</span>
0483 <span class="comment">%replacement name.</span>
0484 I=cellfun(@any,reactionReplacement);
0485 model.rxns(I)=reactionReplacement(I);
0486 
0487 <span class="comment">%Check that there are no empty strings in reactionIDs or equations</span>
0488 <span class="keyword">if</span> any(strcmp(<span class="string">''</span>,model.rxns))
0489     EM=<span class="string">'There are empty reaction IDs'</span>;
0490     dispEM(EM);
0491 <span class="keyword">end</span>
0492 
0493 <span class="keyword">if</span> any(strcmp(<span class="string">''</span>,equations))
0494     EM=<span class="string">'There are empty equations'</span>;
0495     dispEM(EM);
0496 <span class="keyword">end</span>
0497 
0498 <span class="keyword">if</span> ~isempty(model.rxnComps)
0499     <span class="keyword">if</span> any(strcmp(<span class="string">''</span>,model.rxnComps))
0500         EM=<span class="string">'Either all reactions must have an associated compartment string or none of them'</span>;
0501         dispEM(EM);
0502     <span class="keyword">end</span>
0503 <span class="keyword">end</span>
0504 
0505 <span class="keyword">if</span> ~isempty(model.grRules)
0506     tempRules=model.grRules;
0507     <span class="keyword">for</span> i=1:length(model.rxns)
0508         <span class="comment">%Check that all gene associations have a match in the gene list</span>
0509         <span class="keyword">if</span> ~isempty(model.grRules{i})
0510             tempRules{i}=regexprep(tempRules{i},<span class="string">' and | or '</span>,<span class="string">'&gt;'</span>); <span class="comment">%New format: Genes are separated 'and' and 'or' strings with parentheses</span>
0511             tempRules{i}=regexprep(tempRules{i},<span class="string">'('</span>,<span class="string">''</span>); <span class="comment">%New format: Genes are separated 'and' and 'or' strings with parentheses</span>
0512             tempRules{i}=regexprep(tempRules{i},<span class="string">')'</span>,<span class="string">''</span>); <span class="comment">%New format: Genes are separated 'and' and 'or' strings with parentheses</span>
0513             indexesNew=strfind(tempRules{i},<span class="string">'&gt;'</span>); <span class="comment">%Old format: Genes are separated by &quot;:&quot; for AND and &quot;;&quot; for OR</span>
0514             indexes=strfind(tempRules{i},<span class="string">':'</span>); <span class="comment">%Old format: Genes are separated by &quot;:&quot; for AND and &quot;;&quot; for OR</span>
0515             indexes=unique([indexesNew indexes strfind(tempRules{i},<span class="string">';'</span>)]);
0516             <span class="keyword">if</span> isempty(indexes)
0517                 <span class="comment">%See if you have a match</span>
0518                 I=find(strcmp(tempRules{i},model.genes));
0519                 <span class="keyword">if</span> isempty(I)
0520                     EM=[<span class="string">'The gene association in reaction '</span> model.rxns{i} <span class="string">' ('</span> tempRules{i} <span class="string">') is not present in the gene list'</span>];
0521                     dispEM(EM);
0522                 <span class="keyword">end</span>
0523             <span class="keyword">else</span>
0524                 temp=[0 indexes numel(tempRules{i})+1];
0525                 <span class="keyword">for</span> j=1:numel(indexes)+1
0526                     <span class="comment">%The reaction has several associated genes</span>
0527                     geneName=tempRules{i}(temp(j)+1:temp(j+1)-1);
0528                     I=find(strcmp(geneName,model.genes));
0529                     <span class="keyword">if</span> isempty(I)
0530                         EM=[<span class="string">'The gene association in reaction '</span> model.rxns{i} <span class="string">' ('</span> geneName <span class="string">') is not present in the gene list'</span>];
0531                         dispEM(EM);
0532                     <span class="keyword">end</span>
0533                 <span class="keyword">end</span>
0534             <span class="keyword">end</span>
0535             <span class="comment">%In order to adhere to the COBRA standards it should be like</span>
0536             <span class="comment">%this: -If only one gene then no parentheses -If only &quot;and&quot; or</span>
0537             <span class="comment">%only &quot;or&quot; there should only be one set of parentheses -If both</span>
0538             <span class="comment">%&quot;and&quot; and &quot;or&quot;, then split on &quot;or&quot;. This is not complete, but</span>
0539             <span class="comment">%it's the type of relationship supported by the Excel</span>
0540             <span class="comment">%formulation</span>
0541             aSign=strfind(model.grRules{i},<span class="string">':'</span>);
0542             oSign=strfind(model.grRules{i},<span class="string">';'</span>);
0543             <span class="keyword">if</span> isempty(aSign) &amp;&amp; isempty(oSign)
0544                 model.grRules{i}=model.grRules{i};
0545             <span class="keyword">else</span>
0546                 <span class="keyword">if</span> isempty(aSign)
0547                     model.grRules{i}=[<span class="string">'('</span> strrep(model.grRules{i},<span class="string">';'</span>,<span class="string">' or '</span>) <span class="string">')'</span>];
0548                 <span class="keyword">else</span>
0549                     <span class="keyword">if</span> isempty(oSign)
0550                         model.grRules{i}=[<span class="string">'('</span> strrep(model.grRules{i},<span class="string">':'</span>,<span class="string">' and '</span>) <span class="string">')'</span>];
0551                     <span class="keyword">else</span>
0552                         model.grRules{i}=[<span class="string">'(('</span> strrep(model.grRules{i},<span class="string">';'</span>,<span class="string">') or ('</span>) <span class="string">'))'</span>];
0553                         model.grRules{i}=strrep(model.grRules{i},<span class="string">':'</span>,<span class="string">' and '</span>);
0554                     <span class="keyword">end</span>
0555                 <span class="keyword">end</span>
0556             <span class="keyword">end</span>
0557         <span class="keyword">end</span>
0558     <span class="keyword">end</span>
0559 <span class="keyword">end</span>
0560 
0561 <span class="comment">%Check that the compartment for each reaction can be found</span>
0562 <span class="keyword">if</span> ~isempty(model.rxnComps)
0563     [I, model.rxnComps]=ismember(model.rxnComps,model.comps);
0564     EM=<span class="string">'The following reactions have compartment abbreviations which could not be found:'</span>;
0565     dispEM(EM,true,model.rxns(~I));
0566 <span class="keyword">end</span>
0567 
0568 <span class="comment">%Get all the metabolites and info about them</span>
0569 [raw, flag]=<a href="loadSheet.html" class="code" title="function [raw, flag]=loadSheet(workbook, sheet)">loadSheet</a>(workbook,<span class="string">'METS'</span>);
0570 
0571 <span class="keyword">if</span> flag&lt;0
0572     <span class="keyword">if</span> printWarnings==true
0573         EM=<span class="string">'There is no spreadsheet named METS. The metabolites will be named &quot;m1&quot;, &quot;m2&quot;... and assigned to the first compartment'</span>;
0574         dispEM(EM,false);
0575     <span class="keyword">end</span>
0576     <span class="comment">%Parse the equations to find out how many metabolites there are</span>
0577     metsForParsing=parseRxnEqu(equations);
0578     I=num2cell((1:numel(metsForParsing))');
0579     model.mets=strcat(<span class="string">'m'</span>,cellfun(@num2str,I,<span class="string">'UniformOutput'</span>,false));
0580     model.metComps=ones(numel(model.mets),1);
0581     model.unconstrained=zeros(numel(model.mets),1);
0582     model.metNames=metsForParsing;
0583 <span class="keyword">else</span>
0584     raw=<a href="cleanSheet.html" class="code" title="function [raw,keptRows,keptCols]=cleanSheet(raw,removeComments,removeOnlyCap,removeNoCap,removeEmptyRows)">cleanSheet</a>(raw);
0585     
0586     <span class="comment">%Map to new captions</span>
0587     raw(1,:)=upper(raw(1,:));
0588     raw(1,:)=strrep(raw(1,:),<span class="string">'METID'</span>,<span class="string">'ID'</span>);
0589     raw(1,:)=strrep(raw(1,:),<span class="string">'METNAME'</span>,<span class="string">'NAME'</span>);
0590     
0591     <span class="comment">%Loop through the labels</span>
0592     metReplacement={};
0593     <span class="keyword">for</span> i=1:numel(raw(1,:))
0594         <span class="keyword">switch</span> raw{1,i}
0595             <span class="keyword">case</span> <span class="string">'ID'</span>
0596                 model.mets=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,i),<span class="string">'UniformOutput'</span>,false);
0597             <span class="keyword">case</span> <span class="string">'NAME'</span>
0598                 model.metNames=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,i),<span class="string">'UniformOutput'</span>,false);
0599             <span class="keyword">case</span> <span class="string">'UNCONSTRAINED'</span>
0600                 model.unconstrained=cellfun(@<a href="#_sub4" class="code" title="subfunction y=boolToDouble(x)">boolToDouble</a>,raw(2:<span class="keyword">end</span>,i));
0601                 <span class="comment">%NaN is returned if the values couldn't be parsed</span>
0602                 EM=<span class="string">'The UNCONSTRAINED property for the following metabolites must be &quot;true&quot;/&quot;false&quot;, 1/0, TRUE/FALSE or not set:'</span>;
0603                 dispEM(EM,true,model.mets(isnan(model.unconstrained)));
0604             <span class="keyword">case</span> <span class="string">'MIRIAM'</span>
0605                 model.metMiriams=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,i),<span class="string">'UniformOutput'</span>,false);
0606             <span class="keyword">case</span> <span class="string">'COMPOSITION'</span>
0607                 model.metFormulas=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,i),<span class="string">'UniformOutput'</span>,false);
0608             <span class="keyword">case</span> <span class="string">'INCHI'</span>
0609                 model.inchis=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,i),<span class="string">'UniformOutput'</span>,false);
0610             <span class="keyword">case</span> <span class="string">'COMPARTMENT'</span>
0611                 model.metComps=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,i),<span class="string">'UniformOutput'</span>,false);
0612                 
0613                 <span class="comment">%Check that all metabolites have compartments defined</span>
0614                 <span class="keyword">if</span> any(strcmp(<span class="string">''</span>,model.metComps))
0615                     EM=<span class="string">'All metabolites must have an associated compartment string'</span>;
0616                     dispEM(EM);
0617                 <span class="keyword">end</span>
0618             <span class="keyword">case</span> <span class="string">'REPLACEMENT ID'</span>
0619                 metReplacement=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,i),<span class="string">'UniformOutput'</span>,false);
0620             <span class="keyword">case</span> <span class="string">'CHARGE'</span>
0621                 model.metCharges=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,i),<span class="string">'UniformOutput'</span>,false);
0622         <span class="keyword">end</span>
0623     <span class="keyword">end</span>
0624     
0625     <span class="comment">%Check that necessary fields are loaded (METID)</span>
0626     <span class="keyword">if</span> isempty(model.mets)
0627         EM=<span class="string">'There must be a column named ID in the METS sheet'</span>;
0628         dispEM(EM);
0629     <span class="keyword">end</span>
0630     
0631     <span class="comment">%Check that some other stuff is loaded and use default values otherwise</span>
0632     <span class="keyword">if</span> isempty(model.metNames)
0633         model.metNames=cell(numel(model.mets),1);
0634         <span class="keyword">if</span> printWarnings==true
0635             EM=<span class="string">'There is no column named NAME in the METS sheet. ID will be used as name'</span>;
0636             dispEM(EM,false);
0637         <span class="keyword">end</span>
0638     <span class="keyword">end</span>
0639     <span class="keyword">if</span> isempty(model.unconstrained)
0640         model.unconstrained=zeros(numel(model.mets),1);
0641         <span class="keyword">if</span> printWarnings==true
0642             EM=<span class="string">'There is no column named UNCONSTRAINED in the METS sheet. All metabolites will be constrained'</span>;
0643             dispEM(EM,false);
0644         <span class="keyword">end</span>
0645     <span class="keyword">end</span>
0646     
0647     <span class="keyword">if</span> isempty(model.metComps)
0648         model.metComps=cell(numel(model.mets),1);
0649         model.metComps(:)=model.comps(1);
0650         <span class="keyword">if</span> printWarnings==true
0651             EM=<span class="string">'There is no column named COMPARTMENT in the METS sheet. All metabolites will be assigned to the first compartment in COMPS. Note that RAVEN makes extensive use of metabolite names and compartments. Some features will therefore not function correctly if metabolite compartments are not correctly assigned'</span>;
0652             dispEM(EM,false);
0653         <span class="keyword">end</span>
0654     <span class="keyword">end</span>
0655     
0656     <span class="comment">%The composition should be loaded from InChIs when available</span>
0657     I=find(~cellfun(@isempty,model.inchis));
0658     <span class="keyword">for</span> i=1:numel(I)
0659         S=regexp(model.inchis(I(i)),<span class="string">'/'</span>,<span class="string">'split'</span>);
0660         S=S{1};
0661         <span class="keyword">if</span> numel(S)&gt;=2
0662             <span class="comment">%Don't copy if it doesn't look good</span>
0663             model.metFormulas(I(i))=S(2);
0664         <span class="keyword">end</span>
0665     <span class="keyword">end</span>
0666     
0667     <span class="comment">%Check that the compartment for each metabolite can be found. Also</span>
0668     <span class="comment">%convert from id to index</span>
0669     [I, model.metComps]=ismember(model.metComps,model.comps);
0670     EM=<span class="string">'The following metabolites have compartment abbreviations which could not be found:'</span>;
0671     dispEM(EM,true,model.mets(~I));
0672     
0673     <span class="comment">%Check that the model.mets vector is unique. The problem is that the</span>
0674     <span class="comment">%checkModelStruct cannot check for that since only the metReplacements</span>
0675     <span class="comment">%(if used) end up in the model structure</span>
0676     I=false(numel(model.mets),1);
0677     [J, K]=unique(model.mets);
0678     <span class="keyword">if</span> numel(J)~=numel(model.mets)
0679         L=1:numel(model.mets);
0680         L(K)=[];
0681         I(L)=true;
0682     <span class="keyword">end</span>
0683     EM=<span class="string">'The following metabolites are duplicates:'</span>;
0684     dispEM(EM,~ignoreErrors,model.mets(I));
0685     
0686     <span class="comment">%Check that there are no metabolite IDs which are numbers. This would</span>
0687     <span class="comment">%give errors when parsing the equations</span>
0688     I=cellfun(@str2double,model.mets);
0689     EM=<span class="string">'The following metabolites have names which cannot be distinguished from numbers:'</span>;
0690     dispEM(EM,~ignoreErrors,model.mets(~isnan(I)));
0691     I=cellfun(@str2double,metReplacement);
0692     EM=<span class="string">'The following metabolites have names which cannot be distinguished from numbers:'</span>;
0693     dispEM(EM,~ignoreErrors,metReplacement(~isnan(I)));
0694     
0695     <span class="comment">%Replace the metabolite IDs for those IDs that have a corresponding</span>
0696     <span class="comment">%replacement metabolite. This is not used for matching, but will be</span>
0697     <span class="comment">%checked for consistency with SBML naming conventions</span>
0698     metsForParsing=model.mets; <span class="comment">%This is because the equations are written with this</span>
0699     I=cellfun(@any,metReplacement);
0700     model.mets(I)=metReplacement(I);
0701     
0702     <span class="comment">%If the metabolite name isn't set, replace it with the metabolite id</span>
0703     I=~cellfun(@any,model.metNames);
0704     model.metNames(I)=model.mets(I);
0705     
0706     <span class="comment">%Construct the metMiriams structure</span>
0707     model.metMiriams=<a href="#_sub1" class="code" title="subfunction miriamStruct=parseMiriam(strings,miriamStruct)">parseMiriam</a>(model.metMiriams);
0708     
0709     <span class="comment">%Either all metabolites have charge or none of them. Check if it's only</span>
0710     <span class="comment">%empty and if so return it to []</span>
0711     <span class="keyword">if</span> ~isempty(model.metCharges)
0712         <span class="keyword">if</span> all(cellfun(@isempty,model.metCharges))
0713             model.metCharges=[];
0714         <span class="keyword">end</span>
0715     <span class="keyword">end</span>
0716     <span class="keyword">if</span> ~isempty(model.metCharges)
0717         model.metCharges=str2double(model.metCharges);
0718     <span class="keyword">end</span>
0719 <span class="keyword">end</span>
0720 
0721 <span class="comment">%Everything seems fine with the metabolite IDs, compartments, genes, and</span>
0722 <span class="comment">%reactions</span>
0723 
0724 <span class="comment">%Parse the equations</span>
0725 [model.S, mets, badRxns, model.rev]=constructS(equations,metsForParsing,model.rxns);
0726 model.rev=model.rev*1; <span class="comment">%Typecast to double</span>
0727 
0728 <span class="comment">%Add default constraints</span>
0729 model.lb(isnan(model.lb))=model.annotation.defaultLB.*model.rev(isnan(model.lb));
0730 model.ub(isnan(model.ub))=model.annotation.defaultUB;
0731 
0732 <span class="comment">%Reorder the S matrix so that it fits with the metabolite list in the</span>
0733 <span class="comment">%structure</span>
0734 [~, I]=ismember(mets,metsForParsing);
0735 model.S=model.S(I,:);
0736 
0737 <span class="comment">%Print warnings about the reactions which contain the same metabolite as</span>
0738 <span class="comment">%both reactants and products</span>
0739 EM=<span class="string">'The following reactions have metabolites which are present more than once. Only the net reactions will be exported:'</span>;
0740 dispEM(EM,false,model.rxns(badRxns));
0741 
0742 model.b=zeros(numel(model.mets),1);
0743 
0744 <span class="comment">%Fix grRules and reconstruct rxnGeneMat</span>
0745 [grRules,rxnGeneMat] = standardizeGrRules(model,true);
0746 model.grRules = grRules;
0747 model.rxnGeneMat = rxnGeneMat;
0748 
0749 <span class="comment">%Remove unused fields</span>
0750 <span class="keyword">if</span> all(cellfun(@isempty,model.compOutside))
0751     model=rmfield(model,<span class="string">'compOutside'</span>);
0752 <span class="keyword">end</span>
0753 <span class="keyword">if</span> all(cellfun(@isempty,model.compMiriams))
0754     model=rmfield(model,<span class="string">'compMiriams'</span>);
0755 <span class="keyword">end</span>
0756 <span class="keyword">if</span> all(cellfun(@isempty,model.rxnNames))
0757     model=rmfield(model,<span class="string">'rxnNames'</span>);
0758 <span class="keyword">end</span>
0759 <span class="keyword">if</span> isempty(model.rxnComps)
0760     model=rmfield(model,<span class="string">'rxnComps'</span>);
0761 <span class="keyword">end</span>
0762 <span class="keyword">if</span> all(cellfun(@isempty,model.grRules))
0763     model=rmfield(model,<span class="string">'grRules'</span>);
0764 <span class="keyword">end</span>
0765 <span class="keyword">if</span> isfield(model,<span class="string">'rxnGeneMat'</span>) &amp;&amp; isempty(model.rxnGeneMat)
0766     model=rmfield(model,<span class="string">'rxnGeneMat'</span>);
0767 <span class="keyword">end</span>
0768 <span class="keyword">if</span> all(cellfun(@isempty,model.subSystems))
0769     model=rmfield(model,<span class="string">'subSystems'</span>);
0770 <span class="keyword">end</span>
0771 <span class="keyword">if</span> all(cellfun(@isempty,model.eccodes))
0772     model=rmfield(model,<span class="string">'eccodes'</span>);
0773 <span class="keyword">end</span>
0774 <span class="keyword">if</span> all(cellfun(@isempty,model.rxnMiriams))
0775     model=rmfield(model,<span class="string">'rxnMiriams'</span>);
0776 <span class="keyword">end</span>
0777 <span class="keyword">if</span> all(cellfun(@isempty,model.rxnNotes))
0778     model=rmfield(model,<span class="string">'rxnNotes'</span>);
0779 <span class="keyword">end</span>
0780 <span class="keyword">if</span> all(cellfun(@isempty,model.rxnReferences))
0781     model=rmfield(model,<span class="string">'rxnReferences'</span>);
0782 <span class="keyword">end</span>
0783 <span class="keyword">if</span> isempty(model.rxnConfidenceScores)
0784     model=rmfield(model,<span class="string">'rxnConfidenceScores'</span>);
0785 <span class="keyword">end</span>
0786 <span class="keyword">if</span> isempty(model.genes)
0787     model=rmfield(model,<span class="string">'genes'</span>);
0788 <span class="keyword">end</span>
0789 <span class="keyword">if</span> isempty(model.geneComps)
0790     model=rmfield(model,<span class="string">'geneComps'</span>);
0791 <span class="keyword">end</span>
0792 <span class="keyword">if</span> isempty(model.geneMiriams)
0793     model=rmfield(model,<span class="string">'geneMiriams'</span>);
0794 <span class="keyword">end</span>
0795 <span class="keyword">if</span> all(cellfun(@isempty,model.geneShortNames))
0796     model=rmfield(model,<span class="string">'geneShortNames'</span>);
0797 <span class="keyword">end</span>
0798 <span class="keyword">if</span> all(cellfun(@isempty,model.inchis))
0799     model=rmfield(model,<span class="string">'inchis'</span>);
0800 <span class="keyword">end</span>
0801 <span class="keyword">if</span> all(cellfun(@isempty,model.metFormulas))
0802     model=rmfield(model,<span class="string">'metFormulas'</span>);
0803 <span class="keyword">end</span>
0804 <span class="keyword">if</span> all(cellfun(@isempty,model.metMiriams))
0805     model=rmfield(model,<span class="string">'metMiriams'</span>);
0806 <span class="keyword">end</span>
0807 <span class="keyword">if</span> isempty(model.metCharges)
0808     model=rmfield(model,<span class="string">'metCharges'</span>);
0809 <span class="keyword">end</span>
0810 
0811 <span class="comment">%The model structure has now been reconstructed but it can still contain</span>
0812 <span class="comment">%many types of errors. The checkModelConsistency function is used to make</span>
0813 <span class="comment">%sure that naming and mapping of stuff looks good</span>
0814 checkModelStruct(model,~ignoreErrors);
0815 
0816 <span class="keyword">if</span> removeExcMets==true
0817     model=simplifyModel(model);
0818 <span class="keyword">end</span>
0819 <span class="keyword">end</span>
0820 
0821 <a name="_sub1" href="#_subfunctions" class="code">function miriamStruct=parseMiriam(strings,miriamStruct)</a>
0822 <span class="comment">%Gets the names and values of Miriam-string. Nothing fancy at all, just to</span>
0823 <span class="comment">%prevent using the same code for metabolites, genes, and reactions. The</span>
0824 <span class="comment">%function also allows for supplying a miriamStruct and the info will then</span>
0825 <span class="comment">%be added</span>
0826 
0827 <span class="keyword">if</span> nargin&lt;2
0828     miriamStruct=cell(numel(strings),1);
0829 <span class="keyword">end</span>
0830 <span class="keyword">for</span> i=1:numel(strings)
0831     <span class="keyword">if</span> any(strings{i})
0832         <span class="comment">%A Miriam string can be several ids separated by &quot;;&quot;. Each id is</span>
0833         <span class="comment">%&quot;name(..:..)/value&quot;; an old format when value is separated by</span>
0834         <span class="comment">%colon is also supported</span>
0835         I=regexp(strings{i},<span class="string">';'</span>,<span class="string">'split'</span>);
0836         <span class="keyword">if</span> isfield(miriamStruct{i},<span class="string">'name'</span>)
0837             startIndex=numel(miriamStruct{i}.name);
0838             miriamStruct{i}.name=[miriamStruct{i}.name;cell(numel(I),1)];
0839             miriamStruct{i}.value=[miriamStruct{i}.value;cell(numel(I),1)];
0840         <span class="keyword">else</span>
0841             startIndex=0;
0842             miriamStruct{i}.name=cell(numel(I),1);
0843             miriamStruct{i}.value=cell(numel(I),1);
0844         <span class="keyword">end</span>
0845         
0846         <span class="keyword">for</span> j=1:numel(I)
0847             <span class="keyword">if</span> any(strfind(I{j},<span class="string">'/'</span>))
0848                 index=max(strfind(I{j},<span class="string">'/'</span>));
0849             <span class="keyword">elseif</span> any(strfind(I{j},<span class="string">':'</span>))
0850                 index=max(strfind(I{j},<span class="string">':'</span>));
0851             <span class="keyword">end</span>
0852             <span class="keyword">if</span> any(index)
0853                 miriamStruct{i}.name{startIndex+j}=I{j}(1:index-1);
0854                 miriamStruct{i}.value{startIndex+j}=I{j}(index+1:end);
0855             <span class="keyword">else</span>
0856                 EM=[<span class="string">'&quot;'</span> I{j} <span class="string">'&quot; is not a valid MIRIAM string. The format must be &quot;identifier/value&quot; or identifier:value'</span>];
0857                 dispEM(EM);
0858             <span class="keyword">end</span>
0859         <span class="keyword">end</span>
0860     <span class="keyword">end</span>
0861 <span class="keyword">end</span>
0862 <span class="keyword">end</span>
0863 
0864 <span class="comment">%For converting a value to string. This is used instead of num2str because</span>
0865 <span class="comment">%I want to convert empty cells to {''}.</span>
0866 <a name="_sub2" href="#_subfunctions" class="code">function y=toStr(x)</a>
0867 <span class="comment">%x can be empty, numerical, string or boolean. It cannot be NaN. Boolean</span>
0868 <span class="comment">%values will be converted to '1'/'0'</span>
0869 <span class="keyword">if</span> isempty(x)
0870     y=<span class="string">''</span>;
0871 <span class="keyword">else</span>
0872     y=num2str(x);
0873 <span class="keyword">end</span>
0874 <span class="keyword">end</span>
0875 
0876 <span class="comment">%For converting to numeric. This is used instead of str2num because I want</span>
0877 <span class="comment">%to be able to choose what empty values should be mapped to.</span>
0878 <span class="comment">%</span>
0879 <span class="comment">% default the value to use for empty input</span>
0880 <a name="_sub3" href="#_subfunctions" class="code">function y=toDouble(x,default)</a>
0881 <span class="keyword">if</span> isempty(x) <span class="comment">%Note that this catches '' as well</span>
0882     y=default;
0883 <span class="keyword">else</span>
0884     <span class="keyword">if</span> isnumeric(x)
0885         y=x;
0886     <span class="keyword">else</span>
0887         y=str2double(x);
0888         
0889         <span class="comment">%This happens if the input couldn't be converted. Note that the</span>
0890         <span class="comment">%input itself cannot be NaN since it was fixed in clean imported</span>
0891         <span class="keyword">if</span> isnan(y)
0892             EM=[<span class="string">'Cannot convert the string &quot;'</span> x <span class="string">'&quot; to double'</span>];
0893             dispEM(EM);
0894         <span class="keyword">end</span>
0895     <span class="keyword">end</span>
0896 <span class="keyword">end</span>
0897 <span class="keyword">end</span>
0898 
0899 <span class="comment">%For converting boolean (the UNCONSTRAINED field) to double (the</span>
0900 <span class="comment">%model.unconstrained field)</span>
0901 <a name="_sub4" href="#_subfunctions" class="code">function y=boolToDouble(x)</a>
0902 <span class="keyword">if</span> isempty(x)
0903     y=0;
0904     <span class="keyword">return</span>;
0905 <span class="keyword">end</span>
0906 <span class="keyword">if</span> islogical(x)
0907     y=x*1; <span class="comment">%Typecast to double</span>
0908     <span class="keyword">return</span>;
0909 <span class="keyword">end</span>
0910 <span class="keyword">if</span> isnumeric(x)
0911     <span class="keyword">if</span> x~=0
0912         y=1;
0913         <span class="keyword">return</span>;
0914     <span class="keyword">else</span>
0915         y=0;
0916         <span class="keyword">return</span>;
0917     <span class="keyword">end</span>
0918 <span class="keyword">end</span>
0919 <span class="keyword">if</span> ischar(x)
0920     <span class="keyword">if</span> strcmpi(x,<span class="string">'TRUE'</span>)
0921         y=1;
0922         <span class="keyword">return</span>;
0923     <span class="keyword">end</span>
0924     <span class="keyword">if</span> strcmpi(x,<span class="string">'FALSE'</span>)
0925         y=0;
0926         <span class="keyword">return</span>;
0927     <span class="keyword">end</span>
0928 <span class="keyword">end</span>
0929 y=NaN; <span class="comment">%This means that the input couldn't be parsed</span>
0930 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Mon 17-Feb-2020 11:12:32 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>