<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of exportModel</title>
  <meta name="keywords" content="exportModel">
  <meta name="description" content="exportModel">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">io</a> &gt; exportModel.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for io&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>exportModel
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>exportModel</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function exportModel(model,fileName,exportGeneComplexes,supressWarnings,sortIds) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> exportModel
   Exports a constraint-based model to an SBML file (L3V1 FBCv2)

   Input:
   model               a model structure
   fileName            filename to export the model to (without file extension)
   exportGeneComplexes true if gene complexes (all gene sets linked with
                       AND relationship) should be recognised and exported
                       (opt, default false)
   supressWarnings     true if warnings should be supressed (opt, default
                       false)
   sortIds             logical whether metabolites, reactions and genes
                       should be sorted alphabetically by their
                       identifiers (opt, default false)

   Usage: exportModel(model,fileName,exportGeneComplexes,supressWarnings,sortIds)</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="checkFileExistence.html" class="code" title="function files=checkFileExistence(files,fullOrTemp,allowSpace,checkExist)">checkFileExistence</a>	checkFileExistence</li><li><a href="sortIdentifiers.html" class="code" title="function newModel = sortIdentifiers(model)">sortIdentifiers</a>	exportModel</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="SBMLFromExcel.html" class="code" title="function SBMLFromExcel(fileName, outputFileName,toCOBRA,printWarnings)">SBMLFromExcel</a>	SBMLFromExcel</li><li><a href="exportForGit.html" class="code" title="function out=exportForGit(model,prefix,path,formats,mainBranchFlag,subDirs,cobraText)">exportForGit</a>	exportForGit</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function modelSBML=getSBMLStructure(sbmlLevel,sbmlVersion,sbmlPackages,sbmlPackageVersions)</a></li><li><a href="#_sub2" class="code">function miriamString=getMiriam(miriamStruct)</a></li><li><a href="#_sub3" class="code">function [tmp_Rxn]=addReactantsProducts(model,sbmlModel,i)</a></li><li><a href="#_sub4" class="code">function vecT = columnVector(vec)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function exportModel(model,fileName,exportGeneComplexes,supressWarnings,sortIds)</a>
0002 <span class="comment">% exportModel</span>
0003 <span class="comment">%   Exports a constraint-based model to an SBML file (L3V1 FBCv2)</span>
0004 <span class="comment">%</span>
0005 <span class="comment">%   Input:</span>
0006 <span class="comment">%   model               a model structure</span>
0007 <span class="comment">%   fileName            filename to export the model to (without file extension)</span>
0008 <span class="comment">%   exportGeneComplexes true if gene complexes (all gene sets linked with</span>
0009 <span class="comment">%                       AND relationship) should be recognised and exported</span>
0010 <span class="comment">%                       (opt, default false)</span>
0011 <span class="comment">%   supressWarnings     true if warnings should be supressed (opt, default</span>
0012 <span class="comment">%                       false)</span>
0013 <span class="comment">%   sortIds             logical whether metabolites, reactions and genes</span>
0014 <span class="comment">%                       should be sorted alphabetically by their</span>
0015 <span class="comment">%                       identifiers (opt, default false)</span>
0016 <span class="comment">%</span>
0017 <span class="comment">%   Usage: exportModel(model,fileName,exportGeneComplexes,supressWarnings,sortIds)</span>
0018 fileName=char(fileName);
0019 <span class="keyword">if</span> nargin&lt;3
0020     exportGeneComplexes=false;
0021 <span class="keyword">end</span>
0022 <span class="keyword">if</span> nargin&lt;4
0023     supressWarnings=false;
0024 <span class="keyword">end</span>
0025 <span class="keyword">if</span> nargin&lt;5
0026     sortIds=false;
0027 <span class="keyword">end</span>
0028 <span class="keyword">if</span> sortIds==true
0029     model=<a href="sortIdentifiers.html" class="code" title="function newModel = sortIdentifiers(model)">sortIdentifiers</a>(model);
0030 <span class="keyword">end</span>
0031 
0032 <span class="comment">%If no subSystems are defined, then no need to use groups package</span>
0033 <span class="keyword">if</span> isfield(model,<span class="string">'subSystems'</span>)
0034     modelHasSubsystems=true;
0035 <span class="keyword">else</span>
0036     modelHasSubsystems=false;
0037 <span class="keyword">end</span>
0038 
0039 <span class="comment">%The default SBML format settings, which are used as input for appropriate</span>
0040 <span class="comment">%libSBML functions to generate the blank SBML model structure before using</span>
0041 <span class="comment">%exporting in with OutputSBML to xml file</span>
0042 sbmlLevel=3;
0043 sbmlVersion=1;
0044 sbmlPackages={<span class="string">'fbc'</span>};
0045 sbmlPackageVersions=2;
0046 <span class="keyword">if</span> modelHasSubsystems
0047     sbmlPackages={sbmlPackages,<span class="string">'groups'</span>};
0048     sbmlPackageVersions=[sbmlPackageVersions,1];
0049 <span class="keyword">end</span>
0050 
0051 <span class="comment">%Check if the &quot;unconstrained&quot; field is still present. This shows if</span>
0052 <span class="comment">%exchange metabolites have been removed</span>
0053 <span class="keyword">if</span> ~isfield(model,<span class="string">'unconstrained'</span>)
0054     model.unconstrained=zeros(numel(model.mets),1);
0055 <span class="keyword">end</span>
0056 
0057 <span class="comment">%If model id and name do not exist, make sure that default</span>
0058 <span class="comment">%strings are included</span>
0059 <span class="keyword">if</span> ~isfield(model,<span class="string">'id'</span>)
0060     fprintf(<span class="string">'WARNING: The model is missing the &quot;id&quot; field. Uses &quot;blankID&quot;. \n'</span>);
0061     model.id=<span class="string">'blankID'</span>;
0062 <span class="keyword">end</span>
0063 <span class="keyword">if</span> ~isfield(model,<span class="string">'name'</span>)
0064     fprintf(<span class="string">'WARNING: The model is missing the &quot;name&quot; field. Uses &quot;blankName&quot;. \n'</span>);
0065     model.name=<span class="string">'blankName'</span>;
0066 <span class="keyword">end</span>
0067 
0068 <span class="comment">%Check the model structure</span>
0069 <span class="keyword">if</span> supressWarnings==false
0070     checkModelStruct(model,false);
0071 <span class="keyword">end</span>
0072 
0073 <span class="comment">%Add several blank fields, if they do not exist already. This is to reduce</span>
0074 <span class="comment">%the number of conditions below</span>
0075 <span class="keyword">if</span> ~isfield(model,<span class="string">'compMiriams'</span>)
0076     model.compMiriams=cell(numel(model.comps),1);
0077 <span class="keyword">end</span>
0078 <span class="keyword">if</span> ~isfield(model,<span class="string">'inchis'</span>)
0079     model.inchis=cell(numel(model.mets),1);
0080 <span class="keyword">end</span>
0081 <span class="keyword">if</span> ~isfield(model,<span class="string">'metFormulas'</span>)
0082     model.metFormulas=cell(numel(model.mets),1);
0083 <span class="keyword">end</span>
0084 <span class="keyword">if</span> ~isfield(model,<span class="string">'metMiriams'</span>)
0085     model.metMiriams=cell(numel(model.mets),1);
0086 <span class="keyword">end</span>
0087 <span class="keyword">if</span> ~isfield(model,<span class="string">'geneMiriams'</span>) &amp;&amp; isfield(model,<span class="string">'genes'</span>)
0088     model.geneMiriams=cell(numel(model.genes),1);
0089 <span class="keyword">end</span>
0090 <span class="keyword">if</span> ~isfield(model,<span class="string">'geneShortNames'</span>) &amp;&amp; isfield(model,<span class="string">'genes'</span>)
0091     model.geneShortNames=cell(numel(model.genes),1);
0092 <span class="keyword">end</span>
0093 <span class="keyword">if</span> ~isfield(model,<span class="string">'subSystems'</span>)
0094     model.subSystems=cell(numel(model.rxns),1);
0095 <span class="keyword">end</span>
0096 <span class="keyword">if</span> ~isfield(model,<span class="string">'eccodes'</span>)
0097     model.eccodes=cell(numel(model.rxns),1);
0098 <span class="keyword">end</span>
0099 <span class="keyword">if</span> ~isfield(model,<span class="string">'rxnReferences'</span>)
0100     model.rxnReferences=cell(numel(model.rxns),1);
0101 <span class="keyword">end</span>
0102 <span class="keyword">if</span> ~isfield(model,<span class="string">'rxnConfidenceScores'</span>)
0103     model.rxnConfidenceScores=NaN(numel(model.rxns),1);
0104 <span class="keyword">end</span>
0105 <span class="keyword">if</span> ~isfield(model,<span class="string">'rxnNotes'</span>)
0106     model.rxnNotes=cell(numel(model.rxns),1);
0107 <span class="keyword">end</span>
0108 <span class="keyword">if</span> ~isfield(model,<span class="string">'rxnMiriams'</span>)
0109     model.rxnMiriams=cell(numel(model.rxns),1);
0110 <span class="keyword">end</span>
0111 
0112 <span class="keyword">if</span> sbmlLevel&lt;3
0113     <span class="comment">%Check if genes have associated compartments</span>
0114     <span class="keyword">if</span> ~isfield(model,<span class="string">'geneComps'</span>) &amp;&amp; isfield(model,<span class="string">'genes'</span>)
0115         <span class="keyword">if</span> supressWarnings==false
0116             EM=<span class="string">'There are no compartments specified for genes. All genes will be assigned to the first compartment. This is because the SBML structure requires all elements to be assigned to a compartment'</span>;
0117             dispEM(EM,false);
0118         <span class="keyword">end</span>
0119         model.geneComps=ones(numel(model.genes),1);
0120     <span class="keyword">end</span>
0121 <span class="keyword">end</span>
0122 
0123 <span class="comment">%Convert ids to SBML-convenient format. This is to avoid the data loss when</span>
0124 <span class="comment">%unsupported characters are included in ids. Here we are using part from</span>
0125 <span class="comment">%convertSBMLID, originating from the COBRA Toolbox</span>
0126 model.rxns=regexprep(model.rxns,<span class="string">'([^0-9_a-zA-Z])'</span>,<span class="string">'__${num2str($1+0)}__'</span>);
0127 model.mets=regexprep(model.mets,<span class="string">'([^0-9_a-zA-Z])'</span>,<span class="string">'__${num2str($1+0)}__'</span>);
0128 model.comps=regexprep(model.comps,<span class="string">'([^0-9_a-zA-Z])'</span>,<span class="string">'__${num2str($1+0)}__'</span>);
0129 <span class="keyword">if</span> isfield(model,<span class="string">'genes'</span>)
0130     problemGenes=find(~cellfun(<span class="string">'isempty'</span>,regexp(model.genes,<span class="string">'([^0-9_a-zA-Z])'</span>)));
0131     originalGenes=model.genes(problemGenes);
0132     replacedGenes=regexprep(model.genes(problemGenes),<span class="string">'([^0-9_a-zA-Z])'</span>,<span class="string">'__${num2str($1+0)}__'</span>);
0133     model.genes(problemGenes)=replacedGenes;
0134     <span class="keyword">for</span> i=1:numel(problemGenes)
0135         model.grRules = regexprep(model.grRules, [<span class="string">'(^|\s|\()'</span> originalGenes{i} <span class="string">'($|\s|\))'</span>], [<span class="string">'$1'</span> replacedGenes{i} <span class="string">'$2'</span>]);
0136     <span class="keyword">end</span>
0137 <span class="keyword">end</span>
0138 
0139 <span class="comment">%Generate an empty SBML structure</span>
0140 modelSBML=<a href="#_sub1" class="code" title="subfunction modelSBML=getSBMLStructure(sbmlLevel,sbmlVersion,sbmlPackages,sbmlPackageVersions)">getSBMLStructure</a>(sbmlLevel,sbmlVersion,sbmlPackages,sbmlPackageVersions);
0141 modelSBML.metaid=model.id;
0142 modelSBML.id=model.id;
0143 modelSBML.name=model.name;
0144 
0145 <span class="keyword">if</span> isfield(model,<span class="string">'annotation'</span>)
0146     <span class="keyword">if</span> isfield(model.annotation,<span class="string">'note'</span>)
0147         modelSBML.notes=[<span class="string">'&lt;notes&gt;&lt;body xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;&lt;p&gt;'</span>,regexprep(model.annotation.note,<span class="string">'&lt;p&gt;|&lt;/p&gt;'</span>,<span class="string">''</span>),<span class="string">'&lt;/p&gt;&lt;/body&gt;&lt;/notes&gt;'</span>];
0148     <span class="keyword">end</span>
0149     modelSBML.annotation=[<span class="string">'&lt;annotation&gt;&lt;rdf:RDF xmlns:rdf=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot; xmlns:dc=&quot;http://purl.org/dc/elements/1.1/&quot; xmlns:dcterms=&quot;http://purl.org/dc/terms/&quot; xmlns:vCard=&quot;http://www.w3.org/2001/vcard-rdf/3.0#&quot; xmlns:bqbiol=&quot;http://biomodels.net/biology-qualifiers/&quot; xmlns:bqmodel=&quot;http://biomodels.net/model-qualifiers/&quot;&gt;&lt;rdf:Description rdf:about=&quot;#meta_'</span> model.id <span class="string">'&quot;&gt;'</span>];
0150     nameString=<span class="string">''</span>;
0151     <span class="keyword">if</span> isfield(model.annotation,<span class="string">'familyName'</span>)
0152         <span class="keyword">if</span> ~isempty(model.annotation.familyName)
0153             nameString=[<span class="string">'&lt;vCard:Family&gt;'</span> model.annotation.familyName <span class="string">'&lt;/vCard:Family&gt;'</span>];
0154         <span class="keyword">end</span>
0155     <span class="keyword">end</span>
0156     <span class="keyword">if</span> isfield(model.annotation,<span class="string">'givenName'</span>)
0157         <span class="keyword">if</span> ~isempty(model.annotation.givenName)
0158             nameString=[nameString <span class="string">'&lt;vCard:Given&gt;'</span> model.annotation.givenName <span class="string">'&lt;/vCard:Given&gt;'</span>];
0159         <span class="keyword">end</span>
0160     <span class="keyword">end</span>
0161     email=<span class="string">''</span>;
0162     <span class="keyword">if</span> isfield(model.annotation,<span class="string">'email'</span>)
0163         <span class="keyword">if</span> ~isempty(model.annotation.email)
0164             email=[<span class="string">'&lt;vCard:EMAIL&gt;'</span> model.annotation.email <span class="string">'&lt;/vCard:EMAIL&gt;'</span>];
0165         <span class="keyword">end</span>
0166     <span class="keyword">end</span>
0167     org=<span class="string">''</span>;
0168     <span class="keyword">if</span> isfield(model.annotation,<span class="string">'organization'</span>)
0169         <span class="keyword">if</span> ~isempty(model.annotation.organization)
0170             org=[<span class="string">'&lt;vCard:ORG rdf:parseType=&quot;Resource&quot;&gt;&lt;vCard:Orgname&gt;'</span> model.annotation.organization <span class="string">'&lt;/vCard:Orgname&gt;&lt;/vCard:ORG&gt;'</span>];
0171         <span class="keyword">end</span>
0172     <span class="keyword">end</span>
0173     <span class="keyword">if</span> ~isempty(nameString) || ~isempty(email) || ~isempty(org)
0174         modelSBML.annotation=[modelSBML.annotation <span class="string">'&lt;dc:creator&gt;&lt;rdf:Bag&gt;&lt;rdf:li rdf:parseType=&quot;Resource&quot;&gt;'</span>];
0175         <span class="keyword">if</span> ~isempty(nameString)
0176             modelSBML.annotation=[modelSBML.annotation <span class="string">'&lt;vCard:N rdf:parseType=&quot;Resource&quot;&gt;'</span> nameString <span class="string">'&lt;/vCard:N&gt;'</span>];
0177         <span class="keyword">end</span>
0178         modelSBML.annotation=[modelSBML.annotation email org <span class="string">'&lt;/rdf:li&gt;&lt;/rdf:Bag&gt;&lt;/dc:creator&gt;'</span>];
0179     <span class="keyword">end</span>
0180     <span class="keyword">if</span> isfield(model,<span class="string">'annotation'</span>)
0181         <span class="keyword">if</span> isfield(model.annotation,<span class="string">'taxonomy'</span>)
0182             modelSBML.annotation=[modelSBML.annotation <span class="string">'&lt;bqbiol:is&gt;&lt;rdf:Bag&gt;&lt;rdf:li rdf:resource=&quot;https://identifiers.org/taxonomy/'</span> regexprep(model.annotation.taxonomy,<span class="string">'taxonomy/'</span>,<span class="string">''</span>) <span class="string">'&quot;/&gt;&lt;/rdf:Bag&gt;&lt;/bqbiol:is&gt;'</span>];
0183         <span class="keyword">end</span>
0184     <span class="keyword">end</span>    
0185     modelSBML.annotation=[modelSBML.annotation <span class="string">'&lt;/rdf:Description&gt;&lt;/rdf:RDF&gt;&lt;/annotation&gt;'</span>];
0186 <span class="keyword">end</span>
0187 
0188 <span class="comment">%Prepare compartments</span>
0189 <span class="keyword">for</span> i=1:numel(model.comps)
0190     <span class="comment">%Add the default values, as these will be the same in all entries</span>
0191     <span class="keyword">if</span> i==1
0192         <span class="keyword">if</span> isfield(modelSBML.compartment, <span class="string">'sboTerm'</span>)
0193             modelSBML.compartment(i).sboTerm=290;
0194         <span class="keyword">end</span>
0195         <span class="keyword">if</span> isfield(modelSBML.compartment, <span class="string">'spatialDimensions'</span>)
0196             modelSBML.compartment(i).spatialDimensions=3;
0197         <span class="keyword">end</span>
0198         <span class="keyword">if</span> isfield(modelSBML.compartment, <span class="string">'size'</span>)
0199             modelSBML.compartment(i).size=1;
0200         <span class="keyword">end</span>
0201         <span class="keyword">if</span> isfield(modelSBML.compartment, <span class="string">'constant'</span>)
0202             modelSBML.compartment(i).constant=1;
0203         <span class="keyword">end</span>
0204         <span class="keyword">if</span> isfield(modelSBML.compartment, <span class="string">'isSetSize'</span>)
0205             modelSBML.compartment(i).isSetSize=1;
0206         <span class="keyword">end</span>
0207         <span class="keyword">if</span> isfield(modelSBML.compartment, <span class="string">'isSetSpatialDimensions'</span>)
0208             modelSBML.compartment(i).isSetSpatialDimensions=1;
0209         <span class="keyword">end</span>
0210     <span class="keyword">end</span>
0211     <span class="comment">%Copy the default values to the next entry as long as it is not the</span>
0212     <span class="comment">%last one</span>
0213     <span class="keyword">if</span> i&lt;numel(model.comps)
0214         modelSBML.compartment(i+1)=modelSBML.compartment(i);
0215     <span class="keyword">end</span>
0216     
0217     <span class="keyword">if</span> isfield(modelSBML.compartment,<span class="string">'metaid'</span>)
0218         <span class="keyword">if</span> regexp(model.comps{i},<span class="string">'^[^a-zA-Z_]'</span>)
0219             EM=<span class="string">'The compartment IDs are in numeric format. For the compliance with SBML specifications, compartment IDs will be preceded with &quot;c_&quot; string'</span>;
0220             dispEM(EM,false);
0221             model.comps(i)=strcat(<span class="string">'c_'</span>,model.comps(i));
0222         <span class="keyword">end</span>
0223         modelSBML.compartment(i).metaid=model.comps{i};
0224     <span class="keyword">end</span>
0225     <span class="comment">%Prepare Miriam strings</span>
0226     <span class="keyword">if</span> ~isempty(model.compMiriams{i})
0227         [~,sbo_ind] = ismember(<span class="string">'sbo'</span>,model.compMiriams{i}.name);
0228         <span class="keyword">if</span> sbo_ind &gt; 0
0229             modelSBML.compartment(i).sboTerm=str2double(regexprep(model.compMiriams{i}.value{sbo_ind},<span class="string">'SBO:'</span>,<span class="string">''</span>,<span class="string">'ignorecase'</span>));
0230             <span class="comment">% remove the SBO term from compMiriams so the information is</span>
0231             <span class="comment">% not duplicated in the &quot;annotation&quot; field later on</span>
0232             model.compMiriams{i}.name(sbo_ind) = [];
0233             model.compMiriams{i}.value(sbo_ind) = [];
0234         <span class="keyword">end</span>
0235     <span class="keyword">end</span>
0236     <span class="keyword">if</span> ~isempty(model.compMiriams{i}) &amp;&amp; isfield(modelSBML.compartment(i),<span class="string">'annotation'</span>)
0237         modelSBML.compartment(i).annotation=[<span class="string">'&lt;annotation&gt;&lt;rdf:RDF xmlns:rdf=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot; xmlns:dc=&quot;http://purl.org/dc/elements/1.1/&quot; xmlns:dcterms=&quot;http://purl.org/dc/terms/&quot; xmlns:vCard=&quot;http://www.w3.org/2001/vcard-rdf/3.0#&quot; xmlns:bqbiol=&quot;http://biomodels.net/biology-qualifiers/&quot; xmlns:bqmodel=&quot;http://biomodels.net/model-qualifiers/&quot;&gt;&lt;rdf:Description rdf:about=&quot;#meta_'</span> model.comps{i} <span class="string">'&quot;&gt;'</span>];
0238         modelSBML.compartment(i).annotation=[modelSBML.compartment(i).annotation <span class="string">'&lt;bqbiol:is&gt;&lt;rdf:Bag&gt;'</span>];
0239         modelSBML.compartment(i).annotation=[modelSBML.compartment(i).annotation <a href="#_sub2" class="code" title="subfunction miriamString=getMiriam(miriamStruct)">getMiriam</a>(model.compMiriams{i}) <span class="string">'&lt;/rdf:Bag&gt;&lt;/bqbiol:is&gt;&lt;/rdf:Description&gt;&lt;/rdf:RDF&gt;&lt;/annotation&gt;'</span>];
0240     <span class="keyword">end</span>
0241     <span class="keyword">if</span> isfield(modelSBML.compartment, <span class="string">'name'</span>)
0242         modelSBML.compartment(i).name=model.compNames{i};
0243     <span class="keyword">end</span>
0244     <span class="keyword">if</span> isfield(modelSBML.compartment, <span class="string">'id'</span>)
0245         modelSBML.compartment(i).id=model.comps{i};
0246     <span class="keyword">end</span>
0247     
0248 <span class="keyword">end</span>
0249 
0250 <span class="comment">%Begin writing species</span>
0251 <span class="keyword">for</span> i=1:numel(model.mets)
0252     <span class="comment">%Add the default values, as these will be the same in all entries</span>
0253     <span class="keyword">if</span> i==1
0254         <span class="keyword">if</span> isfield(modelSBML.species, <span class="string">'sboTerm'</span>)
0255             modelSBML.species(i).sboTerm=247;
0256         <span class="keyword">end</span>
0257         <span class="keyword">if</span> isfield(modelSBML.species, <span class="string">'initialAmount'</span>)
0258             modelSBML.species(i).initialAmount=1;
0259         <span class="keyword">end</span>
0260         <span class="keyword">if</span> isfield(modelSBML.species, <span class="string">'initialConcentration'</span>)
0261             modelSBML.species(i).initialConcentration=0;
0262         <span class="keyword">end</span>
0263         <span class="keyword">if</span> isfield(modelSBML.species, <span class="string">'isSetInitialAmount'</span>)
0264             modelSBML.species(i).isSetInitialAmount=1;
0265         <span class="keyword">end</span>
0266         <span class="keyword">if</span> isfield(modelSBML.species, <span class="string">'isSetInitialConcentration'</span>)
0267             modelSBML.species(i).isSetInitialConcentration=1;
0268         <span class="keyword">end</span>
0269     <span class="keyword">end</span>
0270     <span class="comment">%Copy the default values to the next entry as long as it is not the</span>
0271     <span class="comment">%last one</span>
0272     <span class="keyword">if</span> i&lt;numel(model.mets)
0273         modelSBML.species(i+1)=modelSBML.species(i);
0274     <span class="keyword">end</span>
0275     
0276     <span class="keyword">if</span> isfield(modelSBML.species,<span class="string">'metaid'</span>)
0277         modelSBML.species(i).metaid=[<span class="string">'M_'</span> model.mets{i}];
0278     <span class="keyword">end</span>
0279     <span class="keyword">if</span> isfield(modelSBML.species, <span class="string">'name'</span>)
0280         modelSBML.species(i).name=model.metNames{i};
0281     <span class="keyword">end</span>
0282     <span class="keyword">if</span> isfield(modelSBML.species, <span class="string">'id'</span>)
0283         modelSBML.species(i).id=[<span class="string">'M_'</span> model.mets{i}];
0284     <span class="keyword">end</span>
0285     <span class="keyword">if</span> isfield(modelSBML.species, <span class="string">'compartment'</span>)
0286         modelSBML.species(i).compartment=model.comps{model.metComps(i)};
0287     <span class="keyword">end</span>
0288     <span class="keyword">if</span> isfield(model,<span class="string">'unconstrained'</span>)
0289         <span class="keyword">if</span> model.unconstrained(i)
0290             modelSBML.species(i).boundaryCondition=1;
0291         <span class="keyword">end</span>
0292     <span class="keyword">end</span>
0293     <span class="keyword">if</span> isfield(modelSBML.species, <span class="string">'fbc_charge'</span>) &amp;&amp; isfield(model,<span class="string">'metCharges'</span>)
0294         <span class="keyword">if</span> ~isnan(model.metCharges(i))
0295             modelSBML.species(i).fbc_charge=model.metCharges(i);
0296             modelSBML.species(i).isSetfbc_charge=1;
0297         <span class="keyword">else</span>
0298             modelSBML.species(i).isSetfbc_charge=0;
0299         <span class="keyword">end</span>
0300     <span class="keyword">end</span>
0301     <span class="keyword">if</span> ~isempty(model.metMiriams{i})
0302         [~,sbo_ind] = ismember(<span class="string">'sbo'</span>,model.metMiriams{i}.name);
0303         <span class="keyword">if</span> sbo_ind &gt; 0
0304             modelSBML.species(i).sboTerm=str2double(regexprep(model.metMiriams{i}.value{sbo_ind},<span class="string">'SBO:'</span>,<span class="string">''</span>,<span class="string">'ignorecase'</span>));
0305             <span class="comment">% remove the SBO term from metMiriams so the information is</span>
0306             <span class="comment">% not duplicated in the &quot;annotation&quot; field later on</span>
0307             model.metMiriams{i}.name(sbo_ind) = [];
0308             model.metMiriams{i}.value(sbo_ind) = [];
0309         <span class="keyword">end</span>
0310     <span class="keyword">end</span>
0311     <span class="keyword">if</span> isfield(modelSBML.species,<span class="string">'annotation'</span>)
0312         <span class="keyword">if</span> ~isempty(model.metMiriams{i}) || ~isempty(model.metFormulas{i})
0313             hasInchi=false;
0314             <span class="keyword">if</span> ~isempty(model.metFormulas{i})
0315                 <span class="comment">%Only export formula if there is no InChI. This is because</span>
0316                 <span class="comment">%the metFormulas field is populated by InChIs if available</span>
0317                 <span class="keyword">if</span> ~isempty(model.inchis{i})
0318                     hasInchi=true;
0319                 <span class="keyword">end</span>
0320                 <span class="keyword">if</span> hasInchi==false
0321                     modelSBML.species(i).fbc_chemicalFormula=model.metFormulas{i};
0322                 <span class="keyword">end</span>
0323             <span class="keyword">end</span>
0324             <span class="keyword">if</span> ~isempty(model.metMiriams{i}) || hasInchi==true
0325                 modelSBML.species(i).annotation=[<span class="string">'&lt;annotation&gt;&lt;rdf:RDF xmlns:rdf=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot; xmlns:dc=&quot;http://purl.org/dc/elements/1.1/&quot; xmlns:dcterms=&quot;http://purl.org/dc/terms/&quot; xmlns:vCard=&quot;http://www.w3.org/2001/vcard-rdf/3.0#&quot; xmlns:bqbiol=&quot;http://biomodels.net/biology-qualifiers/&quot; xmlns:bqmodel=&quot;http://biomodels.net/model-qualifiers/&quot;&gt;&lt;rdf:Description rdf:about=&quot;#meta_M_'</span> model.mets{i} <span class="string">'&quot;&gt;'</span>];
0326                 modelSBML.species(i).annotation=[modelSBML.species(i).annotation <span class="string">'&lt;bqbiol:is&gt;&lt;rdf:Bag&gt;'</span>];
0327                 <span class="keyword">if</span> ~isempty(model.metMiriams{i})
0328                     modelSBML.species(i).annotation=[modelSBML.species(i).annotation <a href="#_sub2" class="code" title="subfunction miriamString=getMiriam(miriamStruct)">getMiriam</a>(model.metMiriams{i})];
0329                 <span class="keyword">end</span>
0330                 <span class="keyword">if</span> hasInchi==true
0331                     modelSBML.species(i).annotation=[modelSBML.species(i).annotation <span class="string">'&lt;rdf:li rdf:resource=&quot;https://identifiers.org/inchi/InChI='</span> regexprep(model.inchis{i},<span class="string">'^InChI='</span>,<span class="string">''</span>) <span class="string">'&quot;/&gt;'</span>];
0332                     modelSBML.species(i).fbc_chemicalFormula=char(regexp(model.inchis{i}, <span class="string">'/(\w+)/'</span>, <span class="string">'tokens'</span>, <span class="string">'once'</span>));
0333                 <span class="keyword">end</span>
0334                 modelSBML.species(i).annotation=[modelSBML.species(i).annotation <span class="string">'&lt;/rdf:Bag&gt;&lt;/bqbiol:is&gt;&lt;/rdf:Description&gt;&lt;/rdf:RDF&gt;&lt;/annotation&gt;'</span>];
0335             <span class="keyword">end</span>
0336         <span class="keyword">end</span>
0337     <span class="keyword">end</span>
0338 <span class="keyword">end</span>
0339 
0340 <span class="keyword">if</span> isfield(model,<span class="string">'genes'</span>)
0341     <span class="keyword">for</span> i=1:numel(model.genes)
0342         <span class="comment">%Add the default values, as these will be the same in all entries</span>
0343         <span class="keyword">if</span> i==1
0344             <span class="keyword">if</span> isfield(modelSBML.fbc_geneProduct, <span class="string">'sboTerm'</span>)
0345                 modelSBML.fbc_geneProduct(i).sboTerm=243;
0346             <span class="keyword">end</span>
0347         <span class="keyword">end</span>
0348         <span class="comment">%Copy the default values to the next index as long as it is not the</span>
0349         <span class="comment">%last one</span>
0350         <span class="keyword">if</span> i&lt;numel(model.genes)
0351             modelSBML.fbc_geneProduct(i+1)=modelSBML.fbc_geneProduct(i);
0352         <span class="keyword">end</span>
0353         
0354         <span class="keyword">if</span> isfield(modelSBML.fbc_geneProduct,<span class="string">'metaid'</span>)
0355             modelSBML.fbc_geneProduct(i).metaid=model.genes{i};
0356         <span class="keyword">end</span>
0357         <span class="keyword">if</span> ~isempty(model.geneMiriams{i})
0358             [~,sbo_ind] = ismember(<span class="string">'sbo'</span>,model.geneMiriams{i}.name);
0359             <span class="keyword">if</span> sbo_ind &gt; 0
0360                 modelSBML.fbc_geneProduct(i).sboTerm=str2double(regexprep(model.geneMiriams{i}.value{sbo_ind},<span class="string">'SBO:'</span>,<span class="string">''</span>,<span class="string">'ignorecase'</span>));
0361                 <span class="comment">% remove the SBO term from compMiriams so the information is</span>
0362                 <span class="comment">% not duplicated in the &quot;annotation&quot; field later on</span>
0363                 model.geneMiriams{i}.name(sbo_ind) = [];
0364                 model.geneMiriams{i}.value(sbo_ind) = [];
0365             <span class="keyword">end</span>
0366         <span class="keyword">end</span>
0367         <span class="keyword">if</span> ~isempty(model.geneMiriams{i}) &amp;&amp; isfield(modelSBML.fbc_geneProduct(i),<span class="string">'annotation'</span>)
0368             modelSBML.fbc_geneProduct(i).annotation=[<span class="string">'&lt;annotation&gt;&lt;rdf:RDF xmlns:rdf=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot; xmlns:dc=&quot;http://purl.org/dc/elements/1.1/&quot; xmlns:dcterms=&quot;http://purl.org/dc/terms/&quot; xmlns:vCard=&quot;http://www.w3.org/2001/vcard-rdf/3.0#&quot; xmlns:bqbiol=&quot;http://biomodels.net/biology-qualifiers/&quot; xmlns:bqmodel=&quot;http://biomodels.net/model-qualifiers/&quot;&gt;&lt;rdf:Description rdf:about=&quot;#meta_'</span> model.genes{i} <span class="string">'&quot;&gt;'</span>];
0369             modelSBML.fbc_geneProduct(i).annotation=[modelSBML.fbc_geneProduct(i).annotation <span class="string">'&lt;bqbiol:is&gt;&lt;rdf:Bag&gt;'</span>];
0370             modelSBML.fbc_geneProduct(i).annotation=[modelSBML.fbc_geneProduct(i).annotation <a href="#_sub2" class="code" title="subfunction miriamString=getMiriam(miriamStruct)">getMiriam</a>(model.geneMiriams{i}) <span class="string">'&lt;/rdf:Bag&gt;&lt;/bqbiol:is&gt;&lt;/rdf:Description&gt;&lt;/rdf:RDF&gt;&lt;/annotation&gt;'</span>];
0371         <span class="keyword">end</span>
0372         <span class="keyword">if</span> isfield(modelSBML.fbc_geneProduct, <span class="string">'fbc_id'</span>)
0373             modelSBML.fbc_geneProduct(i).fbc_id=model.genes{i};
0374         <span class="keyword">end</span>
0375         <span class="keyword">if</span> isfield(modelSBML.fbc_geneProduct, <span class="string">'fbc_label'</span>) &amp;&amp; isfield(model,<span class="string">'geneShortNames'</span>)
0376             <span class="keyword">if</span> isempty(model.geneShortNames{i})
0377                 modelSBML.fbc_geneProduct(i).fbc_label=model.genes{i};
0378             <span class="keyword">else</span>
0379                 modelSBML.fbc_geneProduct(i).fbc_label=model.geneShortNames{i};
0380             <span class="keyword">end</span>
0381         <span class="keyword">end</span>
0382     <span class="keyword">end</span>
0383     <span class="keyword">if</span> exportGeneComplexes==true
0384         <span class="comment">%Also add the complexes as genes. This is done by splitting grRules</span>
0385         <span class="comment">%on &quot;or&quot; and adding the ones which contain several genes</span>
0386         geneComplexes={};
0387         <span class="keyword">if</span> isfield(model,<span class="string">'grRules'</span>)
0388             <span class="comment">%Only grRules which contain &quot; and &quot; can be complexes</span>
0389             uniqueRules=unique(model.grRules);
0390             I=cellfun(@any,strfind(uniqueRules,<span class="string">' and '</span>));
0391             uniqueRules(~I)=[];
0392             uniqueRules=strrep(uniqueRules,<span class="string">'('</span>,<span class="string">''</span>);
0393             uniqueRules=strrep(uniqueRules,<span class="string">')'</span>,<span class="string">''</span>);
0394             uniqueRules=strrep(uniqueRules,<span class="string">' and '</span>,<span class="string">':'</span>);
0395             <span class="keyword">for</span> i=1:numel(uniqueRules)
0396                 genes=regexp(uniqueRules(i),<span class="string">' or '</span>,<span class="string">'split'</span>);
0397                 genes=genes{1}(:);
0398                 <span class="comment">%Check which ones are complexes</span>
0399                 I=cellfun(@any,strfind(genes,<span class="string">':'</span>));
0400                 geneComplexes=[geneComplexes;genes(I)];
0401             <span class="keyword">end</span>
0402         <span class="keyword">end</span>
0403         geneComplexes=unique(geneComplexes);
0404         <span class="keyword">if</span> ~isempty(geneComplexes)
0405             <span class="comment">%Then add them as genes. There is a possiblity that a complex</span>
0406             <span class="comment">%A&amp;B is added as separate from B&amp;A. This is not really an issue</span>
0407             <span class="comment">%so this is not dealt with</span>
0408             <span class="keyword">for</span> i=1:numel(geneComplexes)
0409                 modelSBML.fbc_geneProduct(numel(model.genes)+i)=modelSBML.fbc_geneProduct(1);
0410                 <span class="keyword">if</span> isfield(modelSBML.fbc_geneProduct,<span class="string">'metaid'</span>)
0411                     modelSBML.fbc_geneProduct(numel(model.genes)+i).metaid=geneComplexes{i};
0412                 <span class="keyword">end</span>
0413                 <span class="keyword">if</span> isfield(modelSBML.fbc_geneProduct,<span class="string">'fbc_id'</span>)
0414                     modelSBML.fbc_geneProduct(numel(model.genes)+i).fbc_id=geneComplexes{i};
0415                 <span class="keyword">else</span>
0416                     modelSBML.fbc_geneProduct(i).fbc_label=modelSBML.fbc_geneProduct(i).fbc_id;
0417                 <span class="keyword">end</span>
0418             <span class="keyword">end</span>
0419         <span class="keyword">end</span>
0420     <span class="keyword">end</span>
0421 <span class="keyword">end</span>
0422 
0423 <span class="comment">%Generate a list of unique fbc_bound names</span>
0424 totalValues=[model.lb; model.ub];
0425 totalNames=cell(size(totalValues,1),1);
0426 
0427 listUniqueValues=unique(totalValues);
0428 
0429 <span class="keyword">for</span> i=1:length(listUniqueValues)
0430     listUniqueNames{i,1}=[<span class="string">'FB'</span>,num2str(i),<span class="string">'N'</span>,num2str(abs(round(listUniqueValues(i))))]; <span class="comment">% create unique flux bound IDs.</span>
0431     ind=find(ismember(totalValues,listUniqueValues(i)));
0432     totalNames(ind)=listUniqueNames(i,1);
0433 <span class="keyword">end</span>
0434 
0435 <span class="keyword">for</span> i=1:length(listUniqueNames)
0436     <span class="comment">%Add the default values, as these will be the same in all entries</span>
0437     <span class="keyword">if</span> i==1
0438         <span class="keyword">if</span> isfield(modelSBML.parameter, <span class="string">'constant'</span>)
0439             modelSBML.parameter(i).constant=1;
0440         <span class="keyword">end</span>
0441         <span class="keyword">if</span> isfield(modelSBML.parameter, <span class="string">'isSetValue'</span>)
0442             modelSBML.parameter(i).isSetValue=1;
0443         <span class="keyword">end</span>
0444     <span class="keyword">end</span>
0445     <span class="comment">%Copy the default values to the next index as long as it is not the</span>
0446     <span class="comment">%last one</span>
0447     <span class="keyword">if</span> i&lt;numel(listUniqueNames)
0448         modelSBML.parameter(i+1)=modelSBML.parameter(i);
0449     <span class="keyword">end</span>
0450     modelSBML.parameter(i).id=listUniqueNames{i};
0451     modelSBML.parameter(i).value=listUniqueValues(i);
0452 <span class="keyword">end</span>
0453 
0454 <span class="keyword">for</span> i=1:numel(model.rxns)
0455     <span class="comment">%Add the default values, as these will be the same in all entries</span>
0456     <span class="keyword">if</span> i==1
0457         <span class="keyword">if</span> isfield(modelSBML.reaction, <span class="string">'sboTerm'</span>)
0458             modelSBML.reaction(i).sboTerm=176;
0459         <span class="keyword">end</span>
0460         <span class="keyword">if</span> isfield(modelSBML.reaction, <span class="string">'isSetFast'</span>)
0461             modelSBML.reaction(i).isSetFast=1;
0462         <span class="keyword">end</span>
0463     <span class="keyword">end</span>
0464     <span class="comment">%Copy the default values to the next index as long as it is not the</span>
0465     <span class="comment">%last one</span>
0466     <span class="keyword">if</span> i&lt;numel(model.rxns)
0467         modelSBML.reaction(i+1)=modelSBML.reaction(i);
0468     <span class="keyword">end</span>
0469     
0470     <span class="keyword">if</span> isfield(modelSBML.reaction,<span class="string">'metaid'</span>)
0471         modelSBML.reaction(i).metaid=[<span class="string">'R_'</span> model.rxns{i}];
0472     <span class="keyword">end</span>
0473     
0474     <span class="comment">%Export notes information</span>
0475     <span class="keyword">if</span> (~isnan(model.rxnConfidenceScores(i)) || ~isempty(model.rxnReferences{i}) || ~isempty(model.rxnNotes{i}))
0476         modelSBML.reaction(i).notes=<span class="string">'&lt;notes&gt;&lt;body xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;'</span>;
0477         <span class="keyword">if</span> ~isnan(model.rxnConfidenceScores(i))
0478             modelSBML.reaction(i).notes=[modelSBML.reaction(i).notes <span class="string">'&lt;p&gt;Confidence Level: '</span> num2str(model.rxnConfidenceScores(i)) <span class="string">'&lt;/p&gt;'</span>];
0479         <span class="keyword">end</span>
0480         <span class="keyword">if</span> ~isempty(model.rxnReferences{i})
0481             modelSBML.reaction(i).notes=[modelSBML.reaction(i).notes <span class="string">'&lt;p&gt;AUTHORS: '</span> model.rxnReferences{i} <span class="string">'&lt;/p&gt;'</span>];
0482         <span class="keyword">end</span>
0483         <span class="keyword">if</span> ~isempty(model.rxnNotes{i})
0484             modelSBML.reaction(i).notes=[modelSBML.reaction(i).notes <span class="string">'&lt;p&gt;NOTES: '</span> model.rxnNotes{i} <span class="string">'&lt;/p&gt;'</span>];
0485         <span class="keyword">end</span>
0486         modelSBML.reaction(i).notes=[modelSBML.reaction(i).notes <span class="string">'&lt;/body&gt;&lt;/notes&gt;'</span>];
0487     <span class="keyword">end</span>
0488     
0489     <span class="comment">% Export SBO terms from rxnMiriams</span>
0490     <span class="keyword">if</span> ~isempty(model.rxnMiriams{i})
0491         [~,sbo_ind] = ismember(<span class="string">'sbo'</span>,model.rxnMiriams{i}.name);
0492         <span class="keyword">if</span> sbo_ind &gt; 0
0493             modelSBML.reaction(i).sboTerm=str2double(regexprep(model.rxnMiriams{i}.value{sbo_ind},<span class="string">'SBO:'</span>,<span class="string">''</span>,<span class="string">'ignorecase'</span>));
0494             <span class="comment">% remove the SBO term from rxnMiriams so the information is not</span>
0495             <span class="comment">% duplicated in the &quot;annotation&quot; field later on</span>
0496             model.rxnMiriams{i}.name(sbo_ind) = [];
0497             model.rxnMiriams{i}.value(sbo_ind) = [];
0498         <span class="keyword">end</span>
0499     <span class="keyword">end</span>
0500     
0501     <span class="comment">%Export annotation information from rxnMiriams</span>
0502     <span class="keyword">if</span> (~isempty(model.rxnMiriams{i}) &amp;&amp; isfield(modelSBML.reaction(i),<span class="string">'annotation'</span>)) || ~isempty(model.eccodes{i})
0503         modelSBML.reaction(i).annotation=[<span class="string">'&lt;annotation&gt;&lt;rdf:RDF xmlns:rdf=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot; xmlns:dc=&quot;http://purl.org/dc/elements/1.1/&quot; xmlns:dcterms=&quot;http://purl.org/dc/terms/&quot; xmlns:vCard=&quot;http://www.w3.org/2001/vcard-rdf/3.0#&quot; xmlns:bqbiol=&quot;http://biomodels.net/biology-qualifiers/&quot; xmlns:bqmodel=&quot;http://biomodels.net/model-qualifiers/&quot;&gt;&lt;rdf:Description rdf:about=&quot;#meta_R_'</span> model.rxns{i} <span class="string">'&quot;&gt;'</span>];
0504         modelSBML.reaction(i).annotation=[modelSBML.reaction(i).annotation <span class="string">'&lt;bqbiol:is&gt;&lt;rdf:Bag&gt;'</span>];
0505         <span class="keyword">if</span> ~isempty(model.eccodes{i})
0506             eccodes=regexp(model.eccodes{i},<span class="string">';'</span>,<span class="string">'split'</span>);
0507             <span class="keyword">for</span> j=1:numel(eccodes)
0508                 modelSBML.reaction(i).annotation=[modelSBML.reaction(i).annotation  <span class="string">'&lt;rdf:li rdf:resource=&quot;https://identifiers.org/ec-code/'</span> regexprep(eccodes{j},<span class="string">'ec-code/|EC'</span>,<span class="string">''</span>) <span class="string">'&quot;/&gt;'</span>];
0509             <span class="keyword">end</span>
0510         <span class="keyword">end</span>
0511         modelSBML.reaction(i).annotation=[modelSBML.reaction(i).annotation <a href="#_sub2" class="code" title="subfunction miriamString=getMiriam(miriamStruct)">getMiriam</a>(model.rxnMiriams{i}) <span class="string">'&lt;/rdf:Bag&gt;&lt;/bqbiol:is&gt;&lt;/rdf:Description&gt;&lt;/rdf:RDF&gt;&lt;/annotation&gt;'</span>];
0512     <span class="keyword">end</span>
0513     
0514     <span class="keyword">if</span> isfield(modelSBML.reaction, <span class="string">'name'</span>)
0515         modelSBML.reaction(i).name=model.rxnNames{i};
0516     <span class="keyword">end</span>
0517     <span class="keyword">if</span> isfield(modelSBML.reaction, <span class="string">'id'</span>)
0518         modelSBML.reaction(i).id=[<span class="string">'R_'</span> model.rxns{i}];
0519     <span class="keyword">end</span>
0520     
0521     <span class="comment">%Add the information about reactants and products</span>
0522     involvedMets=<a href="#_sub3" class="code" title="subfunction [tmp_Rxn]=addReactantsProducts(model,sbmlModel,i)">addReactantsProducts</a>(model,modelSBML,i);
0523     <span class="keyword">for</span> j=1:numel(involvedMets.reactant)
0524         <span class="keyword">if</span> j&lt;numel(involvedMets.reactant)
0525             modelSBML.reaction(i).reactant(j+1)=modelSBML.reaction(i).reactant(j);
0526         <span class="keyword">end</span>
0527         modelSBML.reaction(i).reactant(j).species=involvedMets.reactant(j).species;
0528         modelSBML.reaction(i).reactant(j).stoichiometry=involvedMets.reactant(j).stoichiometry;
0529         modelSBML.reaction(i).reactant(j).isSetStoichiometry=involvedMets.reactant(j).isSetStoichiometry;
0530         modelSBML.reaction(i).reactant(j).constant=involvedMets.reactant(j).constant;
0531     <span class="keyword">end</span>
0532     <span class="keyword">if</span> numel(involvedMets.reactant)==0
0533         modelSBML.reaction(i).reactant=<span class="string">''</span>;
0534     <span class="keyword">end</span>
0535     <span class="keyword">for</span> j=1:numel(involvedMets.product)
0536         <span class="keyword">if</span> j&lt;numel(involvedMets.product)
0537             modelSBML.reaction(i).product(j+1)=modelSBML.reaction(i).product(j);
0538         <span class="keyword">end</span>
0539         modelSBML.reaction(i).product(j).species=involvedMets.product(j).species;
0540         modelSBML.reaction(i).product(j).stoichiometry=involvedMets.product(j).stoichiometry;
0541         modelSBML.reaction(i).product(j).isSetStoichiometry=involvedMets.product(j).isSetStoichiometry;
0542         modelSBML.reaction(i).product(j).constant=involvedMets.product(j).constant;
0543     <span class="keyword">end</span>
0544     <span class="keyword">if</span> numel(involvedMets.product)==0
0545         modelSBML.reaction(i).product=<span class="string">''</span>;
0546     <span class="keyword">end</span>
0547     <span class="comment">%Export reversibility information. Reactions are irreversible by</span>
0548     <span class="comment">%default</span>
0549     <span class="keyword">if</span> model.rev(i)==1
0550         modelSBML.reaction(i).reversible=1;
0551     <span class="keyword">end</span>
0552     <span class="keyword">if</span> isfield(model, <span class="string">'rxnComps'</span>)
0553         modelSBML.reaction(i).compartment=model.comps{model.rxnComps(i)};
0554     <span class="keyword">end</span>
0555     <span class="keyword">if</span> isfield(model, <span class="string">'grRules'</span>)
0556         modelSBML.reaction(i).fbc_geneProductAssociation.fbc_association.fbc_association=model.grRules{i};
0557     <span class="keyword">end</span>
0558     modelSBML.reaction(i).fbc_lowerFluxBound=totalNames{i};
0559     modelSBML.reaction(i).fbc_upperFluxBound=totalNames{length(model.lb)+i};
0560 <span class="keyword">end</span>
0561 
0562 <span class="comment">%Prepare subSystems Code taken from COBRA functions getModelSubSystems,</span>
0563 <span class="comment">%writeSBML, findRxnsFromSubSystem under GNU General Public License v3.0,</span>
0564 <span class="comment">%license file in readme/GPL.MD. Code modified for RAVEN</span>
0565 <span class="keyword">if</span> modelHasSubsystems
0566     modelSBML.groups_group.groups_kind = <span class="string">'partonomy'</span>;
0567     modelSBML.groups_group.sboTerm = 633;
0568     tmpStruct=modelSBML.groups_group;
0569 
0570     rxns=strcat(<span class="string">'R_'</span>,model.rxns);
0571     <span class="keyword">if</span> ~any(cellfun(@iscell,model.subSystems))
0572         <span class="keyword">if</span> ~any(~cellfun(@isempty,model.subSystems))
0573             subSystems = {};
0574         <span class="keyword">else</span>
0575             subSystems = setdiff(model.subSystems,<span class="string">''</span>);
0576         <span class="keyword">end</span>
0577     <span class="keyword">else</span>
0578         orderedSubs = cellfun(@(x) <a href="#_sub4" class="code" title="subfunction vecT = columnVector(vec)">columnVector</a>(x),model.subSystems,<span class="string">'UniformOUtput'</span>,false);
0579         subSystems = setdiff(vertcat(orderedSubs{:}),<span class="string">''</span>);
0580     <span class="keyword">end</span>
0581     <span class="keyword">if</span> isempty(subSystems)
0582         subSystems = {};
0583     <span class="keyword">end</span>
0584     <span class="keyword">if</span> ~isempty(subSystems)
0585         <span class="comment">%Build the groups for the group package</span>
0586         groupIDs = strcat(<span class="string">'group'</span>,cellfun(@num2str, num2cell(1:length(subSystems)),<span class="string">'UniformOutput'</span>,false));
0587         <span class="keyword">for</span> i = 1:length(subSystems)
0588             cgroup = tmpStruct;
0589             <span class="keyword">if</span> ~any(cellfun(@iscell,model.subSystems))
0590                 present = ismember(model.subSystems,subSystems{i});
0591             <span class="keyword">else</span>
0592                 present = cellfun(@(x) any(ismember(x,subSystems{i})),model.subSystems);
0593             <span class="keyword">end</span>
0594             groupMembers = rxns(present);
0595             <span class="keyword">for</span> j = 1:numel(groupMembers)
0596                 cMember = tmpStruct.groups_member;
0597                 cMember.groups_idRef = groupMembers{j};
0598                 <span class="keyword">if</span> j == 1
0599                     cgroup.groups_member = cMember;
0600                 <span class="keyword">else</span>
0601                     cgroup.groups_member(j) = cMember;
0602                 <span class="keyword">end</span>
0603             <span class="keyword">end</span>
0604             cgroup.groups_id = groupIDs{i};
0605             cgroup.groups_name = subSystems{i};
0606             <span class="keyword">if</span> i == 1
0607                 modelSBML.groups_group = cgroup;
0608             <span class="keyword">else</span>
0609                 modelSBML.groups_group(i) = cgroup;
0610             <span class="keyword">end</span>
0611         <span class="keyword">end</span>
0612     <span class="keyword">end</span>
0613 <span class="keyword">end</span>
0614 
0615 <span class="comment">%Prepare fbc_objective subfield</span>
0616 
0617 modelSBML.fbc_objective.fbc_type=<span class="string">'maximize'</span>;
0618 modelSBML.fbc_objective.fbc_id=<span class="string">'obj'</span>;
0619 
0620 ind=find(model.c);
0621 
0622 <span class="keyword">if</span> isempty(ind)
0623     modelSBML.fbc_objective.fbc_fluxObjective.fbc_coefficient=0;
0624 <span class="keyword">else</span>
0625     <span class="keyword">for</span> i=1:length(ind)
0626         <span class="comment">%Copy the default values to the next index as long as it is not the</span>
0627         <span class="comment">%last one</span>
0628         <span class="keyword">if</span> i&lt;numel(ind)
0629             modelSBML.reaction(i+1)=modelSBML.reaction(i);
0630         <span class="keyword">end</span>
0631         values=model.c(model.c~=0);
0632         modelSBML.fbc_objective(i).fbc_fluxObjective.fbc_reaction=modelSBML.reaction(ind(i)).id;
0633         modelSBML.fbc_objective(i).fbc_fluxObjective.fbc_coefficient=values(i);
0634         modelSBML.fbc_objective(i).fbc_fluxObjective.isSetfbc_coefficient=1;
0635     <span class="keyword">end</span>
0636 <span class="keyword">end</span>
0637 
0638 modelSBML.fbc_activeObjective=modelSBML.fbc_objective.fbc_id;
0639 
0640 fbcStr=[<span class="string">'http://www.sbml.org/sbml/level'</span>, num2str(sbmlLevel), <span class="string">'/version'</span>, num2str(sbmlVersion), <span class="string">'/fbc/version'</span>,num2str(sbmlPackageVersions(1))];
0641 <span class="keyword">if</span> modelHasSubsystems
0642     groupStr=[<span class="string">'http://www.sbml.org/sbml/level'</span>, num2str(sbmlLevel), <span class="string">'/version'</span>, num2str(sbmlVersion), <span class="string">'/groups/version'</span>,num2str(sbmlPackageVersions(2))];
0643     modelSBML.namespaces=struct(<span class="string">'prefix'</span>,{<span class="string">''</span>,<span class="string">'fbc'</span>,<span class="string">'groups'</span>},<span class="keyword">...</span>
0644     <span class="string">'uri'</span>,{[<span class="string">'http://www.sbml.org/sbml/level'</span>, num2str(sbmlLevel), <span class="string">'/version'</span>, num2str(sbmlVersion), <span class="string">'/core'</span>],<span class="keyword">...</span>
0645     fbcStr,groupStr});
0646 <span class="keyword">else</span>
0647     modelSBML.namespaces=struct(<span class="string">'prefix'</span>,{<span class="string">''</span>,<span class="string">'fbc'</span>},<span class="keyword">...</span>
0648     <span class="string">'uri'</span>,{[<span class="string">'http://www.sbml.org/sbml/level'</span>, num2str(sbmlLevel), <span class="string">'/version'</span>, num2str(sbmlVersion), <span class="string">'/core'</span>],<span class="keyword">...</span>
0649     fbcStr});
0650 <span class="keyword">end</span>
0651 
0652 <span class="keyword">if</span> sbmlPackageVersions(1) == 2
0653     modelSBML.fbc_strict=1;
0654 <span class="keyword">end</span>
0655 
0656 modelSBML.rule=[];
0657 modelSBML.constraint=[];
0658 
0659 [ravenDir,prevDir]=findRAVENroot();
0660 fileName=<a href="checkFileExistence.html" class="code" title="function files=checkFileExistence(files,fullOrTemp,allowSpace,checkExist)">checkFileExistence</a>(fileName,1,true,false);
0661 cd(fullfile(ravenDir,<span class="string">'software'</span>,<span class="string">'libSBML'</span>));
0662 OutputSBML(modelSBML,fileName,1,0,[1,0]);
0663 cd(prevDir);
0664 <span class="keyword">end</span>
0665 
0666 
0667 <a name="_sub1" href="#_subfunctions" class="code">function modelSBML=getSBMLStructure(sbmlLevel,sbmlVersion,sbmlPackages,sbmlPackageVersions)</a>
0668 <span class="comment">%Returns the blank SBML model structure by using appropriate libSBML</span>
0669 <span class="comment">%functions. This creates structure by considering three levels</span>
0670 
0671 sbmlFieldNames=getStructureFieldnames(<span class="string">'model'</span>,sbmlLevel,sbmlVersion,sbmlPackages,sbmlPackageVersions);
0672 sbmlDefaultValues=getDefaultValues(<span class="string">'model'</span>,sbmlLevel,sbmlVersion,sbmlPackages,sbmlPackageVersions);
0673 
0674 <span class="keyword">for</span> i=1:numel(sbmlFieldNames)
0675     modelSBML.(sbmlFieldNames{1,i})=sbmlDefaultValues{1,i};
0676     sbmlSubfieldNames=getStructureFieldnames(sbmlFieldNames{1,i},sbmlLevel,sbmlVersion,sbmlPackages,sbmlPackageVersions);
0677     sbmlSubfieldValues=getDefaultValues(sbmlFieldNames{1,i},sbmlLevel,sbmlVersion,sbmlPackages,sbmlPackageVersions);
0678     <span class="keyword">if</span> ~strcmp(sbmlFieldNames{1,i},<span class="string">'event'</span>) &amp;&amp; ~strcmp(sbmlFieldNames{1,i},<span class="string">'functionDefinition'</span>) &amp;&amp; ~strcmp(sbmlFieldNames{1,i},<span class="string">'initialAssignment'</span>)
0679         <span class="keyword">for</span> j=1:numel(sbmlSubfieldNames)
0680             modelSBML.(sbmlFieldNames{1,i}).(sbmlSubfieldNames{1,j})=sbmlSubfieldValues{1,j};
0681             sbmlSubsubfieldNames=getStructureFieldnames(sbmlSubfieldNames{1,j},sbmlLevel,sbmlVersion,sbmlPackages,sbmlPackageVersions);
0682             sbmlSubsubfieldValues=getDefaultValues(sbmlSubfieldNames{1,j},sbmlLevel,sbmlVersion,sbmlPackages,sbmlPackageVersions);
0683             <span class="keyword">if</span> ~strcmp(sbmlSubfieldNames{1,j},<span class="string">'modifier'</span>) &amp;&amp; ~strcmp(sbmlSubfieldNames{1,j},<span class="string">'kineticLaw'</span>)
0684                 <span class="keyword">for</span> k=1:numel(sbmlSubsubfieldNames)
0685                     <span class="comment">%'compartment' and 'species' fields are not supposed to</span>
0686                     <span class="comment">%have their standalone structures if they are subfields</span>
0687                     <span class="comment">%or subsubfields</span>
0688                     <span class="keyword">if</span> ~strcmp(sbmlSubfieldNames{1,j},<span class="string">'compartment'</span>) &amp;&amp; ~strcmp(sbmlSubfieldNames{1,j},<span class="string">'species'</span>)
0689                         modelSBML.(sbmlFieldNames{1,i}).(sbmlSubfieldNames{1,j}).(sbmlSubsubfieldNames{1,k})=sbmlSubsubfieldValues{1,k};
0690                     <span class="keyword">end</span>
0691                     <span class="comment">%If it is fbc_association in the third level, we need</span>
0692                     <span class="comment">%to establish the fourth level, since libSBML requires</span>
0693                     <span class="comment">%it</span>
0694                     <span class="keyword">if</span> strcmp(sbmlSubsubfieldNames{1,k},<span class="string">'fbc_association'</span>)
0695                         fbc_associationFieldNames=getStructureFieldnames(<span class="string">'fbc_association'</span>,sbmlLevel,sbmlVersion,sbmlPackages,sbmlPackageVersions);
0696                         fbc_associationFieldValues=getDefaultValues(<span class="string">'fbc_association'</span>,sbmlLevel,sbmlVersion,sbmlPackages,sbmlPackageVersions);
0697                         <span class="keyword">for</span> l=1:numel(fbc_associationFieldNames)
0698                             modelSBML.(sbmlFieldNames{1,i}).(sbmlSubfieldNames{1,j}).(sbmlSubsubfieldNames{1,k}).(fbc_associationFieldNames{1,l})=fbc_associationFieldValues{1,l};
0699                         <span class="keyword">end</span>
0700                     <span class="keyword">end</span>
0701                 <span class="keyword">end</span>
0702             <span class="keyword">end</span>
0703         <span class="keyword">end</span>
0704     <span class="keyword">end</span>
0705     <span class="keyword">if</span> ~isstruct(modelSBML.(sbmlFieldNames{1,i}))
0706         modelSBML.(sbmlFieldNames{1,i})=sbmlDefaultValues{1,i};
0707     <span class="keyword">end</span>
0708 <span class="keyword">end</span>
0709 
0710 modelSBML.unitDefinition.id=<span class="string">'mmol_per_gDW_per_hr'</span>;
0711 
0712 unitFieldNames=getStructureFieldnames(<span class="string">'unit'</span>,sbmlLevel,sbmlVersion,sbmlPackages,sbmlPackageVersions);
0713 unitDefaultValues=getDefaultValues(<span class="string">'unit'</span>,sbmlLevel,sbmlVersion,sbmlPackages,sbmlPackageVersions);
0714 
0715 kinds={<span class="string">'mole'</span>,<span class="string">'gram'</span>,<span class="string">'second'</span>};
0716 exponents=[1 -1 -1];
0717 scales=[-3 0 0];
0718 multipliers=[1 1 1*60*60];
0719 
0720 <span class="keyword">for</span> i=1:numel(unitFieldNames)
0721     modelSBML.unitDefinition.unit(1).(unitFieldNames{1,i})=unitDefaultValues{1,i};
0722     <span class="keyword">for</span> j=1:3
0723         modelSBML.unitDefinition.unit(j).(unitFieldNames{1,i})=unitDefaultValues{1,i};
0724         <span class="keyword">if</span> strcmp(unitFieldNames{1,i},<span class="string">'kind'</span>)
0725             modelSBML.unitDefinition.unit(j).(unitFieldNames{1,i})=kinds{j};
0726         <span class="keyword">elseif</span> strcmp(unitFieldNames{1,i},<span class="string">'exponent'</span>)
0727             modelSBML.unitDefinition.unit(j).(unitFieldNames{1,i})=exponents(j);
0728         <span class="keyword">elseif</span> strcmp(unitFieldNames{1,i},<span class="string">'scale'</span>)
0729             modelSBML.unitDefinition.unit(j).(unitFieldNames{1,i})=scales(j);
0730         <span class="keyword">elseif</span> strcmp(unitFieldNames{1,i},<span class="string">'multiplier'</span>)
0731             modelSBML.unitDefinition.unit(j).(unitFieldNames{1,i})=multipliers(j);
0732         <span class="keyword">end</span>
0733     <span class="keyword">end</span>
0734 <span class="keyword">end</span>
0735 <span class="keyword">end</span>
0736 
0737 <a name="_sub2" href="#_subfunctions" class="code">function miriamString=getMiriam(miriamStruct)</a>
0738 <span class="comment">%Returns a string with list elements for a miriam structure ('&lt;rdf:li</span>
0739 <span class="comment">%rdf:resource=&quot;https://identifiers.org/go/GO:0005739&quot;/&gt;' for example). This</span>
0740 <span class="comment">%is just to speed up things since this is done many times during the</span>
0741 <span class="comment">%exporting</span>
0742 
0743 miriamString=<span class="string">''</span>;
0744 <span class="keyword">if</span> isfield(miriamStruct,<span class="string">'name'</span>)
0745     <span class="keyword">for</span> i=1:numel(miriamStruct.name)
0746         miriamString=[miriamString <span class="string">'&lt;rdf:li rdf:resource=&quot;https://identifiers.org/'</span> miriamStruct.name{i} <span class="string">'/'</span> miriamStruct.value{i} <span class="string">'&quot;/&gt;'</span>];
0747     <span class="keyword">end</span>
0748 <span class="keyword">end</span>
0749 <span class="keyword">end</span>
0750 
0751 <a name="_sub3" href="#_subfunctions" class="code">function [tmp_Rxn]=addReactantsProducts(model,sbmlModel,i)</a>
0752 <span class="comment">%This function provides reactants and products for particular reaction. The</span>
0753 <span class="comment">%function was 'borrowed' from writeSBML in COBRA toolbox, lines 663-679</span>
0754 
0755 met_idx = find(model.S(:, i));
0756 tmp_Rxn.product=[];
0757 tmp_Rxn.reactant=[];
0758 <span class="keyword">for</span> j_met=1:size(met_idx,1)
0759     tmp_idx = met_idx(j_met,1);
0760     sbml_tmp_species_ref.species = sbmlModel.species(tmp_idx).id;
0761     met_stoich = model.S(tmp_idx, i);
0762     sbml_tmp_species_ref.stoichiometry = abs(met_stoich);
0763     sbml_tmp_species_ref.isSetStoichiometry=1;
0764     sbml_tmp_species_ref.constant=1;
0765     <span class="keyword">if</span> (met_stoich &gt; 0)
0766         tmp_Rxn.product = [ tmp_Rxn.product, sbml_tmp_species_ref ];
0767     <span class="keyword">else</span>
0768         tmp_Rxn.reactant = [ tmp_Rxn.reactant, sbml_tmp_species_ref];
0769     <span class="keyword">end</span>
0770 <span class="keyword">end</span>
0771 <span class="keyword">end</span>
0772 
0773 <a name="_sub4" href="#_subfunctions" class="code">function vecT = columnVector(vec)</a>
0774 <span class="comment">% Code below taken from COBRA Toolbox under GNU General Public License v3.0</span>
0775 <span class="comment">% license file in readme/GPL.MD.</span>
0776 <span class="comment">%</span>
0777 <span class="comment">% Converts a vector to a column vector</span>
0778 <span class="comment">%</span>
0779 <span class="comment">% USAGE:</span>
0780 <span class="comment">%</span>
0781 <span class="comment">%   vecT = columnVector(vec)</span>
0782 <span class="comment">%</span>
0783 <span class="comment">% INPUT:</span>
0784 <span class="comment">%   vec:     a vector</span>
0785 <span class="comment">%</span>
0786 <span class="comment">% OUTPUT:</span>
0787 <span class="comment">%   vecT:    a column vector</span>
0788 
0789 [n, m] = size(vec);
0790 
0791 <span class="keyword">if</span> n &lt; m
0792     vecT = vec';
0793 <span class="keyword">else</span>
0794     vecT = vec;
0795 <span class="keyword">end</span>
0796 <span class="keyword">end</span></pre></div>
<hr><address>Generated by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>